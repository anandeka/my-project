create or replace package "PKG_PHY_PHYSICAL_PROCESS" is

  gvc_previous_process_id varchar2(15);

  gvc_dbd_id varchar2(15);

  gvc_process varchar2(10);

  gvc_base_cur_decimals number;

  gvc_prev_eod_ref_no_mig varchar2(15);

  gvc_prev_eom_ref_no_mig varchar2(15);

  gvc_previous_process_date date;

  procedure sp_process_run(pc_corporate_id varchar2,
                           pd_trade_date   date,
                           pc_process_id   varchar2,
                           pc_user_id      varchar2,
                           pc_process      varchar2,
                           pc_dbd_id       varchar2);

  procedure sp_phy_rebuild_stats;

  procedure sp_calc_contract_price(pc_corporate_id varchar2,
                                   pd_trade_date   date,
                                   pc_process_id   varchar2,
                                   pc_user_id      varchar2,
                                   pc_dbd_id       varchar2);

  procedure sp_calc_gmr_price(pc_corporate_id varchar2,
                              pd_trade_date   date,
                              pc_process_id   varchar2,
                              pc_user_id      varchar2,
                              pc_dbd_id       varchar2);

  procedure sp_calc_conc_gmr_price(pc_corporate_id varchar2,
                                   pd_trade_date   date,
                                   pc_process_id   varchar2,
                                   pc_user_id      varchar2,
                                   pc_dbd_id       varchar2);

  procedure sp_calc_contract_conc_price(pc_corporate_id varchar2,
                                        pd_trade_date   date,
                                        pc_process_id   varchar2,
                                        pc_user_id      varchar2,
                                        pc_dbd_id       varchar2);

  procedure sp_calc_stock_price(pc_process_id varchar2);

  procedure sp_mark_process_id(pc_corporate_id varchar2,
                               pc_process_id   varchar2,
                               pc_user_id      varchar2,
                               pd_trade_date   date);

  procedure sp_calc_secondary_cost(pc_corporate_id varchar2,
                                   pc_process_id   varchar2,
                                   pc_user_id      varchar2,
                                   pd_trade_date   date);

  procedure sp_calc_m2m_cost(pc_corporate_id varchar2,
                             pd_trade_date   date,
                             pc_process_id   varchar2,
                             pc_user_id      varchar2);

  procedure sp_calc_m2m_conc_cost(pc_corporate_id varchar2,
                                  pd_trade_date   date,
                                  pc_process_id   varchar2,
                                  pc_user_id      varchar2);
  procedure sp_calc_m2m_tolling_extn_cost(pc_corporate_id varchar2,
                                          pd_trade_date   date,
                                          pc_process_id   varchar2,
                                          pc_user_id      varchar2);

  procedure sp_calc_phy_open_unreal_pnl(pc_corporate_id varchar2,
                                        pd_trade_date   date,
                                        pc_process_id   varchar2,
                                        pc_user_id      varchar2);

  procedure sp_calc_phy_opencon_unreal_pnl(pc_corporate_id varchar2,
                                           pd_trade_date   date,
                                           pc_process_id   varchar2,
                                           pc_user_id      varchar2,
                                           pc_dbd_id       varchar2);
  procedure sp_phy_opencon_ext_unreal_pnl(pc_corporate_id varchar2,
                                          pd_trade_date   date,
                                          pc_process_id   varchar2,
                                          pc_user_id      varchar2,
                                          pc_dbd_id       varchar2);

  procedure sp_stock_unreal_shipped_not_tt(pc_corporate_id varchar2,
                                           pd_trade_date   date,
                                           pc_process_id   varchar2,
                                           pc_user_id      varchar2);
  procedure sp_stock_unreal_inventory_in(pc_corporate_id varchar2,
                                         pd_trade_date   date,
                                         pc_process_id   varchar2,
                                         pc_user_id      varchar2);

  procedure sp_cal_phy_stok_con_unreal_pnl(pc_corporate_id varchar2,
                                           pd_trade_date   date,
                                           pc_process_id   varchar2,
                                           pc_user_id      varchar2);
  procedure sp_phy_stok_con_ext_unreal_pnl(pc_corporate_id varchar2,
                                           pd_trade_date   date,
                                           pc_process_id   varchar2,
                                           pc_user_id      varchar2);

  procedure sp_process_rollback(pc_corporate_id varchar2,
                                pc_process      varchar2,
                                pd_trade_date   date,
                                pc_dbd_id       varchar2,
                                pc_process_id   varchar2);

  procedure sp_calc_pnl_summary(pc_corporate_id varchar2,
                                pd_trade_date   date,
                                pc_process_id   varchar2,
                                pc_process      varchar2,
                                pc_user_id      varchar2);

  procedure sp_calc_daily_trade_pnl(pc_corporate_id varchar2,
                                    pd_trade_date   date,
                                    pc_process_id   varchar2,
                                    pc_process      varchar2,
                                    pc_user_id      varchar2);

  function f_get_next_day(p_date     in date,
                          p_day      in varchar2,
                          p_position in number) return date;

  function f_is_day_holiday(pc_instrumentid in varchar2,
                            pc_trade_date   date) return boolean;

  procedure sp_calc_quality_premium(pc_int_contract_item_ref_no in varchar2,
                                    pc_price_unit_id            in varchar2,
                                    pc_corporate_id             in varchar2,
                                    pd_trade_date               in date,
                                    pc_process_id               in varchar2,
                                    pn_premium                  out number);
  procedure sp_quality_premium_fw_rate(pc_int_contract_item_ref_no in varchar2,
                                       pc_corporate_id             in varchar2,
                                       pd_trade_date               in date,
                                       pc_price_unit_id            in varchar2,
                                       pc_base_cur_id              in varchar2,
                                       pd_payment_due_date         in date,
                                       pc_product_id               in varchar2,
                                       pc_base_qty_unit_id         in varchar2,
                                       pc_process_id               in varchar2,
                                       pn_premium                  out number,
                                       pc_exch_rate_string         out varchar2);
  procedure sp_calc_pofh_price(pc_pofh_id       varchar2,
                               pd_trade_date    date,
                               pn_price         out number,
                               pc_price_unit_id out varchar2);
  procedure sp_calc_phy_realized_today(pc_corporate_id varchar2,
                                       pd_trade_date   date,
                                       pc_process_id   varchar2,
                                       pc_user_id      varchar2);

  procedure sp_calc_reverse_realized(pc_corporate_id varchar2,
                                     pd_trade_date   date,
                                     pc_process_id   varchar2,
                                     pc_user_id      varchar2);
  procedure sp_calc_phy_realize_pnl_change(pc_corporate_id varchar2,
                                           pd_trade_date   date,
                                           pc_process      varchar2,
                                           pc_process_id   varchar2,
                                           pc_user_id      varchar2);
  procedure sp_calc_realized_not_fixed(pc_corporate_id varchar2,
                                       pd_trade_date   date,
                                       pc_process      varchar2,
                                       pc_process_id   varchar2,
                                       pc_user_id      varchar2);

  procedure sp_populate_price_conversion(pc_corporate_id varchar2,
                                         pd_trade_date   date);

  procedure sp_calc_invm_cog(pc_corporate_id varchar2,
                             pc_process_id   varchar2,
                             pc_user_id      varchar2,
                             pd_trade_date   date);
  procedure sp_calc_invm_cogs(pc_corporate_id varchar2,
                              pc_process_id   varchar2,
                              pc_user_id      varchar2,
                              pd_trade_date   date);

  procedure sp_phy_purchase_accural(pc_corporate_id varchar2,
                                    pd_trade_date   date,
                                    pc_process_id   varchar2,
                                    pc_dbd_id       varchar2);

end;
/
create or replace package body "PKG_PHY_PHYSICAL_PROCESS" is

  procedure sp_process_run(pc_corporate_id varchar2,
                           pd_trade_date   date,
                           pc_process_id   varchar2,
                           pc_user_id      varchar2,
                           pc_process      varchar2, --eod or eom
                           pc_dbd_id       varchar2
                           ------------------------------------------------------------------------------------------
                           --        procedure name                            : sp_process_run
                           --        author                                    :
                           --        created date                              : 10 th jan 2011
                           --        purpose                                   : calls all procedures for eod
                           --
                           --        parameters
                           --        pc_corporate_id                           : corporate id
                           --        pd_trade_date                             : trade date
                           --        pc_process_id                             : eod/eom reference no
                           --
                           --        modification history
                           --        modified date                             :
                           --        modified by                               :
                           --        modify description                        :
                           --------------------------------------------------------------------------------------------
                           ) is
    vobj_error_log     tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count number := 1;
    vn_logno           number := 0;
    vc_err_msg         varchar2(1000);
    vc_prev_eod_id     varchar2(15);
    vc_prev_eod_date   date;
    vc_prev_eom_id     varchar2(15);
    vc_prev_eom_date   date;
  begin
    gvc_process := pc_process;
  
    vc_err_msg := 'Before gvc_previous_process_id ';
    if gvc_process = 'EOD' then
      begin
        select tdc.process_id,
               tdc.trade_date
          into vc_prev_eod_id,
               vc_prev_eod_date
          from tdc_trade_date_closure tdc
         where tdc.corporate_id = pc_corporate_id
           and process = pc_process
           and tdc.trade_date =
               (select max(trade_date)
                  from tdc_trade_date_closure
                 where corporate_id = pc_corporate_id
                   and trade_date < pd_trade_date
                   and process = pc_process);
      exception
        when no_data_found then
          select seq_eod.nextval into vc_prev_eod_id from dual;
          insert into tdc_trade_date_closure
            (corporate_id,
             trade_date,
             created_date,
             closed_by,
             process_id,
             process)
          values
            (pc_corporate_id,
             to_date('01-Jan-2000', 'dd-Mon-yyyy'),
             systimestamp,
             pc_user_id,
             gvc_previous_process_id,
             pc_process);
      end;
      vc_err_msg := 'Before vc_prev_eom_id/date ';
    else
      begin
        -- To get the Previous EOM Process ID
        select tdc.process_id,
               tdc.trade_date
          into vc_prev_eom_id,
               vc_prev_eom_date
          from tdc_trade_date_closure tdc
         where tdc.corporate_id = pc_corporate_id
           and process = 'EOM'
           and tdc.trade_date = (select max(trade_date)
                                   from tdc_trade_date_closure
                                  where corporate_id = pc_corporate_id
                                    and trade_date < pd_trade_date
                                    and process = 'EOM');
      exception
        when no_data_found then
          select seq_eod.nextval into vc_prev_eom_id from dual;
          insert into tdc_trade_date_closure
            (corporate_id,
             trade_date,
             created_date,
             closed_by,
             process_id,
             process)
          values
            (pc_corporate_id,
             to_date('01-Jan-2000', 'dd-Mon-yyyy'),
             systimestamp,
             pc_user_id,
             vc_prev_eom_id,
             'EOM');
          vc_prev_eom_date := to_date('01-Jan-2000', 'dd-Mon-yyyy');
      end;
    end if;
    if pc_process = 'EOD' then
      gvc_previous_process_id   := vc_prev_eod_id;
      gvc_previous_process_date := vc_prev_eod_date;
    else
      gvc_previous_process_id   := vc_prev_eom_id;
      gvc_previous_process_date := vc_prev_eom_date;
    end if;
    -- get the dump id
    gvc_dbd_id := pc_dbd_id;
    --
    -- get the base currency decinals
    --
    vc_err_msg := 'Before base currency decimals ';
    select cm.decimals
      into gvc_base_cur_decimals
      from ak_corporate       akc,
           cm_currency_master cm
     where akc.corporate_id = pc_corporate_id
       and akc.base_cur_id = cm.cur_id;
    -- mark eod
    vc_err_msg := 'Before mark process id ';
    vn_logno   := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'Start of EOD/EOM Process From Physical');
  
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_mark_process_id');
    sp_mark_process_id(pc_corporate_id,
                       pc_process_id,
                       pc_user_id,
                       pd_trade_date);
  
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_phy_rebuild_stats');
    --sp_phy_rebuild_stats;
  
    vc_err_msg := 'sp_calc_contract_price ';
  
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_contract_price');
    sp_calc_contract_price(pc_corporate_id,
                           pd_trade_date,
                           pc_process_id,
                           pc_user_id,
                           pc_dbd_id);
    vc_err_msg := 'sp_calc_gmr_price ';
    -----GMR Price calculation
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_gmr_price');
    sp_calc_gmr_price(pc_corporate_id,
                      pd_trade_date,
                      pc_process_id,
                      pc_user_id,
                      pc_dbd_id);
  
    vc_err_msg := 'sp_calc_contract_conc_price ';
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_contract_conc_price');
    sp_calc_contract_conc_price(pc_corporate_id,
                                pd_trade_date,
                                pc_process_id,
                                pc_user_id,
                                pc_dbd_id);
  
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_conc_gmr_price');
    sp_calc_conc_gmr_price(pc_corporate_id,
                           pd_trade_date,
                           pc_process_id,
                           pc_user_id,
                           pc_dbd_id);
  
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_secondary_cost');
    sp_calc_secondary_cost(pc_corporate_id,
                           pc_process_id,
                           pc_user_id,
                           pd_trade_date);
  
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_invm_cog');
  
    pkg_phy_physical_process.sp_calc_invm_cog(pc_corporate_id,
                                              pc_process_id,
                                              pc_user_id,
                                              pd_trade_date);
  
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_invm_cogs');
  
    pkg_phy_physical_process.sp_calc_invm_cogs(pc_corporate_id,
                                               pc_process_id,
                                               pc_user_id,
                                               pd_trade_date);
  
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_m2m_cost');
    vc_err_msg := 'Before calc m2m cost ';
    sp_calc_m2m_cost(pc_corporate_id,
                     pd_trade_date,
                     pc_process_id,
                     pc_user_id);
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_m2m_conc_cost');
    vc_err_msg := 'Before calc m2m conc  cost ';
    sp_calc_m2m_conc_cost(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          pc_user_id);
    ----
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_m2m_tolling_extn_cost');
    vc_err_msg := 'Before call of sp_calc_m2m_tolling_extn_cost';
  
    sp_calc_m2m_tolling_extn_cost(pc_corporate_id,
                                  pd_trade_date,
                                  pc_process_id,
                                  pc_user_id);
    ---
  
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_populate_price_conversion');
  
    vc_err_msg := 'Before call of sp_populate_price_conversion';
  
    sp_populate_price_conversion(pc_corporate_id, pd_trade_date);
  
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_stock_price');
    vc_err_msg := 'Before call of sp_calc_stock_price';
  
    sp_calc_stock_price(pc_process_id);
  
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_phy_open_unreal_pnl');
    vc_err_msg := 'Before open unreal pnl ';
    sp_calc_phy_open_unreal_pnl(pc_corporate_id,
                                pd_trade_date,
                                pc_process_id,
                                pc_user_id);
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_phy_opencon_unreal_pnl');
  
    vc_err_msg := 'Before call of sp_calc_phy_opencon_unreal_pnl';
  
    sp_calc_phy_opencon_unreal_pnl(pc_corporate_id,
                                   pd_trade_date,
                                   pc_process_id,
                                   pc_user_id,
                                   pc_dbd_id);
  
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_phy_opencon_ext_unreal_pnl');
  
    vc_err_msg := 'Before call of sp_phy_opencon_ext_unreal_pnl';
  
    sp_phy_opencon_ext_unreal_pnl(pc_corporate_id,
                                  pd_trade_date,
                                  pc_process_id,
                                  pc_user_id,
                                  pc_dbd_id);
  
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_stock_unreal_shipped_not_tt');
  
    vc_err_msg := 'Before call of sp_stock_unreal_shipped_not_tt';
  
    sp_stock_unreal_shipped_not_tt(pc_corporate_id,
                                   pd_trade_date,
                                   pc_process_id,
                                   pc_user_id);
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_stock_unreal_inventory_in');
  
    vc_err_msg := 'Before call of sp_stock_unreal_inventory_in';
  
    sp_stock_unreal_inventory_in(pc_corporate_id,
                                 pd_trade_date,
                                 pc_process_id,
                                 pc_user_id);
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_cal_phy_stok_con_unreal_pnl');
  
    vc_err_msg := 'Before call of sp_cal_phy_stok_con_unreal_pnl';
  
    sp_cal_phy_stok_con_unreal_pnl(pc_corporate_id,
                                   pd_trade_date,
                                   pc_process_id,
                                   pc_user_id);
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_phy_stok_con_ext_unreal_pnl');
  
    vc_err_msg := 'Before call of sp_phy_stok_con_ext_unreal_pnl';
  
    sp_phy_stok_con_ext_unreal_pnl(pc_corporate_id,
                                   pd_trade_date,
                                   pc_process_id,
                                   pc_user_id);
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_phy_realized_today');
    vc_err_msg := 'Before call of sp_calc_phy_realized_today';
  
    sp_calc_phy_realized_today(pc_corporate_id,
                               pd_trade_date,
                               pc_process_id,
                               pc_user_id);
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_reverse_realized');
    vc_err_msg := 'Before call of sp_calc_reverse_realized';
  
    sp_calc_reverse_realized(pc_corporate_id,
                             pd_trade_date,
                             pc_process_id,
                             pc_user_id);
  
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_phy_realize_pnl_change');
    vc_err_msg := 'Before call of sp_calc_phy_realize_pnl_change';
  
    sp_calc_phy_realize_pnl_change(pc_corporate_id,
                                   pd_trade_date,
                                   pc_process,
                                   pc_process_id,
                                   pc_user_id);
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_pnl_summary');
    sp_calc_pnl_summary(pc_corporate_id,
                        pd_trade_date,
                        pc_process_id,
                        gvc_process,
                        pc_user_id);
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_daily_trade_pnl');
    vc_err_msg := 'Before trade pnl ';
    sp_calc_daily_trade_pnl(pc_corporate_id,
                            pd_trade_date,
                            pc_process_id,
                            gvc_process,
                            pc_user_id);
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_calc_realized_not_fixed');
    vc_err_msg := 'Before sp_calc_realized_not_fixed ';
    sp_calc_realized_not_fixed(pc_corporate_id,
                               pd_trade_date,
                               pc_process,
                               pc_process_id,
                               pc_user_id);
    vn_logno := vn_logno + 1;
  
    if pkg_process_status.sp_get(pc_corporate_id, pc_process, pd_trade_date) =
       'Cancel' then
      goto cancel_process;
    end if;
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'sp_phy_purchase_accural');
    sp_phy_purchase_accural(pc_corporate_id,
                            pd_trade_date,
                            pc_process_id,
                            pc_dbd_id);
  
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_process_id,
                          vn_logno,
                          'End of EOD/EOM Process From Physical');
    vc_err_msg := 'end of physical sp process run ';
    <<cancel_process>>
    dbms_output.put_line('EOD/EOM Process Cancelled while pnl calculation');
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure pkg_phy_physical_process sp_process_run ' ||
                                                           vc_err_msg,
                                                           'M2M-013',
                                                           'code:' ||
                                                           sqlcode ||
                                                           ' message:' ||
                                                           sqlerrm || ' ' ||
                                                           vc_err_msg,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;

  procedure sp_phy_rebuild_stats is
  begin
    sp_gather_stats('cipd_contract_item_price_daily');
    sp_gather_stats('cisc_contract_item_sec_cost');
    sp_gather_stats('gsc_gmr_sec_cost');
    sp_gather_stats('gscs_gmr_sec_cost_summary');
    sp_gather_stats('tmpc_temp_m2m_pre_check');
    sp_gather_stats('md_m2m_daily');
    sp_gather_stats('dpp_daily_physical_position');
    sp_gather_stats('poud_phy_open_unreal_daily');
    sp_gather_stats('psu_phy_stock_unrealized');
    sp_gather_stats('psci_phy_stock_contract_item');
    sp_gather_stats('psg_phy_stock_gmr');
    sp_gather_stats('tpd_trade_pnl_daily');
    sp_gather_stats('prd_physical_realized_daily');
    sp_gather_stats('ord_overall_realized_pnl_daily');
    sp_gather_stats('cps_cost_pnl_summary');
    sp_gather_stats('pnlc_pnl_change');
    sp_gather_stats('ccd_carrying_cost_daily');
    sp_gather_stats('rgmrd_realized_gmr_detail');
    sp_gather_stats('mes_month_end_stock');
    sp_gather_stats('pps_physical_pnl_summary');
    sp_gather_stats('rgmr_realized_gmr');
  end;

  procedure sp_calc_contract_price(pc_corporate_id varchar2,
                                   pd_trade_date   date,
                                   pc_process_id   varchar2,
                                   pc_user_id      varchar2,
                                   pc_dbd_id       varchar2) is
  
    vobj_error_log     tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count number := 1;
  
    cursor cur_pcdi is
      select pcdi.pcdi_id,
             pcdi.internal_contract_ref_no,
             pcdi.delivery_item_no,
             pcdi.delivery_period_type,
             pcdi.delivery_from_month,
             pcdi.delivery_from_year,
             pcdi.delivery_to_month,
             pcdi.delivery_to_year,
             pcdi.delivery_from_date,
             pcdi.delivery_to_date,
             pd_trade_date eod_trade_date,
             pcdi.basis_type,
             nvl(pcdi.transit_days, 0) transit_days,
             pcdi.qp_declaration_date,
             pcdi.is_price_optionality_present,
             pcdi.is_phy_optionality_present,
             pcdi.price_option_call_off_status,
             pci.internal_contract_item_ref_no,
             pcm.contract_ref_no,
             (case
               when nvl(pcdi.payment_due_date, pd_trade_date) <
                    pd_trade_date then
                pd_trade_date
               else
                nvl(pcdi.payment_due_date, pd_trade_date)
             end) payment_due_date,
             pci.item_qty,
             pci.item_qty_unit_id,
             pcm.invoice_currency_id,
             pcpd.qty_unit_id,
             pcpd.product_id,
             qat.instrument_id,
             akc.base_cur_id,
             akc.base_currency_name,
             dim.instrument_name,
             ps.price_source_id,
             ps.price_source_name,
             apm.available_price_id,
             apm.available_price_name,
             pum.price_unit_name,
             vdip.ppu_price_unit_id,
             div.price_unit_id,
             dim.delivery_calender_id,
             pdc.is_daily_cal_applicable,
             pdc.is_monthly_cal_applicable
        from pcdi_pc_delivery_item        pcdi,
             pci_physical_contract_item   pci,
             pcm_physical_contract_main   pcm,
             ak_corporate                 akc,
             pcpd_pc_product_definition   pcpd,
             pcpq_pc_product_quality      pcpq,
             v_contract_exchange_detail   qat,
             dim_der_instrument_master    dim,
             div_der_instrument_valuation div,
             ps_price_source              ps,
             apm_available_price_master   apm,
             pum_price_unit_master        pum,
             v_der_instrument_price_unit  vdip,
             pdc_prompt_delivery_calendar pdc
       where pcdi.pcdi_id = pci.pcdi_id
         and pcdi.internal_contract_ref_no = pcm.internal_contract_ref_no
         and pcm.internal_contract_ref_no = pcpd.internal_contract_ref_no
         and pci.pcpq_id = pcpq.pcpq_id
         and pcm.corporate_id = akc.corporate_id
         and pcm.contract_status = 'In Position'
         and pcm.contract_type = 'BASEMETAL'
         and pcpd.input_output = 'Input'
         and pci.internal_contract_item_ref_no =
             qat.internal_contract_item_ref_no(+)
         and pci.process_id = qat.process_id(+)
         and qat.instrument_id = dim.instrument_id(+)
         and dim.instrument_id = div.instrument_id(+)
         and div.is_deleted(+) = 'N'
         and div.price_source_id = ps.price_source_id(+)
         and div.available_price_id = apm.available_price_id(+)
         and div.price_unit_id = pum.price_unit_id(+)
         and dim.instrument_id = vdip.instrument_id(+)
         and dim.delivery_calender_id = pdc.prompt_delivery_calendar_id(+)
         and pci.item_qty > 0
         and pcdi.process_id = pc_process_id
         and pci.process_id = pc_process_id
         and pcm.process_id = pc_process_id
         and pcpd.process_id = pc_process_id
         and pcpq.process_id = pc_process_id
         and pcpd.is_active = 'Y'
         and pcpq.is_active = 'Y'
         and pcdi.is_active = 'Y'
         and pci.is_active = 'Y'
         and pcm.is_active = 'Y';
  
    cursor cur_called_off(pc_pcdi_id varchar2) is
      select poch.poch_id,
             poch.internal_action_ref_no,
             pocd.pricing_formula_id,
             pcbpd.pcbpd_id,
             pcbpd.price_basis,
             pcbpd.price_value,
             pcbpd.price_unit_id,
             pcbpd.tonnage_basis,
             pcbpd.fx_to_base,
             pcbpd.qty_to_be_priced,
             pcbph.price_description
        from poch_price_opt_call_off_header poch,
             pocd_price_option_calloff_dtls pocd,
             pcbpd_pc_base_price_detail     pcbpd,
             pcbph_pc_base_price_header     pcbph
       where poch.pcdi_id = pc_pcdi_id
         and poch.poch_id = pocd.poch_id
         and pocd.pcbpd_id = pcbpd.pcbpd_id
         and pcbpd.pcbph_id = pcbph.pcbph_id
         and pcbpd.process_id = pc_process_id
         and pcbph.process_id = pc_process_id
         and poch.is_active = 'Y'
         and pocd.is_active = 'Y'
         and pcbpd.is_active = 'Y'
         and pcbph.is_active = 'Y';
  
    cursor cur_not_called_off(pc_pcdi_id varchar2, pc_int_cont_item_ref_no varchar2) is
      select pcbpd.pcbpd_id,
             pcbph.internal_contract_ref_no,
             pcbpd.price_basis,
             pcbpd.price_value,
             pcbpd.price_unit_id,
             pcbpd.tonnage_basis,
             pcbpd.fx_to_base,
             pcbpd.qty_to_be_priced,
             pcbph.price_description
        from pci_physical_contract_item pci,
             pcipf_pci_pricing_formula  pcipf,
             pcbph_pc_base_price_header pcbph,
             pcbpd_pc_base_price_detail pcbpd
       where pci.internal_contract_item_ref_no =
             pcipf.internal_contract_item_ref_no
         and pcipf.pcbph_id = pcbph.pcbph_id
         and pcbph.pcbph_id = pcbpd.pcbph_id
         and pci.pcdi_id = pc_pcdi_id
         and pci.internal_contract_item_ref_no = pc_int_cont_item_ref_no
         and pci.process_id = pc_process_id
         and pcipf.process_id = pc_process_id
         and pcbph.process_id = pc_process_id
         and pcbpd.process_id = pc_process_id
         and pci.is_active = 'Y'
         and pcipf.is_active = 'Y'
         and pcbpd.is_active = 'Y'
         and pcbph.is_active = 'Y';
  
    vn_contract_price              number;
    vc_price_unit_id               varchar2(15);
    vc_price_basis                 varchar2(15);
    vc_price_cur_id                varchar2(15);
    vc_price_cur_code              varchar2(15);
    vc_price_weight_unit           number;
    vc_price_weight_unit_id        varchar2(15);
    vc_price_qty_unit              varchar2(15);
    vn_contract_equity_premium     varchar2(15);
    vn_market_equity_premium       varchar2(15);
    vc_mar_equ_prem_price_unit_id  varchar2(15);
    vc_con_equ_prem_price_unit_id  varchar2(15);
    vc_price_fixation_status       varchar2(50);
    vn_price_fixed_qty             number;
    vn_total_qty                   number;
    vn_total_quantity              number;
    vn_qty_to_be_priced            number;
    vn_total_contract_value        number;
    vn_average_price               number;
    vc_contract_base_price_unit_id varchar2(15);
    vc_contract_main_cur_id        varchar2(15);
    vc_contract_main_cur_code      varchar2(15);
    vc_base_main_cur_id            varchar2(15);
    vc_base_main_cur_code          varchar2(15);
    vn_forward_points              number;
    vn_fw_exch_rate_price_to_base  number;
    vd_qp_start_date               date;
    vd_qp_end_date                 date;
    vc_period                      varchar2(15);
    vd_shipment_date               date;
    vd_arrival_date                date;
    vc_before_price_dr_id          varchar2(15);
    vn_before_qp_price             number;
    vc_before_qp_price_unit_id     varchar2(15);
    vd_3rd_wed_of_qp               date;
    vc_holiday                     char(1);
    vn_after_qp_price              number;
    vc_after_qp_price_unit_id      varchar2(10);
    vd_payment_due_date            date;
    vc_price_description           varchar2(500);
    vn_contract_main_cur_factor    number;
    vd_dur_qp_start_date           date;
    vd_dur_qp_end_date             date;
    vn_during_val_price            number;
    vc_during_val_price_unit_id    varchar2(15);
    vn_during_total_set_price      number;
    vn_during_total_val_price      number;
    vn_count_set_qp                number;
    vn_count_val_qp                number;
    workings_days                  number;
    vd_quotes_date                 date;
    vn_after_count                 number;
    vn_after_price                 number;
    vn_during_qp_price             number;
    vc_after_price_dr_id           varchar2(15);
    vc_during_price_dr_id          varchar2(15);
    vc_during_qp_price_unit_id     varchar2(15);
    vn_error_no                    number := 0;
    vn_market_flag                 char(1);
    vn_any_day_price_fix_qty_amt   number;
    vn_any_day_price_unfix_qty_amt number;
    vn_any_day_unfixed_qty         number;
    vn_any_day_fixed_qty           number;
    vc_prompt_month                varchar2(15);
    vc_prompt_year                 number;
    vc_prompt_date                 date;
    vc_exch_rate_string            varchar2(300);
    vn_price_in_base_price_unit_id number;
    vc_fixed_price_unit_id         varchar2(15); -- During QP , Fixed Price Unit
    vn_val_to_base_corp_fx_rate    number; -- During QP Corp FX Rate from Quote to Price 
    vc_quote_cur_id                varchar2(15); -- During QP ,Quote Currency ID
    vc_quote_cur_code              varchar2(15); -- During QP ,Quote Currency Code
    vc_fixed_price_cur_id          varchar2(15);
    vc_fixed_price_cur_code        varchar2(15);
    vc_fixed_price_main_cur_id     varchar2(15);
    vc_fixed_price_main_cur_code   varchar2(15);
    vn_fixed_factor                number;
    vc_quote_main_cur_id           varchar2(15);
    vc_quote_main_cur_code         varchar2(15);
    vn_quote_factor                number;
  begin
    for cur_pcdi_rows in cur_pcdi
    loop
      if cur_pcdi_rows.payment_due_date is null then
        vd_payment_due_date := pd_trade_date;
      else
        vd_payment_due_date := cur_pcdi_rows.payment_due_date;
      end if;
      -- Get the base main cur id
      vc_base_main_cur_id      := cur_pcdi_rows.base_cur_id;
      vc_base_main_cur_code    := cur_pcdi_rows.base_currency_name;
      vc_price_fixation_status := null;
      vn_total_contract_value  := 0;
      vc_exch_rate_string      := null;
    
      if cur_pcdi_rows.price_option_call_off_status in
         ('Called Off', 'Not Applicable') then
        vc_price_fixation_status := null;
        for cur_called_off_rows in cur_called_off(cur_pcdi_rows.pcdi_id)
        loop
          vc_price_basis       := cur_called_off_rows.price_basis;
          vc_price_description := cur_called_off_rows.price_description;
        
          if cur_called_off_rows.price_basis = 'Fixed' then
          
            vn_contract_price        := cur_called_off_rows.price_value;
            vn_total_quantity        := cur_pcdi_rows.item_qty;
            vn_qty_to_be_priced      := cur_called_off_rows.qty_to_be_priced;
            vn_total_contract_value  := vn_total_contract_value +
                                        vn_total_quantity *
                                        (vn_qty_to_be_priced / 100) *
                                        vn_contract_price;
            vc_price_unit_id         := cur_called_off_rows.price_unit_id;
            vc_price_fixation_status := 'Fixed';
          
          elsif cur_called_off_rows.price_basis in ('Index', 'Formula') then
          
            for cc1 in (select ppfh.ppfh_id,
                               ppfh.price_unit_id ppu_price_unit_id,
                               ppu.price_unit_id,
                               ppu.price_unit_name,
                               pocd.qp_period_type,
                               pofh.qp_start_date,
                               pofh.qp_end_date,
                               pfqpp.event_name,
                               pfqpp.no_of_event_months,
                               pfqpp.is_qp_any_day_basis,
                               pofh.qty_to_be_fixed,
                               pofh.priced_qty,
                               pofh.pofh_id
                          from poch_price_opt_call_off_header poch,
                               pocd_price_option_calloff_dtls pocd,
                               pcbpd_pc_base_price_detail     pcbpd,
                               ppfh_phy_price_formula_header  ppfh,
                               pfqpp_phy_formula_qp_pricing   pfqpp,
                               pofh_price_opt_fixation_header pofh,
                               v_ppu_pum                      ppu
                         where poch.poch_id = pocd.poch_id
                           and pocd.pcbpd_id = pcbpd.pcbpd_id
                           and pcbpd.pcbpd_id = ppfh.pcbpd_id
                           and ppfh.ppfh_id = pfqpp.ppfh_id
                           and pocd.pocd_id = pofh.pocd_id(+)
                           and pcbpd.pcbpd_id = cur_called_off_rows.pcbpd_id
                           and poch.poch_id = cur_called_off_rows.poch_id
                           and ppfh.price_unit_id =
                               ppu.product_price_unit_id
                           and poch.is_active = 'Y'
                           and pocd.is_active = 'Y'
                           and pcbpd.is_active = 'Y'
                           and ppfh.is_active = 'Y'
                           and pfqpp.is_active = 'Y'
                              -- and pofh.is_active(+) = 'Y'
                           and pcbpd.process_id = pc_process_id
                           and pfqpp.process_id = pc_process_id
                           and ppfh.process_id = pc_process_id)
            
            loop
            
              if cur_pcdi_rows.basis_type = 'Shipment' then
                if cur_pcdi_rows.delivery_period_type = 'Month' then
                  vd_shipment_date := last_day('01-' ||
                                               cur_pcdi_rows.delivery_to_month || '-' ||
                                               cur_pcdi_rows.delivery_to_year);
                elsif cur_pcdi_rows.delivery_period_type = 'Date' then
                  vd_shipment_date := cur_pcdi_rows.delivery_to_date;
                end if;
                vd_arrival_date := vd_shipment_date +
                                   cur_pcdi_rows.transit_days;
              
              elsif cur_pcdi_rows.basis_type = 'Arrival' then
                if cur_pcdi_rows.delivery_period_type = 'Month' then
                  vd_arrival_date := last_day('01-' ||
                                              cur_pcdi_rows.delivery_to_month || '-' ||
                                              cur_pcdi_rows.delivery_to_year);
                elsif cur_pcdi_rows.delivery_period_type = 'Date' then
                  vd_arrival_date := cur_pcdi_rows.delivery_to_date;
                end if;
                vd_shipment_date := vd_arrival_date -
                                    cur_pcdi_rows.transit_days;
              end if;
            
              if cc1.qp_period_type = 'Period' then
                vd_qp_start_date := cc1.qp_start_date;
                vd_qp_end_date   := cc1.qp_end_date;
              elsif cc1.qp_period_type = 'Month' then
                vd_qp_start_date := cc1.qp_start_date;
                vd_qp_end_date   := cc1.qp_end_date;
              elsif cc1.qp_period_type = 'Date' then
                vd_qp_start_date := cc1.qp_start_date;
                vd_qp_end_date   := cc1.qp_end_date;
              elsif cc1.qp_period_type = 'Event' then
                begin
                  select dieqp.expected_qp_start_date,
                         dieqp.expected_qp_end_date
                    into vd_qp_start_date,
                         vd_qp_end_date
                    from di_del_item_exp_qp_details dieqp
                   where dieqp.pcdi_id = cur_pcdi_rows.pcdi_id
                     and dieqp.pcbpd_id = cur_called_off_rows.pcbpd_id
                     and dieqp.is_active = 'Y';
                exception
                  when no_data_found then
                    vd_qp_start_date := cc1.qp_start_date;
                    vd_qp_end_date   := cc1.qp_end_date;
                  when others then
                    vd_qp_start_date := cc1.qp_start_date;
                    vd_qp_end_date   := cc1.qp_end_date;
                end;
              else
                vd_qp_start_date := cc1.qp_start_date;
                vd_qp_end_date   := cc1.qp_end_date;
              end if;
              if cur_pcdi_rows.eod_trade_date >= vd_qp_start_date and
                 cur_pcdi_rows.eod_trade_date <= vd_qp_end_date then
                vc_period := 'During QP';
              elsif cur_pcdi_rows.eod_trade_date < vd_qp_start_date and
                    cur_pcdi_rows.eod_trade_date < vd_qp_end_date then
                vc_period := 'Before QP';
              elsif cur_pcdi_rows.eod_trade_date > vd_qp_start_date and
                    cur_pcdi_rows.eod_trade_date > vd_qp_end_date then
                vc_period := 'After QP';
              end if;
            
              if vc_period = 'Before QP' then
                vc_price_fixation_status := 'Un-priced';
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'Y' then
                  vd_3rd_wed_of_qp := f_get_next_day(vd_qp_end_date,
                                                     'Wed',
                                                     3);
                
                  while true
                  loop
                    if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                        vd_3rd_wed_of_qp) then
                      vd_3rd_wed_of_qp := vd_3rd_wed_of_qp + 1;
                    else
                      exit;
                    end if;
                  end loop;
                  --- get 3rd wednesday  before QP period 
                  -- Get the quotation date = Trade Date +2 working Days
                  if vd_3rd_wed_of_qp <= pd_trade_date then
                    workings_days  := 0;
                    vd_quotes_date := pd_trade_date + 1;
                    while workings_days <> 2
                    loop
                      if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                          vd_quotes_date) then
                        vd_quotes_date := vd_quotes_date + 1;
                      else
                        workings_days := workings_days + 1;
                        if workings_days <> 2 then
                          vd_quotes_date := vd_quotes_date + 1;
                        end if;
                      end if;
                    end loop;
                    vd_3rd_wed_of_qp := vd_quotes_date;
                  end if;
                  ---- get the dr_id             
                  begin
                    select drm.dr_id
                      into vc_before_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.prompt_date = vd_3rd_wed_of_qp
                       and rownum <= 1
                       and drm.price_point_id is null
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_price',
                                                                           'PHY-002',
                                                                           'DR_ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vd_3rd_wed_of_qp,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                    
                  end;
                end if;
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'N' and
                   cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then
                
                  vc_prompt_date  := pkg_metals_general.fn_get_next_month_prompt_date(cur_pcdi_rows.delivery_calender_id,
                                                                                      vd_qp_end_date);
                  vc_prompt_month := to_char(vc_prompt_date, 'Mon');
                  vc_prompt_year  := to_char(vc_prompt_date, 'YYYY');
                
                  ---- get the dr_id             
                  begin
                    select drm.dr_id
                      into vc_before_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.period_month = vc_prompt_month
                       and drm.period_year = vc_prompt_year
                       and rownum <= 1
                       and drm.price_point_id is null
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_price',
                                                                           'PHY-002',
                                                                           'DR_ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vc_prompt_month || ' ' ||
                                                                           vc_prompt_year,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                  end;
                end if;
                --get the price              
                begin
                  select dqd.price,
                         dqd.price_unit_id
                    into vn_before_qp_price,
                         vc_before_qp_price_unit_id
                    from dq_derivative_quotes        dq,
                         dqd_derivative_quote_detail dqd
                   where dq.dq_id = dqd.dq_id
                     and dqd.dr_id = vc_before_price_dr_id
                     and dq.process_id = pc_process_id
                     and dq.instrument_id = cur_pcdi_rows.instrument_id
                     and dq.process_id = dqd.process_id
                     and dqd.available_price_id =
                         cur_pcdi_rows.available_price_id
                     and dq.price_source_id = cur_pcdi_rows.price_source_id
                     and dqd.price_unit_id = cc1.price_unit_id
                     and dq.trade_date = pd_trade_date
                     and dq.is_deleted = 'N'
                     and dqd.is_deleted = 'N';
                exception
                  when no_data_found then
                    vobj_error_log.extend;
                    vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,'procedure sp_calc_contract_price','PHY-002','Price missing for ' || cur_pcdi_rows.instrument_name ||',Price Source:' || cur_pcdi_rows.price_source_name ||' Contract Ref No: ' || cur_pcdi_rows.contract_ref_no ||',Price Unit:' || cc1.price_unit_name ||',' || cur_pcdi_rows.available_price_name ||' Price,Prompt Date:' || (case when cur_pcdi_rows.is_daily_cal_applicable = 'N' and cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then to_char(vc_prompt_date, 'Mon-yyyy') else to_char(vd_3rd_wed_of_qp, 'dd-Mon-yyyy') end), '', gvc_process, pc_user_id, sysdate, pd_trade_date);
                    sp_insert_error_log(vobj_error_log);
                end;
                vn_total_quantity       := cur_pcdi_rows.item_qty;
                vn_qty_to_be_priced     := cur_called_off_rows.qty_to_be_priced;
                vn_total_contract_value := vn_total_contract_value +
                                           vn_total_quantity *
                                           (vn_qty_to_be_priced / 100) *
                                           vn_before_qp_price;
                vc_price_unit_id        := cc1.ppu_price_unit_id;
              elsif vc_period = 'After QP' then
                vn_after_price := 0;
                vn_after_count := 0;
                for pfd_price in (select pfd.user_price,
                                         pfd.price_unit_id,
                                         pofh.final_price
                                    from poch_price_opt_call_off_header poch,
                                         pocd_price_option_calloff_dtls pocd,
                                         pofh_price_opt_fixation_header pofh,
                                         pfd_price_fixation_details     pfd
                                   where poch.poch_id = pocd.poch_id
                                     and pocd.pocd_id = pofh.pocd_id
                                     and pfd.pofh_id = cc1.pofh_id
                                     and pofh.pofh_id = pfd.pofh_id
                                     and poch.is_active = 'Y'
                                     and pocd.is_active = 'Y'
                                     and pofh.is_active = 'Y'
                                     and pfd.is_active = 'Y')
                loop
                  vn_after_price            := vn_after_price +
                                               pfd_price.user_price;
                  vn_after_count            := vn_after_count + 1;
                  vc_after_qp_price_unit_id := pfd_price.price_unit_id;
                
                  if pfd_price.final_price is not null then
                    vc_price_fixation_status := 'Finalized';
                  end if;
                
                end loop;
                if vn_after_count = 0 then
                  vn_after_qp_price        := 0;
                  vn_total_contract_value  := 0;
                  vn_total_quantity        := cur_pcdi_rows.item_qty;
                  vc_price_fixation_status := 'Un-priced';
                else
                  if vc_price_fixation_status <> 'Finalized' then
                    vc_price_fixation_status := 'Partially Priced';
                  else
                    vc_price_fixation_status := 'Partially Priced';
                  end if;
                  vn_after_qp_price       := vn_after_price /
                                             vn_after_count;
                  vn_total_quantity       := cur_pcdi_rows.item_qty;
                  vn_qty_to_be_priced     := cur_called_off_rows.qty_to_be_priced;
                  vn_total_contract_value := vn_total_contract_value +
                                             vn_total_quantity *
                                             (vn_qty_to_be_priced / 100) *
                                             vn_after_qp_price;
                  vc_price_unit_id        := vc_after_qp_price_unit_id;
                end if;
              elsif vc_period = 'During QP' then
                vd_dur_qp_start_date         := vd_qp_start_date;
                vd_dur_qp_end_date           := vd_qp_end_date;
                vn_during_total_set_price    := 0;
                vn_count_set_qp              := 0;
                vn_any_day_price_fix_qty_amt := 0;
                vn_any_day_fixed_qty         := 0;
                for cc in (select pfd.user_price,
                                  pfd.as_of_date,
                                  pfd.qty_fixed,
                                  pofh.final_price,
                                  pfd.price_unit_id,
                                  vppu.price_unit_id pum_fixed_price_unit_id
                             from poch_price_opt_call_off_header poch,
                                  pocd_price_option_calloff_dtls pocd,
                                  pofh_price_opt_fixation_header pofh,
                                  pfd_price_fixation_details     pfd,
                                  v_ppu_pum                      vppu
                            where poch.poch_id = pocd.poch_id
                              and pocd.pocd_id = pofh.pocd_id
                              and pofh.pofh_id = cc1.pofh_id
                              and pofh.pofh_id = pfd.pofh_id
                              and pfd.as_of_date >= vd_dur_qp_start_date
                              and pfd.as_of_date <= pd_trade_date
                              and pfd.price_unit_id =
                                  vppu.product_price_unit_id
                              and poch.is_active = 'Y'
                              and pocd.is_active = 'Y'
                              and pofh.is_active = 'Y'
                              and pfd.is_active = 'Y')
                loop
                  vn_during_total_set_price    := vn_during_total_set_price +
                                                  cc.user_price;
                  vn_any_day_price_fix_qty_amt := vn_any_day_price_fix_qty_amt +
                                                  (cc.user_price *
                                                  cc.qty_fixed);
                  vn_any_day_fixed_qty         := vn_any_day_fixed_qty +
                                                  cc.qty_fixed;
                  vn_count_set_qp              := vn_count_set_qp + 1;
                  vc_fixed_price_unit_id       := cc.price_unit_id;
                  if cc.final_price is not null then
                    vc_price_fixation_status := 'Finalized';
                  end if;
                end loop;
              
                if vn_count_set_qp <> 0 then
                  if vc_price_fixation_status <> 'Finalized' then
                    vc_price_fixation_status := 'Partially Priced';
                  end if;
                else
                  vc_price_fixation_status := 'Un-priced';
                
                end if;
              
                if cc1.is_qp_any_day_basis = 'Y' then
                  vn_market_flag := 'N';
                else
                  vn_market_flag := 'Y';
                end if;
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'Y' then
                  -- get the third wednesday
                  vd_3rd_wed_of_qp := f_get_next_day(vd_dur_qp_end_date,
                                                     'Wed',
                                                     3);
                  while true
                  loop
                    if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                        vd_3rd_wed_of_qp) then
                      vd_3rd_wed_of_qp := vd_3rd_wed_of_qp + 1;
                    else
                      exit;
                    end if;
                  end loop;
                  --- get 3rd wednesday  before QP period 
                  -- Get the quotation date = Trade Date +2 working Days
                  if vd_3rd_wed_of_qp <= pd_trade_date then
                    workings_days  := 0;
                    vd_quotes_date := pd_trade_date + 1;
                    while workings_days <> 2
                    loop
                      if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                          vd_quotes_date) then
                        vd_quotes_date := vd_quotes_date + 1;
                      else
                        workings_days := workings_days + 1;
                        if workings_days <> 2 then
                          vd_quotes_date := vd_quotes_date + 1;
                        end if;
                      end if;
                    end loop;
                    vd_3rd_wed_of_qp := vd_quotes_date;
                  end if;
                  --Get the DR-id
                  begin
                    select drm.dr_id
                      into vc_during_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.prompt_date = vd_3rd_wed_of_qp
                       and rownum <= 1
                       and drm.price_point_id is null
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_price',
                                                                           'PHY-002',
                                                                           'DR-ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cc1.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vd_3rd_wed_of_qp,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                  end;
                end if;
                if cur_pcdi_rows.is_daily_cal_applicable = 'N' and
                   cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then
                
                  vc_prompt_date  := pkg_metals_general.fn_get_next_month_prompt_date(cur_pcdi_rows.delivery_calender_id,
                                                                                      vd_qp_end_date);
                  vc_prompt_month := to_char(vc_prompt_date, 'Mon');
                  vc_prompt_year  := to_char(vc_prompt_date, 'YYYY');
                  ---- get the dr_id             
                  begin
                    select drm.dr_id
                      into vc_during_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.period_month = vc_prompt_month
                       and drm.period_year = vc_prompt_year
                       and rownum <= 1
                       and drm.price_point_id is null
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_price',
                                                                           'PHY-002',
                                                                           'DR_ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vc_prompt_month || ' ' ||
                                                                           vc_prompt_year,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                  end;
                end if;
                --Get the price for the dr-id
                begin
                  select dqd.price,
                         dqd.price_unit_id
                    into vn_during_val_price,
                         vc_during_val_price_unit_id
                    from dq_derivative_quotes        dq,
                         dqd_derivative_quote_detail dqd
                   where dq.dq_id = dqd.dq_id
                     and dqd.dr_id = vc_during_price_dr_id
                     and dq.instrument_id = cur_pcdi_rows.instrument_id
                     and dq.dbd_id = dqd.dbd_id
                     and dq.dbd_id = pc_dbd_id
                     and dqd.available_price_id =
                         cur_pcdi_rows.available_price_id
                     and dq.price_source_id = cur_pcdi_rows.price_source_id
                     and dqd.price_unit_id = cc1.price_unit_id
                     and dq.trade_date = pd_trade_date
                     and dq.is_deleted = 'N'
                     and dqd.is_deleted = 'N';
                exception
                  when no_data_found then
                    vobj_error_log.extend;
                    vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,'procedure sp_calc_contract_price','PHY-002','Price missing for ' || cur_pcdi_rows.instrument_name ||',Price Source:' || cur_pcdi_rows.price_source_name ||' Contract Ref No: ' || cur_pcdi_rows.contract_ref_no ||',Price Unit:' || cc1.price_unit_name ||',' || cur_pcdi_rows.available_price_name ||' Price,Prompt Date:' || (case when cur_pcdi_rows.is_daily_cal_applicable = 'N' and cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then to_char(vc_prompt_date, 'Mon-yyyy') else to_char(vd_3rd_wed_of_qp, 'dd-Mon-yyyy') end), '', gvc_process, pc_user_id, sysdate, pd_trade_date);
                    sp_insert_error_log(vobj_error_log);
                end;
              
                vn_during_total_val_price := 0;
                vn_count_val_qp           := 0;
                vd_dur_qp_start_date      := pd_trade_date + 1;
              
                if vn_market_flag = 'N' then
                  vn_during_total_val_price := vn_during_total_val_price +
                                               vn_during_val_price;
                
                  vn_any_day_unfixed_qty         := cc1.qty_to_be_fixed -
                                                    vn_any_day_fixed_qty;
                  vn_count_val_qp                := vn_count_val_qp + 1;
                  vn_any_day_price_unfix_qty_amt := (vn_any_day_unfixed_qty *
                                                    vn_during_total_val_price);
                  if vn_any_day_unfixed_qty > 0 then
                    vc_price_fixation_status := 'Partially Priced';
                  else
                    vc_price_fixation_status := 'Priced';
                  end if;
                else
                
                  while vd_dur_qp_start_date <= vd_dur_qp_end_date
                  loop
                    ---- finding holidays       
                    if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                        vd_dur_qp_start_date) then
                      vc_holiday := 'Y';
                    else
                      vc_holiday := 'N';
                    end if;
                  
                    if vc_holiday = 'N' then
                      vn_during_total_val_price := vn_during_total_val_price +
                                                   vn_during_val_price;
                      vn_count_val_qp           := vn_count_val_qp + 1;
                    end if;
                    vd_dur_qp_start_date := vd_dur_qp_start_date + 1;
                  end loop;
                end if;
              
                if (vn_count_val_qp + vn_count_set_qp) <> 0 then
                
                  if vn_market_flag = 'N' then
                    vn_during_qp_price := (vn_any_day_price_fix_qty_amt +
                                          vn_any_day_price_unfix_qty_amt) /
                                          cc1.qty_to_be_fixed;
                  
                  else
                    vn_during_qp_price := (vn_during_total_set_price +
                                          vn_during_total_val_price) /
                                          (vn_count_set_qp +
                                          vn_count_val_qp);
                  
                  end if;
                
                  vn_total_quantity       := cur_pcdi_rows.item_qty;
                  vn_qty_to_be_priced     := cur_called_off_rows.qty_to_be_priced;
                  vn_total_contract_value := vn_total_contract_value +
                                             vn_total_quantity *
                                             (vn_qty_to_be_priced / 100) *
                                             vn_during_qp_price;
                
                  --                  vc_price_unit_id        := cur_pcdi_rows.ppu_price_unit_id;
                
                else
                  vn_total_quantity       := cur_pcdi_rows.item_qty;
                  vn_total_contract_value := 0;
                
                  --                  vc_price_unit_id        := cur_pcdi_rows.ppu_price_unit_id;
                end if;
                vc_price_unit_id := cc1.ppu_price_unit_id;
              end if;
            
            end loop;
          
          end if;
        end loop;
        vn_average_price := round(vn_total_contract_value /
                                  vn_total_quantity,
                                  3);
      
        vn_error_no := vn_error_no + 1;
      elsif cur_pcdi_rows.price_option_call_off_status = 'Not Called Off' then
        vn_error_no              := vn_error_no + 1;
        vc_price_fixation_status := null;
        for cur_not_called_off_rows in cur_not_called_off(cur_pcdi_rows.pcdi_id,
                                                          cur_pcdi_rows.internal_contract_item_ref_no)
        loop
          vc_price_basis       := cur_not_called_off_rows.price_basis;
          vc_price_description := cur_not_called_off_rows.price_description;
          -- vn_total_contract_value := 0;
          if cur_not_called_off_rows.price_basis = 'Fixed' then
            vn_contract_price        := cur_not_called_off_rows.price_value;
            vn_total_quantity        := cur_pcdi_rows.item_qty;
            vn_qty_to_be_priced      := cur_not_called_off_rows.qty_to_be_priced;
            vn_total_contract_value  := vn_total_contract_value +
                                        vn_total_quantity *
                                        (vn_qty_to_be_priced / 100) *
                                        vn_contract_price;
            vc_price_unit_id         := cur_not_called_off_rows.price_unit_id;
            vc_price_fixation_status := 'Fixed';
            vn_error_no              := 3;
          elsif cur_not_called_off_rows.price_basis in ('Index', 'Formula') then
            for cc1 in (select pfqpp.qp_pricing_period_type,
                               pfqpp.qp_period_from_date,
                               pfqpp.qp_period_to_date,
                               pfqpp.qp_month,
                               pfqpp.qp_year,
                               pfqpp.qp_date,
                               pfqpp.event_name,
                               pfqpp.no_of_event_months,
                               ppfh.price_unit_id ppu_price_unit_id,
                               ppu.price_unit_id, --pum price unit id, as quoted available in this unit only
                               ppu.price_unit_name
                          from ppfh_phy_price_formula_header ppfh,
                               pfqpp_phy_formula_qp_pricing  pfqpp,
                               v_ppu_pum                     ppu
                         where ppfh.ppfh_id = pfqpp.ppfh_id
                           and ppfh.pcbpd_id =
                               cur_not_called_off_rows.pcbpd_id
                           and ppfh.is_active = 'Y'
                           and pfqpp.is_active = 'Y'
                           and ppfh.price_unit_id =
                               ppu.product_price_unit_id
                           and ppfh.process_id = pc_process_id
                           and pfqpp.process_id = pc_process_id)
            loop
            
              if cur_pcdi_rows.basis_type = 'Shipment' then
                if cur_pcdi_rows.delivery_period_type = 'Month' then
                  vd_shipment_date := last_day('01-' ||
                                               cur_pcdi_rows.delivery_to_month || '-' ||
                                               cur_pcdi_rows.delivery_to_year);
                elsif cur_pcdi_rows.delivery_period_type = 'Date' then
                  vd_shipment_date := cur_pcdi_rows.delivery_to_date;
                end if;
                vd_arrival_date := vd_shipment_date +
                                   cur_pcdi_rows.transit_days;
              
              elsif cur_pcdi_rows.basis_type = 'Arrival' then
                if cur_pcdi_rows.delivery_period_type = 'Month' then
                  vd_arrival_date := last_day('01-' ||
                                              cur_pcdi_rows.delivery_to_month || '-' ||
                                              cur_pcdi_rows.delivery_to_year);
                elsif cur_pcdi_rows.delivery_period_type = 'Date' then
                  vd_arrival_date := cur_pcdi_rows.delivery_to_date;
                end if;
                vd_shipment_date := vd_arrival_date -
                                    cur_pcdi_rows.transit_days;
              end if;
            
              if cc1.qp_pricing_period_type = 'Period' then
                vd_qp_start_date := cc1.qp_period_from_date;
                vd_qp_end_date   := cc1.qp_period_to_date;
              elsif cc1.qp_pricing_period_type = 'Month' then
                vd_qp_start_date := '01-' || cc1.qp_month || '-' ||
                                    cc1.qp_year;
                vd_qp_end_date   := last_day(vd_qp_start_date);
              elsif cc1.qp_pricing_period_type = 'Date' then
                vd_qp_start_date := cc1.qp_date;
                vd_qp_end_date   := cc1.qp_date;
              elsif cc1.qp_pricing_period_type = 'Event' then
                begin
                  select dieqp.expected_qp_start_date,
                         dieqp.expected_qp_end_date
                    into vd_qp_start_date,
                         vd_qp_end_date
                    from di_del_item_exp_qp_details dieqp
                   where dieqp.pcdi_id = cur_pcdi_rows.pcdi_id
                     and dieqp.pcbpd_id = cur_not_called_off_rows.pcbpd_id
                     and dieqp.is_active = 'Y';
                exception
                  when no_data_found then
                    vd_qp_start_date := cc1.qp_period_from_date;
                    vd_qp_end_date   := cc1.qp_period_to_date;
                  when others then
                    vd_qp_start_date := cc1.qp_period_from_date;
                    vd_qp_end_date   := cc1.qp_period_to_date;
                end;
              else
                vd_qp_start_date := cc1.qp_period_from_date;
                vd_qp_end_date   := cc1.qp_period_to_date;
              end if;
              if cur_pcdi_rows.eod_trade_date >= vd_qp_start_date and
                 cur_pcdi_rows.eod_trade_date <= vd_qp_end_date then
                vc_period := 'During QP';
              elsif cur_pcdi_rows.eod_trade_date < vd_qp_start_date and
                    cur_pcdi_rows.eod_trade_date < vd_qp_end_date then
                vc_period := 'Before QP';
              elsif cur_pcdi_rows.eod_trade_date > vd_qp_start_date and
                    cur_pcdi_rows.eod_trade_date > vd_qp_end_date then
                vc_period := 'After QP';
              end if;
            
              if vc_period = 'Before QP' then
              
                vc_price_fixation_status := 'Un-priced';
              
                vn_error_no := 4;
                ---- get third wednesday of QP period
                --  If 3rd Wednesday of QP End date is not a prompt date, get the next valid prompt date
                if cur_pcdi_rows.is_daily_cal_applicable = 'Y' then
                  vd_3rd_wed_of_qp := f_get_next_day(vd_qp_end_date,
                                                     'Wed',
                                                     3);
                  while true
                  loop
                    if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                        vd_3rd_wed_of_qp) then
                      vd_3rd_wed_of_qp := vd_3rd_wed_of_qp + 1;
                    else
                      exit;
                    end if;
                  end loop;
                  --- get 3rd wednesday  before QP period 
                  -- Get the quotation date = Trade Date +2 working Days
                  if vd_3rd_wed_of_qp <= pd_trade_date then
                    workings_days  := 0;
                    vd_quotes_date := pd_trade_date + 1;
                    while workings_days <> 2
                    loop
                      if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                          vd_quotes_date) then
                        vd_quotes_date := vd_quotes_date + 1;
                      else
                        workings_days := workings_days + 1;
                        if workings_days <> 2 then
                          vd_quotes_date := vd_quotes_date + 1;
                        end if;
                      end if;
                    end loop;
                    vd_3rd_wed_of_qp := vd_quotes_date;
                  end if;
                  --get the price dr_id   
                  begin
                    select drm.dr_id
                      into vc_before_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.prompt_date = vd_3rd_wed_of_qp
                       and drm.price_point_id is null
                       and rownum <= 1
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_price',
                                                                           'PHY-002',
                                                                           'DR-ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cc1.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vd_3rd_wed_of_qp,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                  end;
                end if;
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'N' and
                   cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then
                
                  vc_prompt_date  := pkg_metals_general.fn_get_next_month_prompt_date(cur_pcdi_rows.delivery_calender_id,
                                                                                      vd_qp_end_date);
                  vc_prompt_month := to_char(vc_prompt_date, 'Mon');
                  vc_prompt_year  := to_char(vc_prompt_date, 'YYYY');
                
                  ---- get the dr_id             
                  begin
                    select drm.dr_id
                      into vc_before_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.period_month = vc_prompt_month
                       and drm.period_year = vc_prompt_year
                       and rownum <= 1
                       and drm.price_point_id is null
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_price',
                                                                           'PHY-002',
                                                                           'DR_ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vc_prompt_month || ' ' ||
                                                                           vc_prompt_year,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                    
                  end;
                
                end if;
              
                --get the price
              
                begin
                  select dqd.price,
                         dqd.price_unit_id
                    into vn_before_qp_price,
                         vc_before_qp_price_unit_id
                    from dq_derivative_quotes        dq,
                         dqd_derivative_quote_detail dqd
                   where dq.dq_id = dqd.dq_id
                     and dqd.dr_id = vc_before_price_dr_id
                     and dq.process_id = pc_process_id
                     and dq.instrument_id = cur_pcdi_rows.instrument_id
                     and dq.process_id = dqd.process_id
                     and dqd.available_price_id =
                         cur_pcdi_rows.available_price_id
                     and dq.price_source_id = cur_pcdi_rows.price_source_id
                     and dqd.price_unit_id = cc1.price_unit_id
                     and dq.trade_date = pd_trade_date
                     and dq.is_deleted = 'N'
                     and dqd.is_deleted = 'N';
                exception
                  when no_data_found then
                    vobj_error_log.extend;
                    vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,'procedure sp_calc_contract_price','PHY-002','Price missing for ' || cur_pcdi_rows.instrument_name ||',Price Source:' || cur_pcdi_rows.price_source_name ||' Contract Ref No: ' || cur_pcdi_rows.contract_ref_no ||',Price Unit:' || cc1.price_unit_name ||',' || cur_pcdi_rows.available_price_name ||' Price,Prompt Date:' || (case when cur_pcdi_rows.is_daily_cal_applicable = 'N' and cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then to_char(vc_prompt_date, 'Mon-yyyy') else to_char(vd_3rd_wed_of_qp, 'dd-Mon-yyyy') end), '', gvc_process, pc_user_id, sysdate, pd_trade_date);
                    sp_insert_error_log(vobj_error_log);
                end;
                vn_total_quantity       := cur_pcdi_rows.item_qty;
                vn_qty_to_be_priced     := cur_not_called_off_rows.qty_to_be_priced;
                vn_total_contract_value := vn_total_contract_value +
                                           vn_total_quantity *
                                           (vn_qty_to_be_priced / 100) *
                                           vn_before_qp_price;
                vc_price_unit_id        := cc1.ppu_price_unit_id;
              
              elsif vc_period = 'After QP' then
                vc_price_fixation_status := 'Un-priced';
                vn_error_no              := 5;
                if cur_pcdi_rows.is_daily_cal_applicable = 'Y' then
                  vd_3rd_wed_of_qp := f_get_next_day(vd_qp_end_date,
                                                     'Wed',
                                                     3);
                  while true
                  loop
                    if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                        vd_3rd_wed_of_qp) then
                      vd_3rd_wed_of_qp := vd_3rd_wed_of_qp + 1;
                    else
                      exit;
                    end if;
                  end loop;
                  --- get 3rd wednesday  before QP period 
                  -- Get the quotation date = Trade Date +2 working Days
                  if vd_3rd_wed_of_qp <= pd_trade_date then
                    workings_days  := 0;
                    vd_quotes_date := pd_trade_date + 1;
                    while workings_days <> 2
                    loop
                      if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                          vd_quotes_date) then
                        vd_quotes_date := vd_quotes_date + 1;
                      else
                        workings_days := workings_days + 1;
                        if workings_days <> 2 then
                          vd_quotes_date := vd_quotes_date + 1;
                        end if;
                      end if;
                    end loop;
                    vd_3rd_wed_of_qp := vd_quotes_date;
                  end if;
                
                  --get the price dr_id   
                  begin
                    select drm.dr_id
                      into vc_after_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.prompt_date = vd_3rd_wed_of_qp
                       and drm.price_point_id is null
                       and rownum <= 1
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_price',
                                                                           'PHY-002',
                                                                           'DR-ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cc1.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vd_3rd_wed_of_qp,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                  end;
                end if;
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'N' and
                   cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then
                
                  vc_prompt_date  := pkg_metals_general.fn_get_next_month_prompt_date(cur_pcdi_rows.delivery_calender_id,
                                                                                      vd_qp_end_date);
                  vc_prompt_month := to_char(vc_prompt_date, 'Mon');
                  vc_prompt_year  := to_char(vc_prompt_date, 'YYYY');
                
                  ---- get the dr_id             
                  begin
                    select drm.dr_id
                      into vc_after_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.period_month = vc_prompt_month
                       and drm.period_year = vc_prompt_year
                       and rownum <= 1
                       and drm.price_point_id is null
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_price',
                                                                           'PHY-002',
                                                                           'DR_ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vc_prompt_month || ' ' ||
                                                                           vc_prompt_year,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                  end;
                end if;
                --get the price
              
                begin
                  select dqd.price,
                         dqd.price_unit_id
                    into vn_after_qp_price,
                         vc_after_qp_price_unit_id
                    from dq_derivative_quotes        dq,
                         dqd_derivative_quote_detail dqd
                   where dq.dq_id = dqd.dq_id
                     and dqd.dr_id = vc_after_price_dr_id
                     and dq.process_id = pc_process_id
                     and dq.instrument_id = cur_pcdi_rows.instrument_id
                     and dq.process_id = dqd.process_id
                     and dqd.available_price_id =
                         cur_pcdi_rows.available_price_id
                     and dq.price_source_id = cur_pcdi_rows.price_source_id
                     and dqd.price_unit_id = cc1.price_unit_id
                     and dq.trade_date = pd_trade_date
                     and dq.is_deleted = 'N'
                     and dqd.is_deleted = 'N';
                exception
                  when no_data_found then
                    vobj_error_log.extend;
                    vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,'procedure sp_calc_contract_price','PHY-002','Price missing for ' || cur_pcdi_rows.instrument_name ||',Price Source:' || cur_pcdi_rows.price_source_name ||' Contract Ref No: ' || cur_pcdi_rows.contract_ref_no ||',Price Unit:' || cc1.price_unit_name ||',' || cur_pcdi_rows.available_price_name ||' Price,Prompt Date:' || (case when cur_pcdi_rows.is_daily_cal_applicable = 'N' and cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then to_char(vc_prompt_date, 'Mon-yyyy') else to_char(vd_3rd_wed_of_qp, 'dd-Mon-yyyy') end), '', gvc_process, pc_user_id, sysdate, pd_trade_date);
                    sp_insert_error_log(vobj_error_log);
                end;
                vn_total_quantity       := cur_pcdi_rows.item_qty;
                vn_qty_to_be_priced     := cur_not_called_off_rows.qty_to_be_priced;
                vn_total_contract_value := vn_total_contract_value +
                                           vn_total_quantity *
                                           (vn_qty_to_be_priced / 100) *
                                           vn_after_qp_price;
                vc_price_unit_id        := cc1.ppu_price_unit_id;
              
              elsif vc_period = 'During QP' then
                vc_price_fixation_status := 'Un-priced';
                vn_error_no              := 6;
                if cur_pcdi_rows.is_daily_cal_applicable = 'Y' then
                  vd_3rd_wed_of_qp := f_get_next_day(vd_qp_end_date,
                                                     'Wed',
                                                     3);
                  while true
                  loop
                    if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                        vd_3rd_wed_of_qp) then
                      vd_3rd_wed_of_qp := vd_3rd_wed_of_qp + 1;
                    else
                      exit;
                    end if;
                  end loop;
                  --- get 3rd wednesday  before QP period 
                  -- Get the quotation date = Trade Date +2 working Days
                  if vd_3rd_wed_of_qp <= pd_trade_date then
                    workings_days  := 0;
                    vd_quotes_date := pd_trade_date + 1;
                    while workings_days <> 2
                    loop
                      if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                          vd_quotes_date) then
                        vd_quotes_date := vd_quotes_date + 1;
                      else
                        workings_days := workings_days + 1;
                        if workings_days <> 2 then
                          vd_quotes_date := vd_quotes_date + 1;
                        end if;
                      end if;
                    end loop;
                    vd_3rd_wed_of_qp := vd_quotes_date;
                  end if;
                
                  --get the price dr_id   
                  begin
                    select drm.dr_id
                      into vc_during_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.prompt_date = vd_3rd_wed_of_qp
                       and drm.price_point_id is null
                       and rownum <= 1
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_price',
                                                                           'PHY-002',
                                                                           'DR-ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cc1.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vd_3rd_wed_of_qp,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                  end;
                end if;
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'N' and
                   cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then
                
                  vc_prompt_date  := pkg_metals_general.fn_get_next_month_prompt_date(cur_pcdi_rows.delivery_calender_id,
                                                                                      vd_qp_end_date);
                  vc_prompt_month := to_char(vc_prompt_date, 'Mon');
                  vc_prompt_year  := to_char(vc_prompt_date, 'YYYY');
                
                  ---- get the dr_id             
                  begin
                    select drm.dr_id
                      into vc_during_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.period_month = vc_prompt_month
                       and drm.period_year = vc_prompt_year
                       and rownum <= 1
                       and drm.price_point_id is null
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_price',
                                                                           'PHY-002',
                                                                           'DR_ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vc_prompt_month || ' ' ||
                                                                           vc_prompt_year,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                  end;
                end if;
              
                --get the price              
                begin
                  select dqd.price,
                         dqd.price_unit_id
                    into vn_during_qp_price,
                         vc_during_qp_price_unit_id
                    from dq_derivative_quotes        dq,
                         dqd_derivative_quote_detail dqd
                   where dq.dq_id = dqd.dq_id
                     and dqd.dr_id = vc_during_price_dr_id
                     and dq.process_id = pc_process_id
                     and dq.instrument_id = cur_pcdi_rows.instrument_id
                     and dq.process_id = dqd.process_id
                     and dqd.available_price_id =
                         cur_pcdi_rows.available_price_id
                     and dq.price_source_id = cur_pcdi_rows.price_source_id
                     and dqd.price_unit_id = cc1.price_unit_id
                     and dq.trade_date = pd_trade_date
                     and dq.is_deleted = 'N'
                     and dqd.is_deleted = 'N';
                exception
                  when no_data_found then
                    vobj_error_log.extend;
                    vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,'procedure sp_calc_contract_price','PHY-002','Price missing for ' || cur_pcdi_rows.instrument_name ||',Price Source:' || cur_pcdi_rows.price_source_name ||' Contract Ref No: ' || cur_pcdi_rows.contract_ref_no ||',Price Unit:' || cc1.price_unit_name ||',' || cur_pcdi_rows.available_price_name ||' Price,Prompt Date:' || (case when cur_pcdi_rows.is_daily_cal_applicable = 'N' and cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then to_char(vc_prompt_date, 'Mon-yyyy') else to_char(vd_3rd_wed_of_qp, 'dd-Mon-yyyy') end), '', gvc_process, pc_user_id, sysdate, pd_trade_date);
                    sp_insert_error_log(vobj_error_log);
                end;
                vn_total_quantity       := cur_pcdi_rows.item_qty;
                vn_qty_to_be_priced     := cur_not_called_off_rows.qty_to_be_priced;
                vn_total_contract_value := vn_total_contract_value +
                                           vn_total_quantity *
                                           (vn_qty_to_be_priced / 100) *
                                           vn_during_qp_price;
                vc_price_unit_id        := cc1.ppu_price_unit_id;
              
              end if;
            end loop;
          end if;
        end loop;
        vn_average_price := round(vn_total_contract_value /
                                  vn_total_quantity,
                                  3);
      end if;
      vn_error_no := 7;
      begin
        select cm.cur_id,
               cm.cur_code,
               ppu.weight,
               ppu.weight_unit_id,
               qum.qty_unit
          into vc_price_cur_id,
               vc_price_cur_code,
               vc_price_weight_unit,
               vc_price_weight_unit_id,
               vc_price_qty_unit
          from v_ppu_pum                ppu,
               cm_currency_master       cm,
               qum_quantity_unit_master qum
         where ppu.product_price_unit_id = vc_price_unit_id
           and ppu.cur_id = cm.cur_id
           and qum.qty_unit_id = ppu.weight_unit_id;
      
        pkg_general.sp_get_base_cur_detail(vc_price_cur_id,
                                           vc_contract_main_cur_id,
                                           vc_contract_main_cur_code,
                                           vn_contract_main_cur_factor);
        vn_error_no := 8;
      
      exception
        when no_data_found then
          vc_price_cur_id         := null;
          vc_price_cur_code       := null;
          vc_price_weight_unit    := null;
          vc_price_weight_unit_id := null;
          vc_price_qty_unit       := null;
      end;
    
      -- Get the contract base price Unit id
      begin
      
        select ppu.product_price_unit_id
          into vc_contract_base_price_unit_id
          from v_ppu_pum ppu
         where ppu.weight_unit_id = cur_pcdi_rows.item_qty_unit_id
           and ppu.product_id = cur_pcdi_rows.product_id
           and ppu.cur_id = cur_pcdi_rows.base_cur_id;
      
      exception
        when no_data_found then
          vc_contract_base_price_unit_id := null;
      end;
      --
      -- Convert the final price into base price unit ID
      --
      --
      -- Get the Forward Exchange Rate from Price Unit ID to Base Price Unit ID
      --
      if vc_price_cur_id <> vc_base_main_cur_id then
        pkg_general.sp_forward_cur_exchange_new(pc_corporate_id,
                                                pd_trade_date,
                                                vd_payment_due_date,
                                                vc_price_cur_id,
                                                vc_base_main_cur_id,
                                                30,
                                                vn_fw_exch_rate_price_to_base,
                                                vn_forward_points);
      
        if vc_exch_rate_string is null then
          vc_exch_rate_string := '1 ' || vc_price_cur_code || '=' ||
                                 vn_fw_exch_rate_price_to_base || ' ' ||
                                 vc_base_main_cur_code;
        else
          vc_exch_rate_string := vc_exch_rate_string || ',' || '1 ' ||
                                 vc_price_cur_code || '=' ||
                                 vn_fw_exch_rate_price_to_base || ' ' ||
                                 vc_base_main_cur_code;
        end if;
      else
        vn_fw_exch_rate_price_to_base := 1.0;
      end if;
      vn_price_in_base_price_unit_id := vn_fw_exch_rate_price_to_base *
                                        vn_contract_main_cur_factor *
                                        pkg_general.f_get_converted_quantity(cur_pcdi_rows.product_id,
                                                                             vc_price_weight_unit_id,
                                                                             cur_pcdi_rows.item_qty_unit_id,
                                                                             1) *
                                        vn_average_price;
    
      vn_error_no := 9;
      insert into cipd_contract_item_price_daily
        (corporate_id,
         pcdi_id,
         internal_contract_item_ref_no,
         internal_contract_ref_no,
         contract_ref_no,
         delivery_item_no,
         contract_price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         price_unit_weight,
         price_unit_weight_unit_id,
         price_unit_weight_unit,
         price_basis,
         price_fixation_details,
         contract_equity_premium,
         market_equity_premium,
         mkt_equity_prem_price_unit_id,
         cont_equity_prem_price_unit_id,
         process_id,
         price_fixation_status,
         price_fixed_qty,
         total_qty,
         payment_due_date,
         contract_base_price_unit_id,
         -- contract_base_fx_rate,
         exch_rate_string,
         price_description,
         price_in_base_price_unit_id)
      values
        (pc_corporate_id,
         cur_pcdi_rows.pcdi_id,
         cur_pcdi_rows.internal_contract_item_ref_no,
         cur_pcdi_rows.internal_contract_ref_no,
         cur_pcdi_rows.contract_ref_no,
         cur_pcdi_rows.delivery_item_no,
         vn_average_price,
         vc_price_unit_id,
         vc_price_cur_id,
         vc_price_cur_code,
         vc_price_weight_unit,
         vc_price_weight_unit_id,
         vc_price_qty_unit,
         vc_price_basis,
         'Not Applicable',
         vn_contract_equity_premium,
         vn_market_equity_premium,
         vc_mar_equ_prem_price_unit_id,
         vc_con_equ_prem_price_unit_id,
         pc_process_id,
         vc_price_fixation_status,
         vn_price_fixed_qty,
         vn_total_qty,
         cur_pcdi_rows.payment_due_date,
         vc_contract_base_price_unit_id,
         -- vn_fw_exch_rate_price_to_base,
         vc_exch_rate_string,
         vc_price_description,
         vn_price_in_base_price_unit_id);
      update pci_physical_contract_item pci
         set pci.price_description = vc_price_description
       where pci.internal_contract_item_ref_no =
            
             cur_pcdi_rows.internal_contract_item_ref_no
         and pci.process_id = pc_process_id;
    
    end loop;
  
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure pkg_phy_physical_process contract price',
                                                           'M2M-013',
                                                           ' Code:' ||
                                                           sqlcode ||
                                                           ' Message:' ||
                                                           sqlerrm ||
                                                           dbms_utility.format_error_backtrace ||
                                                           'No ' ||
                                                           vn_error_no,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;

  procedure sp_calc_gmr_price(pc_corporate_id varchar2,
                              pd_trade_date   date,
                              pc_process_id   varchar2,
                              pc_user_id      varchar2,
                              pc_dbd_id       varchar2) is
  
    cursor cur_gmr is
      select gmr.corporate_id,
             grd.product_id,
             gmr.internal_gmr_ref_no,
             gmr.gmr_ref_no,
             gmr.current_qty,
             pofh.qp_start_date,
             pofh.qp_end_date,
             pofh.pofh_id,
             pd_trade_date eod_trade_date,
             qat.instrument_id,
             dim.instrument_name,
             ps.price_source_id,
             ps.price_source_name,
             apm.available_price_id,
             apm.available_price_name,
             pum.price_unit_name,
             vdip.ppu_price_unit_id,
             div.price_unit_id,
             pocd.is_any_day_pricing,
             pofh.qty_to_be_fixed,
             round(pofh.priced_qty, 4) priced_qty,
             pofh.no_of_prompt_days,
             pocd.pcbpd_id,
             dim.delivery_calender_id,
             pdc.is_daily_cal_applicable,
             pdc.is_monthly_cal_applicable,
             grd.payment_due_date
        from gmr_goods_movement_record gmr,
             (select grd.internal_gmr_ref_no,
                     grd.quality_id,
                     grd.product_id,
                     (case
                       when nvl(grd.payment_due_date, pd_trade_date) <
                            pd_trade_date then
                        pd_trade_date
                       else
                        grd.payment_due_date
                     end) payment_due_date
              
                from grd_goods_record_detail grd
               where grd.process_id = pc_process_id
                 and grd.status = 'Active'
                 and grd.is_deleted = 'N'
                 and nvl(grd.inventory_status, 'NA') <> 'Out'
               group by grd.internal_gmr_ref_no,
                        grd.quality_id,
                        grd.product_id,
                        (case
                          when nvl(grd.payment_due_date, pd_trade_date) <
                               pd_trade_date then
                           pd_trade_date
                          else
                           grd.payment_due_date
                        end)) grd,
             pdm_productmaster pdm,
             pdtm_product_type_master pdtm,
             pofh_price_opt_fixation_header pofh,
             pocd_price_option_calloff_dtls pocd,
             --mv_qat_quality_valuation qat,
             v_gmr_exchange_detail        qat,
             dim_der_instrument_master    dim,
             div_der_instrument_valuation div,
             ps_price_source              ps,
             apm_available_price_master   apm,
             pum_price_unit_master        pum,
             v_der_instrument_price_unit  vdip,
             pdc_prompt_delivery_calendar pdc
       where gmr.internal_gmr_ref_no = grd.internal_gmr_ref_no
         and grd.product_id = pdm.product_id
         and pdm.product_type_id = pdtm.product_type_id
         and pdtm.product_type_name = 'Standard'
         and gmr.internal_gmr_ref_no = pofh.internal_gmr_ref_no
         and pofh.pocd_id = pocd.pocd_id
            --and grd.quality_id = qat.quality_id
         and gmr.process_id = pc_process_id
            --and qat.corporate_id = pc_corporate_id
         and gmr.internal_gmr_ref_no = qat.internal_gmr_ref_no(+)
         and gmr.process_id = qat.process_id(+)
         and qat.instrument_id = dim.instrument_id(+)
         and dim.instrument_id = div.instrument_id(+)
         and div.is_deleted(+) = 'N'
         and div.price_source_id = ps.price_source_id(+)
         and div.available_price_id = apm.available_price_id(+)
         and div.price_unit_id = pum.price_unit_id(+)
         and dim.instrument_id = vdip.instrument_id(+)
         and dim.delivery_calender_id = pdc.prompt_delivery_calendar_id(+)
         and gmr.is_deleted = 'N'
         and pofh.is_active = 'Y'
      union all
      select gmr.corporate_id,
             grd.product_id,
             gmr.internal_gmr_ref_no,
             gmr.gmr_ref_no,
             gmr.current_qty,
             pofh.qp_start_date,
             pofh.qp_end_date,
             pofh.pofh_id,
             pd_trade_date eod_trade_date,
             qat.instrument_id,
             dim.instrument_name,
             ps.price_source_id,
             ps.price_source_name,
             apm.available_price_id,
             apm.available_price_name,
             pum.price_unit_name,
             vdip.ppu_price_unit_id,
             div.price_unit_id,
             pocd.is_any_day_pricing,
             pofh.qty_to_be_fixed,
             round(pofh.priced_qty, 4) priced_qty,
             pofh.no_of_prompt_days,
             pocd.pcbpd_id,
             dim.delivery_calender_id,
             pdc.is_daily_cal_applicable,
             pdc.is_monthly_cal_applicable,
             grd.payment_due_date
        from gmr_goods_movement_record gmr,
             (select grd.internal_gmr_ref_no,
                     grd.quality_id,
                     grd.product_id,
                     (case
                       when nvl(grd.payment_due_date, pd_trade_date) <
                            pd_trade_date then
                        pd_trade_date
                       else
                        grd.payment_due_date
                     end) payment_due_date
                from dgrd_delivered_grd grd
               where grd.process_id = pc_process_id
                 and grd.status = 'Active'
                    --and grd.is_deleted = 'N'
                 and nvl(grd.inventory_status, 'NA') <> 'Out'
               group by grd.internal_gmr_ref_no,
                        grd.quality_id,
                        grd.product_id,
                        (case
                          when nvl(grd.payment_due_date, pd_trade_date) <
                               pd_trade_date then
                           pd_trade_date
                          else
                           grd.payment_due_date
                        end)) grd,
             pdm_productmaster pdm,
             pdtm_product_type_master pdtm,
             pofh_price_opt_fixation_header pofh,
             pocd_price_option_calloff_dtls pocd,
             --mv_qat_quality_valuation qat,
             v_gmr_exchange_detail        qat,
             dim_der_instrument_master    dim,
             div_der_instrument_valuation div,
             ps_price_source              ps,
             apm_available_price_master   apm,
             pum_price_unit_master        pum,
             v_der_instrument_price_unit  vdip,
             pdc_prompt_delivery_calendar pdc
       where gmr.internal_gmr_ref_no = grd.internal_gmr_ref_no
         and grd.product_id = pdm.product_id
         and pdm.product_type_id = pdtm.product_type_id
         and pdtm.product_type_name = 'Standard'
         and gmr.internal_gmr_ref_no = pofh.internal_gmr_ref_no
         and pofh.pocd_id = pocd.pocd_id
            --and grd.quality_id = qat.quality_id
         and gmr.process_id = pc_process_id
            --and qat.corporate_id = pc_corporate_id
         and gmr.internal_gmr_ref_no = qat.internal_gmr_ref_no(+)
         and gmr.process_id = qat.process_id(+)
         and qat.instrument_id = dim.instrument_id(+)
         and dim.instrument_id = div.instrument_id(+)
         and div.is_deleted(+) = 'N'
         and div.price_source_id = ps.price_source_id(+)
         and div.available_price_id = apm.available_price_id(+)
         and div.price_unit_id = pum.price_unit_id(+)
         and dim.instrument_id = vdip.instrument_id(+)
         and dim.delivery_calender_id = pdc.prompt_delivery_calendar_id(+)
         and gmr.is_deleted = 'N'
         and pofh.is_active = 'Y';
  
    vobj_error_log             tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count         number := 1;
    vd_qp_start_date           date;
    vd_qp_end_date             date;
    vc_period                  varchar2(50);
    vd_3rd_wed_of_qp           date;
    workings_days              number;
    vd_quotes_date             date;
    vc_before_price_dr_id      varchar2(15);
    vn_before_qp_price         number;
    vc_before_qp_price_unit_id varchar2(15);
    --vn_total_quantity              number;
    vn_total_contract_value number;
    -- vc_price_unit_id               varchar2(15);
    vn_after_price                 number;
    vn_after_count                 number;
    vn_after_qp_price              number;
    vc_after_qp_price_unit_id      varchar2(15);
    vd_dur_qp_start_date           date;
    vd_dur_qp_end_date             date;
    vn_during_total_set_price      number;
    vn_count_set_qp                number;
    vc_during_price_dr_id          varchar2(15);
    vn_during_val_price            number;
    vc_during_val_price_unit_id    varchar2(15);
    vn_during_total_val_price      number;
    vn_count_val_qp                number;
    vc_holiday                     char(1);
    vn_during_qp_price             number;
    vc_price_cur_id                varchar2(15);
    vc_price_cur_code              varchar2(15);
    vc_price_weight_unit           number;
    vc_price_weight_unit_id        varchar2(15);
    vc_price_qty_unit              varchar2(15);
    vc_price_fixation_status       varchar2(50);
    vn_market_flag                 char(1);
    vn_any_day_cont_price_fix_qty  number;
    vn_any_day_cont_price_ufix_qty number;
    vn_any_day_unfixed_qty         number;
    vn_any_day_fixed_qty           number;
    vc_price_unit_id               varchar2(15);
    vc_ppu_price_unit_id           varchar2(15);
    vc_price_name                  varchar2(100);
    vc_pcbpd_id                    varchar2(15);
    vc_prompt_month                varchar2(15);
    vc_prompt_year                 number;
    vc_prompt_date                 date;
    vc_contract_base_price_unit_id varchar2(15);
    vc_contract_main_cur_id        varchar2(15);
    vc_contract_main_cur_code      varchar2(15);
    vn_contract_main_cur_factor    number;
    vc_base_main_cur_id            varchar2(15);
    vc_base_main_cur_code          varchar2(15);
    vn_settlement_price            number;
    vn_forward_points              number;
    vc_exch_rate_string            varchar2(300);
    vn_price_in_base_price_unit_id number;
    vc_fixed_price_unit_id         varchar2(15);
    vn_val_to_base_corp_fx_rate    number; -- During QP Corp FX Rate from Quote to Price 
    vc_quote_cur_id                varchar2(15); -- During QP ,Quote Currency ID
    vc_quote_cur_code              varchar2(15); -- During QP ,Quote Currency Code
    vc_fixed_price_cur_id          varchar2(15);
    vc_fixed_price_cur_code        varchar2(15);
    vc_fixed_price_main_cur_id     varchar2(15);
    vc_fixed_price_main_cur_code   varchar2(15);
    vn_fixed_factor                number;
    vc_quote_main_cur_id           varchar2(15);
    vc_quote_main_cur_code         varchar2(15);
    vn_quote_factor                number;
  begin
    for cur_gmr_rows in cur_gmr
    loop
      vc_price_fixation_status       := null;
      vn_total_contract_value        := 0;
      vn_market_flag                 := null;
      vn_any_day_cont_price_fix_qty  := 0;
      vn_any_day_cont_price_ufix_qty := 0;
      vn_any_day_unfixed_qty         := 0;
      vn_any_day_fixed_qty           := 0;
      vc_pcbpd_id                    := cur_gmr_rows.pcbpd_id;
      vc_price_unit_id               := null;
      vc_ppu_price_unit_id           := null;
      vd_qp_start_date               := cur_gmr_rows.qp_start_date;
      vd_qp_end_date                 := cur_gmr_rows.qp_end_date;
    
      begin
      
        select ppu.product_price_unit_id,
               akc.base_cur_id,
               cm.cur_code
          into vc_contract_base_price_unit_id,
               vc_base_main_cur_id,
               vc_base_main_cur_code
          from v_ppu_pum          ppu,
               pdm_productmaster  pdm,
               ak_corporate       akc,
               cm_currency_master cm
         where ppu.weight_unit_id = pdm.base_quantity_unit
           and ppu.product_id = pdm.product_id
           and ppu.product_id = cur_gmr_rows.product_id
           and ppu.cur_id = akc.base_cur_id
           and akc.corporate_id = pc_corporate_id
           and ppu.cur_id = cm.cur_id;
      
      exception
        when no_data_found then
          vc_contract_base_price_unit_id := null;
      end;
    
      if cur_gmr_rows.eod_trade_date >= vd_qp_start_date and
         cur_gmr_rows.eod_trade_date <= vd_qp_end_date then
        vc_period := 'During QP';
      elsif cur_gmr_rows.eod_trade_date < vd_qp_start_date and
            cur_gmr_rows.eod_trade_date < vd_qp_end_date then
        vc_period := 'Before QP';
      elsif cur_gmr_rows.eod_trade_date > vd_qp_start_date and
            cur_gmr_rows.eod_trade_date > vd_qp_end_date then
        vc_period := 'After QP';
      end if;
      begin
        select ppu.product_price_unit_id,
               ppu.price_unit_id,
               ppu.price_unit_name
          into vc_ppu_price_unit_id,
               vc_price_unit_id,
               vc_price_name
          from ppfh_phy_price_formula_header ppfh,
               v_ppu_pum                     ppu
         where ppfh.pcbpd_id = vc_pcbpd_id
           and ppfh.process_id = pc_process_id
           and ppfh.price_unit_id = ppu.product_price_unit_id
           and rownum <= 1;
      exception
        when no_data_found then
          vc_ppu_price_unit_id := cur_gmr_rows.ppu_price_unit_id;
          vc_price_unit_id     := cur_gmr_rows.price_unit_id;
          vc_price_name        := cur_gmr_rows.price_unit_name;
        when others then
          vc_ppu_price_unit_id := cur_gmr_rows.ppu_price_unit_id;
          vc_price_unit_id     := cur_gmr_rows.price_unit_id;
          vc_price_name        := cur_gmr_rows.price_unit_name;
      end;
      if vc_period = 'Before QP' then
        vc_price_fixation_status := 'Un-priced';
      
        if cur_gmr_rows.is_daily_cal_applicable = 'Y' then
          vd_3rd_wed_of_qp := f_get_next_day(vd_qp_end_date, 'Wed', 3);
        
          while true
          loop
            if f_is_day_holiday(cur_gmr_rows.instrument_id,
                                vd_3rd_wed_of_qp) then
              vd_3rd_wed_of_qp := vd_3rd_wed_of_qp + 1;
            else
              exit;
            end if;
          end loop;
        
          --- get 3rd wednesday  before QP period 
          -- Get the quotation date = Trade Date +2 working Days
          if vd_3rd_wed_of_qp <= pd_trade_date then
            workings_days  := 0;
            vd_quotes_date := pd_trade_date + 1;
            while workings_days <> 2
            loop
              if f_is_day_holiday(cur_gmr_rows.instrument_id,
                                  vd_quotes_date) then
                vd_quotes_date := vd_quotes_date + 1;
              else
                workings_days := workings_days + 1;
                if workings_days <> 2 then
                  vd_quotes_date := vd_quotes_date + 1;
                end if;
              end if;
            end loop;
            vd_3rd_wed_of_qp := vd_quotes_date;
          end if;
          ---- get the dr_id             
          begin
            select drm.dr_id
              into vc_before_price_dr_id
              from drm_derivative_master drm
             where drm.instrument_id = cur_gmr_rows.instrument_id
               and drm.prompt_date = vd_3rd_wed_of_qp
               and rownum <= 1
               and drm.price_point_id is null
               and drm.is_deleted = 'N';
          exception
            when no_data_found then
              vobj_error_log.extend;
              vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                   'procedure sp_calc_gmr_price',
                                                                   'PHY-002',
                                                                   'DR_ID missing for ' ||
                                                                   cur_gmr_rows.instrument_name ||
                                                                   ',Price Source:' ||
                                                                   cur_gmr_rows.price_source_name ||
                                                                   ' GMR No: ' ||
                                                                   cur_gmr_rows.gmr_ref_no ||
                                                                   ',Price Unit:' ||
                                                                   vc_price_name || ',' ||
                                                                   cur_gmr_rows.available_price_name ||
                                                                   ' Price,Prompt Date:' ||
                                                                   vd_3rd_wed_of_qp,
                                                                   '',
                                                                   gvc_process,
                                                                   pc_user_id,
                                                                   sysdate,
                                                                   pd_trade_date);
              sp_insert_error_log(vobj_error_log);
            
          end;
        
        elsif cur_gmr_rows.is_daily_cal_applicable = 'N' and
              cur_gmr_rows.is_monthly_cal_applicable = 'Y' then
        
          vc_prompt_date  := pkg_metals_general.fn_get_next_month_prompt_date(cur_gmr_rows.delivery_calender_id,
                                                                              vd_qp_end_date);
          vc_prompt_month := to_char(vc_prompt_date, 'Mon');
          vc_prompt_year  := to_char(vc_prompt_date, 'YYYY');
        
          ---- get the dr_id             
          begin
            select drm.dr_id
              into vc_before_price_dr_id
              from drm_derivative_master drm
             where drm.instrument_id = cur_gmr_rows.instrument_id
               and drm.period_month = vc_prompt_month
               and drm.period_year = vc_prompt_year
               and rownum <= 1
               and drm.price_point_id is null
               and drm.is_deleted = 'N';
          exception
            when no_data_found then
              vobj_error_log.extend;
              vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                   'procedure sp_calc_contract_price',
                                                                   'PHY-002',
                                                                   'DR_ID missing for ' ||
                                                                   cur_gmr_rows.instrument_name ||
                                                                   ',Price Source:' ||
                                                                   cur_gmr_rows.price_source_name ||
                                                                   ' Contract Ref No: ' ||
                                                                   cur_gmr_rows.gmr_ref_no ||
                                                                   ',Price Unit:' ||
                                                                   cur_gmr_rows.price_unit_name || ',' ||
                                                                   cur_gmr_rows.available_price_name ||
                                                                   ' Price,Prompt Date:' ||
                                                                   vc_prompt_month || ' ' ||
                                                                   vc_prompt_year,
                                                                   '',
                                                                   gvc_process,
                                                                   pc_user_id,
                                                                   sysdate,
                                                                   pd_trade_date);
              sp_insert_error_log(vobj_error_log);
          end;
        end if;
        --get the price              
        begin
          select dqd.price,
                 dqd.price_unit_id
            into vn_before_qp_price,
                 vc_before_qp_price_unit_id
            from dq_derivative_quotes        dq,
                 dqd_derivative_quote_detail dqd
           where dq.dq_id = dqd.dq_id
             and dqd.dr_id = vc_before_price_dr_id
             and dq.process_id = pc_process_id
             and dq.instrument_id = cur_gmr_rows.instrument_id
             and dq.process_id = dqd.process_id
             and dqd.available_price_id = cur_gmr_rows.available_price_id
             and dq.price_source_id = cur_gmr_rows.price_source_id
             and dqd.price_unit_id = vc_price_unit_id
             and dq.trade_date = pd_trade_date
             and dq.is_deleted = 'N'
             and dqd.is_deleted = 'N';
        exception
          when no_data_found then
            vobj_error_log.extend;
            vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,'procedure sp_calc_gmr_price','PHY-002','Price missing for ' || cur_gmr_rows.instrument_name ||',Price Source:' || cur_gmr_rows.price_source_name ||' GMR No: ' || cur_gmr_rows.gmr_ref_no ||',Price Unit:' || vc_price_name ||',' || cur_gmr_rows.available_price_name ||' Price,Prompt Date:' || (case when cur_gmr_rows.is_daily_cal_applicable = 'N' and cur_gmr_rows.is_monthly_cal_applicable = 'Y' then to_char(vc_prompt_date, 'Mon-yyyy') else to_char(vd_3rd_wed_of_qp, 'dd-Mon-yyyy') end), '', gvc_process, pc_user_id, sysdate, pd_trade_date);
            sp_insert_error_log(vobj_error_log);
        end;
        vn_total_contract_value := vn_total_contract_value +
                                   vn_before_qp_price;
        --  vc_price_unit_id        := cur_gmr_rows.ppu_price_unit_id;
      elsif vc_period = 'After QP' then
        vn_after_price := 0;
        vn_after_count := 0;
        for pfd_price in (select pfd.user_price,
                                 pfd.price_unit_id,
                                 pofh.final_price
                            from poch_price_opt_call_off_header poch,
                                 pocd_price_option_calloff_dtls pocd,
                                 pofh_price_opt_fixation_header pofh,
                                 pfd_price_fixation_details     pfd
                           where poch.poch_id = pocd.poch_id
                             and pocd.pocd_id = pofh.pocd_id
                             and pfd.pofh_id = cur_gmr_rows.pofh_id
                             and pofh.pofh_id = pfd.pofh_id
                             and poch.is_active = 'Y'
                             and pocd.is_active = 'Y'
                             and pofh.is_active = 'Y'
                             and pfd.is_active = 'Y')
        loop
          if pfd_price.final_price is not null then
            vc_price_fixation_status := 'Finalized';
          end if;
        
          vn_after_price := vn_after_price + pfd_price.user_price;
          vn_after_count := vn_after_count + 1;
        
        end loop;
        --   end if;
        if vn_after_count = 0 then
          vn_after_qp_price         := 0;
          vn_total_contract_value   := 0;
          vc_after_qp_price_unit_id := null;
          vc_price_fixation_status  := 'Un-priced';
        else
          vn_after_qp_price       := vn_after_price / vn_after_count;
          vn_total_contract_value := vn_total_contract_value +
                                     vn_after_qp_price;
          -- vc_price_unit_id        := cur_gmr_rows.ppu_price_unit_id;
          if vc_price_fixation_status <> 'Finalized' then
            vc_price_fixation_status := 'Partially Priced';
          else
            vc_price_fixation_status := 'Partially Priced';
          end if;
        end if;
      elsif vc_period = 'During QP' then
        vd_dur_qp_start_date      := vd_qp_start_date;
        vd_dur_qp_end_date        := vd_qp_end_date;
        vn_during_total_set_price := 0;
        vn_count_set_qp           := 0;
        for cc in (select pfd.user_price,
                          pfd.as_of_date,
                          pfd.qty_fixed,
                          pofh.final_price,
                          pocd.is_any_day_pricing,
                          pfd.price_unit_id
                     from poch_price_opt_call_off_header poch,
                          pocd_price_option_calloff_dtls pocd,
                          pofh_price_opt_fixation_header pofh,
                          pfd_price_fixation_details     pfd
                    where poch.poch_id = pocd.poch_id
                      and pocd.pocd_id = pofh.pocd_id
                      and pofh.pofh_id = cur_gmr_rows.pofh_id
                      and pofh.pofh_id = pfd.pofh_id
                      and pfd.as_of_date >= vd_dur_qp_start_date
                      and pfd.as_of_date <= pd_trade_date
                      and poch.is_active = 'Y'
                      and pocd.is_active = 'Y'
                      and pofh.is_active = 'Y'
                      and pfd.is_active = 'Y')
        loop
          vn_during_total_set_price := vn_during_total_set_price +
                                       cc.user_price;
          vn_count_set_qp           := vn_count_set_qp + 1;
          if cc.final_price is not null then
            vc_price_fixation_status := 'Finalized';
          end if;
          vn_any_day_fixed_qty := vn_any_day_fixed_qty + cc.qty_fixed;
        
          vc_fixed_price_unit_id := cc.price_unit_id;
        end loop;
      
        if vn_count_set_qp <> 0 then
          if vc_price_fixation_status <> 'Finalized' then
            vc_price_fixation_status := 'Partially Priced';
          end if;
        else
          vc_price_fixation_status := 'Un-priced';
        
        end if;
        if cur_gmr_rows.is_any_day_pricing = 'Y' then
          vn_market_flag := 'N';
        else
          vn_market_flag := 'Y';
        end if;
      
        -- get the third wednesday
        if cur_gmr_rows.is_daily_cal_applicable = 'Y' then
          vd_3rd_wed_of_qp := f_get_next_day(vd_dur_qp_end_date, 'Wed', 3);
          while true
          loop
            if f_is_day_holiday(cur_gmr_rows.instrument_id,
                                vd_3rd_wed_of_qp) then
              vd_3rd_wed_of_qp := vd_3rd_wed_of_qp + 1;
            else
              exit;
            end if;
          end loop;
          --- get 3rd wednesday  before QP period 
          -- Get the quotation date = Trade Date +2 working Days
          if vd_3rd_wed_of_qp <= pd_trade_date then
            workings_days  := 0;
            vd_quotes_date := pd_trade_date + 1;
            while workings_days <> 2
            loop
              if f_is_day_holiday(cur_gmr_rows.instrument_id,
                                  vd_quotes_date) then
                vd_quotes_date := vd_quotes_date + 1;
              else
                workings_days := workings_days + 1;
                if workings_days <> 2 then
                  vd_quotes_date := vd_quotes_date + 1;
                end if;
              end if;
            end loop;
            vd_3rd_wed_of_qp := vd_quotes_date;
          end if;
          --Get the DR-id
          begin
            select drm.dr_id
              into vc_during_price_dr_id
              from drm_derivative_master drm
             where drm.instrument_id = cur_gmr_rows.instrument_id
               and drm.prompt_date = vd_3rd_wed_of_qp
               and rownum <= 1
               and drm.price_point_id is null
               and drm.is_deleted = 'N';
          exception
            when no_data_found then
              vobj_error_log.extend;
              vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                   'procedure sp_calc_gmr_price',
                                                                   'PHY-002',
                                                                   'DR-ID missing for ' ||
                                                                   cur_gmr_rows.instrument_name ||
                                                                   ',Price Source:' ||
                                                                   cur_gmr_rows.price_source_name ||
                                                                   ' GMR NO: ' ||
                                                                   cur_gmr_rows.gmr_ref_no ||
                                                                   ',Price Unit:' ||
                                                                   vc_price_name || ',' ||
                                                                   cur_gmr_rows.available_price_name ||
                                                                   ' Price,Prompt Date:' ||
                                                                   vd_3rd_wed_of_qp,
                                                                   '',
                                                                   gvc_process,
                                                                   pc_user_id,
                                                                   sysdate,
                                                                   pd_trade_date);
              sp_insert_error_log(vobj_error_log);
          end;
        elsif cur_gmr_rows.is_daily_cal_applicable = 'N' and
              cur_gmr_rows.is_monthly_cal_applicable = 'Y' then
        
          vc_prompt_date  := pkg_metals_general.fn_get_next_month_prompt_date(cur_gmr_rows.delivery_calender_id,
                                                                              vd_qp_end_date);
          vc_prompt_month := to_char(vc_prompt_date, 'Mon');
          vc_prompt_year  := to_char(vc_prompt_date, 'YYYY');
          ---- get the dr_id             
          begin
            select drm.dr_id
              into vc_during_price_dr_id
              from drm_derivative_master drm
             where drm.instrument_id = cur_gmr_rows.instrument_id
               and drm.period_month = vc_prompt_month
               and drm.period_year = vc_prompt_year
               and rownum <= 1
               and drm.price_point_id is null
               and drm.is_deleted = 'N';
          exception
            when no_data_found then
              vobj_error_log.extend;
              vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                   'procedure sp_calc_contract_price',
                                                                   'PHY-002',
                                                                   'DR_ID missing for ' ||
                                                                   cur_gmr_rows.instrument_name ||
                                                                   ',Price Source:' ||
                                                                   cur_gmr_rows.price_source_name ||
                                                                   ' Contract Ref No: ' ||
                                                                   cur_gmr_rows.gmr_ref_no ||
                                                                   ',Price Unit:' ||
                                                                   cur_gmr_rows.price_unit_name || ',' ||
                                                                   cur_gmr_rows.available_price_name ||
                                                                   ' Price,Prompt Date:' ||
                                                                   vc_prompt_month || ' ' ||
                                                                   vc_prompt_year,
                                                                   '',
                                                                   gvc_process,
                                                                   pc_user_id,
                                                                   sysdate,
                                                                   pd_trade_date);
              sp_insert_error_log(vobj_error_log);
          end;
        end if;
        --Get the price for the dr-id
        begin
          select dqd.price,
                 dqd.price_unit_id
            into vn_during_val_price,
                 vc_during_val_price_unit_id
            from dq_derivative_quotes        dq,
                 dqd_derivative_quote_detail dqd
           where dq.dq_id = dqd.dq_id
             and dqd.dr_id = vc_during_price_dr_id
             and dq.instrument_id = cur_gmr_rows.instrument_id
             and dq.dbd_id = dqd.dbd_id
             and dq.dbd_id = pc_dbd_id
             and dqd.available_price_id = cur_gmr_rows.available_price_id
             and dq.price_source_id = cur_gmr_rows.price_source_id
             and dq.trade_date = pd_trade_date
             and dqd.price_unit_id = vc_price_unit_id
             and dq.is_deleted = 'N'
             and dqd.is_deleted = 'N';
        exception
          when no_data_found then
            vobj_error_log.extend;
            vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,'procedure sp_gmr_price','PHY-002','Price missing for ' || cur_gmr_rows.instrument_name ||',Price Source:' || cur_gmr_rows.price_source_name ||' GMR No: ' || cur_gmr_rows.gmr_ref_no ||',Price Unit:' || vc_price_name ||',' || cur_gmr_rows.available_price_name ||' Price,Prompt Date:' || (case when cur_gmr_rows.is_daily_cal_applicable = 'N' and cur_gmr_rows.is_monthly_cal_applicable = 'Y' then to_char(vc_prompt_date, 'Mon-yyyy') else to_char(vd_3rd_wed_of_qp, 'dd-Mon-yyyy') end), '', gvc_process, pc_user_id, sysdate, pd_trade_date);
            sp_insert_error_log(vobj_error_log);
        end;
        vn_during_total_val_price := 0;
        vn_count_val_qp           := 0;
        vd_dur_qp_start_date      := pd_trade_date + 1;
        if vn_market_flag = 'N' then
          vn_during_total_val_price := vn_during_total_val_price +
                                       vn_during_val_price;
        
          vn_any_day_unfixed_qty         := cur_gmr_rows.qty_to_be_fixed -
                                            vn_any_day_fixed_qty;
          vn_count_val_qp                := vn_count_val_qp + 1;
          vn_any_day_cont_price_ufix_qty := (vn_any_day_unfixed_qty *
                                            vn_during_total_val_price);
        
        else
          while vd_dur_qp_start_date <= vd_dur_qp_end_date
          loop
            if f_is_day_holiday(cur_gmr_rows.instrument_id,
                                vd_dur_qp_start_date) then
              vc_holiday := 'Y';
            else
              vc_holiday := 'N';
            end if;
            if vc_holiday = 'N' then
              vn_during_total_val_price := vn_during_total_val_price +
                                           vn_during_val_price;
              vn_count_val_qp           := vn_count_val_qp + 1;
            end if;
            vd_dur_qp_start_date := vd_dur_qp_start_date + 1;
          end loop;
        end if;
        if (vn_count_val_qp + vn_count_set_qp) <> 0 then
        
          if vn_market_flag = 'N' then
            vn_during_qp_price := (vn_any_day_cont_price_fix_qty +
                                  vn_any_day_cont_price_ufix_qty) /
                                  cur_gmr_rows.qty_to_be_fixed;
          else
            vn_during_qp_price := (vn_during_total_set_price +
                                  vn_during_total_val_price) /
                                  (vn_count_set_qp + vn_count_val_qp);
          end if;
          vn_total_contract_value := vn_total_contract_value +
                                     vn_during_qp_price;
        else
          vn_total_contract_value := 0;
        end if;
      
      end if;
      --
      -- Convert the final price into Base Price Unit 
      --
      begin
        select cm.cur_id,
               cm.cur_code,
               ppu.weight,
               ppu.weight_unit_id,
               qum.qty_unit
          into vc_price_cur_id,
               vc_price_cur_code,
               vc_price_weight_unit,
               vc_price_weight_unit_id,
               vc_price_qty_unit
          from v_ppu_pum                ppu,
               cm_currency_master       cm,
               qum_quantity_unit_master qum
         where ppu.product_price_unit_id = vc_ppu_price_unit_id
           and ppu.cur_id = cm.cur_id
           and qum.qty_unit_id = ppu.weight_unit_id;
      
      exception
        when no_data_found then
          vc_price_cur_id         := null;
          vc_price_cur_code       := null;
          vc_price_weight_unit    := null;
          vc_price_weight_unit_id := null;
          vc_price_qty_unit       := null;
      end;
    
      pkg_general.sp_get_base_cur_detail(vc_price_cur_id,
                                         vc_contract_main_cur_id,
                                         vc_contract_main_cur_code,
                                         vn_contract_main_cur_factor);
    
      --
      -- Get the Forward Exchange Rate from Price Unit ID to Base Price Unit ID
      --
      if vc_contract_main_cur_id <> vc_base_main_cur_id then
        pkg_general.sp_forward_cur_exchange_new(pc_corporate_id,
                                                pd_trade_date,
                                                cur_gmr_rows.payment_due_date,
                                                vc_contract_main_cur_id,
                                                vc_base_main_cur_id,
                                                30,
                                                vn_settlement_price,
                                                vn_forward_points);
        vc_exch_rate_string := vc_contract_main_cur_id || '=' ||
                               vn_settlement_price || ' ' ||
                               vc_base_main_cur_id;
        if vn_settlement_price is null or vn_settlement_price = 0 then
        
          vobj_error_log.extend;
          vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                               'procedure pkg_phy_physical_process Bae GMR Price',
                                                               'PHY-005',
                                                               vc_base_main_cur_code ||
                                                               ' to ' ||
                                                               vc_contract_main_cur_id || ' (' ||
                                                               to_char(cur_gmr_rows.payment_due_date,
                                                                       'dd-Mon-yyyy') || ') ',
                                                               '',
                                                               gvc_process,
                                                               pc_user_id,
                                                               sysdate,
                                                               pd_trade_date);
          sp_insert_error_log(vobj_error_log);
        end if;
      else
        vn_settlement_price := 1.0;
      end if;
      vn_price_in_base_price_unit_id := vn_settlement_price *
                                        vn_total_contract_value;
    
      insert into gpd_gmr_price_daily
        (corporate_id,
         internal_gmr_ref_no,
         contract_price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         price_unit_weight,
         price_unit_weight_unit_id,
         price_unit_weight_unit,
         process_id,
         price_fixation_status,
         contract_base_price_unit_id,
         exch_rate_string,
         price_in_base_price_unit_id)
      values
        (cur_gmr_rows.corporate_id,
         cur_gmr_rows.internal_gmr_ref_no,
         vn_total_contract_value,
         vc_ppu_price_unit_id,
         vc_price_cur_id,
         vc_price_cur_code,
         vc_price_weight_unit,
         vc_price_weight_unit_id,
         vc_price_qty_unit,
         pc_process_id,
         vc_price_fixation_status,
         null,
         null,
         null);
    
    end loop;
  
  end;

  procedure sp_calc_conc_gmr_price(pc_corporate_id varchar2,
                                   pd_trade_date   date,
                                   pc_process_id   varchar2,
                                   pc_user_id      varchar2,
                                   pc_dbd_id       varchar2) is
  
    cursor cur_gmr is
      select gmr.corporate_id,
             gmr.internal_gmr_ref_no,
             gmr.gmr_ref_no,
             gmr.current_qty,
             gmr.qty_unit_id,
             grd.product_id,
             pd_trade_date eod_trade_date,
             tt.instrument_id,
             tt.instrument_name,
             tt.price_source_id,
             tt.price_source_name,
             tt.available_price_id,
             tt.available_price_name,
             tt.price_unit_name,
             tt.ppu_price_unit_id,
             tt.price_unit_id,
             tt.delivery_calender_id,
             tt.is_daily_cal_applicable,
             tt.is_monthly_cal_applicable,
             spq.element_id,
             spq.payable_qty,
             spq.qty_unit_id payable_qty_unit_id
        from gmr_goods_movement_record gmr,
             (select grd.internal_gmr_ref_no,
                     grd.quality_id,
                     grd.product_id
                from grd_goods_record_detail grd
               where grd.process_id = pc_process_id
                 and grd.status = 'Active'
                 and grd.is_deleted = 'N'
                 and nvl(grd.inventory_status, 'NA') <> 'Out'
               group by grd.internal_gmr_ref_no,
                        grd.quality_id,
                        grd.product_id) grd,
             pdm_productmaster pdm,
             pdtm_product_type_master pdtm,
             v_gmr_stockpayable_qty spq,
             (select qat.process_id,
                     qat.internal_gmr_ref_no,
                     qat.instrument_id,
                     qat.element_id,
                     dim.instrument_name,
                     ps.price_source_id,
                     ps.price_source_name,
                     apm.available_price_id,
                     apm.available_price_name,
                     pum.price_unit_name,
                     vdip.ppu_price_unit_id,
                     div.price_unit_id,
                     dim.delivery_calender_id,
                     pdc.is_daily_cal_applicable,
                     pdc.is_monthly_cal_applicable
                from v_gmr_exchange_detail        qat,
                     dim_der_instrument_master    dim,
                     div_der_instrument_valuation div,
                     ps_price_source              ps,
                     apm_available_price_master   apm,
                     pum_price_unit_master        pum,
                     v_der_instrument_price_unit  vdip,
                     pdc_prompt_delivery_calendar pdc
               where qat.instrument_id = dim.instrument_id
                 and dim.instrument_id = div.instrument_id
                 and div.is_deleted = 'N'
                 and div.price_source_id = ps.price_source_id
                 and div.available_price_id = apm.available_price_id
                 and div.price_unit_id = pum.price_unit_id
                 and dim.instrument_id = vdip.instrument_id
                 and dim.delivery_calender_id =
                     pdc.prompt_delivery_calendar_id) tt
       where gmr.internal_gmr_ref_no = grd.internal_gmr_ref_no
         and grd.product_id = pdm.product_id
         and pdm.product_type_id = pdtm.product_type_id
         and pdtm.product_type_name = 'Composite'
         and spq.process_id = pc_process_id
         and tt.element_id = spq.element_id
         and tt.internal_gmr_ref_no = spq.internal_gmr_ref_no
         and gmr.process_id = pc_process_id
         and gmr.internal_gmr_ref_no = tt.internal_gmr_ref_no(+)
         and gmr.process_id = tt.process_id(+)
         and gmr.is_deleted = 'N'
      union all
      select gmr.corporate_id,
             gmr.internal_gmr_ref_no,
             gmr.gmr_ref_no,
             gmr.current_qty,
             gmr.qty_unit_id,
             grd.product_id,
             pd_trade_date eod_trade_date,
             tt.instrument_id,
             tt.instrument_name,
             tt.price_source_id,
             tt.price_source_name,
             tt.available_price_id,
             tt.available_price_name,
             tt.price_unit_name,
             tt.ppu_price_unit_id,
             tt.price_unit_id,
             tt.delivery_calender_id,
             tt.is_daily_cal_applicable,
             tt.is_monthly_cal_applicable,
             spq.element_id,
             spq.payable_qty,
             spq.qty_unit_id payable_qty_unit_id
        from gmr_goods_movement_record gmr,
             (select grd.internal_gmr_ref_no,
                     grd.quality_id,
                     grd.product_id
                from dgrd_delivered_grd grd
               where grd.process_id = pc_process_id
                 and grd.status = 'Active'
                 and nvl(grd.inventory_status, 'NA') <> 'Out'
               group by grd.internal_gmr_ref_no,
                        grd.quality_id,
                        grd.product_id) grd,
             pdm_productmaster pdm,
             pdtm_product_type_master pdtm,
             v_gmr_stockpayable_qty spq,
             (select qat.process_id,
                     qat.internal_gmr_ref_no,
                     qat.instrument_id,
                     qat.element_id,
                     dim.instrument_name,
                     ps.price_source_id,
                     ps.price_source_name,
                     apm.available_price_id,
                     apm.available_price_name,
                     pum.price_unit_name,
                     vdip.ppu_price_unit_id,
                     div.price_unit_id,
                     dim.delivery_calender_id,
                     pdc.is_daily_cal_applicable,
                     pdc.is_monthly_cal_applicable
                from v_gmr_exchange_detail        qat,
                     dim_der_instrument_master    dim,
                     div_der_instrument_valuation div,
                     ps_price_source              ps,
                     apm_available_price_master   apm,
                     pum_price_unit_master        pum,
                     v_der_instrument_price_unit  vdip,
                     pdc_prompt_delivery_calendar pdc
               where qat.instrument_id = dim.instrument_id
                 and dim.instrument_id = div.instrument_id
                 and div.is_deleted = 'N'
                 and div.price_source_id = ps.price_source_id
                 and div.available_price_id = apm.available_price_id
                 and div.price_unit_id = pum.price_unit_id
                 and dim.instrument_id = vdip.instrument_id
                 and dim.delivery_calender_id =
                     pdc.prompt_delivery_calendar_id) tt
       where gmr.internal_gmr_ref_no = grd.internal_gmr_ref_no
         and grd.product_id = pdm.product_id
         and pdm.product_type_id = pdtm.product_type_id
         and pdm.product_type_id = 'Composite'
         and spq.process_id = pc_process_id
         and tt.element_id = spq.element_id
         and tt.internal_gmr_ref_no = spq.internal_gmr_ref_no
         and gmr.process_id = pc_process_id
         and gmr.internal_gmr_ref_no = tt.internal_gmr_ref_no(+)
         and gmr.process_id = tt.process_id(+)
         and gmr.is_deleted = 'N';
  
    cursor cur_gmr_ele(pc_internal_gmr_ref_no varchar2, pc_element_id varchar2) is
      select pofh.internal_gmr_ref_no,
             pofh.pofh_id,
             pofh.qp_start_date,
             pofh.qp_end_date,
             pofh.qty_to_be_fixed,
             pcbpd.element_id,
             pcbpd.pcbpd_id,
             pcbpd.qty_to_be_priced,
             pocd.is_any_day_pricing,
             pcbpd.price_basis,
             pcbph.price_description,
             pofh.no_of_prompt_days,
             pofh.final_price,
             pofh.avg_price_in_price_in_cur,
             pocd.pay_in_price_unit_id
        from pofh_price_opt_fixation_header pofh,
             pocd_price_option_calloff_dtls pocd,
             pcbpd_pc_base_price_detail     pcbpd,
             pcbph_pc_base_price_header     pcbph
       where pofh.internal_gmr_ref_no = pc_internal_gmr_ref_no
         and pofh.pocd_id = pocd.pocd_id
         and pocd.pcbpd_id = pcbpd.pcbpd_id
         and pcbpd.pcbph_id = pcbph.pcbph_id
         and pcbpd.element_id = pc_element_id
         and pcbpd.process_id = pc_process_id
         and pcbph.process_id = pc_process_id
         and pcbph.process_id = pc_process_id
         and pofh.is_active = 'Y'
         and pocd.is_active = 'Y'
         and pcbpd.is_active = 'Y'
         and pcbph.is_active = 'Y';
  
    vobj_error_log                 tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count             number := 1;
    vd_qp_start_date               date;
    vd_qp_end_date                 date;
    vc_period                      varchar2(50);
    vd_3rd_wed_of_qp               date;
    workings_days                  number;
    vd_quotes_date                 date;
    vc_before_price_dr_id          varchar2(15);
    vn_before_qp_price             number;
    vc_before_qp_price_unit_id     varchar2(15);
    vn_total_contract_value        number;
    vn_after_price                 number;
    vn_after_count                 number;
    vn_after_qp_price              number;
    vc_after_qp_price_unit_id      varchar2(15);
    vd_dur_qp_start_date           date;
    vd_dur_qp_end_date             date;
    vn_during_total_set_price      number;
    vn_count_set_qp                number;
    vc_during_price_dr_id          varchar2(15);
    vn_during_val_price            number;
    vc_during_val_price_unit_id    varchar2(15);
    vn_during_total_val_price      number;
    vn_count_val_qp                number;
    vc_holiday                     char(1);
    vn_during_qp_price             number;
    vc_price_cur_id                varchar2(15);
    vc_price_cur_code              varchar2(15);
    vc_price_weight_unit           number;
    vc_price_weight_unit_id        varchar2(15);
    vc_price_qty_unit              varchar2(15);
    vc_price_fixation_status       varchar2(50);
    vn_market_flag                 char(1);
    vn_any_day_cont_price_fix_qty  number;
    vn_any_day_cont_price_ufix_qty number;
    vn_any_day_unfixed_qty         number;
    vn_any_day_fixed_qty           number;
    vc_price_unit_id               varchar2(15);
    vc_ppu_price_unit_id           varchar2(15);
    vc_price_name                  varchar2(100);
    vc_pcbpd_id                    varchar2(15);
    vc_prompt_month                varchar2(15);
    vc_prompt_year                 number;
    vc_prompt_date                 date;
    vn_qty_to_be_priced            number;
    vn_total_quantity              number;
    vn_avarage_price               number;
    vc_price_basis                 varchar2(15);
    vc_price_description           varchar2(4000);
    vn_delta_price                 number;
    vc_delta_pricing_flag          char(1);
    vn_delta_priced_qty            number;
    vn_delta_avg_price             number;
    vn_total_delta_priced_qty      number;
  
  begin
    for cur_gmr_rows in cur_gmr
    loop
      vn_total_contract_value := 0;
      for cur_gmr_ele_rows in cur_gmr_ele(cur_gmr_rows.internal_gmr_ref_no,
                                          cur_gmr_rows.element_id)
      loop
        vc_price_basis                 := cur_gmr_ele_rows.price_basis;
        vc_price_description           := cur_gmr_ele_rows.price_description;
        vc_price_fixation_status       := null;
        vn_market_flag                 := null;
        vn_any_day_cont_price_fix_qty  := 0;
        vn_any_day_cont_price_ufix_qty := 0;
        vn_any_day_unfixed_qty         := 0;
        vn_any_day_fixed_qty           := 0;
        vc_pcbpd_id                    := cur_gmr_ele_rows.pcbpd_id;
        vc_price_unit_id               := null;
        vc_ppu_price_unit_id           := null;
        vd_qp_start_date               := cur_gmr_ele_rows.qp_start_date;
        vd_qp_end_date                 := cur_gmr_ele_rows.qp_end_date;
      
        if cur_gmr_rows.eod_trade_date >= vd_qp_start_date and
           cur_gmr_rows.eod_trade_date <= vd_qp_end_date then
          vc_period := 'During QP';
        elsif cur_gmr_rows.eod_trade_date < vd_qp_start_date and
              cur_gmr_rows.eod_trade_date < vd_qp_end_date then
          vc_period := 'Before QP';
        elsif cur_gmr_rows.eod_trade_date > vd_qp_start_date and
              cur_gmr_rows.eod_trade_date > vd_qp_end_date then
          vc_period := 'After QP';
        end if;
      
        begin
          select ppu.product_price_unit_id,
                 ppu.price_unit_id,
                 ppu.price_unit_name
            into vc_ppu_price_unit_id,
                 vc_price_unit_id,
                 vc_price_name
            from ppfh_phy_price_formula_header ppfh,
                 v_ppu_pum                     ppu
           where ppfh.pcbpd_id = vc_pcbpd_id
             and ppfh.process_id = pc_process_id
             and ppfh.price_unit_id = ppu.product_price_unit_id
             and rownum <= 1;
        exception
          when no_data_found then
            vc_ppu_price_unit_id := cur_gmr_rows.ppu_price_unit_id;
            vc_price_unit_id     := cur_gmr_rows.price_unit_id;
            vc_price_name        := cur_gmr_rows.price_unit_name;
          when others then
            vc_ppu_price_unit_id := cur_gmr_rows.ppu_price_unit_id;
            vc_price_unit_id     := cur_gmr_rows.price_unit_id;
            vc_price_name        := cur_gmr_rows.price_unit_name;
        end;
      
        if vc_period = 'Before QP' then
          vc_price_fixation_status := 'Un-priced';
        
          if cur_gmr_rows.is_daily_cal_applicable = 'Y' then
          
            vd_3rd_wed_of_qp := f_get_next_day(vd_qp_end_date, 'Wed', 3);
          
            while true
            loop
              if f_is_day_holiday(cur_gmr_rows.instrument_id,
                                  vd_3rd_wed_of_qp) then
                vd_3rd_wed_of_qp := vd_3rd_wed_of_qp + 1;
              else
                exit;
              end if;
            end loop;
          
            --- get 3rd wednesday  before QP period 
            -- Get the quotation date = Trade Date +2 working Days
            if vd_3rd_wed_of_qp <= pd_trade_date then
              workings_days  := 0;
              vd_quotes_date := pd_trade_date + 1;
              while workings_days <> 2
              loop
                if f_is_day_holiday(cur_gmr_rows.instrument_id,
                                    vd_quotes_date) then
                  vd_quotes_date := vd_quotes_date + 1;
                else
                  workings_days := workings_days + 1;
                  if workings_days <> 2 then
                    vd_quotes_date := vd_quotes_date + 1;
                  end if;
                end if;
              end loop;
              vd_3rd_wed_of_qp := vd_quotes_date;
            end if;
            ---- get the dr_id             
            begin
              select drm.dr_id
                into vc_before_price_dr_id
                from drm_derivative_master drm
               where drm.instrument_id = cur_gmr_rows.instrument_id
                 and drm.prompt_date = vd_3rd_wed_of_qp
                 and rownum <= 1
                 and drm.price_point_id is null
                 and drm.is_deleted = 'N';
            exception
              when no_data_found then
                vobj_error_log.extend;
                vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                     'procedure sp_calc_conc_gmr_price',
                                                                     'PHY-002',
                                                                     'DR_ID missing for ' ||
                                                                     cur_gmr_rows.instrument_name ||
                                                                     ',Price Source:' ||
                                                                     cur_gmr_rows.price_source_name ||
                                                                     ' GMR No: ' ||
                                                                     cur_gmr_rows.gmr_ref_no ||
                                                                     ',Price Unit:' ||
                                                                     vc_price_name || ',' ||
                                                                     cur_gmr_rows.available_price_name ||
                                                                     ' Price,Prompt Date:' ||
                                                                     vd_3rd_wed_of_qp,
                                                                     '',
                                                                     gvc_process,
                                                                     pc_user_id,
                                                                     sysdate,
                                                                     pd_trade_date);
                sp_insert_error_log(vobj_error_log);
              
            end;
          
          elsif cur_gmr_rows.is_daily_cal_applicable = 'N' and
                cur_gmr_rows.is_monthly_cal_applicable = 'Y' then
          
            vc_prompt_date  := pkg_metals_general.fn_get_next_month_prompt_date(cur_gmr_rows.delivery_calender_id,
                                                                                vd_qp_end_date);
            vc_prompt_month := to_char(vc_prompt_date, 'Mon');
            vc_prompt_year  := to_char(vc_prompt_date, 'YYYY');
          
            ---- get the dr_id             
            begin
              select drm.dr_id
                into vc_before_price_dr_id
                from drm_derivative_master drm
               where drm.instrument_id = cur_gmr_rows.instrument_id
                 and drm.period_month = vc_prompt_month
                 and drm.period_year = vc_prompt_year
                 and rownum <= 1
                 and drm.price_point_id is null
                 and drm.is_deleted = 'N';
            exception
              when no_data_found then
                vobj_error_log.extend;
                vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                     'procedure sp_calc_conc_gmr_price',
                                                                     'PHY-002',
                                                                     'DR_ID missing for ' ||
                                                                     cur_gmr_rows.instrument_name ||
                                                                     ',Price Source:' ||
                                                                     cur_gmr_rows.price_source_name ||
                                                                     ' Contract Ref No: ' ||
                                                                     cur_gmr_rows.gmr_ref_no ||
                                                                     ',Price Unit:' ||
                                                                     vc_price_name || ',' ||
                                                                     cur_gmr_rows.available_price_name ||
                                                                     ' Price,Prompt Date:' ||
                                                                     vc_prompt_month || ' ' ||
                                                                     vc_prompt_year,
                                                                     '',
                                                                     gvc_process,
                                                                     pc_user_id,
                                                                     sysdate,
                                                                     pd_trade_date);
                sp_insert_error_log(vobj_error_log);
              
            end;
          
          end if;
          --get the price              
          begin
            select dqd.price,
                   dqd.price_unit_id
              into vn_before_qp_price,
                   vc_before_qp_price_unit_id
              from dq_derivative_quotes        dq,
                   dqd_derivative_quote_detail dqd
             where dq.dq_id = dqd.dq_id
               and dqd.dr_id = vc_before_price_dr_id
               and dq.process_id = pc_process_id
               and dq.instrument_id = cur_gmr_rows.instrument_id
               and dq.process_id = dqd.process_id
               and dqd.available_price_id = cur_gmr_rows.available_price_id
               and dq.price_source_id = cur_gmr_rows.price_source_id
               and dqd.price_unit_id = vc_price_unit_id
               and dq.trade_date = pd_trade_date
               and dq.is_deleted = 'N'
               and dqd.is_deleted = 'N';
          exception
            when no_data_found then
              vobj_error_log.extend;
              vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,'procedure sp_calc_conc_gmr_price','PHY-002','Price missing for ' || cur_gmr_rows.instrument_name ||',Price Source:' || cur_gmr_rows.price_source_name ||' GMR No: ' || cur_gmr_rows.gmr_ref_no ||',Price Unit:' || vc_price_name ||',' || cur_gmr_rows.available_price_name ||' Price,Prompt Date:' || (case when cur_gmr_rows.is_daily_cal_applicable = 'N' and cur_gmr_rows.is_monthly_cal_applicable = 'Y' then to_char(vc_prompt_date, 'Mon-yyyy') else to_char(vd_3rd_wed_of_qp, 'dd-Mon-yyyy') end), '', gvc_process, pc_user_id, sysdate, pd_trade_date);
              sp_insert_error_log(vobj_error_log);
          end;
          vn_total_quantity       := pkg_general.f_get_converted_quantity(cur_gmr_rows.product_id,
                                                                          cur_gmr_rows.payable_qty_unit_id,
                                                                          cur_gmr_rows.qty_unit_id,
                                                                          cur_gmr_rows.payable_qty);
          vn_qty_to_be_priced     := cur_gmr_ele_rows.qty_to_be_priced;
          vn_total_contract_value := vn_total_contract_value +
                                     vn_total_quantity *
                                     (vn_qty_to_be_priced / 100) *
                                     vn_before_qp_price;
        
          --- vn_total_contract_value := vn_total_contract_value +vn_before_qp_price;                                   
          --  vc_price_unit_id        := cur_gmr_rows.ppu_price_unit_id;
        
        elsif vc_period = 'After QP' then
          if cur_gmr_ele_rows.final_price is not null and
             cur_gmr_ele_rows.avg_price_in_price_in_cur is not null then
            vn_after_qp_price       := cur_gmr_ele_rows.avg_price_in_price_in_cur;
            vn_total_quantity       := pkg_general.f_get_converted_quantity(cur_gmr_rows.product_id,
                                                                            cur_gmr_rows.payable_qty_unit_id,
                                                                            cur_gmr_rows.qty_unit_id,
                                                                            cur_gmr_rows.payable_qty);
            vn_qty_to_be_priced     := cur_gmr_ele_rows.qty_to_be_priced;
            vn_total_contract_value := vn_total_contract_value +
                                       vn_total_quantity *
                                       (vn_qty_to_be_priced / 100) *
                                       vn_after_qp_price;
          else
            vn_after_price := 0;
            vn_after_count := 0;
            for pfd_price in (select pfd.user_price,
                                     pfd.price_unit_id,
                                     pofh.final_price
                                from poch_price_opt_call_off_header poch,
                                     pocd_price_option_calloff_dtls pocd,
                                     pofh_price_opt_fixation_header pofh,
                                     pfd_price_fixation_details     pfd
                               where poch.poch_id = pocd.poch_id
                                 and pocd.pocd_id = pofh.pocd_id
                                 and pfd.pofh_id = cur_gmr_ele_rows.pofh_id
                                 and pofh.pofh_id = pfd.pofh_id
                                 and poch.is_active = 'Y'
                                 and pocd.is_active = 'Y'
                                 and pofh.is_active = 'Y'
                                 and nvl(pfd.is_delta_pricing, 'N') = 'N'
                                 and pfd.is_active = 'Y')
            loop
              if pfd_price.final_price is not null then
                vc_price_fixation_status := 'Finalized';
              end if;
            
              vn_after_price := vn_after_price + pfd_price.user_price;
              vn_after_count := vn_after_count + 1;
            
            end loop;
            --   end if;
            if vn_after_count = 0 then
              vn_after_qp_price         := 0;
              vn_total_contract_value   := 0;
              vc_after_qp_price_unit_id := null;
              vc_price_fixation_status  := 'Un-priced';
              vn_total_quantity         := pkg_general.f_get_converted_quantity(cur_gmr_rows.product_id,
                                                                                cur_gmr_rows.payable_qty_unit_id,
                                                                                cur_gmr_rows.qty_unit_id,
                                                                                cur_gmr_rows.payable_qty);
            else
              begin
                select pfd.user_price,
                       pfd.is_delta_pricing,
                       pofh.delta_priced_qty
                  into vn_delta_price,
                       vc_delta_pricing_flag,
                       vn_delta_priced_qty
                  from pfd_price_fixation_details     pfd,
                       pofh_price_opt_fixation_header pofh
                 where pfd.pofh_id = cur_gmr_ele_rows.pofh_id
                   and pofh.pofh_id = pfd.pofh_id
                   and pfd.is_delta_pricing = 'Y'
                   and pofh.is_active = 'Y'
                   and pfd.is_active = 'Y';
              exception
                when no_data_found then
                  vn_delta_price        := null;
                  vc_delta_pricing_flag := 'N';
                  vn_delta_priced_qty   := null;
              end;
              if vc_delta_pricing_flag = 'Y' then
                vn_after_qp_price         := vn_after_price /
                                             vn_after_count;
                vn_total_quantity         := pkg_general.f_get_converted_quantity(cur_gmr_rows.product_id,
                                                                                  cur_gmr_rows.payable_qty_unit_id,
                                                                                  cur_gmr_rows.qty_unit_id,
                                                                                  cur_gmr_rows.payable_qty);
                vn_total_delta_priced_qty := pkg_general.f_get_converted_quantity(cur_gmr_rows.product_id,
                                                                                  cur_gmr_rows.payable_qty_unit_id,
                                                                                  cur_gmr_rows.qty_unit_id,
                                                                                  vn_delta_priced_qty);
                vn_qty_to_be_priced       := cur_gmr_ele_rows.qty_to_be_priced;
                vn_delta_avg_price        := (((vn_total_quantity -
                                             vn_total_delta_priced_qty) *
                                             vn_after_qp_price) +
                                             (vn_total_delta_priced_qty *
                                             vn_delta_price)) /
                                             vn_total_quantity;
                vn_total_contract_value   := vn_total_contract_value +
                                             vn_total_quantity *
                                             (vn_qty_to_be_priced / 100) *
                                             vn_delta_avg_price;
              else
                vn_after_qp_price       := vn_after_price / vn_after_count;
                vn_total_quantity       := pkg_general.f_get_converted_quantity(cur_gmr_rows.product_id,
                                                                                cur_gmr_rows.payable_qty_unit_id,
                                                                                cur_gmr_rows.qty_unit_id,
                                                                                cur_gmr_rows.payable_qty);
                vn_qty_to_be_priced     := cur_gmr_ele_rows.qty_to_be_priced;
                vn_total_contract_value := vn_total_contract_value +
                                           vn_total_quantity *
                                           (vn_qty_to_be_priced / 100) *
                                           vn_after_price;
              
                ---  vn_total_contract_value := vn_total_contract_value +vn_after_qp_price;
                -- vc_price_unit_id        := cur_gmr_rows.ppu_price_unit_id;
                if vc_price_fixation_status <> 'Finalized' then
                  vc_price_fixation_status := 'Partially Priced';
                else
                  vc_price_fixation_status := 'Partially Priced';
                end if;
              end if;
            end if;
          end if;
        elsif vc_period = 'During QP' then
          vd_dur_qp_start_date      := vd_qp_start_date;
          vd_dur_qp_end_date        := vd_qp_end_date;
          vn_during_total_set_price := 0;
          vn_count_set_qp           := 0;
          for cc in (select pfd.user_price,
                            pfd.as_of_date,
                            pfd.qty_fixed,
                            pofh.final_price,
                            pocd.is_any_day_pricing
                       from poch_price_opt_call_off_header poch,
                            pocd_price_option_calloff_dtls pocd,
                            pofh_price_opt_fixation_header pofh,
                            pfd_price_fixation_details     pfd
                      where poch.poch_id = pocd.poch_id
                        and pocd.pocd_id = pofh.pocd_id
                        and pofh.pofh_id = cur_gmr_ele_rows.pofh_id
                        and pofh.pofh_id = pfd.pofh_id
                        and pfd.as_of_date >= vd_dur_qp_start_date
                        and pfd.as_of_date <= pd_trade_date
                        and poch.is_active = 'Y'
                        and pocd.is_active = 'Y'
                        and pofh.is_active = 'Y'
                        and pfd.is_active = 'Y')
          loop
            vn_during_total_set_price := vn_during_total_set_price +
                                         cc.user_price;
            vn_count_set_qp           := vn_count_set_qp + 1;
            if cc.final_price is not null then
              vc_price_fixation_status := 'Finalized';
            end if;
            vn_any_day_fixed_qty := vn_any_day_fixed_qty + cc.qty_fixed;
          end loop;
          if vn_count_set_qp <> 0 then
            if vc_price_fixation_status <> 'Finalized' then
              vc_price_fixation_status := 'Partially Priced';
            end if;
          else
            vc_price_fixation_status := 'Un-priced';
          
          end if;
          if cur_gmr_ele_rows.is_any_day_pricing = 'Y' then
            vn_market_flag := 'N';
          else
            vn_market_flag := 'Y';
          end if;
        
          if cur_gmr_rows.is_daily_cal_applicable = 'Y' then
            -- get the third wednes day
            vd_3rd_wed_of_qp := f_get_next_day(vd_dur_qp_end_date, 'Wed', 3);
            while true
            loop
              if f_is_day_holiday(cur_gmr_rows.instrument_id,
                                  vd_3rd_wed_of_qp) then
                vd_3rd_wed_of_qp := vd_3rd_wed_of_qp + 1;
              else
                exit;
              end if;
            end loop;
          
            --- get 3rd wednesday  before QP period 
            -- Get the quotation date = Trade Date +2 working Days
            if vd_3rd_wed_of_qp <= pd_trade_date then
              workings_days  := 0;
              vd_quotes_date := pd_trade_date + 1;
              while workings_days <> 2
              loop
                if f_is_day_holiday(cur_gmr_rows.instrument_id,
                                    vd_quotes_date) then
                  vd_quotes_date := vd_quotes_date + 1;
                else
                  workings_days := workings_days + 1;
                  if workings_days <> 2 then
                    vd_quotes_date := vd_quotes_date + 1;
                  end if;
                end if;
              end loop;
              vd_3rd_wed_of_qp := vd_quotes_date;
            end if;
            --Get the DR-id
            begin
              select drm.dr_id
                into vc_during_price_dr_id
                from drm_derivative_master drm
               where drm.instrument_id = cur_gmr_rows.instrument_id
                 and drm.prompt_date = vd_3rd_wed_of_qp
                 and rownum <= 1
                 and drm.price_point_id is null
                 and drm.is_deleted = 'N';
            exception
              when no_data_found then
                vobj_error_log.extend;
                vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                     'procedure sp_calc_conc_gmr_price',
                                                                     'PHY-002',
                                                                     'DR-ID missing for ' ||
                                                                     cur_gmr_rows.instrument_name ||
                                                                     ',Price Source:' ||
                                                                     cur_gmr_rows.price_source_name ||
                                                                     ' GMR NO: ' ||
                                                                     cur_gmr_rows.gmr_ref_no ||
                                                                     ',Price Unit:' ||
                                                                     vc_price_name || ',' ||
                                                                     cur_gmr_rows.available_price_name ||
                                                                     ' Price,Prompt Date:' ||
                                                                     vd_3rd_wed_of_qp,
                                                                     '',
                                                                     gvc_process,
                                                                     pc_user_id,
                                                                     sysdate,
                                                                     pd_trade_date);
                sp_insert_error_log(vobj_error_log);
            end;
          elsif cur_gmr_rows.is_daily_cal_applicable = 'N' and
                cur_gmr_rows.is_monthly_cal_applicable = 'Y' then
          
            vc_prompt_date  := pkg_metals_general.fn_get_next_month_prompt_date(cur_gmr_rows.delivery_calender_id,
                                                                                vd_qp_end_date);
            vc_prompt_month := to_char(vc_prompt_date, 'Mon');
            vc_prompt_year  := to_char(vc_prompt_date, 'YYYY');
          
            ---- get the dr_id             
            begin
              select drm.dr_id
                into vc_during_price_dr_id
                from drm_derivative_master drm
               where drm.instrument_id = cur_gmr_rows.instrument_id
                 and drm.period_month = vc_prompt_month
                 and drm.period_year = vc_prompt_year
                 and rownum <= 1
                 and drm.price_point_id is null
                 and drm.is_deleted = 'N';
            exception
              when no_data_found then
                vobj_error_log.extend;
                vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                     'procedure sp_calc_conc_gmr_price',
                                                                     'PHY-002',
                                                                     'DR_ID missing for ' ||
                                                                     cur_gmr_rows.instrument_name ||
                                                                     ',Price Source:' ||
                                                                     cur_gmr_rows.price_source_name ||
                                                                     ' Contract Ref No: ' ||
                                                                     cur_gmr_rows.gmr_ref_no ||
                                                                     ',Price Unit:' ||
                                                                     vc_price_name || ',' ||
                                                                     cur_gmr_rows.available_price_name ||
                                                                     ' Price,Prompt Date:' ||
                                                                     vc_prompt_month || ' ' ||
                                                                     vc_prompt_year,
                                                                     '',
                                                                     gvc_process,
                                                                     pc_user_id,
                                                                     sysdate,
                                                                     pd_trade_date);
                sp_insert_error_log(vobj_error_log);
              
            end;
          
          end if;
          --Get the price for the price
          begin
            select dqd.price,
                   dqd.price_unit_id
              into vn_during_val_price,
                   vc_during_val_price_unit_id
              from dq_derivative_quotes        dq,
                   dqd_derivative_quote_detail dqd
             where dq.dq_id = dqd.dq_id
               and dqd.dr_id = vc_during_price_dr_id
               and dq.instrument_id = cur_gmr_rows.instrument_id
               and dq.dbd_id = dqd.dbd_id
               and dq.dbd_id = pc_dbd_id
               and dqd.available_price_id = cur_gmr_rows.available_price_id
               and dq.price_source_id = cur_gmr_rows.price_source_id
               and dq.trade_date = pd_trade_date
               and dqd.price_unit_id = vc_price_unit_id
               and dq.is_deleted = 'N'
               and dqd.is_deleted = 'N';
          exception
            when no_data_found then
              vobj_error_log.extend;
              vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,'procedure sp_calc_conc_gmr_price','PHY-002','Price missing for ' || cur_gmr_rows.instrument_name ||',Price Source:' || cur_gmr_rows.price_source_name ||' GMR No: ' || cur_gmr_rows.gmr_ref_no ||',Price Unit:' || vc_price_name ||',' || cur_gmr_rows.available_price_name ||' Price,Prompt Date:' || (case when cur_gmr_rows.is_daily_cal_applicable = 'N' and cur_gmr_rows.is_monthly_cal_applicable = 'Y' then to_char(vc_prompt_date, 'Mon-yyyy') else to_char(vd_3rd_wed_of_qp, 'dd-Mon-yyyy') end), '', gvc_process, pc_user_id, sysdate, pd_trade_date);
              sp_insert_error_log(vobj_error_log);
          end;
        
          vn_during_total_val_price := 0;
          vn_count_val_qp           := 0;
          vd_dur_qp_start_date      := pd_trade_date + 1;
          if vn_market_flag = 'N' then
            vn_during_total_val_price := vn_during_total_val_price +
                                         vn_during_val_price;
          
            vn_any_day_unfixed_qty         := cur_gmr_ele_rows.qty_to_be_fixed -
                                              vn_any_day_fixed_qty;
            vn_count_val_qp                := vn_count_val_qp + 1;
            vn_any_day_cont_price_ufix_qty := (vn_any_day_unfixed_qty *
                                              vn_during_total_val_price);
          
          else
            while vd_dur_qp_start_date <= vd_dur_qp_end_date
            loop
              ---- finding holidays       
              if f_is_day_holiday(cur_gmr_rows.instrument_id,
                                  vd_dur_qp_start_date) then
                vc_holiday := 'Y';
              else
                vc_holiday := 'N';
              end if;
            
              if vc_holiday = 'N' then
                vn_during_total_val_price := vn_during_total_val_price +
                                             vn_during_val_price;
                vn_count_val_qp           := vn_count_val_qp + 1;
              end if;
              vd_dur_qp_start_date := vd_dur_qp_start_date + 1;
            end loop;
          end if;
          if (vn_count_val_qp + vn_count_set_qp) <> 0 then
          
            if vn_market_flag = 'N' then
              vn_during_qp_price := (vn_any_day_cont_price_fix_qty +
                                    vn_any_day_cont_price_ufix_qty) /
                                    cur_gmr_ele_rows.qty_to_be_fixed;
            else
              vn_during_qp_price := (vn_during_total_set_price +
                                    vn_during_total_val_price) /
                                    (vn_count_set_qp + vn_count_val_qp);
            end if;
            vn_total_quantity       := pkg_general.f_get_converted_quantity(cur_gmr_rows.product_id,
                                                                            cur_gmr_rows.payable_qty_unit_id,
                                                                            cur_gmr_rows.qty_unit_id,
                                                                            cur_gmr_rows.payable_qty);
            vn_qty_to_be_priced     := cur_gmr_ele_rows.qty_to_be_priced;
            vn_total_contract_value := vn_total_contract_value +
                                       vn_total_quantity *
                                       (vn_qty_to_be_priced / 100) *
                                       vn_during_qp_price;
          
            -- vn_total_contract_value := vn_total_contract_value +vn_during_qp_price;
          else
            vn_total_contract_value := 0;
          end if;
        
        end if;
      end loop;
      vn_avarage_price := round(vn_total_contract_value / vn_total_quantity,
                                3);
    
      begin
        select cm.cur_id,
               cm.cur_code,
               ppu.weight,
               ppu.weight_unit_id,
               qum.qty_unit
          into vc_price_cur_id,
               vc_price_cur_code,
               vc_price_weight_unit,
               vc_price_weight_unit_id,
               vc_price_qty_unit
          from v_ppu_pum                ppu,
               cm_currency_master       cm,
               qum_quantity_unit_master qum
         where ppu.product_price_unit_id = vc_ppu_price_unit_id
           and ppu.cur_id = cm.cur_id
           and qum.qty_unit_id = ppu.weight_unit_id;
      
      exception
        when no_data_found then
          vc_price_cur_id         := null;
          vc_price_cur_code       := null;
          vc_price_weight_unit    := null;
          vc_price_weight_unit_id := null;
          vc_price_qty_unit       := null;
      end;
    
      insert into gpd_gmr_conc_price_daily
        (corporate_id,
         internal_gmr_ref_no,
         element_id,
         contract_price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         price_unit_weight,
         price_unit_weight_unit_id,
         price_unit_weight_unit,
         process_id,
         price_fixation_status,
         price_basis,
         price_fixation_details,
         price_description)
      values
        (cur_gmr_rows.corporate_id,
         cur_gmr_rows.internal_gmr_ref_no,
         cur_gmr_rows.element_id,
         vn_avarage_price,
         vc_ppu_price_unit_id,
         vc_price_cur_id,
         vc_price_cur_code,
         vc_price_weight_unit,
         vc_price_weight_unit_id,
         vc_price_qty_unit,
         pc_process_id,
         vc_price_fixation_status,
         vc_price_basis,
         'Not Applicable',
         vc_price_description);
    
    end loop;
  end;

  procedure sp_calc_contract_conc_price(pc_corporate_id varchar2,
                                        pd_trade_date   date,
                                        pc_process_id   varchar2,
                                        pc_user_id      varchar2,
                                        pc_dbd_id       varchar2) is
  
    vobj_error_log     tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count number := 1;
    cursor cur_pcdi is
      select pcdi.pcdi_id,
             pcdi.internal_contract_ref_no,
             ceqs.element_id,
             ceqs.payable_qty,
             ceqs.payable_qty_unit_id,
             null assay_qty,
             null assay_qty_unit_id,
             pcdi.delivery_item_no,
             pcdi.delivery_period_type,
             pcdi.delivery_from_month,
             pcdi.delivery_from_year,
             pcdi.delivery_to_month,
             pcdi.delivery_to_year,
             pcdi.delivery_from_date,
             pcdi.delivery_to_date,
             pd_trade_date eod_trade_date,
             pcdi.basis_type,
             nvl(pcdi.transit_days, 0) transit_days,
             pcdi.qp_declaration_date,
             pcdi.is_price_optionality_present,
             pcdi.is_phy_optionality_present,
             pci.internal_contract_item_ref_no,
             pcm.contract_ref_no,
             (case
               when nvl(pcdi.payment_due_date, pd_trade_date) <
                    pd_trade_date then
                pd_trade_date
               else
                nvl(pcdi.payment_due_date, pd_trade_date)
             end) payment_due_date,
             --nvl(pcdi.payment_due_date, pd_trade_date) payment_due_date,
             pci.item_qty,
             pci.item_qty_unit_id,
             pcm.invoice_currency_id,
             pcpd.qty_unit_id,
             pcpd.product_id,
             aml.underlying_product_id,
             --qat.quality_name,
             tt.instrument_id,
             akc.base_cur_id,
             akc.base_currency_name,
             tt.instrument_name,
             tt.price_source_id,
             tt.price_source_name,
             tt.available_price_id,
             tt.available_price_name,
             tt.price_unit_name,
             tt.ppu_price_unit_id,
             tt.price_unit_id,
             tt.delivery_calender_id,
             tt.is_daily_cal_applicable,
             tt.is_monthly_cal_applicable
      
        from pcdi_pc_delivery_item pcdi,
             --ceqs_contract_ele_qty_status ceqs,
             v_contract_payable_qty ceqs,
             pci_physical_contract_item pci,
             pcm_physical_contract_main pcm,
             ak_corporate akc,
             pcpd_pc_product_definition pcpd,
             pcpq_pc_product_quality pcpq,
             aml_attribute_master_list aml,
             dipch_di_payablecontent_header dipch,
             pcpch_pc_payble_content_header pcpch,
             (select qat.process_id,
                     qat.internal_contract_item_ref_no,
                     qat.element_id,
                     qat.instrument_id,
                     dim.instrument_name,
                     ps.price_source_id,
                     ps.price_source_name,
                     apm.available_price_id,
                     apm.available_price_name,
                     pum.price_unit_name,
                     vdip.ppu_price_unit_id,
                     div.price_unit_id,
                     dim.delivery_calender_id,
                     pdc.is_daily_cal_applicable,
                     pdc.is_monthly_cal_applicable
                from v_contract_exchange_detail   qat,
                     dim_der_instrument_master    dim,
                     div_der_instrument_valuation div,
                     ps_price_source              ps,
                     apm_available_price_master   apm,
                     pum_price_unit_master        pum,
                     v_der_instrument_price_unit  vdip,
                     pdc_prompt_delivery_calendar pdc
               where qat.instrument_id = dim.instrument_id
                 and dim.instrument_id = div.instrument_id
                 and div.is_deleted = 'N'
                 and div.price_source_id = ps.price_source_id
                 and div.available_price_id = apm.available_price_id
                 and div.price_unit_id = pum.price_unit_id
                 and dim.instrument_id = vdip.instrument_id
                 and dim.delivery_calender_id =
                     pdc.prompt_delivery_calendar_id) tt
      
       where pcdi.pcdi_id = pci.pcdi_id
         and pci.internal_contract_item_ref_no =
             ceqs.internal_contract_item_ref_no
         and pcdi.internal_contract_ref_no = pcm.internal_contract_ref_no
         and pcm.internal_contract_ref_no = pcpd.internal_contract_ref_no
         and pcdi.pcdi_id = dipch.pcdi_id
         and dipch.pcpch_id = pcpch.pcpch_id
         and pcpch.element_id = aml.attribute_id
         and nvl(pcpch.payable_type, 'Payable') = 'Payable'
         and pci.pcpq_id = pcpq.pcpq_id
         and pcm.corporate_id = akc.corporate_id
         and pcm.contract_status = 'In Position'
         and pcm.contract_type = 'CONCENTRATES'
         and pcpd.input_output = 'Input'
            --and pcpd.product_id = qat.conc_product_id
            --and pcpq.quality_template_id = qat.conc_quality_id
         and ceqs.element_id = aml.attribute_id
            --and ceqs.element_id = qat.attribute_id
            --and qat.corporate_id = pc_corporate_id
         and ceqs.internal_contract_item_ref_no =
             tt.internal_contract_item_ref_no(+)
         and ceqs.element_id = tt.element_id(+)
         and ceqs.process_id = tt.process_id(+)
         and pci.item_qty > 0
         and ceqs.payable_qty > 0
         and pcdi.process_id = pc_process_id
         and pci.process_id = pc_process_id
         and pcm.process_id = pc_process_id
         and pcpd.process_id = pc_process_id
         and pcpq.process_id = pc_process_id
         and ceqs.process_id = pc_process_id
         and dipch.process_id = pc_process_id
         and pcpch.process_id = pc_process_id
         and pcpd.is_active = 'Y'
         and pcpq.is_active = 'Y'
         and pcdi.is_active = 'Y'
         and pci.is_active = 'Y'
         and pcm.is_active = 'Y'
         and dipch.is_active = 'Y'
         and pcpch.is_active = 'Y';
  
    cursor cur_called_off(pc_pcdi_id varchar2, pc_element_id varchar2) is
      select poch.poch_id,
             poch.internal_action_ref_no,
             pocd.pricing_formula_id,
             pcbpd.pcbpd_id,
             pcbpd.price_basis,
             pcbpd.price_value,
             pcbpd.price_unit_id,
             pcbpd.tonnage_basis,
             pcbpd.fx_to_base,
             pcbpd.qty_to_be_priced,
             pcbph.price_description
        from poch_price_opt_call_off_header poch,
             pocd_price_option_calloff_dtls pocd,
             pcbpd_pc_base_price_detail     pcbpd,
             pcbph_pc_base_price_header     pcbph
       where poch.pcdi_id = pc_pcdi_id
         and pcbpd.element_id = pc_element_id
         and poch.poch_id = pocd.poch_id
         and pocd.pcbpd_id = pcbpd.pcbpd_id
         and pcbpd.pcbph_id = pcbph.pcbph_id
         and pcbpd.process_id = pc_process_id
         and pcbph.process_id = pc_process_id
         and poch.is_active = 'Y'
         and pocd.is_active = 'Y'
         and pcbpd.is_active = 'Y'
         and pcbph.is_active = 'Y';
  
    cursor cur_not_called_off(pc_pcdi_id varchar2, pc_element_id varchar2, pc_int_cont_item_ref_no varchar2) is
      select pcbpd.pcbpd_id,
             pcbph.internal_contract_ref_no,
             pcbpd.price_basis,
             pcbpd.price_value,
             pcbpd.price_unit_id,
             pcbpd.tonnage_basis,
             pcbpd.fx_to_base,
             pcbpd.qty_to_be_priced,
             pcbph.price_description
        from pci_physical_contract_item pci,
             pcipf_pci_pricing_formula  pcipf,
             pcbph_pc_base_price_header pcbph,
             pcbpd_pc_base_price_detail pcbpd
       where pci.internal_contract_item_ref_no =
             pcipf.internal_contract_item_ref_no
         and pcipf.pcbph_id = pcbph.pcbph_id
         and pcbph.pcbph_id = pcbpd.pcbph_id
         and pci.pcdi_id = pc_pcdi_id
         and pcbpd.element_id = pc_element_id
         and pci.internal_contract_item_ref_no = pc_int_cont_item_ref_no
         and pci.process_id = pc_process_id
         and pcipf.process_id = pc_process_id
         and pcbph.process_id = pc_process_id
         and pcbpd.process_id = pc_process_id
         and pci.is_active = 'Y'
         and pcipf.is_active = 'Y'
         and pcbpd.is_active = 'Y'
         and pcbph.is_active = 'Y';
  
    vn_contract_price              number;
    vc_price_unit_id               varchar2(15);
    vn_total_quantity              number;
    vn_total_contract_value        number;
    vd_shipment_date               date;
    vd_arrival_date                date;
    vd_qp_start_date               date;
    vd_qp_end_date                 date;
    vc_period                      varchar2(20);
    vd_3rd_wed_of_qp               date;
    workings_days                  number;
    vd_quotes_date                 date;
    vc_before_price_dr_id          varchar2(15);
    vn_before_qp_price             number;
    vc_before_qp_price_unit_id     varchar2(15);
    vn_qty_to_be_priced            number;
    vn_after_price                 number;
    vn_after_count                 number;
    vc_after_qp_price_unit_id      varchar2(15);
    vn_after_qp_price              number;
    vd_dur_qp_start_date           date;
    vd_dur_qp_end_date             date;
    vn_during_total_set_price      number;
    vn_count_set_qp                number;
    vn_any_day_cont_price_fix_qty  number;
    vn_any_day_fixed_qty           number;
    vn_market_flag                 char(1);
    vc_during_price_dr_id          varchar2(15);
    vn_during_val_price            number;
    vc_during_val_price_unit_id    varchar2(15);
    vn_during_total_val_price      number;
    vn_count_val_qp                number;
    vn_any_day_unfixed_qty         number;
    vn_any_day_cont_price_ufix_qty number;
    vc_holiday                     char(10);
    vn_during_qp_price             number;
    vn_avarage_price               number;
    vc_price_fixation_status       varchar2(50);
    vc_price_basis                 varchar2(15);
    vc_price_description           varchar2(500);
    --vd_evevnt_date                 date;
    --vd_qp_price_date               date;
    vc_after_price_dr_id           varchar2(15);
    vc_during_qp_price_unit_id     varchar2(15);
    vc_price_cur_id                varchar2(15);
    vc_price_cur_code              varchar2(15);
    vc_price_weight_unit           number;
    vc_price_weight_unit_id        varchar2(15);
    vc_price_qty_unit              varchar2(15);
    vc_contract_main_cur_id        varchar2(15);
    vc_contract_main_cur_code      varchar2(15);
    vn_contract_main_cur_factor    number;
    vc_base_main_cur_id            varchar2(15);
    vc_base_main_cur_code          varchar2(15);
    vd_payment_due_date            date;
    vn_settlement_price            number;
    vn_forward_points              number;
    vn_contract_base_price_unit_id varchar2(15);
    vc_price_option_call_off_sts   varchar2(50);
    vc_pcdi_id                     varchar2(15);
    vc_element_id                  varchar2(15);
    vc_prompt_month                varchar2(15);
    vc_prompt_year                 number;
    vc_prompt_date                 date;
    vn_delta_price                 number;
    vc_delta_pricing_flag          char(1);
    vn_delta_priced_qty            number;
    vn_delta_avg_price             number;
    vn_total_delta_priced_qty      number;
  
  begin
  
    for cur_pcdi_rows in cur_pcdi
    loop
      vc_pcdi_id    := cur_pcdi_rows.pcdi_id;
      vc_element_id := cur_pcdi_rows.element_id;
      begin
        select dipq.price_option_call_off_status
          into vc_price_option_call_off_sts
          from dipq_delivery_item_payable_qty dipq
         where dipq.pcdi_id = vc_pcdi_id
           and dipq.element_id = vc_element_id
           and dipq.is_active = 'Y'
           and dipq.dbd_id = pc_dbd_id;
      exception
        when no_data_found then
          vc_price_option_call_off_sts := null;
      end;
    
      vc_price_fixation_status := null;
      vn_total_contract_value  := 0;
      vd_qp_start_date         := null;
      vd_qp_end_date           := null;
    
      if vc_price_option_call_off_sts in ('Called Off', 'Not Applicable') then
        for cur_called_off_rows in cur_called_off(cur_pcdi_rows.pcdi_id,
                                                  cur_pcdi_rows.element_id)
        loop
          vc_price_basis       := cur_called_off_rows.price_basis;
          vc_price_description := cur_called_off_rows.price_description;
          if cur_called_off_rows.price_basis = 'Fixed' then
          
            vn_contract_price        := cur_called_off_rows.price_value;
            vn_total_quantity        := pkg_general.f_get_converted_quantity(cur_pcdi_rows.underlying_product_id,
                                                                             cur_pcdi_rows.payable_qty_unit_id,
                                                                             cur_pcdi_rows.item_qty_unit_id,
                                                                             cur_pcdi_rows.payable_qty);
            vn_qty_to_be_priced      := cur_called_off_rows.qty_to_be_priced;
            vn_total_contract_value  := vn_total_contract_value +
                                        vn_total_quantity *
                                        (vn_qty_to_be_priced / 100) *
                                        vn_contract_price;
            vc_price_unit_id         := cur_called_off_rows.price_unit_id;
            vc_price_fixation_status := 'Fixed';
          
          elsif cur_called_off_rows.price_basis in ('Index', 'Formula') then
            for cc1 in (select ppfh.ppfh_id,
                               ppfh.price_unit_id ppu_price_unit_id,
                               ppu.price_unit_id,
                               ppu.price_unit_name,
                               pocd.qp_period_type,
                               pofh.qp_start_date,
                               pofh.qp_end_date,
                               pfqpp.event_name,
                               pfqpp.no_of_event_months,
                               pfqpp.is_qp_any_day_basis,
                               pofh.qty_to_be_fixed,
                               pofh.priced_qty,
                               pofh.pofh_id,
                               pofh.no_of_prompt_days,
                               pofh.avg_price_in_price_in_cur,
                               pofh.final_price,
                               pocd.pay_in_price_unit_id
                          from poch_price_opt_call_off_header poch,
                               pocd_price_option_calloff_dtls pocd,
                               pcbpd_pc_base_price_detail     pcbpd,
                               ppfh_phy_price_formula_header  ppfh,
                               pfqpp_phy_formula_qp_pricing   pfqpp,
                               pofh_price_opt_fixation_header pofh,
                               v_ppu_pum                      ppu
                         where poch.poch_id = pocd.poch_id
                           and pocd.pcbpd_id = pcbpd.pcbpd_id
                           and pcbpd.pcbpd_id = ppfh.pcbpd_id
                           and ppfh.ppfh_id = pfqpp.ppfh_id
                           and pocd.pocd_id = pofh.pocd_id(+)
                           and pcbpd.pcbpd_id = cur_called_off_rows.pcbpd_id
                           and poch.poch_id = cur_called_off_rows.poch_id
                           and ppfh.price_unit_id =
                               ppu.product_price_unit_id
                           and poch.is_active = 'Y'
                           and pocd.is_active = 'Y'
                           and pcbpd.is_active = 'Y'
                           and ppfh.is_active = 'Y'
                           and pfqpp.is_active = 'Y'
                              -- and pofh.is_active(+) = 'Y'
                           and pcbpd.process_id = pc_process_id
                           and pfqpp.process_id = pc_process_id
                           and ppfh.process_id = pc_process_id)
            
            loop
              if cur_pcdi_rows.basis_type = 'Shipment' then
                if cur_pcdi_rows.delivery_period_type = 'Month' then
                  vd_shipment_date := last_day('01-' ||
                                               cur_pcdi_rows.delivery_to_month || '-' ||
                                               cur_pcdi_rows.delivery_to_year);
                elsif cur_pcdi_rows.delivery_period_type = 'Date' then
                  vd_shipment_date := cur_pcdi_rows.delivery_to_date;
                end if;
                vd_arrival_date := vd_shipment_date +
                                   cur_pcdi_rows.transit_days;
              
              elsif cur_pcdi_rows.basis_type = 'Arrival' then
                if cur_pcdi_rows.delivery_period_type = 'Month' then
                  vd_arrival_date := last_day('01-' ||
                                              cur_pcdi_rows.delivery_to_month || '-' ||
                                              cur_pcdi_rows.delivery_to_year);
                elsif cur_pcdi_rows.delivery_period_type = 'Date' then
                  vd_arrival_date := cur_pcdi_rows.delivery_to_date;
                end if;
                vd_shipment_date := vd_arrival_date -
                                    cur_pcdi_rows.transit_days;
              end if;
            
              if cc1.qp_period_type = 'Period' then
                vd_qp_start_date := cc1.qp_start_date;
                vd_qp_end_date   := cc1.qp_end_date;
              elsif cc1.qp_period_type = 'Month' then
                vd_qp_start_date := cc1.qp_start_date;
                vd_qp_end_date   := cc1.qp_end_date;
              elsif cc1.qp_period_type = 'Date' then
                vd_qp_start_date := cc1.qp_start_date;
                vd_qp_end_date   := cc1.qp_end_date;
              elsif cc1.qp_period_type = 'Event' then
                begin
                  select dieqp.expected_qp_start_date,
                         dieqp.expected_qp_end_date
                    into vd_qp_start_date,
                         vd_qp_end_date
                    from di_del_item_exp_qp_details dieqp
                   where dieqp.pcdi_id = cur_pcdi_rows.pcdi_id
                     and dieqp.pcbpd_id = cur_called_off_rows.pcbpd_id
                     and dieqp.is_active = 'Y';
                exception
                  when no_data_found then
                    vd_qp_start_date := cc1.qp_start_date;
                    vd_qp_end_date   := cc1.qp_end_date;
                  when others then
                    vd_qp_start_date := cc1.qp_start_date;
                    vd_qp_end_date   := cc1.qp_end_date;
                end;
              else
                vd_qp_start_date := cc1.qp_start_date;
                vd_qp_end_date   := cc1.qp_end_date;
              end if;
              if cur_pcdi_rows.eod_trade_date >= vd_qp_start_date and
                 cur_pcdi_rows.eod_trade_date <= vd_qp_end_date then
                vc_period := 'During QP';
              elsif cur_pcdi_rows.eod_trade_date < vd_qp_start_date and
                    cur_pcdi_rows.eod_trade_date < vd_qp_end_date then
                vc_period := 'Before QP';
              elsif cur_pcdi_rows.eod_trade_date > vd_qp_start_date and
                    cur_pcdi_rows.eod_trade_date > vd_qp_end_date then
                vc_period := 'After QP';
              end if;
              if vc_period = 'Before QP' then
                vc_price_fixation_status := 'Un-priced';
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'Y' then
                  vd_3rd_wed_of_qp := f_get_next_day(vd_qp_end_date,
                                                     'Wed',
                                                     3);
                
                  while true
                  loop
                    if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                        vd_3rd_wed_of_qp) then
                      vd_3rd_wed_of_qp := vd_3rd_wed_of_qp + 1;
                    else
                      exit;
                    end if;
                  end loop;
                  --- get 3rd wednesday  before QP period 
                  -- Get the quotation date = Trade Date +2 working Days
                  if vd_3rd_wed_of_qp <= pd_trade_date then
                    workings_days  := 0;
                    vd_quotes_date := pd_trade_date + 1;
                    while workings_days <> 2
                    loop
                      if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                          vd_quotes_date) then
                        vd_quotes_date := vd_quotes_date + 1;
                      else
                        workings_days := workings_days + 1;
                        if workings_days <> 2 then
                          vd_quotes_date := vd_quotes_date + 1;
                        end if;
                      end if;
                    end loop;
                    vd_3rd_wed_of_qp := vd_quotes_date;
                  end if;
                  ---- get the dr_id             
                  begin
                    select drm.dr_id
                      into vc_before_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.prompt_date = vd_3rd_wed_of_qp
                       and rownum <= 1
                       and drm.price_point_id is null
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_conc_price',
                                                                           'PHY-002',
                                                                           'DR_ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vd_3rd_wed_of_qp,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                    
                  end;
                end if;
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'N' and
                   cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then
                
                  vc_prompt_date  := pkg_metals_general.fn_get_next_month_prompt_date(cur_pcdi_rows.delivery_calender_id,
                                                                                      vd_qp_end_date);
                  vc_prompt_month := to_char(vc_prompt_date, 'Mon');
                  vc_prompt_year  := to_char(vc_prompt_date, 'YYYY');
                
                  ---- get the dr_id             
                  begin
                    select drm.dr_id
                      into vc_before_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.period_month = vc_prompt_month
                       and drm.period_year = vc_prompt_year
                       and rownum <= 1
                       and drm.price_point_id is null
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_conc_price',
                                                                           'PHY-002',
                                                                           'DR_ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vc_prompt_month || ' ' ||
                                                                           vc_prompt_year,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                    
                  end;
                
                end if;
              
                --get the price              
                begin
                  select dqd.price,
                         dqd.price_unit_id
                    into vn_before_qp_price,
                         vc_before_qp_price_unit_id
                    from dq_derivative_quotes        dq,
                         dqd_derivative_quote_detail dqd
                   where dq.dq_id = dqd.dq_id
                     and dqd.dr_id = vc_before_price_dr_id
                     and dq.process_id = pc_process_id
                     and dq.instrument_id = cur_pcdi_rows.instrument_id
                     and dq.process_id = dqd.process_id
                     and dqd.available_price_id =
                         cur_pcdi_rows.available_price_id
                     and dq.price_source_id = cur_pcdi_rows.price_source_id
                     and dqd.price_unit_id = cc1.price_unit_id
                     and dq.trade_date = pd_trade_date
                     and dq.is_deleted = 'N'
                     and dqd.is_deleted = 'N';
                exception
                  when no_data_found then
                    vobj_error_log.extend;
                    vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,'procedure sp_calc_contract_conc_price','PHY-002','Price missing for ' || cur_pcdi_rows.instrument_name ||',Price Source:' || cur_pcdi_rows.price_source_name ||' Contract Ref No: ' || cur_pcdi_rows.contract_ref_no ||',Price Unit:' || cc1.price_unit_name ||',' || cur_pcdi_rows.available_price_name ||' Price,Prompt Date:' || (case when cur_pcdi_rows.is_daily_cal_applicable = 'N' and cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then
                    --vc_prompt_month || '-' || vc_prompt_year
                     to_char(vc_prompt_date, 'Mon-yyyy') else to_char(vd_3rd_wed_of_qp, 'dd-Mon-yyyy') end), '', gvc_process, pc_user_id, sysdate, pd_trade_date);
                    sp_insert_error_log(vobj_error_log);
                end;
                vn_total_quantity       := pkg_general.f_get_converted_quantity(cur_pcdi_rows.underlying_product_id,
                                                                                cur_pcdi_rows.payable_qty_unit_id,
                                                                                cur_pcdi_rows.item_qty_unit_id,
                                                                                cur_pcdi_rows.payable_qty);
                vn_qty_to_be_priced     := cur_called_off_rows.qty_to_be_priced;
                vn_total_contract_value := vn_total_contract_value +
                                           vn_total_quantity *
                                           (vn_qty_to_be_priced / 100) *
                                           vn_before_qp_price;
                vc_price_unit_id        := cc1.ppu_price_unit_id;
              
              elsif vc_period = 'After QP' then
                if cc1.avg_price_in_price_in_cur is not null and
                   cc1.final_price is not null then
                  vn_after_qp_price       := cc1.avg_price_in_price_in_cur;
                  vn_total_quantity       := pkg_general.f_get_converted_quantity(cur_pcdi_rows.underlying_product_id,
                                                                                  cur_pcdi_rows.payable_qty_unit_id,
                                                                                  cur_pcdi_rows.item_qty_unit_id,
                                                                                  cur_pcdi_rows.payable_qty);
                  vn_qty_to_be_priced     := cur_called_off_rows.qty_to_be_priced;
                  vn_total_contract_value := vn_total_contract_value +
                                             vn_total_quantity *
                                             (vn_qty_to_be_priced / 100) *
                                             vn_after_qp_price;
                  vc_price_unit_id        := cc1.pay_in_price_unit_id;
                else
                  vn_after_price := 0;
                  vn_after_count := 0;
                  for pfd_price in (select pfd.user_price,
                                           pfd.price_unit_id,
                                           pofh.final_price
                                      from poch_price_opt_call_off_header poch,
                                           pocd_price_option_calloff_dtls pocd,
                                           pofh_price_opt_fixation_header pofh,
                                           pfd_price_fixation_details     pfd
                                     where poch.poch_id = pocd.poch_id
                                       and pocd.pocd_id = pofh.pocd_id
                                       and pfd.pofh_id = cc1.pofh_id
                                       and pofh.pofh_id = pfd.pofh_id
                                       and poch.is_active = 'Y'
                                       and pocd.is_active = 'Y'
                                       and pofh.is_active = 'Y'
                                       and nvl(pfd.is_delta_pricing, 'N') = 'N'
                                       and pfd.is_active = 'Y')
                  loop
                    vn_after_price            := vn_after_price +
                                                 pfd_price.user_price;
                    vn_after_count            := vn_after_count + 1;
                    vc_after_qp_price_unit_id := pfd_price.price_unit_id;
                  
                    if pfd_price.final_price is not null then
                      vc_price_fixation_status := 'Finalized';
                    end if;
                  
                  end loop;
                  if vn_after_count = 0 then
                    vn_after_qp_price        := 0;
                    vn_total_contract_value  := 0;
                    vc_price_fixation_status := 'Un-priced';
                    vn_total_quantity        := pkg_general.f_get_converted_quantity(cur_pcdi_rows.underlying_product_id,
                                                                                     cur_pcdi_rows.payable_qty_unit_id,
                                                                                     cur_pcdi_rows.item_qty_unit_id,
                                                                                     cur_pcdi_rows.payable_qty);
                  else
                    if vc_price_fixation_status <> 'Finalized' then
                      vc_price_fixation_status := 'Partially Priced';
                    else
                      vc_price_fixation_status := 'Partially Priced';
                    end if;
                  
                    begin
                      select pfd.user_price,
                             pfd.is_delta_pricing,
                             pofh.delta_priced_qty
                        into vn_delta_price,
                             vc_delta_pricing_flag,
                             vn_delta_priced_qty
                        from pfd_price_fixation_details     pfd,
                             pofh_price_opt_fixation_header pofh
                       where pfd.pofh_id = cc1.pofh_id
                         and pofh.pofh_id = pfd.pofh_id
                         and pfd.is_delta_pricing = 'Y'
                         and pofh.is_active = 'Y'
                         and pfd.is_active = 'Y';
                    exception
                      when no_data_found then
                        vn_delta_price        := null;
                        vc_delta_pricing_flag := 'N';
                        vn_delta_priced_qty   := null;
                    end;
                    if vc_delta_pricing_flag = 'Y' then
                      vn_after_qp_price         := vn_after_price /
                                                   vn_after_count;
                      vn_total_quantity         := pkg_general.f_get_converted_quantity(cur_pcdi_rows.underlying_product_id,
                                                                                        cur_pcdi_rows.payable_qty_unit_id,
                                                                                        cur_pcdi_rows.item_qty_unit_id,
                                                                                        cur_pcdi_rows.payable_qty);
                      vn_total_delta_priced_qty := pkg_general.f_get_converted_quantity(cur_pcdi_rows.underlying_product_id,
                                                                                        cur_pcdi_rows.payable_qty_unit_id,
                                                                                        cur_pcdi_rows.item_qty_unit_id,
                                                                                        vn_delta_priced_qty);
                      vn_qty_to_be_priced       := cur_called_off_rows.qty_to_be_priced;
                      vn_delta_avg_price        := (((vn_total_quantity -
                                                   vn_total_delta_priced_qty) *
                                                   vn_after_qp_price) +
                                                   (vn_total_delta_priced_qty *
                                                   vn_delta_price)) /
                                                   vn_total_quantity;
                      vn_total_contract_value   := vn_total_contract_value +
                                                   vn_total_quantity *
                                                   (vn_qty_to_be_priced / 100) *
                                                   vn_delta_avg_price;
                      vc_price_unit_id          := vc_after_qp_price_unit_id;
                    
                    else
                      vn_after_qp_price       := vn_after_price /
                                                 vn_after_count;
                      vn_total_quantity       := pkg_general.f_get_converted_quantity(cur_pcdi_rows.underlying_product_id,
                                                                                      cur_pcdi_rows.payable_qty_unit_id,
                                                                                      cur_pcdi_rows.item_qty_unit_id,
                                                                                      cur_pcdi_rows.payable_qty);
                      vn_qty_to_be_priced     := cur_called_off_rows.qty_to_be_priced;
                      vn_total_contract_value := vn_total_contract_value +
                                                 vn_total_quantity *
                                                 (vn_qty_to_be_priced / 100) *
                                                 vn_after_qp_price;
                      vc_price_unit_id        := vc_after_qp_price_unit_id;
                    end if;
                  end if;
                end if;
              
              elsif vc_period = 'During QP' then
              
                vd_dur_qp_start_date          := vd_qp_start_date;
                vd_dur_qp_end_date            := vd_qp_end_date;
                vn_during_total_set_price     := 0;
                vn_count_set_qp               := 0;
                vn_any_day_cont_price_fix_qty := 0;
                vn_any_day_fixed_qty          := 0;
              
                for cc in (select pfd.user_price,
                                  pfd.as_of_date,
                                  pfd.qty_fixed,
                                  pofh.final_price
                             from poch_price_opt_call_off_header poch,
                                  pocd_price_option_calloff_dtls pocd,
                                  pofh_price_opt_fixation_header pofh,
                                  pfd_price_fixation_details     pfd
                            where poch.poch_id = pocd.poch_id
                              and pocd.pocd_id = pofh.pocd_id
                              and pofh.pofh_id = cc1.pofh_id
                              and pofh.pofh_id = pfd.pofh_id
                              and pfd.as_of_date >= vd_dur_qp_start_date
                              and pfd.as_of_date <= pd_trade_date
                              and poch.is_active = 'Y'
                              and pocd.is_active = 'Y'
                              and pofh.is_active = 'Y'
                              and pfd.is_active = 'Y')
                loop
                  vn_during_total_set_price     := vn_during_total_set_price +
                                                   cc.user_price;
                  vn_any_day_cont_price_fix_qty := vn_any_day_cont_price_fix_qty +
                                                   (cc.user_price *
                                                   cc.qty_fixed);
                  vn_any_day_fixed_qty          := vn_any_day_fixed_qty +
                                                   cc.qty_fixed;
                  vn_count_set_qp               := vn_count_set_qp + 1;
                
                  if cc.final_price is not null then
                    vc_price_fixation_status := 'Finalized';
                  end if;
                end loop;
              
                if vn_count_set_qp <> 0 then
                  if vc_price_fixation_status <> 'Finalized' then
                    vc_price_fixation_status := 'Partially Priced';
                  else
                    vc_price_fixation_status := 'Partially Priced';
                  end if;
                else
                  vc_price_fixation_status := 'Un-priced';
                
                end if;
              
                if cc1.is_qp_any_day_basis = 'Y' then
                  vn_market_flag := 'N';
                else
                  vn_market_flag := 'Y';
                end if;
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'Y' then
                  -- get the third wednes day
                  vd_3rd_wed_of_qp := f_get_next_day(vd_dur_qp_end_date,
                                                     'Wed',
                                                     3);
                  while true
                  loop
                    if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                        vd_3rd_wed_of_qp) then
                      vd_3rd_wed_of_qp := vd_3rd_wed_of_qp + 1;
                    else
                      exit;
                    end if;
                  end loop;
                
                  --- get 3rd wednesday  before QP period 
                  -- Get the quotation date = Trade Date +2 working Days
                  if vd_3rd_wed_of_qp <= pd_trade_date then
                    workings_days  := 0;
                    vd_quotes_date := pd_trade_date + 1;
                    while workings_days <> 2
                    loop
                      if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                          vd_quotes_date) then
                        vd_quotes_date := vd_quotes_date + 1;
                      else
                        workings_days := workings_days + 1;
                        if workings_days <> 2 then
                          vd_quotes_date := vd_quotes_date + 1;
                        end if;
                      end if;
                    end loop;
                    vd_3rd_wed_of_qp := vd_quotes_date;
                  end if;
                  --Get the DR-id
                  begin
                    select drm.dr_id
                      into vc_during_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.prompt_date = vd_3rd_wed_of_qp
                       and rownum <= 1
                       and drm.price_point_id is null
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_conc_price',
                                                                           'PHY-002',
                                                                           'DR-ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vd_3rd_wed_of_qp,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                  end;
                end if;
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'N' and
                   cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then
                
                  vc_prompt_date  := pkg_metals_general.fn_get_next_month_prompt_date(cur_pcdi_rows.delivery_calender_id,
                                                                                      vd_qp_end_date);
                  vc_prompt_month := to_char(vc_prompt_date, 'Mon');
                  vc_prompt_year  := to_char(vc_prompt_date, 'YYYY');
                
                  ---- get the dr_id             
                  begin
                    select drm.dr_id
                      into vc_during_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.period_month = vc_prompt_month
                       and drm.period_year = vc_prompt_year
                       and rownum <= 1
                       and drm.price_point_id is null
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_conc_price',
                                                                           'PHY-002',
                                                                           'DR_ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vc_prompt_month || ' ' ||
                                                                           vc_prompt_year,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                    
                  end;
                
                end if;
              
                --Get the price for the dr-id
                begin
                  select dqd.price,
                         dqd.price_unit_id
                    into vn_during_val_price,
                         vc_during_val_price_unit_id
                    from dq_derivative_quotes        dq,
                         dqd_derivative_quote_detail dqd
                   where dq.dq_id = dqd.dq_id
                     and dqd.dr_id = vc_during_price_dr_id
                     and dq.instrument_id = cur_pcdi_rows.instrument_id
                     and dq.dbd_id = dqd.dbd_id
                     and dq.dbd_id = pc_dbd_id
                     and dqd.available_price_id =
                         cur_pcdi_rows.available_price_id
                     and dq.price_source_id = cur_pcdi_rows.price_source_id
                     and dqd.price_unit_id = cc1.price_unit_id
                     and dq.trade_date = pd_trade_date
                     and dq.is_deleted = 'N'
                     and dqd.is_deleted = 'N';
                exception
                  when no_data_found then
                    vobj_error_log.extend;
                    vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,'procedure sp_calc_contract_conc_price','PHY-002','Price missing for ' || cur_pcdi_rows.instrument_name ||',Price Source:' || cur_pcdi_rows.price_source_name ||' Contract Ref No: ' || cur_pcdi_rows.contract_ref_no ||',Price Unit:' || cc1.price_unit_name ||',' || cur_pcdi_rows.available_price_name ||' Price,Prompt Date:' || (case when cur_pcdi_rows.is_daily_cal_applicable = 'N' and cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then
                    -- vc_prompt_month || '-' || vc_prompt_year
                     to_char(vc_prompt_date, 'Mon-yyyy') else to_char(vd_3rd_wed_of_qp, 'dd-Mon-yyyy') end), '', gvc_process, pc_user_id, sysdate, pd_trade_date);
                    sp_insert_error_log(vobj_error_log);
                end;
              
                vn_during_total_val_price := 0;
                vn_count_val_qp           := 0;
                vd_dur_qp_start_date      := pd_trade_date + 1;
              
                if vn_market_flag = 'N' then
                  vn_during_total_val_price := vn_during_total_val_price +
                                               vn_during_val_price;
                
                  vn_any_day_unfixed_qty         := cc1.qty_to_be_fixed -
                                                    vn_any_day_fixed_qty;
                  vn_count_val_qp                := vn_count_val_qp + 1;
                  vn_any_day_cont_price_ufix_qty := (vn_any_day_unfixed_qty *
                                                    vn_during_total_val_price);
                  if vn_any_day_unfixed_qty > 0 then
                    vc_price_fixation_status := 'Partially Priced';
                  else
                    vc_price_fixation_status := 'Priced';
                  end if;
                
                else
                
                  while vd_dur_qp_start_date <= vd_dur_qp_end_date
                  loop
                    ---- finding holidays       
                    if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                        vd_dur_qp_start_date) then
                      vc_holiday := 'Y';
                    else
                      vc_holiday := 'N';
                    end if;
                  
                    if vc_holiday = 'N' then
                      vn_during_total_val_price := vn_during_total_val_price +
                                                   vn_during_val_price;
                      vn_count_val_qp           := vn_count_val_qp + 1;
                    end if;
                    vd_dur_qp_start_date := vd_dur_qp_start_date + 1;
                  end loop;
                end if;
              
                if (vn_count_val_qp + vn_count_set_qp) <> 0 then
                
                  if vn_market_flag = 'N' then
                    vn_during_qp_price := (vn_any_day_cont_price_fix_qty +
                                          vn_any_day_cont_price_ufix_qty) /
                                          cc1.qty_to_be_fixed;
                  else
                    vn_during_qp_price := (vn_during_total_set_price +
                                          vn_during_total_val_price) /
                                          (vn_count_set_qp +
                                          vn_count_val_qp);
                  end if;
                  vn_total_quantity       := pkg_general.f_get_converted_quantity(cur_pcdi_rows.underlying_product_id,
                                                                                  cur_pcdi_rows.payable_qty_unit_id,
                                                                                  cur_pcdi_rows.item_qty_unit_id,
                                                                                  cur_pcdi_rows.payable_qty);
                  vn_qty_to_be_priced     := cur_called_off_rows.qty_to_be_priced;
                  vn_total_contract_value := vn_total_contract_value +
                                             vn_total_quantity *
                                             (vn_qty_to_be_priced / 100) *
                                             vn_during_qp_price;
                  vc_price_unit_id        := cc1.ppu_price_unit_id;
                
                else
                  vn_total_quantity       := pkg_general.f_get_converted_quantity(cur_pcdi_rows.underlying_product_id,
                                                                                  cur_pcdi_rows.payable_qty_unit_id,
                                                                                  cur_pcdi_rows.item_qty_unit_id,
                                                                                  cur_pcdi_rows.payable_qty);
                  vn_total_contract_value := 0;
                  vc_price_unit_id        := cc1.ppu_price_unit_id;
                end if;
              
              end if;
            end loop;
          end if;
        end loop;
        vn_avarage_price := round(vn_total_contract_value /
                                  vn_total_quantity,
                                  3);
      
      elsif vc_price_option_call_off_sts = 'Not Called Off' then
      
        vc_price_fixation_status := null;
        for cur_not_called_off_rows in cur_not_called_off(cur_pcdi_rows.pcdi_id,
                                                          cur_pcdi_rows.element_id,
                                                          cur_pcdi_rows.internal_contract_item_ref_no)
        loop
          vc_price_basis       := cur_not_called_off_rows.price_basis;
          vc_price_description := cur_not_called_off_rows.price_description;
          --vn_total_contract_value := 0;
          if cur_not_called_off_rows.price_basis = 'Fixed' then
            vn_contract_price        := cur_not_called_off_rows.price_value;
            vn_total_quantity        := pkg_general.f_get_converted_quantity(cur_pcdi_rows.underlying_product_id,
                                                                             cur_pcdi_rows.payable_qty_unit_id,
                                                                             cur_pcdi_rows.item_qty_unit_id,
                                                                             cur_pcdi_rows.payable_qty);
            vn_qty_to_be_priced      := cur_not_called_off_rows.qty_to_be_priced;
            vn_total_contract_value  := vn_total_contract_value +
                                        vn_total_quantity *
                                        (vn_qty_to_be_priced / 100) *
                                        vn_contract_price;
            vc_price_unit_id         := cur_not_called_off_rows.price_unit_id;
            vc_price_fixation_status := 'Fixed';
          
          elsif cur_not_called_off_rows.price_basis in ('Index', 'Formula') then
            for cc1 in (select pfqpp.qp_pricing_period_type,
                               pfqpp.qp_period_from_date,
                               pfqpp.qp_period_to_date,
                               pfqpp.qp_month,
                               pfqpp.qp_year,
                               pfqpp.qp_date,
                               pfqpp.event_name,
                               pfqpp.no_of_event_months,
                               ppfh.price_unit_id ppu_price_unit_id,
                               ppu.price_unit_id, --pum price unit id, as quoted available in this unit only
                               ppu.price_unit_name
                          from ppfh_phy_price_formula_header ppfh,
                               pfqpp_phy_formula_qp_pricing  pfqpp,
                               v_ppu_pum                     ppu
                         where ppfh.ppfh_id = pfqpp.ppfh_id
                           and ppfh.pcbpd_id =
                               cur_not_called_off_rows.pcbpd_id
                           and ppfh.is_active = 'Y'
                           and pfqpp.is_active = 'Y'
                           and ppfh.price_unit_id =
                               ppu.product_price_unit_id
                           and ppfh.process_id = pc_process_id
                           and pfqpp.process_id = pc_process_id)
            loop
            
              if cur_pcdi_rows.basis_type = 'Shipment' then
                if cur_pcdi_rows.delivery_period_type = 'Month' then
                  vd_shipment_date := last_day('01-' ||
                                               cur_pcdi_rows.delivery_to_month || '-' ||
                                               cur_pcdi_rows.delivery_to_year);
                elsif cur_pcdi_rows.delivery_period_type = 'Date' then
                  vd_shipment_date := cur_pcdi_rows.delivery_to_date;
                end if;
                vd_arrival_date := vd_shipment_date +
                                   cur_pcdi_rows.transit_days;
              
              elsif cur_pcdi_rows.basis_type = 'Arrival' then
                if cur_pcdi_rows.delivery_period_type = 'Month' then
                  vd_arrival_date := last_day('01-' ||
                                              cur_pcdi_rows.delivery_to_month || '-' ||
                                              cur_pcdi_rows.delivery_to_year);
                elsif cur_pcdi_rows.delivery_period_type = 'Date' then
                  vd_arrival_date := cur_pcdi_rows.delivery_to_date;
                end if;
                vd_shipment_date := vd_arrival_date -
                                    cur_pcdi_rows.transit_days;
              end if;
            
              if cc1.qp_pricing_period_type = 'Period' then
                vd_qp_start_date := cc1.qp_period_from_date;
                vd_qp_end_date   := cc1.qp_period_to_date;
              elsif cc1.qp_pricing_period_type = 'Month' then
                vd_qp_start_date := '01-' || cc1.qp_month || '-' ||
                                    cc1.qp_year;
                vd_qp_end_date   := last_day(vd_qp_start_date);
              elsif cc1.qp_pricing_period_type = 'Date' then
                vd_qp_start_date := cc1.qp_date;
                vd_qp_end_date   := cc1.qp_date;
              elsif cc1.qp_pricing_period_type = 'Event' then
                begin
                  select dieqp.expected_qp_start_date,
                         dieqp.expected_qp_end_date
                    into vd_qp_start_date,
                         vd_qp_end_date
                    from di_del_item_exp_qp_details dieqp
                   where dieqp.pcdi_id = cur_pcdi_rows.pcdi_id
                     and dieqp.pcbpd_id = cur_not_called_off_rows.pcbpd_id
                     and dieqp.is_active = 'Y';
                exception
                  when no_data_found then
                    vd_qp_start_date := cc1.qp_period_from_date;
                    vd_qp_end_date   := cc1.qp_period_to_date;
                  when others then
                    vd_qp_start_date := cc1.qp_period_from_date;
                    vd_qp_end_date   := cc1.qp_period_to_date;
                end;
              
              else
                vd_qp_start_date := cc1.qp_period_from_date;
                vd_qp_end_date   := cc1.qp_period_to_date;
              end if;
              if cur_pcdi_rows.eod_trade_date >= vd_qp_start_date and
                 cur_pcdi_rows.eod_trade_date <= vd_qp_end_date then
                vc_period := 'During QP';
              elsif cur_pcdi_rows.eod_trade_date < vd_qp_start_date and
                    cur_pcdi_rows.eod_trade_date < vd_qp_end_date then
                vc_period := 'Before QP';
              elsif cur_pcdi_rows.eod_trade_date > vd_qp_start_date and
                    cur_pcdi_rows.eod_trade_date > vd_qp_end_date then
                vc_period := 'After QP';
              end if;
            
              if vc_period = 'Before QP' then
              
                vc_price_fixation_status := 'Un-priced';
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'Y' then
                  ---- get third wednesday of QP period
                  --  If 3rd Wednesday of QP End date is not a prompt date, get the next valid prompt date
                  vd_3rd_wed_of_qp := f_get_next_day(vd_qp_end_date,
                                                     'Wed',
                                                     3);
                  while true
                  loop
                    if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                        vd_3rd_wed_of_qp) then
                      vd_3rd_wed_of_qp := vd_3rd_wed_of_qp + 1;
                    else
                      exit;
                    end if;
                  end loop;
                  --- get 3rd wednesday  before QP period 
                  -- Get the quotation date = Trade Date +2 working Days
                  if vd_3rd_wed_of_qp <= pd_trade_date then
                    workings_days  := 0;
                    vd_quotes_date := pd_trade_date + 1;
                    while workings_days <> 2
                    loop
                      if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                          vd_quotes_date) then
                        vd_quotes_date := vd_quotes_date + 1;
                      else
                        workings_days := workings_days + 1;
                        if workings_days <> 2 then
                          vd_quotes_date := vd_quotes_date + 1;
                        end if;
                      end if;
                    end loop;
                    vd_3rd_wed_of_qp := vd_quotes_date;
                  end if;
                  --get the price dr_id   
                  begin
                    select drm.dr_id
                      into vc_before_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.prompt_date = vd_3rd_wed_of_qp
                       and drm.price_point_id is null
                       and rownum <= 1
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_conc_price',
                                                                           'PHY-002',
                                                                           'DR-ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vd_3rd_wed_of_qp,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                  end;
                end if;
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'N' and
                   cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then
                
                  vc_prompt_date  := pkg_metals_general.fn_get_next_month_prompt_date(cur_pcdi_rows.delivery_calender_id,
                                                                                      vd_qp_end_date);
                  vc_prompt_month := to_char(vc_prompt_date, 'Mon');
                  vc_prompt_year  := to_char(vc_prompt_date, 'YYYY');
                
                  ---- get the dr_id             
                  begin
                  
                    select drm.dr_id
                      into vc_before_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.period_month = vc_prompt_month
                       and drm.period_year = vc_prompt_year
                       and drm.price_point_id is null
                       and rownum <= 1
                       and drm.is_deleted = 'N';
                  
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_conc_price',
                                                                           'PHY-002',
                                                                           'DR_ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vc_prompt_month || ' ' ||
                                                                           vc_prompt_year,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                    
                  end;
                
                end if;
              
                --get the price
              
                begin
                  select dqd.price,
                         dqd.price_unit_id
                    into vn_before_qp_price,
                         vc_before_qp_price_unit_id
                    from dq_derivative_quotes        dq,
                         dqd_derivative_quote_detail dqd
                   where dq.dq_id = dqd.dq_id
                     and dqd.dr_id = vc_before_price_dr_id
                     and dq.process_id = pc_process_id
                     and dq.instrument_id = cur_pcdi_rows.instrument_id
                     and dq.process_id = dqd.process_id
                     and dqd.available_price_id =
                         cur_pcdi_rows.available_price_id
                     and dq.price_source_id = cur_pcdi_rows.price_source_id
                     and dqd.price_unit_id = cc1.price_unit_id
                     and dq.trade_date = pd_trade_date
                     and dq.is_deleted = 'N'
                     and dqd.is_deleted = 'N';
                exception
                  when no_data_found then
                    vobj_error_log.extend;
                    vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,'procedure sp_calc_contract_conc_price','PHY-002','Price missing for ' || cur_pcdi_rows.instrument_name ||',Price Source:' || cur_pcdi_rows.price_source_name ||' Contract Ref No: ' || cur_pcdi_rows.contract_ref_no ||',Price Unit:' || cc1.price_unit_name ||',' || cur_pcdi_rows.available_price_name ||' Price,Prompt Date:' || (case when cur_pcdi_rows.is_daily_cal_applicable = 'N' and cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then
                    -- vc_prompt_month || '-' || vc_prompt_year
                     to_char(vc_prompt_date, 'Mon-yyyy') else to_char(vd_3rd_wed_of_qp, 'dd-Mon-yyyy') end), '', gvc_process, pc_user_id, sysdate, pd_trade_date);
                    sp_insert_error_log(vobj_error_log);
                end;
                vn_total_quantity       := pkg_general.f_get_converted_quantity(cur_pcdi_rows.underlying_product_id,
                                                                                cur_pcdi_rows.payable_qty_unit_id,
                                                                                cur_pcdi_rows.item_qty_unit_id,
                                                                                cur_pcdi_rows.payable_qty);
                vn_qty_to_be_priced     := cur_not_called_off_rows.qty_to_be_priced;
                vn_total_contract_value := vn_total_contract_value +
                                           vn_total_quantity *
                                           (vn_qty_to_be_priced / 100) *
                                           vn_before_qp_price;
                vc_price_unit_id        := cc1.ppu_price_unit_id;
              
              elsif vc_period = 'After QP' then
                vc_price_fixation_status := 'Un-priced';
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'Y' then
                  vd_3rd_wed_of_qp := f_get_next_day(vd_qp_end_date,
                                                     'Wed',
                                                     3);
                  while true
                  loop
                    if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                        vd_3rd_wed_of_qp) then
                      vd_3rd_wed_of_qp := vd_3rd_wed_of_qp + 1;
                    else
                      exit;
                    end if;
                  end loop;
                  --- get 3rd wednesday  before QP period 
                  -- Get the quotation date = Trade Date +2 working Days
                  if vd_3rd_wed_of_qp <= pd_trade_date then
                    workings_days  := 0;
                    vd_quotes_date := pd_trade_date + 1;
                    while workings_days <> 2
                    loop
                      if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                          vd_quotes_date) then
                        vd_quotes_date := vd_quotes_date + 1;
                      else
                        workings_days := workings_days + 1;
                        if workings_days <> 2 then
                          vd_quotes_date := vd_quotes_date + 1;
                        end if;
                      end if;
                    end loop;
                    vd_3rd_wed_of_qp := vd_quotes_date;
                  end if;
                
                  --get the price dr_id   
                  begin
                    select drm.dr_id
                      into vc_after_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.prompt_date = vd_3rd_wed_of_qp
                       and drm.price_point_id is null
                       and rownum <= 1
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_conc_price',
                                                                           'PHY-002',
                                                                           'DR-ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vd_3rd_wed_of_qp,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                  end;
                end if;
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'N' and
                   cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then
                
                  vc_prompt_date  := pkg_metals_general.fn_get_next_month_prompt_date(cur_pcdi_rows.delivery_calender_id,
                                                                                      vd_qp_end_date);
                  vc_prompt_month := to_char(vc_prompt_date, 'Mon');
                  vc_prompt_year  := to_char(vc_prompt_date, 'YYYY');
                
                  ---- get the dr_id             
                  begin
                    select drm.dr_id
                      into vc_after_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.period_month = vc_prompt_month
                       and drm.period_year = vc_prompt_year
                       and drm.price_point_id is null
                       and rownum <= 1
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_conc_price',
                                                                           'PHY-002',
                                                                           'DR_ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vc_prompt_month || ' ' ||
                                                                           vc_prompt_year,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                    
                  end;
                
                end if;
              
                --get the price
              
                begin
                  select dqd.price,
                         dqd.price_unit_id
                    into vn_after_qp_price,
                         vc_after_qp_price_unit_id
                    from dq_derivative_quotes        dq,
                         dqd_derivative_quote_detail dqd
                   where dq.dq_id = dqd.dq_id
                     and dqd.dr_id = vc_after_price_dr_id
                     and dq.process_id = pc_process_id
                     and dq.instrument_id = cur_pcdi_rows.instrument_id
                     and dq.process_id = dqd.process_id
                     and dqd.available_price_id =
                         cur_pcdi_rows.available_price_id
                     and dq.price_source_id = cur_pcdi_rows.price_source_id
                     and dqd.price_unit_id = cc1.price_unit_id
                     and dq.trade_date = pd_trade_date
                     and dq.is_deleted = 'N'
                     and dqd.is_deleted = 'N';
                exception
                  when no_data_found then
                    vobj_error_log.extend;
                    vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,'procedure sp_calc_contract_conc_price','PHY-002','Price missing for ' || cur_pcdi_rows.instrument_name ||',Price Source:' || cur_pcdi_rows.price_source_name ||' Contract Ref No: ' || cur_pcdi_rows.contract_ref_no ||',Price Unit:' || cc1.price_unit_name ||',' || cur_pcdi_rows.available_price_name ||' Price,Prompt Date:' || (case when cur_pcdi_rows.is_daily_cal_applicable = 'N' and cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then
                    -- vc_prompt_month || '-' || vc_prompt_year
                     to_char(vc_prompt_date, 'Mon-yyyy') else to_char(vd_3rd_wed_of_qp, 'dd-Mon-yyyy') end), '', gvc_process, pc_user_id, sysdate, pd_trade_date);
                    sp_insert_error_log(vobj_error_log);
                end;
                vn_total_quantity       := pkg_general.f_get_converted_quantity(cur_pcdi_rows.underlying_product_id,
                                                                                cur_pcdi_rows.payable_qty_unit_id,
                                                                                cur_pcdi_rows.item_qty_unit_id,
                                                                                cur_pcdi_rows.payable_qty);
                vn_qty_to_be_priced     := cur_not_called_off_rows.qty_to_be_priced;
                vn_total_contract_value := vn_total_contract_value +
                                           vn_total_quantity *
                                           (vn_qty_to_be_priced / 100) *
                                           vn_after_qp_price;
                vc_price_unit_id        := cc1.ppu_price_unit_id;
              elsif vc_period = 'During QP' then
                vc_price_fixation_status := 'Un-priced';
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'Y' then
                  vd_3rd_wed_of_qp := f_get_next_day(vd_qp_end_date,
                                                     'Wed',
                                                     3);
                  while true
                  loop
                    if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                        vd_3rd_wed_of_qp) then
                      vd_3rd_wed_of_qp := vd_3rd_wed_of_qp + 1;
                    else
                      exit;
                    end if;
                  end loop;
                  --- get 3rd wednesday  before QP period 
                  -- Get the quotation date = Trade Date +2 working Days
                  if vd_3rd_wed_of_qp <= pd_trade_date then
                    workings_days  := 0;
                    vd_quotes_date := pd_trade_date + 1;
                    while workings_days <> 2
                    loop
                      if f_is_day_holiday(cur_pcdi_rows.instrument_id,
                                          vd_quotes_date) then
                        vd_quotes_date := vd_quotes_date + 1;
                      else
                        workings_days := workings_days + 1;
                        if workings_days <> 2 then
                          vd_quotes_date := vd_quotes_date + 1;
                        end if;
                      end if;
                    end loop;
                    vd_3rd_wed_of_qp := vd_quotes_date;
                  end if;
                
                  --get the price dr_id   
                  begin
                    select drm.dr_id
                      into vc_during_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.prompt_date = vd_3rd_wed_of_qp
                       and drm.price_point_id is null
                       and rownum <= 1
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_conc_price',
                                                                           'PHY-002',
                                                                           'DR-ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vd_3rd_wed_of_qp,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                  end;
                end if;
              
                if cur_pcdi_rows.is_daily_cal_applicable = 'N' and
                   cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then
                
                  vc_prompt_date  := pkg_metals_general.fn_get_next_month_prompt_date(cur_pcdi_rows.delivery_calender_id,
                                                                                      vd_qp_end_date);
                  vc_prompt_month := to_char(vc_prompt_date, 'Mon');
                  vc_prompt_year  := to_char(vc_prompt_date, 'YYYY');
                
                  ---- get the dr_id             
                  begin
                    select drm.dr_id
                      into vc_during_price_dr_id
                      from drm_derivative_master drm
                     where drm.instrument_id = cur_pcdi_rows.instrument_id
                       and drm.period_month = vc_prompt_month
                       and drm.period_year = vc_prompt_year
                       and drm.price_point_id is null
                       and rownum <= 1
                       and drm.is_deleted = 'N';
                  exception
                    when no_data_found then
                      vobj_error_log.extend;
                      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                           'procedure sp_calc_contract_conc_price',
                                                                           'PHY-002',
                                                                           'DR_ID missing for ' ||
                                                                           cur_pcdi_rows.instrument_name ||
                                                                           ',Price Source:' ||
                                                                           cur_pcdi_rows.price_source_name ||
                                                                           ' Contract Ref No: ' ||
                                                                           cur_pcdi_rows.contract_ref_no ||
                                                                           ',Price Unit:' ||
                                                                           cur_pcdi_rows.price_unit_name || ',' ||
                                                                           cur_pcdi_rows.available_price_name ||
                                                                           ' Price,Prompt Date:' ||
                                                                           vc_prompt_month || ' ' ||
                                                                           vc_prompt_year,
                                                                           '',
                                                                           gvc_process,
                                                                           pc_user_id,
                                                                           sysdate,
                                                                           pd_trade_date);
                      sp_insert_error_log(vobj_error_log);
                    
                  end;
                
                end if;
              
                --get the price
              
                begin
                  select dqd.price,
                         dqd.price_unit_id
                    into vn_during_qp_price,
                         vc_during_qp_price_unit_id
                    from dq_derivative_quotes        dq,
                         dqd_derivative_quote_detail dqd
                   where dq.dq_id = dqd.dq_id
                     and dqd.dr_id = vc_during_price_dr_id
                     and dq.process_id = pc_process_id
                     and dq.instrument_id = cur_pcdi_rows.instrument_id
                     and dq.process_id = dqd.process_id
                     and dqd.available_price_id =
                         cur_pcdi_rows.available_price_id
                     and dq.price_source_id = cur_pcdi_rows.price_source_id
                     and dqd.price_unit_id = cc1.price_unit_id
                     and dq.trade_date = pd_trade_date
                     and dq.is_deleted = 'N'
                     and dqd.is_deleted = 'N';
                exception
                  when no_data_found then
                    vobj_error_log.extend;
                    vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,'procedure sp_calc_contract_conc_price','PHY-002','Price missing for ' || cur_pcdi_rows.instrument_name ||',Price Source:' || cur_pcdi_rows.price_source_name ||' Contract Ref No: ' || cur_pcdi_rows.contract_ref_no ||',Price Unit:' || cc1.price_unit_name ||',' || cur_pcdi_rows.available_price_name ||' Price,Prompt Date:' || (case when cur_pcdi_rows.is_daily_cal_applicable = 'N' and cur_pcdi_rows.is_monthly_cal_applicable = 'Y' then
                    --- vc_prompt_month || '-' || vc_prompt_year
                     to_char(vc_prompt_date, 'Mon-yyyy') else to_char(vd_3rd_wed_of_qp, 'dd-Mon-yyyy') end), '', gvc_process, pc_user_id, sysdate, pd_trade_date);
                    sp_insert_error_log(vobj_error_log);
                end;
                vn_total_quantity       := pkg_general.f_get_converted_quantity(cur_pcdi_rows.underlying_product_id,
                                                                                cur_pcdi_rows.payable_qty_unit_id,
                                                                                cur_pcdi_rows.item_qty_unit_id,
                                                                                cur_pcdi_rows.payable_qty);
                vn_qty_to_be_priced     := cur_not_called_off_rows.qty_to_be_priced;
                vn_total_contract_value := vn_total_contract_value +
                                           vn_total_quantity *
                                           (vn_qty_to_be_priced / 100) *
                                           vn_during_qp_price;
                vc_price_unit_id        := cc1.ppu_price_unit_id;
              
              end if;
            end loop;
          end if;
        end loop;
        vn_avarage_price := round(vn_total_contract_value /
                                  vn_total_quantity,
                                  3);
      
      end if;
    
      begin
        select cm.cur_id,
               cm.cur_code,
               ppu.weight,
               ppu.weight_unit_id,
               qum.qty_unit
          into vc_price_cur_id,
               vc_price_cur_code,
               vc_price_weight_unit,
               vc_price_weight_unit_id,
               vc_price_qty_unit
          from v_ppu_pum                ppu,
               cm_currency_master       cm,
               qum_quantity_unit_master qum
         where ppu.product_price_unit_id = vc_price_unit_id
           and ppu.cur_id = cm.cur_id
           and qum.qty_unit_id = ppu.weight_unit_id;
      
        pkg_general.sp_get_base_cur_detail(vc_price_cur_id,
                                           vc_contract_main_cur_id,
                                           vc_contract_main_cur_code,
                                           vn_contract_main_cur_factor);
      
      exception
        when no_data_found then
          vc_price_cur_id         := null;
          vc_price_cur_code       := null;
          vc_price_weight_unit    := null;
          vc_price_weight_unit_id := null;
          vc_price_qty_unit       := null;
      end;
    
      vc_base_main_cur_id   := cur_pcdi_rows.base_cur_id;
      vc_base_main_cur_code := cur_pcdi_rows.base_currency_name;
    
      if cur_pcdi_rows.payment_due_date is null then
        vd_payment_due_date := pd_trade_date;
      else
        vd_payment_due_date := cur_pcdi_rows.payment_due_date;
      end if;
    
      pkg_general.sp_forward_cur_exchange_rate(pc_corporate_id,
                                               pd_trade_date,
                                               vd_payment_due_date,
                                               vc_contract_main_cur_id,
                                               vc_base_main_cur_id,
                                               vn_settlement_price,
                                               vn_forward_points);
    
      if vc_contract_main_cur_id <> vc_base_main_cur_id then
        if vn_settlement_price is null or vn_settlement_price = 0 then
          vobj_error_log.extend;
          vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                               'procedure pkg_phy_physical_process contract price',
                                                               'PHY-005',
                                                               vc_base_main_cur_code ||
                                                               ' to ' ||
                                                               vc_contract_main_cur_code || ' (' ||
                                                               to_char(vd_payment_due_date,
                                                                       'dd-Mon-yyyy') || ') ',
                                                               '',
                                                               gvc_process,
                                                               pc_user_id,
                                                               sysdate,
                                                               pd_trade_date);
          sp_insert_error_log(vobj_error_log);
        
        end if;
      end if;
    
      insert into cipde_cipd_element_price
        (corporate_id,
         process_id,
         pcdi_id,
         internal_contract_item_ref_no,
         internal_contract_ref_no,
         contract_ref_no,
         delivery_item_no,
         element_id,
         assay_qty,
         assay_qty_unit_id,
         payable_qty,
         payable_qty_unit_id,
         contract_price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         price_unit_weight,
         price_unit_weight_unit_id,
         price_unit_weight_unit,
         fixed_qty,
         unfixed_qty,
         price_basis,
         price_fixation_status,
         price_fixation_details,
         payment_due_date,
         contract_base_price_unit_id,
         contract_to_base_fx_rate,
         price_description,
         refining_charge,
         treatment_charge,
         penalty_charge,
         cur_id,
         cur_code,
         qp_period_from_date,
         qp_period_to_date,
         instrument_id)
      values
        (pc_corporate_id,
         pc_process_id,
         cur_pcdi_rows.pcdi_id,
         cur_pcdi_rows.internal_contract_item_ref_no,
         cur_pcdi_rows.internal_contract_ref_no,
         cur_pcdi_rows.contract_ref_no,
         cur_pcdi_rows.delivery_item_no,
         cur_pcdi_rows.element_id,
         cur_pcdi_rows.assay_qty,
         cur_pcdi_rows.assay_qty_unit_id,
         cur_pcdi_rows.payable_qty,
         cur_pcdi_rows.payable_qty_unit_id,
         vn_avarage_price,
         vc_price_unit_id,
         vc_price_cur_id,
         vc_price_cur_code,
         vc_price_weight_unit,
         vc_price_weight_unit_id,
         vc_price_qty_unit,
         null,
         null,
         vc_price_basis,
         vc_price_fixation_status,
         'Not Applicable',
         cur_pcdi_rows.payment_due_date,
         vn_contract_base_price_unit_id,
         vn_settlement_price,
         vc_price_description,
         null,
         null,
         null,
         null,
         null,
         vd_qp_start_date,
         vd_qp_end_date,
         cur_pcdi_rows.instrument_id);
    
    end loop;
    commit;
    --Checking for the treatment  is there or not
    --For this  we are calling the sp_get_treatment_charge
    /*  for cc1 in (select tmpc.internal_contract_item_ref_no,
                         tmpc.conc_product_id,
                         tmpc.conc_quality_id,
                         tmpc.element_id,
                                       tmpc.product_id,
                                       tmpc.quality_id,
                                       pc_process_id,
                                       pci.item_qty,
                                       pci.item_qty_unit_id,
                                       vn_cp_price,
                                       vc_cp_price_unit_id
                                        from tmpc_temp_m2m_pre_check tmpc,
                                                  pci_physical_contract_item    pci
                                                  where  pci.internal_contract_item_ref_no=
                                                  tmpc.internal_contract_item_ref_no
                                                  and tmpc.product_type='CONCENTRATES' ) loop      
      sp_get_treatment_charge(cc1.internal_contract_item_ref_no,
                                                             cc1.element_id,
                                                             pc_process_id,
                                                             cc1.item_qty,
                                                             cc1.item_qty_unit_id,
                                                             cc1.vn_cp_price,
                                                             cc1.vc_cp_price_unit_id,
                                                             vn_total_tc_charge,
                                                             vc_tc_cur_id);
                                                             
      --if  vn_total_tc_charge  is zero or null we have to raise the exception
      --else 
      if nvl(vn_total_tc_charge,0)<>0   then
         update md_m2m_daily md
         set md.treatment_charge=vn_total_tc_charge
         where md.corporate_id =pc_corporate_id
           and md.product_type='CONCENTRATES'
           and md.conc_product_id=cc1.conc_product_id
           and md.conc_quality_id=cc1.conc_quality_id
           and md.product_id=cc1.product_id
           and md.quality_id=cc1.quality_id
           and md.element_id=cc1.element_id
           and md.process_id=pc_process_id;
          end if;
    end loop;
    
    --Check theRefine Charege is there or not
    --If Refine charge  is  there we will update the md table
    --for this we are calling the sp_get_refine_chage
    for cc_rc  in (select tmpc.internal_contract_item_ref_no,
                                       tmpc.conc_product_id,
                                       tmpc.conc_quality_id,
                                       tmpc.element_id,
                                       tmpc.product_id,
                                       tmpc.quality_id,
                                       pc_process_id,
                                       pci.item_qty,
                                       pci.item_qty_unit_id,
                                       vn_cp_price,
                                       vc_cp_price_unit_id
                                        from tmpc_temp_m2m_pre_check tmpc,
                                                  pci_physical_contract_item    pci
                                                  where  pci.internal_contract_item_ref_no=
                                                  tmpc.internal_contract_item_ref_no
                                                  and tmpc.product_type='CONCENTRATES' ) loop      
      sp_get_refine_charge( cc_rc.internal_contract_item_ref_no,
                                                              cc_rc.element_id,
                                                             pc_process_id,
                                                              cc_rc.item_qty,
                                                              cc_rc.item_qty_unit_id,
                                                              cc_rc.vn_cp_price,
                                                              cc_rc.vc_cp_price_unit_id,
                                                             vn_total_rc_charge,
                                                             vc_tc_cur_id);
                                                             
      --if  vn_total_tc_charge  is zero or null we have to raise the exception
      --else we have to update the md table
      if nvl(vn_total_rc_charge,0)<>0   then
         update md_m2m_daily md
         set md.refine_charge=vn_total_rc_charge
         where md.corporate_id =pc_corporate_id
           and md.product_type='CONCENTRATES'
           and md.conc_product_id= cc_rc.conc_product_id
           and md.conc_quality_id= cc_rc.conc_quality_id
           and md.product_id= cc_rc.product_id
           and md.quality_id= cc_rc.quality_id
           and md.element_id= cc_rc.element_id
           and md.process_id=pc_process_id;
          end if;
    end loop;
    --calling the sp_get_penalty_charge
    for cc_pc  in (select tmpc.internal_contract_item_ref_no,
                                       tmpc.conc_product_id,
                                       tmpc.conc_quality_id,
                                       tmpc.element_id,
                                       tmpc.product_id,
                                       tmpc.quality_id,
                                       pc_process_id,
                                       pci.item_qty,
                                       pci.item_qty_unit_id,
                                       vn_cp_price,
                                       vc_cp_price_unit_id
                                        from tmpc_temp_m2m_pre_check tmpc,
                                                  pci_physical_contract_item    pci
                                                  where  pci.internal_contract_item_ref_no=
                                                  tmpc.internal_contract_item_ref_no
                                                  and tmpc.product_type='CONCENTRATES' ) loop  
      sp_get_penalty_charge( cc_pc.internal_contract_item_ref_no,
                                                         cc_pc.element_id,
                                                         pc_process_id,
                                                         cc_pc.item_qty,
                                                         cc_pc.item_qty_unit_id,
                                                         vn_total_pc_charge,
                                                         vc_pc_cur_id);
                                                             
      --if  vn_total_pc_charge  is zero or null we have to raise the exception
      --else we have to update the md table
      if nvl(vn_total_pc_charge,0)<> 0   then
         update md_m2m_daily md
         set md.penalty_charge=vn_total_pc_charge
         where md.corporate_id =pc_corporate_id
           and md.product_type='CONCENTRATES'
           and md.conc_product_id= cc_pc.conc_product_id
           and md.conc_quality_id= cc_pc.conc_quality_id
           and md.product_id= cc_pc.product_id
           and md.quality_id= cc_pc.quality_id
           and md.element_id= cc_pc.element_id
           and md.process_id=pc_process_id;
          end if;
    end loop;*/
  
  end;
  procedure sp_calc_stock_price(pc_process_id varchar2) is
  
    cursor cur_price is
      select *
        from (select scm.internal_grd_ref_no          internal_grd_ref_no,
                     cigc.int_contract_item_ref_no    int_contract_item_ref_no,
                     scm.transformation_ratio         transformation_ratio,
                     cipd.price_in_base_price_unit_id contract_price,
                     cipd.contract_base_price_unit_id price_unit_id,
                     grd.qty                          stock_qty
                from scm_stock_cost_mapping         scm,
                     cigc_contract_item_gmr_cost    cigc,
                     cipd_contract_item_price_daily cipd,
                     grd_goods_record_detail        grd,
                     cs_cost_store                  cs,
                     scm_service_charge_master      scm_master
               where scm.cog_ref_no = cigc.cog_ref_no
                 and cigc.process_id = pc_process_id
                 and scm.is_deleted = 'N'
                 and cigc.is_deleted = 'N'
                 and cigc.int_contract_item_ref_no is not null
                 and scm.internal_grd_ref_no is not null
                 and cipd.internal_contract_item_ref_no =
                     cigc.int_contract_item_ref_no
                 and cipd.process_id = pc_process_id
                 and grd.internal_grd_ref_no = scm.internal_grd_ref_no
                 and grd.process_id = cigc.process_id
                 and cs.cog_ref_no = cigc.cog_ref_no
                 and cs.cost_component_id = scm_master.cost_id
                 and scm_master.cost_component_name = 'Material Cost'
                 and scm_master.cost_type = 'DIRECT_COST'
                 and cs.process_id = pc_process_id
                 and nvl(grd.inventory_status, 'NA') = 'In'
              union all
              select grd.internal_grd_ref_no           internal_grd_ref_no,
                     grd.internal_contract_item_ref_no int_contract_item_ref_no,
                     1                                 transformation_ratio,
                     cipd.price_in_base_price_unit_id  contract_price,
                     cipd.contract_base_price_unit_id  price_unit_id,
                     grd.qty                           stock_qty
                from grd_goods_record_detail        grd,
                     cipd_contract_item_price_daily cipd
               where grd.internal_contract_item_ref_no =
                     cipd.internal_contract_item_ref_no
                 and grd.process_id = pc_process_id
                 and cipd.process_id = grd.process_id
                 and nvl(grd.inventory_status, 'NA') = 'NA'
                 and grd.is_deleted = 'N'
                 and grd.status = 'Active'
              union all
              select scm.internal_dgrd_ref_no,
                     cigc.int_contract_item_ref_no,
                     scm.transformation_ratio,
                     cipd.price_in_base_price_unit_id contract_price,
                     cipd.contract_base_price_unit_id price_unit_id,
                     dgrd.net_weight stock_qty
                from scm_stock_cost_mapping         scm,
                     cigc_contract_item_gmr_cost    cigc,
                     cipd_contract_item_price_daily cipd,
                     dgrd_delivered_grd             dgrd,
                     cs_cost_store                  cs,
                     scm_service_charge_master      scm_master
               where scm.cog_ref_no = cigc.cog_ref_no
                 and cigc.process_id = pc_process_id
                 and scm.is_deleted = 'N'
                 and cigc.is_deleted = 'N'
                 and cipd.internal_contract_item_ref_no =
                     cigc.int_contract_item_ref_no
                 and cipd.process_id = pc_process_id
                 and dgrd.internal_dgrd_ref_no = scm.internal_dgrd_ref_no
                 and dgrd.process_id = pc_process_id
                 and cs.cog_ref_no = cigc.cog_ref_no
                 and cs.cost_component_id = scm_master.cost_id
                 and scm_master.cost_component_name = 'Material Cost'
                 and scm_master.cost_type = 'DIRECT_COST'
                 and cs.process_id = pc_process_id
                 and nvl(dgrd.inventory_status, 'NA') = 'Out'
              union all
              select dgrd.internal_dgrd_ref_no          internal_grd_ref_no,
                     cipd.internal_contract_item_ref_no int_contract_item_ref_no,
                     1                                  transformation_ratio,
                     cipd.price_in_base_price_unit_id   contract_price,
                     cipd.contract_base_price_unit_id   price_unit_id,
                     dgrd.net_weight                    stock_qty
                from dgrd_delivered_grd             dgrd,
                     cipd_contract_item_price_daily cipd
               where dgrd.internal_contract_item_ref_no =
                     cipd.internal_contract_item_ref_no
                 and dgrd.process_id = pc_process_id
                 and cipd.process_id = dgrd.process_id
                 and nvl(dgrd.inventory_status, 'NA') in ('NA', 'None')
                 and dgrd.status = 'Active'
              
              )
       order by internal_grd_ref_no;
  
    vc_is_data_to_populate       varchar2(1) := 'N'; -- Represents that there was arleast one record which needed price calculation, Only required when there are zero stocks in the system
    vc_current_grd_dgrd_ref_no   varchar2(15);
    vc_previous_grd_dgrd_ref_no  varchar2(15);
    vn_item_mc                   number := 0;
    vn_total_mc                  number;
    vn_avg_mc                    number := 0;
    vn_item_qty                  number;
    vn_total_item_qty            number := 0;
    vc_price_unit_id             varchar2(15);
    vc_price_unit_cur_id         varchar2(15);
    vc_price_unit_cur_code       varchar2(15);
    vc_price_unit_weight_unit_id varchar2(15);
    vc_price_unit_weight_unit    varchar2(15);
    vn_price_unit_weight         number;
  begin
    for cur_price_rows in cur_price
    loop
      vc_is_data_to_populate := 'Y';
      if cur_price_rows.internal_grd_ref_no <> vc_current_grd_dgrd_ref_no or
         vc_current_grd_dgrd_ref_no is null then
        vc_current_grd_dgrd_ref_no := cur_price_rows.internal_grd_ref_no;
        vc_price_unit_id           := cur_price_rows.price_unit_id;
      
        select cm.cur_id,
               cm.cur_code,
               qum.qty_unit_id,
               qum.qty_unit,
               pum.weight
          into vc_price_unit_cur_id,
               vc_price_unit_cur_code,
               vc_price_unit_weight_unit_id,
               vc_price_unit_weight_unit,
               vn_price_unit_weight
          from ppu_product_price_units  ppu,
               cm_currency_master       cm,
               qum_quantity_unit_master qum,
               pum_price_unit_master    pum
         where ppu.internal_price_unit_id = vc_price_unit_id
           and ppu.price_unit_id = pum.price_unit_id
           and pum.is_active = 'Y'
           and pum.is_deleted = 'N'
           and pum.cur_id = cm.cur_id
           and pum.weight_unit_id = qum.qty_unit_id;
      
      end if;
      vn_item_qty := cur_price_rows.stock_qty;
      vn_item_mc  := cur_price_rows.contract_price * vn_item_qty *
                     cur_price_rows.transformation_ratio;
      --
      -- Calculate the Price for the Previous GRD Since the GRD has changed
      --
      if vc_current_grd_dgrd_ref_no <> vc_previous_grd_dgrd_ref_no then
        --
        -- Calculate the Average Materail Cost
        --
        vn_avg_mc := vn_total_mc / vn_total_item_qty;
        insert into spd_stock_price_daily
          (process_id,
           internal_drg_dgrd_ref_no,
           stock_price,
           price_unit_id,
           price_unit_cur_id,
           price_unit_cur_code,
           price_unit_weight_unit_id,
           price_unit_weight_unit,
           price_unit_weight)
        values
          (pc_process_id,
           vc_previous_grd_dgrd_ref_no,
           vn_avg_mc,
           vc_price_unit_id,
           vc_price_unit_cur_id,
           vc_price_unit_cur_code,
           vc_price_unit_weight_unit_id,
           vc_price_unit_weight_unit,
           vn_price_unit_weight);
        --
        -- New Stock came, Renitialize the Price and Qty
        --
        vn_total_mc       := vn_item_mc;
        vn_total_item_qty := vn_item_qty;
      else
        --
        -- Old Stock with Different Item Or First Stock in the query
        --
        if vn_total_mc is null then
          -- First Stock in the query
          vn_total_mc       := vn_item_mc;
          vn_total_item_qty := vn_item_qty;
        else
          -- Old Stock with Different Item
          vn_total_mc       := vn_total_mc + vn_item_mc;
          vn_total_item_qty := vn_total_item_qty + vn_item_qty;
        end if;
      end if;
      vc_previous_grd_dgrd_ref_no := cur_price_rows.internal_grd_ref_no;
    end loop;
    --
    -- Need to insert data for the last record outside of the loop
    -- 
    if vc_is_data_to_populate = 'Y' then
      vn_avg_mc := vn_total_mc / vn_total_item_qty;
      insert into spd_stock_price_daily
        (process_id,
         internal_drg_dgrd_ref_no,
         stock_price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         price_unit_weight_unit_id,
         price_unit_weight_unit,
         price_unit_weight)
      values
        (pc_process_id,
         vc_previous_grd_dgrd_ref_no,
         vn_avg_mc,
         vc_price_unit_id,
         vc_price_unit_cur_id,
         vc_price_unit_cur_code,
         vc_price_unit_weight_unit_id,
         vc_price_unit_weight_unit,
         vn_price_unit_weight);
    end if;
  end;
  procedure sp_mark_process_id(pc_corporate_id varchar2,
                               pc_process_id   varchar2,
                               pc_user_id      varchar2,
                               pd_trade_date   date
                               --------------------------------------------------------------------------------------------------
                               --  procedure name                            : sp_mark_process_id
                               --  author                                    : siva
                               --  created date                              : 20th jan 2009
                               --  purpose                                   : to mark the eod refernce numbers
                               --
                               --  parameters
                               --  pc_corporate_id                           : corporate id
                               --  pd_trade_date                             : trade date
                               --  pc_process_id                             : eod reference no
                               --
                               --  modification history
                               --  modified date                             :
                               --  modified by                               :
                               --  modify description                        :
                               --------------------------------------------------------------------------------------------------
                               ) is
    vobj_error_log     tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count number := 1;
    vc_dbd_id          varchar2(15);
    vc_prev_process_id varchar2(15);
    prev_trade_date    date;
    vc_err_msg         varchar2(100);
  begin
    -- get the dump id
  
    vc_err_msg := 'Before select vc_dbd_id';
    select max(dbd.dbd_id)
      into vc_dbd_id
      from dbd_database_dump dbd
     where dbd.corporate_id = pc_corporate_id
       and dbd.process = gvc_process
       and dbd.trade_date = pd_trade_date;
  
    vc_err_msg := 'Before select vc_prev_process_id';
    select max(tdc.process_id)
      into vc_prev_process_id
      from tdc_trade_date_closure tdc
     where tdc.corporate_id = pc_corporate_id
       and tdc.process = gvc_process
       and tdc.trade_date < pd_trade_date;
  
    vc_err_msg := 'Before select prev_trade_date';
    select tdc.trade_date
      into prev_trade_date
      from tdc_trade_date_closure tdc
     where tdc.corporate_id = pc_corporate_id
       and tdc.process_id = vc_prev_process_id;
  
    update agd_alloc_group_detail
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update agh_alloc_group_header
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update cigc_contract_item_gmr_cost
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update cs_cost_store
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update dgrd_delivered_grd
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update gmr_goods_movement_record
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update mogrd_moved_out_grd
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcad_pc_agency_detail
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcbpd_pc_base_price_detail
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcbph_pc_base_price_header
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcdb_pc_delivery_basis
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcdd_document_details
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcdiob_di_optional_basis
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcdipe_di_pricing_elements
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcdiqd_di_quality_details
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcdi_pc_delivery_item
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcipf_pci_pricing_formula
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pci_physical_contract_item
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcjv_pc_jv_detail
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcm_physical_contract_main
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcpdqd_pd_quality_details
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcpd_pc_product_definition
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcpq_pc_product_quality
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcqpd_pc_qual_premium_discount
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pffxd_phy_formula_fx_details
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pfqpp_phy_formula_qp_pricing
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update ppfd_phy_price_formula_details
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update ppfh_phy_price_formula_header
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update ciqs_contract_item_qty_status
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update diqs_delivery_item_qty_status
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update cqs_contract_qty_status
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update grd_goods_record_detail
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update vd_voyage_detail
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update invm_inventory_master
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcpch_pc_payble_content_header
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pqd_payable_quality_details
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcepc_pc_elem_payable_content
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcth_pc_treatment_header
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update ted_treatment_element_details
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update tqd_treatment_quality_details
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
    update tqd_treatment_quality_details
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcetc_pc_elem_treatment_charge
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcar_pc_assaying_rules
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcaesl_assay_elem_split_limits
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update arqd_assay_quality_details
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcaph_pc_attr_penalty_header
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcap_pc_attribute_penalty
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pqd_penalty_quality_details
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pad_penalty_attribute_details
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcrh_pc_refining_header
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update rqd_refining_quality_details
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update red_refining_element_details
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update pcerc_pc_elem_refining_charge
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update ceqs_contract_ele_qty_status
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update dith_di_treatment_header
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update dirh_di_refining_header
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update diph_di_penalty_header
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update cipq_contract_item_payable_qty
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update dipq_delivery_item_payable_qty
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update spq_stock_payable_qty
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update dipch_di_payablecontent_header
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    update is_invoice_summary
       set process_id = pc_process_id
     where process_id is null
       and dbd_id = vc_dbd_id;
  
    --
    -- 1. AGH was not present in previous eod and became inventory out in this eod
    --
    update agh_alloc_group_header agh
       set agh.today_status = 'Realized Today'
     where trim(agh.realized_status) = 'Realized'
       and agh.process_id = pc_process_id
       and agh.is_deleted = 'N'
       and agh.int_alloc_group_id not in
           (select agh_prev.int_alloc_group_id
              from agh_alloc_group_header agh_prev
             where trim(agh_prev.realized_status) = 'Realized'
               and agh_prev.process_id = gvc_previous_process_id
               and agh_prev.is_deleted = 'N');
    --
    -- 2. AGH was present in previous eod and became inventory out in this eod
    --
    update agh_alloc_group_header agh
       set agh.today_status = 'Realized Today'
     where trim(agh.realized_status) = 'Realized'
       and agh.process_id = pc_process_id
       and agh.is_deleted = 'N'
       and agh.int_alloc_group_id in
           (select agh_prev.int_alloc_group_id
              from agh_alloc_group_header agh_prev
             where trim(agh_prev.realized_status) <> 'Realized'
               and agh_prev.process_id = gvc_previous_process_id
               and agh_prev.is_deleted = 'N');
    --
    -- For Realized PNL Change update below tables for PROCESS_ID 
    --               
    update grdl_goods_record_detail_log grdl
       set grdl.process_id = pc_process_id
     where grdl.process_id is null
       and (grdl.internal_action_ref_no) in
           (select axs.internal_action_ref_no
              from axs_action_summary axs
             where axs.internal_action_ref_no = grdl.internal_action_ref_no
               and axs.eff_date <= pd_trade_date
               and axs.corporate_id = pc_corporate_id)
       and grdl.dbd_id in
           (select dbd.dbd_id
              from dbd_database_dump dbd
             where dbd.corporate_id = pc_corporate_id
               and dbd.process = gvc_process
               and dbd.trade_date <= pd_trade_date);
  
    update dgrdul_delivered_grd_ul dgrdul
       set dgrdul.process_id = pc_process_id
     where dgrdul.process_id is null
       and (dgrdul.internal_action_ref_no) in
           (select axs.internal_action_ref_no
              from axs_action_summary axs
             where axs.internal_action_ref_no =
                   dgrdul.internal_action_ref_no
               and axs.eff_date <= pd_trade_date
               and axs.corporate_id = pc_corporate_id)
       and dgrdul.dbd_id in
           (select dbd.dbd_id
              from dbd_database_dump dbd
             where dbd.corporate_id = pc_corporate_id
               and dbd.process = gvc_process
               and dbd.trade_date <= pd_trade_date);
  
    update cdl_cost_delta_log cdl
       set cdl.process_id = pc_process_id
     where cdl.process_id is null
       and (cdl.internal_action_ref_no) in
           (select axs.internal_action_ref_no
              from axs_action_summary axs
             where axs.internal_action_ref_no = cdl.internal_action_ref_no
               and axs.eff_date <= pd_trade_date
               and axs.corporate_id = pc_corporate_id)
       and cdl.dbd_id in
           (select dbd.dbd_id
              from dbd_database_dump dbd
             where dbd.corporate_id = pc_corporate_id
               and dbd.process = gvc_process
               and dbd.trade_date <= pd_trade_date);
  
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure pkg_phy_physical_process sp_mark_process_id',
                                                           'M2M-013',
                                                           'Code:' ||
                                                           sqlcode ||
                                                           'Message:' ||
                                                           sqlerrm || ' ' ||
                                                           vc_err_msg,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;

  procedure sp_calc_secondary_cost(pc_corporate_id varchar2,
                                   pc_process_id   varchar2,
                                   pc_user_id      varchar2,
                                   pd_trade_date   date) is
    -----------------------------------------------------------------------------------------------------------
    --        procedure name                            : sp_calc_secondary_cost
    --        author                                    :
    --        created date                              : 11th Jan 2011
    --        purpose                                   : populate secondary costs for contracts and gmrs
    --
    --        parameters
    --        pc_corporate_id                           : corporate id
    --        pc_process_id                             : eod reference no
    --
    --        modification history
    --        modified date                             :
    --        modified by                               :
    --        modify description                        :
    --------------------------------------------------------------------------------------------------------------
    vobj_error_log           tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count       number := 1;
    vn_trans_to_base_fw_rate number;
    vn_forward_points        number;
    vn_qty_factor            number;
  begin
    --
    -- Update PUM ID for Rate Type
    -- Not doing with PPU because I don't know the product at this point
    --
    update cs_cost_store cs
       set cs.transaction_price_unit_id = (select ppu.price_unit_id
                                             from v_ppu_pum             ppu,
                                                  pum_price_unit_master pum
                                            where ppu.product_price_unit_id =
                                                  cs.rate_price_unit_id
                                              and ppu.price_unit_id =
                                                  pum.price_unit_id)
     where cs.process_id = pc_process_id
       and cs.rate_type = 'Rate';
    --
    -- Update PUM ID for Absolute Type
    -- Currency from CS and Unit from CIGC
    -- 
    for cc1 in (select cs.internal_cost_id,
                       cog.cog_ref_no,
                       cog.qty,
                       cog.qty_unit_id,
                       cs.transaction_amt,
                       cs.transaction_amt_cur_id,
                       pum.price_unit_id,
                       cs.rate_type,
                       round(cs.transaction_amt / cog.qty, 10) transaction_cost,
                       round(cs.cost_value / cog.qty, 10) cost_value
                  from cigc_contract_item_gmr_cost cog,
                       cs_cost_store               cs,
                       pum_price_unit_master       pum
                 where cog.process_id = pc_process_id
                   and cs.process_id = cog.process_id
                   and cog.cog_ref_no = cs.cog_ref_no
                   and cog.qty_unit_id = pum.weight_unit_id
                   and cs.transaction_amt_cur_id = pum.cur_id
                   and cs.rate_type = 'Absolute'
                   and nvl(pum.weight, 1) = 1
                   and pum.is_active = 'Y'
                   and pum.is_deleted = 'N')
    loop
      update cs_cost_store css
         set css.cost_value                = cc1.cost_value,
             css.transaction_price_unit_id = cc1.price_unit_id
       where css.internal_cost_id = cc1.internal_cost_id;
    
    end loop;
  
    insert into cisc_contract_item_sec_cost
      (internal_contract_item_ref_no,
       cost_component_id,
       avg_cost,
       process_id,
       secondary_cost,
       avg_cost_in_trn_cur,
       avg_cost_price_unit_id,
       payment_due_date,
       product_id,
       corporate_id,
       transact_price_unit_id,
       transact_qty_unit_id,
       transact_cur_id,
       transact_main_cur_id,
       currency_factor,
       base_cur_id,
       base_qty_unit_id,
       base_price_unit_id,
       cost_value,
       price_qty_unit_id)
      select pci.internal_contract_item_ref_no,
             cs.cost_component_id,
             cs.cost_in_base_price_unit_id,
             pc_process_id,
             cs.cost_value secondary_cost,
             cs.cost_in_transact_price_unit_id,
             cs.transaction_price_unit_id,
             case
               when nvl(cs.est_payment_due_date, pd_trade_date) >
                    pd_trade_date then
                pd_trade_date
               else
                nvl(cs.est_payment_due_date, pd_trade_date)
             end,
             pcpd.product_id,
             pcm.corporate_id,
             cs.transaction_price_unit_id,
             cigc.qty_unit_id,
             cs.transaction_amt_cur_id,
             nvl(scd.cur_id, cs.transaction_amt_cur_id),
             nvl(scd.factor, 1),
             akc.base_cur_id,
             pdm.base_quantity_unit,
             pum_base.price_unit_id,
             cs.cost_value,
             pum_trans.weight_unit_id
        from cs_cost_store               cs,
             cigc_contract_item_gmr_cost cigc,
             pcdi_pc_delivery_item       pcdi,
             pci_physical_contract_item  pci,
             pcm_physical_contract_main  pcm,
             scm_service_charge_master   scm,
             pcpq_pc_product_quality     pcpq,
             pcpd_pc_product_definition  pcpd,
             ak_corporate                akc,
             pdm_productmaster           pdm,
             scd_sub_currency_detail     scd,
             pum_price_unit_master       pum_base,
             pum_price_unit_master       pum_trans
       where pcm.internal_contract_ref_no = pcdi.internal_contract_ref_no
         and pcdi.pcdi_id = pci.pcdi_id
         and pci.internal_contract_item_ref_no =
             cigc.int_contract_item_ref_no
         and cigc.cog_ref_no = cs.cog_ref_no
         and pcm.is_active = 'Y'
         and pci.is_active = 'Y'
         and pcdi.is_active = 'Y'
         and cigc.is_deleted = 'N'
         and cs.is_deleted = 'N'
         and pcm.contract_status = 'In Position'
         and pcm.process_id = pc_process_id
         and pci.process_id = pc_process_id
         and pcdi.process_id = pc_process_id
         and cigc.process_id = pc_process_id
         and cs.process_id = pc_process_id
         and cs.cost_component_id = scm.cost_id
         and scm.cost_type = 'SECONDARY_COST'
         and cs.cost_type = 'Estimate'
         and pci.pcpq_id = pcpq.pcpq_id
         and pcpq.pcpd_id = pcpd.pcpd_id
         and pcpq.process_id = pcpd.process_id
         and pcm.corporate_id = akc.corporate_id
         and pcpd.product_id = pdm.product_id
         and cs.transaction_amt_cur_id = scd.sub_cur_id(+)
         and pum_base.weight_unit_id = pdm.base_quantity_unit
         and pum_base.cur_id = akc.base_cur_id
         and pum_trans.price_unit_id = cs.transaction_price_unit_id
         and pcpd.process_id = pc_process_id;
  
    --
    -- Check the exchange rate from Transaction Currency to Base Currency
    --
    for cur_cisc in (select cisc.transact_main_cur_id,
                            cisc.base_cur_id,
                            cisc.payment_due_date,
                            cm_tran.cur_code transact_main_cur_code,
                            cm_base.cur_code base_cur_code
                       from cisc_contract_item_sec_cost cisc,
                            cm_currency_master          cm_tran,
                            cm_currency_master          cm_base
                      where cisc.process_id = pc_process_id
                        and cisc.transact_main_cur_id <> cisc.base_cur_id
                        and cisc.transact_main_cur_id = cm_tran.cur_id
                        and cisc.base_cur_id = cm_base.cur_id
                      group by cisc.transact_main_cur_id,
                               cisc.base_cur_id,
                               cisc.payment_due_date,
                               cm_tran.cur_code,
                               cm_base.cur_code)
    loop
      pkg_general.sp_forward_cur_exchange_new(pc_corporate_id,
                                              pd_trade_date,
                                              cur_cisc.payment_due_date,
                                              cur_cisc.transact_main_cur_id,
                                              cur_cisc.base_cur_id,
                                              30,
                                              vn_trans_to_base_fw_rate,
                                              vn_forward_points);
    
      if vn_trans_to_base_fw_rate is null or vn_trans_to_base_fw_rate = 0 then
        vobj_error_log.extend;
        vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                             'procedure pkg_phy_physical_process-sp_calc_cisc  ',
                                                             'PHY-005',
                                                             cur_cisc.transact_main_cur_code ||
                                                             ' to ' ||
                                                             cur_cisc.base_cur_code || ' (' ||
                                                             to_char(cur_cisc.payment_due_date,
                                                                     'dd-Mon-yyyy') || ') ',
                                                             '',
                                                             gvc_process,
                                                             null, -- pc_user_id,
                                                             sysdate,
                                                             pd_trade_date);
        sp_insert_error_log(vobj_error_log);
      else
        update cisc_contract_item_sec_cost cisc
           set cisc.fw_rate_trans_to_base_currency = vn_trans_to_base_fw_rate,
               cisc.fw_rate_string                 = '1 ' ||
                                                     cur_cisc.transact_main_cur_code || '=' ||
                                                     vn_trans_to_base_fw_rate || ' ' ||
                                                     cur_cisc.base_cur_code
         where cisc.process_id = pc_process_id
           and cisc.transact_main_cur_id = cur_cisc.transact_main_cur_id
           and cisc.base_cur_id = cur_cisc.base_cur_id
           and cisc.payment_due_date = cur_cisc.payment_due_date;
      end if;
    end loop;
  
    --
    -- Update the Quantity Conversion from Base to Transaction
    --
    for cur_cisc_qty in (select cisc.product_id,
                                cisc.price_qty_unit_id,
                                cisc.base_qty_unit_id
                           from cisc_contract_item_sec_cost cisc
                          where cisc.process_id = pc_process_id
                            and cisc.price_qty_unit_id <>
                                cisc.base_qty_unit_id
                          group by cisc.product_id,
                                   cisc.price_qty_unit_id,
                                   cisc.base_qty_unit_id)
    loop
      select pkg_general.f_get_converted_quantity(cur_cisc_qty.product_id,
                                                  cur_cisc_qty.base_qty_unit_id,
                                                  cur_cisc_qty.price_qty_unit_id,
                                                  1)
        into vn_qty_factor
        from dual;
      update cisc_contract_item_sec_cost cisc
         set cisc.base_to_price_weight_factor = vn_qty_factor
       where cisc.price_qty_unit_id = cur_cisc_qty.price_qty_unit_id
         and cisc.base_qty_unit_id = cur_cisc_qty.base_qty_unit_id
         and cisc.process_id = pc_process_id;
    end loop;
  
    --
    -- Average Price in Base Price Unit ID
    --
    update cisc_contract_item_sec_cost cisc
       set cisc.avg_cost_fw_rate = cisc.cost_value *
                                   nvl(cisc.currency_factor, 1) *
                                   nvl(cisc.base_to_price_weight_factor, 1) *
                                   nvl(cisc.fw_rate_trans_to_base_currency,
                                       1)
     where cisc.process_id = pc_process_id;
  
    --For GMR
  
    insert into gsc_gmr_sec_cost
      (internal_gmr_ref_no,
       cost_component_id,
       avg_cost,
       process_id,
       secondary_cost,
       internal_contract_item_ref_no,
       avg_cost_in_trn_cur,
       avg_cost_price_unit_id,
       payment_due_date,
       product_id,
       corporate_id,
       transact_price_unit_id,
       transact_qty_unit_id,
       price_qty_unit_id,
       cost_value,
       transact_cur_id,
       transact_main_cur_id,
       currency_factor,
       base_cur_id,
       base_qty_unit_id,
       base_price_unit_id)
      select cigc.internal_gmr_ref_no,
             cs.cost_component_id,
             cs.cost_in_base_price_unit_id avg_cost,
             pc_process_id,
             0 secondary_cost,
             cigc.int_contract_item_ref_no,
             cs.cost_in_transact_price_unit_id,
             cs.transaction_price_unit_id,
             pd_trade_date,
             gmr.product_id,
             gmr.corporate_id,
             cs.transaction_price_unit_id,
             cigc.qty_unit_id transact_qty_unit_id,
             pum1.weight_unit_id price_qty_unit_id,
             cs.cost_value,
             cs.transaction_amt_cur_id,
             nvl(scd.cur_id, transaction_amt_cur_id) transaction_amt_main_cur_id,
             nvl(scd.factor, 1),
             akc.base_cur_id,
             pdm.base_quantity_unit base_qty_unit_id,
             pum.price_unit_id base_price_unit_id
        from cs_cost_store               cs,
             cigc_contract_item_gmr_cost cigc,
             scm_service_charge_master   scm,
             gmr_goods_movement_record   gmr,
             scd_sub_currency_detail     scd,
             ak_corporate                akc,
             pdm_productmaster           pdm,
             pum_price_unit_master       pum,
             pum_price_unit_master       pum1
       where cs.cog_ref_no = cigc.cog_ref_no
         and cs.is_deleted = 'N'
         and cigc.is_deleted = 'N'
         and cigc.process_id = pc_process_id
         and cs.process_id = pc_process_id
         and cigc.internal_gmr_ref_no is not null
         and cigc.internal_gmr_ref_no = gmr.internal_gmr_ref_no
         and gmr.process_id = pc_process_id
         and cs.cost_component_id = scm.cost_id
         and scm.cost_type = 'SECONDARY_COST'
         and cs.cost_type <> 'Estimate'
         and cs.transaction_amt_cur_id = scd.sub_cur_id(+)
         and gmr.corporate_id = akc.corporate_id
         and gmr.product_id = pdm.product_id
         and pum.weight_unit_id = pdm.base_quantity_unit
         and pum.cur_id = akc.base_cur_id
         and nvl(pum.weight, 1) = 1
         and pum.is_active = 'Y'
         and pum.is_deleted = 'N'
         and pum1.price_unit_id = cs.transaction_price_unit_id
         and pum1.is_active = 'Y'
         and pum1.is_deleted = 'N';
  
    --
    -- Check the exchange rate from Transaction Currency to Base Currency
    --
    for cur_gsc in (select gsc.transact_main_cur_id,
                           gsc.base_cur_id,
                           gsc.payment_due_date,
                           cm_tran.cur_code transact_main_cur_code,
                           cm_base.cur_code base_cur_code
                      from gsc_gmr_sec_cost   gsc,
                           cm_currency_master cm_tran,
                           cm_currency_master cm_base
                     where gsc.process_id = pc_process_id
                       and gsc.transact_main_cur_id <> gsc.base_cur_id
                       and gsc.transact_main_cur_id = cm_tran.cur_id
                       and gsc.base_cur_id = cm_base.cur_id
                     group by gsc.transact_main_cur_id,
                              gsc.base_cur_id,
                              gsc.payment_due_date,
                              cm_tran.cur_code,
                              cm_base.cur_code)
    loop
    
      pkg_general.sp_forward_cur_exchange_new(pc_corporate_id,
                                              pd_trade_date,
                                              cur_gsc.payment_due_date,
                                              cur_gsc.transact_main_cur_id,
                                              cur_gsc.base_cur_id,
                                              30,
                                              vn_trans_to_base_fw_rate,
                                              vn_forward_points);
    
      if vn_trans_to_base_fw_rate is null or vn_trans_to_base_fw_rate = 0 then
        vobj_error_log.extend;
        vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                             'procedure pkg_phy_physical_process-sp_calc_gsc  ',
                                                             'PHY-005',
                                                             cur_gsc.base_cur_code ||
                                                             ' to ' ||
                                                             cur_gsc.transact_main_cur_code || ' (' ||
                                                             to_char(cur_gsc.payment_due_date,
                                                                     'dd-Mon-yyyy') || ') ',
                                                             '',
                                                             gvc_process,
                                                             null, -- pc_user_id,
                                                             sysdate,
                                                             pd_trade_date);
        sp_insert_error_log(vobj_error_log);
      else
        update gsc_gmr_sec_cost gsc
           set gsc.fw_rate_trans_to_base_currency = vn_trans_to_base_fw_rate,
               gsc.fw_rate_string                 = '1 ' ||
                                                    cur_gsc.transact_main_cur_code || '=' ||
                                                    vn_trans_to_base_fw_rate || ' ' ||
                                                    cur_gsc.base_cur_code
        
         where gsc.process_id = pc_process_id
           and gsc.transact_main_cur_id = cur_gsc.transact_main_cur_id
           and gsc.base_cur_id = cur_gsc.base_cur_id
           and gsc.payment_due_date = cur_gsc.payment_due_date;
      end if;
    end loop;
  
    --
    -- Update the Quantity Conversion from Base to Transaction
    --
    for cur_gsc_qty in (select gsc.product_id,
                               gsc.price_qty_unit_id,
                               gsc.base_qty_unit_id
                          from gsc_gmr_sec_cost gsc
                         where gsc.process_id = pc_process_id
                           and gsc.price_qty_unit_id <> gsc.base_qty_unit_id
                         group by gsc.product_id,
                                  gsc.price_qty_unit_id,
                                  gsc.base_qty_unit_id)
    loop
      select pkg_general.f_get_converted_quantity(cur_gsc_qty.product_id,
                                                  cur_gsc_qty.base_qty_unit_id,
                                                  cur_gsc_qty.price_qty_unit_id,
                                                  1)
        into vn_qty_factor
        from dual;
      update gsc_gmr_sec_cost gsc
         set gsc.base_to_price_weight_factor = vn_qty_factor
       where gsc.price_qty_unit_id = cur_gsc_qty.price_qty_unit_id
         and gsc.base_qty_unit_id = cur_gsc_qty.base_qty_unit_id
         and gsc.process_id = pc_process_id;
    end loop;
  
    --
    -- Average Price in Base Price Unit ID
    --
    update gsc_gmr_sec_cost gsc
       set gsc.avg_cost_fw_rate = gsc.cost_value *
                                  nvl(gsc.currency_factor, 1) *
                                  nvl(gsc.base_to_price_weight_factor, 1) *
                                  nvl(gsc.fw_rate_trans_to_base_currency, 1)
     where gsc.process_id = pc_process_id;
    --
    -- Calcualte GMR Sec Cost Summary for PNL
    --
    insert into gscs_gmr_sec_cost_summary
      (internal_gmr_ref_no,
       avg_cost,
       process_id,
       avg_cost_fw_rate,
       fw_rate_string)
      select gsc.internal_gmr_ref_no,
             sum(gsc.avg_cost),
             pc_process_id,
             sum(gsc.avg_cost_fw_rate),
             f_string_aggregate(gsc.fw_rate_string)
        from gsc_gmr_sec_cost gsc
       where gsc.process_id = pc_process_id
       group by gsc.internal_gmr_ref_no;
  
    --
    -- Calcualte Contract Item Sec Cost Summary for PNL
    --
  
    insert into ciscs_cisc_summary ciscs
      (internal_contract_item_ref_no,
       avg_cost,
       process_id,
       avg_cost_fw_rate,
       fw_rate_string)
      select cisc.internal_contract_item_ref_no,
             sum(cisc.avg_cost),
             pc_process_id,
             sum(cisc.avg_cost_fw_rate),
             f_string_aggregate(cisc.fw_rate_string)
        from cisc_contract_item_sec_cost cisc
       where cisc.process_id = pc_process_id
       group by cisc.internal_contract_item_ref_no;
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure sp_calc_secondary_cost',
                                                           'M2M-013',
                                                           'Code:' ||
                                                           sqlcode ||
                                                           'Message:' ||
                                                           sqlerrm,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;

  procedure sp_calc_m2m_cost(pc_corporate_id varchar2,
                             pd_trade_date   date,
                             pc_process_id   varchar2,
                             pc_user_id      varchar2) is
    --------------------------------------------------------------------------------------------------------------------------
    --        procedure name                            : sp_calc_m2m_cost
    --        author                                    :
    --        created date                              : 11th Jan 2011
    --        purpose                                   : populate secondary costs for contracts and gmrs
    --
    --        parameters
    --        pc_corporate_id                           : corporate id
    --        pc_process_id                             : eod reference no
    --
    --        modification history
    --        modified date                             :
    --        modified by                               :
    --        modify description                        :
    --------------------------------------------------------------------------------------------------------------------------
    vn_serial_no       number;
    vobj_error_log     tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count number := 1;
    vc_err_msg         varchar2(100);
  begin
    --
    -- Generate unique m2m data with m2m id
    --
    vc_err_msg := 'before generate Unique M2M data with M2M ID';
    begin
      vn_serial_no := 1;
      for cc in (select t.corporate_id,
                        t.product_id,
                        t.product_type,
                        t.quality_id,
                        t.mvp_id,
                        t.mvpl_id,
                        t.value_type,
                        t.valuation_region,
                        t.valuation_point,
                        t.valuation_incoterm_id,
                        t.valuation_city_id,
                        t.valuation_basis,
                        t.reference_incoterm,
                        t.refernce_location,
                        t.instrument_id,
                        t.valuation_dr_id,
                        t.price_basis as valuation_method,
                        t.m2m_price_unit_id,
                        pum.cur_id m2m_price_unit_cur_id,
                        cm.cur_code,
                        pum.weight_unit_id,
                        qum.qty_unit,
                        nvl(pum.weight, 1) as weight,
                        t.derivative_def_id,
                        t.valuation_month || '-' || t.valuation_year valuation_period,
                        t.valuation_date,
                        t.shipment_month || '-' || t.shipment_year shipment_month_year,
                        t.shipment_date,
                        decode(t.section_name, 'OPEN', 'OPEN', 'STOCK') rate_type,
                        pum.cur_id valuation_cur_id,
                        t.base_price_unit_id_in_ppu,
                        t.base_price_unit_id_in_pum,
                        t.payment_due_date
                   from tmpc_temp_m2m_pre_check  t,
                        pum_price_unit_master    pum,
                        cm_currency_master       cm,
                        qum_quantity_unit_master qum
                  where t.corporate_id = pc_corporate_id
                    and t.m2m_price_unit_id = pum.price_unit_id(+)
                    and pum.cur_id = cm.cur_id(+)
                    and pum.weight_unit_id = qum.qty_unit_id(+)
                    and t.product_type = 'BASEMETAL'
                  group by t.corporate_id,
                           t.product_id,
                           t.product_type,
                           t.mvp_id,
                           t.mvpl_id,
                           t.value_type,
                           t.valuation_region,
                           t.valuation_point,
                           t.valuation_incoterm_id,
                           t.valuation_city_id,
                           t.valuation_basis,
                           t.reference_incoterm,
                           t.refernce_location,
                           t.instrument_id,
                           t.valuation_dr_id,
                           t.price_basis,
                           pum.cur_id,
                           t.m2m_price_unit_id,
                           t.m2m_price_unit_cur_id,
                           cm.cur_code,
                           pum.weight_unit_id,
                           qum.qty_unit,
                           nvl(pum.weight, 1),
                           t.quality_id,
                           t.derivative_def_id,
                           t.valuation_month || '-' || t.valuation_year,
                           t.valuation_date,
                           t.shipment_month || '-' || t.shipment_year,
                           t.shipment_date,
                           --this bit is important since for the same dr_id , open contract use forward rates and
                           --stock uses spot. tmef has been populated for both types
                           decode(t.section_name, 'OPEN', 'OPEN', 'STOCK'),
                           t.valuation_cur_id,
                           t.base_price_unit_id_in_ppu,
                           t.base_price_unit_id_in_pum,
                           t.payment_due_date)
      loop
        insert into md_m2m_daily
          (md_id,
           process_id,
           corporate_id,
           product_id,
           product_type,
           quality_id,
           mvp_id,
           mvpl_id,
           valuation_region,
           valuation_point,
           valuation_incoterm_id,
           valuation_city_id,
           valuation_basis,
           reference_incoterm,
           refernce_location_id,
           instrument_id,
           valuation_dr_id,
           m2m_price_unit_id,
           m2m_price_unit_cur_id,
           m2m_price_unit_cur_code,
           m2m_price_unit_weight_unit_id,
           m2m_price_unit_weight_unit,
           m2m_price_unit_weight,
           valuation_month,
           valuation_future_contract,
           derivative_def_id,
           valuation_date,
           shipment_month_year,
           shipment_date,
           rate_type,
           valuation_cur_id,
           base_price_unit_id_in_ppu,
           base_price_unit_id_in_pum,
           valuation_method,
           payment_due_date)
        values
          ('MDB-' || vn_serial_no,
           pc_process_id,
           cc.corporate_id,
           cc.product_id,
           cc.product_type,
           cc.quality_id,
           cc.mvp_id,
           cc.mvpl_id,
           cc.valuation_region,
           cc.valuation_point,
           cc.valuation_incoterm_id,
           cc.valuation_city_id,
           cc.valuation_basis,
           cc.reference_incoterm,
           cc.refernce_location,
           cc.instrument_id,
           cc.valuation_dr_id,
           cc.m2m_price_unit_id,
           cc.m2m_price_unit_cur_id,
           cc.cur_code,
           cc.weight_unit_id,
           cc.qty_unit,
           cc.weight,
           cc.valuation_period,
           cc.valuation_dr_id,
           cc.derivative_def_id,
           cc.valuation_date,
           cc.shipment_month_year,
           cc.shipment_date,
           cc.rate_type,
           cc.valuation_cur_id,
           cc.base_price_unit_id_in_ppu,
           cc.base_price_unit_id_in_pum,
           cc.value_type,
           cc.payment_due_date);
        vn_serial_no := vn_serial_no + 1;
      end loop;
      --
      -- Update the Quality premimum
      --
      for cc1 in (select tmpc.corporate_id,
                         tmpc.mvp_id,
                         tmpc.valuation_point,
                         tmpc.shipment_month,
                         tmpc.shipment_year,
                         tmpc.instrument_id,
                         tmpc.base_price_unit_id_in_ppu,
                         tmpc.quality_id,
                         tmpc.product_id,
                         tmpc.payment_due_date,
                         tmpc.m2m_quality_premium,
                         tmpc.m2m_qp_fw_exch_rate
                    from tmpc_temp_m2m_pre_check tmpc
                   where tmpc.corporate_id = pc_corporate_id
                     and tmpc.product_type = 'BASEMETAL'
                   group by tmpc.corporate_id,
                            tmpc.mvp_id,
                            tmpc.valuation_point,
                            tmpc.shipment_month,
                            tmpc.shipment_year,
                            tmpc.instrument_id,
                            tmpc.base_price_unit_id_in_ppu,
                            tmpc.quality_id,
                            tmpc.product_id,
                            tmpc.payment_due_date,
                            tmpc.m2m_quality_premium,
                            tmpc.m2m_qp_fw_exch_rate)
      loop
      
        update md_m2m_daily md
           set md.m2m_quality_premium = cc1.m2m_quality_premium,
               md.m2m_qp_fw_exch_rate = cc1.m2m_qp_fw_exch_rate
         where md.corporate_id = cc1.corporate_id
           and md.product_id = cc1.product_id
           and md.quality_id = cc1.quality_id
           and md.shipment_month_year =
               cc1.shipment_month || '-' || cc1.shipment_year
           and md.mvp_id = cc1.mvp_id
           and md.payment_due_date = cc1.payment_due_date
           and md.process_id = pc_process_id
           and md.product_type = 'BASEMETAL';
      
      end loop;
      --
      -- Update the product premimum
      --
      for cc2 in (select tmpc.corporate_id,
                         tmpc.product_id,
                         tmpc.base_price_unit_id_in_ppu,
                         tmpc.shipment_month,
                         tmpc.shipment_year,
                         tmpc.payment_due_date,
                         tmpc.m2m_product_premium,
                         tmpc.m2m_pp_fw_exch_rate
                    from tmpc_temp_m2m_pre_check tmpc
                   where tmpc.corporate_id = pc_corporate_id
                     and tmpc.product_type = 'BASEMETAL'
                   group by tmpc.corporate_id,
                            tmpc.product_id,
                            tmpc.base_price_unit_id_in_ppu,
                            tmpc.shipment_month,
                            tmpc.shipment_year,
                            tmpc.payment_due_date,
                            tmpc.m2m_product_premium,
                            tmpc.m2m_pp_fw_exch_rate)
      loop
        update md_m2m_daily md
           set md.m2m_product_premium = cc2.m2m_product_premium,
               md.m2m_pp_fw_exch_rate = cc2.m2m_pp_fw_exch_rate
         where md.corporate_id = cc2.corporate_id
           and md.product_id = cc2.product_id
           and md.shipment_month_year =
               cc2.shipment_month || '-' || cc2.shipment_year
           and md.payment_due_date = cc2.payment_due_date
           and md.process_id = pc_process_id
           and md.product_type = 'BASEMETAL';
      end loop;
      vc_err_msg := 'line 2819';
      update md_m2m_daily md
         set (md.valuation_exchange_id, md.m2m_settlement_price, md.m2m_sett_price_available_date) = --
              (select pdd.exchange_id,
                      edq.price,
                      edq.dq_trade_date
                 from eodeom_derivative_quote_detail edq,
                      pum_price_unit_master          pum,
                      dim_der_instrument_master      dim,
                      div_der_instrument_valuation   div,
                      pdd_product_derivative_def     pdd
                where edq.dr_id = md.valuation_dr_id
                  and edq.corporate_id = pc_corporate_id
                  and dim.instrument_id = md.instrument_id
                  and edq.instrument_id = div.instrument_id
                  and dim.product_derivative_id = pdd.derivative_def_id
                  and edq.price_source_id = div.price_source_id
                  and div.is_deleted = 'N'
                  and edq.available_price_id = div.available_price_id
                  and edq.price_unit_id = pum.price_unit_id
                  and edq.price_unit_id = div.price_unit_id
                  and edq.price is not null
                  and edq.process_id = pc_process_id
                  and edq.dq_trade_date = pd_trade_date)
      
       where md.corporate_id = pc_corporate_id
         and md.valuation_method <> 'FIXED'
         and md.process_id = pc_process_id;
      ----
      vc_err_msg := 'line 2887';
      --
      -- Update the M2M Location Incoterm Deviation
      --
      for cc3 in (select tmpc.product_id,
                         tmpc.valuation_city_id,
                         tmpc.mvp_id,
                         tmpc.valuation_incoterm_id,
                         tmpc.payment_due_date,
                         tmpc.m2m_loc_incoterm_deviation,
                         tmpc.m2m_ld_fw_exch_rate
                    from tmpc_temp_m2m_pre_check tmpc
                   where tmpc.product_type = 'BASEMETAL'
                     and tmpc.corporate_id = pc_corporate_id
                   group by tmpc.product_id,
                            tmpc.valuation_city_id,
                            tmpc.mvp_id,
                            tmpc.valuation_incoterm_id,
                            tmpc.payment_due_date,
                            tmpc.m2m_loc_incoterm_deviation,
                            tmpc.m2m_ld_fw_exch_rate)
      loop
      
        update md_m2m_daily md
           set md.m2m_loc_incoterm_deviation = cc3.m2m_loc_incoterm_deviation,
               md.m2m_ld_fw_exch_rate        = cc3.m2m_ld_fw_exch_rate
         where md.valuation_city_id = cc3.valuation_city_id
           and md.mvp_id = cc3.mvp_id
           and md.product_id = cc3.product_id
           and md.valuation_incoterm_id = cc3.valuation_incoterm_id
           and md.product_type = 'BASEMETAL'
           and md.corporate_id = pc_corporate_id
           and md.payment_due_date = cc3.payment_due_date
           and md.process_id = pc_process_id;
      
      end loop;
    
      vc_err_msg := 'line 3049';
    
      update md_m2m_daily md
         set md.net_m2m_price = nvl(md.m2m_settlement_price, 0)
       where md.corporate_id = pc_corporate_id
         and md.product_type = 'BASEMETAL'
         and md.process_id = pc_process_id;
      sp_write_log(pc_corporate_id,
                   pd_trade_date,
                   'sp_calc_m2m',
                   'before 5');
      vc_err_msg := 'line 3068';
      vc_err_msg := 'line 3090';
      sp_write_log(pc_corporate_id,
                   pd_trade_date,
                   'sp_calc_m2m',
                   'before 6');
      --
      -- update derivative def id/name
      --
      update md_m2m_daily md
         set (derivative_def_id, derivative_def_name) = (select pdd.derivative_def_id,
                                                                pdd.derivative_def_name
                                                           from dim_der_instrument_master  dim,
                                                                pdd_product_derivative_def pdd,
                                                                irm_instrument_type_master irm
                                                          where dim.instrument_id =
                                                                md.instrument_id
                                                            and dim.product_derivative_id =
                                                                pdd.derivative_def_id
                                                            and dim.instrument_type_id =
                                                                irm.instrument_type_id
                                                            and md.product_type =
                                                                'BASEMETAL'
                                                            and irm.instrument_type =
                                                                'Future'
                                                            and rownum <= 1)
       where md.corporate_id = pc_corporate_id
         and md.product_type = 'BASEMETAL'
         and md.process_id = pc_process_id;
      --
      -- update m2m main currency and decimals
      --
      -- tbd : update is not working : 25th   : this is not working as have commented the above update to
      --get the m2m_price_unit_cur_id
      sp_write_log(pc_corporate_id,
                   pd_trade_date,
                   'sp_calc_m2m',
                   'before 7');
      vc_err_msg := 'line 3121';
      update md_m2m_daily md
         set (md.m2m_main_cur_id, md.m2m_main_cur_code, md.m2m_main_cur_decimals, md.main_currency_factor) = --
              (select (case
                        when cm.is_sub_cur = 'Y' then
                         scd.cur_id
                        else
                         cm.cur_id
                      end) base_currency_id,
                      (case
                        when cm.is_sub_cur = 'Y' then
                         cm_1.cur_code
                        else
                         cm.cur_code
                      end) cur_code,
                      (case
                        when cm.is_sub_cur = 'Y' then
                         cm_1.decimals
                        else
                         cm.decimals
                      end),
                      (case
                        when cm.is_sub_cur = 'Y' then
                         nvl(scd.factor, 1)
                        else
                         1
                      end) factor
                 from cm_currency_master      cm,
                      scd_sub_currency_detail scd,
                      cm_currency_master      cm_1
                where cm.cur_id = md.m2m_price_unit_cur_id
                  and cm.cur_id = scd.sub_cur_id(+)
                  and scd.cur_id = cm_1.cur_id(+))
       where md.process_id = pc_process_id
         and md.product_type = 'BASEMETAL';
      sp_write_log(pc_corporate_id,
                   pd_trade_date,
                   'sp_calc_m2m',
                   'before 8');
      -- now update the m2m id in the tmpc_temp_m2m_pre_check
      -- table per contract item level,gmr level,grd level --
      vc_err_msg := 'line 3163';
      for c1 in (select md.md_id,
                        md.corporate_id,
                        md.product_id,
                        md.crop_year_id,
                        md.quality_id,
                        md.origin_id,
                        md.origin_group_id,
                        md.growth_code_id,
                        md.valuation_method,
                        md.mvp_id,
                        md.mvpl_id,
                        md.valuation_region,
                        md.valuation_point,
                        md.valuation_incoterm_id,
                        md.valuation_city_id,
                        md.valuation_basis,
                        md.reference_incoterm,
                        md.refernce_location_id refernce_location,
                        md.instrument_id,
                        md.valuation_dr_id,
                        md.valuation_month,
                        md.valuation_date,
                        md.shipment_month_year,
                        md.shipment_date,
                        md.rate_type,
                        md.payment_due_date
                   from md_m2m_daily md
                  where md.corporate_id = pc_corporate_id
                    and md.process_id = pc_process_id)
      loop
        if c1.valuation_method <> 'FIXED' then
          update tmpc_temp_m2m_pre_check tmpc
             set tmpc.internal_m2m_id = c1.md_id
           where tmpc.corporate_id = c1.corporate_id
             and tmpc.product_id = c1.product_id
             and tmpc.quality_id = c1.quality_id
             and tmpc.mvp_id = c1.mvp_id
             and tmpc.mvpl_id = c1.mvpl_id
             and tmpc.valuation_region = c1.valuation_region
             and tmpc.valuation_point = c1.valuation_point
             and tmpc.valuation_incoterm_id = c1.valuation_incoterm_id
             and tmpc.valuation_city_id = c1.valuation_city_id
             and tmpc.valuation_basis = c1.valuation_basis
             and tmpc.valuation_dr_id = c1.valuation_dr_id
             and tmpc.reference_incoterm = c1.reference_incoterm
             and tmpc.refernce_location = c1.refernce_location
             and tmpc.instrument_id = c1.instrument_id
             and tmpc.shipment_date = c1.shipment_date
             and tmpc.shipment_month || '-' || tmpc.shipment_year =
                 c1.shipment_month_year
             and decode(tmpc.section_name, 'OPEN', 'OPEN', 'STOCK') =
                 c1.rate_type
             and tmpc.product_type = 'BASEMETAL'
             and tmpc.payment_due_date = c1.payment_due_date;
        
        else
          update tmpc_temp_m2m_pre_check tmpc
             set tmpc.internal_m2m_id = c1.md_id
           where tmpc.corporate_id = c1.corporate_id
             and tmpc.product_id = c1.product_id
             and tmpc.quality_id = c1.quality_id
             and tmpc.mvp_id = c1.mvp_id
             and tmpc.mvpl_id = c1.mvpl_id
             and tmpc.valuation_region = c1.valuation_region
             and tmpc.valuation_point = c1.valuation_point
             and tmpc.valuation_incoterm_id = c1.valuation_incoterm_id
             and tmpc.valuation_city_id = c1.valuation_city_id
             and tmpc.valuation_basis = c1.valuation_basis
             and tmpc.reference_incoterm = c1.reference_incoterm
             and tmpc.refernce_location = c1.refernce_location
                --and tmpc.instrument_id = c1.instrument_id
             and tmpc.shipment_date = c1.shipment_date
             and tmpc.shipment_month || '-' || tmpc.shipment_year =
                 c1.shipment_month_year
             and decode(tmpc.section_name, 'OPEN', 'OPEN', 'STOCK') =
                 c1.rate_type
             and tmpc.product_type = 'BASEMETAL'
             and tmpc.payment_due_date = c1.payment_due_date;
        end if;
      end loop;
    
      -- Update valuation_location, reference_location and valuation_incoterm
    
      for cc in (select tmpc.internal_m2m_id,
                        tmpc.product_id,
                        cim_val_loc.city_name valuation_location,
                        cim_ref_loc.city_name reference_location,
                        itm.incoterm valuation_incoterm,
                        cim_val_loc_v.country_name valuation_location_country,
                        cim_ref_loc_r.country_name reference_location_country
                   from tmpc_temp_m2m_pre_check tmpc,
                        cim_citymaster          cim_val_loc,
                        cim_citymaster          cim_ref_loc,
                        cym_countrymaster       cim_val_loc_v,
                        cym_countrymaster       cim_ref_loc_r,
                        itm_incoterm_master     itm
                  where tmpc.valuation_city_id = cim_val_loc.city_id
                    and tmpc.refernce_location = cim_ref_loc.city_id
                    and cim_val_loc_v.country_id = cim_val_loc.country_id
                    and cim_ref_loc_r.country_id = cim_ref_loc.country_id
                    and tmpc.valuation_incoterm_id = itm.incoterm_id
                    and tmpc.corporate_id = pc_corporate_id
                    and tmpc.product_type = 'BASEMETAL'
                  group by cim_val_loc.city_name,
                           cim_ref_loc.city_name,
                           itm.incoterm,
                           cim_val_loc_v.country_name,
                           cim_ref_loc_r.country_name,
                           tmpc.product_id,
                           tmpc.internal_m2m_id)
      loop
        update md_m2m_daily md
           set md.valuation_location         = cc.valuation_location,
               md.reference_location         = cc.reference_location,
               md.valuation_incoterm         = cc.valuation_incoterm,
               md.valuation_location_country = cc.valuation_location_country,
               md.reference_location_country = cc.reference_location_country
         where md.md_id = cc.internal_m2m_id
           and md.product_id = cc.product_id
           and md.process_id = pc_process_id;
      end loop;
    
    end;
    sp_write_log(pc_corporate_id, pd_trade_date, 'sp_calc_m2m', 'Done');
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure pkg_phy_physical_process.sp_calc_m2m_cost',
                                                           'M2M-013',
                                                           'Code:' ||
                                                           sqlcode ||
                                                           'Message:' ||
                                                           sqlerrm ||
                                                           vc_err_msg,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;

  procedure sp_calc_m2m_conc_cost(pc_corporate_id varchar2,
                                  pd_trade_date   date,
                                  pc_process_id   varchar2,
                                  pc_user_id      varchar2) is
    --------------------------------------------------------------------------------------------------------------------------
    --        procedure name                            : sp_calc_m2m_cost
    --        author                                    :
    --        created date                              : 11th Jan 2011
    --        purpose                                   : populate secondary costs for contracts and gmrs
    --        parameters
    --        pc_corporate_id                           : corporate id
    --        pc_process_id                             : eod reference no
    --        modification history
    --        modified date                             :
    --        modified by                               :
    --        modify description                        :
    --------------------------------------------------------------------------------------------------------------------------
    vn_serial_no       number;
    vobj_error_log     tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count number := 1;
    vc_err_msg         varchar2(100);
    --vn_qat_premimum_amt     number(25, 5);
    --vn_pdm_premimum_amt     number(25, 5);
    --vn_cp_price             number;
    --vc_cp_price_unit_id     varchar2(20);
    --vn_total_pc_charge      number;
    --vn_total_tc_charge      number;
    --vn_total_rc_charge      number;
    --vc_tc_cur_id            varchar2(20);
    --vc_pc_cur_id            varchar2(20);
    pn_charge_amt           number;
    pc_charge_price_unit_id varchar2(25);
  begin
    --generate unique m2m data with m2m id
    vc_err_msg := 'before generate Unique M2M data with M2M ID';
    begin
      vn_serial_no := 1;
      for cc in (select t.corporate_id,
                        t.conc_product_id,
                        t.conc_quality_id,
                        t.product_id,
                        t.quality_id,
                        t.element_id,
                        t.product_type,
                        t.mvp_id,
                        t.mvpl_id,
                        t.value_type,
                        t.valuation_region,
                        t.valuation_point,
                        t.valuation_incoterm_id,
                        t.valuation_city_id,
                        t.valuation_basis,
                        t.reference_incoterm,
                        t.refernce_location,
                        t.instrument_id,
                        t.valuation_dr_id,
                        t.price_basis as valuation_method,
                        t.m2m_price_unit_id,
                        pum.cur_id m2m_price_unit_cur_id,
                        cm.cur_code,
                        pum.weight_unit_id,
                        qum.qty_unit,
                        nvl(pum.weight, 1) as weight,
                        t.derivative_def_id,
                        t.valuation_month || '-' || t.valuation_year valuation_period,
                        t.valuation_date,
                        t.shipment_month || '-' || t.shipment_year shipment_month_year,
                        t.shipment_date,
                        decode(t.section_name, 'OPEN', 'OPEN', 'STOCK') rate_type,
                        pum.cur_id valuation_cur_id,
                        t.base_price_unit_id_in_ppu,
                        t.base_price_unit_id_in_pum,
                        t.is_tolling_contract,
                        t.is_tolling_extn
                   from tmpc_temp_m2m_pre_check  t,
                        pum_price_unit_master    pum,
                        cm_currency_master       cm,
                        qum_quantity_unit_master qum
                  where t.corporate_id = pc_corporate_id
                    and t.m2m_price_unit_id = pum.price_unit_id(+)
                    and pum.cur_id = cm.cur_id(+)
                    and pum.weight_unit_id = qum.qty_unit_id(+)
                    and t.product_type = 'CONCENTRATES'
                    and t.is_tolling_contract = 'N'
                    and t.is_tolling_extn = 'N'
                  group by t.corporate_id,
                           t.conc_product_id,
                           t.conc_quality_id,
                           t.product_id,
                           t.element_id,
                           t.product_type,
                           t.mvp_id,
                           t.mvpl_id,
                           t.value_type,
                           t.valuation_region,
                           t.valuation_point,
                           t.valuation_incoterm_id,
                           t.valuation_city_id,
                           t.valuation_basis,
                           t.reference_incoterm,
                           t.refernce_location,
                           t.instrument_id,
                           t.valuation_dr_id,
                           t.price_basis,
                           pum.cur_id,
                           t.m2m_price_unit_id,
                           t.m2m_price_unit_cur_id,
                           cm.cur_code,
                           pum.weight_unit_id,
                           qum.qty_unit,
                           nvl(pum.weight, 1),
                           t.quality_id,
                           t.derivative_def_id,
                           t.valuation_month || '-' || t.valuation_year,
                           t.valuation_date,
                           t.shipment_month || '-' || t.shipment_year,
                           t.shipment_date,
                           --this bit is important since for the same dr_id , open contract use forward rates and
                           --stock uses spot. tmef has been populated for both types
                           decode(t.section_name, 'OPEN', 'OPEN', 'STOCK'),
                           t.valuation_cur_id,
                           t.base_price_unit_id_in_ppu,
                           t.base_price_unit_id_in_pum,
                           t.is_tolling_contract,
                           t.is_tolling_extn)
      loop
        insert into md_m2m_daily
          (md_id,
           process_id,
           corporate_id,
           conc_product_id,
           conc_quality_id,
           product_id,
           quality_id,
           element_id,
           product_type,
           mvp_id,
           mvpl_id,
           valuation_region,
           valuation_point,
           valuation_incoterm_id,
           valuation_city_id,
           valuation_basis,
           reference_incoterm,
           refernce_location_id,
           instrument_id,
           valuation_dr_id,
           m2m_price_unit_id,
           m2m_price_unit_cur_id,
           m2m_price_unit_cur_code,
           m2m_price_unit_weight_unit_id,
           m2m_price_unit_weight_unit,
           m2m_price_unit_weight,
           valuation_month,
           valuation_future_contract,
           derivative_def_id,
           valuation_date,
           shipment_month_year,
           shipment_date,
           rate_type,
           valuation_cur_id,
           base_price_unit_id_in_ppu,
           base_price_unit_id_in_pum,
           valuation_method,
           is_tolling_contract,
           is_tolling_extn)
        values
          ('MDC-' || vn_serial_no,
           pc_process_id,
           cc.corporate_id,
           cc.conc_product_id,
           cc.conc_quality_id,
           cc.product_id,
           cc.quality_id,
           cc.element_id,
           cc.product_type,
           cc.mvp_id,
           cc.mvpl_id,
           cc.valuation_region,
           cc.valuation_point,
           cc.valuation_incoterm_id,
           cc.valuation_city_id,
           cc.valuation_basis,
           cc.reference_incoterm,
           cc.refernce_location,
           cc.instrument_id,
           cc.valuation_dr_id,
           cc.m2m_price_unit_id,
           cc.m2m_price_unit_cur_id,
           cc.cur_code,
           cc.weight_unit_id,
           cc.qty_unit,
           cc.weight,
           cc.valuation_period,
           cc.valuation_dr_id,
           cc.derivative_def_id,
           cc.valuation_date,
           cc.shipment_month_year,
           cc.shipment_date,
           cc.rate_type,
           cc.valuation_cur_id,
           cc.base_price_unit_id_in_ppu,
           cc.base_price_unit_id_in_pum,
           cc.value_type,
           cc.is_tolling_contract,
           cc.is_tolling_extn);
        vn_serial_no := vn_serial_no + 1;
      end loop;
      --Checking for the treatment  is there or not
      --For this  we are calling the sp_get_treatment_charge
      /*  for cc1 in (select tmpc.internal_contract_item_ref_no,
                                         tmpc.conc_product_id,
                                         tmpc.conc_quality_id,
                                         tmpc.element_id,
                                         tmpc.product_id,
                                         tmpc.quality_id,
                                         pc_process_id,
                                         pci.item_qty,
                                         pci.item_qty_unit_id,
                                         vn_cp_price,
                                         vc_cp_price_unit_id
                                          from tmpc_temp_m2m_pre_check tmpc,
                                                    pci_physical_contract_item    pci
                                                    where  pci.internal_contract_item_ref_no=
                                                    tmpc.internal_contract_item_ref_no
                                                    and tmpc.product_type='CONCENTRATES' ) loop      
        sp_get_treatment_charge(cc1.internal_contract_item_ref_no,
                                                               cc1.element_id,
                                                               pc_process_id,
                                                               cc1.item_qty,
                                                               cc1.item_qty_unit_id,
                                                               cc1.vn_cp_price,
                                                               cc1.vc_cp_price_unit_id,
                                                               vn_total_tc_charge,
                                                               vc_tc_cur_id);
                                                               
        --if  vn_total_tc_charge  is zero or null we have to raise the exception
        --else 
        if nvl(vn_total_tc_charge,0)<>0   then
           update md_m2m_daily md
           set md.treatment_charge=vn_total_tc_charge
           where md.corporate_id =pc_corporate_id
             and md.product_type='CONCENTRATES'
             and md.conc_product_id=cc1.conc_product_id
             and md.conc_quality_id=cc1.conc_quality_id
             and md.product_id=cc1.product_id
             and md.quality_id=cc1.quality_id
             and md.element_id=cc1.element_id
             and md.process_id=pc_process_id;
            end if;
      end loop;
      
      --Check theRefine Charege is there or not
      --If Refine charge  is  there we will update the md table
      --for this we are calling the sp_get_refine_chage
      for cc_rc  in (select tmpc.internal_contract_item_ref_no,
                                         tmpc.conc_product_id,
                                         tmpc.conc_quality_id,
                                         tmpc.element_id,
                                         tmpc.product_id,
                                         tmpc.quality_id,
                                         pc_process_id,
                                         pci.item_qty,
                                         pci.item_qty_unit_id,
                                         vn_cp_price,
                                         vc_cp_price_unit_id
                                          from tmpc_temp_m2m_pre_check tmpc,
                                                    pci_physical_contract_item    pci
                                                    where  pci.internal_contract_item_ref_no=
                                                    tmpc.internal_contract_item_ref_no
                                                    and tmpc.product_type='CONCENTRATES' ) loop      
        sp_get_refine_charge( cc_rc.internal_contract_item_ref_no,
                                                                cc_rc.element_id,
                                                               pc_process_id,
                                                                cc_rc.item_qty,
                                                                cc_rc.item_qty_unit_id,
                                                                cc_rc.vn_cp_price,
                                                                cc_rc.vc_cp_price_unit_id,
                                                               vn_total_rc_charge,
                                                               vc_tc_cur_id);
                                                               
        --if  vn_total_tc_charge  is zero or null we have to raise the exception
        --else we have to update the md table
        if nvl(vn_total_rc_charge,0)<>0   then
           update md_m2m_daily md
           set md.refine_charge=vn_total_rc_charge
           where md.corporate_id =pc_corporate_id
             and md.product_type='CONCENTRATES'
             and md.conc_product_id= cc_rc.conc_product_id
             and md.conc_quality_id= cc_rc.conc_quality_id
             and md.product_id= cc_rc.product_id
             and md.quality_id= cc_rc.quality_id
             and md.element_id= cc_rc.element_id
             and md.process_id=pc_process_id;
            end if;
      end loop;
      --calling the sp_get_penalty_charge
      for cc_pc  in (select tmpc.internal_contract_item_ref_no,
                                         tmpc.conc_product_id,
                                         tmpc.conc_quality_id,
                                         tmpc.element_id,
                                         tmpc.product_id,
                                         tmpc.quality_id,
                                         pc_process_id,
                                         pci.item_qty,
                                         pci.item_qty_unit_id,
                                         vn_cp_price,
                                         vc_cp_price_unit_id
                                          from tmpc_temp_m2m_pre_check tmpc,
                                                    pci_physical_contract_item    pci
                                                    where  pci.internal_contract_item_ref_no=
                                                    tmpc.internal_contract_item_ref_no
                                                    and tmpc.product_type='CONCENTRATES' ) loop  
        sp_get_penalty_charge( cc_pc.internal_contract_item_ref_no,
                                                           cc_pc.element_id,
                                                           pc_process_id,
                                                           cc_pc.item_qty,
                                                           cc_pc.item_qty_unit_id,
                                                           vn_total_pc_charge,
                                                           vc_pc_cur_id);
                                                               
        --if  vn_total_pc_charge  is zero or null we have to raise the exception
        --else we have to update the md table
        if nvl(vn_total_pc_charge,0)<> 0   then
           update md_m2m_daily md
           set md.penalty_charge=vn_total_pc_charge
           where md.corporate_id =pc_corporate_id
             and md.product_type='CONCENTRATES'
             and md.conc_product_id= cc_pc.conc_product_id
             and md.conc_quality_id= cc_pc.conc_quality_id
             and md.product_id= cc_pc.product_id
             and md.quality_id= cc_pc.quality_id
             and md.element_id= cc_pc.element_id
             and md.process_id=pc_process_id;
            end if;
      end loop;*/
    
      for cc_tmpc in (select tmpc.corporate_id,
                             tmpc.conc_product_id,
                             tmpc.conc_quality_id,
                             tmpc.product_id,
                             tmpc.quality_id,
                             tmpc.element_id,
                             tmpc.base_price_unit_id_in_ppu,
                             tmpc.shipment_month,
                             tmpc.shipment_year,
                             tmpc.mvp_id valuation_point_id,
                             ppu.decimals
                        from tmpc_temp_m2m_pre_check tmpc,
                             pdm_productmaster       pdm,
                             qat_quality_attributes  qat,
                             ppu_product_price_units ppu
                       where tmpc.product_type = 'CONCENTRATES'
                         and tmpc.is_tolling_contract = 'N'
                         and tmpc.is_tolling_extn = 'N'
                         and tmpc.corporate_id = pc_corporate_id
                         and tmpc.conc_product_id = pdm.product_id
                         and tmpc.conc_quality_id = qat.quality_id
                         and tmpc.base_price_unit_id_in_ppu =
                             ppu.internal_price_unit_id
                       group by tmpc.corporate_id,
                                tmpc.conc_product_id,
                                tmpc.conc_quality_id,
                                tmpc.product_id,
                                tmpc.quality_id,
                                tmpc.base_price_unit_id_in_ppu,
                                tmpc.element_id,
                                tmpc.mvp_id,
                                tmpc.shipment_month,
                                tmpc.shipment_year,
                                ppu.decimals)
      loop
        -- updating treatment charge  to the md table
        pkg_phy_pre_check_process.sp_calc_m2m_tc_pc_rc_charge(cc_tmpc.corporate_id,
                                                              pd_trade_date,
                                                              cc_tmpc.conc_product_id,
                                                              cc_tmpc.conc_quality_id,
                                                              cc_tmpc.valuation_point_id, --valuation_id
                                                              'Treatment Charges', --charge_type
                                                              cc_tmpc.element_id,
                                                              cc_tmpc.shipment_month,
                                                              cc_tmpc.shipment_year,
                                                              cc_tmpc.base_price_unit_id_in_ppu,
                                                              pn_charge_amt,
                                                              pc_charge_price_unit_id);
      
        /* if nvl(pn_charge_amt, 0) <> 0 then
        pn_charge_amt := round(pkg_phy_pre_check_process.f_get_converted_price(pc_corporate_id,
                                                                               pn_charge_amt,
                                                                               pc_charge_price_unit_id,
                                                                               cc_tmpc.base_price_unit_id_in_ppu,
                                                                               pd_trade_date),
                               cc_tmpc.decimals);*/
        update md_m2m_daily md
           set md.treatment_charge = pn_charge_amt,
               md.tc_price_unit_id = pc_charge_price_unit_id
         where md.corporate_id = pc_corporate_id
           and md.product_type = 'CONCENTRATES'
           and md.is_tolling_contract = 'N'
           and md.is_tolling_extn = 'N'
           and md.conc_product_id = cc_tmpc.conc_product_id
           and md.conc_quality_id = cc_tmpc.conc_quality_id
           and md.product_id = cc_tmpc.product_id
           and md.quality_id = cc_tmpc.quality_id
           and md.shipment_month_year =
               cc_tmpc.shipment_month || '-' || cc_tmpc.shipment_year
           and md.mvp_id = cc_tmpc.valuation_point_id
           and md.process_id = pc_process_id
           and md.element_id = cc_tmpc.element_id
           and md.process_id = pc_process_id;
        -- end if;
        -- updating refine  charge  to the md table
        pkg_phy_pre_check_process.sp_calc_m2m_tc_pc_rc_charge(cc_tmpc.corporate_id,
                                                              pd_trade_date,
                                                              cc_tmpc.conc_product_id,
                                                              cc_tmpc.conc_quality_id,
                                                              cc_tmpc.valuation_point_id,
                                                              'Refining Charges',
                                                              cc_tmpc.element_id,
                                                              cc_tmpc.shipment_month,
                                                              cc_tmpc.shipment_year,
                                                              cc_tmpc.base_price_unit_id_in_ppu,
                                                              pn_charge_amt,
                                                              pc_charge_price_unit_id);
      
        /*if nvl(pn_charge_amt, 0) <> 0 then
        pn_charge_amt := round(pkg_phy_pre_check_process.f_get_converted_price(pc_corporate_id,
                                                                               pn_charge_amt,
                                                                               pc_charge_price_unit_id,
                                                                               cc_tmpc.base_price_unit_id_in_ppu,
                                                                               pd_trade_date),
                               cc_tmpc.decimals);*/
        update md_m2m_daily md
           set md.refine_charge    = pn_charge_amt,
               md.rc_price_unit_id = pc_charge_price_unit_id
         where md.corporate_id = pc_corporate_id
           and md.product_type = 'CONCENTRATES'
           and md.is_tolling_contract = 'N'
           and md.is_tolling_extn = 'N'
           and md.conc_product_id = cc_tmpc.conc_product_id
           and md.conc_quality_id = cc_tmpc.conc_quality_id
           and md.product_id = cc_tmpc.product_id
           and md.quality_id = cc_tmpc.quality_id
           and md.shipment_month_year =
               cc_tmpc.shipment_month || '-' || cc_tmpc.shipment_year
           and md.mvp_id = cc_tmpc.valuation_point_id
           and md.process_id = pc_process_id
           and md.element_id = cc_tmpc.element_id
           and md.process_id = pc_process_id;
        -- end if;
      end loop;
      -- updating penalty  charge  to the md table 
      /*for cc_penalty in (select tmpc.corporate_id,
                                tmpc.conc_product_id,
                                tmpc.conc_quality_id,
                                pdm.product_desc,
                                qat.quality_name,
                                qat.quality_id,
                                tmpc.product_id,
                                tmpc.shipment_month,
                                tmpc.shipment_year,
                                tmpc.mvp_id,
                                tmpc.valuation_point,
                                pqca.element_id,
                                tmpc.base_price_unit_id_in_ppu,
                                aml.attribute_name
                           from ash_assay_header               ash,
                                asm_assay_sublot_mapping       asm,
                                aml_attribute_master_list      aml,
                                pqca_pq_chemical_attributes    pqca,
                                rm_ratio_master                rm,
                                ppm_product_properties_mapping ppm,
                                tmpc_temp_m2m_pre_check        tmpc,
                                pdm_productmaster              pdm,
                                qat_quality_attributes         qat
                          where ash.ash_id = tmpc.assay_header_id
                            and tmpc.conc_product_id = pdm.product_id
                            and ash.ash_id = asm.ash_id
                            and asm.asm_id = pqca.asm_id
                            and pqca.unit_of_measure = rm.ratio_id
                            and pqca.element_id = aml.attribute_id
                            and ppm.attribute_id = aml.attribute_id
                            and tmpc.corporate_id = pc_corporate_id
                            and tmpc.conc_quality_id = qat.quality_id
                            and pqca.is_elem_for_pricing = 'N'
                            and pqca.is_active = 'Y'
                            and asm.is_active = 'Y'
                            and ppm.product_id = tmpc.conc_product_id
                            and nvl(ppm.deduct_for_wet_to_dry, 'N') = 'N'
                          group by tmpc.corporate_id,
                                   tmpc.conc_product_id,
                                   tmpc.conc_quality_id,
                                   pdm.product_desc,
                                   qat.quality_name,
                                   qat.quality_id,
                                   tmpc.product_id,
                                   tmpc.shipment_month,
                                   tmpc.shipment_year,
                                   tmpc.mvp_id,
                                   tmpc.valuation_point,
                                   tmpc.base_price_unit_id_in_ppu,
                                   pqca.element_id,
                                   aml.attribute_name)
      loop
      
        pkg_phy_pre_check_process.sp_calc_m2m_tc_pc_rc_charge(cc_penalty.corporate_id,
                                                              pd_trade_date,
                                                              cc_penalty.conc_product_id,
                                                              cc_penalty.conc_quality_id,
                                                              cc_penalty.mvp_id, --valuation_id
                                                              'Penalties', --charge_type
                                                              cc_penalty.element_id,
                                                              cc_penalty.shipment_month,
                                                              cc_penalty.shipment_year,
                                                              pn_charge_amt,
                                                              pc_charge_price_unit_id);
      
        if nvl(pn_charge_amt, 0) <> 0 then
          pn_charge_amt := pkg_phy_pre_check_process.f_get_converted_price(pc_corporate_id,
                                                                           pn_charge_amt,
                                                                           pc_charge_price_unit_id,
                                                                           cc_penalty.base_price_unit_id_in_ppu,
                                                                           pd_trade_date);
          update md_m2m_daily md
             set md.penalty_charge = pn_charge_amt
           where md.corporate_id = pc_corporate_id
             and md.product_type = 'CONCENTRATES'
             and md.conc_product_id = cc_penalty.conc_product_id
             and md.conc_quality_id = cc_penalty.conc_quality_id
             and md.product_id = cc_penalty.product_id
             and md.quality_id = cc_penalty.quality_id
             and md.shipment_month_year = cc_penalty.shipment_month || '-' ||
                 cc_penalty.shipment_year
             and md.mvp_id = cc_penalty.mvp_id
             and md.process_id = pc_process_id
             and md.element_id = cc_penalty.element_id
             and md.process_id = pc_process_id;
        end if;
      
      end loop;*/
      /** End of updatin the Treatment Charge,Refine Charge and  Penalty Charge of the MD table ***/
      vc_err_msg := 'line 2819';
      --Updating exg_id,settlement_price,settlement price avl date of the md table
      update md_m2m_daily md
         set (md.valuation_exchange_id, md.m2m_settlement_price, md.m2m_sett_price_available_date) = (select pdd.exchange_id,
                                                                                                             edq.price,
                                                                                                             edq.dq_trade_date
                                                                                                        from eodeom_derivative_quote_detail edq,
                                                                                                             pum_price_unit_master          pum,
                                                                                                             dim_der_instrument_master      dim,
                                                                                                             div_der_instrument_valuation   div,
                                                                                                             pdd_product_derivative_def     pdd
                                                                                                       where edq.dr_id =
                                                                                                             md.valuation_dr_id
                                                                                                         and edq.corporate_id =
                                                                                                             pc_corporate_id
                                                                                                         and dim.instrument_id =
                                                                                                             md.instrument_id
                                                                                                         and edq.instrument_id =
                                                                                                             div.instrument_id
                                                                                                         and dim.product_derivative_id =
                                                                                                             pdd.derivative_def_id
                                                                                                         and edq.price_source_id =
                                                                                                             div.price_source_id
                                                                                                         and div.price_unit_id =
                                                                                                             edq.price_unit_id
                                                                                                         and div.is_deleted = 'N'
                                                                                                         and edq.available_price_id =
                                                                                                             div.available_price_id
                                                                                                         and edq.price_unit_id =
                                                                                                             pum.price_unit_id
                                                                                                         and edq.price is not null
                                                                                                         and edq.process_id =
                                                                                                             pc_process_id
                                                                                                         and edq.dq_trade_date =
                                                                                                             pd_trade_date)
       where md.corporate_id = pc_corporate_id
         and md.product_type = 'CONCENTRATES'
         and md.is_tolling_contract = 'N'
         and md.is_tolling_extn = 'N'
         and md.valuation_method <> 'FIXED'
         and md.process_id = pc_process_id;
    
      vc_err_msg := 'line 2887';
      --update the m2m location -incoterm deviation for the within region of growth    
      update md_m2m_daily md
         set md.m2m_loc_incoterm_deviation = round(nvl((select sum(ldc.cost_value /
                                                                  nvl(vpp.weight,
                                                                      1) *
                                                                  pkg_general.f_get_converted_currency_amt(md.corporate_id,
                                                                                                           vpp.cur_id,
                                                                                                           md_base.cur_id,
                                                                                                           pd_trade_date,
                                                                                                           1) *
                                                                  (pkg_general.f_get_converted_quantity(md.product_id,
                                                                                                        vpp.weight_unit_id,
                                                                                                        md_base.weight_unit_id,
                                                                                                        1)))
                                                       
                                                         from lds_location_diff_setup ldh,
                                                              ldc_location_diff_cost  ldc,
                                                              v_ppu_pum               vpp,
                                                              pum_price_unit_master   md_base
                                                        where ldh.loc_diff_id =
                                                              ldc.loc_diff_id
                                                          and ldh.valuation_city_id =
                                                              md.valuation_city_id
                                                          and md.mvp_id =
                                                              ldh.valuation_point_id
                                                          and md.conc_product_id = --updated
                                                              ldh.product_id
                                                          and md_base.price_unit_id =
                                                              md.base_price_unit_id_in_pum
                                                          and md.product_type =
                                                              'CONCENTRATES'
                                                          and ldh.inco_term_id =
                                                              md.valuation_incoterm_id
                                                          and ldh.corporate_id =
                                                              pc_corporate_id
                                                          and ldc.cost_price_unit_id =
                                                              vpp.product_price_unit_id
                                                          and ldh.as_on_date =
                                                              (select max(ldh1.as_on_date)
                                                                 from lds_location_diff_setup ldh1
                                                                where ldh1.as_on_date <=
                                                                      pd_trade_date
                                                                  and ldh1.valuation_point_id =
                                                                      ldh.valuation_point_id
                                                                  and ldh1.inco_term_id =
                                                                      ldh.inco_term_id
                                                                  and ldh1.valuation_city_id =
                                                                      ldh.valuation_city_id
                                                                  and ldh1.product_id =
                                                                      ldh.product_id)),
                                                       0),
                                                   4)
       where md.corporate_id = pc_corporate_id
         and md.product_type = 'CONCENTRATES'
         and md.is_tolling_contract = 'N'
         and md.is_tolling_extn = 'N'
         and md.process_id = pc_process_id;
      vc_err_msg := 'line 3049';
      update md_m2m_daily md
         set md.net_m2m_price = nvl(md.m2m_settlement_price, 0)
       where md.corporate_id = pc_corporate_id
         and md.product_type = 'CONCENTRATES'
         and md.is_tolling_contract = 'N'
         and md.is_tolling_extn = 'N'
         and md.process_id = pc_process_id;
      --   dbms_output.put_line('after update -5 ');
      sp_write_log(pc_corporate_id,
                   pd_trade_date,
                   'sp_calc_m2m',
                   'before 5');
      vc_err_msg := 'line 3068';
    
      /*update md_m2m_daily md
        set (valuation_location, reference_location, valuation_incoterm, valuation_location_country, reference_location_country) = (select cim_val_loc.city_name,
                                                                                                                                           cim_ref_loc.city_name,
                                                                                                                                           itm.incoterm,
                                                                                                                                           cim_val_loc_v.country_name,
                                                                                                                                           cim_ref_loc_r.country_name
                                                                                                                                      from cim_citymaster      cim_val_loc,
                                                                                                                                           cim_citymaster      cim_ref_loc,
                                                                                                                                           cym_countrymaster   cim_val_loc_v,
                                                                                                                                           cym_countrymaster   cim_ref_loc_r,
                                                                                                                                           itm_incoterm_master itm
                                                                                                                                     where md.valuation_city_id =
                                                                                                                                           cim_val_loc.city_id
                                                                                                                                       and md.product_type =
                                                                                                                                           'CONCENTRATES'
                                                                                                                                       and md.refernce_location_id =
                                                                                                                                           cim_ref_loc.city_id
                                                                                                                                       and cim_val_loc_v.country_id =
                                                                                                                                           cim_val_loc.country_id
                                                                                                                                       and cim_ref_loc_r.country_id =
                                                                                                                                           cim_ref_loc.country_id
                                                                                                                                       and md.valuation_incoterm_id =
                                                                                                                                           itm.incoterm_id)
      where md.corporate_id = pc_corporate_id
        and md.process_id = pc_process_id;*/
      vc_err_msg := 'line 3090';
      sp_write_log(pc_corporate_id,
                   pd_trade_date,
                   'sp_calc_m2m',
                   'before 6');
      --  dbms_output.put_line('after update -6 ');
      -- update derivative def id/name
      update md_m2m_daily md
         set (derivative_def_id, derivative_def_name) = (select pdd.derivative_def_id,
                                                                pdd.derivative_def_name
                                                           from dim_der_instrument_master  dim,
                                                                pdd_product_derivative_def pdd,
                                                                irm_instrument_type_master irm
                                                          where dim.instrument_id =
                                                                md.instrument_id
                                                            and md.product_type =
                                                                'CONCENTRATES'
                                                            and dim.product_derivative_id =
                                                                pdd.derivative_def_id
                                                            and dim.instrument_type_id =
                                                                irm.instrument_type_id
                                                            and irm.instrument_type =
                                                                'Future'
                                                            and rownum <= 1)
       where md.corporate_id = pc_corporate_id
         and md.product_type = 'CONCENTRATES'
         and md.is_tolling_contract = 'N'
         and md.is_tolling_extn = 'N'
         and md.process_id = pc_process_id;
    
      --get the m2m_price_unit_cur_id
      sp_write_log(pc_corporate_id,
                   pd_trade_date,
                   'sp_calc_m2m',
                   'before 7');
      vc_err_msg := 'line 3121';
      update md_m2m_daily md
         set (md.m2m_main_cur_id, md.m2m_main_cur_code, md.m2m_main_cur_decimals, md.main_currency_factor) = (select (case
                                                                                                                       when cm.is_sub_cur = 'Y' then
                                                                                                                        scd.cur_id
                                                                                                                       else
                                                                                                                        cm.cur_id
                                                                                                                     end) base_currency_id,
                                                                                                                     (case
                                                                                                                       when cm.is_sub_cur = 'Y' then
                                                                                                                        cm_1.cur_code
                                                                                                                       else
                                                                                                                        cm.cur_code
                                                                                                                     end) cur_code,
                                                                                                                     (case
                                                                                                                       when cm.is_sub_cur = 'Y' then
                                                                                                                        cm_1.decimals
                                                                                                                       else
                                                                                                                        cm.decimals
                                                                                                                     end),
                                                                                                                     (case
                                                                                                                       when cm.is_sub_cur = 'Y' then
                                                                                                                        nvl(scd.factor,
                                                                                                                            1)
                                                                                                                       else
                                                                                                                        1
                                                                                                                     end) factor
                                                                                                                from cm_currency_master      cm,
                                                                                                                     scd_sub_currency_detail scd,
                                                                                                                     cm_currency_master      cm_1
                                                                                                               where cm.cur_id =
                                                                                                                     md.m2m_price_unit_cur_id
                                                                                                                 and cm.cur_id =
                                                                                                                     scd.sub_cur_id(+)
                                                                                                                 and scd.cur_id =
                                                                                                                     cm_1.cur_id(+))
       where md.process_id = pc_process_id
         and md.product_type = 'CONCENTRATES'
         and md.is_tolling_contract = 'N'
         and md.is_tolling_extn = 'N';
      sp_write_log(pc_corporate_id,
                   pd_trade_date,
                   'sp_calc_m2m',
                   'before 8');
      --  dbms_output.put_line('after update -8 ');
      -- now update the m2m id in the tmpc_temp_m2m_pre_check
      -- table per contract item level,gmr level,grd level --
      vc_err_msg := 'line 3163';
      for c1 in (select md.md_id,
                        md.conc_product_id,
                        md.conc_quality_id,
                        md.corporate_id,
                        md.product_id,
                        md.element_id,
                        md.crop_year_id,
                        md.quality_id,
                        md.origin_id,
                        md.origin_group_id,
                        md.growth_code_id,
                        md.valuation_method,
                        md.mvp_id,
                        md.mvpl_id,
                        md.valuation_region,
                        md.valuation_point,
                        md.valuation_incoterm_id,
                        md.valuation_city_id,
                        md.valuation_basis,
                        md.reference_incoterm,
                        md.refernce_location_id refernce_location,
                        md.instrument_id,
                        md.valuation_dr_id,
                        md.valuation_month,
                        md.valuation_date,
                        md.shipment_month_year,
                        md.shipment_date,
                        md.rate_type
                   from md_m2m_daily md
                  where md.corporate_id = pc_corporate_id
                    and md.product_type = 'CONCENTRATES'
                    and md.is_tolling_contract = 'N'
                    and md.is_tolling_extn = 'N'
                    and md.process_id = pc_process_id)
      loop
        if c1.valuation_method <> 'FIXED' then
          update tmpc_temp_m2m_pre_check tmpc
             set tmpc.internal_m2m_id = c1.md_id
           where tmpc.corporate_id = c1.corporate_id
             and tmpc.product_id = c1.product_id
             and tmpc.conc_product_id = c1.conc_product_id
             and tmpc.conc_quality_id = c1.conc_quality_id
             and tmpc.element_id = c1.element_id
             and tmpc.quality_id = c1.quality_id
             and tmpc.mvp_id = c1.mvp_id
             and tmpc.mvpl_id = c1.mvpl_id
             and tmpc.valuation_region = c1.valuation_region
             and tmpc.valuation_point = c1.valuation_point
             and tmpc.valuation_incoterm_id = c1.valuation_incoterm_id
             and tmpc.valuation_city_id = c1.valuation_city_id
             and tmpc.valuation_basis = c1.valuation_basis
             and tmpc.valuation_dr_id = c1.valuation_dr_id
             and tmpc.reference_incoterm = c1.reference_incoterm
             and tmpc.refernce_location = c1.refernce_location
             and tmpc.instrument_id = c1.instrument_id
             and tmpc.shipment_date = c1.shipment_date
             and tmpc.shipment_month || '-' || tmpc.shipment_year =
                 c1.shipment_month_year
             and decode(tmpc.section_name, 'OPEN', 'OPEN', 'STOCK') =
                 c1.rate_type
             and tmpc.product_type = 'CONCENTRATES'
             and tmpc.is_tolling_contract = 'N'
             and tmpc.is_tolling_extn = 'N';
        else
          update tmpc_temp_m2m_pre_check tmpc
             set tmpc.internal_m2m_id = c1.md_id
           where tmpc.corporate_id = c1.corporate_id
             and tmpc.conc_product_id = c1.conc_product_id
             and tmpc.conc_quality_id = c1.conc_quality_id
             and tmpc.product_id = c1.product_id
             and tmpc.quality_id = c1.quality_id
             and tmpc.element_id = c1.element_id
             and tmpc.mvp_id = c1.mvp_id
             and tmpc.mvpl_id = c1.mvpl_id
             and tmpc.valuation_region = c1.valuation_region
             and tmpc.valuation_point = c1.valuation_point
             and tmpc.valuation_incoterm_id = c1.valuation_incoterm_id
             and tmpc.valuation_city_id = c1.valuation_city_id
             and tmpc.valuation_basis = c1.valuation_basis
             and tmpc.reference_incoterm = c1.reference_incoterm
             and tmpc.refernce_location = c1.refernce_location
                --and tmpc.instrument_id = c1.instrument_id
             and tmpc.shipment_date = c1.shipment_date
             and tmpc.shipment_month || '-' || tmpc.shipment_year =
                 c1.shipment_month_year
             and decode(tmpc.section_name, 'OPEN', 'OPEN', 'STOCK') =
                 c1.rate_type
             and tmpc.product_type = 'CONCENTRATES'
             and tmpc.is_tolling_contract = 'N'
             and tmpc.is_tolling_extn = 'N';
        end if;
      end loop;
    
      --update valuation_location, reference_location and valuation_incoterm
    
      for cc in (select tmpc.internal_m2m_id,
                        tmpc.product_id,
                        cim_val_loc.city_name valuation_location,
                        cim_ref_loc.city_name reference_location,
                        itm.incoterm valuation_incoterm,
                        cim_val_loc_v.country_name valuation_location_country,
                        cim_ref_loc_r.country_name reference_location_country
                   from tmpc_temp_m2m_pre_check tmpc,
                        cim_citymaster          cim_val_loc,
                        cim_citymaster          cim_ref_loc,
                        cym_countrymaster       cim_val_loc_v,
                        cym_countrymaster       cim_ref_loc_r,
                        itm_incoterm_master     itm
                  where tmpc.valuation_city_id = cim_val_loc.city_id
                    and tmpc.refernce_location = cim_ref_loc.city_id
                    and cim_val_loc_v.country_id = cim_val_loc.country_id
                    and cim_ref_loc_r.country_id = cim_ref_loc.country_id
                    and tmpc.valuation_incoterm_id = itm.incoterm_id
                    and tmpc.corporate_id = pc_corporate_id
                    and tmpc.product_type = 'CONCENTRATES'
                    and tmpc.is_tolling_contract = 'N'
                    and tmpc.is_tolling_extn = 'N'
                  group by cim_val_loc.city_name,
                           cim_ref_loc.city_name,
                           itm.incoterm,
                           cim_val_loc_v.country_name,
                           cim_ref_loc_r.country_name,
                           tmpc.product_id,
                           tmpc.internal_m2m_id)
      loop
      
        update md_m2m_daily md
           set valuation_location         = cc.valuation_location,
               reference_location         = cc.reference_location,
               valuation_incoterm         = cc.valuation_incoterm,
               valuation_location_country = cc.valuation_location_country,
               reference_location_country = cc.reference_location_country
         where md.md_id = cc.internal_m2m_id
           and md.product_id = cc.product_id
           and md.process_id = pc_process_id;
        commit;
      end loop;
    
    end;
    --  dbms_output.put_line('after allll');
    sp_write_log(pc_corporate_id, pd_trade_date, 'sp_calc_m2m', 'Done');
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure pkg_phy_physical_process.sp_calc_m2m_conc_cost',
                                                           'M2M-013',
                                                           'Code:' ||
                                                           sqlcode ||
                                                           'Message:' ||
                                                           sqlerrm ||
                                                           vc_err_msg,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;

  procedure sp_calc_m2m_tolling_extn_cost(pc_corporate_id varchar2,
                                          pd_trade_date   date,
                                          pc_process_id   varchar2,
                                          pc_user_id      varchar2) is
    --------------------------------------------------------------------------------------------------------------------------
    --        procedure name                            : sp_calc_m2m_cost
    --        author                                    :
    --        created date                              : 11th Jan 2011
    --        purpose                                   : populate secondary costs for contracts and gmrs
    --        parameters
    --        pc_corporate_id                           : corporate id
    --        pc_process_id                             : eod reference no
    --        modification history
    --        modified date                             :
    --        modified by                               :
    --        modify description                        :
    --------------------------------------------------------------------------------------------------------------------------
    vn_serial_no       number;
    vobj_error_log     tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count number := 1;
    vc_err_msg         varchar2(100);
    --vn_qat_premimum_amt     number(25, 5);
    --vn_pdm_premimum_amt     number(25, 5);
    --vn_cp_price             number;
    --vc_cp_price_unit_id     varchar2(20);
    --vn_total_pc_charge      number;
    --vn_total_tc_charge      number;
    --vn_total_rc_charge      number;
    --vc_tc_cur_id            varchar2(20);
    --vc_pc_cur_id            varchar2(20);
    pn_charge_amt           number;
    pc_charge_price_unit_id varchar2(25);
  begin
    --generate unique m2m data with m2m id
    vc_err_msg := 'before generate Unique M2M data with M2M ID';
    begin
      vn_serial_no := 1;
      for cc in (select t.corporate_id,
                        t.conc_product_id,
                        t.conc_quality_id,
                        t.product_id,
                        t.quality_id,
                        t.element_id,
                        t.product_type,
                        t.mvp_id,
                        t.mvpl_id,
                        t.value_type,
                        t.valuation_region,
                        t.valuation_point,
                        t.valuation_incoterm_id,
                        t.valuation_city_id,
                        t.valuation_basis,
                        t.reference_incoterm,
                        t.refernce_location,
                        t.instrument_id,
                        t.valuation_dr_id,
                        t.price_basis as valuation_method,
                        t.m2m_price_unit_id,
                        pum.cur_id m2m_price_unit_cur_id,
                        cm.cur_code,
                        pum.weight_unit_id,
                        qum.qty_unit,
                        nvl(pum.weight, 1) as weight,
                        t.derivative_def_id,
                        t.valuation_month || '-' || t.valuation_year valuation_period,
                        t.valuation_date,
                        t.shipment_month || '-' || t.shipment_year shipment_month_year,
                        t.shipment_date,
                        decode(t.section_name, 'OPEN', 'OPEN', 'STOCK') rate_type,
                        pum.cur_id valuation_cur_id,
                        t.base_price_unit_id_in_ppu,
                        t.base_price_unit_id_in_pum,
                        t.is_tolling_contract,
                        t.is_tolling_extn
                   from tmpc_temp_m2m_pre_check  t,
                        pum_price_unit_master    pum,
                        cm_currency_master       cm,
                        qum_quantity_unit_master qum
                  where t.corporate_id = pc_corporate_id
                    and t.m2m_price_unit_id = pum.price_unit_id(+)
                    and pum.cur_id = cm.cur_id(+)
                    and pum.weight_unit_id = qum.qty_unit_id(+)
                    and t.product_type = 'CONCENTRATES'
                    and t.is_tolling_contract = 'Y'
                    and t.is_tolling_extn = 'Y'
                  group by t.corporate_id,
                           t.conc_product_id,
                           t.conc_quality_id,
                           t.product_id,
                           t.element_id,
                           t.product_type,
                           t.mvp_id,
                           t.mvpl_id,
                           t.value_type,
                           t.valuation_region,
                           t.valuation_point,
                           t.valuation_incoterm_id,
                           t.valuation_city_id,
                           t.valuation_basis,
                           t.reference_incoterm,
                           t.refernce_location,
                           t.instrument_id,
                           t.valuation_dr_id,
                           t.price_basis,
                           pum.cur_id,
                           t.m2m_price_unit_id,
                           t.m2m_price_unit_cur_id,
                           cm.cur_code,
                           pum.weight_unit_id,
                           qum.qty_unit,
                           nvl(pum.weight, 1),
                           t.quality_id,
                           t.derivative_def_id,
                           t.valuation_month || '-' || t.valuation_year,
                           t.valuation_date,
                           t.shipment_month || '-' || t.shipment_year,
                           t.shipment_date,
                           --this bit is important since for the same dr_id , open contract use forward rates and
                           --stock uses spot. tmef has been populated for both types
                           decode(t.section_name, 'OPEN', 'OPEN', 'STOCK'),
                           t.valuation_cur_id,
                           t.base_price_unit_id_in_ppu,
                           t.base_price_unit_id_in_pum,
                           t.is_tolling_contract,
                           t.is_tolling_extn)
      loop
        insert into md_m2m_daily
          (md_id,
           process_id,
           corporate_id,
           conc_product_id,
           conc_quality_id,
           product_id,
           quality_id,
           element_id,
           product_type,
           mvp_id,
           mvpl_id,
           valuation_region,
           valuation_point,
           valuation_incoterm_id,
           valuation_city_id,
           valuation_basis,
           reference_incoterm,
           refernce_location_id,
           instrument_id,
           valuation_dr_id,
           m2m_price_unit_id,
           m2m_price_unit_cur_id,
           m2m_price_unit_cur_code,
           m2m_price_unit_weight_unit_id,
           m2m_price_unit_weight_unit,
           m2m_price_unit_weight,
           valuation_month,
           valuation_future_contract,
           derivative_def_id,
           valuation_date,
           shipment_month_year,
           shipment_date,
           rate_type,
           valuation_cur_id,
           base_price_unit_id_in_ppu,
           base_price_unit_id_in_pum,
           valuation_method,
           is_tolling_contract,
           is_tolling_extn)
        values
          ('MDE-' || vn_serial_no,
           pc_process_id,
           cc.corporate_id,
           cc.conc_product_id,
           cc.conc_quality_id,
           cc.product_id,
           cc.quality_id,
           cc.element_id,
           cc.product_type,
           cc.mvp_id,
           cc.mvpl_id,
           cc.valuation_region,
           cc.valuation_point,
           cc.valuation_incoterm_id,
           cc.valuation_city_id,
           cc.valuation_basis,
           cc.reference_incoterm,
           cc.refernce_location,
           cc.instrument_id,
           cc.valuation_dr_id,
           cc.m2m_price_unit_id,
           cc.m2m_price_unit_cur_id,
           cc.cur_code,
           cc.weight_unit_id,
           cc.qty_unit,
           cc.weight,
           cc.valuation_period,
           cc.valuation_dr_id,
           cc.derivative_def_id,
           cc.valuation_date,
           cc.shipment_month_year,
           cc.shipment_date,
           cc.rate_type,
           cc.valuation_cur_id,
           cc.base_price_unit_id_in_ppu,
           cc.base_price_unit_id_in_pum,
           cc.value_type,
           cc.is_tolling_contract,
           cc.is_tolling_extn);
        vn_serial_no := vn_serial_no + 1;
      end loop;
      --Checking for the treatment  is there or not
      --For this  we are calling the sp_get_treatment_charge
      /*  for cc1 in (select tmpc.internal_contract_item_ref_no,
                                         tmpc.conc_product_id,
                                         tmpc.conc_quality_id,
                                         tmpc.element_id,
                                         tmpc.product_id,
                                         tmpc.quality_id,
                                         pc_process_id,
                                         pci.item_qty,
                                         pci.item_qty_unit_id,
                                         vn_cp_price,
                                         vc_cp_price_unit_id
                                          from tmpc_temp_m2m_pre_check tmpc,
                                                    pci_physical_contract_item    pci
                                                    where  pci.internal_contract_item_ref_no=
                                                    tmpc.internal_contract_item_ref_no
                                                    and tmpc.product_type='CONCENTRATES' ) loop      
        sp_get_treatment_charge(cc1.internal_contract_item_ref_no,
                                                               cc1.element_id,
                                                               pc_process_id,
                                                               cc1.item_qty,
                                                               cc1.item_qty_unit_id,
                                                               cc1.vn_cp_price,
                                                               cc1.vc_cp_price_unit_id,
                                                               vn_total_tc_charge,
                                                               vc_tc_cur_id);
                                                               
        --if  vn_total_tc_charge  is zero or null we have to raise the exception
        --else 
        if nvl(vn_total_tc_charge,0)<>0   then
           update md_m2m_daily md
           set md.treatment_charge=vn_total_tc_charge
           where md.corporate_id =pc_corporate_id
             and md.product_type='CONCENTRATES'
             and md.conc_product_id=cc1.conc_product_id
             and md.conc_quality_id=cc1.conc_quality_id
             and md.product_id=cc1.product_id
             and md.quality_id=cc1.quality_id
             and md.element_id=cc1.element_id
             and md.process_id=pc_process_id;
            end if;
      end loop;
      
      --Check theRefine Charege is there or not
      --If Refine charge  is  there we will update the md table
      --for this we are calling the sp_get_refine_chage
      for cc_rc  in (select tmpc.internal_contract_item_ref_no,
                                         tmpc.conc_product_id,
                                         tmpc.conc_quality_id,
                                         tmpc.element_id,
                                         tmpc.product_id,
                                         tmpc.quality_id,
                                         pc_process_id,
                                         pci.item_qty,
                                         pci.item_qty_unit_id,
                                         vn_cp_price,
                                         vc_cp_price_unit_id
                                          from tmpc_temp_m2m_pre_check tmpc,
                                                    pci_physical_contract_item    pci
                                                    where  pci.internal_contract_item_ref_no=
                                                    tmpc.internal_contract_item_ref_no
                                                    and tmpc.product_type='CONCENTRATES' ) loop      
        sp_get_refine_charge( cc_rc.internal_contract_item_ref_no,
                                                                cc_rc.element_id,
                                                               pc_process_id,
                                                                cc_rc.item_qty,
                                                                cc_rc.item_qty_unit_id,
                                                                cc_rc.vn_cp_price,
                                                                cc_rc.vc_cp_price_unit_id,
                                                               vn_total_rc_charge,
                                                               vc_tc_cur_id);
                                                               
        --if  vn_total_tc_charge  is zero or null we have to raise the exception
        --else we have to update the md table
        if nvl(vn_total_rc_charge,0)<>0   then
           update md_m2m_daily md
           set md.refine_charge=vn_total_rc_charge
           where md.corporate_id =pc_corporate_id
             and md.product_type='CONCENTRATES'
             and md.conc_product_id= cc_rc.conc_product_id
             and md.conc_quality_id= cc_rc.conc_quality_id
             and md.product_id= cc_rc.product_id
             and md.quality_id= cc_rc.quality_id
             and md.element_id= cc_rc.element_id
             and md.process_id=pc_process_id;
            end if;
      end loop;
      --calling the sp_get_penalty_charge
      for cc_pc  in (select tmpc.internal_contract_item_ref_no,
                                         tmpc.conc_product_id,
                                         tmpc.conc_quality_id,
                                         tmpc.element_id,
                                         tmpc.product_id,
                                         tmpc.quality_id,
                                         pc_process_id,
                                         pci.item_qty,
                                         pci.item_qty_unit_id,
                                         vn_cp_price,
                                         vc_cp_price_unit_id
                                          from tmpc_temp_m2m_pre_check tmpc,
                                                    pci_physical_contract_item    pci
                                                    where  pci.internal_contract_item_ref_no=
                                                    tmpc.internal_contract_item_ref_no
                                                    and tmpc.product_type='CONCENTRATES' ) loop  
        sp_get_penalty_charge( cc_pc.internal_contract_item_ref_no,
                                                           cc_pc.element_id,
                                                           pc_process_id,
                                                           cc_pc.item_qty,
                                                           cc_pc.item_qty_unit_id,
                                                           vn_total_pc_charge,
                                                           vc_pc_cur_id);
                                                               
        --if  vn_total_pc_charge  is zero or null we have to raise the exception
        --else we have to update the md table
        if nvl(vn_total_pc_charge,0)<> 0   then
           update md_m2m_daily md
           set md.penalty_charge=vn_total_pc_charge
           where md.corporate_id =pc_corporate_id
             and md.product_type='CONCENTRATES'
             and md.conc_product_id= cc_pc.conc_product_id
             and md.conc_quality_id= cc_pc.conc_quality_id
             and md.product_id= cc_pc.product_id
             and md.quality_id= cc_pc.quality_id
             and md.element_id= cc_pc.element_id
             and md.process_id=pc_process_id;
            end if;
      end loop;*/
    
      for cc_tmpc in (select tmpc.corporate_id,
                             tmpc.conc_product_id,
                             tmpc.conc_quality_id,
                             tmpc.product_id,
                             tmpc.quality_id,
                             tmpc.element_id,
                             tmpc.base_price_unit_id_in_ppu,
                             tmpc.shipment_month,
                             tmpc.shipment_year,
                             tmpc.mvp_id valuation_point_id,
                             ppu.decimals
                        from tmpc_temp_m2m_pre_check tmpc,
                             pdm_productmaster       pdm,
                             qat_quality_attributes  qat,
                             ppu_product_price_units ppu
                       where tmpc.product_type = 'CONCENTRATES'
                         and tmpc.is_tolling_contract = 'Y'
                         and tmpc.is_tolling_extn = 'Y'
                         and tmpc.corporate_id = pc_corporate_id
                         and tmpc.conc_product_id = pdm.product_id
                         and tmpc.conc_quality_id = qat.quality_id
                         and tmpc.base_price_unit_id_in_ppu =
                             ppu.internal_price_unit_id
                       group by tmpc.corporate_id,
                                tmpc.conc_product_id,
                                tmpc.conc_quality_id,
                                tmpc.product_id,
                                tmpc.quality_id,
                                tmpc.base_price_unit_id_in_ppu,
                                tmpc.element_id,
                                tmpc.mvp_id,
                                tmpc.shipment_month,
                                tmpc.shipment_year,
                                ppu.decimals)
      loop
        -- updating treatment charge  to the md table
        pkg_phy_pre_check_process.sp_calc_m2m_tc_pc_rc_charge(cc_tmpc.corporate_id,
                                                              pd_trade_date,
                                                              cc_tmpc.conc_product_id,
                                                              cc_tmpc.conc_quality_id,
                                                              cc_tmpc.valuation_point_id, --valuation_id
                                                              'Treatment Charges', --charge_type
                                                              cc_tmpc.element_id,
                                                              cc_tmpc.shipment_month,
                                                              cc_tmpc.shipment_year,
                                                              cc_tmpc.base_price_unit_id_in_ppu,
                                                              pn_charge_amt,
                                                              pc_charge_price_unit_id);
      
        /* if nvl(pn_charge_amt, 0) <> 0 then
        pn_charge_amt := round(pkg_phy_pre_check_process.f_get_converted_price(pc_corporate_id,
                                                                               pn_charge_amt,
                                                                               pc_charge_price_unit_id,
                                                                               cc_tmpc.base_price_unit_id_in_ppu,
                                                                               pd_trade_date),
                               cc_tmpc.decimals);*/
        update md_m2m_daily md
           set md.treatment_charge = pn_charge_amt,
               md.tc_price_unit_id = pc_charge_price_unit_id
         where md.corporate_id = pc_corporate_id
           and md.product_type = 'CONCENTRATES'
           and md.is_tolling_contract = 'Y'
           and md.is_tolling_extn = 'Y'
           and md.conc_product_id = cc_tmpc.conc_product_id
           and md.conc_quality_id = cc_tmpc.conc_quality_id
           and md.product_id = cc_tmpc.product_id
           and md.quality_id = cc_tmpc.quality_id
           and md.shipment_month_year =
               cc_tmpc.shipment_month || '-' || cc_tmpc.shipment_year
           and md.mvp_id = cc_tmpc.valuation_point_id
           and md.process_id = pc_process_id
           and md.element_id = cc_tmpc.element_id
           and md.process_id = pc_process_id;
        -- end if;
        -- updating refine  charge  to the md table
        pkg_phy_pre_check_process.sp_calc_m2m_tc_pc_rc_charge(cc_tmpc.corporate_id,
                                                              pd_trade_date,
                                                              cc_tmpc.conc_product_id,
                                                              cc_tmpc.conc_quality_id,
                                                              cc_tmpc.valuation_point_id,
                                                              'Refining Charges',
                                                              cc_tmpc.element_id,
                                                              cc_tmpc.shipment_month,
                                                              cc_tmpc.shipment_year,
                                                              cc_tmpc.base_price_unit_id_in_ppu,
                                                              pn_charge_amt,
                                                              pc_charge_price_unit_id);
      
        /*if nvl(pn_charge_amt, 0) <> 0 then
        pn_charge_amt := round(pkg_phy_pre_check_process.f_get_converted_price(pc_corporate_id,
                                                                               pn_charge_amt,
                                                                               pc_charge_price_unit_id,
                                                                               cc_tmpc.base_price_unit_id_in_ppu,
                                                                               pd_trade_date),
                               cc_tmpc.decimals);*/
        update md_m2m_daily md
           set md.refine_charge    = pn_charge_amt,
               md.rc_price_unit_id = pc_charge_price_unit_id
         where md.corporate_id = pc_corporate_id
           and md.product_type = 'CONCENTRATES'
           and md.is_tolling_contract = 'Y'
           and md.is_tolling_extn = 'Y'
           and md.conc_product_id = cc_tmpc.conc_product_id
           and md.conc_quality_id = cc_tmpc.conc_quality_id
           and md.product_id = cc_tmpc.product_id
           and md.quality_id = cc_tmpc.quality_id
           and md.shipment_month_year =
               cc_tmpc.shipment_month || '-' || cc_tmpc.shipment_year
           and md.mvp_id = cc_tmpc.valuation_point_id
           and md.process_id = pc_process_id
           and md.element_id = cc_tmpc.element_id
           and md.process_id = pc_process_id;
        -- end if;
      end loop;
      -- updating penalty  charge  to the md table 
      /*for cc_penalty in (select tmpc.corporate_id,
                                tmpc.conc_product_id,
                                tmpc.conc_quality_id,
                                pdm.product_desc,
                                qat.quality_name,
                                qat.quality_id,
                                tmpc.product_id,
                                tmpc.shipment_month,
                                tmpc.shipment_year,
                                tmpc.mvp_id,
                                tmpc.valuation_point,
                                pqca.element_id,
                                tmpc.base_price_unit_id_in_ppu,
                                aml.attribute_name
                           from ash_assay_header               ash,
                                asm_assay_sublot_mapping       asm,
                                aml_attribute_master_list      aml,
                                pqca_pq_chemical_attributes    pqca,
                                rm_ratio_master                rm,
                                ppm_product_properties_mapping ppm,
                                tmpc_temp_m2m_pre_check        tmpc,
                                pdm_productmaster              pdm,
                                qat_quality_attributes         qat
                          where ash.ash_id = tmpc.assay_header_id
                            and tmpc.conc_product_id = pdm.product_id
                            and ash.ash_id = asm.ash_id
                            and asm.asm_id = pqca.asm_id
                            and pqca.unit_of_measure = rm.ratio_id
                            and pqca.element_id = aml.attribute_id
                            and ppm.attribute_id = aml.attribute_id
                            and tmpc.corporate_id = pc_corporate_id
                            and tmpc.conc_quality_id = qat.quality_id
                            and pqca.is_elem_for_pricing = 'N'
                            and pqca.is_active = 'Y'
                            and asm.is_active = 'Y'
                            and ppm.product_id = tmpc.conc_product_id
                            and nvl(ppm.deduct_for_wet_to_dry, 'N') = 'N'
                          group by tmpc.corporate_id,
                                   tmpc.conc_product_id,
                                   tmpc.conc_quality_id,
                                   pdm.product_desc,
                                   qat.quality_name,
                                   qat.quality_id,
                                   tmpc.product_id,
                                   tmpc.shipment_month,
                                   tmpc.shipment_year,
                                   tmpc.mvp_id,
                                   tmpc.valuation_point,
                                   tmpc.base_price_unit_id_in_ppu,
                                   pqca.element_id,
                                   aml.attribute_name)
      loop
      
        pkg_phy_pre_check_process.sp_calc_m2m_tc_pc_rc_charge(cc_penalty.corporate_id,
                                                              pd_trade_date,
                                                              cc_penalty.conc_product_id,
                                                              cc_penalty.conc_quality_id,
                                                              cc_penalty.mvp_id, --valuation_id
                                                              'Penalties', --charge_type
                                                              cc_penalty.element_id,
                                                              cc_penalty.shipment_month,
                                                              cc_penalty.shipment_year,
                                                              pn_charge_amt,
                                                              pc_charge_price_unit_id);
      
        if nvl(pn_charge_amt, 0) <> 0 then
          pn_charge_amt := pkg_phy_pre_check_process.f_get_converted_price(pc_corporate_id,
                                                                           pn_charge_amt,
                                                                           pc_charge_price_unit_id,
                                                                           cc_penalty.base_price_unit_id_in_ppu,
                                                                           pd_trade_date);
          update md_m2m_daily md
             set md.penalty_charge = pn_charge_amt
           where md.corporate_id = pc_corporate_id
             and md.product_type = 'CONCENTRATES'
             and md.conc_product_id = cc_penalty.conc_product_id
             and md.conc_quality_id = cc_penalty.conc_quality_id
             and md.product_id = cc_penalty.product_id
             and md.quality_id = cc_penalty.quality_id
             and md.shipment_month_year = cc_penalty.shipment_month || '-' ||
                 cc_penalty.shipment_year
             and md.mvp_id = cc_penalty.mvp_id
             and md.process_id = pc_process_id
             and md.element_id = cc_penalty.element_id
             and md.process_id = pc_process_id;
        end if;
      
      end loop;*/
      /** End of updatin the Treatment Charge,Refine Charge and  Penalty Charge of the MD table ***/
      vc_err_msg := 'line 2819';
      --Updating exg_id,settlement_price,settlement price avl date of the md table
      update md_m2m_daily md
         set (md.valuation_exchange_id, md.m2m_settlement_price, md.m2m_sett_price_available_date) = (select pdd.exchange_id,
                                                                                                             edq.price,
                                                                                                             edq.dq_trade_date
                                                                                                        from eodeom_derivative_quote_detail edq,
                                                                                                             pum_price_unit_master          pum,
                                                                                                             dim_der_instrument_master      dim,
                                                                                                             div_der_instrument_valuation   div,
                                                                                                             pdd_product_derivative_def     pdd
                                                                                                       where edq.dr_id =
                                                                                                             md.valuation_dr_id
                                                                                                         and edq.corporate_id =
                                                                                                             pc_corporate_id
                                                                                                         and dim.instrument_id =
                                                                                                             md.instrument_id
                                                                                                         and edq.instrument_id =
                                                                                                             div.instrument_id
                                                                                                         and dim.product_derivative_id =
                                                                                                             pdd.derivative_def_id
                                                                                                         and edq.price_source_id =
                                                                                                             div.price_source_id
                                                                                                         and div.price_unit_id =
                                                                                                             edq.price_unit_id
                                                                                                         and div.is_deleted = 'N'
                                                                                                         and edq.available_price_id =
                                                                                                             div.available_price_id
                                                                                                         and edq.price_unit_id =
                                                                                                             pum.price_unit_id
                                                                                                         and edq.price is not null
                                                                                                         and edq.process_id =
                                                                                                             pc_process_id
                                                                                                         and edq.dq_trade_date =
                                                                                                             pd_trade_date)
       where md.corporate_id = pc_corporate_id
         and md.product_type = 'CONCENTRATES'
         and md.is_tolling_contract = 'Y'
         and md.is_tolling_extn = 'Y'
         and md.valuation_method <> 'FIXED'
         and md.process_id = pc_process_id;
    
      vc_err_msg := 'line 2887';
      --update the m2m location -incoterm deviation for the within region of growth    
      update md_m2m_daily md
         set md.m2m_loc_incoterm_deviation = round(nvl((select sum(ldc.cost_value /
                                                                  nvl(vpp.weight,
                                                                      1) *
                                                                  pkg_general.f_get_converted_currency_amt(md.corporate_id,
                                                                                                           vpp.cur_id,
                                                                                                           md_base.cur_id,
                                                                                                           pd_trade_date,
                                                                                                           1) *
                                                                  (pkg_general.f_get_converted_quantity(md.product_id,
                                                                                                        vpp.weight_unit_id,
                                                                                                        md_base.weight_unit_id,
                                                                                                        1)))
                                                       
                                                         from lds_location_diff_setup ldh,
                                                              ldc_location_diff_cost  ldc,
                                                              v_ppu_pum               vpp,
                                                              pum_price_unit_master   md_base
                                                        where ldh.loc_diff_id =
                                                              ldc.loc_diff_id
                                                          and ldh.valuation_city_id =
                                                              md.valuation_city_id
                                                          and md.mvp_id =
                                                              ldh.valuation_point_id
                                                          and md.conc_product_id = --updated
                                                              ldh.product_id
                                                          and md_base.price_unit_id =
                                                              md.base_price_unit_id_in_pum
                                                          and md.product_type =
                                                              'CONCENTRATES'
                                                          and ldh.inco_term_id =
                                                              md.valuation_incoterm_id
                                                          and ldh.corporate_id =
                                                              pc_corporate_id
                                                          and ldc.cost_price_unit_id =
                                                              vpp.product_price_unit_id
                                                          and ldh.as_on_date =
                                                              (select max(ldh1.as_on_date)
                                                                 from lds_location_diff_setup ldh1
                                                                where ldh1.as_on_date <=
                                                                      pd_trade_date
                                                                  and ldh1.valuation_point_id =
                                                                      ldh.valuation_point_id
                                                                  and ldh1.inco_term_id =
                                                                      ldh.inco_term_id
                                                                  and ldh1.valuation_city_id =
                                                                      ldh.valuation_city_id
                                                                  and ldh1.product_id =
                                                                      ldh.product_id)),
                                                       0),
                                                   4)
       where md.corporate_id = pc_corporate_id
         and md.product_type = 'CONCENTRATES'
         and md.is_tolling_contract = 'Y'
         and md.is_tolling_extn = 'Y'
         and md.process_id = pc_process_id;
      vc_err_msg := 'line 3049';
      update md_m2m_daily md
         set md.net_m2m_price = nvl(md.m2m_settlement_price, 0)
       where md.corporate_id = pc_corporate_id
         and md.product_type = 'CONCENTRATES'
         and md.process_id = pc_process_id
         and md.is_tolling_contract = 'Y'
         and md.is_tolling_extn = 'Y';
      --   dbms_output.put_line('after update -5 ');
      sp_write_log(pc_corporate_id,
                   pd_trade_date,
                   'sp_calc_m2m',
                   'before 5');
      vc_err_msg := 'line 3068';
    
      /*update md_m2m_daily md
        set (valuation_location, reference_location, valuation_incoterm, valuation_location_country, reference_location_country) = (select cim_val_loc.city_name,
                                                                                                                                           cim_ref_loc.city_name,
                                                                                                                                           itm.incoterm,
                                                                                                                                           cim_val_loc_v.country_name,
                                                                                                                                           cim_ref_loc_r.country_name
                                                                                                                                      from cim_citymaster      cim_val_loc,
                                                                                                                                           cim_citymaster      cim_ref_loc,
                                                                                                                                           cym_countrymaster   cim_val_loc_v,
                                                                                                                                           cym_countrymaster   cim_ref_loc_r,
                                                                                                                                           itm_incoterm_master itm
                                                                                                                                     where md.valuation_city_id =
                                                                                                                                           cim_val_loc.city_id
                                                                                                                                       and md.product_type =
                                                                                                                                           'CONCENTRATES'
                                                                                                                                       and md.refernce_location_id =
                                                                                                                                           cim_ref_loc.city_id
                                                                                                                                       and cim_val_loc_v.country_id =
                                                                                                                                           cim_val_loc.country_id
                                                                                                                                       and cim_ref_loc_r.country_id =
                                                                                                                                           cim_ref_loc.country_id
                                                                                                                                       and md.valuation_incoterm_id =
                                                                                                                                           itm.incoterm_id)
      where md.corporate_id = pc_corporate_id
        and md.process_id = pc_process_id;*/
      vc_err_msg := 'line 3090';
      sp_write_log(pc_corporate_id,
                   pd_trade_date,
                   'sp_calc_m2m',
                   'before 6');
      --  dbms_output.put_line('after update -6 ');
      -- update derivative def id/name
      update md_m2m_daily md
         set (derivative_def_id, derivative_def_name) = (select pdd.derivative_def_id,
                                                                pdd.derivative_def_name
                                                           from dim_der_instrument_master  dim,
                                                                pdd_product_derivative_def pdd,
                                                                irm_instrument_type_master irm
                                                          where dim.instrument_id =
                                                                md.instrument_id
                                                            and md.product_type =
                                                                'CONCENTRATES'
                                                            and dim.product_derivative_id =
                                                                pdd.derivative_def_id
                                                            and dim.instrument_type_id =
                                                                irm.instrument_type_id
                                                            and irm.instrument_type =
                                                                'Future'
                                                            and rownum <= 1)
       where md.corporate_id = pc_corporate_id
         and md.product_type = 'CONCENTRATES'
         and md.is_tolling_contract = 'Y'
         and md.is_tolling_extn = 'Y'
         and md.process_id = pc_process_id;
    
      --get the m2m_price_unit_cur_id
      sp_write_log(pc_corporate_id,
                   pd_trade_date,
                   'sp_calc_m2m',
                   'before 7');
      vc_err_msg := 'line 3121';
      update md_m2m_daily md
         set (md.m2m_main_cur_id, md.m2m_main_cur_code, md.m2m_main_cur_decimals, md.main_currency_factor) = (select (case
                                                                                                                       when cm.is_sub_cur = 'Y' then
                                                                                                                        scd.cur_id
                                                                                                                       else
                                                                                                                        cm.cur_id
                                                                                                                     end) base_currency_id,
                                                                                                                     (case
                                                                                                                       when cm.is_sub_cur = 'Y' then
                                                                                                                        cm_1.cur_code
                                                                                                                       else
                                                                                                                        cm.cur_code
                                                                                                                     end) cur_code,
                                                                                                                     (case
                                                                                                                       when cm.is_sub_cur = 'Y' then
                                                                                                                        cm_1.decimals
                                                                                                                       else
                                                                                                                        cm.decimals
                                                                                                                     end),
                                                                                                                     (case
                                                                                                                       when cm.is_sub_cur = 'Y' then
                                                                                                                        nvl(scd.factor,
                                                                                                                            1)
                                                                                                                       else
                                                                                                                        1
                                                                                                                     end) factor
                                                                                                                from cm_currency_master      cm,
                                                                                                                     scd_sub_currency_detail scd,
                                                                                                                     cm_currency_master      cm_1
                                                                                                               where cm.cur_id =
                                                                                                                     md.m2m_price_unit_cur_id
                                                                                                                 and cm.cur_id =
                                                                                                                     scd.sub_cur_id(+)
                                                                                                                 and scd.cur_id =
                                                                                                                     cm_1.cur_id(+))
       where md.process_id = pc_process_id
         and md.product_type = 'CONCENTRATES'
         and md.is_tolling_contract = 'Y'
         and md.is_tolling_extn = 'Y';
      sp_write_log(pc_corporate_id,
                   pd_trade_date,
                   'sp_calc_m2m',
                   'before 8');
      --  dbms_output.put_line('after update -8 ');
      -- now update the m2m id in the tmpc_temp_m2m_pre_check
      -- table per contract item level,gmr level,grd level --
      vc_err_msg := 'line 3163';
      for c1 in (select md.md_id,
                        md.conc_product_id,
                        md.conc_quality_id,
                        md.corporate_id,
                        md.product_id,
                        md.element_id,
                        md.crop_year_id,
                        md.quality_id,
                        md.origin_id,
                        md.origin_group_id,
                        md.growth_code_id,
                        md.valuation_method,
                        md.mvp_id,
                        md.mvpl_id,
                        md.valuation_region,
                        md.valuation_point,
                        md.valuation_incoterm_id,
                        md.valuation_city_id,
                        md.valuation_basis,
                        md.reference_incoterm,
                        md.refernce_location_id refernce_location,
                        md.instrument_id,
                        md.valuation_dr_id,
                        md.valuation_month,
                        md.valuation_date,
                        md.shipment_month_year,
                        md.shipment_date,
                        md.rate_type
                   from md_m2m_daily md
                  where md.corporate_id = pc_corporate_id
                    and md.product_type = 'CONCENTRATES'
                    and md.is_tolling_contract = 'Y'
                    and md.is_tolling_extn = 'Y'
                    and md.process_id = pc_process_id)
      loop
        if c1.valuation_method <> 'FIXED' then
          update tmpc_temp_m2m_pre_check tmpc
             set tmpc.internal_m2m_id = c1.md_id
           where tmpc.corporate_id = c1.corporate_id
             and tmpc.product_id = c1.product_id
             and tmpc.conc_product_id = c1.conc_product_id
             and tmpc.conc_quality_id = c1.conc_quality_id
             and tmpc.element_id = c1.element_id
             and tmpc.quality_id = c1.quality_id
             and tmpc.mvp_id = c1.mvp_id
             and tmpc.mvpl_id = c1.mvpl_id
             and tmpc.valuation_region = c1.valuation_region
             and tmpc.valuation_point = c1.valuation_point
             and tmpc.valuation_incoterm_id = c1.valuation_incoterm_id
             and tmpc.valuation_city_id = c1.valuation_city_id
             and tmpc.valuation_basis = c1.valuation_basis
             and tmpc.valuation_dr_id = c1.valuation_dr_id
             and tmpc.reference_incoterm = c1.reference_incoterm
             and tmpc.refernce_location = c1.refernce_location
             and tmpc.instrument_id = c1.instrument_id
             and tmpc.shipment_date = c1.shipment_date
             and tmpc.shipment_month || '-' || tmpc.shipment_year =
                 c1.shipment_month_year
             and decode(tmpc.section_name, 'OPEN', 'OPEN', 'STOCK') =
                 c1.rate_type
             and tmpc.product_type = 'CONCENTRATES'
             and tmpc.is_tolling_contract = 'Y'
             and tmpc.is_tolling_extn = 'Y';
        else
          update tmpc_temp_m2m_pre_check tmpc
             set tmpc.internal_m2m_id = c1.md_id
           where tmpc.corporate_id = c1.corporate_id
             and tmpc.conc_product_id = c1.conc_product_id
             and tmpc.conc_quality_id = c1.conc_quality_id
             and tmpc.product_id = c1.product_id
             and tmpc.quality_id = c1.quality_id
             and tmpc.element_id = c1.element_id
             and tmpc.mvp_id = c1.mvp_id
             and tmpc.mvpl_id = c1.mvpl_id
             and tmpc.valuation_region = c1.valuation_region
             and tmpc.valuation_point = c1.valuation_point
             and tmpc.valuation_incoterm_id = c1.valuation_incoterm_id
             and tmpc.valuation_city_id = c1.valuation_city_id
             and tmpc.valuation_basis = c1.valuation_basis
             and tmpc.reference_incoterm = c1.reference_incoterm
             and tmpc.refernce_location = c1.refernce_location
                --and tmpc.instrument_id = c1.instrument_id
             and tmpc.shipment_date = c1.shipment_date
             and tmpc.shipment_month || '-' || tmpc.shipment_year =
                 c1.shipment_month_year
             and decode(tmpc.section_name, 'OPEN', 'OPEN', 'STOCK') =
                 c1.rate_type
             and tmpc.product_type = 'CONCENTRATES'
             and tmpc.is_tolling_contract = 'Y'
             and tmpc.is_tolling_extn = 'Y';
        end if;
      end loop;
    
      --update valuation_location, reference_location and valuation_incoterm
    
      for cc in (select tmpc.internal_m2m_id,
                        tmpc.product_id,
                        cim_val_loc.city_name valuation_location,
                        cim_ref_loc.city_name reference_location,
                        itm.incoterm valuation_incoterm,
                        cim_val_loc_v.country_name valuation_location_country,
                        cim_ref_loc_r.country_name reference_location_country
                   from tmpc_temp_m2m_pre_check tmpc,
                        cim_citymaster          cim_val_loc,
                        cim_citymaster          cim_ref_loc,
                        cym_countrymaster       cim_val_loc_v,
                        cym_countrymaster       cim_ref_loc_r,
                        itm_incoterm_master     itm
                  where tmpc.valuation_city_id = cim_val_loc.city_id
                    and tmpc.refernce_location = cim_ref_loc.city_id
                    and cim_val_loc_v.country_id = cim_val_loc.country_id
                    and cim_ref_loc_r.country_id = cim_ref_loc.country_id
                    and tmpc.valuation_incoterm_id = itm.incoterm_id
                    and tmpc.corporate_id = pc_corporate_id
                    and tmpc.product_type = 'CONCENTRATES'
                    and tmpc.is_tolling_contract = 'Y'
                    and tmpc.is_tolling_extn = 'Y'
                  group by cim_val_loc.city_name,
                           cim_ref_loc.city_name,
                           itm.incoterm,
                           cim_val_loc_v.country_name,
                           cim_ref_loc_r.country_name,
                           tmpc.product_id,
                           tmpc.internal_m2m_id)
      loop
      
        update md_m2m_daily md
           set valuation_location         = cc.valuation_location,
               reference_location         = cc.reference_location,
               valuation_incoterm         = cc.valuation_incoterm,
               valuation_location_country = cc.valuation_location_country,
               reference_location_country = cc.reference_location_country
         where md.md_id = cc.internal_m2m_id
           and md.product_id = cc.product_id
           and md.process_id = pc_process_id;
        commit;
      end loop;
    
    end;
    --  dbms_output.put_line('after allll');
    sp_write_log(pc_corporate_id, pd_trade_date, 'sp_calc_m2m', 'Done');
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure pkg_phy_physical_process.sp_calc_m2m_conc_cost',
                                                           'M2M-013',
                                                           'Code:' ||
                                                           sqlcode ||
                                                           'Message:' ||
                                                           sqlerrm ||
                                                           vc_err_msg,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;

  procedure sp_calc_phy_open_unreal_pnl(pc_corporate_id varchar2,
                                        pd_trade_date   date,
                                        pc_process_id   varchar2,
                                        pc_user_id      varchar2) is
    cursor cur_unrealized is
      select pcm.corporate_id,
             akc.corporate_name,
             pc_process_id,
             pcdi.pcdi_id,
             pcdi.delivery_item_no,
             pcdi.prefix,
             pcdi.middle_no,
             pcdi.suffix,
             pcdi.internal_contract_ref_no,
             pcm.contract_ref_no,
             pcm.issue_date,
             pci.internal_contract_item_ref_no,
             pcdi.basis_type,
             pcdi.delivery_period_type,
             pcdi.delivery_from_month,
             pcdi.delivery_from_year,
             pcdi.delivery_to_month,
             pcdi.delivery_to_year,
             pcdi.delivery_from_date,
             pcdi.delivery_to_date,
             pcdi.transit_days,
             pcm.purchase_sales,
             pcm.contract_status,
             'Unrealized' unrealized_type,
             pcpd.profit_center_id,
             cpc.profit_center_name,
             cpc.profit_center_short_name,
             pcm.cp_id,
             phd_cp.companyname cp_name,
             pcm.trader_id,
             (case
               when pcm.trader_id is not null then
                (select gab.firstname || ' ' || gab.lastname
                   from gab_globaladdressbook       gab,
                        ak_corporate_user@eka_appdb aku
                  where gab.gabid = aku.gabid
                    and aku.user_id = pcm.trader_id)
               else
                ''
             end) trader_user_name,
             pcpd.product_id,
             pdm.product_desc product_name,
             ciqs.open_qty item_qty,
             ciqs.item_qty_unit_id qty_unit_id,
             qum.qty_unit,
             pcpq.quality_template_id,
             qat.quality_name,
             pdm.product_desc,
             cipd.price_basis,
             pt.price_type_name,
             cipd.price_description price_description,
             pci.expected_delivery_month || '-' ||
             pci.expected_delivery_year item_delivery_period_string,
             cipd.price_basis fixation_method,
             cipd.price_fixation_status,
             pcdb.inco_term_id,
             itm.incoterm,
             pcdb.city_id origination_city_id,
             cim1.city_name origination_city,
             pcdb.country_id origination_country_id,
             cym1.country_name origination_country,
             pcdb.city_id destination_city_id,
             cim2.city_name destination_city,
             pcdb.country_id destination_country_id,
             cym2.country_name destination_country,
             rem_cym1.region_id origination_region_id,
             rem_cym1.region_name origination_region,
             rem_cym2.region_id destination_region_id,
             rem_cym2.region_name destination_region,
             pcm.payment_term_id,
             pym.payment_term,
             cipd.price_fixation_details as price_fixation_details,
             cipd.contract_price as contract_price,
             cipd.price_unit_id price_unit_id,
             cipd.price_unit_cur_id price_unit_cur_id,
             cipd.price_unit_cur_code price_unit_cur_code,
             cipd.price_unit_weight_unit_id,
             cipd.price_unit_weight price_unit_weight,
             cipd.price_unit_weight_unit price_unit_weight_unit,
             nvl(cipd.payment_due_date, pd_trade_date) payment_due_date,
             md.net_m2m_price net_m2m_price,
             md.m2m_price_unit_id,
             md.m2m_price_unit_cur_id,
             md.m2m_price_unit_cur_code,
             md.m2m_price_unit_weight,
             md.m2m_price_unit_weight_unit_id,
             md.m2m_price_unit_weight_unit,
             md.m2m_main_cur_id,
             md.m2m_main_cur_code,
             md.m2m_main_cur_decimals,
             md.main_currency_factor,
             0 m2m_amt,
             nvl(ciscs.avg_cost_fw_rate, 0) sc_in_base_cur,
             ciscs.fw_rate_string accrual_to_base_fw_exch_rate,
             cm.cur_id as base_cur_id,
             cm.cur_code as base_cur_code,
             md.md_id md_id,
             pd_trade_date eod_trade_date,
             gcd.groupid,
             gcd.groupname,
             cm_gcd.cur_id cur_id_gcd,
             cm_gcd.cur_code cur_code_gcd,
             qum_gcd.qty_unit_id qty_unit_id_gcd,
             qum_gcd.qty_unit qty_unit_gcd,
             qum_pdm.qty_unit_id as base_qty_unit_id,
             qum_pdm.qty_unit as base_qty_unit,
             pcpd.strategy_id,
             css.strategy_name,
             (ciqs.total_qty - nvl(ciqs.price_fixed_qty, 0)) unfxd_qty,
             ciqs.price_fixed_qty fxd_qty,
             md.derivative_def_id,
             md.valuation_exchange_id,
             md.valuation_dr_id,
             drm.dr_id_name,
             md.valuation_month,
             md.m2m_loc_incoterm_deviation,
             md.m2m_quality_premium,
             md.m2m_product_premium,
             md.base_price_unit_id_in_ppu,
             md.base_price_unit_id_in_pum,
             nvl(md.m2m_loc_incoterm_deviation, 0) +
             nvl(md.m2m_quality_premium, 0) +
             nvl(md.m2m_product_premium, 0) total_premium,
             akc.base_currency_name,
             nvl(pcdb.premium, 0) delivery_premium,
             pcdb.premium_unit_id delivery_premium_unit_id,
             md.m2m_pp_fw_exch_rate,
             md.m2m_ld_fw_exch_rate,
             md.m2m_qp_fw_exch_rate,
             qat.eval_basis
        from pcm_physical_contract_main pcm,
             ak_corporate akc,
             pcdi_pc_delivery_item pcdi,
             pci_physical_contract_item pci,
             pcpd_pc_product_definition pcpd,
             cpc_corporate_profit_center cpc,
             phd_profileheaderdetails phd_cp,
             pdm_productmaster pdm,
             qum_quantity_unit_master qum,
             pcpq_pc_product_quality pcpq,
             pt_price_type pt,
             qat_quality_attributes qat,
             pcdb_pc_delivery_basis pcdb,
             itm_incoterm_master itm,
             cim_citymaster cim1,
             cim_citymaster cim2,
             cym_countrymaster cym1,
             cym_countrymaster cym2,
             rem_region_master@eka_appdb rem_cym1,
             rem_region_master@eka_appdb rem_cym2,
             pym_payment_terms_master pym,
             cipd_contract_item_price_daily cipd,
             (select md1.*
                from md_m2m_daily md1
               where md1.rate_type = 'OPEN'
                 and md1.corporate_id = pc_corporate_id
                 and md1.product_type = 'BASEMETAL'
                 and md1.process_id = pc_process_id) md,
             drm_derivative_master drm,
             (select tmp.*
                from tmpc_temp_m2m_pre_check tmp
               where tmp.corporate_id = pc_corporate_id
                 and tmp.product_type = 'BASEMETAL'
                 and tmp.section_name = 'OPEN') tmpc,
             cm_currency_master cm,
             gcd_groupcorporatedetails gcd,
             cm_currency_master cm_gcd,
             qum_quantity_unit_master qum_gcd,
             qum_quantity_unit_master qum_pdm,
             css_corporate_strategy_setup css,
             ciqs_contract_item_qty_status ciqs,
             ciscs_cisc_summary ciscs
       where pcm.corporate_id = akc.corporate_id
         and pcm.internal_contract_ref_no = pcdi.internal_contract_ref_no
         and pcdi.pcdi_id = pci.pcdi_id
         and pcdi.internal_contract_ref_no = pcpd.internal_contract_ref_no
         and pcpd.profit_center_id = cpc.profit_center_id
         and pcm.cp_id = phd_cp.profileid
         and pcpd.product_id = pdm.product_id
         and pci.item_qty_unit_id = qum.qty_unit_id
         and pci.pcpq_id = pcpq.pcpq_id
         and pcpq.quality_template_id = qat.quality_id
         and cipd.price_basis = pt.price_type_id
         and pcdi.internal_contract_ref_no = pcdb.internal_contract_ref_no
         and pcdb.inco_term_id = itm.incoterm_id
         and pcdb.city_id = cim1.city_id(+)
         and pcdb.city_id = cim2.city_id(+)
         and pcdb.country_id = cym1.country_id(+)
         and pcdb.country_id = cym2.country_id(+)
         and cym1.region_id = rem_cym1.region_id(+)
         and cym2.region_id = rem_cym2.region_id(+)
         and pcm.payment_term_id = pym.payment_term_id
         and pci.internal_contract_item_ref_no =
             cipd.internal_contract_item_ref_no
         and akc.base_cur_id = cm.cur_id
         and akc.groupid = gcd.groupid
         and gcd.group_cur_id = cm_gcd.cur_id(+)
         and gcd.group_qty_unit_id = qum_gcd.qty_unit_id(+)
         and qum_pdm.qty_unit_id = pdm.base_quantity_unit
         and pcpd.strategy_id = css.strategy_id
         and ciqs.internal_contract_item_ref_no =
             pci.internal_contract_item_ref_no
         and pci.pcdb_id = pcdb.pcdb_id
         and pcm.corporate_id = pc_corporate_id
         and pcm.contract_status = 'In Position'
         and pcpd.input_output = 'Input'
         and pcm.is_active = 'Y'
         and pci.is_active = 'Y'
         and pcdi.is_active = 'Y'
         and pcdb.is_active = 'Y'
         and ciqs.is_active = 'Y'
         and pcm.contract_type = 'BASEMETAL'
         and pcm.process_id = pc_process_id
         and pci.process_id = pc_process_id
         and pcdi.process_id = pc_process_id
         and pcpd.process_id = pc_process_id
         and pcdb.process_id = pc_process_id
         and pcpq.process_id = pc_process_id
         and ciqs.process_id = pc_process_id
         and cipd.process_id = pc_process_id
         and ciqs.open_qty > 0
         and pci.internal_contract_item_ref_no =
             tmpc.internal_contract_item_ref_no(+)
         and tmpc.internal_m2m_id = md.md_id(+)
         and md.valuation_dr_id = drm.dr_id(+)
         and ciqs.internal_contract_item_ref_no =
             ciscs.internal_contract_item_ref_no(+)
         and ciqs.process_id = ciscs.process_id(+);
  
    vn_m2m_amt                     number;
    vc_m2m_cur_id                  varchar2(15);
    vc_m2m_cur_code                varchar2(15);
    vc_price_cur_id                varchar2(15);
    vc_price_cur_code              varchar2(15);
    vn_m2m_sub_cur_id_factor       number;
    vn_m2m_cur_decimals            number;
    vn_cont_price_cur_id_factor    number;
    vn_cont_price_cur_decimals     number;
    vn_contract_value_in_price_cur number;
    vn_forward_exch_rate           number;
    -- vn_fw_fx_price_cur_to_m2m_cur  number;
    -- vn_val_to_base_corp_fx_rate    number;
    -- vn_base_to_val_fx_rate         number;
    vn_contract_value_in_val_cur   number;
    vn_sc_in_base_cur              number;
    vn_sc_in_valuation_cur         number;
    vn_expected_cog_in_val_cur     number;
    vn_unrealized_pnl_in_val_cur   number;
    vn_unrealized_pnl_in_base_cur  number;
    vc_base_price_unit             varchar2(15);
    vn_qty_in_base                 number;
    vn_unrealized_pnl_in_m2m_unit  number;
    vc_m2m_price_unit_id           varchar2(15);
    vc_m2m_price_unit_cur_id       varchar2(15);
    vc_m2m_price_unit_cur_code     varchar2(15);
    vc_m2m_price_unit_wgt_unit_id  varchar2(15);
    vc_m2m_price_unit_wgt_unit     varchar2(15);
    vn_m2m_price_unit_wgt_unit_wt  number;
    vn_contract_premium            number;
    vn_contract_premium_value      number;
    vobj_error_log                 tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count             number := 1;
    vn_m2m_base_fx_rate            number;
    vn_m2m_base_deviation          number;
    vn_m2m_amount_in_base          number;
    vn_m2m_total_amount            number;
    vn_m2m_total_premium_amt       number;
    vn_fx_price_to_base            number;
    vn_cont_delivery_premium       number;
    vn_cont_del_premium_amt        number;
    vn_contract_value_in_base_cur  number;
    vc_del_premium_cur_id          varchar2(15);
    vc_del_premium_cur_code        varchar2(15);
    vc_del_premium_main_cur_id     varchar2(15);
    vc_del_premium_main_cur_code   varchar2(15);
    vn_del_premium_cur_main_factor number;
    vc_del_premium_weight_unit_id  varchar2(15);
    vn_del_premium_weight          number;
    vn_del_to_base_fw_rate         number;
    vn_forward_points              number;
    vc_qual_prem_exch_rate_string  varchar2(500);
    vc_error_msg                   varchar2(100);
    -- Variable for all exchange rate string start
    vc_price_to_base_fw_rate    varchar2(100);
    vc_m2m_to_base_fw_rate      varchar2(100);
    vc_m2m_ld_fw_exch_rate      varchar2(100);
    vc_m2m_qp_fw_exch_rate      varchar2(100);
    vc_m2m_pp_fw_exch_rate      varchar2(100);
    vc_contract_qp_fw_exch_rate varchar2(100);
    vc_contract_pp_fw_exch_rate varchar2(100);
    -- Variable for all exchange rate string end    
  begin
    for cur_unrealized_rows in cur_unrealized
    loop
      vc_m2m_ld_fw_exch_rate    := cur_unrealized_rows.m2m_ld_fw_exch_rate;
      vc_m2m_qp_fw_exch_rate    := cur_unrealized_rows.m2m_qp_fw_exch_rate;
      vc_m2m_pp_fw_exch_rate    := cur_unrealized_rows.m2m_pp_fw_exch_rate;
      vc_error_msg              := '1';
      vn_cont_delivery_premium  := 0;
      vn_cont_del_premium_amt   := 0;
      vn_contract_premium       := 0;
      vn_contract_premium_value := 0;
    
      vn_qty_in_base := round(pkg_general.f_get_converted_quantity(cur_unrealized_rows.product_id,
                                                                   cur_unrealized_rows.qty_unit_id,
                                                                   cur_unrealized_rows.base_qty_unit_id,
                                                                   1) *
                              cur_unrealized_rows.item_qty,
                              8);
      vn_m2m_amt     := nvl(cur_unrealized_rows.net_m2m_price, 0) /
                        nvl(cur_unrealized_rows.m2m_price_unit_weight, 1) *
                        pkg_general.f_get_converted_quantity(cur_unrealized_rows.product_id,
                                                             cur_unrealized_rows.qty_unit_id,
                                                             cur_unrealized_rows.m2m_price_unit_weight_unit_id,
                                                             cur_unrealized_rows.item_qty);
      pkg_general.sp_get_main_cur_detail(nvl(cur_unrealized_rows.m2m_price_unit_cur_id,
                                             cur_unrealized_rows.base_cur_id),
                                         vc_m2m_cur_id,
                                         vc_m2m_cur_code,
                                         vn_m2m_sub_cur_id_factor,
                                         vn_m2m_cur_decimals);
      vn_m2m_amt   := round(vn_m2m_amt * vn_m2m_sub_cur_id_factor, 2);
      vc_error_msg := '2';
      if cur_unrealized_rows.eval_basis <> 'FIXED' then
        pkg_general.sp_forward_cur_exchange_new(cur_unrealized_rows.corporate_id,
                                                pd_trade_date,
                                                cur_unrealized_rows.payment_due_date,
                                                vc_m2m_cur_id,
                                                cur_unrealized_rows.base_cur_id,
                                                30,
                                                vn_m2m_base_fx_rate,
                                                vn_m2m_base_deviation);
      
        if vc_m2m_cur_id <> cur_unrealized_rows.base_cur_id then
          if vn_m2m_base_fx_rate is null or vn_m2m_base_fx_rate = 0 then
            vc_error_msg := '3';
            vobj_error_log.extend;
            vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                 'procedure pkg_phy_physical_process-sp_calc_phy_open_unrealized ',
                                                                 'PHY-005',
                                                                 cur_unrealized_rows.base_cur_code ||
                                                                 ' to ' ||
                                                                 vc_m2m_cur_code || ' (' ||
                                                                 to_char(cur_unrealized_rows.payment_due_date,
                                                                         'dd-Mon-yyyy') || ') ',
                                                                 '',
                                                                 gvc_process,
                                                                 pc_user_id,
                                                                 sysdate,
                                                                 pd_trade_date);
            sp_insert_error_log(vobj_error_log);
          
          end if;
          vc_error_msg := '4';
          if vn_m2m_base_fx_rate <> 1 then
            vc_m2m_to_base_fw_rate := '1 ' || vc_m2m_cur_code || '=' ||
                                      vn_m2m_base_fx_rate || ' ' ||
                                      cur_unrealized_rows.base_cur_code;
          end if;
        end if;
      else
        vn_m2m_amt          := 0;
        vn_m2m_base_fx_rate := 1;
      end if;
    
      vn_m2m_amount_in_base    := vn_m2m_amt * vn_m2m_base_fx_rate;
      vn_m2m_total_premium_amt := vn_qty_in_base *
                                  cur_unrealized_rows.total_premium;
      vn_m2m_total_amount      := vn_m2m_amount_in_base +
                                  vn_m2m_total_premium_amt;
      vc_error_msg             := '5';
      pkg_general.sp_get_main_cur_detail(cur_unrealized_rows.price_unit_cur_id,
                                         vc_price_cur_id,
                                         vc_price_cur_code,
                                         vn_cont_price_cur_id_factor,
                                         vn_cont_price_cur_decimals);
    
      vc_error_msg                   := '6';
      vn_contract_value_in_price_cur := (cur_unrealized_rows.contract_price /
                                        nvl(cur_unrealized_rows.price_unit_weight,
                                             1)) *
                                        (pkg_general.f_get_converted_quantity(cur_unrealized_rows.product_id,
                                                                              cur_unrealized_rows.qty_unit_id,
                                                                              cur_unrealized_rows.price_unit_weight_unit_id,
                                                                              cur_unrealized_rows.item_qty)) *
                                        vn_cont_price_cur_id_factor;
    
      pkg_general.sp_forward_cur_exchange_new(cur_unrealized_rows.corporate_id,
                                              pd_trade_date,
                                              cur_unrealized_rows.payment_due_date,
                                              vc_price_cur_id,
                                              cur_unrealized_rows.base_cur_id,
                                              30,
                                              vn_fx_price_to_base,
                                              vn_forward_exch_rate);
      vc_error_msg := '7';
    
      if vc_price_cur_id <> cur_unrealized_rows.base_cur_id then
        if vn_fx_price_to_base is null or vn_fx_price_to_base = 0 then
          vobj_error_log.extend;
          vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                               'procedure sp_calc_phy_open_unreal_pnl',
                                                               'PHY-005',
                                                               cur_unrealized_rows.base_cur_code ||
                                                               ' to ' ||
                                                               vc_price_cur_code,
                                                               '',
                                                               gvc_process,
                                                               pc_user_id,
                                                               sysdate,
                                                               pd_trade_date);
          sp_insert_error_log(vobj_error_log);
        
        end if;
        vc_price_to_base_fw_rate := '1 ' || vc_price_cur_code || '=' ||
                                    vn_fx_price_to_base || ' ' ||
                                    cur_unrealized_rows.base_cur_code;
      end if;
    
      vc_error_msg := '8';
      -- contract value in value currency will store the data in base currency
      vn_contract_value_in_price_cur := round(vn_contract_value_in_price_cur,
                                              2);
    
      vn_contract_value_in_val_cur := round(vn_contract_value_in_price_cur *
                                            nvl(vn_fx_price_to_base, 1),
                                            2);
      begin
        select ppu.product_price_unit_id
          into vc_base_price_unit
          from v_ppu_pum ppu
         where ppu.cur_id = cur_unrealized_rows.base_cur_id
           and ppu.weight_unit_id = cur_unrealized_rows.base_qty_unit_id
           and nvl(ppu.weight, 1) = 1
           and ppu.product_id = cur_unrealized_rows.product_id;
      exception
        when others then
          sp_write_log(pc_corporate_id,
                       pd_trade_date,
                       'sp_open_phy_unreal',
                       'vc_base_price_unit' || vc_base_price_unit || ' For' ||
                       cur_unrealized_rows.contract_ref_no);
      end;
      vn_contract_premium := 0;
    
      vc_error_msg := '9';
      sp_write_log(pc_corporate_id,
                   pd_trade_date,
                   'sp_open_phy_unreal',
                   'QP in ' || vc_base_price_unit || ' For' ||
                   cur_unrealized_rows.contract_ref_no ||
                   cur_unrealized_rows.internal_contract_item_ref_no || ' ' ||
                   pd_trade_date || ' ' || cur_unrealized_rows.product_id ||
                   ' pc_process_id ' || pc_process_id);
      ------------------******** Premium Calculations starts here ******-------------------
    
      sp_quality_premium_fw_rate(cur_unrealized_rows.internal_contract_item_ref_no,
                                 pc_corporate_id,
                                 pd_trade_date,
                                 vc_base_price_unit,
                                 cur_unrealized_rows.base_cur_id,
                                 cur_unrealized_rows.payment_due_date,
                                 cur_unrealized_rows.product_id,
                                 cur_unrealized_rows.base_qty_unit_id,
                                 pc_process_id,
                                 vn_contract_premium,
                                 vc_qual_prem_exch_rate_string);
      vc_error_msg                := '10';
      vc_contract_qp_fw_exch_rate := vc_qual_prem_exch_rate_string;
    
      sp_write_log(pc_corporate_id,
                   pd_trade_date,
                   'sp_open_phy_unreal',
                   'premium' || vc_base_price_unit || ' For' ||
                   cur_unrealized_rows.contract_ref_no ||
                   cur_unrealized_rows.internal_contract_item_ref_no ||
                   vn_contract_premium);
      -- Calculate contract delivery premium from pcdb
      if cur_unrealized_rows.delivery_premium <> 0 then
        if cur_unrealized_rows.delivery_premium_unit_id <>
           vc_base_price_unit then
        
          vc_error_msg := '11';
          --
          -- Get the Delivery Premium Currency 
          --
          select ppu.cur_id,
                 cm.cur_code,
                 nvl(ppu.weight, 1),
                 ppu.weight_unit_id
            into vc_del_premium_cur_id,
                 vc_del_premium_cur_code,
                 vn_del_premium_weight,
                 vc_del_premium_weight_unit_id
            from v_ppu_pum          ppu,
                 cm_currency_master cm
           where ppu.product_price_unit_id =
                 cur_unrealized_rows.delivery_premium_unit_id
             and cm.cur_id = ppu.cur_id;
          --
          -- Get the Main Currency of the Delivery Premium Price Unit
          --
          vc_error_msg := '12';
          pkg_general.sp_get_base_cur_detail(vc_del_premium_cur_id,
                                             vc_del_premium_main_cur_id,
                                             vc_del_premium_main_cur_code,
                                             vn_del_premium_cur_main_factor);
        
          pkg_general.sp_forward_cur_exchange_new(pc_corporate_id,
                                                  pd_trade_date,
                                                  cur_unrealized_rows.payment_due_date,
                                                  vc_del_premium_main_cur_id,
                                                  cur_unrealized_rows.base_cur_id,
                                                  30,
                                                  vn_del_to_base_fw_rate,
                                                  vn_forward_points);
          vc_error_msg := '13';
        
          vn_cont_delivery_premium := (cur_unrealized_rows.delivery_premium /
                                      vn_del_premium_weight) *
                                      vn_del_premium_cur_main_factor *
                                      vn_del_to_base_fw_rate *
                                      pkg_general.f_get_converted_quantity(cur_unrealized_rows.product_id,
                                                                           vc_del_premium_weight_unit_id,
                                                                           cur_unrealized_rows.base_qty_unit_id,
                                                                           1);
          vc_error_msg             := '14';
          if cur_unrealized_rows.base_cur_code <>
             vc_del_premium_main_cur_code then
            vc_contract_pp_fw_exch_rate := '1 ' ||
                                           vc_del_premium_main_cur_code || '=' ||
                                           vn_del_to_base_fw_rate || ' ' ||
                                           cur_unrealized_rows.base_cur_code;
          end if;
        
          if cur_unrealized_rows.base_cur_code <>
             vc_del_premium_main_cur_code then
            if vn_m2m_base_fx_rate is null or vn_m2m_base_fx_rate = 0 then
              vobj_error_log.extend;
              vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                   'procedure pkg_phy_physical_process-sp_calc_phy_open_unrealized ',
                                                                   'PHY-005',
                                                                   cur_unrealized_rows.base_cur_code ||
                                                                   ' to ' ||
                                                                   vc_del_premium_main_cur_code || ' (' ||
                                                                   to_char(cur_unrealized_rows.payment_due_date,
                                                                           'dd-Mon-yyyy') || ') ',
                                                                   '',
                                                                   gvc_process,
                                                                   pc_user_id,
                                                                   sysdate,
                                                                   pd_trade_date);
              sp_insert_error_log(vobj_error_log);
            end if;
          end if;
        else
          vn_cont_delivery_premium := cur_unrealized_rows.delivery_premium;
        end if;
        vn_cont_del_premium_amt := round(vn_cont_delivery_premium *
                                         vn_qty_in_base,
                                         2);
      else
        vn_cont_delivery_premium := 0;
        vn_cont_del_premium_amt  := 0;
      end if;
    
      vc_error_msg              := '15';
      vn_contract_premium_value := round((vn_contract_premium *
                                         vn_qty_in_base) +
                                         vn_cont_del_premium_amt,
                                         2);
      sp_write_log(pc_corporate_id,
                   pd_trade_date,
                   'sp_open_phy_unreal',
                   'vn_contract_premium_value ' || vc_base_price_unit ||
                   ' For' || cur_unrealized_rows.contract_ref_no ||
                   cur_unrealized_rows.internal_contract_item_ref_no ||
                   ' =  ' || vn_contract_premium_value);
      ------------------******** Premium Calculations ends here ******-------------------
      ---- Add premium to contract value,as vn_contract_value_in_val_cur is in base currency and vn_contract_premium_value also in base currency
      vn_contract_value_in_base_cur := vn_contract_value_in_val_cur;
      vn_contract_value_in_val_cur  := vn_contract_value_in_val_cur +
                                       vn_contract_premium_value;
      vn_sc_in_base_cur             := round(cur_unrealized_rows.sc_in_base_cur *
                                             vn_qty_in_base,
                                             2);
      vn_sc_in_valuation_cur        := vn_sc_in_base_cur;
    
      /* if cur_unrealized_rows.purchase_sales = 'P' then
        vn_contract_value_in_val_cur := (-1) * vn_contract_value_in_val_cur;
      else
        vn_contract_value_in_val_cur := vn_contract_value_in_val_cur;
      end if;*/
      -- as per the current implementation in basemetals, there is not Income/expense accruals separately
      -- so we need to ass conract value + SC  - done as on 05-Jul-2011, once we implement the 
      -- Income/expense accruals separately, we have to remove the abs from SC.
      -- vn_contract_value_in_val_cur := vn_contract_value_in_val_cur;
      vn_expected_cog_in_val_cur := round((abs(vn_contract_value_in_val_cur) +
                                          abs(vn_sc_in_valuation_cur)),
                                          2);
    
      if cur_unrealized_rows.purchase_sales = 'P' then
        vn_unrealized_pnl_in_val_cur := round((vn_m2m_total_amount -
                                              vn_expected_cog_in_val_cur),
                                              2);
      else
        vn_unrealized_pnl_in_val_cur := round((vn_expected_cog_in_val_cur -
                                              vn_m2m_total_amount),
                                              2);
      end if;
      vc_error_msg                  := '16';
      vn_unrealized_pnl_in_base_cur := vn_unrealized_pnl_in_val_cur;
    
      -- below variable set as zero as it's not used in any calculation.
      vn_unrealized_pnl_in_m2m_unit := 0;
      vc_m2m_price_unit_id          := cur_unrealized_rows.m2m_price_unit_id;
      vc_m2m_price_unit_cur_id      := cur_unrealized_rows.m2m_price_unit_cur_id;
      vc_m2m_price_unit_cur_code    := cur_unrealized_rows.m2m_price_unit_cur_code;
      vc_m2m_price_unit_wgt_unit_id := cur_unrealized_rows.m2m_price_unit_weight_unit_id;
      vc_m2m_price_unit_wgt_unit    := cur_unrealized_rows.m2m_price_unit_weight_unit;
      vn_m2m_price_unit_wgt_unit_wt := cur_unrealized_rows.m2m_price_unit_weight;
    
      insert into poud_phy_open_unreal_daily
        (corporate_id,
         corporate_name,
         process_id,
         pcdi_id,
         delivery_item_no,
         prefix,
         middle_no,
         suffix,
         internal_contract_ref_no,
         contract_ref_no,
         contract_issue_date,
         internal_contract_item_ref_no,
         basis_type,
         delivery_period_type,
         delivery_from_month,
         delivery_from_year,
         delivery_to_month,
         delivery_to_year,
         delivery_from_date,
         delivery_to_date,
         transit_days,
         contract_type,
         approval_status,
         unrealized_type,
         profit_center_id,
         profit_center_name,
         profit_center_short_name,
         cp_profile_id,
         cp_name,
         trade_user_id,
         trade_user_name,
         product_id,
         product_name,
         item_qty,
         qty_unit_id,
         qty_unit,
         quality_id,
         quality_name,
         product_desc,
         price_type_id,
         price_type_name,
         price_string,
         item_delivery_period_string,
         fixation_method,
         price_fixation_status,
         incoterm_id,
         incoterm,
         origination_city_id,
         origination_city,
         origination_country_id,
         origination_country,
         destination_city_id,
         destination_city,
         destination_country_id,
         destination_country,
         origination_region_id,
         origination_region,
         destination_region_id,
         destination_region,
         payment_term_id,
         payment_term,
         price_fixation_details,
         contract_price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         price_unit_weight_unit_id,
         price_unit_weight,
         price_unit_weight_unit,
         net_m2m_price,
         m2m_price_unit_id,
         m2m_price_cur_id,
         m2m_price_cur_code,
         m2m_price_weight,
         m2m_price_weght_unit_id,
         m2m_price_weight_unit,
         contract_value_in_price_cur,
         contract_value_in_val_cur,
         price_main_cur_id,
         price_main_cur_code,
         valualtion_cur_id,
         valualtion_cur_code,
         m2m_amt,
         m2m_amt_cur_id,
         m2m_amt_cur_code,
         sc_in_valuation_cur,
         sc_in_base_cur,
         contract_premium_value,
         premium_cur_id,
         premium_cur_code,
         expected_cog_net_sale_value,
         unrealized_pnl_in_val_cur,
         unrealized_pnl_in_base_cur,
         prev_day_unr_pnl_in_val_cur,
         prev_day_unr_pnl_in_base_cur,
         trade_day_pnl_in_val_cur,
         trade_day_pnl_in_base_cur,
         base_cur_id,
         base_cur_code,
         expected_cog_in_val_cur,
         price_cur_to_val_cur_fx_rate,
         price_cur_to_base_cur_fx_rate,
         base_cur_to_val_cur_fx_rate,
         val_to_base_corp_fx_rate,
         spot_rate_val_cur_to_base_cur,
         unrealized_pnl_in_m2m_price_id,
         prev_unr_pnl_in_m2m_price_id,
         trade_day_pnl_in_m2m_price_id,
         realized_date,
         realized_price,
         realized_price_id,
         realized_price_cur_id,
         realized_price_cur_code,
         realized_price_weight,
         realized_price_weight_unit,
         realized_qty,
         realized_qty_id,
         realized_qty_unit,
         md_id,
         group_id,
         group_name,
         group_cur_id,
         group_cur_code,
         group_qty_unit_id,
         group_qty_unit,
         base_qty_unit_id,
         base_qty_unit,
         prev_item_qty,
         prev_qty_unit_id,
         cont_unr_status,
         unfxd_qty,
         fxd_qty,
         qty_in_base_unit,
         eod_trade_date,
         strategy_id,
         strategy_name,
         derivative_def_id,
         valuation_exchange_id,
         valuation_dr_id,
         valuation_dr_id_name,
         valuation_month,
         price_month,
         pay_in_cur_id,
         pay_in_cur_code,
         unreal_pnl_in_base_per_unit,
         unreal_pnl_in_val_cur_per_unit,
         realized_internal_stock_ref_no,
         sales_internal_gmr_ref_no,
         sales_gmr_ref_no,
         price_to_base_fw_exch_rate,
         m2m_to_base_fw_exch_rate,
         m2m_ld_fw_exch_rate,
         m2m_qp_fw_exch_rate,
         m2m_pp_fw_exch_rate,
         contract_qp_fw_exch_rate,
         contract_pp_fw_exch_rate,
         accrual_to_base_fw_exch_rate)
      values
        (cur_unrealized_rows.corporate_id,
         cur_unrealized_rows.corporate_name,
         pc_process_id,
         cur_unrealized_rows.pcdi_id,
         cur_unrealized_rows.delivery_item_no,
         cur_unrealized_rows.prefix,
         cur_unrealized_rows.middle_no,
         cur_unrealized_rows.suffix,
         cur_unrealized_rows.internal_contract_ref_no,
         cur_unrealized_rows.contract_ref_no,
         cur_unrealized_rows.issue_date,
         cur_unrealized_rows.internal_contract_item_ref_no,
         cur_unrealized_rows.basis_type,
         cur_unrealized_rows.delivery_period_type,
         cur_unrealized_rows.delivery_from_month,
         cur_unrealized_rows.delivery_from_year,
         cur_unrealized_rows.delivery_to_month,
         cur_unrealized_rows.delivery_to_year,
         cur_unrealized_rows.delivery_from_date,
         cur_unrealized_rows.delivery_to_date,
         cur_unrealized_rows.transit_days,
         cur_unrealized_rows.purchase_sales,
         cur_unrealized_rows.contract_status,
         cur_unrealized_rows.unrealized_type,
         cur_unrealized_rows.profit_center_id,
         cur_unrealized_rows.profit_center_name,
         cur_unrealized_rows.profit_center_short_name,
         cur_unrealized_rows.cp_id,
         cur_unrealized_rows.cp_name,
         cur_unrealized_rows.trader_id,
         cur_unrealized_rows.trader_user_name,
         cur_unrealized_rows.product_id,
         cur_unrealized_rows.product_name,
         cur_unrealized_rows.item_qty,
         cur_unrealized_rows.qty_unit_id,
         cur_unrealized_rows.qty_unit,
         cur_unrealized_rows.quality_template_id,
         cur_unrealized_rows.quality_name,
         cur_unrealized_rows.product_desc,
         cur_unrealized_rows.price_basis,
         cur_unrealized_rows.price_type_name,
         cur_unrealized_rows.price_description,
         cur_unrealized_rows.item_delivery_period_string,
         cur_unrealized_rows.fixation_method,
         cur_unrealized_rows.price_fixation_status,
         cur_unrealized_rows.inco_term_id,
         cur_unrealized_rows.incoterm,
         cur_unrealized_rows.origination_city_id,
         cur_unrealized_rows.origination_city,
         cur_unrealized_rows.origination_country_id,
         cur_unrealized_rows.origination_country,
         cur_unrealized_rows.destination_city_id,
         cur_unrealized_rows.destination_city,
         cur_unrealized_rows.destination_country_id,
         cur_unrealized_rows.destination_country,
         cur_unrealized_rows.origination_region_id,
         cur_unrealized_rows.origination_region,
         cur_unrealized_rows.destination_region_id,
         cur_unrealized_rows.destination_region,
         cur_unrealized_rows.payment_term_id,
         cur_unrealized_rows.payment_term,
         cur_unrealized_rows.price_fixation_details,
         cur_unrealized_rows.contract_price,
         cur_unrealized_rows.price_unit_id,
         cur_unrealized_rows.price_unit_cur_id,
         cur_unrealized_rows.price_unit_cur_code,
         cur_unrealized_rows.price_unit_weight_unit_id,
         cur_unrealized_rows.price_unit_weight,
         cur_unrealized_rows.price_unit_weight_unit,
         cur_unrealized_rows.net_m2m_price,
         vc_m2m_price_unit_id,
         vc_m2m_price_unit_cur_id,
         vc_m2m_price_unit_cur_code,
         vn_m2m_price_unit_wgt_unit_wt,
         vc_m2m_price_unit_wgt_unit_id,
         vc_m2m_price_unit_wgt_unit,
         vn_contract_value_in_price_cur,
         vn_contract_value_in_val_cur,
         vc_price_cur_id,
         vc_price_cur_code,
         vc_m2m_price_unit_cur_id, -- valuation cur_id
         vc_m2m_price_unit_cur_code, -- valuation cur_code
         vn_m2m_total_amount,
         cur_unrealized_rows.base_cur_id,
         cur_unrealized_rows.base_cur_code,
         --  vc_m2m_cur_id,
         -- vc_m2m_cur_id,
         vn_sc_in_base_cur,
         vn_sc_in_valuation_cur,
         vn_contract_premium_value, -- contract premium value
         cur_unrealized_rows.base_cur_id, -- premium cur_id
         cur_unrealized_rows.base_cur_code, --premium cur_code
         vn_expected_cog_in_val_cur, -- expected_cog_net_sale_value
         vn_unrealized_pnl_in_val_cur,
         vn_unrealized_pnl_in_base_cur,
         0, --prev_day_unr_pnl_in_val_cur
         0, --prev_day_unr_pnl_in_base_cur
         0, --trade_day_pnl_in_val_cur
         0, --trade_day_pnl_in_base_cur
         cur_unrealized_rows.base_cur_id,
         cur_unrealized_rows.base_cur_code,
         vn_expected_cog_in_val_cur,
         null, -- vn_fw_fx_price_cur_to_m2m_cur,
         vn_fx_price_to_base, --price_cur_to_base_cur_fx_rate
         null, -- vn_base_to_val_fx_rate, --base_cur_to_val_cur_fx_rate
         null, --vn_val_to_base_corp_fx_rate, --val_to_base_corp_fx_rate
         vn_m2m_base_fx_rate, --spot_rate_val_cur_to_base_cur
         vn_unrealized_pnl_in_m2m_unit, --unrealized_pnl_in_m2m_price_id
         0, --prev_unr_pnl_in_m2m_price_id
         0, --trade_day_pnl_in_m2m_price_id
         null, --realized_date
         null, --realized_price
         null, --realized_price_id
         null, --realized_price_cur_id
         null, --realized_price_cur_code
         null, --realized_price_weight
         null, --realized_price_weight_unit
         null, --realized_qty
         null, --realized_qty_id
         null, --realized_qty_unit
         cur_unrealized_rows.md_id,
         cur_unrealized_rows.groupid,
         cur_unrealized_rows.groupname,
         cur_unrealized_rows.cur_id_gcd,
         cur_unrealized_rows.cur_code_gcd,
         cur_unrealized_rows.qty_unit_id_gcd,
         cur_unrealized_rows.qty_unit_gcd,
         cur_unrealized_rows.base_qty_unit_id,
         cur_unrealized_rows.base_qty_unit,
         null, --prev_item_qty
         null, --prev_qty_unit_id
         null, --cont_unr_status
         cur_unrealized_rows.unfxd_qty,
         cur_unrealized_rows.fxd_qty,
         vn_qty_in_base,
         cur_unrealized_rows.eod_trade_date,
         cur_unrealized_rows.strategy_id,
         cur_unrealized_rows.strategy_name,
         cur_unrealized_rows.derivative_def_id,
         cur_unrealized_rows.valuation_exchange_id,
         cur_unrealized_rows.valuation_dr_id,
         cur_unrealized_rows.dr_id_name,
         cur_unrealized_rows.valuation_month,
         null, --price_month
         null, --pay_in_cur_id
         null, --pay_in_cur_code
         vn_unrealized_pnl_in_base_cur /
         decode(vn_qty_in_base, 0, 1, vn_qty_in_base), --unreal_pnl_in_base_per_unit
         vn_unrealized_pnl_in_val_cur /
         decode(vn_qty_in_base, 0, 1, vn_qty_in_base), --unreal_pnl_in_val_cur_per_unit
         null, --realized_internal_stock_ref_no
         null, --sales_internal_gmr_ref_no
         null, -- sales_gmr_ref_no
         vc_price_to_base_fw_rate,
         vc_m2m_to_base_fw_rate,
         vc_m2m_ld_fw_exch_rate,
         vc_m2m_qp_fw_exch_rate,
         vc_m2m_pp_fw_exch_rate,
         vc_contract_qp_fw_exch_rate,
         vc_contract_pp_fw_exch_rate,
         cur_unrealized_rows.accrual_to_base_fw_exch_rate);
    end loop;
    ---------
    commit;
    sp_gather_stats('poud_phy_open_unreal_daily');
  
    vc_error_msg := '17';
    begin
      -- update previous eod data
      for cur_update in (select poud_prev_day.internal_contract_item_ref_no,
                                poud_prev_day.unreal_pnl_in_base_per_unit,
                                poud_prev_day.unreal_pnl_in_val_cur_per_unit,
                                poud_prev_day.unrealized_pnl_in_m2m_price_id,
                                poud_prev_day.item_qty,
                                poud_prev_day.qty_unit_id,
                                poud_prev_day.unrealized_type,
                                poud_prev_day.m2m_amt_cur_id
                           from poud_phy_open_unreal_daily poud_prev_day
                          where poud_prev_day.process_id =
                                gvc_previous_process_id
                            and corporate_id = pc_corporate_id)
      loop
        update poud_phy_open_unreal_daily poud_today
           set poud_today.prev_day_unr_pnl_in_base_cur = cur_update.unreal_pnl_in_base_per_unit *
                                                         poud_today.qty_in_base_unit,
               poud_today.prev_day_unr_pnl_in_val_cur  = pkg_general.f_get_converted_currency_amt(pc_corporate_id,
                                                                                                  cur_update.m2m_amt_cur_id,
                                                                                                  poud_today.m2m_amt_cur_id,
                                                                                                  pd_trade_date,
                                                                                                  cur_update.unreal_pnl_in_val_cur_per_unit),
               poud_today.prev_unr_pnl_in_m2m_price_id = cur_update.unrealized_pnl_in_m2m_price_id,
               poud_today.prev_item_qty                = cur_update.item_qty,
               poud_today.prev_qty_unit_id             = cur_update.qty_unit_id,
               poud_today.cont_unr_status              = 'EXISTING_TRADE'
         where poud_today.internal_contract_item_ref_no =
               cur_update.internal_contract_item_ref_no
           and poud_today.process_id = pc_process_id
           and poud_today.unrealized_type = cur_update.unrealized_type
           and poud_today.corporate_id = pc_corporate_id;
      end loop;
    exception
      when others then
        dbms_output.put_line('SQLERRM-1' || sqlerrm);
    end;
  
    vc_error_msg := '18';
    -- mark the trades came as new in this eod/eom
    begin
      update poud_phy_open_unreal_daily poud
         set poud.cont_unr_status = 'NEW_TRADE'
       where poud.cont_unr_status is null
         and poud.process_id = pc_process_id
         and poud.corporate_id = pc_corporate_id;
    exception
      when others then
        dbms_output.put_line('SQLERRM-2' || sqlerrm);
    end;
    vc_error_msg := '19';
    update poud_phy_open_unreal_daily poud
       set poud.trade_day_pnl_in_val_cur  = nvl(poud.unrealized_pnl_in_val_cur,
                                                0) - nvl(poud.prev_day_unr_pnl_in_val_cur,
                                                         0),
           poud.trade_day_pnl_in_base_cur = nvl(poud.unrealized_pnl_in_base_cur,
                                                0) - nvl(poud.prev_day_unr_pnl_in_base_cur,
                                                         0)
     where poud.process_id = pc_process_id
       and poud.corporate_id = pc_corporate_id
       and poud.unrealized_type = 'Unrealized';
  exception
    when others then
      dbms_output.put_line('failed with ' || sqlerrm);
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure sp_calc_phy_open_unreal_pnl',
                                                           'M2M-013',
                                                           'Code:' ||
                                                           sqlcode ||
                                                           'Message:' ||
                                                           sqlerrm || ' ' ||
                                                           vc_error_msg,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;

  procedure sp_calc_phy_opencon_unreal_pnl(pc_corporate_id varchar2,
                                           pd_trade_date   date,
                                           pc_process_id   varchar2,
                                           pc_user_id      varchar2,
                                           pc_dbd_id       varchar2) is
  
    cursor cur_unrealized is
      select pcm.corporate_id,
             akc.corporate_name,
             pc_process_id,
             pcdi.pcdi_id,
             pcdi.delivery_item_no,
             pcdi.prefix,
             pcdi.middle_no,
             pcdi.suffix,
             pcdi.internal_contract_ref_no,
             pcm.contract_ref_no,
             pcm.issue_date,
             pci.internal_contract_item_ref_no,
             pci.del_distribution_item_no,
             pcdi.basis_type,
             pcdi.delivery_period_type,
             pcdi.delivery_from_month,
             pcdi.delivery_from_year,
             pcdi.delivery_to_month,
             pcdi.delivery_to_year,
             pcdi.delivery_from_date,
             pcdi.delivery_to_date,
             pcdi.transit_days,
             pcm.purchase_sales,
             pcm.contract_status,
             'Unrealized' unrealized_type,
             pcpd.profit_center_id,
             cpc.profit_center_name,
             cpc.profit_center_short_name,
             pcm.cp_id,
             phd_cp.companyname cp_name,
             pcm.trader_id,
             (case
               when pcm.trader_id is not null then
                (select gab.firstname || ' ' || gab.lastname
                   from gab_globaladdressbook       gab,
                        ak_corporate_user@eka_appdb aku
                  where gab.gabid = aku.gabid
                    and aku.user_id = pcm.trader_id)
               else
                ''
             end) trader_user_name,
             pcpd.product_id conc_product_id,
             pdm_conc.product_desc conc_product_name,
             aml.underlying_product_id product_id,
             pdm.product_desc product_name,
             ciqs.open_qty item_qty,
             ciqs.item_qty_unit_id qty_unit_id,
             qum.qty_unit,
             qum.decimals item_qty_decimal,
             pcpq.quality_template_id conc_quality_id,
             qat.quality_name conc_quality_name,
             qav.comp_quality_id quality_id,
             qat_und.quality_name,
             pcdb.inco_term_id,
             itm.incoterm,
             pcdb.city_id origination_city_id,
             cim1.city_name origination_city,
             pcdb.country_id origination_country_id,
             cym1.country_name origination_country,
             pcdb.city_id destination_city_id,
             cim2.city_name destination_city,
             pcdb.country_id destination_country_id,
             cym2.country_name destination_country,
             rem_cym1.region_id origination_region_id,
             rem_cym1.region_name origination_region,
             rem_cym2.region_id destination_region_id,
             rem_cym2.region_name destination_region,
             pcm.payment_term_id,
             pym.payment_term,
             cm.cur_id as base_cur_id,
             cm.cur_code as base_cur_code,
             cm.decimals as base_cur_decimal,
             gcd.groupid,
             gcd.groupname,
             cm_gcd.cur_id cur_id_gcd,
             cm_gcd.cur_code cur_code_gcd,
             qum_gcd.qty_unit_id qty_unit_id_gcd,
             qum_gcd.qty_unit qty_unit_gcd,
             qum_pdm.qty_unit_id as base_qty_unit_id,
             qum_pdm.qty_unit as base_qty_unit,
             qum_pdm.decimals as base_qty_decimal,
             qum_pdm_conc.qty_unit_id as conc_base_qty_unit_id,
             qum_pdm_conc.qty_unit as conc_base_qty_unit,
             qum_pdm_conc.decimals as conc_base_qty_decimal,
             pcpd.strategy_id,
             css.strategy_name,
             cipde.element_id,
             aml.attribute_name,
             pcpq.assay_header_id,
             pcpq.unit_of_measure,
             ceqs.assay_qty,
             ceqs.assay_qty_unit_id,
             cipq.payable_qty,
             cipq.qty_unit_id payable_qty_unit_id,
             cipde.contract_price,
             cipde.price_unit_id,
             cipde.price_unit_cur_id,
             cipde.price_unit_cur_code,
             cipde.price_unit_weight_unit_id,
             cipde.price_unit_weight,
             cipde.price_unit_weight_unit,
             --   cipde.treatment_charge,
             --  cipde.refining_charge,
             --  cipde.penalty_charge,
             cipde.price_basis fixation_method,
             cipde.price_description,
             cipde.price_fixation_status,
             cipde.price_fixation_details,
             nvl(cipde.payment_due_date, pd_trade_date) payment_due_date,
             pci.expected_delivery_month || '-' ||
             pci.expected_delivery_year item_delivery_period_string,
             md.net_m2m_price net_m2m_price,
             md.m2m_price_unit_id,
             md.m2m_price_unit_cur_id,
             md.m2m_price_unit_cur_code,
             md.m2m_price_unit_weight,
             md.m2m_price_unit_weight_unit_id,
             md.m2m_price_unit_weight_unit,
             md.m2m_main_cur_id,
             md.m2m_main_cur_code,
             md.m2m_main_cur_decimals,
             md.main_currency_factor,
             md.md_id,
             0 m2m_amt,
             nvl(md.treatment_charge, 0) m2m_treatment_charge, -- will be in base price unit id
             nvl(md.refine_charge, 0) m2m_refining_charge, -- will be in base price unit id
             nvl(md.penalty_charge, 0) m2m_penalty_charge, -- will be in base price unit id
             tc_ppu_pum.price_unit_id m2m_tc_price_unit_id,
             tc_ppu_pum.price_unit_name m2m_tc_price_unit_name,
             tc_ppu_pum.cur_id m2m_tc_cur_id,
             tc_ppu_pum.weight m2m_tc_weight,
             tc_ppu_pum.weight_unit_id m2m_tc_weight_unit_id,
             rc_ppu_pum.price_unit_id m2m_rc_price_unit_id,
             rc_ppu_pum.price_unit_name m2m_rc_price_unit_name,
             rc_ppu_pum.cur_id m2m_rc_cur_id,
             rc_ppu_pum.weight m2m_rc_weight,
             rc_ppu_pum.weight_unit_id m2m_rc_weight_unit_id,
             nvl((select sum(cisc.avg_cost)
                   from cisc_contract_item_sec_cost cisc
                  where cisc.internal_contract_item_ref_no =
                        pci.internal_contract_item_ref_no
                    and cisc.process_id = pc_process_id),
                 0) sc_in_base_cur,
             md.derivative_def_id,
             md.valuation_exchange_id,
             emt.exchange_name,
             md.valuation_dr_id,
             drm.dr_id_name,
             md.valuation_month,
             md.valuation_date,
             md.m2m_loc_incoterm_deviation,
             dense_rank() over(partition by pci.internal_contract_item_ref_no order by cipde.element_id) ele_rank,
             md.base_price_unit_id_in_ppu,
             md.base_price_unit_id_in_pum,
             pum_base_price_id.price_unit_name base_price_unit_name,
             pum_loc_base.weight_unit_id loc_qty_unit_id,
             tmpc.mvp_id,
             tmpc.shipment_month,
             tmpc.shipment_year,
             nvl(pdm_conc.valuation_against_underlying, 'Y') valuation_against_underlying
        from pcm_physical_contract_main pcm,
             ak_corporate akc,
             pcdi_pc_delivery_item pcdi,
             pci_physical_contract_item pci,
             pcpd_pc_product_definition pcpd,
             cpc_corporate_profit_center cpc,
             phd_profileheaderdetails phd_cp,
             pdm_productmaster pdm,
             ciqs_contract_item_qty_status ciqs,
             qum_quantity_unit_master qum,
             pcpq_pc_product_quality pcpq,
             qat_quality_attributes qat,
             qat_quality_attributes qat_und,
             qav_quality_attribute_values qav,
             ppm_product_properties_mapping ppm,
             aml_attribute_master_list aml,
             pcdb_pc_delivery_basis pcdb,
             itm_incoterm_master itm,
             cim_citymaster cim1,
             cim_citymaster cim2,
             cym_countrymaster cym1,
             cym_countrymaster cym2,
             rem_region_master@eka_appdb rem_cym1,
             rem_region_master@eka_appdb rem_cym2,
             pym_payment_terms_master pym,
             cm_currency_master cm,
             gcd_groupcorporatedetails gcd,
             cm_currency_master cm_gcd,
             qum_quantity_unit_master qum_gcd,
             qum_quantity_unit_master qum_pdm,
             pdm_productmaster pdm_conc,
             qum_quantity_unit_master qum_pdm_conc,
             css_corporate_strategy_setup css,
             pum_price_unit_master pum_base_price_id,
             pum_price_unit_master pum_loc_base,
             cipde_cipd_element_price cipde,
             (select md1.*
                from md_m2m_daily md1
               where md1.rate_type = 'OPEN'
                 and md1.corporate_id = pc_corporate_id
                 and md1.product_type = 'CONCENTRATES'
                 and md1.process_id = pc_process_id) md,
             (select tmp.*
                from tmpc_temp_m2m_pre_check tmp
               where tmp.corporate_id = pc_corporate_id
                 and tmp.product_type = 'CONCENTRATES'
                 and tmp.section_name = 'OPEN') tmpc,
             drm_derivative_master drm,
             emt_exchangemaster emt,
             v_ppu_pum tc_ppu_pum,
             v_ppu_pum rc_ppu_pum,
             cipq_contract_item_payable_qty cipq,
             ceqs_contract_ele_qty_status ceqs
       where pcm.corporate_id = akc.corporate_id
         and pcm.internal_contract_ref_no = pcdi.internal_contract_ref_no
         and pcdi.pcdi_id = pci.pcdi_id
         and pcm.internal_contract_ref_no = pcpd.internal_contract_ref_no
         and pcpd.profit_center_id = cpc.profit_center_id
         and pcm.cp_id = phd_cp.profileid
         and pci.internal_contract_item_ref_no =
             ciqs.internal_contract_item_ref_no
         and ciqs.item_qty_unit_id = qum.qty_unit_id
         and pci.pcpq_id = pcpq.pcpq_id
         and pcpq.quality_template_id = qat.quality_id
         and qat.quality_id = qav.quality_id
         and qav.attribute_id = ppm.property_id
         and qav.comp_quality_id = qat_und.quality_id
         and ppm.attribute_id = aml.attribute_id
         and aml.underlying_product_id = pdm.product_id
         and aml.attribute_id = cipde.element_id
         and pci.pcdb_id = pcdb.pcdb_id
         and pcdb.inco_term_id = itm.incoterm_id
         and pcdb.city_id = cim1.city_id(+)
         and pcdb.city_id = cim2.city_id(+)
         and pcdb.country_id = cym1.country_id(+)
         and pcdb.country_id = cym2.country_id(+)
         and cym1.region_id = rem_cym1.region_id(+)
         and cym2.region_id = rem_cym2.region_id(+)
         and pcm.payment_term_id = pym.payment_term_id
         and akc.base_cur_id = cm.cur_id
         and akc.groupid = gcd.groupid
         and gcd.group_cur_id = cm_gcd.cur_id(+)
         and gcd.group_qty_unit_id = qum_gcd.qty_unit_id(+)
         and qum_pdm.qty_unit_id = pdm.base_quantity_unit
         and pcpd.product_id = pdm_conc.product_id
         and qum_pdm_conc.qty_unit_id = pdm_conc.base_quantity_unit
         and pcpd.strategy_id = css.strategy_id
         and pci.internal_contract_item_ref_no =
             cipde.internal_contract_item_ref_no
         and pci.internal_contract_item_ref_no =
             tmpc.internal_contract_item_ref_no(+)
         and tmpc.element_id = cipde.element_id
         and tmpc.internal_m2m_id = md.md_id(+)
         and md.element_id = cipde.element_id
         and md.valuation_dr_id = drm.dr_id(+)
         and md.valuation_exchange_id = emt.exchange_id(+)
         and pcm.corporate_id = pc_corporate_id
         and ciqs.open_qty > 0
         and pcm.contract_status = 'In Position'
         and pcm.contract_type = 'CONCENTRATES'
         and pcpd.input_output = 'Input'
         and pcm.is_tolling_contract = 'N'
         and pcm.is_tolling_extn = 'N'
         and pcm.is_active = 'Y'
         and pci.is_active = 'Y'
         and pcdi.is_active = 'Y'
         and pcdb.is_active = 'Y'
         and pcpd.is_active = 'Y'
         and pcpq.is_active = 'Y'
         and ciqs.is_active = 'Y'
         and ppm.is_active = 'Y'
         and ppm.is_deleted = 'N'
         and qav.is_deleted = 'N'
         and qav.is_comp_product_attribute = 'Y'
         and qat.is_active = 'Y'
         and qat.is_deleted = 'N'
         and aml.is_active = 'Y'
         and aml.is_deleted = 'N'
         and qat_und.is_active = 'Y'
         and qat_und.is_deleted = 'N'
         and md.base_price_unit_id_in_pum = pum_base_price_id.price_unit_id
         and md.base_price_unit_id_in_pum = pum_loc_base.price_unit_id
         and md.tc_price_unit_id = tc_ppu_pum.product_price_unit_id
         and md.rc_price_unit_id = rc_ppu_pum.product_price_unit_id
         and pci.internal_contract_item_ref_no =
             cipq.internal_contract_item_ref_no
         and aml.attribute_id = cipq.element_id
         and pci.internal_contract_item_ref_no =
             ceqs.internal_contract_item_ref_no
         and aml.attribute_id = ceqs.element_id
         and pcm.process_id = pc_process_id
         and pcdi.process_id = pc_process_id
         and pci.process_id = pc_process_id
         and pcpd.process_id = pc_process_id
         and ciqs.process_id = pc_process_id
         and pcpq.process_id = pc_process_id
         and pcdb.process_id = pc_process_id
         and cipde.process_id = pc_process_id
         and cipq.process_id = pc_process_id
         and ceqs.process_id = pc_process_id;
    vn_ele_qty_in_base        number;
    vn_ele_m2m_amt            number;
    vc_m2m_cur_id             varchar2(15);
    vc_m2m_cur_code           varchar2(15);
    vn_m2m_base_fx_rate       number;
    vn_m2m_base_deviation     number;
    vn_m2m_sub_cur_id_factor  number;
    vn_m2m_cur_decimals       number;
    vn_ele_m2m_amount_in_base number;
    vn_ele_m2m_total_amount   number;
    --vn_ele_m2m_total_premium_amt   number;
    --vn_ele_m2m_premium_amt         number;
    vc_price_cur_id                varchar2(15);
    vc_price_cur_code              varchar2(15);
    vn_cont_price_cur_id_factor    number;
    vn_cont_price_cur_decimals     number;
    vn_ele_cont_value_in_price_cur number;
    vn_fx_price_to_base            number;
    vn_forward_exch_rate           number;
    --vc_base_price_unit             varchar2(15);
    vn_ele_cont_premium           number;
    vn_ele_cont_total_premium     number;
    vn_ele_cont_value_in_base_cur number;
    --vn_ele_sc_in_base_cur          number;
    vn_ele_exp_cog_in_base_cur    number;
    vn_ele_unreal_pnl_in_base_cur number;
    vn_unrealized_pnl_in_m2m_unit number;
    vc_m2m_price_unit_id          varchar2(15);
    vc_m2m_price_unit_cur_id      varchar2(15);
    vc_m2m_price_unit_cur_code    varchar2(15);
    vc_m2m_price_unit_wgt_unit_id varchar2(15);
    vc_m2m_price_unit_wgt_unit    varchar2(15);
    vn_m2m_price_unit_wgt_unit_wt number;
    vobj_error_log                tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count            number := 1;
    vn_dry_qty                    number;
    vn_wet_qty                    number;
    --vn_m2m_total_amount            number;
    --vn_cont_value_in_base_cur      number;
    --vn_cont_total_premium          number;
    vn_sc_in_base_cur number;
    --vn_exp_cog_in_base_cur         number;
    --vn_unreal_pnl_in_base_cur      number;
    vn_qty_in_base               number;
    vn_con_treatment_charge      number;
    vc_con_treatment_cur_id      varchar2(15);
    vn_base_con_treatment_charge number;
    vn_con_refine_charge         number;
    vc_con_refine_cur_id         varchar2(15);
    vn_base_con_refine_charge    number;
    vn_con_penality_charge       number;
    vn_base_con_penality_charge  number;
    --vn_con_penality_per_elemet     number;
    vc_con_penality_cur_id      varchar2(15);
    vn_dry_qty_in_base          number;
    vn_ele_m2m_treatment_charge number;
    vn_ele_m2m_refine_charge    number;
    vn_loc_amount               number;
    vn_loc_total_amount         number;
    vn_penality                 number;
    vc_penality_price_unit_id   varchar2(20);
    vn_total_penality           number;
    vc_price_unit_id            varchar2(15);
  
  begin
    for cur_unrealized_rows in cur_unrealized
    loop
    
      -- convert wet qty to dry qty
      if cur_unrealized_rows.unit_of_measure = 'Wet' then
        vn_dry_qty := round(pkg_metals_general.fn_get_assay_dry_qty(cur_unrealized_rows.conc_product_id,
                                                                    cur_unrealized_rows.assay_header_id,
                                                                    cur_unrealized_rows.item_qty,
                                                                    cur_unrealized_rows.qty_unit_id),
                            cur_unrealized_rows.item_qty_decimal);
      else
        vn_dry_qty := cur_unrealized_rows.item_qty;
      end if;
    
      vn_wet_qty := cur_unrealized_rows.item_qty;
    
      -- convert into dry qty to base qty element level
    
      vn_dry_qty_in_base := round(pkg_general.f_get_converted_quantity(cur_unrealized_rows.conc_product_id,
                                                                       cur_unrealized_rows.qty_unit_id,
                                                                       cur_unrealized_rows.base_qty_unit_id,
                                                                       1) *
                                  vn_dry_qty,
                                  cur_unrealized_rows.base_qty_decimal);
    
      -- contract treatment charges
      pkg_metals_general.sp_get_treatment_charge(cur_unrealized_rows.internal_contract_item_ref_no,
                                                 cur_unrealized_rows.element_id,
                                                 pc_dbd_id,
                                                 vn_dry_qty,
                                                 vn_wet_qty,
                                                 cur_unrealized_rows.qty_unit_id,
                                                 cur_unrealized_rows.contract_price,
                                                 cur_unrealized_rows.price_unit_id,
                                                 vn_con_treatment_charge,
                                                 vc_con_treatment_cur_id);
      -- converted treatment charges to base currency                                           
      vn_base_con_treatment_charge := round(pkg_general.f_get_converted_currency_amt(cur_unrealized_rows.corporate_id,
                                                                                     vc_con_treatment_cur_id,
                                                                                     cur_unrealized_rows.base_cur_id,
                                                                                     pd_trade_date,
                                                                                     vn_con_treatment_charge),
                                            cur_unrealized_rows.base_cur_decimal);
    
      --- contract refine chrges
      pkg_metals_general.sp_get_refine_charge(cur_unrealized_rows.internal_contract_item_ref_no,
                                              cur_unrealized_rows.element_id,
                                              pc_dbd_id,
                                              cur_unrealized_rows.payable_qty,
                                              cur_unrealized_rows.payable_qty_unit_id,
                                              cur_unrealized_rows.contract_price,
                                              cur_unrealized_rows.price_unit_id,
                                              vn_con_refine_charge,
                                              vc_con_refine_cur_id);
    
      --- converted refine charges to base currency                                              
    
      vn_base_con_refine_charge := round(pkg_general.f_get_converted_currency_amt(cur_unrealized_rows.corporate_id,
                                                                                  vc_con_refine_cur_id,
                                                                                  cur_unrealized_rows.base_cur_id,
                                                                                  pd_trade_date,
                                                                                  vn_con_refine_charge),
                                         cur_unrealized_rows.base_cur_decimal);
      --- contract penality chrges   
      if cur_unrealized_rows.ele_rank = 1 then
        pkg_metals_general.sp_get_penalty_charge(cur_unrealized_rows.internal_contract_item_ref_no,
                                                 pc_dbd_id,
                                                 vn_dry_qty,
                                                 cur_unrealized_rows.qty_unit_id,
                                                 vn_con_penality_charge,
                                                 vc_con_penality_cur_id);
      
        vn_base_con_penality_charge := round(pkg_general.f_get_converted_currency_amt(cur_unrealized_rows.corporate_id,
                                                                                      vc_con_penality_cur_id,
                                                                                      cur_unrealized_rows.base_cur_id,
                                                                                      pd_trade_date,
                                                                                      vn_con_penality_charge),
                                             cur_unrealized_rows.base_cur_decimal);
      end if;
    
      vn_qty_in_base := round(pkg_general.f_get_converted_quantity(cur_unrealized_rows.conc_product_id,
                                                                   cur_unrealized_rows.qty_unit_id,
                                                                   cur_unrealized_rows.conc_base_qty_unit_id,
                                                                   1) *
                              vn_wet_qty,
                              cur_unrealized_rows.conc_base_qty_decimal);
    
      vn_ele_qty_in_base := round(pkg_general.f_get_converted_quantity(cur_unrealized_rows.product_id,
                                                                       cur_unrealized_rows.payable_qty_unit_id,
                                                                       cur_unrealized_rows.base_qty_unit_id,
                                                                       1) *
                                  cur_unrealized_rows.payable_qty,
                                  cur_unrealized_rows.base_qty_decimal);
      if cur_unrealized_rows.valuation_against_underlying = 'Y' then
        vn_ele_m2m_amt := nvl(cur_unrealized_rows.net_m2m_price, 0) /
                          nvl(cur_unrealized_rows.m2m_price_unit_weight, 1) *
                          pkg_general.f_get_converted_quantity(cur_unrealized_rows.product_id,
                                                               cur_unrealized_rows.payable_qty_unit_id,
                                                               cur_unrealized_rows.m2m_price_unit_weight_unit_id,
                                                               cur_unrealized_rows.payable_qty);
      
        pkg_general.sp_get_main_cur_detail(nvl(cur_unrealized_rows.m2m_price_unit_cur_id,
                                               cur_unrealized_rows.base_cur_id),
                                           vc_m2m_cur_id,
                                           vc_m2m_cur_code,
                                           vn_m2m_sub_cur_id_factor,
                                           vn_m2m_cur_decimals);
        vn_ele_m2m_amt := round(vn_ele_m2m_amt * vn_m2m_sub_cur_id_factor,
                                vn_m2m_cur_decimals);
      
        pkg_general.sp_forward_cur_exchange_new(cur_unrealized_rows.corporate_id,
                                                pd_trade_date,
                                                cur_unrealized_rows.payment_due_date,
                                                vc_m2m_cur_id,
                                                cur_unrealized_rows.base_cur_id,
                                                30,
                                                vn_m2m_base_fx_rate,
                                                vn_m2m_base_deviation);
        if vc_m2m_cur_id <> cur_unrealized_rows.base_cur_id then
          if vn_m2m_base_fx_rate is null or vn_m2m_base_fx_rate = 0 then
            vobj_error_log.extend;
            vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                 'procedure pkg_phy_physical_process-sp_calc_phy_open_unrealized ',
                                                                 'PHY-005',
                                                                 cur_unrealized_rows.base_cur_code ||
                                                                 ' to ' ||
                                                                 vc_m2m_cur_code || ' (' ||
                                                                 to_char(cur_unrealized_rows.payment_due_date,
                                                                         'dd-Mon-yyyy') || ') ',
                                                                 '',
                                                                 gvc_process,
                                                                 pc_user_id,
                                                                 sysdate,
                                                                 pd_trade_date);
            sp_insert_error_log(vobj_error_log);
          end if;
        end if;
        vn_ele_m2m_amount_in_base := vn_ele_m2m_amt * vn_m2m_base_fx_rate;
      else
        vn_ele_m2m_amt := nvl(cur_unrealized_rows.net_m2m_price, 0) /
                          nvl(cur_unrealized_rows.m2m_price_unit_weight, 1) *
                          pkg_general.f_get_converted_quantity(cur_unrealized_rows.conc_product_id,
                                                               cur_unrealized_rows.conc_base_qty_unit_id,
                                                               cur_unrealized_rows.m2m_price_unit_weight_unit_id,
                                                               vn_dry_qty_in_base);
      
        pkg_general.sp_get_main_cur_detail(nvl(cur_unrealized_rows.m2m_price_unit_cur_id,
                                               cur_unrealized_rows.base_cur_id),
                                           vc_m2m_cur_id,
                                           vc_m2m_cur_code,
                                           vn_m2m_sub_cur_id_factor,
                                           vn_m2m_cur_decimals);
        vn_ele_m2m_amt := round(vn_ele_m2m_amt * vn_m2m_sub_cur_id_factor,
                                vn_m2m_cur_decimals);
      
        pkg_general.sp_forward_cur_exchange_new(cur_unrealized_rows.corporate_id,
                                                pd_trade_date,
                                                cur_unrealized_rows.payment_due_date,
                                                vc_m2m_cur_id,
                                                cur_unrealized_rows.base_cur_id,
                                                30,
                                                vn_m2m_base_fx_rate,
                                                vn_m2m_base_deviation);
        if vc_m2m_cur_id <> cur_unrealized_rows.base_cur_id then
          if vn_m2m_base_fx_rate is null or vn_m2m_base_fx_rate = 0 then
            vobj_error_log.extend;
            vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                 'procedure pkg_phy_physical_process-sp_calc_phy_open_unrealized ',
                                                                 'PHY-005',
                                                                 cur_unrealized_rows.base_cur_code ||
                                                                 ' to ' ||
                                                                 vc_m2m_cur_code || ' (' ||
                                                                 to_char(cur_unrealized_rows.payment_due_date,
                                                                         'dd-Mon-yyyy') || ') ',
                                                                 '',
                                                                 gvc_process,
                                                                 pc_user_id,
                                                                 sysdate,
                                                                 pd_trade_date);
            sp_insert_error_log(vobj_error_log);
          end if;
        end if;
        if cur_unrealized_rows.ele_rank = 1 then
          vn_ele_m2m_amount_in_base := vn_ele_m2m_amt * vn_m2m_base_fx_rate;
        else
          vn_ele_m2m_amount_in_base := 0;
          vn_ele_m2m_amt            := 0;
        end if;
      end if;
    
      /*vn_ele_m2m_treatment_charge := round(cur_unrealized_rows.m2m_treatment_charge *
                                           vn_dry_qty_in_base,
                                           cur_unrealized_rows.base_cur_decimal);
      vn_ele_m2m_refine_charge    := round(cur_unrealized_rows.m2m_refining_charge *
                                           vn_ele_qty_in_base,
                                           cur_unrealized_rows.base_cur_decimal);*/
    
      vn_ele_m2m_treatment_charge := round((cur_unrealized_rows.m2m_treatment_charge /
                                           nvl(cur_unrealized_rows.m2m_tc_weight,
                                                1)) *
                                           pkg_general.f_get_converted_currency_amt(pc_corporate_id,
                                                                                    cur_unrealized_rows.m2m_tc_cur_id,
                                                                                    cur_unrealized_rows.base_cur_id,
                                                                                    pd_trade_date,
                                                                                    1) *
                                           (pkg_general.f_get_converted_quantity(cur_unrealized_rows.conc_product_id,
                                                                                 cur_unrealized_rows.qty_unit_id,
                                                                                 cur_unrealized_rows.m2m_tc_weight_unit_id,
                                                                                 vn_dry_qty)),
                                           cur_unrealized_rows.base_cur_decimal);
    
      vn_ele_m2m_refine_charge := round((cur_unrealized_rows.m2m_refining_charge /
                                        nvl(cur_unrealized_rows.m2m_rc_weight,
                                             1)) *
                                        pkg_general.f_get_converted_currency_amt(pc_corporate_id,
                                                                                 cur_unrealized_rows.m2m_rc_cur_id,
                                                                                 cur_unrealized_rows.base_cur_id,
                                                                                 pd_trade_date,
                                                                                 1) *
                                        (pkg_general.f_get_converted_quantity(cur_unrealized_rows.product_id,
                                                                              cur_unrealized_rows.payable_qty_unit_id,
                                                                              cur_unrealized_rows.m2m_rc_weight_unit_id,
                                                                              cur_unrealized_rows.payable_qty)),
                                        cur_unrealized_rows.base_cur_decimal);
    
      vn_loc_amount := round(pkg_general.f_get_converted_quantity(cur_unrealized_rows.conc_product_id,
                                                                  cur_unrealized_rows.loc_qty_unit_id,
                                                                  cur_unrealized_rows.conc_base_qty_unit_id,
                                                                  1) *
                             cur_unrealized_rows.m2m_loc_incoterm_deviation,
                             cur_unrealized_rows.base_cur_decimal);
    
      vn_loc_total_amount := round(vn_loc_amount * vn_qty_in_base,
                                   cur_unrealized_rows.base_cur_decimal);
      vn_total_penality   := 0;
      if cur_unrealized_rows.ele_rank = 1 then
        begin
          select ppu.product_price_unit_id
            into vc_price_unit_id
            from v_ppu_pum         ppu,
                 pdm_productmaster pdm,
                 ak_corporate      akc
           where ppu.product_id = cur_unrealized_rows.conc_product_id
             and ppu.product_id = pdm.product_id
             and pdm.base_quantity_unit = ppu.weight_unit_id
             and ppu.cur_id = akc.base_cur_id
             and nvl(ppu.weight, 1) = 1
             and akc.corporate_id = pc_corporate_id;
        
        exception
          when no_data_found then
            vc_price_unit_id := null;
        end;
        vn_total_penality := 0;
        for cc in (select pci.internal_contract_item_ref_no,
                          pqca.element_id,
                          pcpq.quality_template_id
                     from pci_physical_contract_item  pci,
                          pcpq_pc_product_quality     pcpq,
                          ash_assay_header            ash,
                          asm_assay_sublot_mapping    asm,
                          pqca_pq_chemical_attributes pqca
                    where pci.pcpq_id = pcpq.pcpq_id
                      and pcpq.assay_header_id = ash.ash_id
                      and ash.ash_id = asm.ash_id
                      and asm.asm_id = pqca.asm_id
                      and pci.process_id = pc_process_id
                      and pcpq.process_id = pc_process_id
                      and pci.is_active = 'Y'
                      and pcpq.is_active = 'Y'
                      and ash.is_active = 'Y'
                      and asm.is_active = 'Y'
                      and pqca.is_active = 'Y'
                      and pqca.is_elem_for_pricing = 'N'
                      and pqca.is_deductible = 'N'
                      and pci.internal_contract_item_ref_no =
                          cur_unrealized_rows.internal_contract_item_ref_no)
        loop
        
          pkg_phy_pre_check_process.sp_calc_m2m_tc_pc_rc_charge(cur_unrealized_rows.corporate_id,
                                                                pd_trade_date,
                                                                cur_unrealized_rows.conc_product_id,
                                                                cur_unrealized_rows.conc_quality_id,
                                                                cur_unrealized_rows.mvp_id,
                                                                'Penalties',
                                                                cc.element_id,
                                                                cur_unrealized_rows.shipment_month,
                                                                cur_unrealized_rows.shipment_year,
                                                                vc_price_unit_id,
                                                                vn_penality,
                                                                vc_penality_price_unit_id);
          if nvl(vn_penality, 0) <> 0 then
            vn_total_penality := round(vn_total_penality +
                                       (vn_penality * vn_dry_qty_in_base),
                                       cur_unrealized_rows.base_cur_decimal);
          end if;
        
        end loop;
      
      end if;
    
      /* vn_ele_m2m_premium_amt       := (cur_unrealized_rows.m2m_treatment_charge*vn_dry_qty_in_base) +
                                      (cur_unrealized_rows.m2m_refining_charge*vn_ele_qty_in_base);
                                      
      vn_ele_m2m_total_premium_amt := vn_ele_qty_in_base *
                                      nvl(vn_ele_m2m_premium_amt, 0);
                                      
      vn_ele_m2m_total_amount      := vn_ele_m2m_amount_in_base -
                                      vn_ele_m2m_total_premium_amt; */
    
      vn_ele_m2m_total_amount := vn_ele_m2m_amount_in_base -
                                 vn_ele_m2m_treatment_charge -
                                 vn_ele_m2m_refine_charge;
    
      pkg_general.sp_get_main_cur_detail(cur_unrealized_rows.price_unit_cur_id,
                                         vc_price_cur_id,
                                         vc_price_cur_code,
                                         vn_cont_price_cur_id_factor,
                                         vn_cont_price_cur_decimals);
    
      vn_ele_cont_value_in_price_cur := (cur_unrealized_rows.contract_price /
                                        nvl(cur_unrealized_rows.price_unit_weight,
                                             1)) *
                                        (pkg_general.f_get_converted_quantity(cur_unrealized_rows.product_id,
                                                                              cur_unrealized_rows.payable_qty_unit_id,
                                                                              cur_unrealized_rows.price_unit_weight_unit_id,
                                                                              cur_unrealized_rows.payable_qty)) *
                                        vn_cont_price_cur_id_factor;
    
      pkg_general.sp_forward_cur_exchange_new(cur_unrealized_rows.corporate_id,
                                              pd_trade_date,
                                              cur_unrealized_rows.payment_due_date,
                                              vc_price_cur_id,
                                              cur_unrealized_rows.base_cur_id,
                                              30,
                                              vn_fx_price_to_base,
                                              vn_forward_exch_rate);
      if vc_price_cur_id <> cur_unrealized_rows.base_cur_id then
        if vn_fx_price_to_base is null or vn_fx_price_to_base = 0 then
          vobj_error_log.extend;
          vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                               'procedure sp_calc_phy_opencon_unreal_pnl',
                                                               'PHY-005',
                                                               cur_unrealized_rows.base_cur_code ||
                                                               ' to ' ||
                                                               vc_price_cur_code,
                                                               '',
                                                               gvc_process,
                                                               pc_user_id,
                                                               sysdate,
                                                               pd_trade_date);
          sp_insert_error_log(vobj_error_log);
        
        end if;
      end if;
    
      -- contract value in value currency will store the data in base currency
      vn_ele_cont_value_in_price_cur := round(vn_ele_cont_value_in_price_cur *
                                              nvl(vn_fx_price_to_base, 1),
                                              cur_unrealized_rows.base_cur_decimal);
    
      vn_ele_cont_premium := vn_base_con_treatment_charge +
                             vn_base_con_refine_charge;
    
      vn_ele_cont_total_premium := round((nvl(vn_ele_cont_premium, 0) *
                                         vn_ele_qty_in_base),
                                         cur_unrealized_rows.base_cur_decimal);
    
      vn_ele_cont_value_in_base_cur := vn_ele_cont_value_in_price_cur -
                                       vn_ele_cont_total_premium;
      -- secondray cost                                 
      if cur_unrealized_rows.ele_rank = 1 then
        vn_sc_in_base_cur := round(cur_unrealized_rows.sc_in_base_cur *
                                   vn_qty_in_base,
                                   cur_unrealized_rows.base_cur_decimal);
      end if;
    
      -- vn_ele_exp_cog_in_base_cur := round((abs(vn_ele_cont_value_in_base_cur)),2);
    
      /*  if cur_unrealized_rows.purchase_sales = 'P' then
        vn_ele_unreal_pnl_in_base_cur := round((vn_ele_m2m_total_amount -
                                               vn_ele_exp_cog_in_base_cur),
                                               2);
      else
        vn_ele_unreal_pnl_in_base_cur := round((vn_ele_exp_cog_in_base_cur -
                                               vn_ele_m2m_total_amount),
                                               2);
      end if;*/
    
      -- below variable set as zero as it's not used in any calculation.
      vn_unrealized_pnl_in_m2m_unit := 0;
      vc_m2m_price_unit_id          := cur_unrealized_rows.m2m_price_unit_id;
      vc_m2m_price_unit_cur_id      := cur_unrealized_rows.m2m_price_unit_cur_id;
      vc_m2m_price_unit_cur_code    := cur_unrealized_rows.m2m_price_unit_cur_code;
      vc_m2m_price_unit_wgt_unit_id := cur_unrealized_rows.m2m_price_unit_weight_unit_id;
      vc_m2m_price_unit_wgt_unit    := cur_unrealized_rows.m2m_price_unit_weight_unit;
      vn_m2m_price_unit_wgt_unit_wt := cur_unrealized_rows.m2m_price_unit_weight;
    
      insert into poued_element_details
        (corporate_id,
         corporate_name,
         process_id,
         md_id,
         internal_contract_item_ref_no,
         element_id,
         element_name,
         assay_header_id,
         assay_qty,
         assay_qty_unit_id,
         payable_qty,
         payable_qty_unit_id,
         refining_charge,
         treatment_charge,
         -- penalty_charge,
         pricing_details,
         contract_price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         price_unit_weight_unit_id,
         price_unit_weight,
         price_unit_weight_unit,
         m2m_price,
         m2m_price_unit_id,
         m2m_price_cur_id,
         m2m_price_cur_code,
         m2m_price_weight,
         m2m_price_weght_unit_id,
         m2m_price_weight_unit,
         contract_value,
         contract_value_cur_id,
         contract_value_cur_code,
         contract_value_in_base,
         contract_premium_value_in_base,
         m2m_value,
         m2m_value_cur_id,
         m2m_value_cur_code,
         m2m_refining_charge,
         m2m_treatment_charge,
         -- m2m_penalty_charge,
         m2m_loc_diff,
         m2m_amt_in_base,
         -- sc_in_base_cur,
         valuation_dr_id,
         valuation_dr_id_name,
         valuation_month,
         valuation_date,
         expected_cog_net_sale_value,
         unrealized_pnl_in_base_cur,
         base_cur_id,
         base_cur_code,
         price_cur_to_base_cur_fx_rate,
         m2m_cur_to_base_cur_fx_rate,
         derivative_def_id,
         valuation_exchange_id,
         valuation_exchange,
         element_qty_in_base_unit,
         base_price_unit_id_ppu,
         base_price_unit_name,
         valuation_against_underlying)
      values
        (cur_unrealized_rows.corporate_id,
         cur_unrealized_rows.corporate_name,
         pc_process_id,
         cur_unrealized_rows.md_id,
         cur_unrealized_rows.internal_contract_item_ref_no,
         cur_unrealized_rows.element_id,
         cur_unrealized_rows.attribute_name,
         cur_unrealized_rows.assay_header_id,
         cur_unrealized_rows.assay_qty,
         cur_unrealized_rows.assay_qty_unit_id,
         cur_unrealized_rows.payable_qty,
         cur_unrealized_rows.payable_qty_unit_id,
         vn_base_con_refine_charge,
         vn_base_con_treatment_charge,
         -- vn_con_penality_per_elemet,
         cur_unrealized_rows.attribute_name ||
         cur_unrealized_rows.price_description, --pricing_details,
         cur_unrealized_rows.contract_price,
         cur_unrealized_rows.price_unit_id,
         cur_unrealized_rows.price_unit_cur_id,
         cur_unrealized_rows.price_unit_cur_code,
         cur_unrealized_rows.price_unit_weight_unit_id,
         cur_unrealized_rows.price_unit_weight,
         cur_unrealized_rows.price_unit_weight_unit,
         cur_unrealized_rows.net_m2m_price,
         cur_unrealized_rows.m2m_price_unit_id,
         cur_unrealized_rows.m2m_price_unit_cur_id,
         cur_unrealized_rows.m2m_price_unit_cur_code,
         decode(cur_unrealized_rows.m2m_price_unit_weight,
                1,
                null,
                cur_unrealized_rows.m2m_price_unit_weight),
         cur_unrealized_rows.m2m_price_unit_weight_unit_id,
         cur_unrealized_rows.m2m_price_unit_weight_unit,
         vn_ele_cont_value_in_price_cur, --contract_value,
         vc_price_cur_id, --contract_value_cur_id,
         vc_price_cur_code, --contract_value_cur_code,
         vn_ele_cont_value_in_price_cur, --contract_value_in_base, 
         vn_ele_cont_total_premium, --contract_premium_value_in_base , 
         vn_ele_m2m_amount_in_base, --m2m_value,
         vc_m2m_cur_id, --m2m_value_cur_id,
         vc_m2m_cur_code, --m2m_value_cur_code,
         vn_ele_m2m_refine_charge,
         vn_ele_m2m_treatment_charge,
         -- cur_unrealized_rows.m2m_penalty_charge,
         cur_unrealized_rows.m2m_loc_incoterm_deviation,
         vn_ele_m2m_amount_in_base, -- updated by siva on 14sep2011 vn_ele_m2m_total_amount, --m2m_amt_in_base, ---used to sum at main table
         -- round(vn_ele_sc_in_base_cur, 3), --sc_in_base_cur,
         cur_unrealized_rows.valuation_dr_id,
         cur_unrealized_rows.dr_id_name,
         cur_unrealized_rows.valuation_month,
         cur_unrealized_rows.valuation_date,
         vn_ele_exp_cog_in_base_cur, --expected_cog_net_sale_value,
         vn_ele_unreal_pnl_in_base_cur, --unrealized_pnl_in_base_cur,
         cur_unrealized_rows.base_cur_id,
         cur_unrealized_rows.base_cur_code,
         vn_fx_price_to_base, --price_cur_to_base_cur_fx_rate,
         vn_m2m_base_fx_rate, --m2m_cur_to_base_cur_fx_rate,
         cur_unrealized_rows.derivative_def_id,
         cur_unrealized_rows.valuation_exchange_id,
         cur_unrealized_rows.exchange_name,
         vn_ele_qty_in_base,
         cur_unrealized_rows.base_price_unit_id_in_ppu,
         cur_unrealized_rows.base_price_unit_name,
         cur_unrealized_rows.valuation_against_underlying);
    
      if cur_unrealized_rows.ele_rank = 1 then
        insert into poue_phy_open_unreal_element
          (corporate_id,
           corporate_name,
           process_id,
           pcdi_id,
           delivery_item_no,
           prefix,
           middle_no,
           suffix,
           internal_contract_ref_no,
           contract_ref_no,
           contract_issue_date,
           internal_contract_item_ref_no,
           basis_type,
           delivery_period_type,
           delivery_from_month,
           delivery_from_year,
           delivery_to_month,
           delivery_to_year,
           delivery_from_date,
           delivery_to_date,
           transit_days,
           contract_type,
           approval_status,
           unrealized_type,
           profit_center_id,
           profit_center_name,
           profit_center_short_name,
           cp_profile_id,
           cp_name,
           trade_user_id,
           trade_user_name,
           product_id,
           product_name,
           item_dry_qty,
           item_wet_qty,
           qty_unit_id,
           qty_unit,
           quality_id,
           quality_name,
           fixation_method,
           price_string,
           price_fixation_status,
           price_fixation_details,
           item_delivery_period_string,
           incoterm_id,
           incoterm,
           origination_city_id,
           origination_city,
           origination_country_id,
           origination_country,
           destination_city_id,
           destination_city,
           destination_country_id,
           destination_country,
           origination_region_id,
           origination_region,
           destination_region_id,
           destination_region,
           payment_term_id,
           payment_term,
           contract_price_string,
           contract_rc_tc_pen_string,
           m2m_price_string,
           m2m_rc_tc_pen_string,
           net_contract_value_in_base_cur,
           net_contract_prem_in_base_cur,
           net_m2m_amt_in_base_cur,
           net_sc_in_base_cur,
           expected_cog_net_sale_value,
           unrealized_pnl_in_base_cur,
           unreal_pnl_in_base_per_unit,
           prev_day_unr_pnl_in_base_cur,
           trade_day_pnl_in_base_cur,
           base_cur_id,
           base_cur_code,
           group_id,
           group_name,
           group_cur_id,
           group_cur_code,
           group_qty_unit_id,
           group_qty_unit,
           base_qty_unit_id,
           base_qty_unit,
           cont_unr_status,
           qty_in_base_unit,
           process_trade_date,
           strategy_id,
           strategy_name,
           del_distribution_item_no,
           penalty_charge,
           m2m_penalty_charge,
           m2m_loc_diff_premium,
           valuation_against_underlying)
        values
          (cur_unrealized_rows.corporate_id,
           cur_unrealized_rows.corporate_name,
           pc_process_id,
           cur_unrealized_rows.pcdi_id,
           cur_unrealized_rows.delivery_item_no,
           cur_unrealized_rows.prefix,
           cur_unrealized_rows.middle_no,
           cur_unrealized_rows.suffix,
           cur_unrealized_rows.internal_contract_ref_no,
           cur_unrealized_rows.contract_ref_no,
           cur_unrealized_rows.issue_date,
           cur_unrealized_rows.internal_contract_item_ref_no,
           cur_unrealized_rows.basis_type,
           cur_unrealized_rows.delivery_period_type,
           cur_unrealized_rows.delivery_from_month,
           cur_unrealized_rows.delivery_from_year,
           cur_unrealized_rows.delivery_to_month,
           cur_unrealized_rows.delivery_to_year,
           cur_unrealized_rows.delivery_from_date,
           cur_unrealized_rows.delivery_to_date,
           cur_unrealized_rows.transit_days,
           cur_unrealized_rows.purchase_sales,
           cur_unrealized_rows.contract_status,
           cur_unrealized_rows.unrealized_type,
           cur_unrealized_rows.profit_center_id,
           cur_unrealized_rows.profit_center_name,
           cur_unrealized_rows.profit_center_short_name,
           cur_unrealized_rows.cp_id,
           cur_unrealized_rows.cp_name,
           cur_unrealized_rows.trader_id,
           cur_unrealized_rows.trader_user_name,
           cur_unrealized_rows.conc_product_id,
           cur_unrealized_rows.conc_product_name,
           vn_dry_qty,
           vn_wet_qty,
           cur_unrealized_rows.qty_unit_id,
           cur_unrealized_rows.qty_unit,
           cur_unrealized_rows.conc_quality_id,
           cur_unrealized_rows.conc_quality_name,
           cur_unrealized_rows.fixation_method,
           cur_unrealized_rows.price_description,
           cur_unrealized_rows.price_fixation_status,
           cur_unrealized_rows.price_fixation_details,
           cur_unrealized_rows.item_delivery_period_string,
           cur_unrealized_rows.inco_term_id,
           cur_unrealized_rows.incoterm,
           cur_unrealized_rows.origination_city_id,
           cur_unrealized_rows.origination_city,
           cur_unrealized_rows.origination_country_id,
           cur_unrealized_rows.origination_country,
           cur_unrealized_rows.destination_city_id,
           cur_unrealized_rows.destination_city,
           cur_unrealized_rows.destination_country_id,
           cur_unrealized_rows.destination_country,
           cur_unrealized_rows.origination_region_id,
           cur_unrealized_rows.origination_region,
           cur_unrealized_rows.destination_region_id,
           cur_unrealized_rows.destination_region,
           cur_unrealized_rows.payment_term_id,
           cur_unrealized_rows.payment_term,
           null, -- contract_price_string,
           null, --contract_rc_tc_pen_string,
           null, -- m2m_price_string,
           null, -- m2m_rc_tc_pen_string,
           null, -- net_contract_value_in_base_cur,
           null, -- net_contract_prem_in_base_cur,
           null, -- net_m2m_amt_in_base_cur, 
           vn_sc_in_base_cur, -- net_sc_in_base_cur,
           null, -- expected_cog_net_sale_value,
           null, -- unrealized_pnl_in_base_cur,
           null, -- unreal_pnl_in_base_per_unit,
           null, -- prev_day_unr_pnl_in_base_cur,
           null, -- trade_day_pnl_in_base_cur,
           cur_unrealized_rows.base_cur_id,
           cur_unrealized_rows.base_cur_code,
           cur_unrealized_rows.groupid,
           cur_unrealized_rows.groupname,
           cur_unrealized_rows.cur_id_gcd,
           cur_unrealized_rows.cur_code_gcd,
           cur_unrealized_rows.qty_unit_id_gcd,
           cur_unrealized_rows.qty_unit_gcd,
           cur_unrealized_rows.base_qty_unit_id,
           cur_unrealized_rows.base_qty_unit,
           null, -- cont_unr_status,
           vn_qty_in_base,
           pd_trade_date,
           cur_unrealized_rows.strategy_id,
           cur_unrealized_rows.strategy_name,
           cur_unrealized_rows.del_distribution_item_no,
           vn_base_con_penality_charge,
           vn_total_penality,
           vn_loc_total_amount,
           cur_unrealized_rows.valuation_against_underlying);
      end if;
    
    end loop;
  
    for cur_update_pnl in (select poude.internal_contract_item_ref_no,
                                  sum(poude.contract_value_in_base) net_contract_value_in_base_cur,
                                  sum(poude.contract_premium_value_in_base) net_contract_prem_in_base_cur,
                                  sum(poude.m2m_amt_in_base) net_m2m_amt_in_base_cur,
                                  sum(poude.treatment_charge) net_contract_treatment_charge,
                                  sum(poude.refining_charge) net_contract_refining_charge,
                                  sum(poude.m2m_treatment_charge) net_m2m_treatment_charge,
                                  sum(poude.m2m_refining_charge) net_m2m_refining_charge,
                                  -- sum(poude.expected_cog_net_sale_value) expected_cog_net_sale_value,
                                  --sum(poude.unrealized_pnl_in_base_cur) unrealized_pnl_in_base_cur,
                                  stragg(poude.element_name || '-' ||
                                         poude.contract_price || ' ' ||
                                         poude.price_unit_cur_code || '/' ||
                                         poude.price_unit_weight ||
                                         poude.price_unit_weight_unit) contract_price_string,
                                  (case
                                     when poude.valuation_against_underlying = 'N' then
                                      max((case
                                     when nvl(poude.m2m_price, 0) <> 0 then
                                      (poude.m2m_price || ' ' ||
                                      poude.m2m_price_cur_code || '/' ||
                                      poude.m2m_price_weight ||
                                      poude.m2m_price_weight_unit)
                                     else
                                      null
                                   end)) else stragg((case
                                    when nvl(poude.m2m_price,
                                             0) <> 0 then
                                     (poude.element_name || '-' ||
                                     poude.m2m_price || ' ' ||
                                     poude.m2m_price_cur_code || '/' ||
                                     poude.m2m_price_weight ||
                                     poude.m2m_price_weight_unit)
                                    else
                                     null
                                  end)) end) m2m_price_string, -- TODO if underly valuation = n, show the concentrate price
                                  stragg('TC:' || poude.element_name || '-' ||
                                         poude.treatment_charge || ' ' ||
                                         poude.base_cur_code || '  ' ||
                                         'RC:' || poude.element_name || '-' ||
                                         poude.refining_charge || ' ' ||
                                         poude.base_cur_code) contract_rc_tc_pen_string,
                                  stragg('TC:' || poude.element_name || '-' ||
                                         poude.m2m_treatment_charge || ' ' ||
                                         poude.base_cur_code || ' ' || 'RC:' ||
                                         poude.element_name || '-' ||
                                         poude.m2m_refining_charge || ' ' ||
                                         poude.base_cur_code) m2m_rc_tc_pen_string
                             from poued_element_details poude
                            where poude.corporate_id = pc_corporate_id
                              and poude.process_id = pc_process_id
                            group by poude.internal_contract_item_ref_no,
                                     poude.valuation_against_underlying)
    loop
      update poue_phy_open_unreal_element poue
         set poue.net_contract_value_in_base_cur = round(cur_update_pnl.net_contract_value_in_base_cur,
                                                         2),
             poue.net_contract_prem_in_base_cur  = round(cur_update_pnl.net_contract_prem_in_base_cur,
                                                         2),
             poue.net_m2m_amt_in_base_cur        = round(cur_update_pnl.net_m2m_amt_in_base_cur,
                                                         2),
             poue.net_contract_treatment_charge  = cur_update_pnl.net_contract_treatment_charge,
             poue.net_contract_refining_charge   = cur_update_pnl.net_contract_refining_charge,
             poue.net_m2m_treatment_charge       = cur_update_pnl.net_m2m_treatment_charge,
             poue.net_m2m_refining_charge        = cur_update_pnl.net_m2m_refining_charge,
             -- poue.expected_cog_net_sale_value    = round(cur_update_pnl.expected_cog_net_sale_value, 3),
             /*poue.unrealized_pnl_in_base_cur     = round(cur_update_pnl.unrealized_pnl_in_base_cur,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       3),*/
             poue.contract_price_string     = cur_update_pnl.contract_price_string,
             poue.m2m_price_string          = cur_update_pnl.m2m_price_string,
             poue.contract_rc_tc_pen_string = cur_update_pnl.contract_rc_tc_pen_string,
             poue.m2m_rc_tc_pen_string      = cur_update_pnl.m2m_rc_tc_pen_string
       where poue.internal_contract_item_ref_no =
             cur_update_pnl.internal_contract_item_ref_no
         and poue.process_id = pc_process_id
         and poue.corporate_id = pc_corporate_id;
    end loop;
    commit;
  
    update poue_phy_open_unreal_element poue
       set poue.expected_cog_net_sale_value = poue.net_contract_value_in_base_cur -
                                              poue.net_contract_treatment_charge -
                                              poue.net_contract_refining_charge +
                                              poue.net_sc_in_base_cur
     where poue.corporate_id = pc_corporate_id
       and poue.process_id = pc_process_id;
    commit;
    --- update unrealized pnl
  
    update poue_phy_open_unreal_element poue
       set poue.unrealized_pnl_in_base_cur = (case when poue.contract_type = 'P' then(poue.net_m2m_amt_in_base_cur - poue.net_m2m_treatment_charge - poue.net_m2m_refining_charge - nvl(poue.m2m_penalty_charge, 0) + poue.m2m_loc_diff_premium) - (poue.expected_cog_net_sale_value - nvl(poue.penalty_charge, 0)) else(poue.expected_cog_net_sale_value - nvl(poue.penalty_charge, 0)) - (poue.net_m2m_amt_in_base_cur - poue.net_m2m_treatment_charge - poue.net_m2m_refining_charge - nvl(poue.m2m_penalty_charge, 0) + poue.m2m_loc_diff_premium) end)
     where poue.corporate_id = pc_corporate_id
       and poue.process_id = pc_process_id;
    commit;
    -- update pnl base per unit
    update poue_phy_open_unreal_element poue
       set poue.unreal_pnl_in_base_per_unit = round(poue.unrealized_pnl_in_base_cur /
                                                    poue.qty_in_base_unit,
                                                    2)
     where poue.corporate_id = pc_corporate_id
       and poue.process_id = pc_process_id
       and poue.qty_in_base_unit <> 0;
  
    -- update previous eod data  
    begin
      for cur_update in (select poue_prev_day.internal_contract_item_ref_no,
                                poue_prev_day.unreal_pnl_in_base_per_unit,
                                poue_prev_day.unrealized_type
                           from poue_phy_open_unreal_element poue_prev_day
                          where poue_prev_day.process_id =
                                gvc_previous_process_id
                            and corporate_id = pc_corporate_id)
      loop
        update poue_phy_open_unreal_element poue_today
           set poue_today.prev_day_unr_pnl_in_base_cur = round(cur_update.unreal_pnl_in_base_per_unit *
                                                               poue_today.qty_in_base_unit,
                                                               2),
               poue_today.cont_unr_status              = 'EXISTING_TRADE'
         where poue_today.internal_contract_item_ref_no =
               cur_update.internal_contract_item_ref_no
           and poue_today.process_id = pc_process_id
           and poue_today.unrealized_type = cur_update.unrealized_type
           and poue_today.corporate_id = pc_corporate_id;
      end loop;
    exception
      when others then
        dbms_output.put_line('SQLERRM-1' || sqlerrm);
    end;
  
    -- mark the trades came as new in this eod/eom
  
    begin
      update poue_phy_open_unreal_element poue
         set poue.cont_unr_status = 'NEW_TRADE'
       where poue.cont_unr_status is null
         and poue.process_id = pc_process_id
         and poue.corporate_id = pc_corporate_id;
    exception
      when others then
        dbms_output.put_line('SQLERRM-2' || sqlerrm);
    end;
  
    update poue_phy_open_unreal_element poue
       set poue.trade_day_pnl_in_base_cur = round(nvl(poue.unrealized_pnl_in_base_cur,
                                                      0) - nvl(poue.prev_day_unr_pnl_in_base_cur,
                                                               0),
                                                  2)
     where poue.process_id = pc_process_id
       and poue.corporate_id = pc_corporate_id
       and poue.unrealized_type = 'Unrealized';
  
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure sp_calc_phy_opencon_unreal_pnl',
                                                           'M2M-013',
                                                           'Code:' ||
                                                           sqlcode ||
                                                           'Message:' ||
                                                           sqlerrm,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;

  procedure sp_phy_opencon_ext_unreal_pnl(pc_corporate_id varchar2,
                                          pd_trade_date   date,
                                          pc_process_id   varchar2,
                                          pc_user_id      varchar2,
                                          pc_dbd_id       varchar2) is
  
    cursor cur_unrealized is
      select pcm.corporate_id,
             akc.corporate_name,
             pc_process_id,
             pcdi.pcdi_id,
             pcdi.delivery_item_no,
             pcdi.prefix,
             pcdi.middle_no,
             pcdi.suffix,
             pcdi.internal_contract_ref_no,
             pcm.contract_ref_no,
             pcm.issue_date,
             pci.internal_contract_item_ref_no,
             pci.del_distribution_item_no,
             pcdi.basis_type,
             pcdi.delivery_period_type,
             pcdi.delivery_from_month,
             pcdi.delivery_from_year,
             pcdi.delivery_to_month,
             pcdi.delivery_to_year,
             pcdi.delivery_from_date,
             pcdi.delivery_to_date,
             pcdi.transit_days,
             pcm.purchase_sales,
             pcm.contract_status,
             'Unrealized' unrealized_type,
             pcpd.profit_center_id,
             cpc.profit_center_name,
             cpc.profit_center_short_name,
             pcm.cp_id,
             phd_cp.companyname cp_name,
             pcm.trader_id,
             (case
               when pcm.trader_id is not null then
                (select gab.firstname || ' ' || gab.lastname
                   from gab_globaladdressbook       gab,
                        ak_corporate_user@eka_appdb aku
                  where gab.gabid = aku.gabid
                    and aku.user_id = pcm.trader_id)
               else
                ''
             end) trader_user_name,
             pcpd.product_id conc_product_id,
             pdm_conc.product_desc conc_product_name,
             aml.underlying_product_id product_id,
             pdm.product_desc product_name,
             ciqs.open_qty item_qty,
             ciqs.item_qty_unit_id qty_unit_id,
             qum.qty_unit,
             qum.decimals item_qty_decimal,
             pcpq.quality_template_id conc_quality_id,
             qat.quality_name conc_quality_name,
             qav.comp_quality_id quality_id,
             qat_und.quality_name,
             pcdb.inco_term_id,
             itm.incoterm,
             pcdb.city_id origination_city_id,
             cim1.city_name origination_city,
             pcdb.country_id origination_country_id,
             cym1.country_name origination_country,
             pcdb.city_id destination_city_id,
             cim2.city_name destination_city,
             pcdb.country_id destination_country_id,
             cym2.country_name destination_country,
             rem_cym1.region_id origination_region_id,
             rem_cym1.region_name origination_region,
             rem_cym2.region_id destination_region_id,
             rem_cym2.region_name destination_region,
             pcm.payment_term_id,
             pym.payment_term,
             cm.cur_id as base_cur_id,
             cm.cur_code as base_cur_code,
             cm.decimals as base_cur_decimal,
             gcd.groupid,
             gcd.groupname,
             cm_gcd.cur_id cur_id_gcd,
             cm_gcd.cur_code cur_code_gcd,
             qum_gcd.qty_unit_id qty_unit_id_gcd,
             qum_gcd.qty_unit qty_unit_gcd,
             qum_pdm.qty_unit_id as base_qty_unit_id,
             qum_pdm.qty_unit as base_qty_unit,
             qum_pdm.decimals as base_qty_decimal,
             qum_pdm_conc.qty_unit_id as conc_base_qty_unit_id,
             qum_pdm_conc.qty_unit as conc_base_qty_unit,
             qum_pdm_conc.decimals as conc_base_qty_decimal,
             pcpd.strategy_id,
             css.strategy_name,
             cipde.element_id,
             aml.attribute_name,
             pcpq.assay_header_id,
             pcpq.unit_of_measure,
             ceqs.assay_qty,
             ceqs.assay_qty_unit_id,
             cipq.payable_qty,
             cipq.qty_unit_id payable_qty_unit_id,
             cipde.contract_price,
             cipde.price_unit_id,
             cipde.price_unit_cur_id,
             cipde.price_unit_cur_code,
             cipde.price_unit_weight_unit_id,
             cipde.price_unit_weight,
             cipde.price_unit_weight_unit,
             --   cipde.treatment_charge,
             --  cipde.refining_charge,
             --  cipde.penalty_charge,
             cipde.price_basis fixation_method,
             cipde.price_description,
             cipde.price_fixation_status,
             cipde.price_fixation_details,
             nvl(cipde.payment_due_date, pd_trade_date) payment_due_date,
             pci.expected_delivery_month || '-' ||
             pci.expected_delivery_year item_delivery_period_string,
             md.net_m2m_price net_m2m_price,
             md.m2m_price_unit_id,
             md.m2m_price_unit_cur_id,
             md.m2m_price_unit_cur_code,
             md.m2m_price_unit_weight,
             md.m2m_price_unit_weight_unit_id,
             md.m2m_price_unit_weight_unit,
             md.m2m_main_cur_id,
             md.m2m_main_cur_code,
             md.m2m_main_cur_decimals,
             md.main_currency_factor,
             md.md_id,
             0 m2m_amt,
             nvl(md.treatment_charge, 0) m2m_treatment_charge, -- will be in base price unit id
             nvl(md.refine_charge, 0) m2m_refining_charge, -- will be in base price unit id
             nvl(md.penalty_charge, 0) m2m_penalty_charge, -- will be in base price unit id
             tc_ppu_pum.price_unit_id m2m_tc_price_unit_id,
             tc_ppu_pum.price_unit_name m2m_tc_price_unit_name,
             tc_ppu_pum.cur_id m2m_tc_cur_id,
             tc_ppu_pum.weight m2m_tc_weight,
             tc_ppu_pum.weight_unit_id m2m_tc_weight_unit_id,
             rc_ppu_pum.price_unit_id m2m_rc_price_unit_id,
             rc_ppu_pum.price_unit_name m2m_rc_price_unit_name,
             rc_ppu_pum.cur_id m2m_rc_cur_id,
             rc_ppu_pum.weight m2m_rc_weight,
             rc_ppu_pum.weight_unit_id m2m_rc_weight_unit_id,
             nvl((select sum(cisc.avg_cost)
                   from cisc_contract_item_sec_cost cisc
                  where cisc.internal_contract_item_ref_no =
                        pci.internal_contract_item_ref_no
                    and cisc.process_id = pc_process_id),
                 0) sc_in_base_cur,
             md.derivative_def_id,
             md.valuation_exchange_id,
             emt.exchange_name,
             md.valuation_dr_id,
             drm.dr_id_name,
             md.valuation_month,
             md.valuation_date,
             md.m2m_loc_incoterm_deviation,
             dense_rank() over(partition by pci.internal_contract_item_ref_no order by cipde.element_id) ele_rank,
             md.base_price_unit_id_in_ppu,
             md.base_price_unit_id_in_pum,
             pum_base_price_id.price_unit_name base_price_unit_name,
             pum_loc_base.weight_unit_id loc_qty_unit_id,
             tmpc.mvp_id,
             tmpc.shipment_month,
             tmpc.shipment_year,
             nvl(pdm_conc.valuation_against_underlying, 'Y') valuation_against_underlying
        from pcm_physical_contract_main pcm,
             ak_corporate akc,
             pcdi_pc_delivery_item pcdi,
             pci_physical_contract_item pci,
             pcpd_pc_product_definition pcpd,
             cpc_corporate_profit_center cpc,
             phd_profileheaderdetails phd_cp,
             pdm_productmaster pdm,
             ciqs_contract_item_qty_status ciqs,
             qum_quantity_unit_master qum,
             pcpq_pc_product_quality pcpq,
             qat_quality_attributes qat,
             qat_quality_attributes qat_und,
             qav_quality_attribute_values qav,
             ppm_product_properties_mapping ppm,
             aml_attribute_master_list aml,
             pcdb_pc_delivery_basis pcdb,
             itm_incoterm_master itm,
             cim_citymaster cim1,
             cim_citymaster cim2,
             cym_countrymaster cym1,
             cym_countrymaster cym2,
             rem_region_master@eka_appdb rem_cym1,
             rem_region_master@eka_appdb rem_cym2,
             pym_payment_terms_master pym,
             cm_currency_master cm,
             gcd_groupcorporatedetails gcd,
             cm_currency_master cm_gcd,
             qum_quantity_unit_master qum_gcd,
             qum_quantity_unit_master qum_pdm,
             pdm_productmaster pdm_conc,
             qum_quantity_unit_master qum_pdm_conc,
             css_corporate_strategy_setup css,
             pum_price_unit_master pum_base_price_id,
             pum_price_unit_master pum_loc_base,
             cipde_cipd_element_price cipde,
             (select md1.*
                from md_m2m_daily md1
               where md1.rate_type = 'OPEN'
                 and md1.corporate_id = pc_corporate_id
                 and md1.product_type = 'CONCENTRATES'
                 and md1.process_id = pc_process_id) md,
             (select tmp.*
                from tmpc_temp_m2m_pre_check tmp
               where tmp.corporate_id = pc_corporate_id
                 and tmp.product_type = 'CONCENTRATES'
                 and tmp.section_name = 'OPEN') tmpc,
             drm_derivative_master drm,
             emt_exchangemaster emt,
             v_ppu_pum tc_ppu_pum,
             v_ppu_pum rc_ppu_pum,
             cipq_contract_item_payable_qty cipq,
             ceqs_contract_ele_qty_status ceqs
       where pcm.corporate_id = akc.corporate_id
         and pcm.internal_contract_ref_no = pcdi.internal_contract_ref_no
         and pcdi.pcdi_id = pci.pcdi_id
         and pcm.internal_contract_ref_no = pcpd.internal_contract_ref_no
         and pcpd.profit_center_id = cpc.profit_center_id
         and pcm.cp_id = phd_cp.profileid
         and pci.internal_contract_item_ref_no =
             ciqs.internal_contract_item_ref_no
         and ciqs.item_qty_unit_id = qum.qty_unit_id
         and pci.pcpq_id = pcpq.pcpq_id
         and pcpq.quality_template_id = qat.quality_id
         and qat.quality_id = qav.quality_id
         and qav.attribute_id = ppm.property_id
         and qav.comp_quality_id = qat_und.quality_id
         and ppm.attribute_id = aml.attribute_id
         and aml.underlying_product_id = pdm.product_id
         and aml.attribute_id = cipde.element_id
         and pci.pcdb_id = pcdb.pcdb_id
         and pcdb.inco_term_id = itm.incoterm_id
         and pcdb.city_id = cim1.city_id(+)
         and pcdb.city_id = cim2.city_id(+)
         and pcdb.country_id = cym1.country_id(+)
         and pcdb.country_id = cym2.country_id(+)
         and cym1.region_id = rem_cym1.region_id(+)
         and cym2.region_id = rem_cym2.region_id(+)
         and pcm.payment_term_id = pym.payment_term_id(+)
         and akc.base_cur_id = cm.cur_id
         and akc.groupid = gcd.groupid
         and gcd.group_cur_id = cm_gcd.cur_id(+)
         and gcd.group_qty_unit_id = qum_gcd.qty_unit_id(+)
         and qum_pdm.qty_unit_id = pdm.base_quantity_unit
         and pcpd.product_id = pdm_conc.product_id
         and qum_pdm_conc.qty_unit_id = pdm_conc.base_quantity_unit
         and pcpd.strategy_id = css.strategy_id
         and pci.internal_contract_item_ref_no =
             cipde.internal_contract_item_ref_no
         and pci.internal_contract_item_ref_no =
             tmpc.internal_contract_item_ref_no(+)
         and tmpc.element_id = cipde.element_id
         and tmpc.internal_m2m_id = md.md_id(+)
         and md.element_id = cipde.element_id
         and md.valuation_dr_id = drm.dr_id(+)
         and md.valuation_exchange_id = emt.exchange_id(+)
         and pcm.corporate_id = pc_corporate_id
         and ciqs.open_qty > 0
         and pcm.contract_status = 'In Position'
         and pcm.contract_type = 'CONCENTRATES'
         and pcpd.input_output = 'Input'
         and pcm.is_tolling_contract = 'Y'
         and pcm.is_tolling_extn = 'Y'
         and pcm.is_active = 'Y'
         and pci.is_active = 'Y'
         and pcdi.is_active = 'Y'
         and pcdb.is_active = 'Y'
         and pcpd.is_active = 'Y'
         and pcpq.is_active = 'Y'
         and ciqs.is_active = 'Y'
         and ppm.is_active = 'Y'
         and ppm.is_deleted = 'N'
         and qav.is_deleted = 'N'
         and qav.is_comp_product_attribute = 'Y'
         and qat.is_active = 'Y'
         and qat.is_deleted = 'N'
         and aml.is_active = 'Y'
         and aml.is_deleted = 'N'
         and qat_und.is_active = 'Y'
         and qat_und.is_deleted = 'N'
         and md.base_price_unit_id_in_pum = pum_base_price_id.price_unit_id
         and md.base_price_unit_id_in_pum = pum_loc_base.price_unit_id
         and md.tc_price_unit_id = tc_ppu_pum.product_price_unit_id
         and md.rc_price_unit_id = rc_ppu_pum.product_price_unit_id
         and pci.internal_contract_item_ref_no =
             cipq.internal_contract_item_ref_no
         and aml.attribute_id = cipq.element_id
         and pci.internal_contract_item_ref_no =
             ceqs.internal_contract_item_ref_no
         and aml.attribute_id = ceqs.element_id
         and pcm.process_id = pc_process_id
         and pcdi.process_id = pc_process_id
         and pci.process_id = pc_process_id
         and pcpd.process_id = pc_process_id
         and ciqs.process_id = pc_process_id
         and pcpq.process_id = pc_process_id
         and pcdb.process_id = pc_process_id
         and cipde.process_id = pc_process_id
         and cipq.process_id = pc_process_id
         and ceqs.process_id = pc_process_id;
    vn_ele_qty_in_base        number;
    vn_ele_m2m_amt            number;
    vc_m2m_cur_id             varchar2(15);
    vc_m2m_cur_code           varchar2(15);
    vn_m2m_base_fx_rate       number;
    vn_m2m_base_deviation     number;
    vn_m2m_sub_cur_id_factor  number;
    vn_m2m_cur_decimals       number;
    vn_ele_m2m_amount_in_base number;
    vn_ele_m2m_total_amount   number;
    --vn_ele_m2m_total_premium_amt   number;
    --vn_ele_m2m_premium_amt         number;
    vc_price_cur_id                varchar2(15);
    vc_price_cur_code              varchar2(15);
    vn_cont_price_cur_id_factor    number;
    vn_cont_price_cur_decimals     number;
    vn_ele_cont_value_in_price_cur number;
    vn_fx_price_to_base            number;
    vn_forward_exch_rate           number;
    --vc_base_price_unit             varchar2(15);
    vn_ele_cont_premium           number;
    vn_ele_cont_total_premium     number;
    vn_ele_cont_value_in_base_cur number;
    --vn_ele_sc_in_base_cur          number;
    vn_ele_exp_cog_in_base_cur    number;
    vn_ele_unreal_pnl_in_base_cur number;
    vn_unrealized_pnl_in_m2m_unit number;
    vc_m2m_price_unit_id          varchar2(15);
    vc_m2m_price_unit_cur_id      varchar2(15);
    vc_m2m_price_unit_cur_code    varchar2(15);
    vc_m2m_price_unit_wgt_unit_id varchar2(15);
    vc_m2m_price_unit_wgt_unit    varchar2(15);
    vn_m2m_price_unit_wgt_unit_wt number;
    vobj_error_log                tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count            number := 1;
    vn_dry_qty                    number;
    vn_wet_qty                    number;
    ----vn_m2m_total_amount            number;
    --vn_cont_value_in_base_cur      number;
    --vn_cont_total_premium          number;
    vn_sc_in_base_cur number;
    --vn_exp_cog_in_base_cur         number;
    --vn_unreal_pnl_in_base_cur      number;
    vn_qty_in_base               number;
    vn_con_treatment_charge      number;
    vc_con_treatment_cur_id      varchar2(15);
    vn_base_con_treatment_charge number;
    vn_con_refine_charge         number;
    vc_con_refine_cur_id         varchar2(15);
    vn_base_con_refine_charge    number;
    vn_con_penality_charge       number;
    vn_base_con_penality_charge  number;
    --vn_con_penality_per_elemet     number;
    vc_con_penality_cur_id      varchar2(15);
    vn_dry_qty_in_base          number;
    vn_ele_m2m_treatment_charge number;
    vn_ele_m2m_refine_charge    number;
    vn_loc_amount               number;
    vn_loc_total_amount         number;
    vn_penality                 number;
    vc_penality_price_unit_id   varchar2(20);
    vn_total_penality           number;
    vc_price_unit_id            varchar2(15);
  
  begin
    for cur_unrealized_rows in cur_unrealized
    loop
    
      -- convert wet qty to dry qty
      if cur_unrealized_rows.unit_of_measure = 'Wet' then
        vn_dry_qty := round(pkg_metals_general.fn_get_assay_dry_qty(cur_unrealized_rows.conc_product_id,
                                                                    cur_unrealized_rows.assay_header_id,
                                                                    cur_unrealized_rows.item_qty,
                                                                    cur_unrealized_rows.qty_unit_id),
                            cur_unrealized_rows.item_qty_decimal);
      else
        vn_dry_qty := cur_unrealized_rows.item_qty;
      end if;
    
      vn_wet_qty := cur_unrealized_rows.item_qty;
    
      -- convert into dry qty to base qty element level
    
      vn_dry_qty_in_base := round(pkg_general.f_get_converted_quantity(cur_unrealized_rows.conc_product_id,
                                                                       cur_unrealized_rows.qty_unit_id,
                                                                       cur_unrealized_rows.base_qty_unit_id,
                                                                       1) *
                                  vn_dry_qty,
                                  cur_unrealized_rows.base_qty_decimal);
    
      -- contract treatment charges
      pkg_metals_general.sp_get_treatment_charge(cur_unrealized_rows.internal_contract_item_ref_no,
                                                 cur_unrealized_rows.element_id,
                                                 pc_dbd_id,
                                                 vn_dry_qty,
                                                 vn_wet_qty,
                                                 cur_unrealized_rows.qty_unit_id,
                                                 cur_unrealized_rows.contract_price,
                                                 cur_unrealized_rows.price_unit_id,
                                                 vn_con_treatment_charge,
                                                 vc_con_treatment_cur_id);
      -- converted treatment charges to base currency                                           
      vn_base_con_treatment_charge := round(pkg_general.f_get_converted_currency_amt(cur_unrealized_rows.corporate_id,
                                                                                     vc_con_treatment_cur_id,
                                                                                     cur_unrealized_rows.base_cur_id,
                                                                                     pd_trade_date,
                                                                                     vn_con_treatment_charge),
                                            cur_unrealized_rows.base_cur_decimal);
    
      --- contract refine chrges
      pkg_metals_general.sp_get_refine_charge(cur_unrealized_rows.internal_contract_item_ref_no,
                                              cur_unrealized_rows.element_id,
                                              pc_dbd_id,
                                              cur_unrealized_rows.payable_qty,
                                              cur_unrealized_rows.payable_qty_unit_id,
                                              cur_unrealized_rows.contract_price,
                                              cur_unrealized_rows.price_unit_id,
                                              vn_con_refine_charge,
                                              vc_con_refine_cur_id);
    
      --- converted refine charges to base currency                                              
    
      vn_base_con_refine_charge := round(pkg_general.f_get_converted_currency_amt(cur_unrealized_rows.corporate_id,
                                                                                  vc_con_refine_cur_id,
                                                                                  cur_unrealized_rows.base_cur_id,
                                                                                  pd_trade_date,
                                                                                  vn_con_refine_charge),
                                         cur_unrealized_rows.base_cur_decimal);
      --- contract penality chrges   
      if cur_unrealized_rows.ele_rank = 1 then
        pkg_metals_general.sp_get_penalty_charge(cur_unrealized_rows.internal_contract_item_ref_no,
                                                 pc_dbd_id,
                                                 vn_dry_qty,
                                                 cur_unrealized_rows.qty_unit_id,
                                                 vn_con_penality_charge,
                                                 vc_con_penality_cur_id);
      
        vn_base_con_penality_charge := round(pkg_general.f_get_converted_currency_amt(cur_unrealized_rows.corporate_id,
                                                                                      vc_con_penality_cur_id,
                                                                                      cur_unrealized_rows.base_cur_id,
                                                                                      pd_trade_date,
                                                                                      vn_con_penality_charge),
                                             cur_unrealized_rows.base_cur_decimal);
      end if;
    
      vn_qty_in_base := round(pkg_general.f_get_converted_quantity(cur_unrealized_rows.conc_product_id,
                                                                   cur_unrealized_rows.qty_unit_id,
                                                                   cur_unrealized_rows.conc_base_qty_unit_id,
                                                                   1) *
                              vn_wet_qty,
                              cur_unrealized_rows.conc_base_qty_decimal);
    
      vn_ele_qty_in_base := round(pkg_general.f_get_converted_quantity(cur_unrealized_rows.product_id,
                                                                       cur_unrealized_rows.payable_qty_unit_id,
                                                                       cur_unrealized_rows.base_qty_unit_id,
                                                                       1) *
                                  cur_unrealized_rows.payable_qty,
                                  cur_unrealized_rows.base_qty_decimal);
      if cur_unrealized_rows.valuation_against_underlying = 'Y' then
        vn_ele_m2m_amt := nvl(cur_unrealized_rows.net_m2m_price, 0) /
                          nvl(cur_unrealized_rows.m2m_price_unit_weight, 1) *
                          pkg_general.f_get_converted_quantity(cur_unrealized_rows.product_id,
                                                               cur_unrealized_rows.payable_qty_unit_id,
                                                               cur_unrealized_rows.m2m_price_unit_weight_unit_id,
                                                               cur_unrealized_rows.payable_qty);
      
        pkg_general.sp_get_main_cur_detail(nvl(cur_unrealized_rows.m2m_price_unit_cur_id,
                                               cur_unrealized_rows.base_cur_id),
                                           vc_m2m_cur_id,
                                           vc_m2m_cur_code,
                                           vn_m2m_sub_cur_id_factor,
                                           vn_m2m_cur_decimals);
        vn_ele_m2m_amt := round(vn_ele_m2m_amt * vn_m2m_sub_cur_id_factor,
                                vn_m2m_cur_decimals);
      
        pkg_general.sp_forward_cur_exchange_new(cur_unrealized_rows.corporate_id,
                                                pd_trade_date,
                                                cur_unrealized_rows.payment_due_date,
                                                vc_m2m_cur_id,
                                                cur_unrealized_rows.base_cur_id,
                                                30,
                                                vn_m2m_base_fx_rate,
                                                vn_m2m_base_deviation);
        if vc_m2m_cur_id <> cur_unrealized_rows.base_cur_id then
          if vn_m2m_base_fx_rate is null or vn_m2m_base_fx_rate = 0 then
            vobj_error_log.extend;
            vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                 'procedure pkg_phy_physical_process-sp_calc_phy_open_unrealized ',
                                                                 'PHY-005',
                                                                 cur_unrealized_rows.base_cur_code ||
                                                                 ' to ' ||
                                                                 vc_m2m_cur_code || ' (' ||
                                                                 to_char(cur_unrealized_rows.payment_due_date,
                                                                         'dd-Mon-yyyy') || ') ',
                                                                 '',
                                                                 gvc_process,
                                                                 pc_user_id,
                                                                 sysdate,
                                                                 pd_trade_date);
            sp_insert_error_log(vobj_error_log);
          end if;
        end if;
        vn_ele_m2m_amount_in_base := vn_ele_m2m_amt * vn_m2m_base_fx_rate;
      else
        vn_ele_m2m_amt := nvl(cur_unrealized_rows.net_m2m_price, 0) /
                          nvl(cur_unrealized_rows.m2m_price_unit_weight, 1) *
                          pkg_general.f_get_converted_quantity(cur_unrealized_rows.conc_product_id,
                                                               cur_unrealized_rows.conc_base_qty_unit_id,
                                                               cur_unrealized_rows.m2m_price_unit_weight_unit_id,
                                                               vn_dry_qty_in_base);
      
        pkg_general.sp_get_main_cur_detail(nvl(cur_unrealized_rows.m2m_price_unit_cur_id,
                                               cur_unrealized_rows.base_cur_id),
                                           vc_m2m_cur_id,
                                           vc_m2m_cur_code,
                                           vn_m2m_sub_cur_id_factor,
                                           vn_m2m_cur_decimals);
        vn_ele_m2m_amt := round(vn_ele_m2m_amt * vn_m2m_sub_cur_id_factor,
                                vn_m2m_cur_decimals);
      
        pkg_general.sp_forward_cur_exchange_new(cur_unrealized_rows.corporate_id,
                                                pd_trade_date,
                                                cur_unrealized_rows.payment_due_date,
                                                vc_m2m_cur_id,
                                                cur_unrealized_rows.base_cur_id,
                                                30,
                                                vn_m2m_base_fx_rate,
                                                vn_m2m_base_deviation);
        if vc_m2m_cur_id <> cur_unrealized_rows.base_cur_id then
          if vn_m2m_base_fx_rate is null or vn_m2m_base_fx_rate = 0 then
            vobj_error_log.extend;
            vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                 'procedure pkg_phy_physical_process-sp_calc_phy_open_unrealized ',
                                                                 'PHY-005',
                                                                 cur_unrealized_rows.base_cur_code ||
                                                                 ' to ' ||
                                                                 vc_m2m_cur_code || ' (' ||
                                                                 to_char(cur_unrealized_rows.payment_due_date,
                                                                         'dd-Mon-yyyy') || ') ',
                                                                 '',
                                                                 gvc_process,
                                                                 pc_user_id,
                                                                 sysdate,
                                                                 pd_trade_date);
            sp_insert_error_log(vobj_error_log);
          end if;
        end if;
        if cur_unrealized_rows.ele_rank = 1 then
          vn_ele_m2m_amount_in_base := vn_ele_m2m_amt * vn_m2m_base_fx_rate;
        else
          vn_ele_m2m_amount_in_base := 0;
          vn_ele_m2m_amt            := 0;
        end if;
      end if;
    
      /*vn_ele_m2m_treatment_charge := round(cur_unrealized_rows.m2m_treatment_charge *
                                           vn_dry_qty_in_base,
                                           cur_unrealized_rows.base_cur_decimal);
      vn_ele_m2m_refine_charge    := round(cur_unrealized_rows.m2m_refining_charge *
                                           vn_ele_qty_in_base,
                                           cur_unrealized_rows.base_cur_decimal);*/
    
      vn_ele_m2m_treatment_charge := round((cur_unrealized_rows.m2m_treatment_charge /
                                           nvl(cur_unrealized_rows.m2m_tc_weight,
                                                1)) *
                                           pkg_general.f_get_converted_currency_amt(pc_corporate_id,
                                                                                    cur_unrealized_rows.m2m_tc_cur_id,
                                                                                    cur_unrealized_rows.base_cur_id,
                                                                                    pd_trade_date,
                                                                                    1) *
                                           (pkg_general.f_get_converted_quantity(cur_unrealized_rows.conc_product_id,
                                                                                 cur_unrealized_rows.qty_unit_id,
                                                                                 cur_unrealized_rows.m2m_tc_weight_unit_id,
                                                                                 vn_dry_qty)),
                                           cur_unrealized_rows.base_cur_decimal);
    
      vn_ele_m2m_refine_charge := round((cur_unrealized_rows.m2m_refining_charge /
                                        nvl(cur_unrealized_rows.m2m_rc_weight,
                                             1)) *
                                        pkg_general.f_get_converted_currency_amt(pc_corporate_id,
                                                                                 cur_unrealized_rows.m2m_rc_cur_id,
                                                                                 cur_unrealized_rows.base_cur_id,
                                                                                 pd_trade_date,
                                                                                 1) *
                                        (pkg_general.f_get_converted_quantity(cur_unrealized_rows.product_id,
                                                                              cur_unrealized_rows.payable_qty_unit_id,
                                                                              cur_unrealized_rows.m2m_rc_weight_unit_id,
                                                                              cur_unrealized_rows.payable_qty)),
                                        cur_unrealized_rows.base_cur_decimal);
    
      vn_loc_amount := round(pkg_general.f_get_converted_quantity(cur_unrealized_rows.conc_product_id,
                                                                  cur_unrealized_rows.loc_qty_unit_id,
                                                                  cur_unrealized_rows.conc_base_qty_unit_id,
                                                                  1) *
                             cur_unrealized_rows.m2m_loc_incoterm_deviation,
                             cur_unrealized_rows.base_cur_decimal);
    
      vn_loc_total_amount := round(vn_loc_amount * vn_qty_in_base,
                                   cur_unrealized_rows.base_cur_decimal);
      vn_total_penality   := 0;
      if cur_unrealized_rows.ele_rank = 1 then
        begin
          select ppu.product_price_unit_id
            into vc_price_unit_id
            from v_ppu_pum         ppu,
                 pdm_productmaster pdm,
                 ak_corporate      akc
           where ppu.product_id = cur_unrealized_rows.conc_product_id
             and ppu.product_id = pdm.product_id
             and pdm.base_quantity_unit = ppu.weight_unit_id
             and ppu.cur_id = akc.base_cur_id
             and nvl(ppu.weight, 1) = 1
             and akc.corporate_id = pc_corporate_id;
        
        exception
          when no_data_found then
            vc_price_unit_id := null;
        end;
        vn_total_penality := 0;
        for cc in (select pci.internal_contract_item_ref_no,
                          pqca.element_id,
                          pcpq.quality_template_id
                     from pci_physical_contract_item  pci,
                          pcpq_pc_product_quality     pcpq,
                          ash_assay_header            ash,
                          asm_assay_sublot_mapping    asm,
                          pqca_pq_chemical_attributes pqca
                    where pci.pcpq_id = pcpq.pcpq_id
                      and pcpq.assay_header_id = ash.ash_id
                      and ash.ash_id = asm.ash_id
                      and asm.asm_id = pqca.asm_id
                      and pci.process_id = pc_process_id
                      and pcpq.process_id = pc_process_id
                      and pci.is_active = 'Y'
                      and pcpq.is_active = 'Y'
                      and ash.is_active = 'Y'
                      and asm.is_active = 'Y'
                      and pqca.is_active = 'Y'
                      and pqca.is_elem_for_pricing = 'N'
                      and pqca.is_deductible = 'N'
                      and pci.internal_contract_item_ref_no =
                          cur_unrealized_rows.internal_contract_item_ref_no)
        loop
        
          pkg_phy_pre_check_process.sp_calc_m2m_tc_pc_rc_charge(cur_unrealized_rows.corporate_id,
                                                                pd_trade_date,
                                                                cur_unrealized_rows.conc_product_id,
                                                                cur_unrealized_rows.conc_quality_id,
                                                                cur_unrealized_rows.mvp_id,
                                                                'Penalties',
                                                                cc.element_id,
                                                                cur_unrealized_rows.shipment_month,
                                                                cur_unrealized_rows.shipment_year,
                                                                vc_price_unit_id,
                                                                vn_penality,
                                                                vc_penality_price_unit_id);
          if nvl(vn_penality, 0) <> 0 then
            vn_total_penality := round(vn_total_penality +
                                       (vn_penality * vn_dry_qty_in_base),
                                       cur_unrealized_rows.base_cur_decimal);
          end if;
        
        end loop;
      
      end if;
    
      /* vn_ele_m2m_premium_amt       := (cur_unrealized_rows.m2m_treatment_charge*vn_dry_qty_in_base) +
                                      (cur_unrealized_rows.m2m_refining_charge*vn_ele_qty_in_base);
                                      
      vn_ele_m2m_total_premium_amt := vn_ele_qty_in_base *
                                      nvl(vn_ele_m2m_premium_amt, 0);
                                      
      vn_ele_m2m_total_amount      := vn_ele_m2m_amount_in_base -
                                      vn_ele_m2m_total_premium_amt; */
    
      vn_ele_m2m_total_amount := vn_ele_m2m_amount_in_base -
                                 vn_ele_m2m_treatment_charge -
                                 vn_ele_m2m_refine_charge;
    
      pkg_general.sp_get_main_cur_detail(cur_unrealized_rows.price_unit_cur_id,
                                         vc_price_cur_id,
                                         vc_price_cur_code,
                                         vn_cont_price_cur_id_factor,
                                         vn_cont_price_cur_decimals);
    
      vn_ele_cont_value_in_price_cur := (cur_unrealized_rows.contract_price /
                                        nvl(cur_unrealized_rows.price_unit_weight,
                                             1)) *
                                        (pkg_general.f_get_converted_quantity(cur_unrealized_rows.product_id,
                                                                              cur_unrealized_rows.payable_qty_unit_id,
                                                                              cur_unrealized_rows.price_unit_weight_unit_id,
                                                                              cur_unrealized_rows.payable_qty)) *
                                        vn_cont_price_cur_id_factor;
    
      pkg_general.sp_forward_cur_exchange_new(cur_unrealized_rows.corporate_id,
                                              pd_trade_date,
                                              cur_unrealized_rows.payment_due_date,
                                              vc_price_cur_id,
                                              cur_unrealized_rows.base_cur_id,
                                              30,
                                              vn_fx_price_to_base,
                                              vn_forward_exch_rate);
      if vc_price_cur_id <> cur_unrealized_rows.base_cur_id then
        if vn_fx_price_to_base is null or vn_fx_price_to_base = 0 then
          vobj_error_log.extend;
          vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                               'procedure sp_phy_opencon_ext_unreal_pnl',
                                                               'PHY-005',
                                                               cur_unrealized_rows.base_cur_code ||
                                                               ' to ' ||
                                                               vc_price_cur_code,
                                                               '',
                                                               gvc_process,
                                                               pc_user_id,
                                                               sysdate,
                                                               pd_trade_date);
          sp_insert_error_log(vobj_error_log);
        
        end if;
      end if;
    
      -- contract value in value currency will store the data in base currency
      vn_ele_cont_value_in_price_cur := round(vn_ele_cont_value_in_price_cur *
                                              nvl(vn_fx_price_to_base, 1),
                                              cur_unrealized_rows.base_cur_decimal);
    
      vn_ele_cont_premium := vn_base_con_treatment_charge +
                             vn_base_con_refine_charge;
    
      vn_ele_cont_total_premium := round((nvl(vn_ele_cont_premium, 0) *
                                         vn_ele_qty_in_base),
                                         cur_unrealized_rows.base_cur_decimal);
    
      vn_ele_cont_value_in_base_cur := vn_ele_cont_value_in_price_cur -
                                       vn_ele_cont_total_premium;
      -- secondray cost                                 
      if cur_unrealized_rows.ele_rank = 1 then
        vn_sc_in_base_cur := round(cur_unrealized_rows.sc_in_base_cur *
                                   vn_qty_in_base,
                                   cur_unrealized_rows.base_cur_decimal);
      end if;
    
      -- vn_ele_exp_cog_in_base_cur := round((abs(vn_ele_cont_value_in_base_cur)),2);
    
      /*  if cur_unrealized_rows.purchase_sales = 'P' then
        vn_ele_unreal_pnl_in_base_cur := round((vn_ele_m2m_total_amount -
                                               vn_ele_exp_cog_in_base_cur),
                                               2);
      else
        vn_ele_unreal_pnl_in_base_cur := round((vn_ele_exp_cog_in_base_cur -
                                               vn_ele_m2m_total_amount),
                                               2);
      end if;*/
    
      -- below variable set as zero as it's not used in any calculation.
      vn_unrealized_pnl_in_m2m_unit := 0;
      vc_m2m_price_unit_id          := cur_unrealized_rows.m2m_price_unit_id;
      vc_m2m_price_unit_cur_id      := cur_unrealized_rows.m2m_price_unit_cur_id;
      vc_m2m_price_unit_cur_code    := cur_unrealized_rows.m2m_price_unit_cur_code;
      vc_m2m_price_unit_wgt_unit_id := cur_unrealized_rows.m2m_price_unit_weight_unit_id;
      vc_m2m_price_unit_wgt_unit    := cur_unrealized_rows.m2m_price_unit_weight_unit;
      vn_m2m_price_unit_wgt_unit_wt := cur_unrealized_rows.m2m_price_unit_weight;
    
      insert into poued_element_details
        (corporate_id,
         corporate_name,
         process_id,
         md_id,
         internal_contract_item_ref_no,
         element_id,
         element_name,
         assay_header_id,
         assay_qty,
         assay_qty_unit_id,
         payable_qty,
         payable_qty_unit_id,
         refining_charge,
         treatment_charge,
         -- penalty_charge,
         pricing_details,
         contract_price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         price_unit_weight_unit_id,
         price_unit_weight,
         price_unit_weight_unit,
         m2m_price,
         m2m_price_unit_id,
         m2m_price_cur_id,
         m2m_price_cur_code,
         m2m_price_weight,
         m2m_price_weght_unit_id,
         m2m_price_weight_unit,
         contract_value,
         contract_value_cur_id,
         contract_value_cur_code,
         contract_value_in_base,
         contract_premium_value_in_base,
         m2m_value,
         m2m_value_cur_id,
         m2m_value_cur_code,
         m2m_refining_charge,
         m2m_treatment_charge,
         -- m2m_penalty_charge,
         m2m_loc_diff,
         m2m_amt_in_base,
         -- sc_in_base_cur,
         valuation_dr_id,
         valuation_dr_id_name,
         valuation_month,
         valuation_date,
         expected_cog_net_sale_value,
         unrealized_pnl_in_base_cur,
         base_cur_id,
         base_cur_code,
         price_cur_to_base_cur_fx_rate,
         m2m_cur_to_base_cur_fx_rate,
         derivative_def_id,
         valuation_exchange_id,
         valuation_exchange,
         element_qty_in_base_unit,
         base_price_unit_id_ppu,
         base_price_unit_name,
         valuation_against_underlying)
      values
        (cur_unrealized_rows.corporate_id,
         cur_unrealized_rows.corporate_name,
         pc_process_id,
         cur_unrealized_rows.md_id,
         cur_unrealized_rows.internal_contract_item_ref_no,
         cur_unrealized_rows.element_id,
         cur_unrealized_rows.attribute_name,
         cur_unrealized_rows.assay_header_id,
         cur_unrealized_rows.assay_qty,
         cur_unrealized_rows.assay_qty_unit_id,
         cur_unrealized_rows.payable_qty,
         cur_unrealized_rows.payable_qty_unit_id,
         vn_base_con_refine_charge,
         vn_base_con_treatment_charge,
         -- vn_con_penality_per_elemet,
         cur_unrealized_rows.attribute_name ||
         cur_unrealized_rows.price_description, --pricing_details,
         cur_unrealized_rows.contract_price,
         cur_unrealized_rows.price_unit_id,
         cur_unrealized_rows.price_unit_cur_id,
         cur_unrealized_rows.price_unit_cur_code,
         cur_unrealized_rows.price_unit_weight_unit_id,
         cur_unrealized_rows.price_unit_weight,
         cur_unrealized_rows.price_unit_weight_unit,
         cur_unrealized_rows.net_m2m_price,
         cur_unrealized_rows.m2m_price_unit_id,
         cur_unrealized_rows.m2m_price_unit_cur_id,
         cur_unrealized_rows.m2m_price_unit_cur_code,
         decode(cur_unrealized_rows.m2m_price_unit_weight,
                1,
                null,
                cur_unrealized_rows.m2m_price_unit_weight),
         cur_unrealized_rows.m2m_price_unit_weight_unit_id,
         cur_unrealized_rows.m2m_price_unit_weight_unit,
         vn_ele_cont_value_in_price_cur, --contract_value,
         vc_price_cur_id, --contract_value_cur_id,
         vc_price_cur_code, --contract_value_cur_code,
         vn_ele_cont_value_in_price_cur, --contract_value_in_base, 
         vn_ele_cont_total_premium, --contract_premium_value_in_base , 
         vn_ele_m2m_amount_in_base, --m2m_value,
         vc_m2m_cur_id, --m2m_value_cur_id,
         vc_m2m_cur_code, --m2m_value_cur_code,
         vn_ele_m2m_refine_charge,
         vn_ele_m2m_treatment_charge,
         -- cur_unrealized_rows.m2m_penalty_charge,
         cur_unrealized_rows.m2m_loc_incoterm_deviation,
         vn_ele_m2m_amount_in_base, -- updated by siva on 14sep2011 vn_ele_m2m_total_amount, --m2m_amt_in_base, ---used to sum at main table
         -- round(vn_ele_sc_in_base_cur, 3), --sc_in_base_cur,
         cur_unrealized_rows.valuation_dr_id,
         cur_unrealized_rows.dr_id_name,
         cur_unrealized_rows.valuation_month,
         cur_unrealized_rows.valuation_date,
         vn_ele_exp_cog_in_base_cur, --expected_cog_net_sale_value,
         vn_ele_unreal_pnl_in_base_cur, --unrealized_pnl_in_base_cur,
         cur_unrealized_rows.base_cur_id,
         cur_unrealized_rows.base_cur_code,
         vn_fx_price_to_base, --price_cur_to_base_cur_fx_rate,
         vn_m2m_base_fx_rate, --m2m_cur_to_base_cur_fx_rate,
         cur_unrealized_rows.derivative_def_id,
         cur_unrealized_rows.valuation_exchange_id,
         cur_unrealized_rows.exchange_name,
         vn_ele_qty_in_base,
         cur_unrealized_rows.base_price_unit_id_in_ppu,
         cur_unrealized_rows.base_price_unit_name,
         cur_unrealized_rows.valuation_against_underlying);
    
      if cur_unrealized_rows.ele_rank = 1 then
        insert into poue_phy_open_unreal_element
          (corporate_id,
           corporate_name,
           process_id,
           pcdi_id,
           delivery_item_no,
           prefix,
           middle_no,
           suffix,
           internal_contract_ref_no,
           contract_ref_no,
           contract_issue_date,
           internal_contract_item_ref_no,
           basis_type,
           delivery_period_type,
           delivery_from_month,
           delivery_from_year,
           delivery_to_month,
           delivery_to_year,
           delivery_from_date,
           delivery_to_date,
           transit_days,
           contract_type,
           approval_status,
           unrealized_type,
           profit_center_id,
           profit_center_name,
           profit_center_short_name,
           cp_profile_id,
           cp_name,
           trade_user_id,
           trade_user_name,
           product_id,
           product_name,
           item_dry_qty,
           item_wet_qty,
           qty_unit_id,
           qty_unit,
           quality_id,
           quality_name,
           fixation_method,
           price_string,
           price_fixation_status,
           price_fixation_details,
           item_delivery_period_string,
           incoterm_id,
           incoterm,
           origination_city_id,
           origination_city,
           origination_country_id,
           origination_country,
           destination_city_id,
           destination_city,
           destination_country_id,
           destination_country,
           origination_region_id,
           origination_region,
           destination_region_id,
           destination_region,
           payment_term_id,
           payment_term,
           contract_price_string,
           contract_rc_tc_pen_string,
           m2m_price_string,
           m2m_rc_tc_pen_string,
           net_contract_value_in_base_cur,
           net_contract_prem_in_base_cur,
           net_m2m_amt_in_base_cur,
           net_sc_in_base_cur,
           expected_cog_net_sale_value,
           unrealized_pnl_in_base_cur,
           unreal_pnl_in_base_per_unit,
           prev_day_unr_pnl_in_base_cur,
           trade_day_pnl_in_base_cur,
           base_cur_id,
           base_cur_code,
           group_id,
           group_name,
           group_cur_id,
           group_cur_code,
           group_qty_unit_id,
           group_qty_unit,
           base_qty_unit_id,
           base_qty_unit,
           cont_unr_status,
           qty_in_base_unit,
           process_trade_date,
           strategy_id,
           strategy_name,
           del_distribution_item_no,
           penalty_charge,
           m2m_penalty_charge,
           m2m_loc_diff_premium,
           valuation_against_underlying)
        values
          (cur_unrealized_rows.corporate_id,
           cur_unrealized_rows.corporate_name,
           pc_process_id,
           cur_unrealized_rows.pcdi_id,
           cur_unrealized_rows.delivery_item_no,
           cur_unrealized_rows.prefix,
           cur_unrealized_rows.middle_no,
           cur_unrealized_rows.suffix,
           cur_unrealized_rows.internal_contract_ref_no,
           cur_unrealized_rows.contract_ref_no,
           cur_unrealized_rows.issue_date,
           cur_unrealized_rows.internal_contract_item_ref_no,
           cur_unrealized_rows.basis_type,
           cur_unrealized_rows.delivery_period_type,
           cur_unrealized_rows.delivery_from_month,
           cur_unrealized_rows.delivery_from_year,
           cur_unrealized_rows.delivery_to_month,
           cur_unrealized_rows.delivery_to_year,
           cur_unrealized_rows.delivery_from_date,
           cur_unrealized_rows.delivery_to_date,
           cur_unrealized_rows.transit_days,
           cur_unrealized_rows.purchase_sales,
           cur_unrealized_rows.contract_status,
           cur_unrealized_rows.unrealized_type,
           cur_unrealized_rows.profit_center_id,
           cur_unrealized_rows.profit_center_name,
           cur_unrealized_rows.profit_center_short_name,
           cur_unrealized_rows.cp_id,
           cur_unrealized_rows.cp_name,
           cur_unrealized_rows.trader_id,
           cur_unrealized_rows.trader_user_name,
           cur_unrealized_rows.conc_product_id,
           cur_unrealized_rows.conc_product_name,
           vn_dry_qty,
           vn_wet_qty,
           cur_unrealized_rows.qty_unit_id,
           cur_unrealized_rows.qty_unit,
           cur_unrealized_rows.conc_quality_id,
           cur_unrealized_rows.conc_quality_name,
           cur_unrealized_rows.fixation_method,
           cur_unrealized_rows.price_description,
           cur_unrealized_rows.price_fixation_status,
           cur_unrealized_rows.price_fixation_details,
           cur_unrealized_rows.item_delivery_period_string,
           cur_unrealized_rows.inco_term_id,
           cur_unrealized_rows.incoterm,
           cur_unrealized_rows.origination_city_id,
           cur_unrealized_rows.origination_city,
           cur_unrealized_rows.origination_country_id,
           cur_unrealized_rows.origination_country,
           cur_unrealized_rows.destination_city_id,
           cur_unrealized_rows.destination_city,
           cur_unrealized_rows.destination_country_id,
           cur_unrealized_rows.destination_country,
           cur_unrealized_rows.origination_region_id,
           cur_unrealized_rows.origination_region,
           cur_unrealized_rows.destination_region_id,
           cur_unrealized_rows.destination_region,
           cur_unrealized_rows.payment_term_id,
           cur_unrealized_rows.payment_term,
           null, -- contract_price_string,
           null, --contract_rc_tc_pen_string,
           null, -- m2m_price_string,
           null, -- m2m_rc_tc_pen_string,
           null, -- net_contract_value_in_base_cur,
           null, -- net_contract_prem_in_base_cur,
           null, -- net_m2m_amt_in_base_cur, 
           vn_sc_in_base_cur, -- net_sc_in_base_cur,
           null, -- expected_cog_net_sale_value,
           null, -- unrealized_pnl_in_base_cur,
           null, -- unreal_pnl_in_base_per_unit,
           null, -- prev_day_unr_pnl_in_base_cur,
           null, -- trade_day_pnl_in_base_cur,
           cur_unrealized_rows.base_cur_id,
           cur_unrealized_rows.base_cur_code,
           cur_unrealized_rows.groupid,
           cur_unrealized_rows.groupname,
           cur_unrealized_rows.cur_id_gcd,
           cur_unrealized_rows.cur_code_gcd,
           cur_unrealized_rows.qty_unit_id_gcd,
           cur_unrealized_rows.qty_unit_gcd,
           cur_unrealized_rows.base_qty_unit_id,
           cur_unrealized_rows.base_qty_unit,
           null, -- cont_unr_status,
           vn_qty_in_base,
           pd_trade_date,
           cur_unrealized_rows.strategy_id,
           cur_unrealized_rows.strategy_name,
           cur_unrealized_rows.del_distribution_item_no,
           vn_base_con_penality_charge,
           vn_total_penality,
           vn_loc_total_amount,
           cur_unrealized_rows.valuation_against_underlying);
      end if;
    
    end loop;
  
    for cur_update_pnl in (select poude.internal_contract_item_ref_no,
                                  sum(poude.contract_value_in_base) net_contract_value_in_base_cur,
                                  sum(poude.contract_premium_value_in_base) net_contract_prem_in_base_cur,
                                  sum(poude.m2m_amt_in_base) net_m2m_amt_in_base_cur,
                                  sum(poude.treatment_charge) net_contract_treatment_charge,
                                  sum(poude.refining_charge) net_contract_refining_charge,
                                  sum(poude.m2m_treatment_charge) net_m2m_treatment_charge,
                                  sum(poude.m2m_refining_charge) net_m2m_refining_charge,
                                  -- sum(poude.expected_cog_net_sale_value) expected_cog_net_sale_value,
                                  --sum(poude.unrealized_pnl_in_base_cur) unrealized_pnl_in_base_cur,
                                  stragg(poude.element_name || '-' ||
                                         poude.contract_price || ' ' ||
                                         poude.price_unit_cur_code || '/' ||
                                         poude.price_unit_weight ||
                                         poude.price_unit_weight_unit) contract_price_string,
                                  (case
                                     when poude.valuation_against_underlying = 'N' then
                                      max((case
                                     when nvl(poude.m2m_price, 0) <> 0 then
                                      (poude.m2m_price || ' ' ||
                                      poude.m2m_price_cur_code || '/' ||
                                      poude.m2m_price_weight ||
                                      poude.m2m_price_weight_unit)
                                     else
                                      null
                                   end)) else stragg((case
                                    when nvl(poude.m2m_price,
                                             0) <> 0 then
                                     (poude.element_name || '-' ||
                                     poude.m2m_price || ' ' ||
                                     poude.m2m_price_cur_code || '/' ||
                                     poude.m2m_price_weight ||
                                     poude.m2m_price_weight_unit)
                                    else
                                     null
                                  end)) end) m2m_price_string, -- TODO if underly valuation = n, show the concentrate price
                                  stragg('TC:' || poude.element_name || '-' ||
                                         poude.treatment_charge || ' ' ||
                                         poude.base_cur_code || '  ' ||
                                         'RC:' || poude.element_name || '-' ||
                                         poude.refining_charge || ' ' ||
                                         poude.base_cur_code) contract_rc_tc_pen_string,
                                  stragg('TC:' || poude.element_name || '-' ||
                                         poude.m2m_treatment_charge || ' ' ||
                                         poude.base_cur_code || ' ' || 'RC:' ||
                                         poude.element_name || '-' ||
                                         poude.m2m_refining_charge || ' ' ||
                                         poude.base_cur_code) m2m_rc_tc_pen_string
                             from poued_element_details poude
                            where poude.corporate_id = pc_corporate_id
                              and poude.process_id = pc_process_id
                            group by poude.internal_contract_item_ref_no,
                                     poude.valuation_against_underlying)
    loop
      update poue_phy_open_unreal_element poue
         set poue.net_contract_value_in_base_cur = round(cur_update_pnl.net_contract_value_in_base_cur,
                                                         2),
             poue.net_contract_prem_in_base_cur  = round(cur_update_pnl.net_contract_prem_in_base_cur,
                                                         2),
             poue.net_m2m_amt_in_base_cur        = round(cur_update_pnl.net_m2m_amt_in_base_cur,
                                                         2),
             poue.net_contract_treatment_charge  = cur_update_pnl.net_contract_treatment_charge,
             poue.net_contract_refining_charge   = cur_update_pnl.net_contract_refining_charge,
             poue.net_m2m_treatment_charge       = cur_update_pnl.net_m2m_treatment_charge,
             poue.net_m2m_refining_charge        = cur_update_pnl.net_m2m_refining_charge,
             -- poue.expected_cog_net_sale_value    = round(cur_update_pnl.expected_cog_net_sale_value, 3),
             /*poue.unrealized_pnl_in_base_cur     = round(cur_update_pnl.unrealized_pnl_in_base_cur,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                    
                                                                              
                                                                                                        
                                                                                                                                                                         
                                                                                                                                                                                      
                                                                                                                                                                                                                
                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       3),*/
             poue.contract_price_string     = cur_update_pnl.contract_price_string,
             poue.m2m_price_string          = cur_update_pnl.m2m_price_string,
             poue.contract_rc_tc_pen_string = cur_update_pnl.contract_rc_tc_pen_string,
             poue.m2m_rc_tc_pen_string      = cur_update_pnl.m2m_rc_tc_pen_string
       where poue.internal_contract_item_ref_no =
             cur_update_pnl.internal_contract_item_ref_no
         and poue.process_id = pc_process_id
         and poue.corporate_id = pc_corporate_id;
    end loop;
    commit;
  
    update poue_phy_open_unreal_element poue
       set poue.expected_cog_net_sale_value = poue.net_contract_value_in_base_cur -
                                              poue.net_contract_treatment_charge -
                                              poue.net_contract_refining_charge +
                                              poue.net_sc_in_base_cur
     where poue.corporate_id = pc_corporate_id
       and poue.process_id = pc_process_id;
    commit;
    --- update unrealized pnl
  
    update poue_phy_open_unreal_element poue
       set poue.unrealized_pnl_in_base_cur = (case when poue.contract_type = 'P' then(poue.net_m2m_amt_in_base_cur - poue.net_m2m_treatment_charge - poue.net_m2m_refining_charge - nvl(poue.m2m_penalty_charge, 0) + poue.m2m_loc_diff_premium) - (poue.expected_cog_net_sale_value - nvl(poue.penalty_charge, 0)) else(poue.expected_cog_net_sale_value - nvl(poue.penalty_charge, 0)) - (poue.net_m2m_amt_in_base_cur - poue.net_m2m_treatment_charge - poue.net_m2m_refining_charge - nvl(poue.m2m_penalty_charge, 0) + poue.m2m_loc_diff_premium) end)
     where poue.corporate_id = pc_corporate_id
       and poue.process_id = pc_process_id;
    commit;
    -- update pnl base per unit
    update poue_phy_open_unreal_element poue
       set poue.unreal_pnl_in_base_per_unit = round(poue.unrealized_pnl_in_base_cur /
                                                    poue.qty_in_base_unit,
                                                    2)
     where poue.corporate_id = pc_corporate_id
       and poue.process_id = pc_process_id
       and poue.qty_in_base_unit <> 0;
  
    -- update previous eod data  
    begin
      for cur_update in (select poue_prev_day.internal_contract_item_ref_no,
                                poue_prev_day.unreal_pnl_in_base_per_unit,
                                poue_prev_day.unrealized_type
                           from poue_phy_open_unreal_element poue_prev_day
                          where poue_prev_day.process_id =
                                gvc_previous_process_id
                            and corporate_id = pc_corporate_id)
      loop
        update poue_phy_open_unreal_element poue_today
           set poue_today.prev_day_unr_pnl_in_base_cur = round(cur_update.unreal_pnl_in_base_per_unit *
                                                               poue_today.qty_in_base_unit,
                                                               2),
               poue_today.cont_unr_status              = 'EXISTING_TRADE'
         where poue_today.internal_contract_item_ref_no =
               cur_update.internal_contract_item_ref_no
           and poue_today.process_id = pc_process_id
           and poue_today.unrealized_type = cur_update.unrealized_type
           and poue_today.corporate_id = pc_corporate_id;
      end loop;
    exception
      when others then
        dbms_output.put_line('SQLERRM-1' || sqlerrm);
    end;
  
    -- mark the trades came as new in this eod/eom
  
    begin
      update poue_phy_open_unreal_element poue
         set poue.cont_unr_status = 'NEW_TRADE'
       where poue.cont_unr_status is null
         and poue.process_id = pc_process_id
         and poue.corporate_id = pc_corporate_id;
    exception
      when others then
        dbms_output.put_line('SQLERRM-2' || sqlerrm);
    end;
  
    update poue_phy_open_unreal_element poue
       set poue.trade_day_pnl_in_base_cur = round(nvl(poue.unrealized_pnl_in_base_cur,
                                                      0) - nvl(poue.prev_day_unr_pnl_in_base_cur,
                                                               0),
                                                  2)
     where poue.process_id = pc_process_id
       and poue.corporate_id = pc_corporate_id
       and poue.unrealized_type = 'Unrealized';
  
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure sp_calc_phy_opencon_unreal_pnl',
                                                           'M2M-013',
                                                           'Code:' ||
                                                           sqlcode ||
                                                           'Message:' ||
                                                           sqlerrm,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;

  procedure sp_stock_unreal_shipped_not_tt(pc_corporate_id varchar2,
                                           pd_trade_date   date,
                                           pc_process_id   varchar2,
                                           pc_user_id      varchar2) as
    cursor cur_grd is
    -- Purchase Shipped But Not TT
      select 'Purchase' section_type,
             pcpd.profit_center_id profit_center,
             pc_process_id process_id,
             gmr.corporate_id,
             gmr.internal_gmr_ref_no,
             grd.internal_contract_item_ref_no,
             pcm.purchase_sales,
             grd.product_id,
             pdm.product_desc product_name,
             grd.origin_id,
             orm.origin_name,
             qat.quality_id,
             qat.quality_name,
             grd.container_no,
             grd.current_qty stock_qty,
             grd.qty_unit_id,
             gmr.qty_unit_id gmr_qty_unit_id,
             qum.qty_unit,
             grd.no_of_units,
             md.md_id,
             md.m2m_price_unit_id,
             md.net_m2m_price,
             md.m2m_price_unit_cur_id,
             md.m2m_price_unit_cur_code,
             md.m2m_price_unit_weight_unit_id,
             md.m2m_price_unit_weight_unit,
             nvl(md.m2m_price_unit_weight, 1) m2m_price_unit_weight,
             md.m2m_price_unit_cur_code || '/' ||
             decode(md.m2m_price_unit_weight,
                    1,
                    null,
                    md.m2m_price_unit_weight) ||
             md.m2m_price_unit_weight_unit m2m_price_unit_str,
             md.m2m_main_cur_id,
             md.m2m_main_cur_code,
             md.m2m_main_cur_decimals,
             md.main_currency_factor,
             md.settlement_cur_id,
             md.settlement_to_val_fx_rate,
             nvl(gpd.contract_price, spd.stock_price) contract_price,
             nvl(gpd.price_unit_id, spd.price_unit_id) price_unit_id,
             nvl(gpd.price_unit_weight_unit_id,
                 spd.price_unit_weight_unit_id) price_unit_weight_unit_id,
             nvl(gpd.price_unit_weight, spd.price_unit_weight) price_unit_weight,
             nvl(gpd.price_unit_cur_id, spd.price_unit_cur_id) price_unit_cur_id,
             nvl(gpd.price_unit_cur_code, spd.price_unit_cur_code) price_unit_cur_code,
             nvl(gpd.price_unit_weight_unit, spd.price_unit_weight_unit) price_unit_weight_unit,
             cipd.price_fixation_details,
             nvl(cipd.payment_due_date, pd_trade_date) payment_due_date,
             akc.base_cur_id as base_cur_id,
             akc.base_currency_name base_cur_code,
             grd.inventory_status,
             gsm.status shipment_status,
             (case
               when nvl(grd.is_afloat, 'N') = 'Y' and
                    nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                'Shipped NTT'
               when nvl(grd.is_afloat, 'N') = 'Y' and
                    nvl(grd.inventory_status, 'NA') = 'In' then
                'Shipped IN'
               when nvl(grd.is_afloat, 'N') = 'Y' and
                    nvl(grd.inventory_status, 'NA') = 'Out' then
                'Shipped TT'
               when nvl(grd.is_afloat, 'N') = 'N' and
                    nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                'Stock NTT'
               when nvl(grd.is_afloat, 'N') = 'N' and
                    nvl(grd.inventory_status, 'NA') = 'In' then
                'Stock IN'
               when nvl(grd.is_afloat, 'N') = 'N' and
                    nvl(grd.inventory_status, 'NA') = 'Out' then
                'Stock TT'
               else
                'Others'
             end) section_name,
             cipd.price_basis,
             gmr.shed_id,
             gmr.destination_city_id,
             cipd.price_fixation_status price_fixation_status,
             pdm.base_quantity_unit base_qty_unit_id,
             pcpd.strategy_id,
             css.strategy_name,
             (ciqs.total_qty - nvl(ciqs.price_fixed_qty, 0)) unfxd_qty,
             ciqs.price_fixed_qty fxd_qty,
             md.valuation_exchange_id,
             md.valuation_month,
             md.derivative_def_id,
             nvl(gmr.is_voyage_gmr, 'N') is_voyage_gmr,
             gmr.contract_type gmr_contract_type,
             grd.internal_grd_ref_no internal_grd_dgrd_ref_no,
             grd.internal_stock_ref_no stock_ref_no,
             pcm.trader_id,
             (case
               when pcm.trader_id is not null then
                (select gab.firstname || ' ' || gab.lastname
                   from gab_globaladdressbook gab,
                        ak_corporate_user     aku
                  where gab.gabid = aku.gabid
                    and aku.user_id = pcm.trader_id)
               else
                ''
             end) trader_user_name,
             md.m2m_loc_incoterm_deviation,
             md.m2m_quality_premium,
             md.m2m_product_premium,
             md.base_price_unit_id_in_ppu,
             md.base_price_unit_id_in_pum,
             nvl(md.m2m_loc_incoterm_deviation, 0) +
             nvl(md.m2m_quality_premium, 0) +
             nvl(md.m2m_product_premium, 0) total_premium,
             qat.eval_basis,
             nvl(pcdb.premium, 0) delivery_premium,
             pcdb.premium_unit_id delivery_premium_unit_id,
             gpd.price_fixation_status gmr_price_fixation_status,
             nvl(gscs.avg_cost_fw_rate, 0) noncog_secondary_cost_per_unit,
             cipd.price_description cipd_price_description,
             null as gpd_price_description,
             pci.expected_delivery_month || '-' ||
             pci.expected_delivery_year item_delivery_period_string,
             decode(grd.partnership_type, 'Consignment', 'Y', 'N') as is_marked_for_consignment,
             gmr.vessel_name,
             md.m2m_pp_fw_exch_rate,
             md.m2m_ld_fw_exch_rate,
             md.m2m_qp_fw_exch_rate,
             gscs.fw_rate_string accrual_to_base_fw_exch_rate
        from gmr_goods_movement_record gmr,
             grd_goods_record_detail grd,
             gpd_gmr_price_daily gpd,
             pcm_physical_contract_main pcm,
             pcpd_pc_product_definition pcpd,
             pdm_productmaster pdm,
             orm_origin_master orm,
             qat_quality_attributes qat,
             qum_quantity_unit_master qum,
             (select md1.*
                from md_m2m_daily md1
               where md1.rate_type <> 'OPEN'
                 and md1.corporate_id = pc_corporate_id
                 and md1.product_type = 'BASEMETAL'
                 and md1.process_id = pc_process_id) md,
             (select tmp.*
                from tmpc_temp_m2m_pre_check tmp
               where tmp.corporate_id = pc_corporate_id
                 and tmp.product_type = 'BASEMETAL'
                 and tmp.section_name <> 'OPEN') tmpc,
             cipd_contract_item_price_daily cipd,
             ak_corporate akc,
             cm_currency_master cm,
             gsm_gmr_stauts_master gsm,
             pci_physical_contract_item pci,
             pcdb_pc_delivery_basis pcdb,
             ciqs_contract_item_qty_status ciqs,
             css_corporate_strategy_setup css,
             gscs_gmr_sec_cost_summary gscs,
             spd_stock_price_daily spd
       where grd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
         and gmr.internal_contract_ref_no = pcm.internal_contract_ref_no
         and pcm.internal_contract_ref_no = pcpd.internal_contract_ref_no
         and grd.product_id = pdm.product_id
         and grd.origin_id = orm.origin_id(+)
         and gmr.internal_gmr_ref_no = gpd.internal_gmr_ref_no(+)
         and gmr.process_id = gpd.process_id(+)
         and grd.internal_gmr_ref_no = tmpc.internal_gmr_ref_no(+)
         and grd.internal_grd_ref_no = tmpc.internal_grd_ref_no(+)
         and grd.internal_contract_item_ref_no =
             tmpc.internal_contract_item_ref_no(+)
         and tmpc.quality_id = qat.quality_id(+)
         and grd.qty_unit_id = qum.qty_unit_id(+)
         and tmpc.internal_m2m_id = md.md_id(+)
         and grd.internal_contract_item_ref_no =
             cipd.internal_contract_item_ref_no
         and grd.process_id = cipd.process_id
         and cipd.internal_contract_ref_no = pcm.internal_contract_ref_no
         and grd.internal_contract_item_ref_no =
             ciqs.internal_contract_item_ref_no
         and grd.internal_contract_item_ref_no =
             pci.internal_contract_item_ref_no
         and pci.pcdb_id = pcdb.pcdb_id
         and pci.process_id = pcdb.process_id
         and gmr.corporate_id = akc.corporate_id
         and akc.base_cur_id = cm.cur_id
         and gmr.status_id = gsm.status_id(+)
         and pcpd.strategy_id = css.strategy_id
         and grd.process_id = pc_process_id
         and gmr.process_id = pc_process_id
         and pcpd.process_id = pc_process_id
         and cipd.process_id = pc_process_id
         and ciqs.process_id = pc_process_id
         and pcm.process_id = pc_process_id
         and pci.process_id = pc_process_id
         and spd.process_id = pc_process_id
         and pcm.contract_status = 'In Position'
         and pcm.contract_type = 'BASEMETAL'
         and pcm.is_active = 'Y'
         and pci.is_active = 'Y'
         and gmr.corporate_id = pc_corporate_id
         and grd.status = 'Active'
         and grd.is_deleted = 'N'
         and gmr.is_deleted = 'N'
         and nvl(grd.inventory_status, 'NA') = 'NA'
         and pcm.purchase_sales = 'P'
         and nvl(grd.current_qty, 0) > 0
         and gmr.is_internal_movement = 'N'
         and gmr.internal_gmr_ref_no = gscs.internal_gmr_ref_no(+)
         and gmr.process_id = gscs.process_id(+)
         and grd.internal_contract_item_ref_no =
             pci.internal_contract_item_ref_no
         and grd.process_id = pci.process_id
         and spd.internal_drg_dgrd_ref_no = grd.internal_grd_ref_no
      union all
      select 'Sales' section_type,
             pcpd.profit_center_id profit_center,
             pc_process_id process_id,
             gmr.corporate_id,
             gmr.internal_gmr_ref_no,
             dgrd.internal_contract_item_ref_no,
             pcm.purchase_sales,
             dgrd.product_id,
             pdm.product_desc product_name,
             dgrd.origin_id,
             orm.origin_name,
             tmpc.quality_id,
             qat.quality_name,
             '' container_no,
             dgrd.net_weight stock_qty,
             dgrd.net_weight_unit_id qty_unit_id,
             gmr.qty_unit_id gmr_qty_unit_id,
             qum.qty_unit,
             gmr.current_no_of_units no_of_units,
             md.md_id,
             md.m2m_price_unit_id,
             md.net_m2m_price,
             md.m2m_price_unit_cur_id,
             md.m2m_price_unit_cur_code,
             md.m2m_price_unit_weight_unit_id,
             md.m2m_price_unit_weight_unit,
             nvl(md.m2m_price_unit_weight, 1) m2m_price_unit_weight,
             md.m2m_price_unit_cur_code || '/' ||
             decode(md.m2m_price_unit_weight,
                    1,
                    null,
                    md.m2m_price_unit_weight) ||
             md.m2m_price_unit_weight_unit m2m_price_unit_str,
             md.m2m_main_cur_id,
             md.m2m_main_cur_code,
             md.m2m_main_cur_decimals,
             md.main_currency_factor,
             md.settlement_cur_id,
             md.settlement_to_val_fx_rate,
             nvl(gpd.contract_price, spd.stock_price) contract_price,
             nvl(gpd.price_unit_id, spd.price_unit_id) price_unit_id,
             nvl(gpd.price_unit_weight_unit_id,
                 spd.price_unit_weight_unit_id) price_unit_weight_unit_id,
             nvl(gpd.price_unit_weight, spd.price_unit_weight) price_unit_weight,
             nvl(gpd.price_unit_cur_id, spd.price_unit_cur_id) price_unit_cur_id,
             nvl(gpd.price_unit_cur_code, spd.price_unit_cur_code) price_unit_cur_code,
             nvl(gpd.price_unit_weight_unit, spd.price_unit_weight_unit) price_unit_weight_unit,
             cipd.price_fixation_details,
             nvl(cipd.payment_due_date, pd_trade_date) payment_due_date,
             akc.base_cur_id as base_cur_id,
             akc.base_currency_name base_cur_code,
             gmr.inventory_status,
             gsm.status shipment_status,
             (case
               when nvl(dgrd.inventory_status, 'NA') = 'Under CMA' then
                'UnderCMA NTT'
               when nvl(dgrd.is_afloat, 'N') = 'Y' and
                    nvl(dgrd.inventory_status, 'NA') in ('In', 'None', 'NA') then
                'Shipped NTT'
               when nvl(dgrd.is_afloat, 'N') = 'Y' and
                    nvl(dgrd.inventory_status, 'NA') = 'Out' then
                'Shipped TT'
               when nvl(dgrd.is_afloat, 'N') = 'N' and
                    nvl(dgrd.inventory_status, 'NA') in ('In', 'None', 'NA') then
                'Stock NTT'
               when nvl(dgrd.is_afloat, 'N') = 'N' and
                    nvl(dgrd.inventory_status, 'NA') = 'Out' then
                'Stock TT'
               else
                'Others'
             end) section_name,
             cipd.price_basis,
             gmr.shed_id,
             gmr.destination_city_id,
             cipd.price_fixation_status price_fixation_status,
             pdm.base_quantity_unit base_qty_unit_id,
             pcpd.strategy_id,
             css.strategy_name,
             (ciqs.total_qty - nvl(ciqs.price_fixed_qty, 0)) unfxd_qty,
             ciqs.price_fixed_qty fxd_qty,
             md.valuation_exchange_id,
             md.valuation_month,
             md.derivative_def_id,
             nvl(gmr.is_voyage_gmr, 'N') is_voyage_gmr,
             gmr.contract_type gmr_contract_type,
             dgrd.internal_dgrd_ref_no internal_grd_dgrd_ref_no,
             dgrd.internal_stock_ref_no stock_ref_no,
             pcm.trader_id,
             (case
               when pcm.trader_id is not null then
                (select gab.firstname || ' ' || gab.lastname
                   from gab_globaladdressbook gab,
                        ak_corporate_user     aku
                  where gab.gabid = aku.gabid
                    and aku.user_id = pcm.trader_id)
               else
                ''
             end) trader_user_name,
             md.m2m_loc_incoterm_deviation,
             md.m2m_quality_premium,
             md.m2m_product_premium,
             md.base_price_unit_id_in_ppu,
             md.base_price_unit_id_in_pum,
             nvl(md.m2m_loc_incoterm_deviation, 0) +
             nvl(md.m2m_quality_premium, 0) +
             nvl(md.m2m_product_premium, 0) total_premium,
             qat.eval_basis,
             nvl(pcdb.premium, 0) delivery_premium,
             pcdb.premium_unit_id delivery_premium_unit_id,
             gpd.price_fixation_status gmr_price_fixation_status,
             nvl(gscs.avg_cost_fw_rate, 0) noncog_secondary_cost_per_unit,
             cipd.price_description cipd_price_description,
             null as gpd_price_description,
             pci.expected_delivery_month || '-' ||
             pci.expected_delivery_year item_delivery_period_string,
             decode(dgrd.partnership_type, 'Consignment', 'Y', 'N') as is_marked_for_consignment,
             gmr.vessel_name,
             md.m2m_pp_fw_exch_rate,
             md.m2m_ld_fw_exch_rate,
             md.m2m_qp_fw_exch_rate,
             gscs.fw_rate_string accrual_to_base_fw_exch_rate
        from gmr_goods_movement_record gmr,
             gpd_gmr_price_daily gpd,
             dgrd_delivered_grd dgrd,
             agh_alloc_group_header agh,
             pcm_physical_contract_main pcm,
             pcpd_pc_product_definition pcpd,
             pdm_productmaster pdm,
             orm_origin_master orm,
             qat_quality_attributes qat,
             qum_quantity_unit_master qum,
             (select md1.*
                from md_m2m_daily md1
               where md1.rate_type <> 'OPEN'
                 and md1.corporate_id = pc_corporate_id
                 and md1.product_type = 'BASEMETAL'
                 and md1.process_id = pc_process_id) md,
             (select tmp.*
                from tmpc_temp_m2m_pre_check tmp
               where tmp.corporate_id = pc_corporate_id
                 and tmp.product_type = 'BASEMETAL'
                 and tmp.section_name <> 'OPEN') tmpc,
             cipd_contract_item_price_daily cipd,
             ak_corporate akc,
             gsm_gmr_stauts_master gsm,
             ciqs_contract_item_qty_status ciqs,
             pci_physical_contract_item pci,
             pcdb_pc_delivery_basis pcdb,
             cm_currency_master cm,
             css_corporate_strategy_setup css,
             spd_stock_price_daily spd,
             gscs_gmr_sec_cost_summary gscs
       where dgrd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
         and gmr.internal_contract_ref_no = pcm.internal_contract_ref_no
         and pcm.internal_contract_ref_no = pcpd.internal_contract_ref_no
         and gmr.internal_gmr_ref_no = gpd.internal_gmr_ref_no(+)
         and gmr.process_id = gpd.process_id(+)
         and dgrd.product_id = pdm.product_id
         and dgrd.origin_id = orm.origin_id(+)
         and dgrd.int_alloc_group_id = agh.int_alloc_group_id
         and dgrd.internal_gmr_ref_no = tmpc.internal_gmr_ref_no(+)
         and dgrd.internal_dgrd_ref_no = tmpc.internal_grd_ref_no(+)
         and dgrd.internal_contract_item_ref_no =
             tmpc.internal_contract_item_ref_no(+)
         and tmpc.quality_id = qat.quality_id(+)
         and dgrd.net_weight_unit_id = qum.qty_unit_id(+)
         and tmpc.internal_m2m_id = md.md_id(+)
         and dgrd.internal_contract_item_ref_no =
             cipd.internal_contract_item_ref_no
         and dgrd.process_id = cipd.process_id
         and cipd.internal_contract_ref_no = pcm.internal_contract_ref_no
         and cipd.internal_contract_item_ref_no =
             pci.internal_contract_item_ref_no
         and pci.internal_contract_item_ref_no =
             ciqs.internal_contract_item_ref_no
         and gmr.corporate_id = akc.corporate_id
         and akc.base_cur_id = cm.cur_id
         and cm.cur_code = akc.base_currency_name
         and gmr.status_id = gsm.status_id(+)
         and pcpd.strategy_id = css.strategy_id
         and pci.pcdb_id = pcdb.pcdb_id
         and pci.process_id = pcdb.process_id
         and pcm.purchase_sales = 'S'
         and gsm.is_required_for_m2m = 'Y'
         and pcm.contract_status = 'In Position'
         and pcm.contract_type = 'BASEMETAL'
         and pcm.is_active = 'Y'
         and pci.is_active = 'Y'
         and gmr.is_deleted = 'N'
         and pcm.process_id = pc_process_id
         and pci.process_id = pc_process_id
         and ciqs.process_id = pc_process_id
         and upper(dgrd.realized_status) in
             ('UNREALIZED', 'UNDERCMA', 'REVERSEREALIZED', 'REVERSEUNDERCMA')
         and dgrd.status = 'Active'
         and nvl(dgrd.net_weight, 0) > 0
         and dgrd.process_id = pc_process_id
         and gmr.process_id = pc_process_id
         and cipd.process_id = pc_process_id
         and agh.process_id = pc_process_id
         and pcpd.process_id = pc_process_id
         and agh.is_deleted = 'N'
         and gmr.corporate_id = pc_corporate_id
         and gmr.is_internal_movement = 'N'
         and nvl(gmr.inventory_status, 'NA') <> 'Out'
         and spd.internal_drg_dgrd_ref_no = dgrd.internal_dgrd_ref_no
         and spd.process_id = pc_process_id
         and dgrd.internal_gmr_ref_no = gscs.internal_gmr_ref_no(+)
         and dgrd.process_id = gscs.process_id(+)
      union all
      -- Internal Movement Shipped But Not TT
      select 'Internal Movement' section_type,
             grd.profit_center_id profit_center,
             pc_process_id process_id,
             gmr.corporate_id,
             gmr.internal_gmr_ref_no,
             grd.internal_contract_item_ref_no,
             (case
               when gmr.contract_type = 'Purchase' then
                'P'
               when gmr.contract_type = 'Sales' then
                'S'
               else
                'P'
             end) purchase_sales,
             grd.product_id,
             pdm.product_desc product_name,
             grd.origin_id,
             orm.origin_name,
             qat.quality_id,
             qat.quality_name,
             grd.container_no,
             grd.current_qty stock_qty,
             grd.qty_unit_id,
             gmr.qty_unit_id gmr_qty_unit_id,
             qum.qty_unit,
             grd.no_of_units,
             md.md_id,
             md.m2m_price_unit_id,
             md.net_m2m_price,
             md.m2m_price_unit_cur_id,
             md.m2m_price_unit_cur_code,
             md.m2m_price_unit_weight_unit_id,
             md.m2m_price_unit_weight_unit,
             nvl(md.m2m_price_unit_weight, 1) m2m_price_unit_weight,
             md.m2m_price_unit_cur_code || '/' ||
             decode(md.m2m_price_unit_weight,
                    1,
                    null,
                    md.m2m_price_unit_weight) ||
             md.m2m_price_unit_weight_unit m2m_price_unit_str,
             md.m2m_main_cur_id,
             md.m2m_main_cur_code,
             md.m2m_main_cur_decimals,
             md.main_currency_factor,
             md.settlement_cur_id,
             md.settlement_to_val_fx_rate,
             nvl(gpd.contract_price, spd.stock_price) contract_price,
             nvl(gpd.price_unit_id, spd.price_unit_id) price_unit_id,
             nvl(gpd.price_unit_weight_unit_id,
                 spd.price_unit_weight_unit_id) price_unit_weight_unit_id,
             nvl(gpd.price_unit_weight, spd.price_unit_weight) price_unit_weight,
             nvl(gpd.price_unit_cur_id, spd.price_unit_cur_id) price_unit_cur_id,
             nvl(gpd.price_unit_cur_code, spd.price_unit_cur_code) price_unit_cur_code,
             nvl(gpd.price_unit_weight_unit, spd.price_unit_weight_unit) price_unit_weight_unit,
             null price_fixation_details,
             pd_trade_date payment_due_date,
             akc.base_cur_id as base_cur_id,
             akc.base_currency_name base_cur_code,
             grd.inventory_status,
             gsm.status shipment_status,
             (case
               when nvl(grd.is_afloat, 'N') = 'Y' and
                    nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                'Shipped NTT'
               when nvl(grd.is_afloat, 'N') = 'Y' and
                    nvl(grd.inventory_status, 'NA') = 'In' then
                'Shipped IN'
               when nvl(grd.is_afloat, 'N') = 'Y' and
                    nvl(grd.inventory_status, 'NA') = 'Out' then
                'Shipped TT'
               when nvl(grd.is_afloat, 'N') = 'N' and
                    nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                'Stock NTT'
               when nvl(grd.is_afloat, 'N') = 'N' and
                    nvl(grd.inventory_status, 'NA') = 'In' then
                'Stock IN'
               when nvl(grd.is_afloat, 'N') = 'N' and
                    nvl(grd.inventory_status, 'NA') = 'Out' then
                'Stock TT'
               else
                'Others'
             end) section_name,
             null price_basis,
             gmr.shed_id,
             gmr.destination_city_id,
             null price_fixation_status,
             pdm.base_quantity_unit base_qty_unit_id,
             grd.strategy_id strategy_id,
             css.strategy_name strategy_name,
             null unfxd_qty,
             null fxd_qty,
             md.valuation_exchange_id,
             md.valuation_month,
             md.derivative_def_id,
             nvl(gmr.is_voyage_gmr, 'N') is_voyage_gmr,
             gmr.contract_type gmr_contract_type,
             grd.internal_grd_ref_no internal_grd_dgrd_ref_no,
             grd.internal_stock_ref_no stock_ref_no,
             gmr.created_by trader_id,
             (case
               when gmr.created_by is not null then
                (select gab.firstname || ' ' || gab.lastname
                   from gab_globaladdressbook gab,
                        ak_corporate_user     aku
                  where gab.gabid = aku.gabid
                    and aku.user_id = gmr.created_by)
               else
                ''
             end) trader_user_name,
             md.m2m_loc_incoterm_deviation,
             md.m2m_quality_premium,
             md.m2m_product_premium,
             md.base_price_unit_id_in_ppu,
             md.base_price_unit_id_in_pum,
             nvl(md.m2m_loc_incoterm_deviation, 0) +
             nvl(md.m2m_quality_premium, 0) +
             nvl(md.m2m_product_premium, 0) total_premium,
             qat.eval_basis,
             null delivery_premium,
             null delivery_premium_unit_id,
             gpd.price_fixation_status gmr_price_fixation_status,
             nvl(gscs.avg_cost_fw_rate, 0) noncog_secondary_cost_per_unit,
             null cipd_price_description,
             null as gpd_price_description,
             null item_delivery_period_string,
             decode(grd.partnership_type, 'Consignment', 'Y', 'N') as is_marked_for_consignment,
             gmr.vessel_name,
             md.m2m_pp_fw_exch_rate,
             md.m2m_ld_fw_exch_rate,
             md.m2m_qp_fw_exch_rate,
             gscs.fw_rate_string accrual_to_base_fw_exch_rate
        from gmr_goods_movement_record gmr,
             grd_goods_record_detail grd,
             gpd_gmr_price_daily gpd,
             pdm_productmaster pdm,
             orm_origin_master orm,
             qum_quantity_unit_master qum,
             qat_quality_attributes qat,
             ak_corporate akc,
             cm_currency_master cm,
             gsm_gmr_stauts_master gsm,
             (select md1.*
                from md_m2m_daily md1
               where md1.rate_type <> 'OPEN'
                 and md1.corporate_id = pc_corporate_id
                 and md1.product_type = 'BASEMETAL'
                 and md1.process_id = pc_process_id) md,
             (select tmp.*
                from tmpc_temp_m2m_pre_check tmp
               where tmp.corporate_id = pc_corporate_id
                 and tmp.product_type = 'BASEMETAL'
                 and tmp.section_name <> 'OPEN') tmpc,
             gscs_gmr_sec_cost_summary gscs,
             spd_stock_price_daily spd,
             css_corporate_strategy_setup css
       where grd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
         and grd.product_id = pdm.product_id
         and gmr.internal_gmr_ref_no = gpd.internal_gmr_ref_no(+)
         and gmr.process_id = gpd.process_id(+)
         and grd.origin_id = orm.origin_id(+)
         and grd.qty_unit_id = qum.qty_unit_id(+)
         and grd.internal_gmr_ref_no = tmpc.internal_gmr_ref_no(+)
         and grd.internal_grd_ref_no = tmpc.internal_grd_ref_no(+)
         and tmpc.quality_id = qat.quality_id(+)
         and tmpc.internal_m2m_id = md.md_id(+)
         and gmr.corporate_id = akc.corporate_id
         and akc.base_cur_id = cm.cur_id
         and gmr.status_id = gsm.status_id(+)
         and grd.process_id = pc_process_id
         and gmr.process_id = pc_process_id
         and gmr.corporate_id = pc_corporate_id
         and grd.status = 'Active'
         and grd.is_deleted = 'N'
         and gmr.is_deleted = 'N'
         and nvl(grd.inventory_status, 'NA') = 'NA'
         and nvl(grd.current_qty, 0) > 0
         and gmr.is_internal_movement = 'Y'
         and gmr.internal_gmr_ref_no = gscs.internal_gmr_ref_no(+)
         and gmr.process_id = gscs.process_id(+)
         and spd.internal_drg_dgrd_ref_no = grd.internal_grd_ref_no
         and spd.process_id = pc_process_id
         and grd.strategy_id = css.strategy_id(+);
    vn_qty_in_base                 number;
    vn_m2m_amt                     number;
    vc_m2m_cur_id                  varchar2(15);
    vc_m2m_cur_code                varchar2(15);
    vn_m2m_sub_cur_id_factor       number;
    vn_m2m_cur_decimals            number;
    vc_price_cur_id                varchar2(15);
    vc_price_cur_code              varchar2(15);
    vn_cont_price_cur_id_factor    number;
    vn_contract_value_in_price_cur number;
    vn_cont_price_cur_decimals     number;
    vn_contract_value_in_val_cur   number;
    vn_contract_value_in_base_cur  number;
    vc_m2m_price_unit_str          varchar2(100);
    vc_m2m_price_unit_id           varchar2(15);
    vc_m2m_price_unit_cur_id       varchar2(15);
    vn_ratio                       number;
    vn_corp_rate_val_to_base_cur   number;
    vn_spot_rate_base_to_val_cur   number;
    vn_expected_cog_net_sale_value number;
    vn_expected_cog_in_val_cur     number;
    vn_pnl_in_val_cur              number;
    vn_pnl_in_base_cur             number;
    vn_pnl_per_base_unit           number;
    vc_psu_id                      varchar2(500);
    vn_pnl_in_exch_price_unit      number;
    vobj_error_log                 tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count             number := 1;
    vn_m2m_base_fx_rate            number;
    vn_m2m_base_deviation          number;
    vn_m2m_amount_in_base          number;
    vn_m2m_total_amount            number;
    vn_m2m_total_premium_amt       number;
    vn_fx_price_to_base            number;
    vn_fx_price_deviation          number;
    vn_total_premium_value         number;
    vn_quality_premium             number;
    vn_product_premium             number;
    vn_product_premium_amt         number;
    vc_base_price_unit_id          varchar2(20);
    vn_m2m_amt_per_unit            number;
    vn_cont_price                  number;
    vc_cont_price_unit_id          varchar2(15);
    vc_cont_price_unit_cur_id      varchar2(15);
    vc_cont_price_unit_cur_code    varchar2(15);
    vn_cont_price_wt               number;
    vc_cont_price_wt_unit_id       varchar2(15);
    vc_cont_price_wt_unit          varchar2(15);
    vn_sc_in_base_cur              number;
    vc_price_fixation_status       varchar2(50);
    vc_error_msg                   varchar2(100);
    vn_trade_day_pnl_per_base_unit number;
    vc_price_string                varchar2(500);
    vc_del_premium_cur_id          varchar2(15);
    vc_del_premium_cur_code        varchar2(15);
    vc_del_premium_main_cur_id     varchar2(15);
    vc_del_premium_main_cur_code   varchar2(15);
    vn_del_premium_cur_main_factor number;
    vc_del_premium_weight_unit_id  varchar2(15);
    vn_del_premium_weight          number;
    vn_del_to_base_fw_rate         number;
    vn_forward_points              number;
    vc_qual_prem_exch_rate_string  varchar2(500);
    -- Variable for all exchange rate string start
    vc_price_to_base_fw_rate    varchar2(100);
    vc_m2m_to_base_fw_rate      varchar2(100);
    vc_m2m_ld_fw_exch_rate      varchar2(100);
    vc_m2m_qp_fw_exch_rate      varchar2(100);
    vc_m2m_pp_fw_exch_rate      varchar2(100);
    vc_contract_qp_fw_exch_rate varchar2(100);
    vc_contract_pp_fw_exch_rate varchar2(100);
    -- Variable for all exchange rate string end
  begin
    for cur_grd_rows in cur_grd
    loop
      vc_m2m_ld_fw_exch_rate := cur_grd_rows.m2m_ld_fw_exch_rate;
      vc_m2m_qp_fw_exch_rate := cur_grd_rows.m2m_qp_fw_exch_rate;
      vc_m2m_pp_fw_exch_rate := cur_grd_rows.m2m_pp_fw_exch_rate;
    
      vn_product_premium            := 0;
      vn_product_premium_amt        := 0;
      vn_quality_premium            := 0;
      vn_contract_value_in_base_cur := 0;
      vn_total_premium_value        := 0;
      vn_cont_price                 := 0;
      vc_cont_price_unit_id         := null;
      vc_cont_price_unit_cur_id     := null;
      vc_cont_price_unit_cur_code   := null;
      vn_cont_price_wt              := 1;
      vc_cont_price_wt_unit_id      := null;
      vc_cont_price_wt_unit         := null;
      vc_price_fixation_status      := null;
      if cur_grd_rows.gpd_price_description is null then
        vc_price_string := cur_grd_rows.cipd_price_description;
      else
        vc_price_string := cur_grd_rows.gpd_price_description;
      end if;
      if cur_grd_rows.gmr_price_fixation_status is null then
        vc_price_fixation_status := cur_grd_rows.price_fixation_status;
      else
        vc_price_fixation_status := cur_grd_rows.gmr_price_fixation_status;
      end if;
      vn_cont_price               := cur_grd_rows.contract_price;
      vc_cont_price_unit_id       := cur_grd_rows.price_unit_id;
      vc_cont_price_unit_cur_id   := cur_grd_rows.price_unit_cur_id;
      vc_cont_price_unit_cur_code := cur_grd_rows.price_unit_cur_code;
      vn_cont_price_wt            := cur_grd_rows.price_unit_weight;
      vc_cont_price_wt_unit_id    := cur_grd_rows.price_unit_weight_unit_id;
      vc_cont_price_wt_unit       := cur_grd_rows.price_unit_weight_unit;
    
      vc_error_msg := vn_cont_price || vc_cont_price_unit_id;
      if cur_grd_rows.stock_qty <> 0 then
        vc_psu_id      := cur_grd_rows.internal_gmr_ref_no || '-' ||
                          cur_grd_rows.internal_grd_dgrd_ref_no || '-' ||
                          cur_grd_rows.internal_contract_item_ref_no || '-' ||
                          cur_grd_rows.container_no;
        vc_error_msg   := '1';
        vn_qty_in_base := cur_grd_rows.stock_qty *
                          pkg_general.f_get_converted_quantity(cur_grd_rows.product_id,
                                                               cur_grd_rows.qty_unit_id,
                                                               cur_grd_rows.base_qty_unit_id,
                                                               1);
        vc_error_msg   := '2';
        if cur_grd_rows.eval_basis = 'FIXED' then
          vn_m2m_amt               := 0;
          vc_m2m_price_unit_cur_id := cur_grd_rows.base_cur_id;
        else
          vc_m2m_price_unit_cur_id := nvl(cur_grd_rows.m2m_price_unit_cur_id,
                                          cur_grd_rows.base_cur_id);
          vn_m2m_amt               := nvl(cur_grd_rows.net_m2m_price, 0) /
                                      nvl(cur_grd_rows.m2m_price_unit_weight,
                                          1) *
                                      pkg_general.f_get_converted_quantity(cur_grd_rows.product_id,
                                                                           cur_grd_rows.qty_unit_id,
                                                                           cur_grd_rows.m2m_price_unit_weight_unit_id,
                                                                           cur_grd_rows.stock_qty);
        end if;
        vc_error_msg := '3';
        pkg_general.sp_get_main_cur_detail(nvl(vc_m2m_price_unit_cur_id,
                                               cur_grd_rows.base_cur_id),
                                           vc_m2m_cur_id,
                                           vc_m2m_cur_code,
                                           vn_m2m_sub_cur_id_factor,
                                           vn_m2m_cur_decimals);
        vn_m2m_amt   := round(vn_m2m_amt * vn_m2m_sub_cur_id_factor, 2);
        vc_error_msg := '4';
        if cur_grd_rows.eval_basis <> 'FIXED' then
          --
          -- Forwad Rate from Valuation to Base Currency
          --
          pkg_general.sp_forward_cur_exchange_new(cur_grd_rows.corporate_id,
                                                  pd_trade_date,
                                                  cur_grd_rows.payment_due_date,
                                                  nvl(vc_m2m_cur_id,
                                                      cur_grd_rows.base_cur_id),
                                                  cur_grd_rows.base_cur_id,
                                                  30,
                                                  vn_m2m_base_fx_rate,
                                                  vn_m2m_base_deviation);
          vc_error_msg := '5';
          if (vn_m2m_base_fx_rate <> 0 or vn_m2m_base_fx_rate <> 1 or
             vn_m2m_base_fx_rate is not null) then
            if vc_m2m_cur_code <> cur_grd_rows.base_cur_code then
              vc_m2m_to_base_fw_rate := '1 ' || vc_m2m_cur_code || '=' ||
                                        vn_m2m_base_fx_rate || ' ' ||
                                        cur_grd_rows.base_cur_code;
            end if;
          end if;
          if vc_m2m_cur_id <> cur_grd_rows.base_cur_id then
            if vn_m2m_base_fx_rate is null or vn_m2m_base_fx_rate = 0 then
              vobj_error_log.extend;
              vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                   'procedure pkg_phy_physical_process-sp_calc_phy_open_unrealized ',
                                                                   'PHY-005',
                                                                   cur_grd_rows.base_cur_code ||
                                                                   ' to ' ||
                                                                   vc_m2m_cur_code || ' (' ||
                                                                   to_char(cur_grd_rows.payment_due_date,
                                                                           'dd-Mon-yyyy') || ') ',
                                                                   '',
                                                                   gvc_process,
                                                                   pc_user_id,
                                                                   sysdate,
                                                                   pd_trade_date);
              sp_insert_error_log(vobj_error_log);
            end if;
          end if;
        end if;
        vn_m2m_amount_in_base    := vn_m2m_amt * vn_m2m_base_fx_rate;
        vn_m2m_total_premium_amt := vn_qty_in_base *
                                    cur_grd_rows.total_premium;
        vn_m2m_total_amount      := vn_m2m_amount_in_base +
                                    vn_m2m_total_premium_amt;
        vc_error_msg             := '6';
        vn_m2m_amt_per_unit      := round(vn_m2m_total_amount /
                                          vn_qty_in_base,
                                          8);
        pkg_general.sp_get_main_cur_detail(nvl(vc_cont_price_unit_cur_id,
                                               cur_grd_rows.base_cur_id),
                                           vc_price_cur_id,
                                           vc_price_cur_code,
                                           vn_cont_price_cur_id_factor,
                                           vn_cont_price_cur_decimals);
        vc_error_msg := '7';
        if nvl(vn_cont_price, 0) <> 0 and
           vc_cont_price_wt_unit_id is not null then
          vc_error_msg                   := '8';
          vn_contract_value_in_price_cur := (vn_cont_price /
                                            nvl(vn_cont_price_wt, 1)) *
                                            (pkg_general.f_get_converted_quantity(cur_grd_rows.product_id,
                                                                                  cur_grd_rows.qty_unit_id,
                                                                                  vc_cont_price_wt_unit_id,
                                                                                  cur_grd_rows.stock_qty)) *
                                            vn_cont_price_cur_id_factor;
        else
          vn_contract_value_in_price_cur := 0;
        end if;
        vc_error_msg := '9';
        --
        -- Forward FX Rate from Price to Base Currency
        --
        pkg_general.sp_forward_cur_exchange_new(cur_grd_rows.corporate_id,
                                                pd_trade_date,
                                                cur_grd_rows.payment_due_date,
                                                vc_price_cur_id,
                                                cur_grd_rows.base_cur_id,
                                                30,
                                                vn_fx_price_to_base,
                                                vn_fx_price_deviation);
      
        if vn_fx_price_to_base <> 0 or vn_fx_price_to_base <> 1 or
           vn_fx_price_to_base is not null then
        
          if vc_price_cur_code <> cur_grd_rows.base_cur_code then
            vc_price_to_base_fw_rate := '1 ' || vc_price_cur_code || '=' ||
                                        vn_fx_price_to_base || ' ' ||
                                        cur_grd_rows.base_cur_code;
          end if;
        end if;
      
        vn_contract_value_in_price_cur := round(vn_contract_value_in_price_cur,
                                                vn_cont_price_cur_decimals);
        --
        -- Contract Value in Base Currency
        --
        vn_contract_value_in_base_cur := round((vn_contract_value_in_price_cur *
                                               nvl(vn_fx_price_to_base, 1)),
                                               2);
      end if;
      vc_error_msg          := '10';
      vc_m2m_price_unit_str := cur_grd_rows.m2m_price_unit_str;
      vc_m2m_price_unit_id  := cur_grd_rows.m2m_price_unit_id;
      begin
        select ppu.product_price_unit_id
          into vc_base_price_unit_id
          from v_ppu_pum ppu
         where ppu.cur_id = cur_grd_rows.base_cur_id
           and ppu.weight_unit_id = cur_grd_rows.base_qty_unit_id
           and nvl(ppu.weight, 1) = 1
           and ppu.product_id = cur_grd_rows.product_id;
      exception
        when others then
          sp_write_log(pc_corporate_id,
                       pd_trade_date,
                       'sp_open_phy_unreal',
                       'vc_base_price_unit' || vc_base_price_unit_id ||
                       ' For' || cur_grd_rows.internal_contract_item_ref_no);
      end;
      vc_error_msg := '11';
      ------------------******** Premium Calculations starts here ******-------------------
      --
      -- Quality Premium 
      --
      --
      -- Cannot calculate if Stock is internal movement and not having Contract Item #
      --
      if cur_grd_rows.internal_contract_item_ref_no is not null and
         cur_grd_rows.payment_due_date is not null then
        sp_quality_premium_fw_rate(cur_grd_rows.internal_contract_item_ref_no,
                                   pc_corporate_id,
                                   pd_trade_date,
                                   vc_base_price_unit_id,
                                   cur_grd_rows.base_cur_id,
                                   cur_grd_rows.payment_due_date,
                                   cur_grd_rows.product_id,
                                   cur_grd_rows.base_qty_unit_id,
                                   pc_process_id,
                                   vn_quality_premium,
                                   vc_qual_prem_exch_rate_string);
        vc_contract_qp_fw_exch_rate := vc_qual_prem_exch_rate_string;
      else
        vn_quality_premium := 0;
      end if;
    
      if cur_grd_rows.delivery_premium <> 0 then
        if cur_grd_rows.delivery_premium_unit_id <> vc_base_price_unit_id then
          --
          -- Get the Delivery Premium Currency 
          --
          select ppu.cur_id,
                 cm.cur_code,
                 nvl(ppu.weight, 1),
                 ppu.weight_unit_id
            into vc_del_premium_cur_id,
                 vc_del_premium_cur_code,
                 vn_del_premium_weight,
                 vc_del_premium_weight_unit_id
            from v_ppu_pum          ppu,
                 cm_currency_master cm
           where ppu.product_price_unit_id =
                 cur_grd_rows.delivery_premium_unit_id
             and cm.cur_id = ppu.cur_id;
          --
          -- Get the Main Currency of the Delivery Premium Price Unit
          --
          pkg_general.sp_get_base_cur_detail(vc_del_premium_cur_id,
                                             vc_del_premium_main_cur_id,
                                             vc_del_premium_main_cur_code,
                                             vn_del_premium_cur_main_factor);
        
          pkg_general.sp_forward_cur_exchange_new(pc_corporate_id,
                                                  pd_trade_date,
                                                  cur_grd_rows.payment_due_date,
                                                  vc_del_premium_main_cur_id,
                                                  cur_grd_rows.base_cur_id,
                                                  30,
                                                  vn_del_to_base_fw_rate,
                                                  vn_forward_points);
        
          vn_product_premium := (cur_grd_rows.delivery_premium /
                                vn_del_premium_weight) *
                                vn_del_premium_cur_main_factor *
                                vn_del_to_base_fw_rate *
                                pkg_general.f_get_converted_quantity(cur_grd_rows.product_id,
                                                                     vc_del_premium_weight_unit_id,
                                                                     cur_grd_rows.base_qty_unit_id,
                                                                     1);
          if cur_grd_rows.base_cur_code <> vc_del_premium_main_cur_code then
            vc_contract_pp_fw_exch_rate := '1 ' ||
                                           vc_del_premium_main_cur_code || '=' ||
                                           vn_del_to_base_fw_rate || ' ' ||
                                           cur_grd_rows.base_cur_code;
          end if;
        
          if cur_grd_rows.base_cur_code <> vc_del_premium_main_cur_code then
            if vn_m2m_base_fx_rate is null or vn_m2m_base_fx_rate = 0 then
              vobj_error_log.extend;
              vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                   'procedure pkg_phy_physical_process-sp_calc_phy_open_unrealized ',
                                                                   'PHY-005',
                                                                   vc_del_premium_main_cur_code ||
                                                                   ' to ' ||
                                                                   cur_grd_rows.base_cur_code || ' (' ||
                                                                   to_char(cur_grd_rows.payment_due_date,
                                                                           'dd-Mon-yyyy') || ') ',
                                                                   '',
                                                                   gvc_process,
                                                                   pc_user_id,
                                                                   sysdate,
                                                                   pd_trade_date);
              sp_insert_error_log(vobj_error_log);
            end if;
          end if;
        else
          vn_product_premium := cur_grd_rows.delivery_premium;
        end if;
        vn_product_premium_amt := round(vn_product_premium * vn_qty_in_base,
                                        2);
      else
        vn_product_premium     := 0;
        vn_product_premium_amt := 0;
      end if;
      vc_error_msg           := '13';
      vn_total_premium_value := round((vn_quality_premium * vn_qty_in_base) +
                                      vn_product_premium_amt,
                                      2);
      --
      -- Secondary Cost in Base
      --                                               
      vn_sc_in_base_cur := cur_grd_rows.noncog_secondary_cost_per_unit *
                           vn_qty_in_base;
    
      --------------------------------------------------------------------------
      vc_error_msg               := '14';
      vn_expected_cog_in_val_cur := round(vn_contract_value_in_base_cur, 2);
    
      --
      -- Total COG = Contract Value (Qty*Price) + Quality Premium + Delivery Premium + Secondary Cost
      --
    
      vn_expected_cog_in_val_cur := vn_expected_cog_in_val_cur +
                                    vn_total_premium_value +
                                    abs(vn_sc_in_base_cur);
    
      if cur_grd_rows.purchase_sales = 'P' then
        vn_contract_value_in_val_cur := (-1) * vn_contract_value_in_val_cur;
        vn_expected_cog_in_val_cur   := (-1) * vn_expected_cog_in_val_cur;
      else
        vn_contract_value_in_val_cur := vn_contract_value_in_val_cur;
        vn_expected_cog_in_val_cur   := vn_expected_cog_in_val_cur;
      end if;
      vn_expected_cog_net_sale_value := round(vn_expected_cog_in_val_cur, 2);
      if cur_grd_rows.purchase_sales = 'P' then
        vn_pnl_in_val_cur := (vn_m2m_total_amount -
                             (nvl(vn_expected_cog_in_val_cur, 0) * (-1)));
      else
        vn_pnl_in_val_cur := (nvl(vn_expected_cog_in_val_cur, 0) -
                             vn_m2m_total_amount);
      end if;
      vc_error_msg              := '15';
      vn_pnl_in_val_cur         := round(vn_pnl_in_val_cur, 2);
      vn_pnl_in_base_cur        := round(vn_pnl_in_val_cur, 2);
      vn_pnl_per_base_unit      := round(vn_pnl_in_base_cur /
                                         nvl(vn_qty_in_base, 1),
                                         5);
      vc_error_msg              := '16';
      vc_error_msg              := '17';
      vn_pnl_in_exch_price_unit := 0;
    
      vn_trade_day_pnl_per_base_unit := vn_pnl_in_base_cur / vn_qty_in_base;
      vc_error_msg                   := '18';
    
      insert into psu_phy_stock_unrealized
        (process_id,
         psu_id,
         corporate_id,
         internal_gmr_ref_no,
         internal_contract_item_ref_no,
         product_id,
         product_name,
         origin_id,
         origin_name,
         quality_id,
         quality_name,
         container_no,
         stock_qty,
         qty_unit_id,
         qty_unit,
         no_of_units,
         md_id,
         m2m_price_unit_id,
         m2m_price_unit_str,
         m2m_amt,
         m2m_amt_cur_id,
         m2m_amt_cur_code,
         contract_value_in_price_cur,
         contract_price_cur_id,
         contract_price_cur_code,
         material_cost_in_base_cur,
         material_cost_in_val_cur,
         sc_in_base_cur,
         sc_in_valuation_cur,
         expected_cog_in_base_cur,
         expected_cog_in_val_cur,
         pnl_type,
         pnl_in_base_cur,
         pnl_in_val_cur,
         prev_day_pnl_in_base_cur,
         prev_day_pnl_in_val_cur,
         trade_day_pnl_in_base_cur,
         trade_day_pnl_in_val_cur,
         pnl_in_exch_price_unit,
         prev_pnl_in_exch_price_unit,
         day_pnl_in_exch_price_unit,
         pnl_per_base_unit,
         trade_day_pnl_per_base_unit,
         fw_fx_price_cur_to_m2m_cur,
         fw_fx_base_cur_to_m2m_cur,
         spot_rate_m2m_cur_to_base_cur,
         base_cur_id,
         base_cur_code,
         inventory_status,
         shipment_status,
         section_name,
         base_price_unit_id,
         qty_in_base_unit,
         m2m_price_unit_cur_id,
         m2m_price_unit_cur_code,
         m2m_price_unit_qty_unit_id,
         m2m_price_unit_qty_unit,
         m2m_price_unit_qty_unit_weight,
         spot_price_cur_to_base_cur,
         invm_inventory_status,
         strategy_id,
         strategy_name,
         valuation_month,
         contract_type,
         profit_center_id,
         net_m2m_price,
         unfxd_qty,
         fxd_qty,
         valuation_exchange_id,
         derivative_def_id,
         price_to_val_rate,
         val_to_base_rate,
         base_to_val_rate,
         sec_cost_ratio,
         gmr_contract_type,
         is_voyage_gmr,
         sc_to_val_fx_rate,
         sc_to_val_fx_rate_cur_id,
         sc_to_val_fx_rate_cur_code,
         int_alloc_group_id,
         internal_grd_dgrd_ref_no,
         vessel_id,
         charter_voyage_id,
         vessel_voyage_name,
         price_type_id,
         price_type_name,
         price_string,
         item_delivery_period_string,
         fixation_method,
         price_fixation_details,
         contract_price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         price_unit_weight_unit_id,
         price_unit_weight,
         price_unit_weight_unit,
         voyage_ref_no,
         stock_ref_no,
         trader_name,
         trader_id,
         unreal_pnl_in_base_per_unit,
         unreal_pnl_in_val_cur_per_unit,
         contract_premium_value,
         m2m_quality_premium,
         m2m_product_premium,
         m2m_loc_diff_premium,
         base_price_unit_id_in_ppu,
         base_price_unit_id_in_pum,
         market_premimum_amt,
         m2m_amt_per_unit,
         is_marked_for_consignment,
         price_to_base_fw_exch_rate,
         m2m_to_base_fw_exch_rate,
         m2m_ld_fw_exch_rate,
         m2m_qp_fw_exch_rate,
         m2m_pp_fw_exch_rate,
         contract_qp_fw_exch_rate,
         contract_pp_fw_exch_rate,
         accrual_to_base_fw_exch_rate)
      values
        (pc_process_id,
         vc_psu_id,
         pc_corporate_id,
         cur_grd_rows.internal_gmr_ref_no,
         cur_grd_rows.internal_contract_item_ref_no,
         cur_grd_rows.product_id,
         cur_grd_rows.product_name,
         cur_grd_rows.origin_id,
         cur_grd_rows.origin_name,
         cur_grd_rows.quality_id,
         cur_grd_rows.quality_name,
         cur_grd_rows.container_no,
         cur_grd_rows.stock_qty,
         cur_grd_rows.qty_unit_id,
         cur_grd_rows.qty_unit,
         cur_grd_rows.no_of_units,
         cur_grd_rows.md_id,
         vc_m2m_price_unit_id,
         vc_m2m_price_unit_str,
         vn_m2m_total_amount,
         cur_grd_rows.base_cur_id,
         cur_grd_rows.base_cur_code,
         vn_contract_value_in_price_cur,
         vc_price_cur_id,
         vc_price_cur_code,
         vn_contract_value_in_base_cur,
         vn_contract_value_in_base_cur,
         vn_sc_in_base_cur,
         vn_sc_in_base_cur,
         vn_expected_cog_net_sale_value,
         vn_expected_cog_in_val_cur,
         'Unrealized',
         vn_pnl_in_base_cur,
         vn_pnl_in_val_cur,
         null, --prev_day_pnl_in_base_cur
         null, -- prev_day_pnl_in_val_cur
         null, -- trade_day_pnl_in_base_cur
         null, --  trade_day_pnl_in_val_cur
         vn_pnl_in_exch_price_unit,
         null, --   prev_pnl_in_exch_price_unit
         null, --  day_pnl_in_exch_price_unit
         vn_pnl_per_base_unit, --  v_pnl_per_base_unit
         vn_trade_day_pnl_per_base_unit,
         null, --fw_fx_price_cur_to_m2m_cur
         null, --fw_fx_base_cur_to_m2m_cur
         vn_corp_rate_val_to_base_cur,
         cur_grd_rows.base_cur_id,
         cur_grd_rows.base_cur_code,
         cur_grd_rows.inventory_status,
         cur_grd_rows.shipment_status,
         cur_grd_rows.section_name,
         vc_base_price_unit_id,
         vn_qty_in_base,
         cur_grd_rows.m2m_price_unit_cur_id,
         cur_grd_rows.m2m_price_unit_cur_code,
         cur_grd_rows.m2m_price_unit_weight_unit_id,
         cur_grd_rows.m2m_price_unit_weight_unit,
         cur_grd_rows.m2m_price_unit_weight,
         vn_fx_price_to_base, --vn_corp_rate_price_to_base_cur,
         null, --cur_grd_rows.invm_inventory_status,
         cur_grd_rows.strategy_id,
         cur_grd_rows.strategy_name,
         cur_grd_rows.valuation_month,
         cur_grd_rows.purchase_sales,
         cur_grd_rows.profit_center,
         cur_grd_rows.net_m2m_price,
         cur_grd_rows.unfxd_qty,
         cur_grd_rows.fxd_qty,
         cur_grd_rows.valuation_exchange_id,
         cur_grd_rows.derivative_def_id,
         null, --vn_spot_rate_price_to_val_cur,
         vn_m2m_base_fx_rate, --vn_corp_rate_val_to_base_cur,
         null, --vn_spot_rate_base_to_val_cur,
         vn_ratio,
         cur_grd_rows.gmr_contract_type,
         cur_grd_rows.is_voyage_gmr,
         vn_spot_rate_base_to_val_cur,
         null, --sc_to_val_fx_rate_cur_id
         null, --sc_to_val_fx_rate_cur_code
         null, -- cur_grd_rows.int_alloc_group_id,
         cur_grd_rows.internal_grd_dgrd_ref_no,
         null, --cur_grd_rows.vessel_id,
         null, --cur_grd_rows.voyage_number,
         cur_grd_rows.vessel_name,
         cur_grd_rows.price_basis,
         null, --cur_grd_rows.price_type_name,
         vc_price_string,
         null, -- cur_grd_rows.item_delivery_period_string
         vc_price_fixation_status,
         cur_grd_rows.price_fixation_details,
         vn_cont_price,
         vc_cont_price_unit_id,
         vc_cont_price_unit_cur_id,
         vc_cont_price_unit_cur_code,
         vc_cont_price_wt_unit_id,
         vn_cont_price_wt,
         vc_cont_price_wt_unit,
         null, --cur_grd_rows.voyage_ref_no,
         cur_grd_rows.stock_ref_no,
         cur_grd_rows.trader_user_name,
         cur_grd_rows.trader_id,
         vn_pnl_in_base_cur / decode(vn_qty_in_base, 0, 1, vn_qty_in_base),
         vn_pnl_in_val_cur / decode(vn_qty_in_base, 0, 1, vn_qty_in_base),
         vn_total_premium_value,
         cur_grd_rows.m2m_quality_premium,
         cur_grd_rows.m2m_product_premium,
         cur_grd_rows.m2m_loc_incoterm_deviation,
         cur_grd_rows.base_price_unit_id_in_ppu,
         cur_grd_rows.base_price_unit_id_in_pum,
         vn_m2m_total_premium_amt,
         vn_m2m_amt_per_unit,
         cur_grd_rows.is_marked_for_consignment,
         vc_price_to_base_fw_rate,
         vc_m2m_to_base_fw_rate,
         vc_m2m_ld_fw_exch_rate,
         vc_m2m_qp_fw_exch_rate,
         vc_m2m_pp_fw_exch_rate,
         vc_contract_qp_fw_exch_rate,
         vc_contract_pp_fw_exch_rate,
         cur_grd_rows.accrual_to_base_fw_exch_rate);
    end loop;
    -----------
    vc_error_msg := '19';
    commit;
    sp_gather_stats('psu_phy_stock_unrealized');
    sp_gather_stats('pcm_physical_contract_main');
    sp_gather_stats('pci_physical_contract_item');
    sp_gather_stats('cipd_contract_item_price_daily');
    dbms_output.put_line('finsihed loop');
    vc_error_msg := '20';
    begin
      --
      -- update previous eod data
      --
      for cur_update in (select psu_prev_day.unreal_pnl_in_base_per_unit,
                                psu_prev_day.unreal_pnl_in_val_cur_per_unit,
                                psu_prev_day.pnl_in_exch_price_unit,
                                psu_prev_day.m2m_quality_premium,
                                psu_prev_day.m2m_product_premium,
                                psu_prev_day.m2m_loc_diff_premium,
                                psu_prev_day.market_premimum_amt,
                                psu_prev_day.net_m2m_price,
                                psu_prev_day.m2m_price_unit_id,
                                psu_prev_day.m2m_amt,
                                psu_prev_day.m2m_amt_cur_id,
                                psu_prev_day.m2m_amt_cur_code,
                                psu_prev_day.psu_id,
                                psu_prev_day.m2m_amt_per_unit,
                                psu_prev_day.prev_market_value,
                                psu_prev_day.m_pnl_in_base_cur
                           from psu_phy_stock_unrealized psu_prev_day
                          where process_id = gvc_previous_process_id
                            and corporate_id = pc_corporate_id)
      loop
        vc_error_msg := '21';
        update psu_phy_stock_unrealized psu_today
           set psu_today.prev_day_pnl_in_val_cur       = cur_update.unreal_pnl_in_val_cur_per_unit *
                                                         psu_today.qty_in_base_unit,
               psu_today.prev_day_pnl_in_base_cur      = cur_update.unreal_pnl_in_base_per_unit *
                                                         psu_today.qty_in_base_unit,
               psu_today.prev_pnl_in_exch_price_unit   = cur_update.pnl_in_exch_price_unit,
               psu_today.prev_m2m_quality_premium      = cur_update.m2m_quality_premium,
               psu_today.prev_m2m_product_premium      = cur_update.m2m_product_premium,
               psu_today.prev_m2m_loc_diff_premium     = cur_update.m2m_loc_diff_premium,
               psu_today.prev_market_premimum_amt      = cur_update.market_premimum_amt,
               psu_today.prev_market_price             = cur_update.net_m2m_price,
               psu_today.prev_market_price_unit_id     = cur_update.m2m_price_unit_id,
               psu_today.prev_market_value             = round(nvl(cur_update.m2m_amt_per_unit,
                                                                   0) *
                                                               psu_today.qty_in_base_unit,
                                                               4),
               psu_today.prev_market_value_cur_id      = cur_update.m2m_amt_cur_id,
               psu_today.prev_market_value_cur_code    = cur_update.m2m_amt_cur_code,
               psu_today.prev_m2m_amt_per_unit         = cur_update.m2m_amt_per_unit,
               psu_today.m_prev_day_pnl_in_base_cur    = (cur_update.m2m_amt -
                                                         cur_update.prev_market_value),
               psu_today.m_prev_day_pnl_in_val_cur     = (cur_update.m2m_amt -
                                                         cur_update.prev_market_value),
               psu_today.m_trade_day_pnl_per_base_unit = (psu_today.m_pnl_in_base_cur -
                                                         cur_update.m_pnl_in_base_cur) /
                                                         psu_today.qty_in_base_unit,
               psu_today.cont_unr_status               = 'EXISTING_TRADE'
         where psu_today.psu_id = cur_update.psu_id
           and psu_today.process_id = pc_process_id
           and psu_today.corporate_id = pc_corporate_id;
      end loop;
    exception
      when others then
        dbms_output.put_line('SQLERRM-1' || sqlerrm);
    end;
    vc_error_msg := '22';
    --
    -- mark the trades came as new in this eod/eom
    --
    begin
      update psu_phy_stock_unrealized psu
         set psu.prev_day_pnl_in_val_cur     = 0,
             psu.prev_day_pnl_in_base_cur    = 0,
             psu.prev_pnl_in_exch_price_unit = 0,
             psu.m_prev_day_pnl_in_base_cur  = 0,
             psu.m_prev_day_pnl_in_val_cur   = 0,
             psu.m_pnl_in_base_cur           = 0,
             psu.m_trade_day_pnl_in_base_cur = 0,
             psu.prev_m2m_quality_premium    = psu.m2m_quality_premium,
             psu.prev_m2m_product_premium    = psu.m2m_product_premium,
             psu.prev_m2m_loc_diff_premium   = psu.m2m_loc_diff_premium,
             psu.prev_market_premimum_amt    = psu.market_premimum_amt,
             psu.prev_market_price           = psu.net_m2m_price,
             psu.prev_market_price_unit_id   = psu.m2m_price_unit_id,
             psu.prev_market_value           = psu.m2m_amt,
             psu.prev_market_value_cur_id    = psu.m2m_amt_cur_id,
             psu.prev_market_value_cur_code  = psu.m2m_amt_cur_code,
             psu.prev_m2m_amt_per_unit       = psu.m2m_amt_per_unit,
             psu.cont_unr_status             = 'NEW_TRADE'
       where psu.cont_unr_status is null
         and psu.process_id = pc_process_id
         and psu.corporate_id = pc_corporate_id;
    exception
      when others then
        dbms_output.put_line('SQLERRM-2' || sqlerrm);
    end;
    vc_error_msg := '23';
    update psu_phy_stock_unrealized psu
       set psu.m_pnl_in_val_cur          = (psu.m2m_amt -
                                           psu.prev_market_value),
           psu.m_pnl_in_base_cur         = (psu.m2m_amt -
                                           psu.prev_market_value),
           psu.m_pnl_in_base_per_unit    = (psu.m2m_amt -
                                           psu.prev_market_value) /
                                           psu.qty_in_base_unit,
           psu.m_pnl_in_val_cur_per_unit = (psu.m2m_amt -
                                           psu.prev_market_value) /
                                           psu.qty_in_base_unit
     where psu.process_id = pc_process_id
       and psu.corporate_id = pc_corporate_id;
    --
    -- update trade day pnl values
    -- It is difference of unrealized pnl on trade date and previous eod For M2M PNL
    -- Else it is same as PNL as on Today
    -- 
    vc_error_msg := '24';
    sp_write_log(pc_corporate_id,
                 pd_trade_date,
                 'Phy Stock Unrlzd',
                 'after loop' || vc_error_msg);
    update psu_phy_stock_unrealized psu
       set m_trade_day_pnl_in_val_cur    = nvl(psu.m_pnl_in_val_cur, 0) -
                                           nvl(psu.m_prev_day_pnl_in_val_cur,
                                               0),
           m_trade_day_pnl_in_base_cur   = nvl(psu.m_pnl_in_base_cur, 0) -
                                           nvl(psu.m_prev_day_pnl_in_base_cur,
                                               0),
           psu.trade_day_pnl_in_base_cur = psu.pnl_in_base_cur -
                                           psu.prev_day_pnl_in_base_cur,
           psu.trade_day_pnl_in_val_cur  = psu.pnl_in_val_cur -
                                           psu.prev_day_pnl_in_val_cur
     where psu.process_id = pc_process_id;
    sp_write_log(pc_corporate_id,
                 pd_trade_date,
                 'Phy Stock Unrlzd',
                 'after update' || vc_error_msg);
    --
    -- Insert into contract and price data for the contract items that are in pss
    --
    vc_error_msg := '25';
    update psu_phy_stock_unrealized pss
       set (gmr_ref_no, origination_city_id, --
           origination_country_id, --
           destination_city_id, --
           destination_country_id, --
           origination_city, --
           origination_country, --
           destination_city, --
           destination_country, --
           warehouse_id, --
           warehouse_name, --
           shed_id, --
           shed_name, --
           product_id, --
           prod_base_unit_id, --
           prod_base_unit) = --
            (select gmr.gmr_ref_no,
                    gmr.origin_city_id,
                    gmr.origin_country_id,
                    gmr.destination_city_id,
                    gmr.destination_country_id,
                    cim_orig.city_name as origin_city_name,
                    cym_orig.country_name origin_country_name,
                    cim_dest.city_name as destination_city_name,
                    cym_dest.country_name destination_country_name,
                    gmr.warehouse_profile_id,
                    phd_gmr.companyname as warehouse_profile_name,
                    gmr.shed_id,
                    sld.storage_location_name,
                    pss.product_id,
                    pdm.base_quantity_unit,
                    qum.qty_unit
               from gmr_goods_movement_record   gmr,
                    pdm_productmaster           pdm,
                    phd_profileheaderdetails    phd_gmr,
                    sld_storage_location_detail sld,
                    cim_citymaster              cim_orig,
                    cym_countrymaster           cym_orig,
                    cim_citymaster              cim_dest,
                    cym_countrymaster           cym_dest,
                    qum_quantity_unit_master    qum
              where gmr.internal_gmr_ref_no = pss.internal_gmr_ref_no
                and pss.product_id = pdm.product_id
                and pdm.base_quantity_unit = qum.qty_unit_id
                and gmr.warehouse_profile_id = phd_gmr.profileid(+)
                and gmr.shed_id = sld.storage_loc_id(+)
                and gmr.origin_city_id = cim_orig.city_id(+)
                and gmr.origin_country_id = cym_orig.country_id(+)
                and gmr.destination_city_id = cim_dest.city_id(+)
                and gmr.destination_country_id = cym_dest.country_id(+)
                and pss.process_id = gmr.process_id
                and pss.process_id = pc_process_id)
     where pss.process_id = pc_process_id;
    --
    --
    --
    vc_error_msg := '26';
    update md_m2m_daily md
       set md.m2m_price_unit_weight = null
     where md.m2m_price_unit_weight = 1
       and md.process_id = pc_process_id;
    vc_error_msg := '27';
  exception
    when others then
      dbms_output.put_line('failed with ' || sqlerrm);
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure sp_stock_unreal_shipped_not_tt ',
                                                           'M2M-013',
                                                           ' Code:' ||
                                                           sqlcode ||
                                                           ' Message:' ||
                                                           sqlerrm || '- ' ||
                                                           vc_error_msg,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;
  procedure sp_stock_unreal_inventory_in(pc_corporate_id varchar2,
                                         pd_trade_date   date,
                                         pc_process_id   varchar2,
                                         pc_user_id      varchar2) as
    cursor cur_grd is
    -- Purchase Inventory In
      select 'Purchase' section_type,
             pcpd.profit_center_id profit_center,
             pc_process_id process_id,
             gmr.corporate_id,
             gmr.internal_gmr_ref_no,
             grd.internal_contract_item_ref_no,
             pcm.purchase_sales,
             grd.product_id,
             pdm.product_desc product_name,
             grd.origin_id,
             orm.origin_name,
             qat.quality_id,
             qat.quality_name,
             grd.container_no,
             grd.current_qty stock_qty,
             grd.qty_unit_id,
             gmr.qty_unit_id gmr_qty_unit_id,
             qum.qty_unit,
             grd.no_of_units,
             md.md_id,
             md.m2m_price_unit_id,
             md.net_m2m_price,
             md.m2m_price_unit_cur_id,
             md.m2m_price_unit_cur_code,
             md.m2m_price_unit_weight_unit_id,
             md.m2m_price_unit_weight_unit,
             nvl(md.m2m_price_unit_weight, 1) m2m_price_unit_weight,
             md.m2m_price_unit_cur_code || '/' ||
             decode(md.m2m_price_unit_weight,
                    1,
                    null,
                    md.m2m_price_unit_weight) ||
             md.m2m_price_unit_weight_unit m2m_price_unit_str,
             md.m2m_main_cur_id,
             md.m2m_main_cur_code,
             md.m2m_main_cur_decimals,
             md.main_currency_factor,
             md.settlement_cur_id,
             md.settlement_to_val_fx_rate,
             pd_trade_date payment_due_date,
             akc.base_cur_id as base_cur_id,
             akc.base_currency_name base_cur_code,
             grd.inventory_status,
             gsm.status shipment_status,
             (case
               when nvl(grd.is_afloat, 'N') = 'Y' and
                    nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                'Shipped NTT'
               when nvl(grd.is_afloat, 'N') = 'Y' and
                    nvl(grd.inventory_status, 'NA') = 'In' then
                'Shipped IN'
               when nvl(grd.is_afloat, 'N') = 'Y' and
                    nvl(grd.inventory_status, 'NA') = 'Out' then
                'Shipped TT'
               when nvl(grd.is_afloat, 'N') = 'N' and
                    nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                'Stock NTT'
               when nvl(grd.is_afloat, 'N') = 'N' and
                    nvl(grd.inventory_status, 'NA') = 'In' then
                'Stock IN'
               when nvl(grd.is_afloat, 'N') = 'N' and
                    nvl(grd.inventory_status, 'NA') = 'Out' then
                'Stock TT'
               else
                'Others'
             end) section_name,
             null price_basis,
             gmr.shed_id,
             gmr.destination_city_id,
             null price_fixation_status,
             pdm.base_quantity_unit base_qty_unit_id,
             pcpd.strategy_id,
             css.strategy_name,
             (ciqs.total_qty - nvl(ciqs.price_fixed_qty, 0)) unfxd_qty,
             ciqs.price_fixed_qty fxd_qty,
             md.valuation_exchange_id,
             md.valuation_month,
             md.derivative_def_id,
             nvl(gmr.is_voyage_gmr, 'N') is_voyage_gmr,
             gmr.contract_type gmr_contract_type,
             grd.internal_grd_ref_no internal_grd_dgrd_ref_no,
             grd.internal_stock_ref_no stock_ref_no,
             pcm.trader_id,
             (case
               when pcm.trader_id is not null then
                (select gab.firstname || ' ' || gab.lastname
                   from gab_globaladdressbook gab,
                        ak_corporate_user     aku
                  where gab.gabid = aku.gabid
                    and aku.user_id = pcm.trader_id)
               else
                ''
             end) trader_user_name,
             md.m2m_loc_incoterm_deviation,
             md.m2m_quality_premium,
             md.m2m_product_premium,
             md.base_price_unit_id_in_ppu,
             md.base_price_unit_id_in_pum,
             nvl(md.m2m_loc_incoterm_deviation, 0) +
             nvl(md.m2m_quality_premium, 0) +
             nvl(md.m2m_product_premium, 0) total_premium,
             qat.eval_basis,
             invm.material_cost_per_unit,
             invm.secondary_cost_per_unit,
             invm.product_premium_per_unit,
             invm.quality_premium_per_unit,
             invm.price_unit_id cog_price_unit_id,
             invm.price_unit_cur_id cog_price_unit_cur_id,
             invm.price_unit_cur_code cog_price_unit_cur_code,
             invm.price_unit_weight_unit_id cog_price_unit_weight_unit_id,
             invm.price_unit_weight_unit cog_price_unit_weight_unit,
             invm.price_unit_weight cog_price_unit_weight,
             null invm_inventory_status,
             gmr.vessel_name,
             decode(grd.partnership_type, 'Consignment', 'Y', 'N') as is_marked_for_consignment,
             md.m2m_pp_fw_exch_rate,
             md.m2m_ld_fw_exch_rate,
             md.m2m_qp_fw_exch_rate,
             invm.price_to_base_fw_exch_rate,
             invm.contract_qp_fw_exch_rate,
             invm.contract_pp_fw_exch_rate,
             invm.accrual_to_base_fw_exch_rate,
             invm.price_to_base_fw_exch_rate_act
        from gmr_goods_movement_record gmr,
             grd_goods_record_detail grd,
             pcm_physical_contract_main pcm,
             pcpd_pc_product_definition pcpd,
             pdm_productmaster pdm,
             orm_origin_master orm,
             qat_quality_attributes qat,
             qum_quantity_unit_master qum,
             (select md1.*
                from md_m2m_daily md1
               where md1.rate_type <> 'OPEN'
                 and md1.corporate_id = pc_corporate_id
                 and md1.product_type = 'BASEMETAL'
                 and md1.process_id = pc_process_id) md,
             (select tmp.*
                from tmpc_temp_m2m_pre_check tmp
               where tmp.corporate_id = pc_corporate_id
                 and tmp.product_type = 'BASEMETAL'
                 and tmp.section_name <> 'OPEN') tmpc,
             ak_corporate akc,
             cm_currency_master cm,
             gsm_gmr_stauts_master gsm,
             pci_physical_contract_item pci,
             pcdi_pc_delivery_item pcdi,
             ciqs_contract_item_qty_status ciqs,
             css_corporate_strategy_setup css,
             invm_cog invm
       where grd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
         and gmr.internal_contract_ref_no = pcm.internal_contract_ref_no
         and pcm.internal_contract_ref_no = pcpd.internal_contract_ref_no
         and grd.product_id = pdm.product_id
         and grd.origin_id = orm.origin_id(+)
         and grd.internal_gmr_ref_no = tmpc.internal_gmr_ref_no(+)
         and grd.internal_grd_ref_no = tmpc.internal_grd_ref_no(+)
         and grd.internal_contract_item_ref_no =
             tmpc.internal_contract_item_ref_no(+)
         and tmpc.quality_id = qat.quality_id(+)
         and grd.qty_unit_id = qum.qty_unit_id(+)
         and tmpc.internal_m2m_id = md.md_id(+)
         and grd.internal_contract_item_ref_no =
             pci.internal_contract_item_ref_no
         and grd.process_id = pci.process_id
         and pci.pcdi_id = pcdi.pcdi_id
         and pcdi.process_id = pc_process_id
         and pcdi.internal_contract_ref_no = pcm.internal_contract_ref_no
         and grd.internal_contract_item_ref_no =
             ciqs.internal_contract_item_ref_no
         and grd.internal_contract_item_ref_no =
             pci.internal_contract_item_ref_no
         and gmr.corporate_id = akc.corporate_id
         and akc.base_cur_id = cm.cur_id
         and gmr.status_id = gsm.status_id(+)
         and pcpd.strategy_id = css.strategy_id
         and grd.process_id = pc_process_id
         and gmr.process_id = pc_process_id
         and pcpd.process_id = pc_process_id
         and ciqs.process_id = pc_process_id
         and pcm.process_id = pc_process_id
         and pci.process_id = pc_process_id
         and pcm.contract_status = 'In Position'
         and pcm.contract_type = 'BASEMETAL'
         and pcm.is_active = 'Y'
         and pci.is_active = 'Y'
         and gmr.corporate_id = pc_corporate_id
         and grd.status = 'Active'
         and grd.is_deleted = 'N'
         and gmr.is_deleted = 'N'
         and nvl(grd.inventory_status, 'NA') = 'In'
         and pcm.purchase_sales = 'P'
         and nvl(grd.current_qty, 0) > 0
         and gmr.is_internal_movement = 'N'
         and grd.internal_grd_ref_no = invm.internal_grd_ref_no
         and grd.process_id = invm.process_id
      union all
      -- Internal Movement Inventory In
      select 'Internal Movement' section_type,
             null profit_center, --get it FROM grd
             pc_process_id process_id,
             gmr.corporate_id,
             gmr.internal_gmr_ref_no,
             grd.internal_contract_item_ref_no,
             decode(gmr.contract_type, 'Purchase', 'P', 'S') purchase_sales,
             grd.product_id,
             pdm.product_desc product_name,
             grd.origin_id,
             orm.origin_name,
             qat.quality_id,
             qat.quality_name,
             grd.container_no,
             grd.current_qty stock_qty,
             grd.qty_unit_id,
             gmr.qty_unit_id gmr_qty_unit_id,
             qum.qty_unit,
             grd.no_of_units,
             md.md_id,
             md.m2m_price_unit_id,
             md.net_m2m_price,
             md.m2m_price_unit_cur_id,
             md.m2m_price_unit_cur_code,
             md.m2m_price_unit_weight_unit_id,
             md.m2m_price_unit_weight_unit,
             nvl(md.m2m_price_unit_weight, 1) m2m_price_unit_weight,
             md.m2m_price_unit_cur_code || '/' ||
             decode(md.m2m_price_unit_weight,
                    1,
                    null,
                    md.m2m_price_unit_weight) ||
             md.m2m_price_unit_weight_unit m2m_price_unit_str,
             md.m2m_main_cur_id,
             md.m2m_main_cur_code,
             md.m2m_main_cur_decimals,
             md.main_currency_factor,
             md.settlement_cur_id,
             md.settlement_to_val_fx_rate,
             pd_trade_date payment_due_date,
             akc.base_cur_id as base_cur_id,
             akc.base_currency_name base_cur_code,
             grd.inventory_status,
             gsm.status shipment_status,
             (case
               when nvl(grd.is_afloat, 'N') = 'Y' and
                    nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                'Shipped NTT'
               when nvl(grd.is_afloat, 'N') = 'Y' and
                    nvl(grd.inventory_status, 'NA') = 'In' then
                'Shipped IN'
               when nvl(grd.is_afloat, 'N') = 'Y' and
                    nvl(grd.inventory_status, 'NA') = 'Out' then
                'Shipped TT'
               when nvl(grd.is_afloat, 'N') = 'N' and
                    nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                'Stock NTT'
               when nvl(grd.is_afloat, 'N') = 'N' and
                    nvl(grd.inventory_status, 'NA') = 'In' then
                'Stock IN'
               when nvl(grd.is_afloat, 'N') = 'N' and
                    nvl(grd.inventory_status, 'NA') = 'Out' then
                'Stock TT'
               else
                'Others'
             end) section_name,
             null price_basis,
             gmr.shed_id,
             gmr.destination_city_id,
             null price_fixation_status,
             pdm.base_quantity_unit base_qty_unit_id,
             css.strategy_id strategy_id,
             css.strategy_name strategy_name,
             null unfxd_qty,
             null fxd_qty,
             md.valuation_exchange_id,
             md.valuation_month,
             md.derivative_def_id,
             nvl(gmr.is_voyage_gmr, 'N') is_voyage_gmr,
             gmr.contract_type gmr_contract_type,
             grd.internal_grd_ref_no internal_grd_dgrd_ref_no,
             grd.internal_stock_ref_no stock_ref_no,
             gmr.created_by trader_id,
             (case
               when gmr.created_by is not null then
                (select gab.firstname || ' ' || gab.lastname
                   from gab_globaladdressbook gab,
                        ak_corporate_user     aku
                  where gab.gabid = aku.gabid
                    and aku.user_id = gmr.created_by)
               else
                ''
             end) trader_user_name,
             md.m2m_loc_incoterm_deviation,
             md.m2m_quality_premium,
             md.m2m_product_premium,
             md.base_price_unit_id_in_ppu,
             md.base_price_unit_id_in_pum,
             nvl(md.m2m_loc_incoterm_deviation, 0) +
             nvl(md.m2m_quality_premium, 0) +
             nvl(md.m2m_product_premium, 0) total_premium,
             qat.eval_basis,
             invm.material_cost_per_unit,
             invm.secondary_cost_per_unit,
             invm.product_premium_per_unit,
             invm.quality_premium_per_unit,
             invm.price_unit_id cog_price_unit_id,
             invm.price_unit_cur_id cog_price_unit_cur_id,
             invm.price_unit_cur_code cog_price_unit_cur_code,
             invm.price_unit_weight_unit_id cog_price_unit_weight_unit_id,
             invm.price_unit_weight_unit cog_price_unit_weight_unit,
             invm.price_unit_weight cog_price_unit_weight,
             null, -- invm.inv_status invm_inventory_status,
             gmr.vessel_name,
             decode(grd.partnership_type, 'Consignment', 'Y', 'N') as is_marked_for_consignment,
             md.m2m_pp_fw_exch_rate,
             md.m2m_ld_fw_exch_rate,
             md.m2m_qp_fw_exch_rate,
             invm.price_to_base_fw_exch_rate,
             invm.contract_qp_fw_exch_rate,
             invm.contract_pp_fw_exch_rate,
             invm.accrual_to_base_fw_exch_rate,
             invm.price_to_base_fw_exch_rate_act
        from gmr_goods_movement_record gmr,
             grd_goods_record_detail grd,
             pdm_productmaster pdm,
             orm_origin_master orm,
             qum_quantity_unit_master qum,
             qat_quality_attributes qat,
             ak_corporate akc,
             cm_currency_master cm,
             gsm_gmr_stauts_master gsm,
             (select md1.*
                from md_m2m_daily md1
               where md1.rate_type <> 'OPEN'
                 and md1.corporate_id = pc_corporate_id
                 and md1.product_type = 'BASEMETAL'
                 and md1.process_id = pc_process_id) md,
             (select tmp.*
                from tmpc_temp_m2m_pre_check tmp
               where tmp.corporate_id = pc_corporate_id
                 and tmp.product_type = 'BASEMETAL'
                 and tmp.section_name <> 'OPEN') tmpc,
             invm_cog invm,
             css_corporate_strategy_setup css
       where grd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
         and grd.product_id = pdm.product_id
         and grd.origin_id = orm.origin_id(+)
         and grd.qty_unit_id = qum.qty_unit_id(+)
         and grd.internal_gmr_ref_no = tmpc.internal_gmr_ref_no(+)
         and grd.internal_grd_ref_no = tmpc.internal_grd_ref_no(+)
         and tmpc.quality_id = qat.quality_id(+)
         and tmpc.internal_m2m_id = md.md_id(+)
         and gmr.corporate_id = akc.corporate_id
         and akc.base_cur_id = cm.cur_id
         and gmr.status_id = gsm.status_id(+)
         and grd.process_id = pc_process_id
         and gmr.process_id = pc_process_id
         and gmr.corporate_id = pc_corporate_id
         and grd.status = 'Active'
         and grd.is_deleted = 'N'
         and gmr.is_deleted = 'N'
         and nvl(grd.inventory_status, 'NA') = 'In'
         and nvl(grd.current_qty, 0) > 0
         and gmr.is_internal_movement = 'Y'
         and grd.internal_grd_ref_no = invm.internal_grd_ref_no
         and grd.process_id = invm.process_id
         and grd.strategy_id = css.strategy_id(+);
    vn_qty_in_base                 number;
    vn_m2m_amt                     number;
    vc_m2m_cur_id                  varchar2(15);
    vc_m2m_cur_code                varchar2(15);
    vn_m2m_sub_cur_id_factor       number;
    vn_m2m_cur_decimals            number;
    vc_price_cur_id                varchar2(15);
    vc_price_cur_code              varchar2(15);
    vn_cont_price_cur_id_factor    number;
    vn_contract_value_in_price_cur number;
    vn_cont_price_cur_decimals     number;
    vn_contract_value_in_val_cur   number;
    vn_contract_value_in_base_cur  number;
    vc_m2m_price_unit_str          varchar2(100);
    vc_m2m_price_unit_id           varchar2(15);
    vc_m2m_price_unit_cur_id       varchar2(15);
    vn_ratio                       number;
    vn_corp_rate_val_to_base_cur   number;
    vn_spot_rate_base_to_val_cur   number;
    vn_expected_cog_net_sale_value number;
    vn_expected_cog_in_val_cur     number;
    vn_pnl_in_val_cur              number;
    vn_pnl_in_base_cur             number;
    vn_pnl_per_base_unit           number;
    vc_psu_id                      varchar2(500);
    vn_pnl_in_exch_price_unit      number;
    vobj_error_log                 tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count             number := 1;
    vn_m2m_base_fx_rate            number;
    vn_m2m_base_deviation          number;
    vn_m2m_amount_in_base          number;
    vn_m2m_total_amount            number;
    vn_m2m_total_premium_amt       number;
    vn_total_premium_value         number;
    vn_quality_premium_amt         number;
    vn_product_premium_amt         number;
    vc_base_price_unit_id          varchar2(20);
    vn_m2m_amt_per_unit            number;
    vn_cont_price                  number;
    vc_cont_price_unit_id          varchar2(15);
    vc_cont_price_unit_cur_id      varchar2(15);
    vc_cont_price_unit_cur_code    varchar2(15);
    vn_cont_price_wt               number;
    vc_cont_price_wt_unit_id       varchar2(15);
    vc_cont_price_wt_unit          varchar2(15);
    vn_sc_in_base_cur              number;
    vc_price_fixation_status       varchar2(50);
    vc_error_msg                   varchar2(100);
    vn_trade_day_pnl_per_base_unit number;
    -- All variable for exchange rate string start
    vc_price_to_base_fw_rate    varchar2(100);
    vc_m2m_to_base_fw_rate      varchar2(100);
    vc_m2m_ld_fw_exch_rate      varchar2(100);
    vc_m2m_qp_fw_exch_rate      varchar2(100);
    vc_m2m_pp_fw_exch_rate      varchar2(100);
    vc_contract_qp_fw_exch_rate varchar2(100);
    vc_contract_pp_fw_exch_rate varchar2(100);
    vc_sc_fw_exch_rate          varchar2(100);
    -- All variable for exchange rate string end 
  begin
    for cur_grd_rows in cur_grd
    loop
      vc_sc_fw_exch_rate            := cur_grd_rows.accrual_to_base_fw_exch_rate;
      vc_m2m_ld_fw_exch_rate        := cur_grd_rows.m2m_ld_fw_exch_rate;
      vc_m2m_qp_fw_exch_rate        := cur_grd_rows.m2m_qp_fw_exch_rate;
      vc_m2m_pp_fw_exch_rate        := cur_grd_rows.m2m_pp_fw_exch_rate;
      vc_contract_qp_fw_exch_rate   := cur_grd_rows.contract_qp_fw_exch_rate;
      vc_contract_pp_fw_exch_rate   := cur_grd_rows.contract_pp_fw_exch_rate;
      vc_price_to_base_fw_rate      := cur_grd_rows.price_to_base_fw_exch_rate;
      vn_product_premium_amt        := 0;
      vn_quality_premium_amt        := 0;
      vn_contract_value_in_base_cur := 0;
      vn_total_premium_value        := 0;
      vn_cont_price                 := 0;
      vc_cont_price_unit_id         := null;
      vc_cont_price_unit_cur_id     := null;
      vc_cont_price_unit_cur_code   := null;
      vn_cont_price_wt              := 1;
      vc_cont_price_wt_unit_id      := null;
      vc_cont_price_wt_unit         := null;
      vc_price_fixation_status      := null;
      vn_cont_price                 := cur_grd_rows.material_cost_per_unit;
      vc_cont_price_unit_id         := cur_grd_rows.cog_price_unit_id;
      vc_cont_price_unit_cur_id     := cur_grd_rows.cog_price_unit_cur_id;
      vc_cont_price_unit_cur_code   := cur_grd_rows.cog_price_unit_cur_code;
      vn_cont_price_wt              := cur_grd_rows.cog_price_unit_weight;
      vc_cont_price_wt_unit_id      := cur_grd_rows.cog_price_unit_weight_unit_id;
      vc_cont_price_wt_unit         := cur_grd_rows.cog_price_unit_weight_unit;
      vc_error_msg                  := vn_cont_price ||
                                       vc_cont_price_unit_id;
      if cur_grd_rows.stock_qty <> 0 then
        vc_psu_id    := cur_grd_rows.internal_gmr_ref_no || '-' ||
                        cur_grd_rows.internal_grd_dgrd_ref_no || '-' ||
                        cur_grd_rows.internal_contract_item_ref_no || '-' ||
                        cur_grd_rows.container_no;
        vc_error_msg := '1';
        if cur_grd_rows.qty_unit_id <> cur_grd_rows.base_qty_unit_id then
          vn_qty_in_base := cur_grd_rows.stock_qty *
                            pkg_general.f_get_converted_quantity(cur_grd_rows.product_id,
                                                                 cur_grd_rows.qty_unit_id,
                                                                 cur_grd_rows.base_qty_unit_id,
                                                                 1);
        else
          vn_qty_in_base := cur_grd_rows.stock_qty;
        end if;
        vc_error_msg := '2';
        if cur_grd_rows.eval_basis = 'FIXED' then
          vn_m2m_amt               := 0;
          vc_m2m_price_unit_cur_id := cur_grd_rows.base_cur_id;
        else
          vc_m2m_price_unit_cur_id := nvl(cur_grd_rows.m2m_price_unit_cur_id,
                                          cur_grd_rows.base_cur_id);
          vn_m2m_amt               := nvl(cur_grd_rows.net_m2m_price, 0) /
                                      nvl(cur_grd_rows.m2m_price_unit_weight,
                                          1) *
                                      pkg_general.f_get_converted_quantity(cur_grd_rows.product_id,
                                                                           cur_grd_rows.qty_unit_id,
                                                                           cur_grd_rows.m2m_price_unit_weight_unit_id,
                                                                           cur_grd_rows.stock_qty);
        end if;
        vc_error_msg := '3';
        pkg_general.sp_get_main_cur_detail(nvl(vc_m2m_price_unit_cur_id,
                                               cur_grd_rows.base_cur_id),
                                           vc_m2m_cur_id,
                                           vc_m2m_cur_code,
                                           vn_m2m_sub_cur_id_factor,
                                           vn_m2m_cur_decimals);
        vn_m2m_amt   := round(vn_m2m_amt * vn_m2m_sub_cur_id_factor, 2);
        vc_error_msg := '4';
        if cur_grd_rows.eval_basis <> 'FIXED' then
          --
          -- Forwad Rate from Valuation to Base Currency
          --
          pkg_general.sp_forward_cur_exchange_new(cur_grd_rows.corporate_id,
                                                  pd_trade_date,
                                                  cur_grd_rows.payment_due_date,
                                                  nvl(vc_m2m_cur_id,
                                                      cur_grd_rows.base_cur_id),
                                                  cur_grd_rows.base_cur_id,
                                                  30,
                                                  vn_m2m_base_fx_rate,
                                                  vn_m2m_base_deviation);
          vc_error_msg := '5';
        
          if vc_m2m_cur_id <> cur_grd_rows.base_cur_id then
            if vn_m2m_base_fx_rate is null or vn_m2m_base_fx_rate = 0 then
              vobj_error_log.extend;
              vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                   'procedure pkg_phy_physical_process-sp_calc_phy_open_unrealized ',
                                                                   'PHY-005',
                                                                   vc_m2m_cur_code ||
                                                                   ' to ' ||
                                                                   cur_grd_rows.base_cur_code || ' (' ||
                                                                   to_char(cur_grd_rows.payment_due_date,
                                                                           'dd-Mon-yyyy') || ') ',
                                                                   '',
                                                                   gvc_process,
                                                                   pc_user_id,
                                                                   sysdate,
                                                                   pd_trade_date);
              sp_insert_error_log(vobj_error_log);
            else
              vc_m2m_to_base_fw_rate := '1 ' || vc_m2m_cur_code || '=' ||
                                        vn_m2m_base_fx_rate || ' ' ||
                                        cur_grd_rows.base_cur_code;
            
            end if;
          end if;
        else
          vn_m2m_base_fx_rate := 1;
        end if;
        vn_m2m_amount_in_base    := vn_m2m_amt * vn_m2m_base_fx_rate;
        vn_m2m_total_premium_amt := vn_qty_in_base *
                                    cur_grd_rows.total_premium;
        vn_m2m_total_amount      := vn_m2m_amount_in_base +
                                    vn_m2m_total_premium_amt;
        vc_error_msg             := '6';
        vn_m2m_amt_per_unit      := round(vn_m2m_total_amount /
                                          vn_qty_in_base,
                                          8);
        pkg_general.sp_get_main_cur_detail(nvl(vc_cont_price_unit_cur_id,
                                               cur_grd_rows.base_cur_id),
                                           vc_price_cur_id,
                                           vc_price_cur_code,
                                           vn_cont_price_cur_id_factor,
                                           vn_cont_price_cur_decimals);
        vc_error_msg := '7';
      
        vc_error_msg                   := '8';
        vn_contract_value_in_price_cur := vn_cont_price *
                                          (pkg_general.f_get_converted_quantity(cur_grd_rows.product_id,
                                                                                cur_grd_rows.qty_unit_id,
                                                                                vc_cont_price_wt_unit_id,
                                                                                cur_grd_rows.stock_qty));
      
        vc_error_msg := '9';
      
        --
        -- Contract Value in Base Currency
        --
        vn_contract_value_in_base_cur := round((vn_cont_price *
                                               vn_qty_in_base),
                                               2);
      
      end if;
      vc_error_msg          := '10';
      vc_m2m_price_unit_str := cur_grd_rows.m2m_price_unit_str;
      vc_m2m_price_unit_id  := cur_grd_rows.m2m_price_unit_id;
      begin
        select ppu.product_price_unit_id
          into vc_base_price_unit_id
          from v_ppu_pum ppu
         where ppu.cur_id = cur_grd_rows.base_cur_id
           and ppu.weight_unit_id = cur_grd_rows.base_qty_unit_id
           and nvl(ppu.weight, 1) = 1
           and ppu.product_id = cur_grd_rows.product_id;
      exception
        when others then
          sp_write_log(pc_corporate_id,
                       pd_trade_date,
                       'sp_open_phy_unreal',
                       'vc_base_price_unit' || vc_base_price_unit_id ||
                       ' For' || cur_grd_rows.internal_contract_item_ref_no);
      end;
      vc_error_msg := '11';
      --
      -- Quality Premium Amount in Base
      --
      vn_quality_premium_amt := cur_grd_rows.quality_premium_per_unit *
                                vn_qty_in_base;
      vc_error_msg           := '12';
      --
      -- Product Premium Amount in Base
      --
      vn_product_premium_amt := cur_grd_rows.product_premium_per_unit *
                                vn_qty_in_base;
    
      vc_error_msg           := '13';
      vn_total_premium_value := round((vn_quality_premium_amt +
                                      vn_product_premium_amt),
                                      2);
      --
      -- Secondary Cost in Base
      --                                               
      vn_sc_in_base_cur := cur_grd_rows.secondary_cost_per_unit *
                           vn_qty_in_base;
    
      --------------------------------------------------------------------------
      vc_error_msg               := '14';
      vn_expected_cog_in_val_cur := round(vn_contract_value_in_base_cur, 2);
    
      --
      -- Total COG = Contract Value (Qty*Price) + Quality Premium + Delivery Premium + Secondary Cost
      --
    
      vn_expected_cog_in_val_cur := vn_expected_cog_in_val_cur +
                                    vn_total_premium_value +
                                    abs(vn_sc_in_base_cur);
    
      if cur_grd_rows.purchase_sales = 'P' then
        vn_contract_value_in_val_cur := (-1) * vn_contract_value_in_val_cur;
        vn_expected_cog_in_val_cur   := (-1) * vn_expected_cog_in_val_cur;
      else
        vn_contract_value_in_val_cur := vn_contract_value_in_val_cur;
        vn_expected_cog_in_val_cur   := vn_expected_cog_in_val_cur;
      end if;
      vn_expected_cog_net_sale_value := round(vn_expected_cog_in_val_cur, 2);
      if cur_grd_rows.purchase_sales = 'P' then
        vn_pnl_in_val_cur := (vn_m2m_total_amount -
                             (nvl(vn_expected_cog_in_val_cur, 0) * (-1)));
      else
        vn_pnl_in_val_cur := (nvl(vn_expected_cog_in_val_cur, 0) -
                             vn_m2m_total_amount);
      end if;
      vc_error_msg              := '15';
      vn_pnl_in_val_cur         := round(vn_pnl_in_val_cur, 2);
      vn_pnl_in_base_cur        := round(vn_pnl_in_val_cur, 2);
      vn_pnl_per_base_unit      := round(vn_pnl_in_base_cur /
                                         nvl(vn_qty_in_base, 1),
                                         5);
      vc_error_msg              := '16';
      vn_pnl_in_exch_price_unit := 0;
    
      vn_trade_day_pnl_per_base_unit := vn_pnl_in_base_cur / vn_qty_in_base;
    
      insert into psu_phy_stock_unrealized
        (process_id,
         psu_id,
         corporate_id,
         internal_gmr_ref_no,
         internal_contract_item_ref_no,
         product_id,
         product_name,
         origin_id,
         origin_name,
         quality_id,
         quality_name,
         container_no,
         stock_qty,
         qty_unit_id,
         qty_unit,
         no_of_units,
         md_id,
         m2m_price_unit_id,
         m2m_price_unit_str,
         m2m_amt,
         m2m_amt_cur_id,
         m2m_amt_cur_code,
         contract_value_in_price_cur,
         contract_price_cur_id,
         contract_price_cur_code,
         material_cost_in_base_cur,
         material_cost_in_val_cur,
         sc_in_base_cur,
         sc_in_valuation_cur,
         expected_cog_in_base_cur,
         expected_cog_in_val_cur,
         pnl_type,
         pnl_in_base_cur,
         pnl_in_val_cur,
         prev_day_pnl_in_base_cur,
         prev_day_pnl_in_val_cur,
         trade_day_pnl_in_base_cur,
         trade_day_pnl_in_val_cur,
         pnl_in_exch_price_unit,
         prev_pnl_in_exch_price_unit,
         day_pnl_in_exch_price_unit,
         pnl_per_base_unit,
         trade_day_pnl_per_base_unit,
         fw_fx_price_cur_to_m2m_cur,
         fw_fx_base_cur_to_m2m_cur,
         spot_rate_m2m_cur_to_base_cur,
         base_cur_id,
         base_cur_code,
         inventory_status,
         shipment_status,
         section_name,
         base_price_unit_id,
         qty_in_base_unit,
         m2m_price_unit_cur_id,
         m2m_price_unit_cur_code,
         m2m_price_unit_qty_unit_id,
         m2m_price_unit_qty_unit,
         m2m_price_unit_qty_unit_weight,
         spot_price_cur_to_base_cur,
         invm_inventory_status,
         strategy_id,
         strategy_name,
         valuation_month,
         contract_type,
         profit_center_id,
         net_m2m_price,
         unfxd_qty,
         fxd_qty,
         valuation_exchange_id,
         derivative_def_id,
         price_to_val_rate,
         val_to_base_rate,
         base_to_val_rate,
         sec_cost_ratio,
         gmr_contract_type,
         is_voyage_gmr,
         sc_to_val_fx_rate,
         sc_to_val_fx_rate_cur_id,
         sc_to_val_fx_rate_cur_code,
         int_alloc_group_id,
         internal_grd_dgrd_ref_no,
         vessel_id,
         charter_voyage_id,
         vessel_voyage_name,
         price_type_id,
         price_type_name,
         price_string,
         item_delivery_period_string,
         fixation_method,
         price_fixation_details,
         contract_price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         price_unit_weight_unit_id,
         price_unit_weight,
         price_unit_weight_unit,
         voyage_ref_no,
         stock_ref_no,
         trader_name,
         trader_id,
         unreal_pnl_in_base_per_unit,
         unreal_pnl_in_val_cur_per_unit,
         contract_premium_value,
         m2m_quality_premium,
         m2m_product_premium,
         m2m_loc_diff_premium,
         base_price_unit_id_in_ppu,
         base_price_unit_id_in_pum,
         market_premimum_amt,
         m2m_amt_per_unit,
         is_marked_for_consignment,
         price_to_base_fw_exch_rate,
         m2m_to_base_fw_exch_rate,
         m2m_ld_fw_exch_rate,
         m2m_qp_fw_exch_rate,
         m2m_pp_fw_exch_rate,
         contract_qp_fw_exch_rate,
         contract_pp_fw_exch_rate,
         accrual_to_base_fw_exch_rate)
      values
        (pc_process_id,
         vc_psu_id,
         pc_corporate_id,
         cur_grd_rows.internal_gmr_ref_no,
         cur_grd_rows.internal_contract_item_ref_no,
         cur_grd_rows.product_id,
         cur_grd_rows.product_name,
         cur_grd_rows.origin_id,
         cur_grd_rows.origin_name,
         cur_grd_rows.quality_id,
         cur_grd_rows.quality_name,
         cur_grd_rows.container_no,
         cur_grd_rows.stock_qty,
         cur_grd_rows.qty_unit_id,
         cur_grd_rows.qty_unit,
         cur_grd_rows.no_of_units,
         cur_grd_rows.md_id,
         vc_m2m_price_unit_id,
         vc_m2m_price_unit_str,
         vn_m2m_total_amount,
         cur_grd_rows.base_cur_id,
         cur_grd_rows.base_cur_code,
         vn_contract_value_in_price_cur,
         vc_price_cur_id,
         vc_price_cur_code,
         vn_contract_value_in_base_cur,
         vn_contract_value_in_base_cur,
         vn_sc_in_base_cur,
         vn_sc_in_base_cur,
         vn_expected_cog_net_sale_value,
         vn_expected_cog_in_val_cur,
         'Unrealized',
         vn_pnl_in_base_cur,
         vn_pnl_in_val_cur,
         null, -- prev_day_pnl_in_base_cur
         null, -- prev_day_pnl_in_val_cur
         null, -- trade_day_pnl_in_base_cur
         null, --  trade_day_pnl_in_val_cur
         vn_pnl_in_exch_price_unit,
         null, --   prev_pnl_in_exch_price_unit
         null, --  day_pnl_in_exch_price_unit
         vn_pnl_per_base_unit, --  v_pnl_per_base_unit
         vn_trade_day_pnl_per_base_unit,
         null, --fw_fx_price_cur_to_m2m_cur
         null, --fw_fx_base_cur_to_m2m_cur
         vn_corp_rate_val_to_base_cur,
         cur_grd_rows.base_cur_id,
         cur_grd_rows.base_cur_code,
         cur_grd_rows.inventory_status,
         cur_grd_rows.shipment_status,
         cur_grd_rows.section_name,
         vc_base_price_unit_id,
         vn_qty_in_base,
         cur_grd_rows.m2m_price_unit_cur_id, --   vc_m2m_price_unit_cur_id,
         cur_grd_rows.m2m_price_unit_cur_code, -- vc_m2m_price_unit_cur_code,
         cur_grd_rows.m2m_price_unit_weight_unit_id, -- vc_m2m_price_unit_qty_unit_id,
         cur_grd_rows.m2m_price_unit_weight_unit, --vc_m2m_price_unit_qty_unit,
         cur_grd_rows.m2m_price_unit_weight, --vn_m2m_price_unit_qty_unit_wt,
         null, --vn_fx_price_to_base, --vn_corp_rate_price_to_base_cur,
         cur_grd_rows.invm_inventory_status,
         cur_grd_rows.strategy_id,
         cur_grd_rows.strategy_name,
         cur_grd_rows.valuation_month,
         cur_grd_rows.purchase_sales,
         cur_grd_rows.profit_center,
         cur_grd_rows.net_m2m_price,
         cur_grd_rows.unfxd_qty,
         cur_grd_rows.fxd_qty,
         cur_grd_rows.valuation_exchange_id,
         cur_grd_rows.derivative_def_id,
         null, --vn_spot_rate_price_to_val_cur,
         vn_m2m_base_fx_rate, --vn_corp_rate_val_to_base_cur,
         null, --vn_spot_rate_base_to_val_cur,
         vn_ratio,
         cur_grd_rows.gmr_contract_type,
         cur_grd_rows.is_voyage_gmr,
         vn_spot_rate_base_to_val_cur,
         null, --sc_to_val_fx_rate_cur_id
         null, --sc_to_val_fx_rate_cur_code
         null, -- cur_grd_rows.int_alloc_group_id,
         cur_grd_rows.internal_grd_dgrd_ref_no,
         null, --cur_grd_rows.vessel_id,
         null, --cur_grd_rows.voyage_number,
         cur_grd_rows.vessel_name,
         null, -- cur_grd_rows.price_basis,
         null, --cur_grd_rows.price_type_name,
         null, --vc_price_string,
         null, -- cur_grd_rows.item_delivery_period_string
         null, -- vc_price_fixation_status,
         null, -- cur_grd_rows.price_fixation_details,
         vn_cont_price,
         vc_cont_price_unit_id,
         vc_cont_price_unit_cur_id,
         vc_cont_price_unit_cur_code,
         vc_cont_price_wt_unit_id,
         vn_cont_price_wt,
         vc_cont_price_wt_unit,
         null, --cur_grd_rows.voyage_ref_no,
         cur_grd_rows.stock_ref_no,
         cur_grd_rows.trader_user_name,
         cur_grd_rows.trader_id,
         vn_pnl_in_base_cur / decode(vn_qty_in_base, 0, 1, vn_qty_in_base),
         vn_pnl_in_val_cur / decode(vn_qty_in_base, 0, 1, vn_qty_in_base),
         vn_total_premium_value,
         cur_grd_rows.m2m_quality_premium,
         cur_grd_rows.m2m_product_premium,
         cur_grd_rows.m2m_loc_incoterm_deviation,
         cur_grd_rows.base_price_unit_id_in_ppu,
         cur_grd_rows.base_price_unit_id_in_pum,
         vn_m2m_total_premium_amt,
         vn_m2m_amt_per_unit,
         cur_grd_rows.is_marked_for_consignment,
         vc_price_to_base_fw_rate,
         vc_m2m_to_base_fw_rate,
         vc_m2m_ld_fw_exch_rate,
         vc_m2m_qp_fw_exch_rate,
         vc_m2m_pp_fw_exch_rate,
         vc_contract_qp_fw_exch_rate,
         vc_contract_pp_fw_exch_rate,
         cur_grd_rows.accrual_to_base_fw_exch_rate);
    end loop;
    -----------
    vc_error_msg := '17';
    commit;
    sp_gather_stats('psu_phy_stock_unrealized');
    sp_gather_stats('pcm_physical_contract_main');
    sp_gather_stats('pci_physical_contract_item');
    sp_gather_stats('cipd_contract_item_price_daily');
    dbms_output.put_line('finsihed loop');
    vc_error_msg := '18';
    begin
      --
      -- update previous eod data
      --
      for cur_update in (select psu_prev_day.unreal_pnl_in_base_per_unit,
                                psu_prev_day.unreal_pnl_in_val_cur_per_unit,
                                psu_prev_day.pnl_in_exch_price_unit,
                                psu_prev_day.m2m_quality_premium,
                                psu_prev_day.m2m_product_premium,
                                psu_prev_day.m2m_loc_diff_premium,
                                psu_prev_day.market_premimum_amt,
                                psu_prev_day.net_m2m_price,
                                psu_prev_day.m2m_price_unit_id,
                                psu_prev_day.m2m_amt,
                                psu_prev_day.m2m_amt_cur_id,
                                psu_prev_day.m2m_amt_cur_code,
                                psu_prev_day.psu_id,
                                psu_prev_day.m2m_amt_per_unit,
                                psu_prev_day.prev_market_value,
                                psu_prev_day.m_pnl_in_base_cur
                           from psu_phy_stock_unrealized psu_prev_day
                          where process_id = gvc_previous_process_id
                            and corporate_id = pc_corporate_id)
      loop
        vc_error_msg := '19';
        update psu_phy_stock_unrealized psu_today
           set psu_today.prev_day_pnl_in_val_cur       = cur_update.unreal_pnl_in_val_cur_per_unit *
                                                         psu_today.qty_in_base_unit,
               psu_today.prev_day_pnl_in_base_cur      = cur_update.unreal_pnl_in_base_per_unit *
                                                         psu_today.qty_in_base_unit,
               psu_today.prev_pnl_in_exch_price_unit   = cur_update.pnl_in_exch_price_unit,
               psu_today.prev_m2m_quality_premium      = cur_update.m2m_quality_premium,
               psu_today.prev_m2m_product_premium      = cur_update.m2m_product_premium,
               psu_today.prev_m2m_loc_diff_premium     = cur_update.m2m_loc_diff_premium,
               psu_today.prev_market_premimum_amt      = cur_update.market_premimum_amt,
               psu_today.prev_market_price             = cur_update.net_m2m_price,
               psu_today.prev_market_price_unit_id     = cur_update.m2m_price_unit_id,
               psu_today.prev_market_value             = round(nvl(cur_update.m2m_amt_per_unit,
                                                                   0) *
                                                               psu_today.qty_in_base_unit,
                                                               4),
               psu_today.prev_market_value_cur_id      = cur_update.m2m_amt_cur_id,
               psu_today.prev_market_value_cur_code    = cur_update.m2m_amt_cur_code,
               psu_today.prev_m2m_amt_per_unit         = cur_update.m2m_amt_per_unit,
               psu_today.m_prev_day_pnl_in_base_cur    = (cur_update.m2m_amt -
                                                         cur_update.prev_market_value),
               psu_today.m_prev_day_pnl_in_val_cur     = (cur_update.m2m_amt -
                                                         cur_update.prev_market_value),
               psu_today.m_trade_day_pnl_per_base_unit = (psu_today.m_pnl_in_base_cur -
                                                         cur_update.m_pnl_in_base_cur) /
                                                         psu_today.qty_in_base_unit,
               psu_today.cont_unr_status               = 'EXISTING_TRADE'
         where psu_today.psu_id = cur_update.psu_id
           and psu_today.process_id = pc_process_id
           and psu_today.corporate_id = pc_corporate_id;
      end loop;
    exception
      when others then
        dbms_output.put_line('SQLERRM-1' || sqlerrm);
    end;
    vc_error_msg := '20';
    --
    -- mark the trades came as new in this eod/eom
    --
    begin
      update psu_phy_stock_unrealized psu
         set psu.prev_day_pnl_in_val_cur     = 0,
             psu.prev_day_pnl_in_base_cur    = 0,
             psu.prev_pnl_in_exch_price_unit = 0,
             psu.m_prev_day_pnl_in_base_cur  = 0,
             psu.m_prev_day_pnl_in_val_cur   = 0,
             psu.m_pnl_in_base_cur           = 0,
             psu.m_trade_day_pnl_in_base_cur = 0,
             psu.prev_m2m_quality_premium    = psu.m2m_quality_premium,
             psu.prev_m2m_product_premium    = psu.m2m_product_premium,
             psu.prev_m2m_loc_diff_premium   = psu.m2m_loc_diff_premium,
             psu.prev_market_premimum_amt    = psu.market_premimum_amt,
             psu.prev_market_price           = psu.net_m2m_price,
             psu.prev_market_price_unit_id   = psu.m2m_price_unit_id,
             psu.prev_market_value           = psu.m2m_amt,
             psu.prev_market_value_cur_id    = psu.m2m_amt_cur_id,
             psu.prev_market_value_cur_code  = psu.m2m_amt_cur_code,
             psu.prev_m2m_amt_per_unit       = psu.m2m_amt_per_unit,
             psu.cont_unr_status             = 'NEW_TRADE'
       where psu.cont_unr_status is null
         and psu.process_id = pc_process_id
         and psu.corporate_id = pc_corporate_id;
    exception
      when others then
        dbms_output.put_line('SQLERRM-2' || sqlerrm);
    end;
    vc_error_msg := '21';
    update psu_phy_stock_unrealized psu
       set psu.m_pnl_in_val_cur          = (psu.m2m_amt -
                                           psu.prev_market_value),
           psu.m_pnl_in_base_cur         = (psu.m2m_amt -
                                           psu.prev_market_value),
           psu.m_pnl_in_base_per_unit    = (psu.m2m_amt -
                                           psu.prev_market_value) /
                                           psu.qty_in_base_unit,
           psu.m_pnl_in_val_cur_per_unit = (psu.m2m_amt -
                                           psu.prev_market_value) /
                                           psu.qty_in_base_unit
     where psu.process_id = pc_process_id
       and psu.corporate_id = pc_corporate_id;
    --
    -- update trade day pnl values
    -- It is difference of unrealized pnl on trade date and previous eod For M2M PNL
    -- Else it is same as PNL as on Today
    -- 
    vc_error_msg := '22';
    sp_write_log(pc_corporate_id,
                 pd_trade_date,
                 'Phy Stock Unrlzd',
                 'after loop' || vc_error_msg);
    update psu_phy_stock_unrealized psu
       set m_trade_day_pnl_in_val_cur    = nvl(psu.m_pnl_in_val_cur, 0) -
                                           nvl(psu.m_prev_day_pnl_in_val_cur,
                                               0),
           m_trade_day_pnl_in_base_cur   = nvl(psu.m_pnl_in_base_cur, 0) -
                                           nvl(psu.m_prev_day_pnl_in_base_cur,
                                               0),
           psu.trade_day_pnl_in_base_cur = psu.pnl_in_base_cur -
                                           psu.prev_day_pnl_in_base_cur,
           psu.trade_day_pnl_in_val_cur  = psu.pnl_in_val_cur -
                                           psu.prev_day_pnl_in_val_cur
     where psu.process_id = pc_process_id;
    sp_write_log(pc_corporate_id,
                 pd_trade_date,
                 'Phy Stock Unrlzd',
                 'after update' || vc_error_msg);
    --
    -- Insert into contract and price data for the contract items that are in pss
    --
    vc_error_msg := '23';
    update psu_phy_stock_unrealized pss
       set (gmr_ref_no, origination_city_id, --
           origination_country_id, --
           destination_city_id, --
           destination_country_id, --
           origination_city, --
           origination_country, --
           destination_city, --
           destination_country, --
           warehouse_id, --
           warehouse_name, --
           shed_id, --
           shed_name, --
           product_id, --
           prod_base_unit_id, --
           prod_base_unit) = --
            (select gmr.gmr_ref_no,
                    gmr.origin_city_id,
                    gmr.origin_country_id,
                    gmr.destination_city_id,
                    gmr.destination_country_id,
                    cim_orig.city_name as origin_city_name,
                    cym_orig.country_name origin_country_name,
                    cim_dest.city_name as destination_city_name,
                    cym_dest.country_name destination_country_name,
                    gmr.warehouse_profile_id,
                    phd_gmr.companyname as warehouse_profile_name,
                    gmr.shed_id,
                    sld.storage_location_name,
                    pss.product_id,
                    pdm.base_quantity_unit,
                    qum.qty_unit
               from gmr_goods_movement_record   gmr,
                    pdm_productmaster           pdm,
                    phd_profileheaderdetails    phd_gmr,
                    sld_storage_location_detail sld,
                    cim_citymaster              cim_orig,
                    cym_countrymaster           cym_orig,
                    cim_citymaster              cim_dest,
                    cym_countrymaster           cym_dest,
                    qum_quantity_unit_master    qum
              where gmr.internal_gmr_ref_no = pss.internal_gmr_ref_no
                and pss.product_id = pdm.product_id
                and pdm.base_quantity_unit = qum.qty_unit_id
                and gmr.warehouse_profile_id = phd_gmr.profileid(+)
                and gmr.shed_id = sld.storage_loc_id(+)
                and gmr.origin_city_id = cim_orig.city_id(+)
                and gmr.origin_country_id = cym_orig.country_id(+)
                and gmr.destination_city_id = cim_dest.city_id(+)
                and gmr.destination_country_id = cym_dest.country_id(+)
                and pss.process_id = gmr.process_id
                and pss.process_id = pc_process_id)
     where pss.process_id = pc_process_id;
    --
    --
    --
    vc_error_msg := '24';
    update md_m2m_daily md
       set md.m2m_price_unit_weight = null
     where md.m2m_price_unit_weight = 1
       and md.process_id = pc_process_id;
    vc_error_msg := '25';
  exception
    when others then
      dbms_output.put_line('failed with ' || sqlerrm);
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure sp_stock_unreal_inventory_in ',
                                                           'M2M-013',
                                                           ' Code:' ||
                                                           sqlcode ||
                                                           ' Message:' ||
                                                           sqlerrm || '- ' ||
                                                           vc_error_msg,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;
  procedure sp_cal_phy_stok_con_unreal_pnl(pc_corporate_id varchar2,
                                           pd_trade_date   date,
                                           pc_process_id   varchar2,
                                           pc_user_id      varchar2) is
  
    cursor cur_grd is
      select tt.section_type,
             tt.profit_center,
             tt.profit_center_name,
             tt.profit_center_short_name,
             tt.process_id,
             tt.corporate_id,
             tt.corporate_name,
             tt.internal_gmr_ref_no,
             tt.internal_contract_item_ref_no,
             tt.del_distribution_item_no,
             tt.delivery_item_no,
             tt.contract_ref_no,
             tt.purchase_sales,
             tt.conc_product_id,
             tt.conc_product_name,
             tt.product_id,
             tt.product_name,
             tt.origin_id,
             tt.origin_name,
             tt.conc_quality_id,
             tt.conc_quality_name,
             tt.quality_id,
             tt.quality_name,
             tt.container_no,
             tt.stock_qty,
             tt.qty_unit_id,
             tt.gmr_qty_unit_id,
             tt.qty_unit,
             tt.stocky_qty_decimal,
             tt.no_of_units,
             tt.md_id,
             tt.m2m_price_unit_id,
             tt.net_m2m_price,
             tt.m2m_price_unit_cur_id,
             tt.m2m_price_unit_cur_code,
             tt.m2m_price_unit_weight_unit_id,
             tt.m2m_price_unit_weight_unit,
             tt.m2m_price_unit_weight,
             tt.m2m_price_unit_str,
             tt.m2m_main_cur_id,
             tt.m2m_main_cur_code,
             tt.m2m_main_cur_decimals,
             tt.main_currency_factor,
             tt.settlement_cur_id,
             tt.settlement_to_val_fx_rate,
             tt.element_id,
             tt.attribute_name,
             tt.assay_header_id,
             tt.assay_qty,
             tt.assay_qty_unit_id,
             tt.payable_qty,
             tt.payable_qty_unit_id,
             tt.payable_qty_unit,
             tt.contract_price,
             tt.price_unit_id,
             tt.price_unit_weight_unit_id,
             tt.price_unit_weight,
             tt.price_unit_cur_id,
             tt.price_unit_cur_code,
             tt.price_unit_weight_unit,
             tt.price_fixation_details,
             tt.price_description,
             tt.payment_due_date,
             tt.base_cur_id,
             tt.base_cur_code,
             tt.base_cur_decimal,
             tt.inventory_status,
             tt.shipment_status,
             tt.section_name,
             tt.price_basis,
             tt.shed_id,
             tt.destination_city_id,
             tt.price_fixation_status,
             tt.base_qty_unit_id,
             tt.conc_base_qty_unit_id,
             tt.base_qty_decimal,
             tt.strategy_id,
             tt.strategy_name,
             tt.valuation_exchange_id,
             tt.valuation_month,
             tt.derivative_def_id,
             tt.is_voyage_gmr,
             tt.gmr_contract_type,
             tt.int_alloc_group_id,
             tt.internal_grd_dgrd_ref_no,
             tt.stock_ref_no,
             tt.trader_id,
             tt.trader_user_name,
             tt.m2m_loc_incoterm_deviation,
             tt.m2m_treatment_charge,
             tt.m2m_refine_charge,
             tt.m2m_tc_price_unit_id,
             tt.m2m_tc_price_unit_name,
             tt.m2m_tc_cur_id,
             tt.m2m_tc_weight,
             tt.m2m_tc_weight_unit_id,
             tt.m2m_rc_price_unit_id,
             tt.m2m_rc_price_unit_name,
             tt.m2m_rc_cur_id,
             tt.m2m_rc_weight,
             tt.m2m_rc_weight_unit_id,
             tt.base_price_unit_id_in_ppu,
             tt.base_price_unit_id_in_pum,
             tt.eval_basis,
             dense_rank() over(partition by tt.internal_contract_item_ref_no order by tt.element_id) ele_rank,
             tt.unit_of_measure,
             tt.loc_qty_unit_id,
             tt.mvp_id,
             tt.shipment_month,
             tt.shipment_year,
             tt.base_price_unit_name,
             tt.valuation_against_underlying
        from (
              ----  Stock non event based GMR price using CIPDE
              select 'Purchase' section_type,
                      pcpd.profit_center_id profit_center,
                      cpc.profit_center_name,
                      cpc.profit_center_short_name,
                      pc_process_id process_id,
                      gmr.corporate_id,
                      akc.corporate_name,
                      gmr.internal_gmr_ref_no,
                      grd.internal_contract_item_ref_no,
                      pci.del_distribution_item_no,
                      pcdi.delivery_item_no,
                      pcm.contract_ref_no,
                      pcm.purchase_sales,
                      pcpd.product_id conc_product_id,
                      pdm_conc.product_desc conc_product_name,
                      aml.underlying_product_id product_id,
                      pdm.product_desc product_name,
                      grd.origin_id,
                      orm.origin_name,
                      pcpq.quality_template_id conc_quality_id,
                      qat.quality_name conc_quality_name,
                      qav.comp_quality_id quality_id,
                      qat_und.quality_name,
                      grd.container_no,
                      grd.current_qty stock_qty,
                      grd.qty_unit_id,
                      gmr.qty_unit_id gmr_qty_unit_id,
                      qum.qty_unit,
                      qum.decimals stocky_qty_decimal,
                      grd.no_of_units,
                      md.md_id,
                      md.m2m_price_unit_id,
                      md.net_m2m_price,
                      md.m2m_price_unit_cur_id,
                      md.m2m_price_unit_cur_code,
                      md.m2m_price_unit_weight_unit_id,
                      md.m2m_price_unit_weight_unit,
                      nvl(md.m2m_price_unit_weight, 1) m2m_price_unit_weight,
                      md.m2m_price_unit_cur_code || '/' ||
                      decode(md.m2m_price_unit_weight,
                             1,
                             null,
                             md.m2m_price_unit_weight) ||
                      md.m2m_price_unit_weight_unit m2m_price_unit_str,
                      md.m2m_main_cur_id,
                      md.m2m_main_cur_code,
                      md.m2m_main_cur_decimals,
                      md.main_currency_factor,
                      md.settlement_cur_id,
                      md.settlement_to_val_fx_rate,
                      cipde.element_id,
                      aml.attribute_name,
                      --pcpq.assay_header_id,
                      sam.ash_id assay_header_id,
                      ceqs.assay_qty,
                      ceqs.assay_qty_unit_id,
                      gmr_qty.payable_qty,
                      gmr_qty.qty_unit_id payable_qty_unit_id,
                      gmr_qum.qty_unit payable_qty_unit,
                      cipde.contract_price,
                      cipde.price_unit_id,
                      cipde.price_unit_weight_unit_id,
                      cipde.price_unit_weight,
                      cipde.price_unit_cur_id,
                      cipde.price_unit_cur_code,
                      cipde.price_unit_weight_unit,
                      cipde.price_fixation_details,
                      cipde.price_description,
                      nvl(cipde.payment_due_date, pd_trade_date) payment_due_date,
                      akc.base_cur_id as base_cur_id,
                      akc.base_currency_name base_cur_code,
                      cm.decimals as base_cur_decimal,
                      grd.inventory_status,
                      gsm.status shipment_status,
                      (case
                        when nvl(grd.is_afloat, 'N') = 'Y' and
                             nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                         'Shipped NTT'
                        when nvl(grd.is_afloat, 'N') = 'Y' and
                             nvl(grd.inventory_status, 'NA') = 'In' then
                         'Shipped IN'
                        when nvl(grd.is_afloat, 'N') = 'Y' and
                             nvl(grd.inventory_status, 'NA') = 'Out' then
                         'Shipped TT'
                        when nvl(grd.is_afloat, 'N') = 'N' and
                             nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                         'Stock NTT'
                        when nvl(grd.is_afloat, 'N') = 'N' and
                             nvl(grd.inventory_status, 'NA') = 'In' then
                         'Stock IN'
                        when nvl(grd.is_afloat, 'N') = 'N' and
                             nvl(grd.inventory_status, 'NA') = 'Out' then
                         'Stock TT'
                        else
                         'Others'
                      end) section_name,
                      cipde.price_basis,
                      gmr.shed_id,
                      gmr.destination_city_id,
                      cipde.price_fixation_status price_fixation_status,
                      pdm.base_quantity_unit base_qty_unit_id,
                      qum_pdm_conc.qty_unit_id as conc_base_qty_unit_id,
                      qum_pdm_conc.decimals as base_qty_decimal,
                      pcpd.strategy_id,
                      css.strategy_name,
                      md.valuation_exchange_id,
                      md.valuation_month,
                      md.derivative_def_id,
                      nvl(gmr.is_voyage_gmr, 'N') is_voyage_gmr,
                      gmr.contract_type gmr_contract_type,
                      null int_alloc_group_id,
                      grd.internal_grd_ref_no internal_grd_dgrd_ref_no,
                      grd.internal_stock_ref_no stock_ref_no,
                      pcm.trader_id,
                      (case
                        when pcm.trader_id is not null then
                         (select gab.firstname || ' ' || gab.lastname
                            from gab_globaladdressbook gab,
                                 ak_corporate_user     aku
                           where gab.gabid = aku.gabid
                             and aku.user_id = pcm.trader_id)
                        else
                         ''
                      end) trader_user_name,
                      md.m2m_loc_incoterm_deviation,
                      md.treatment_charge m2m_treatment_charge,
                      md.refine_charge m2m_refine_charge,
                      tc_ppu_pum.price_unit_id m2m_tc_price_unit_id,
                      tc_ppu_pum.price_unit_name m2m_tc_price_unit_name,
                      tc_ppu_pum.cur_id m2m_tc_cur_id,
                      tc_ppu_pum.weight m2m_tc_weight,
                      tc_ppu_pum.weight_unit_id m2m_tc_weight_unit_id,
                      rc_ppu_pum.price_unit_id m2m_rc_price_unit_id,
                      rc_ppu_pum.price_unit_name m2m_rc_price_unit_name,
                      rc_ppu_pum.cur_id m2m_rc_cur_id,
                      rc_ppu_pum.weight m2m_rc_weight,
                      rc_ppu_pum.weight_unit_id m2m_rc_weight_unit_id,
                      md.base_price_unit_id_in_ppu,
                      md.base_price_unit_id_in_pum,
                      qat.eval_basis,
                      pcpq.unit_of_measure,
                      pum_loc_base.weight_unit_id loc_qty_unit_id,
                      tmpc.mvp_id,
                      tmpc.shipment_month,
                      tmpc.shipment_year,
                      pum_base_price_id.price_unit_name base_price_unit_name,
                      nvl(pdm_conc.valuation_against_underlying, 'Y') valuation_against_underlying
                from gmr_goods_movement_record gmr,
                      grd_goods_record_detail grd,
                      pcm_physical_contract_main pcm,
                      pcpd_pc_product_definition pcpd,
                      cpc_corporate_profit_center cpc,
                      pdm_productmaster pdm,
                      orm_origin_master orm,
                      (select tmp.*
                         from tmpc_temp_m2m_pre_check tmp
                        where tmp.corporate_id = pc_corporate_id
                          and tmp.product_type = 'CONCENTRATES'
                          and tmp.section_name <> 'OPEN') tmpc,
                      qum_quantity_unit_master qum,
                      qat_quality_attributes qat,
                      (select md1.*
                         from md_m2m_daily md1
                        where md1.rate_type <> 'OPEN'
                          and md1.corporate_id = pc_corporate_id
                          and md1.product_type = 'CONCENTRATES'
                          and md1.process_id = pc_process_id) md,
                      cipde_cipd_element_price cipde,
                      ciqs_contract_item_qty_status ciqs,
                      pci_physical_contract_item pci,
                      pcpq_pc_product_quality pcpq,
                      pcdi_pc_delivery_item pcdi,
                      qav_quality_attribute_values qav,
                      ppm_product_properties_mapping ppm,
                      qat_quality_attributes qat_und,
                      aml_attribute_master_list aml,
                      pcdb_pc_delivery_basis pcdb,
                      ak_corporate akc,
                      cm_currency_master cm,
                      gsm_gmr_stauts_master gsm,
                      css_corporate_strategy_setup css,
                      pdm_productmaster pdm_conc,
                      qum_quantity_unit_master qum_pdm_conc,
                      pum_price_unit_master pum_loc_base,
                      pum_price_unit_master pum_base_price_id,
                      v_gmr_stockpayable_qty gmr_qty,
                      qum_quantity_unit_master gmr_qum,
                      v_ppu_pum tc_ppu_pum,
                      v_ppu_pum rc_ppu_pum,
                      ceqs_contract_ele_qty_status ceqs,
                      sam_stock_assay_mapping sam
               where grd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
                 and gmr.internal_contract_ref_no =
                     pcm.internal_contract_ref_no
                 and pcm.internal_contract_ref_no =
                     pcpd.internal_contract_ref_no
                 and pcpd.profit_center_id = cpc.profit_center_id
                 and grd.origin_id = orm.origin_id(+)
                 and grd.internal_gmr_ref_no = tmpc.internal_gmr_ref_no(+)
                 and grd.internal_grd_ref_no = tmpc.internal_grd_ref_no(+)
                 and grd.internal_contract_item_ref_no =
                     tmpc.internal_contract_item_ref_no(+)
                 and tmpc.conc_quality_id = qat.quality_id
                 and grd.qty_unit_id = qum.qty_unit_id(+)
                 and tmpc.internal_m2m_id = md.md_id(+)
                 and tmpc.element_id = cipde.element_id
                 and md.element_id = cipde.element_id
                 and grd.internal_contract_item_ref_no =
                     cipde.internal_contract_item_ref_no
                 and grd.process_id = cipde.process_id
                 and cipde.internal_contract_ref_no =
                     pcm.internal_contract_ref_no
                 and grd.internal_contract_item_ref_no =
                     ciqs.internal_contract_item_ref_no
                 and grd.internal_contract_item_ref_no =
                     pci.internal_contract_item_ref_no
                 and pci.pcpq_id = pcpq.pcpq_id
                 and pcm.internal_contract_ref_no =
                     pcdi.internal_contract_ref_no
                 and pcdi.pcdi_id = pci.pcdi_id
                 and pcpq.quality_template_id = qat.quality_id(+)
                 and qat.quality_id = qav.quality_id
                 and qav.attribute_id = ppm.property_id
                 and qav.comp_quality_id = qat_und.quality_id
                 and ppm.attribute_id = aml.attribute_id
                 and aml.underlying_product_id = pdm.product_id(+)
                 and aml.attribute_id = cipde.element_id
                 and pci.pcdb_id = pcdb.pcdb_id
                 and gmr.corporate_id = akc.corporate_id
                 and akc.base_cur_id = cm.cur_id
                 and gmr.status_id = gsm.status_id(+)
                 and pcpd.strategy_id = css.strategy_id
                 and pcpd.product_id = pdm_conc.product_id
                 and qum_pdm_conc.qty_unit_id = pdm_conc.base_quantity_unit
                 and md.base_price_unit_id_in_pum =
                     pum_loc_base.price_unit_id
                 and md.base_price_unit_id_in_pum =
                     pum_base_price_id.price_unit_id
                 and md.tc_price_unit_id = tc_ppu_pum.product_price_unit_id
                 and md.rc_price_unit_id = rc_ppu_pum.product_price_unit_id
                 and gmr.internal_gmr_ref_no = gmr_qty.internal_gmr_ref_no
                 and grd.internal_grd_ref_no = gmr_qty.internal_grd_ref_no
                 and cipde.element_id = gmr_qty.element_id
                 and gmr_qty.qty_unit_id = gmr_qum.qty_unit_id
                 and pci.internal_contract_item_ref_no =
                     ceqs.internal_contract_item_ref_no
                 and aml.attribute_id = ceqs.element_id
                 and grd.process_id = pc_process_id
                 and gmr.process_id = pc_process_id
                 and pci.process_id = pc_process_id
                 and pcm.process_id = pc_process_id
                 and pcpd.process_id = pc_process_id
                 and pcpq.process_id = pc_process_id
                 and pcdi.process_id = pc_process_id
                 and pcpd.process_id = pc_process_id
                 and ciqs.process_id = pc_process_id
                 and cipde.process_id = pc_process_id
                 and pcdb.process_id = pc_process_id
                 and gmr_qty.process_id = pc_process_id
                 and ceqs.process_id = pc_process_id
                 and pcm.purchase_sales = 'P'
                 and pcm.contract_status = 'In Position'
                 and pcm.contract_type = 'CONCENTRATES'
                 and pcpd.input_output = 'Input'
                 and pcm.is_tolling_contract = 'N'
                 and pcm.is_tolling_extn = 'N'
                 and pci.is_active = 'Y'
                 and pcm.is_active = 'Y'
                 and pcpd.is_active = 'Y'
                 and pcpq.is_active = 'Y'
                 and pcdi.is_active = 'Y'
                 and pcpd.is_active = 'Y'
                 and ppm.is_active = 'Y'
                 and ppm.is_deleted = 'N'
                 and qav.is_deleted = 'N'
                 and qav.is_comp_product_attribute = 'Y'
                 and qat.is_active = 'Y'
                 and qat.is_deleted = 'N'
                 and aml.is_active = 'Y'
                 and aml.is_deleted = 'N'
                 and qat_und.is_active = 'Y'
                 and qat_und.is_deleted = 'N'
                 and gmr.corporate_id = pc_corporate_id
                 and grd.status = 'Active'
                 and grd.is_deleted = 'N'
                 and gmr.is_deleted = 'N'
                 and nvl(grd.inventory_status, 'NA') <> 'Out'
                 and pcm.purchase_sales = 'P'
                 and nvl(grd.current_qty, 0) > 0
                 and gmr.is_internal_movement = 'N'
                 and grd.internal_grd_ref_no = sam.internal_grd_ref_no
                 and sam.is_latest_position_assay = 'Y'
                 and not exists
               (select gpd.process_id
                        from gpd_gmr_conc_price_daily gpd
                       where gpd.process_id = gmr.process_id
                         and gpd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
                         and gpd.corporate_id = gmr.corporate_id
                         and gpd.element_id = tmpc.element_id)
              union all
              ------  Stock event based GMR price using GPD
              select 'Purchase' section_type,
                     pcpd.profit_center_id profit_center,
                     cpc.profit_center_name,
                     cpc.profit_center_short_name,
                     pc_process_id process_id,
                     gmr.corporate_id,
                     akc.corporate_name,
                     gmr.internal_gmr_ref_no,
                     grd.internal_contract_item_ref_no,
                     pci.del_distribution_item_no,
                     pcdi.delivery_item_no,
                     pcm.contract_ref_no,
                     pcm.purchase_sales,
                     pcpd.product_id conc_product_id,
                     pdm_conc.product_desc conc_product_name,
                     aml.underlying_product_id product_id,
                     pdm.product_desc product_name,
                     grd.origin_id,
                     orm.origin_name,
                     pcpq.quality_template_id conc_quality_id,
                     qat.quality_name conc_quality_name,
                     qav.comp_quality_id quality_id,
                     qat_und.quality_name,
                     grd.container_no,
                     grd.current_qty stock_qty,
                     grd.qty_unit_id,
                     gmr.qty_unit_id gmr_qty_unit_id,
                     qum.qty_unit,
                     qum.decimals stocky_qty_decimal,
                     grd.no_of_units,
                     md.md_id,
                     md.m2m_price_unit_id,
                     md.net_m2m_price,
                     md.m2m_price_unit_cur_id,
                     md.m2m_price_unit_cur_code,
                     md.m2m_price_unit_weight_unit_id,
                     md.m2m_price_unit_weight_unit,
                     nvl(md.m2m_price_unit_weight, 1) m2m_price_unit_weight,
                     md.m2m_price_unit_cur_code || '/' ||
                     decode(md.m2m_price_unit_weight,
                            1,
                            null,
                            md.m2m_price_unit_weight) ||
                     md.m2m_price_unit_weight_unit m2m_price_unit_str,
                     md.m2m_main_cur_id,
                     md.m2m_main_cur_code,
                     md.m2m_main_cur_decimals,
                     md.main_currency_factor,
                     md.settlement_cur_id,
                     md.settlement_to_val_fx_rate,
                     ceqs.element_id, --cipde.element_id,
                     aml.attribute_name,
                     -- pcpq.assay_header_id,
                     sam.ash_id assay_header_id,
                     ceqs.assay_qty,
                     ceqs.assay_qty_unit_id,
                     gmr_qty.payable_qty,
                     gmr_qty.qty_unit_id payable_qty_unit_id,
                     gmr_qum.qty_unit payable_qty_unit,
                     gpd.contract_price,
                     gpd.price_unit_id,
                     gpd.price_unit_weight_unit_id,
                     gpd.price_unit_weight,
                     gpd.price_unit_cur_id,
                     gpd.price_unit_cur_code,
                     gpd.price_unit_weight_unit,
                     gpd.price_fixation_details, --cipde.price_fixation_details,
                     gpd.price_description price_description, --- cipde.price_description,
                     -- null payment_due_date, -- nvl(cipde.payment_due_date, pd_trade_date) payment_due_date,
                     (case
                       when nvl(pcdi.payment_due_date, pd_trade_date) <
                            pd_trade_date then
                        pd_trade_date
                       else
                        nvl(pcdi.payment_due_date, pd_trade_date)
                     end) payment_due_date,
                     akc.base_cur_id as base_cur_id,
                     akc.base_currency_name base_cur_code,
                     cm.decimals as base_cur_decimal,
                     grd.inventory_status,
                     gsm.status shipment_status,
                     (case
                       when nvl(grd.is_afloat, 'N') = 'Y' and
                            nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                        'Shipped NTT'
                       when nvl(grd.is_afloat, 'N') = 'Y' and
                            nvl(grd.inventory_status, 'NA') = 'In' then
                        'Shipped IN'
                       when nvl(grd.is_afloat, 'N') = 'Y' and
                            nvl(grd.inventory_status, 'NA') = 'Out' then
                        'Shipped TT'
                       when nvl(grd.is_afloat, 'N') = 'N' and
                            nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                        'Stock NTT'
                       when nvl(grd.is_afloat, 'N') = 'N' and
                            nvl(grd.inventory_status, 'NA') = 'In' then
                        'Stock IN'
                       when nvl(grd.is_afloat, 'N') = 'N' and
                            nvl(grd.inventory_status, 'NA') = 'Out' then
                        'Stock TT'
                       else
                        'Others'
                     end) section_name,
                     gpd.price_basis, -- cipde.price_basis,
                     gmr.shed_id,
                     gmr.destination_city_id,
                     gpd.price_fixation_status, ---cipde.price_fixation_status price_fixation_status,
                     pdm.base_quantity_unit base_qty_unit_id,
                     qum_pdm_conc.qty_unit_id as conc_base_qty_unit_id,
                     qum_pdm_conc.decimals as base_qty_decimal,
                     pcpd.strategy_id,
                     css.strategy_name,
                     md.valuation_exchange_id,
                     md.valuation_month,
                     md.derivative_def_id,
                     nvl(gmr.is_voyage_gmr, 'N') is_voyage_gmr,
                     gmr.contract_type gmr_contract_type,
                     null int_alloc_group_id,
                     grd.internal_grd_ref_no internal_grd_dgrd_ref_no,
                     grd.internal_stock_ref_no stock_ref_no,
                     pcm.trader_id,
                     (case
                       when pcm.trader_id is not null then
                        (select gab.firstname || ' ' || gab.lastname
                           from gab_globaladdressbook gab,
                                ak_corporate_user     aku
                          where gab.gabid = aku.gabid
                            and aku.user_id = pcm.trader_id)
                       else
                        ''
                     end) trader_user_name,
                     md.m2m_loc_incoterm_deviation,
                     md.treatment_charge m2m_treatment_charge,
                     md.refine_charge m2m_refine_charge,
                     tc_ppu_pum.price_unit_id m2m_tc_price_unit_id,
                     tc_ppu_pum.price_unit_name m2m_tc_price_unit_name,
                     tc_ppu_pum.cur_id m2m_tc_cur_id,
                     tc_ppu_pum.weight m2m_tc_weight,
                     tc_ppu_pum.weight_unit_id m2m_tc_weight_unit_id,
                     rc_ppu_pum.price_unit_id m2m_rc_price_unit_id,
                     rc_ppu_pum.price_unit_name m2m_rc_price_unit_name,
                     rc_ppu_pum.cur_id m2m_rc_cur_id,
                     rc_ppu_pum.weight m2m_rc_weight,
                     rc_ppu_pum.weight_unit_id m2m_rc_weight_unit_id,
                     md.base_price_unit_id_in_ppu,
                     md.base_price_unit_id_in_pum,
                     qat.eval_basis,
                     pcpq.unit_of_measure,
                     pum_loc_base.weight_unit_id loc_qty_unit_id,
                     tmpc.mvp_id,
                     tmpc.shipment_month,
                     tmpc.shipment_year,
                     pum_base_price_id.price_unit_name base_price_unit_name,
                     nvl(pdm_conc.valuation_against_underlying, 'Y') valuation_against_underlying
                from gmr_goods_movement_record gmr,
                     grd_goods_record_detail grd,
                     gpd_gmr_conc_price_daily gpd,
                     pcm_physical_contract_main pcm,
                     pcpd_pc_product_definition pcpd,
                     cpc_corporate_profit_center cpc,
                     pdm_productmaster pdm,
                     orm_origin_master orm,
                     (select tmp.*
                        from tmpc_temp_m2m_pre_check tmp
                       where tmp.corporate_id = pc_corporate_id
                         and tmp.product_type = 'CONCENTRATES'
                         and tmp.section_name <> 'OPEN') tmpc,
                     qum_quantity_unit_master qum,
                     qat_quality_attributes qat,
                     (select md1.*
                        from md_m2m_daily md1
                       where md1.rate_type <> 'OPEN'
                         and md1.corporate_id = pc_corporate_id
                         and md1.product_type = 'CONCENTRATES'
                         and md1.process_id = pc_process_id) md,
                     ciqs_contract_item_qty_status ciqs,
                     pci_physical_contract_item pci,
                     pcpq_pc_product_quality pcpq,
                     pcdi_pc_delivery_item pcdi,
                     qav_quality_attribute_values qav,
                     ppm_product_properties_mapping ppm,
                     qat_quality_attributes qat_und,
                     aml_attribute_master_list aml,
                     pcdb_pc_delivery_basis pcdb,
                     ak_corporate akc,
                     cm_currency_master cm,
                     gsm_gmr_stauts_master gsm,
                     css_corporate_strategy_setup css,
                     pdm_productmaster pdm_conc,
                     qum_quantity_unit_master qum_pdm_conc,
                     pum_price_unit_master pum_loc_base,
                     pum_price_unit_master pum_base_price_id,
                     v_gmr_stockpayable_qty gmr_qty,
                     qum_quantity_unit_master gmr_qum,
                     v_ppu_pum tc_ppu_pum,
                     v_ppu_pum rc_ppu_pum,
                     ceqs_contract_ele_qty_status ceqs,
                     sam_stock_assay_mapping sam
               where grd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
                 and gmr.internal_contract_ref_no =
                     pcm.internal_contract_ref_no
                 and pcm.internal_contract_ref_no =
                     pcpd.internal_contract_ref_no
                 and pcpd.profit_center_id = cpc.profit_center_id
                 and grd.origin_id = orm.origin_id(+)
                 and gmr.internal_gmr_ref_no = gpd.internal_gmr_ref_no(+)
                 and gmr.process_id = gpd.process_id(+)
                 and gpd.internal_gmr_ref_no = tmpc.internal_gmr_ref_no
                 and gpd.element_id = tmpc.element_id
                 and grd.internal_gmr_ref_no = tmpc.internal_gmr_ref_no(+)
                 and grd.internal_grd_ref_no = tmpc.internal_grd_ref_no(+)
                 and grd.internal_contract_item_ref_no =
                     tmpc.internal_contract_item_ref_no(+)
                 and tmpc.conc_quality_id = qat.quality_id
                 and grd.qty_unit_id = qum.qty_unit_id(+)
                 and tmpc.internal_m2m_id = md.md_id(+)
                 and tmpc.element_id = gpd.element_id
                 and md.element_id = gpd.element_id
                 and grd.process_id = gpd.process_id
                 and grd.internal_contract_item_ref_no =
                     ciqs.internal_contract_item_ref_no
                 and grd.internal_contract_item_ref_no =
                     pci.internal_contract_item_ref_no
                 and pci.pcpq_id = pcpq.pcpq_id
                 and pcm.internal_contract_ref_no =
                     pcdi.internal_contract_ref_no
                 and pcdi.pcdi_id = pci.pcdi_id
                 and pcpq.quality_template_id = qat.quality_id(+)
                 and qat.quality_id = qav.quality_id
                 and qav.attribute_id = ppm.property_id
                 and qav.comp_quality_id = qat_und.quality_id
                 and ppm.attribute_id = aml.attribute_id
                 and aml.underlying_product_id = pdm.product_id(+)
                 and aml.attribute_id = gpd.element_id
                 and pci.pcdb_id = pcdb.pcdb_id
                 and gmr.corporate_id = akc.corporate_id
                 and akc.base_cur_id = cm.cur_id
                 and gmr.status_id = gsm.status_id(+)
                 and pcpd.strategy_id = css.strategy_id
                 and pcpd.product_id = pdm_conc.product_id
                 and qum_pdm_conc.qty_unit_id = pdm_conc.base_quantity_unit
                 and md.base_price_unit_id_in_pum =
                     pum_loc_base.price_unit_id
                 and md.base_price_unit_id_in_pum =
                     pum_base_price_id.price_unit_id
                 and md.tc_price_unit_id = tc_ppu_pum.product_price_unit_id
                 and md.rc_price_unit_id = rc_ppu_pum.product_price_unit_id
                 and gmr.internal_gmr_ref_no = gmr_qty.internal_gmr_ref_no
                 and grd.internal_grd_ref_no = gmr_qty.internal_grd_ref_no
                 and gpd.element_id = gmr_qty.element_id
                 and gmr_qty.qty_unit_id = gmr_qum.qty_unit_id
                 and pci.internal_contract_item_ref_no =
                     ceqs.internal_contract_item_ref_no
                 and aml.attribute_id = ceqs.element_id
                 and grd.process_id = pc_process_id
                 and gmr.process_id = pc_process_id
                 and pci.process_id = pc_process_id
                 and pcm.process_id = pc_process_id
                 and pcpd.process_id = pc_process_id
                 and pcpq.process_id = pc_process_id
                 and pcdi.process_id = pc_process_id
                 and pcpd.process_id = pc_process_id
                 and ciqs.process_id = pc_process_id
                 and gpd.process_id = pc_process_id
                 and pcdb.process_id = pc_process_id
                 and gmr_qty.process_id = pc_process_id
                 and ceqs.process_id = pc_process_id
                 and pcm.purchase_sales = 'P'
                 and pcm.contract_status = 'In Position'
                 and pcm.contract_type = 'CONCENTRATES'
                 and pcpd.input_output = 'Input'
                 and pcm.is_tolling_contract = 'N'
                 and pcm.is_tolling_extn = 'N'
                 and pci.is_active = 'Y'
                 and pcm.is_active = 'Y'
                 and pcpd.is_active = 'Y'
                 and pcpq.is_active = 'Y'
                 and pcdi.is_active = 'Y'
                 and pcpd.is_active = 'Y'
                 and ppm.is_active = 'Y'
                 and ppm.is_deleted = 'N'
                 and qav.is_deleted = 'N'
                 and qav.is_comp_product_attribute = 'Y'
                 and qat.is_active = 'Y'
                 and qat.is_deleted = 'N'
                 and aml.is_active = 'Y'
                 and aml.is_deleted = 'N'
                 and qat_und.is_active = 'Y'
                 and qat_und.is_deleted = 'N'
                 and gmr.corporate_id = pc_corporate_id
                 and grd.status = 'Active'
                 and grd.is_deleted = 'N'
                 and gmr.is_deleted = 'N'
                 and nvl(grd.inventory_status, 'NA') <> 'Out'
                 and pcm.purchase_sales = 'P'
                 and nvl(grd.current_qty, 0) > 0
                 and gmr.is_internal_movement = 'N'
                 and grd.internal_grd_ref_no = sam.internal_grd_ref_no
                 and sam.is_latest_position_assay = 'Y'
              union all
              ------  Sales non event based GMR price using CIPDE
              select 'Sales' section_type,
                     pcpd.profit_center_id profit_center,
                     cpc.profit_center_name,
                     cpc.profit_center_short_name,
                     pc_process_id process_id,
                     gmr.corporate_id,
                     akc.corporate_name,
                     gmr.internal_gmr_ref_no,
                     dgrd.internal_contract_item_ref_no,
                     pci.del_distribution_item_no,
                     pcdi.delivery_item_no,
                     pcm.contract_ref_no,
                     pcm.purchase_sales,
                     pcpd.product_id conc_product_id,
                     pdm_conc.product_desc conc_product_name,
                     aml.underlying_product_id product_id,
                     pdm.product_desc product_name,
                     dgrd.origin_id,
                     orm.origin_name,
                     pcpq.quality_template_id conc_quality_id,
                     qat.quality_name conc_quality_name,
                     qav.comp_quality_id quality_id,
                     qat_und.quality_name,
                     '' container_no,
                     dgrd.net_weight stock_qty,
                     dgrd.net_weight_unit_id qty_unit_id,
                     gmr.qty_unit_id gmr_qty_unit_id,
                     qum.qty_unit,
                     qum.decimals stocky_qty_decimal,
                     gmr.current_no_of_units no_of_units,
                     md.md_id,
                     md.m2m_price_unit_id,
                     md.net_m2m_price,
                     md.m2m_price_unit_cur_id,
                     md.m2m_price_unit_cur_code,
                     md.m2m_price_unit_weight_unit_id,
                     md.m2m_price_unit_weight_unit,
                     nvl(md.m2m_price_unit_weight, 1) m2m_price_unit_weight,
                     md.m2m_price_unit_cur_code || '/' ||
                     decode(md.m2m_price_unit_weight,
                            1,
                            null,
                            md.m2m_price_unit_weight) ||
                     md.m2m_price_unit_weight_unit m2m_price_unit_str,
                     md.m2m_main_cur_id,
                     md.m2m_main_cur_code,
                     md.m2m_main_cur_decimals,
                     md.main_currency_factor,
                     md.settlement_cur_id,
                     md.settlement_to_val_fx_rate,
                     cipde.element_id,
                     aml.attribute_name,
                     sam.ash_id assay_header_id,
                     -- pcpq.assay_header_id,
                     ceqs.assay_qty,
                     ceqs.assay_qty_unit_id,
                     gmr_qty.payable_qty,
                     gmr_qty.qty_unit_id payable_qty_unit_id,
                     gmr_qum.qty_unit payable_qty_unit,
                     cipde.contract_price,
                     cipde.price_unit_id,
                     cipde.price_unit_weight_unit_id,
                     cipde.price_unit_weight,
                     cipde.price_unit_cur_id,
                     cipde.price_unit_cur_code,
                     cipde.price_unit_weight_unit,
                     cipde.price_fixation_details,
                     cipde.price_description,
                     nvl(cipde.payment_due_date, pd_trade_date) payment_due_date,
                     akc.base_cur_id as base_cur_id,
                     akc.base_currency_name base_cur_code,
                     cm.decimals as base_cur_decimal,
                     gmr.inventory_status,
                     gsm.status shipment_status,
                     (case
                       when nvl(dgrd.inventory_status, 'NA') = 'Under CMA' then
                        'UnderCMA NTT'
                       when nvl(dgrd.is_afloat, 'N') = 'Y' and
                            nvl(dgrd.inventory_status, 'NA') in
                            ('In', 'None', 'NA') then
                        'Shipped NTT'
                       when nvl(dgrd.is_afloat, 'N') = 'Y' and
                            nvl(dgrd.inventory_status, 'NA') = 'Out' then
                        'Shipped TT'
                       when nvl(dgrd.is_afloat, 'N') = 'N' and
                            nvl(dgrd.inventory_status, 'NA') in
                            ('In', 'None', 'NA') then
                        'Stock NTT'
                       when nvl(dgrd.is_afloat, 'N') = 'N' and
                            nvl(dgrd.inventory_status, 'NA') = 'Out' then
                        'Stock TT'
                       else
                        'Others'
                     end) section_name,
                     cipde.price_basis,
                     gmr.shed_id,
                     gmr.destination_city_id,
                     cipde.price_fixation_status price_fixation_status,
                     pdm.base_quantity_unit base_qty_unit_id,
                     qum_pdm_conc.qty_unit_id as conc_base_qty_unit_id,
                     qum_pdm_conc.decimals as base_qty_decimal,
                     pcpd.strategy_id,
                     css.strategy_name,
                     md.valuation_exchange_id,
                     md.valuation_month,
                     md.derivative_def_id,
                     nvl(gmr.is_voyage_gmr, 'N') is_voyage_gmr,
                     gmr.contract_type gmr_contract_type,
                     agh.int_alloc_group_id,
                     dgrd.internal_dgrd_ref_no internal_grd_dgrd_ref_no,
                     dgrd.internal_stock_ref_no stock_ref_no,
                     pcm.trader_id,
                     (case
                       when pcm.trader_id is not null then
                        (select gab.firstname || ' ' || gab.lastname
                           from gab_globaladdressbook gab,
                                ak_corporate_user     aku
                          where gab.gabid = aku.gabid
                            and aku.user_id = pcm.trader_id)
                       else
                        ''
                     end) trader_user_name,
                     md.m2m_loc_incoterm_deviation,
                     md.treatment_charge m2m_treatment_charge,
                     md.refine_charge m2m_refine_charge,
                     tc_ppu_pum.price_unit_id m2m_tc_price_unit_id,
                     tc_ppu_pum.price_unit_name m2m_tc_price_unit_name,
                     tc_ppu_pum.cur_id m2m_tc_cur_id,
                     tc_ppu_pum.weight m2m_tc_weight,
                     tc_ppu_pum.weight_unit_id m2m_tc_weight_unit_id,
                     rc_ppu_pum.price_unit_id m2m_rc_price_unit_id,
                     rc_ppu_pum.price_unit_name m2m_rc_price_unit_name,
                     rc_ppu_pum.cur_id m2m_rc_cur_id,
                     rc_ppu_pum.weight m2m_rc_weight,
                     rc_ppu_pum.weight_unit_id m2m_rc_weight_unit_id,
                     md.base_price_unit_id_in_ppu,
                     md.base_price_unit_id_in_pum,
                     qat.eval_basis,
                     pcpq.unit_of_measure,
                     pum_loc_base.weight_unit_id loc_qty_unit_id,
                     tmpc.mvp_id,
                     tmpc.shipment_month,
                     tmpc.shipment_year,
                     pum_base_price_id.price_unit_name base_price_unit_name,
                     nvl(pdm_conc.valuation_against_underlying, 'Y') valuation_against_underlying
                from gmr_goods_movement_record gmr,
                     dgrd_delivered_grd dgrd,
                     agh_alloc_group_header agh,
                     pcm_physical_contract_main pcm,
                     pcpd_pc_product_definition pcpd,
                     cpc_corporate_profit_center cpc,
                     pdm_productmaster pdm,
                     orm_origin_master orm,
                     (select tmp.*
                        from tmpc_temp_m2m_pre_check tmp
                       where tmp.corporate_id = pc_corporate_id
                         and tmp.product_type = 'CONCENTRATES'
                         and tmp.section_name <> 'OPEN') tmpc,
                     qat_quality_attributes qat,
                     qum_quantity_unit_master qum,
                     (select md1.*
                        from md_m2m_daily md1
                       where md1.rate_type <> 'OPEN'
                         and md1.corporate_id = pc_corporate_id
                         and md1.product_type = 'CONCENTRATES'
                         and md1.process_id = pc_process_id) md,
                     cipde_cipd_element_price cipde,
                     pcdi_pc_delivery_item pcdi,
                     pci_physical_contract_item pci,
                     pcpq_pc_product_quality pcpq,
                     qav_quality_attribute_values qav,
                     ppm_product_properties_mapping ppm,
                     qat_quality_attributes qat_und,
                     aml_attribute_master_list aml,
                     ciqs_contract_item_qty_status ciqs,
                     ak_corporate akc,
                     cm_currency_master cm,
                     gsm_gmr_stauts_master gsm,
                     css_corporate_strategy_setup css,
                     pcdb_pc_delivery_basis pcdb,
                     pdm_productmaster pdm_conc,
                     qum_quantity_unit_master qum_pdm_conc,
                     pum_price_unit_master pum_loc_base,
                     pum_price_unit_master pum_base_price_id,
                     v_gmr_stockpayable_qty gmr_qty,
                     qum_quantity_unit_master gmr_qum,
                     v_ppu_pum tc_ppu_pum,
                     v_ppu_pum rc_ppu_pum,
                     ceqs_contract_ele_qty_status ceqs,
                     sam_stock_assay_mapping sam
               where dgrd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
                 and dgrd.int_alloc_group_id = agh.int_alloc_group_id
                 and gmr.internal_contract_ref_no =
                     pcm.internal_contract_ref_no
                 and pcm.internal_contract_ref_no =
                     pcpd.internal_contract_ref_no
                 and pcpd.profit_center_id = cpc.profit_center_id
                 and dgrd.origin_id = orm.origin_id(+)
                 and dgrd.internal_gmr_ref_no = tmpc.internal_gmr_ref_no(+)
                 and dgrd.internal_grd_ref_no = tmpc.internal_grd_ref_no(+)
                 and dgrd.internal_contract_item_ref_no =
                     tmpc.internal_contract_item_ref_no(+)
                 and tmpc.conc_quality_id = qat.quality_id
                 and dgrd.net_weight_unit_id = qum.qty_unit_id(+)
                 and tmpc.internal_m2m_id = md.md_id(+)
                 and tmpc.element_id = cipde.element_id
                 and md.element_id = cipde.element_id
                 and dgrd.internal_contract_item_ref_no =
                     cipde.internal_contract_item_ref_no
                 and cipde.internal_contract_ref_no =
                     pcm.internal_contract_ref_no
                 and pcm.internal_contract_ref_no =
                     pcdi.internal_contract_ref_no
                 and pcdi.pcdi_id = pci.pcdi_id
                 and pci.internal_contract_item_ref_no =
                     cipde.internal_contract_item_ref_no
                 and pci.pcpq_id = pcpq.pcpq_id
                 and qat.quality_id = qav.quality_id
                 and qav.attribute_id = ppm.property_id
                 and qav.comp_quality_id = qat_und.quality_id
                 and pcpq.quality_template_id = qat.quality_id
                 and ppm.attribute_id = aml.attribute_id(+)
                 and aml.underlying_product_id = pdm.product_id(+)
                 and aml.attribute_id = cipde.element_id
                 and pcpq.quality_template_id = qat.quality_id(+)
                 and pci.internal_contract_item_ref_no =
                     ciqs.internal_contract_item_ref_no
                 and gmr.corporate_id = akc.corporate_id
                 and akc.base_cur_id = cm.cur_id
                 and cm.cur_code = akc.base_currency_name
                 and gmr.status_id = gsm.status_id(+)
                 and pcpd.strategy_id = css.strategy_id
                 and pci.pcdb_id = pcdb.pcdb_id
                 and pcpd.product_id = pdm_conc.product_id
                 and qum_pdm_conc.qty_unit_id = pdm_conc.base_quantity_unit
                 and md.base_price_unit_id_in_pum =
                     pum_loc_base.price_unit_id
                 and md.base_price_unit_id_in_pum =
                     pum_base_price_id.price_unit_id
                 and md.tc_price_unit_id = tc_ppu_pum.product_price_unit_id
                 and md.rc_price_unit_id = rc_ppu_pum.product_price_unit_id
                 and gmr.internal_gmr_ref_no = gmr_qty.internal_gmr_ref_no
                 and dgrd.internal_dgrd_ref_no = gmr_qty.internal_dgrd_ref_no
                 and cipde.element_id = gmr_qty.element_id
                 and gmr_qty.qty_unit_id = gmr_qum.qty_unit_id
                 and pci.internal_contract_item_ref_no =
                     ceqs.internal_contract_item_ref_no
                 and aml.attribute_id = ceqs.element_id
                 and pcm.purchase_sales = 'S'
                 and gsm.is_required_for_m2m = 'Y'
                 and pcm.contract_status = 'In Position'
                 and pcm.contract_type = 'CONCENTRATES'
                 and pcpd.input_output = 'Input'
                 and pcm.is_tolling_contract = 'N'
                 and pcm.is_tolling_extn = 'N'
                 and pci.is_active = 'Y'
                 and pcm.is_active = 'Y'
                 and pcpd.is_active = 'Y'
                 and pcpq.is_active = 'Y'
                 and pcdi.is_active = 'Y'
                 and pcdb.is_active = 'Y'
                 and gmr.is_deleted = 'N'
                 and ppm.is_active = 'Y'
                 and ppm.is_deleted = 'N'
                 and qav.is_deleted = 'N'
                 and qav.is_comp_product_attribute = 'Y'
                 and qat.is_active = 'Y'
                 and qat.is_deleted = 'N'
                 and aml.is_active = 'Y'
                 and aml.is_deleted = 'N'
                 and qat_und.is_active = 'Y'
                 and qat_und.is_deleted = 'N'
                 and pcm.process_id = pc_process_id
                 and pcdi.process_id = pc_process_id
                 and pci.process_id = pc_process_id
                 and gmr.process_id = pc_process_id
                 and dgrd.process_id = pc_process_id
                 and agh.process_id = pc_process_id
                 and pcpd.process_id = pc_process_id
                 and cipde.process_id = pc_process_id
                 and pcpq.process_id = pc_process_id
                 and ciqs.process_id = pc_process_id
                 and pcdb.process_id = pc_process_id
                 and gmr_qty.process_id = pc_process_id
                 and ceqs.process_id = pc_process_id
                    -- and upper(dgrd.realized_status) in('UNREALIZED', 'REALIZED', 'REVERSEREALIZED')
                 and dgrd.status = 'Active'
                 and nvl(dgrd.net_weight, 0) > 0
                 and agh.is_deleted = 'N'
                 and gmr.corporate_id = pc_corporate_id
                 and gmr.is_internal_movement = 'N'
                 and dgrd.internal_dgrd_ref_no = sam.internal_dgrd_ref_no
                 and sam.is_latest_position_assay = 'Y'
                 and not exists
               (select gpd.process_id
                        from gpd_gmr_conc_price_daily gpd
                       where gpd.process_id = gmr.process_id
                         and gpd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
                         and gpd.corporate_id = gmr.corporate_id
                         and gpd.element_id = tmpc.element_id)
              union all
              ------  Sales  event based GMR price using GPE
              select 'Sales' section_type,
                     pcpd.profit_center_id profit_center,
                     cpc.profit_center_name,
                     cpc.profit_center_short_name,
                     pc_process_id process_id,
                     gmr.corporate_id,
                     akc.corporate_name,
                     gmr.internal_gmr_ref_no,
                     dgrd.internal_contract_item_ref_no,
                     pci.del_distribution_item_no,
                     pcdi.delivery_item_no,
                     pcm.contract_ref_no,
                     pcm.purchase_sales,
                     pcpd.product_id conc_product_id,
                     pdm_conc.product_desc conc_product_name,
                     aml.underlying_product_id product_id,
                     pdm.product_desc product_name,
                     dgrd.origin_id,
                     orm.origin_name,
                     pcpq.quality_template_id conc_quality_id,
                     qat.quality_name conc_quality_name,
                     qav.comp_quality_id quality_id,
                     qat_und.quality_name,
                     '' container_no,
                     dgrd.net_weight stock_qty,
                     dgrd.net_weight_unit_id qty_unit_id,
                     gmr.qty_unit_id gmr_qty_unit_id,
                     qum.qty_unit,
                     qum.decimals stocky_qty_decimal,
                     gmr.current_no_of_units no_of_units,
                     md.md_id,
                     md.m2m_price_unit_id,
                     md.net_m2m_price,
                     md.m2m_price_unit_cur_id,
                     md.m2m_price_unit_cur_code,
                     md.m2m_price_unit_weight_unit_id,
                     md.m2m_price_unit_weight_unit,
                     nvl(md.m2m_price_unit_weight, 1) m2m_price_unit_weight,
                     md.m2m_price_unit_cur_code || '/' ||
                     decode(md.m2m_price_unit_weight,
                            1,
                            null,
                            md.m2m_price_unit_weight) ||
                     md.m2m_price_unit_weight_unit m2m_price_unit_str,
                     md.m2m_main_cur_id,
                     md.m2m_main_cur_code,
                     md.m2m_main_cur_decimals,
                     md.main_currency_factor,
                     md.settlement_cur_id,
                     md.settlement_to_val_fx_rate,
                     ceqs.element_id,
                     aml.attribute_name,
                     sam.ash_id assay_header_id,
                     --pcpq.assay_header_id,
                     ceqs.assay_qty,
                     ceqs.assay_qty_unit_id,
                     gmr_qty.payable_qty,
                     gmr_qty.qty_unit_id payable_qty_unit_id,
                     gmr_qum.qty_unit payable_qty_unit,
                     gpd.contract_price,
                     gpd.price_unit_id,
                     gpd.price_unit_weight_unit_id,
                     gpd.price_unit_weight,
                     gpd.price_unit_cur_id,
                     gpd.price_unit_cur_code,
                     gpd.price_unit_weight_unit,
                     gpd.price_fixation_details, -- cipde.price_fixation_details,
                     gpd.price_description, --cipde.price_description,
                     --null payment_due_date, --nvl(cipde.payment_due_date, pd_trade_date) payment_due_date,
                     (case
                       when nvl(pcdi.payment_due_date, pd_trade_date) <
                            pd_trade_date then
                        pd_trade_date
                       else
                        nvl(pcdi.payment_due_date, pd_trade_date)
                     end) payment_due_date,
                     akc.base_cur_id as base_cur_id,
                     akc.base_currency_name base_cur_code,
                     cm.decimals as base_cur_decimal,
                     gmr.inventory_status,
                     gsm.status shipment_status,
                     (case
                       when nvl(dgrd.inventory_status, 'NA') = 'Under CMA' then
                        'UnderCMA NTT'
                       when nvl(dgrd.is_afloat, 'N') = 'Y' and
                            nvl(dgrd.inventory_status, 'NA') in
                            ('In', 'None', 'NA') then
                        'Shipped NTT'
                       when nvl(dgrd.is_afloat, 'N') = 'Y' and
                            nvl(dgrd.inventory_status, 'NA') = 'Out' then
                        'Shipped TT'
                       when nvl(dgrd.is_afloat, 'N') = 'N' and
                            nvl(dgrd.inventory_status, 'NA') in
                            ('In', 'None', 'NA') then
                        'Stock NTT'
                       when nvl(dgrd.is_afloat, 'N') = 'N' and
                            nvl(dgrd.inventory_status, 'NA') = 'Out' then
                        'Stock TT'
                       else
                        'Others'
                     end) section_name,
                     gpd.price_basis, --cipde.price_basis,
                     gmr.shed_id,
                     gmr.destination_city_id,
                     gpd.price_fixation_status, ---cipde.price_fixation_status price_fixation_status,
                     pdm.base_quantity_unit base_qty_unit_id,
                     qum_pdm_conc.qty_unit_id as conc_base_qty_unit_id,
                     qum_pdm_conc.decimals as base_qty_decimal,
                     pcpd.strategy_id,
                     css.strategy_name,
                     md.valuation_exchange_id,
                     md.valuation_month,
                     md.derivative_def_id,
                     nvl(gmr.is_voyage_gmr, 'N') is_voyage_gmr,
                     gmr.contract_type gmr_contract_type,
                     agh.int_alloc_group_id,
                     dgrd.internal_dgrd_ref_no internal_grd_dgrd_ref_no,
                     dgrd.internal_stock_ref_no stock_ref_no,
                     pcm.trader_id,
                     (case
                       when pcm.trader_id is not null then
                        (select gab.firstname || ' ' || gab.lastname
                           from gab_globaladdressbook gab,
                                ak_corporate_user     aku
                          where gab.gabid = aku.gabid
                            and aku.user_id = pcm.trader_id)
                       else
                        ''
                     end) trader_user_name,
                     md.m2m_loc_incoterm_deviation,
                     md.treatment_charge m2m_treatment_charge,
                     md.refine_charge m2m_refine_charge,
                     tc_ppu_pum.price_unit_id m2m_tc_price_unit_id,
                     tc_ppu_pum.price_unit_name m2m_tc_price_unit_name,
                     tc_ppu_pum.cur_id m2m_tc_cur_id,
                     tc_ppu_pum.weight m2m_tc_weight,
                     tc_ppu_pum.weight_unit_id m2m_tc_weight_unit_id,
                     rc_ppu_pum.price_unit_id m2m_rc_price_unit_id,
                     rc_ppu_pum.price_unit_name m2m_rc_price_unit_name,
                     rc_ppu_pum.cur_id m2m_rc_cur_id,
                     rc_ppu_pum.weight m2m_rc_weight,
                     rc_ppu_pum.weight_unit_id m2m_rc_weight_unit_id,
                     md.base_price_unit_id_in_ppu,
                     md.base_price_unit_id_in_pum,
                     qat.eval_basis,
                     pcpq.unit_of_measure,
                     pum_loc_base.weight_unit_id loc_qty_unit_id,
                     tmpc.mvp_id,
                     tmpc.shipment_month,
                     tmpc.shipment_year,
                     pum_base_price_id.price_unit_name base_price_unit_name,
                     nvl(pdm_conc.valuation_against_underlying, 'Y') valuation_against_underlying
                from gmr_goods_movement_record gmr,
                     gpd_gmr_conc_price_daily gpd,
                     dgrd_delivered_grd dgrd,
                     agh_alloc_group_header agh,
                     pcm_physical_contract_main pcm,
                     pcpd_pc_product_definition pcpd,
                     cpc_corporate_profit_center cpc,
                     pdm_productmaster pdm,
                     orm_origin_master orm,
                     (select tmp.*
                        from tmpc_temp_m2m_pre_check tmp
                       where tmp.corporate_id = pc_corporate_id
                         and tmp.product_type = 'CONCENTRATES'
                         and tmp.section_name <> 'OPEN') tmpc,
                     qat_quality_attributes qat,
                     qum_quantity_unit_master qum,
                     (select md1.*
                        from md_m2m_daily md1
                       where md1.rate_type <> 'OPEN'
                         and md1.corporate_id = pc_corporate_id
                         and md1.product_type = 'CONCENTRATES'
                         and md1.process_id = pc_process_id) md,
                     pcdi_pc_delivery_item pcdi,
                     pci_physical_contract_item pci,
                     pcpq_pc_product_quality pcpq,
                     qav_quality_attribute_values qav,
                     ppm_product_properties_mapping ppm,
                     qat_quality_attributes qat_und,
                     aml_attribute_master_list aml,
                     ciqs_contract_item_qty_status ciqs,
                     ak_corporate akc,
                     cm_currency_master cm,
                     gsm_gmr_stauts_master gsm,
                     css_corporate_strategy_setup css,
                     pcdb_pc_delivery_basis pcdb,
                     pdm_productmaster pdm_conc,
                     qum_quantity_unit_master qum_pdm_conc,
                     pum_price_unit_master pum_loc_base,
                     pum_price_unit_master pum_base_price_id,
                     v_gmr_stockpayable_qty gmr_qty,
                     qum_quantity_unit_master gmr_qum,
                     v_ppu_pum tc_ppu_pum,
                     v_ppu_pum rc_ppu_pum,
                     ceqs_contract_ele_qty_status ceqs,
                     sam_stock_assay_mapping sam
               where dgrd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
                 and dgrd.int_alloc_group_id = agh.int_alloc_group_id
                 and gmr.internal_contract_ref_no =
                     pcm.internal_contract_ref_no
                 and pcm.internal_contract_ref_no =
                     pcpd.internal_contract_ref_no
                 and pcpd.profit_center_id = cpc.profit_center_id
                 and dgrd.origin_id = orm.origin_id(+)
                 and dgrd.internal_gmr_ref_no = tmpc.internal_gmr_ref_no(+)
                 and dgrd.internal_grd_ref_no = tmpc.internal_grd_ref_no(+)
                 and dgrd.internal_contract_item_ref_no =
                     tmpc.internal_contract_item_ref_no(+)
                 and tmpc.conc_quality_id = qat.quality_id
                 and dgrd.net_weight_unit_id = qum.qty_unit_id(+)
                 and tmpc.internal_m2m_id = md.md_id(+)
                 and tmpc.element_id = gpd.element_id
                 and md.element_id = gpd.element_id
                 and pcm.internal_contract_ref_no =
                     pcdi.internal_contract_ref_no
                 and pcdi.pcdi_id = pci.pcdi_id
                 and pci.pcpq_id = pcpq.pcpq_id
                 and qat.quality_id = qav.quality_id
                 and qav.attribute_id = ppm.property_id
                 and qav.comp_quality_id = qat_und.quality_id
                 and pcpq.quality_template_id = qat.quality_id
                 and ppm.attribute_id = aml.attribute_id(+)
                 and aml.underlying_product_id = pdm.product_id(+)
                 and aml.attribute_id = gpd.element_id
                 and pcpq.quality_template_id = qat.quality_id(+)
                 and pci.internal_contract_item_ref_no =
                     ciqs.internal_contract_item_ref_no
                 and gmr.corporate_id = akc.corporate_id
                 and akc.base_cur_id = cm.cur_id
                 and cm.cur_code = akc.base_currency_name
                 and gmr.status_id = gsm.status_id(+)
                 and pcpd.strategy_id = css.strategy_id
                 and pci.pcdb_id = pcdb.pcdb_id
                 and pcpd.product_id = pdm_conc.product_id
                 and qum_pdm_conc.qty_unit_id = pdm_conc.base_quantity_unit
                 and md.base_price_unit_id_in_pum =
                     pum_loc_base.price_unit_id
                 and md.base_price_unit_id_in_pum =
                     pum_base_price_id.price_unit_id
                 and md.tc_price_unit_id = tc_ppu_pum.product_price_unit_id
                 and md.rc_price_unit_id = rc_ppu_pum.product_price_unit_id
                 and gmr.internal_gmr_ref_no = gmr_qty.internal_gmr_ref_no
                 and dgrd.internal_dgrd_ref_no = gmr_qty.internal_dgrd_ref_no
                 and gpd.element_id = gmr_qty.element_id
                 and gmr_qty.qty_unit_id = gmr_qum.qty_unit_id
                 and pci.internal_contract_item_ref_no =
                     ceqs.internal_contract_item_ref_no
                 and aml.attribute_id = ceqs.element_id
                 and pcm.purchase_sales = 'S'
                 and gsm.is_required_for_m2m = 'Y'
                 and pcm.contract_status = 'In Position'
                 and pcm.contract_type = 'CONCENTRATES'
                 and pcpd.input_output = 'Input'
                 and pcm.is_tolling_contract = 'N'
                 and pcm.is_tolling_extn = 'N'
                 and pci.is_active = 'Y'
                 and pcm.is_active = 'Y'
                 and pcpd.is_active = 'Y'
                 and pcpq.is_active = 'Y'
                 and pcdi.is_active = 'Y'
                 and pcdb.is_active = 'Y'
                 and gmr.is_deleted = 'N'
                 and ppm.is_active = 'Y'
                 and ppm.is_deleted = 'N'
                 and qav.is_deleted = 'N'
                 and qav.is_comp_product_attribute = 'Y'
                 and qat.is_active = 'Y'
                 and qat.is_deleted = 'N'
                 and aml.is_active = 'Y'
                 and aml.is_deleted = 'N'
                 and qat_und.is_active = 'Y'
                 and qat_und.is_deleted = 'N'
                 and pcm.process_id = pc_process_id
                 and pcdi.process_id = pc_process_id
                 and pci.process_id = pc_process_id
                 and gmr.process_id = pc_process_id
                 and dgrd.process_id = pc_process_id
                 and agh.process_id = pc_process_id
                 and pcpd.process_id = pc_process_id
                 and gpd.process_id = pc_process_id
                 and pcpq.process_id = pc_process_id
                 and ciqs.process_id = pc_process_id
                 and pcdb.process_id = pc_process_id
                 and gmr_qty.process_id = pc_process_id
                 and ceqs.process_id = pc_process_id
                    --and upper(dgrd.realized_status) in ('UNREALIZED', 'REALIZED', 'REVERSEREALIZED')
                 and dgrd.status = 'Active'
                 and nvl(dgrd.net_weight, 0) > 0
                 and agh.is_deleted = 'N'
                 and gmr.corporate_id = pc_corporate_id
                 and gmr.is_internal_movement = 'N'
                 and dgrd.internal_dgrd_ref_no = sam.internal_dgrd_ref_no
                 and sam.is_latest_position_assay = 'Y') tt;
  
    vn_cont_price               number;
    vc_cont_price_unit_id       varchar2(15);
    vc_cont_price_unit_cur_id   varchar2(15);
    vc_cont_price_unit_cur_code varchar2(15);
    vn_cont_price_wt            number;
    vc_cont_price_wt_unit_id    varchar2(15);
    vc_cont_price_wt_unit       varchar2(15);
    vc_price_fixation_status    varchar2(50);
    vc_psu_id                   varchar2(500);
    vn_qty_in_base              number;
    vn_ele_qty_in_base          number;
    vn_m2m_amt                  number;
    vc_m2m_price_unit_cur_id    varchar2(15);
    vc_m2m_cur_id               varchar2(15);
    vc_m2m_cur_code             varchar2(15);
    vn_m2m_sub_cur_id_factor    number;
    vn_m2m_cur_decimals         number;
    vn_m2m_base_fx_rate         number;
    vn_m2m_base_deviation       number;
    vn_ele_m2m_amount_in_base   number;
    vobj_error_log              tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count          number := 1;
    --vn_m2m_total_premium_amt       number;
    vn_ele_m2m_total_amount        number;
    vn_ele_m2m_amt_per_unit        number;
    vc_price_cur_id                varchar2(15);
    vc_price_cur_code              varchar2(15);
    vn_cont_price_cur_id_factor    number;
    vn_contract_value_in_price_cur number;
    vn_cont_price_cur_decimals     number;
    vn_fx_price_to_base            number;
    vn_fx_price_deviation          number;
    vn_contract_value_in_val_cur   number;
    vn_contract_value_in_base_cur  number;
    vn_ele_m2m_treatment_charge    number;
    vn_dry_qty                     number;
    vn_wet_qty                     number;
    vn_dry_qty_in_base             number;
    vn_ele_m2m_refine_charge       number;
    vn_loc_amount                  number;
    vn_loc_total_amount            number;
    vn_total_penality              number;
    vn_penality                    number;
    vc_penality_price_unit_id      varchar2(15);
    vc_price_unit_id               varchar2(15);
  begin
  
    for cur_grd_rows in cur_grd
    loop
      vn_cont_price               := 0;
      vc_cont_price_unit_id       := null;
      vc_cont_price_unit_cur_id   := null;
      vc_cont_price_unit_cur_code := null;
      vn_cont_price_wt            := 1;
      vc_cont_price_wt_unit_id    := null;
      vc_cont_price_wt_unit       := null;
      vc_price_fixation_status    := null;
    
      /* if cur_grd_rows.gmr_price is null then
        vn_cont_price               := cur_grd_rows.contract_price;
        vc_cont_price_unit_id       := cur_grd_rows.price_unit_id;
        vc_cont_price_unit_cur_id   := cur_grd_rows.price_unit_cur_id;
        vc_cont_price_unit_cur_code := cur_grd_rows.price_unit_cur_code;
        vn_cont_price_wt            := cur_grd_rows.price_unit_weight;
        vc_cont_price_wt_unit_id    := cur_grd_rows.price_unit_weight_unit_id;
        vc_cont_price_wt_unit       := cur_grd_rows.price_unit_weight_unit;
        vc_price_fixation_status    := cur_grd_rows.price_fixation_status;
      
      else
        vn_cont_price               := cur_grd_rows.gmr_price;
        vc_cont_price_unit_id       := cur_grd_rows.gmr_price_unit_id;
        vc_cont_price_unit_cur_id   := cur_grd_rows.gmr_price_cur_id;
        vc_cont_price_unit_cur_code := cur_grd_rows.gmr_price_cur_code;
        vn_cont_price_wt            := cur_grd_rows.gmr_price_wt;
        vc_cont_price_wt_unit_id    := cur_grd_rows.gmr_price_wt_unit_id;
        vc_cont_price_wt_unit       := cur_grd_rows.gmr_price_wt_unit;
        vc_price_fixation_status    := cur_grd_rows.gmr_price_fixation_status;
      end if;*/
    
      vn_cont_price               := cur_grd_rows.contract_price;
      vc_cont_price_unit_id       := cur_grd_rows.price_unit_id;
      vc_cont_price_unit_cur_id   := cur_grd_rows.price_unit_cur_id;
      vc_cont_price_unit_cur_code := cur_grd_rows.price_unit_cur_code;
      vn_cont_price_wt            := cur_grd_rows.price_unit_weight;
      vc_cont_price_wt_unit_id    := cur_grd_rows.price_unit_weight_unit_id;
      vc_cont_price_wt_unit       := cur_grd_rows.price_unit_weight_unit;
      vc_price_fixation_status    := cur_grd_rows.price_fixation_status;
    
      if cur_grd_rows.stock_qty <> 0 then
        vc_psu_id := cur_grd_rows.internal_gmr_ref_no || '-' ||
                     cur_grd_rows.internal_grd_dgrd_ref_no || '-' ||
                     cur_grd_rows.internal_contract_item_ref_no || '-' ||
                     cur_grd_rows.container_no;
      
        if cur_grd_rows.unit_of_measure = 'Wet' then
          vn_dry_qty := round(pkg_metals_general.fn_get_assay_dry_qty(cur_grd_rows.conc_product_id,
                                                                      cur_grd_rows.assay_header_id,
                                                                      cur_grd_rows.stock_qty,
                                                                      cur_grd_rows.qty_unit_id),
                              cur_grd_rows.stocky_qty_decimal);
        else
          vn_dry_qty := cur_grd_rows.stock_qty;
        end if;
      
        vn_wet_qty := cur_grd_rows.stock_qty;
      
        -- convert into dry qty to base qty element level
      
        vn_dry_qty_in_base := round(pkg_general.f_get_converted_quantity(cur_grd_rows.conc_product_id,
                                                                         cur_grd_rows.qty_unit_id,
                                                                         cur_grd_rows.base_qty_unit_id,
                                                                         1) *
                                    vn_dry_qty,
                                    cur_grd_rows.base_qty_decimal);
      
        vn_qty_in_base := round(cur_grd_rows.stock_qty *
                                pkg_general.f_get_converted_quantity(cur_grd_rows.conc_product_id,
                                                                     cur_grd_rows.qty_unit_id,
                                                                     cur_grd_rows.conc_base_qty_unit_id,
                                                                     1),
                                cur_grd_rows.base_qty_decimal);
      
        vn_ele_qty_in_base := round(pkg_general.f_get_converted_quantity(cur_grd_rows.product_id,
                                                                         cur_grd_rows.payable_qty_unit_id,
                                                                         cur_grd_rows.base_qty_unit_id,
                                                                         1) *
                                    cur_grd_rows.payable_qty,
                                    cur_grd_rows.base_qty_decimal);
        if cur_grd_rows.valuation_against_underlying = 'Y' then
          if cur_grd_rows.eval_basis = 'FIXED' then
            vn_m2m_amt               := 0;
            vc_m2m_price_unit_cur_id := cur_grd_rows.base_cur_id;
          else
            vc_m2m_price_unit_cur_id := nvl(cur_grd_rows.m2m_price_unit_cur_id,
                                            cur_grd_rows.base_cur_id);
            vn_m2m_amt               := nvl(cur_grd_rows.net_m2m_price, 0) /
                                        nvl(cur_grd_rows.m2m_price_unit_weight,
                                            1) *
                                        pkg_general.f_get_converted_quantity(cur_grd_rows.product_id,
                                                                             cur_grd_rows.payable_qty_unit_id,
                                                                             cur_grd_rows.m2m_price_unit_weight_unit_id,
                                                                             cur_grd_rows.payable_qty);
          end if;
        
          pkg_general.sp_get_main_cur_detail(nvl(vc_m2m_price_unit_cur_id,
                                                 cur_grd_rows.base_cur_id),
                                             vc_m2m_cur_id,
                                             vc_m2m_cur_code,
                                             vn_m2m_sub_cur_id_factor,
                                             vn_m2m_cur_decimals);
        
          vn_m2m_amt := round(vn_m2m_amt * vn_m2m_sub_cur_id_factor,
                              cur_grd_rows.base_cur_decimal);
        
          pkg_general.sp_forward_cur_exchange_new(cur_grd_rows.corporate_id,
                                                  pd_trade_date,
                                                  cur_grd_rows.payment_due_date,
                                                  nvl(vc_m2m_cur_id,
                                                      cur_grd_rows.base_cur_id),
                                                  cur_grd_rows.base_cur_id,
                                                  30,
                                                  vn_m2m_base_fx_rate,
                                                  vn_m2m_base_deviation);
        
          if vc_m2m_cur_id <> cur_grd_rows.base_cur_id then
            if vn_m2m_base_fx_rate is null or vn_m2m_base_fx_rate = 0 then
              vobj_error_log.extend;
              vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                   'procedure pkg_phy_physical_process-sp_calc_phy_open_unrealized ',
                                                                   'PHY-005',
                                                                   cur_grd_rows.base_cur_code ||
                                                                   ' to ' ||
                                                                   vc_m2m_cur_code || ' (' ||
                                                                   to_char(cur_grd_rows.payment_due_date,
                                                                           'dd-Mon-yyyy') || ') ',
                                                                   '',
                                                                   gvc_process,
                                                                   pc_user_id,
                                                                   sysdate,
                                                                   pd_trade_date);
              sp_insert_error_log(vobj_error_log);
            
            end if;
          end if;
        
          vn_ele_m2m_amount_in_base := vn_m2m_amt * vn_m2m_base_fx_rate;
        else
          --if valuation against underly is no, then use total concentrate qty and market price to calculate the
          --market value for the gmr level.
          if cur_grd_rows.eval_basis = 'FIXED' then
            vn_m2m_amt               := 0;
            vc_m2m_price_unit_cur_id := cur_grd_rows.base_cur_id;
          else
            vc_m2m_price_unit_cur_id := nvl(cur_grd_rows.m2m_price_unit_cur_id,
                                            cur_grd_rows.base_cur_id);
            vn_m2m_amt               := nvl(cur_grd_rows.net_m2m_price, 0) /
                                        nvl(cur_grd_rows.m2m_price_unit_weight,
                                            1) *
                                        pkg_general.f_get_converted_quantity(cur_grd_rows.conc_product_id,
                                                                             cur_grd_rows.conc_base_qty_unit_id,
                                                                             cur_grd_rows.m2m_price_unit_weight_unit_id,
                                                                             vn_dry_qty_in_base);
          end if;
        
          pkg_general.sp_get_main_cur_detail(nvl(vc_m2m_price_unit_cur_id,
                                                 cur_grd_rows.base_cur_id),
                                             vc_m2m_cur_id,
                                             vc_m2m_cur_code,
                                             vn_m2m_sub_cur_id_factor,
                                             vn_m2m_cur_decimals);
        
          vn_m2m_amt := round(vn_m2m_amt * vn_m2m_sub_cur_id_factor,
                              cur_grd_rows.base_cur_decimal);
        
          pkg_general.sp_forward_cur_exchange_new(cur_grd_rows.corporate_id,
                                                  pd_trade_date,
                                                  cur_grd_rows.payment_due_date,
                                                  nvl(vc_m2m_cur_id,
                                                      cur_grd_rows.base_cur_id),
                                                  cur_grd_rows.base_cur_id,
                                                  30,
                                                  vn_m2m_base_fx_rate,
                                                  vn_m2m_base_deviation);
        
          if vc_m2m_cur_id <> cur_grd_rows.base_cur_id then
            if vn_m2m_base_fx_rate is null or vn_m2m_base_fx_rate = 0 then
              vobj_error_log.extend;
              vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                   'procedure pkg_phy_physical_process-sp_calc_phy_open_unrealized ',
                                                                   'PHY-005',
                                                                   cur_grd_rows.base_cur_code ||
                                                                   ' to ' ||
                                                                   vc_m2m_cur_code || ' (' ||
                                                                   to_char(cur_grd_rows.payment_due_date,
                                                                           'dd-Mon-yyyy') || ') ',
                                                                   '',
                                                                   gvc_process,
                                                                   pc_user_id,
                                                                   sysdate,
                                                                   pd_trade_date);
              sp_insert_error_log(vobj_error_log);
            
            end if;
          end if;
          if cur_grd_rows.ele_rank = 1 then
            vn_ele_m2m_amount_in_base := vn_m2m_amt * vn_m2m_base_fx_rate;
          else
            vn_ele_m2m_amount_in_base := 0;
            vn_m2m_amt                := 0;
          end if;
        
        end if;
        /*  vn_ele_m2m_treatment_charge := round(cur_grd_rows.m2m_treatment_charge *
                                             vn_dry_qty_in_base,
                                             cur_grd_rows.base_cur_decimal);
        vn_ele_m2m_refine_charge    := round(cur_grd_rows.m2m_refine_charge *
                                             vn_ele_qty_in_base,
                                             cur_grd_rows.base_cur_decimal);*/
      
        vn_ele_m2m_treatment_charge := round((cur_grd_rows.m2m_treatment_charge /
                                             nvl(cur_grd_rows.m2m_tc_weight,
                                                  1)) *
                                             pkg_general.f_get_converted_currency_amt(pc_corporate_id,
                                                                                      cur_grd_rows.m2m_tc_cur_id,
                                                                                      cur_grd_rows.base_cur_id,
                                                                                      pd_trade_date,
                                                                                      1) *
                                             (pkg_general.f_get_converted_quantity(cur_grd_rows.conc_product_id,
                                                                                   cur_grd_rows.qty_unit_id,
                                                                                   cur_grd_rows.m2m_tc_weight_unit_id,
                                                                                   vn_dry_qty)),
                                             cur_grd_rows.base_cur_decimal);
      
        vn_ele_m2m_refine_charge := round((cur_grd_rows.m2m_refine_charge /
                                          nvl(cur_grd_rows.m2m_rc_weight,
                                               1)) *
                                          pkg_general.f_get_converted_currency_amt(pc_corporate_id,
                                                                                   cur_grd_rows.m2m_rc_cur_id,
                                                                                   cur_grd_rows.base_cur_id,
                                                                                   pd_trade_date,
                                                                                   1) *
                                          (pkg_general.f_get_converted_quantity(cur_grd_rows.product_id,
                                                                                cur_grd_rows.payable_qty_unit_id,
                                                                                cur_grd_rows.m2m_rc_weight_unit_id,
                                                                                cur_grd_rows.payable_qty)),
                                          cur_grd_rows.base_cur_decimal);
      
        if cur_grd_rows.ele_rank = 1 then
          vn_loc_amount := round(pkg_general.f_get_converted_quantity(cur_grd_rows.conc_product_id,
                                                                      cur_grd_rows.loc_qty_unit_id,
                                                                      cur_grd_rows.conc_base_qty_unit_id,
                                                                      1) *
                                 cur_grd_rows.m2m_loc_incoterm_deviation,
                                 cur_grd_rows.base_cur_decimal);
        
          vn_loc_total_amount := round(vn_loc_amount * vn_qty_in_base,
                                       cur_grd_rows.base_cur_decimal);
        end if;
        vn_total_penality := 0;
        if cur_grd_rows.ele_rank = 1 then
          begin
            select ppu.product_price_unit_id
              into vc_price_unit_id
              from v_ppu_pum         ppu,
                   pdm_productmaster pdm,
                   ak_corporate      akc
             where ppu.product_id = cur_grd_rows.conc_product_id
               and ppu.product_id = pdm.product_id
               and pdm.base_quantity_unit = ppu.weight_unit_id
               and ppu.cur_id = akc.base_cur_id
               and nvl(ppu.weight, 1) = 1
               and akc.corporate_id = pc_corporate_id;
          
          exception
            when no_data_found then
              vc_price_unit_id := null;
          end;
        
          vn_total_penality := 0;
          for cc in (select pci.internal_contract_item_ref_no,
                            pqca.element_id,
                            pcpq.quality_template_id
                       from pci_physical_contract_item  pci,
                            pcpq_pc_product_quality     pcpq,
                            ash_assay_header            ash,
                            asm_assay_sublot_mapping    asm,
                            pqca_pq_chemical_attributes pqca
                      where pci.pcpq_id = pcpq.pcpq_id
                        and pcpq.assay_header_id = ash.ash_id
                        and ash.ash_id = asm.ash_id
                        and asm.asm_id = pqca.asm_id
                        and pci.process_id = pc_process_id
                        and pcpq.process_id = pc_process_id
                        and pci.is_active = 'Y'
                        and pcpq.is_active = 'Y'
                        and ash.is_active = 'Y'
                        and asm.is_active = 'Y'
                        and pqca.is_active = 'Y'
                        and pqca.is_elem_for_pricing = 'N'
                        and pqca.is_deductible = 'N'
                        and pci.internal_contract_item_ref_no =
                            cur_grd_rows.internal_contract_item_ref_no)
          loop
          
            pkg_phy_pre_check_process.sp_calc_m2m_tc_pc_rc_charge(cur_grd_rows.corporate_id,
                                                                  pd_trade_date,
                                                                  cur_grd_rows.conc_product_id,
                                                                  cur_grd_rows.conc_quality_id,
                                                                  cur_grd_rows.mvp_id,
                                                                  'Penalties',
                                                                  cc.element_id,
                                                                  cur_grd_rows.shipment_month,
                                                                  cur_grd_rows.shipment_year,
                                                                  vc_price_unit_id,
                                                                  vn_penality,
                                                                  vc_penality_price_unit_id);
            if nvl(vn_penality, 0) <> 0 then
              vn_total_penality := round(vn_total_penality +
                                         (vn_penality * vn_dry_qty_in_base),
                                         cur_grd_rows.base_cur_decimal);
            end if;
          
          end loop;
        
        end if;
      
        vn_ele_m2m_total_amount := vn_ele_m2m_amount_in_base -
                                   vn_ele_m2m_treatment_charge -
                                   vn_ele_m2m_refine_charge;
      
        vn_ele_m2m_amt_per_unit := round(vn_ele_m2m_total_amount /
                                         vn_ele_qty_in_base,
                                         cur_grd_rows.base_cur_decimal);
      
        pkg_general.sp_get_main_cur_detail(nvl(vc_cont_price_unit_cur_id,
                                               cur_grd_rows.base_cur_id),
                                           vc_price_cur_id,
                                           vc_price_cur_code,
                                           vn_cont_price_cur_id_factor,
                                           vn_cont_price_cur_decimals);
      
        if nvl(vn_cont_price, 0) <> 0 and
           vc_cont_price_wt_unit_id is not null then
        
          vn_contract_value_in_price_cur := (vn_cont_price /
                                            nvl(vn_cont_price_wt, 1)) *
                                            (pkg_general.f_get_converted_quantity(cur_grd_rows.product_id,
                                                                                  cur_grd_rows.qty_unit_id,
                                                                                  vc_cont_price_wt_unit_id,
                                                                                  cur_grd_rows.stock_qty)) *
                                            vn_cont_price_cur_id_factor;
        else
          vn_contract_value_in_price_cur := 0;
        end if;
      
        pkg_general.sp_forward_cur_exchange_new(cur_grd_rows.corporate_id,
                                                pd_trade_date,
                                                cur_grd_rows.payment_due_date,
                                                vc_price_cur_id,
                                                cur_grd_rows.base_cur_id,
                                                30,
                                                vn_fx_price_to_base,
                                                vn_fx_price_deviation);
      
        vn_contract_value_in_price_cur := round(vn_contract_value_in_price_cur,
                                                vn_cont_price_cur_decimals);
      
        vn_contract_value_in_val_cur  := round((vn_contract_value_in_price_cur *
                                               nvl(vn_fx_price_to_base, 1)),
                                               cur_grd_rows.base_cur_decimal);
        vn_contract_value_in_base_cur := vn_contract_value_in_val_cur;
      end if;
    
      insert into psue_element_details
        (corporate_id,
         process_id,
         internal_contract_item_ref_no,
         psu_id,
         internal_gmr_ref_no,
         element_id,
         element_name,
         assay_header_id,
         assay_qty,
         assay_qty_unit_id,
         payable_qty,
         payable_qty_unit_id,
         payable_qty_unit,
         contract_price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         price_unit_weight_unit_id,
         price_unit_weight,
         price_unit_weight_unit,
         md_id,
         m2m_price,
         m2m_price_cur_id,
         m2m_price_cur_code,
         m2m_price_weight_unit_id,
         m2m_price_weight_unit,
         m2m_price_weight_unit_weight,
         m2m_refining_charge,
         m2m_treatment_charge,
         pricing_details,
         m2m_price_unit_id,
         m2m_price_unit_str,
         m2m_amt,
         m2m_amt_cur_id,
         m2m_amt_cur_code,
         contract_value_in_price_cur,
         contract_price_cur_id,
         contract_price_cur_code,
         material_cost_in_base_cur,
         element_qty_in_base_unit,
         total_m2m_amount,
         m2m_amt_per_unit,
         price_cur_to_base_cur_fx_rate,
         m2m_cur_to_base_cur_fx_rate,
         base_price_unit_id_in_ppu,
         base_price_unit_id_in_pum,
         valuation_against_underlying,
         internal_grd_dgrd_ref_no)
      values
        (cur_grd_rows.corporate_id,
         pc_process_id,
         cur_grd_rows.internal_contract_item_ref_no,
         vc_psu_id,
         cur_grd_rows.internal_gmr_ref_no,
         cur_grd_rows.element_id,
         cur_grd_rows.attribute_name,
         cur_grd_rows.assay_header_id,
         cur_grd_rows.assay_qty,
         cur_grd_rows.assay_qty_unit_id,
         cur_grd_rows.payable_qty,
         cur_grd_rows.payable_qty_unit_id,
         cur_grd_rows.payable_qty_unit,
         vn_cont_price,
         vc_cont_price_unit_id,
         vc_cont_price_unit_cur_id,
         vc_cont_price_unit_cur_code,
         vc_cont_price_wt_unit_id,
         vn_cont_price_wt,
         vc_cont_price_wt_unit,
         cur_grd_rows.md_id,
         cur_grd_rows.net_m2m_price,
         cur_grd_rows.m2m_price_unit_cur_id,
         cur_grd_rows.m2m_price_unit_cur_code,
         cur_grd_rows.m2m_price_unit_weight_unit_id,
         cur_grd_rows.m2m_price_unit_weight_unit,
         decode(cur_grd_rows.m2m_price_unit_weight,
                1,
                null,
                cur_grd_rows.m2m_price_unit_weight),
         vn_ele_m2m_refine_charge,
         vn_ele_m2m_treatment_charge,
         cur_grd_rows.price_description,
         cur_grd_rows.m2m_price_unit_id,
         cur_grd_rows.m2m_price_unit_str,
         vn_m2m_amt, --m2m_amt
         cur_grd_rows.base_cur_id,
         cur_grd_rows.base_cur_code,
         vn_contract_value_in_price_cur,
         vc_price_cur_id,
         vc_price_cur_code,
         vn_contract_value_in_base_cur,
         vn_ele_qty_in_base,
         vn_ele_m2m_total_amount, --total_m2m_amount,
         vn_ele_m2m_amt_per_unit, --m2m_amt_per_unit,
         vn_fx_price_to_base, --price_cur_to_base_cur_fx_rate,   
         vn_m2m_base_fx_rate, --m2m_cur_to_base_cur_fx_rate,
         cur_grd_rows.base_price_unit_id_in_ppu, --base_price_unit_id_in_ppu,
         cur_grd_rows.base_price_unit_id_in_pum, --base_price_unit_id_in_pum)*/
         cur_grd_rows.valuation_against_underlying,
         cur_grd_rows.internal_grd_dgrd_ref_no);
    
      if cur_grd_rows.ele_rank = 1 then
        insert into psue_phy_stock_unrealized_ele
          (process_id,
           psu_id,
           corporate_id,
           corporate_name,
           internal_gmr_ref_no,
           internal_contract_item_ref_no,
           contract_ref_no,
           delivery_item_no,
           del_distribution_item_no,
           product_id,
           product_name,
           origin_id,
           origin_name,
           quality_id,
           quality_name,
           container_no,
           stock_wet_qty,
           stock_dry_qty,
           qty_unit_id,
           qty_unit,
           qty_in_base_unit,
           no_of_units,
           prod_base_qty_unit_id,
           prod_base_qty_unit,
           inventory_status,
           shipment_status,
           section_name,
           strategy_id,
           strategy_name,
           valuation_month,
           contract_type,
           profit_center_id,
           profit_center_name,
           profit_center_short_name,
           valuation_exchange_id,
           derivative_def_id,
           gmr_contract_type,
           is_voyage_gmr,
           gmr_ref_no,
           warehouse_id,
           warehouse_name,
           shed_id,
           shed_name,
           int_alloc_group_id,
           internal_grd_dgrd_ref_no,
           price_type_id,
           fixation_method,
           price_fixation_details,
           stock_ref_no,
           trader_name,
           trader_id,
           contract_qty_string,
           contract_price_string,
           m2m_price_string,
           m2m_rc_tc_string,
           m2m_penalty_charge,
           m2m_treatment_charge,
           m2m_refining_charge,
           m2m_loc_diff_premium,
           net_contract_value_in_base_cur,
           net_m2m_amount_in_base_cur,
           prev_net_m2m_amt_in_base_cur,
           pnl_type,
           pnl_in_base_cur,
           pnl_in_per_base_unit,
           prev_day_pnl_in_base_cur,
           prev_day_pnl_per_base_unit,
           trade_day_pnl_in_base_cur,
           trade_day_pnl_per_base_unit,
           cont_unr_status,
           prev_m2m_price_string,
           prev_m2m_rc_tc_string,
           prev_m2m_penalty_charge,
           prev_m2m_treatment_charge,
           prev_m2m_refining_charge,
           prev_m2m_loc_diff_premium,
           base_price_unit_id,
           base_price_unit_name,
           base_cur_id,
           base_cur_code,
           valuation_against_underlying)
        values
          (pc_process_id,
           vc_psu_id,
           cur_grd_rows.corporate_id,
           cur_grd_rows.corporate_name,
           cur_grd_rows.internal_gmr_ref_no,
           cur_grd_rows.internal_contract_item_ref_no,
           cur_grd_rows.contract_ref_no,
           cur_grd_rows.delivery_item_no,
           cur_grd_rows.del_distribution_item_no,
           cur_grd_rows.conc_product_id,
           cur_grd_rows.conc_product_name,
           cur_grd_rows.origin_id,
           cur_grd_rows.origin_name,
           cur_grd_rows.conc_quality_id,
           cur_grd_rows.conc_quality_name,
           cur_grd_rows.container_no,
           vn_wet_qty,
           vn_dry_qty,
           cur_grd_rows.qty_unit_id,
           cur_grd_rows.qty_unit,
           vn_qty_in_base,
           cur_grd_rows.no_of_units,
           null, --prod_base_qty_unit_id
           null, --prod_base_qty_unit
           cur_grd_rows.inventory_status,
           cur_grd_rows.shipment_status,
           cur_grd_rows.section_name,
           cur_grd_rows.strategy_id,
           cur_grd_rows.strategy_name,
           cur_grd_rows.valuation_month,
           cur_grd_rows.purchase_sales,
           cur_grd_rows.profit_center,
           cur_grd_rows.profit_center_name,
           cur_grd_rows.profit_center_short_name,
           cur_grd_rows.valuation_exchange_id,
           cur_grd_rows.derivative_def_id,
           cur_grd_rows.gmr_contract_type,
           cur_grd_rows.is_voyage_gmr,
           null, --gmr_ref_no
           null, --warehouse_id,
           null, --warehouse_name,
           null, --shed_id,
           null, --shed_name
           cur_grd_rows.int_alloc_group_id,
           cur_grd_rows.internal_grd_dgrd_ref_no,
           cur_grd_rows.price_basis,
           vc_price_fixation_status,
           cur_grd_rows.price_fixation_details,
           cur_grd_rows.stock_ref_no,
           cur_grd_rows.trader_user_name,
           cur_grd_rows.trader_id,
           null, --contract_qty_string,
           null, --contract_price_string,  
           null, --m2m_price_string,   
           null, --m2m_rc_tc_string,
           vn_total_penality, --m2m_penalty_charge,
           null, --m2m_treatment_charge,
           null, --m2m_refining_charge,
           vn_loc_total_amount, --m2m_loc_diff_premium,
           null, --net_contract_value_in_base_cur, 
           null, --net_m2m_amount_in_base_cur,
           null, --prev_net_m2m_amt_in_base_cur,
           'Unrealized',
           null, --pnl_in_base_cur,
           null, --pnl_in_per_base_unit,
           null, --prev_day_pnl_in_base_cur,
           null, --prev_day_pnl_per_base_unit,
           null, --trade_day_pnl_in_base_cur,
           null, --trade_day_pnl_per_base_unit,
           null, --cont_unr_status,
           null, --prev_m2m_price_string,    
           null, --prev_m2m_rc_tc_string,
           null, --prev_m2m_penalty_charge, 
           null, --prev_m2m_treatment_charge, 
           null, --prev_m2m_refining_charge, 
           null, --prev_m2m_loc_diff_premium,
           cur_grd_rows.base_price_unit_id_in_ppu,
           cur_grd_rows.base_price_unit_name,
           cur_grd_rows.base_cur_id,
           cur_grd_rows.base_cur_code,
           cur_grd_rows.valuation_against_underlying);
      end if;
    end loop;
  
    for cur_update_pnl in (select psue.psu_id,
                                  sum(psue.material_cost_in_base_cur) net_contract_value_in_base_cur,
                                  sum(psue.m2m_amt) net_m2m_amt,
                                  sum(psue.m2m_treatment_charge) net_m2m_treatment_charge,
                                  sum(psue.m2m_refining_charge) net_m2m_refining_charge,
                                  stragg(psue.element_name || '-' ||
                                         psue.payable_qty || ' ' ||
                                         psue.payable_qty_unit) contract_qty_string,
                                  stragg(psue.element_name || '-' ||
                                         psue.contract_price || ' ' ||
                                         psue.price_unit_cur_code || '/' ||
                                         psue.price_unit_weight ||
                                         psue.price_unit_weight_unit) contract_price_string,
                                  (case
                                     when psue.valuation_against_underlying = 'N' then
                                      max((case
                                     when nvl(psue.m2m_price, 0) <> 0 then
                                      (psue.m2m_price || ' ' ||
                                      psue.m2m_price_cur_code || '/' ||
                                      psue.m2m_price_weight_unit_weight ||
                                      psue.m2m_price_weight_unit)
                                     else
                                      null
                                   end)) else stragg((case
                                    when nvl(psue.m2m_price,
                                             0) <> 0 then
                                     (psue.element_name || '-' ||
                                     psue.m2m_price || ' ' ||
                                     psue.m2m_price_cur_code || '/' ||
                                     psue.m2m_price_weight_unit_weight ||
                                     psue.m2m_price_weight_unit)
                                    else
                                     null
                                  end)) end) m2m_price_string, -- TODO if underly valuation = n, show the concentrate price
                                  stragg('TC:' || psue.element_name || '-' ||
                                         psue.m2m_treatment_charge || ' ' ||
                                         psue.price_unit_cur_code || ' ' ||
                                         'RC:' || psue.element_name || '-' ||
                                         psue.m2m_refining_charge || ' ' ||
                                         psue.price_unit_cur_code) m2m_rc_tc_pen_string
                             from psue_element_details psue
                            where psue.corporate_id = pc_corporate_id
                              and psue.process_id = pc_process_id
                            group by psue.psu_id,
                                     psue.valuation_against_underlying)
    loop
    
      update psue_phy_stock_unrealized_ele psuee
         set psuee.net_contract_value_in_base_cur = cur_update_pnl.
                                                    net_contract_value_in_base_cur,
             psuee.net_m2m_amount                 = cur_update_pnl.net_m2m_amt,
             psuee.m2m_treatment_charge           = cur_update_pnl.net_m2m_treatment_charge,
             psuee.m2m_refining_charge            = cur_update_pnl.net_m2m_refining_charge,
             psuee.contract_price_string          = cur_update_pnl.contract_price_string,
             psuee.m2m_price_string               = cur_update_pnl.m2m_price_string,
             psuee.m2m_rc_tc_string               = cur_update_pnl.m2m_rc_tc_pen_string,
             psuee.contract_qty_string            = cur_update_pnl.contract_qty_string
       where psuee.psu_id = cur_update_pnl.psu_id
         and psuee.process_id = pc_process_id
         and psuee.corporate_id = pc_corporate_id;
    end loop;
  
    update psue_phy_stock_unrealized_ele psuee
       set psuee.net_m2m_amount_in_base_cur = (psuee.net_m2m_amount -
                                              psuee.m2m_treatment_charge -
                                              psuee.m2m_refining_charge -
                                              psuee.m2m_penalty_charge +
                                              psuee.m2m_loc_diff_premium)
     where psuee.corporate_id = pc_corporate_id
       and psuee.process_id = pc_process_id;
  
    --- previous EOD Data
    for cur_update in (select psue_prev_day.net_m2m_amount_in_base_cur,
                              psue_prev_day.net_m2m_amount,
                              psue_prev_day.pnl_in_per_base_unit,
                              psue_prev_day.m2m_price_string,
                              psue_prev_day.m2m_rc_tc_string,
                              psue_prev_day.m2m_penalty_charge,
                              psue_prev_day.m2m_treatment_charge,
                              psue_prev_day.m2m_refining_charge,
                              psue_prev_day.m2m_loc_diff_premium,
                              psue_prev_day.qty_in_base_unit,
                              psue_prev_day.psu_id
                         from psue_phy_stock_unrealized_ele psue_prev_day
                        where process_id = gvc_previous_process_id
                          and corporate_id = pc_corporate_id)
    loop
      update psue_phy_stock_unrealized_ele psue_today
         set psue_today.prev_net_m2m_amt_in_base_cur = cur_update.net_m2m_amount_in_base_cur,
             psue_today.prev_day_pnl_in_base_cur     = cur_update.pnl_in_per_base_unit *
                                                       psue_today.qty_in_base_unit,
             psue_today.prev_net_m2m_amount          = cur_update.net_m2m_amount,
             psue_today.prev_day_pnl_per_base_unit   = cur_update.pnl_in_per_base_unit,
             psue_today.prev_m2m_price_string        = cur_update.m2m_price_string,
             psue_today.prev_m2m_rc_tc_string        = cur_update.m2m_rc_tc_string,
             psue_today.prev_m2m_penalty_charge      = cur_update.m2m_penalty_charge,
             psue_today.prev_m2m_treatment_charge    = cur_update.m2m_treatment_charge,
             psue_today.prev_m2m_refining_charge     = cur_update.m2m_refining_charge,
             psue_today.prev_m2m_loc_diff_premium    = cur_update.m2m_loc_diff_premium,
             psue_today.cont_unr_status              = 'EXISTING_TRADE'
       where psue_today.process_id = pc_process_id
         and psue_today.corporate_id = pc_corporate_id
         and psue_today.psu_id = cur_update.psu_id;
    end loop;
  
    begin
      update psue_phy_stock_unrealized_ele psue
         set psue.prev_net_m2m_amt_in_base_cur = psue.net_m2m_amount_in_base_cur,
             psue.prev_day_pnl_in_base_cur     = 0,
             psue.prev_day_pnl_per_base_unit   = 0,
             psue.prev_net_m2m_amount          = psue.net_m2m_amount,
             psue.prev_m2m_price_string        = psue.m2m_price_string,
             psue.prev_m2m_rc_tc_string        = psue.m2m_rc_tc_string,
             psue.prev_m2m_penalty_charge      = psue.m2m_penalty_charge,
             psue.prev_m2m_treatment_charge    = psue.m2m_treatment_charge,
             psue.prev_m2m_refining_charge     = psue.m2m_refining_charge,
             psue.prev_m2m_loc_diff_premium    = psue.m2m_loc_diff_premium,
             psue.cont_unr_status              = 'NEW_TRADE'
       where psue.cont_unr_status is null
         and psue.process_id = pc_process_id
         and psue.corporate_id = pc_corporate_id;
    end;
  
    update psue_phy_stock_unrealized_ele psue
       set psue.pnl_in_base_cur      = psue.net_m2m_amount_in_base_cur -
                                       psue.prev_net_m2m_amt_in_base_cur,
           psue.pnl_in_per_base_unit = (psue.net_m2m_amount_in_base_cur -
                                       psue.prev_net_m2m_amt_in_base_cur) /
                                       psue.qty_in_base_unit
     where psue.process_id = pc_process_id
       and psue.corporate_id = pc_corporate_id;
  
    update psue_phy_stock_unrealized_ele psue
       set trade_day_pnl_in_base_cur   = nvl(psue.pnl_in_base_cur, 0) -
                                         nvl(psue.prev_day_pnl_in_base_cur,
                                             0),
           trade_day_pnl_per_base_unit = nvl(psue.pnl_in_base_cur, 0) -
                                         nvl(psue.prev_day_pnl_in_base_cur,
                                             0) / psue.qty_in_base_unit
     where psue.process_id = pc_process_id
       and psue.corporate_id = pc_corporate_id;
  
    update psue_phy_stock_unrealized_ele psue
       set (gmr_ref_no, warehouse_id, warehouse_name, shed_id, shed_name, prod_base_qty_unit_id, prod_base_qty_unit) = (select gmr.gmr_ref_no,
                                                                                                                               gmr.warehouse_profile_id,
                                                                                                                               phd_gmr.companyname as warehouse_profile_name,
                                                                                                                               gmr.shed_id,
                                                                                                                               sld.storage_location_name,
                                                                                                                               pdm.base_quantity_unit,
                                                                                                                               qum.qty_unit
                                                                                                                          from gmr_goods_movement_record   gmr,
                                                                                                                               pdm_productmaster           pdm,
                                                                                                                               phd_profileheaderdetails    phd_gmr,
                                                                                                                               sld_storage_location_detail sld,
                                                                                                                               qum_quantity_unit_master    qum
                                                                                                                         where gmr.internal_gmr_ref_no =
                                                                                                                               psue.internal_gmr_ref_no
                                                                                                                           and psue.product_id =
                                                                                                                               pdm.product_id
                                                                                                                           and pdm.base_quantity_unit =
                                                                                                                               qum.qty_unit_id
                                                                                                                           and gmr.warehouse_profile_id =
                                                                                                                               phd_gmr.profileid(+)
                                                                                                                           and gmr.shed_id =
                                                                                                                               sld.storage_loc_id(+)
                                                                                                                           and psue.process_id =
                                                                                                                               gmr.process_id
                                                                                                                           and psue.process_id =
                                                                                                                               pc_process_id)
     where psue.process_id = pc_process_id;
  
  exception
    when others then
      dbms_output.put_line('SQLERRM-1' || sqlerrm);
  end;
  procedure sp_phy_stok_con_ext_unreal_pnl(pc_corporate_id varchar2,
                                           pd_trade_date   date,
                                           pc_process_id   varchar2,
                                           pc_user_id      varchar2) is
  
    cursor cur_grd is
      select tt.section_type,
             tt.profit_center,
             tt.profit_center_name,
             tt.profit_center_short_name,
             tt.process_id,
             tt.corporate_id,
             tt.corporate_name,
             tt.internal_gmr_ref_no,
             tt.internal_contract_item_ref_no,
             tt.del_distribution_item_no,
             tt.delivery_item_no,
             tt.contract_ref_no,
             tt.purchase_sales,
             tt.conc_product_id,
             tt.conc_product_name,
             tt.product_id,
             tt.product_name,
             tt.origin_id,
             tt.origin_name,
             tt.conc_quality_id,
             tt.conc_quality_name,
             tt.quality_id,
             tt.quality_name,
             tt.container_no,
             tt.stock_qty,
             tt.qty_unit_id,
             tt.gmr_qty_unit_id,
             tt.qty_unit,
             tt.stocky_qty_decimal,
             tt.no_of_units,
             tt.md_id,
             tt.m2m_price_unit_id,
             tt.net_m2m_price,
             tt.m2m_price_unit_cur_id,
             tt.m2m_price_unit_cur_code,
             tt.m2m_price_unit_weight_unit_id,
             tt.m2m_price_unit_weight_unit,
             tt.m2m_price_unit_weight,
             tt.m2m_price_unit_str,
             tt.m2m_main_cur_id,
             tt.m2m_main_cur_code,
             tt.m2m_main_cur_decimals,
             tt.main_currency_factor,
             tt.settlement_cur_id,
             tt.settlement_to_val_fx_rate,
             tt.element_id,
             tt.attribute_name,
             tt.assay_header_id,
             tt.assay_qty,
             tt.assay_qty_unit_id,
             tt.payable_qty,
             tt.payable_qty_unit_id,
             tt.payable_qty_unit,
             tt.contract_price,
             tt.price_unit_id,
             tt.price_unit_weight_unit_id,
             tt.price_unit_weight,
             tt.price_unit_cur_id,
             tt.price_unit_cur_code,
             tt.price_unit_weight_unit,
             tt.price_fixation_details,
             tt.price_description,
             tt.payment_due_date,
             tt.base_cur_id,
             tt.base_cur_code,
             tt.base_cur_decimal,
             tt.inventory_status,
             tt.shipment_status,
             tt.section_name,
             tt.price_basis,
             tt.shed_id,
             tt.destination_city_id,
             tt.price_fixation_status,
             tt.base_qty_unit_id,
             tt.conc_base_qty_unit_id,
             tt.base_qty_decimal,
             tt.strategy_id,
             tt.strategy_name,
             tt.valuation_exchange_id,
             tt.valuation_month,
             tt.derivative_def_id,
             tt.is_voyage_gmr,
             tt.gmr_contract_type,
             tt.int_alloc_group_id,
             tt.internal_grd_dgrd_ref_no,
             tt.stock_ref_no,
             tt.trader_id,
             tt.trader_user_name,
             tt.m2m_loc_incoterm_deviation,
             tt.m2m_treatment_charge,
             tt.m2m_refine_charge,
             tt.m2m_tc_price_unit_id,
             tt.m2m_tc_price_unit_name,
             tt.m2m_tc_cur_id,
             tt.m2m_tc_weight,
             tt.m2m_tc_weight_unit_id,
             tt.m2m_rc_price_unit_id,
             tt.m2m_rc_price_unit_name,
             tt.m2m_rc_cur_id,
             tt.m2m_rc_weight,
             tt.m2m_rc_weight_unit_id,
             tt.base_price_unit_id_in_ppu,
             tt.base_price_unit_id_in_pum,
             tt.eval_basis,
             dense_rank() over(partition by tt.internal_contract_item_ref_no order by tt.element_id) ele_rank,
             tt.unit_of_measure,
             tt.loc_qty_unit_id,
             tt.mvp_id,
             tt.shipment_month,
             tt.shipment_year,
             tt.base_price_unit_name,
             tt.valuation_against_underlying
        from (
              ----  Stock non event based GMR price using CIPDE
              select 'Purchase' section_type,
                      pcpd.profit_center_id profit_center,
                      cpc.profit_center_name,
                      cpc.profit_center_short_name,
                      pc_process_id process_id,
                      gmr.corporate_id,
                      akc.corporate_name,
                      gmr.internal_gmr_ref_no,
                      grd.internal_contract_item_ref_no,
                      pci.del_distribution_item_no,
                      pcdi.delivery_item_no,
                      pcm.contract_ref_no,
                      pcm.purchase_sales,
                      pcpd.product_id conc_product_id,
                      pdm_conc.product_desc conc_product_name,
                      aml.underlying_product_id product_id,
                      pdm.product_desc product_name,
                      grd.origin_id,
                      orm.origin_name,
                      pcpq.quality_template_id conc_quality_id,
                      qat.quality_name conc_quality_name,
                      qav.comp_quality_id quality_id,
                      qat_und.quality_name,
                      grd.container_no,
                      grd.current_qty stock_qty,
                      grd.qty_unit_id,
                      gmr.qty_unit_id gmr_qty_unit_id,
                      qum.qty_unit,
                      qum.decimals stocky_qty_decimal,
                      grd.no_of_units,
                      md.md_id,
                      md.m2m_price_unit_id,
                      md.net_m2m_price,
                      md.m2m_price_unit_cur_id,
                      md.m2m_price_unit_cur_code,
                      md.m2m_price_unit_weight_unit_id,
                      md.m2m_price_unit_weight_unit,
                      nvl(md.m2m_price_unit_weight, 1) m2m_price_unit_weight,
                      md.m2m_price_unit_cur_code || '/' ||
                      decode(md.m2m_price_unit_weight,
                             1,
                             null,
                             md.m2m_price_unit_weight) ||
                      md.m2m_price_unit_weight_unit m2m_price_unit_str,
                      md.m2m_main_cur_id,
                      md.m2m_main_cur_code,
                      md.m2m_main_cur_decimals,
                      md.main_currency_factor,
                      md.settlement_cur_id,
                      md.settlement_to_val_fx_rate,
                      cipde.element_id,
                      aml.attribute_name,
                      -- pcpq.assay_header_id,
                      sam.ash_id assay_header_id,
                      ceqs.assay_qty,
                      ceqs.assay_qty_unit_id,
                      gmr_qty.payable_qty,
                      gmr_qty.qty_unit_id payable_qty_unit_id,
                      gmr_qum.qty_unit payable_qty_unit,
                      cipde.contract_price,
                      cipde.price_unit_id,
                      cipde.price_unit_weight_unit_id,
                      cipde.price_unit_weight,
                      cipde.price_unit_cur_id,
                      cipde.price_unit_cur_code,
                      cipde.price_unit_weight_unit,
                      cipde.price_fixation_details,
                      cipde.price_description,
                      nvl(cipde.payment_due_date, pd_trade_date) payment_due_date,
                      akc.base_cur_id as base_cur_id,
                      akc.base_currency_name base_cur_code,
                      cm.decimals as base_cur_decimal,
                      grd.inventory_status,
                      gsm.status shipment_status,
                      (case
                        when nvl(grd.is_afloat, 'N') = 'Y' and
                             nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                         'Shipped NTT'
                        when nvl(grd.is_afloat, 'N') = 'Y' and
                             nvl(grd.inventory_status, 'NA') = 'In' then
                         'Shipped IN'
                        when nvl(grd.is_afloat, 'N') = 'Y' and
                             nvl(grd.inventory_status, 'NA') = 'Out' then
                         'Shipped TT'
                        when nvl(grd.is_afloat, 'N') = 'N' and
                             nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                         'Stock NTT'
                        when nvl(grd.is_afloat, 'N') = 'N' and
                             nvl(grd.inventory_status, 'NA') = 'In' then
                         'Stock IN'
                        when nvl(grd.is_afloat, 'N') = 'N' and
                             nvl(grd.inventory_status, 'NA') = 'Out' then
                         'Stock TT'
                        else
                         'Others'
                      end) section_name,
                      cipde.price_basis,
                      gmr.shed_id,
                      gmr.destination_city_id,
                      cipde.price_fixation_status price_fixation_status,
                      pdm.base_quantity_unit base_qty_unit_id,
                      qum_pdm_conc.qty_unit_id as conc_base_qty_unit_id,
                      qum_pdm_conc.decimals as base_qty_decimal,
                      pcpd.strategy_id,
                      css.strategy_name,
                      md.valuation_exchange_id,
                      md.valuation_month,
                      md.derivative_def_id,
                      nvl(gmr.is_voyage_gmr, 'N') is_voyage_gmr,
                      gmr.contract_type gmr_contract_type,
                      null int_alloc_group_id,
                      grd.internal_grd_ref_no internal_grd_dgrd_ref_no,
                      grd.internal_stock_ref_no stock_ref_no,
                      pcm.trader_id,
                      (case
                        when pcm.trader_id is not null then
                         (select gab.firstname || ' ' || gab.lastname
                            from gab_globaladdressbook gab,
                                 ak_corporate_user     aku
                           where gab.gabid = aku.gabid
                             and aku.user_id = pcm.trader_id)
                        else
                         ''
                      end) trader_user_name,
                      md.m2m_loc_incoterm_deviation,
                      md.treatment_charge m2m_treatment_charge,
                      md.refine_charge m2m_refine_charge,
                      tc_ppu_pum.price_unit_id m2m_tc_price_unit_id,
                      tc_ppu_pum.price_unit_name m2m_tc_price_unit_name,
                      tc_ppu_pum.cur_id m2m_tc_cur_id,
                      tc_ppu_pum.weight m2m_tc_weight,
                      tc_ppu_pum.weight_unit_id m2m_tc_weight_unit_id,
                      rc_ppu_pum.price_unit_id m2m_rc_price_unit_id,
                      rc_ppu_pum.price_unit_name m2m_rc_price_unit_name,
                      rc_ppu_pum.cur_id m2m_rc_cur_id,
                      rc_ppu_pum.weight m2m_rc_weight,
                      rc_ppu_pum.weight_unit_id m2m_rc_weight_unit_id,
                      md.base_price_unit_id_in_ppu,
                      md.base_price_unit_id_in_pum,
                      qat.eval_basis,
                      pcpq.unit_of_measure,
                      pum_loc_base.weight_unit_id loc_qty_unit_id,
                      tmpc.mvp_id,
                      tmpc.shipment_month,
                      tmpc.shipment_year,
                      pum_base_price_id.price_unit_name base_price_unit_name,
                      nvl(pdm_conc.valuation_against_underlying, 'Y') valuation_against_underlying
                from gmr_goods_movement_record gmr,
                      grd_goods_record_detail grd,
                      pcm_physical_contract_main pcm,
                      pcpd_pc_product_definition pcpd,
                      cpc_corporate_profit_center cpc,
                      pdm_productmaster pdm,
                      orm_origin_master orm,
                      (select tmp.*
                         from tmpc_temp_m2m_pre_check tmp
                        where tmp.corporate_id = pc_corporate_id
                          and tmp.product_type = 'CONCENTRATES'
                          and tmp.section_name <> 'OPEN') tmpc,
                      qum_quantity_unit_master qum,
                      qat_quality_attributes qat,
                      (select md1.*
                         from md_m2m_daily md1
                        where md1.rate_type <> 'OPEN'
                          and md1.corporate_id = pc_corporate_id
                          and md1.product_type = 'CONCENTRATES'
                          and md1.process_id = pc_process_id) md,
                      cipde_cipd_element_price cipde,
                      ciqs_contract_item_qty_status ciqs,
                      pci_physical_contract_item pci,
                      pcpq_pc_product_quality pcpq,
                      pcdi_pc_delivery_item pcdi,
                      qav_quality_attribute_values qav,
                      ppm_product_properties_mapping ppm,
                      qat_quality_attributes qat_und,
                      aml_attribute_master_list aml,
                      pcdb_pc_delivery_basis pcdb,
                      ak_corporate akc,
                      cm_currency_master cm,
                      gsm_gmr_stauts_master gsm,
                      css_corporate_strategy_setup css,
                      pdm_productmaster pdm_conc,
                      qum_quantity_unit_master qum_pdm_conc,
                      pum_price_unit_master pum_loc_base,
                      pum_price_unit_master pum_base_price_id,
                      v_gmr_stockpayable_qty gmr_qty,
                      qum_quantity_unit_master gmr_qum,
                      v_ppu_pum tc_ppu_pum,
                      v_ppu_pum rc_ppu_pum,
                      ceqs_contract_ele_qty_status ceqs,
                      sam_stock_assay_mapping sam
               where grd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
                 and gmr.internal_contract_ref_no =
                     pcm.internal_contract_ref_no
                 and pcm.internal_contract_ref_no =
                     pcpd.internal_contract_ref_no
                 and pcpd.profit_center_id = cpc.profit_center_id
                 and grd.origin_id = orm.origin_id(+)
                 and grd.internal_gmr_ref_no = tmpc.internal_gmr_ref_no(+)
                 and grd.internal_grd_ref_no = tmpc.internal_grd_ref_no(+)
                 and grd.internal_contract_item_ref_no =
                     tmpc.internal_contract_item_ref_no(+)
                 and tmpc.conc_quality_id = qat.quality_id
                 and grd.qty_unit_id = qum.qty_unit_id(+)
                 and tmpc.internal_m2m_id = md.md_id(+)
                 and tmpc.element_id = cipde.element_id
                 and md.element_id = cipde.element_id
                 and grd.internal_contract_item_ref_no =
                     cipde.internal_contract_item_ref_no
                 and grd.process_id = cipde.process_id
                 and cipde.internal_contract_ref_no =
                     pcm.internal_contract_ref_no
                 and grd.internal_contract_item_ref_no =
                     ciqs.internal_contract_item_ref_no
                 and grd.internal_contract_item_ref_no =
                     pci.internal_contract_item_ref_no
                 and pci.pcpq_id = pcpq.pcpq_id
                 and pcm.internal_contract_ref_no =
                     pcdi.internal_contract_ref_no
                 and pcdi.pcdi_id = pci.pcdi_id
                 and pcpq.quality_template_id = qat.quality_id(+)
                 and qat.quality_id = qav.quality_id
                 and qav.attribute_id = ppm.property_id
                 and qav.comp_quality_id = qat_und.quality_id
                 and ppm.attribute_id = aml.attribute_id
                 and aml.underlying_product_id = pdm.product_id(+)
                 and aml.attribute_id = cipde.element_id
                 and pci.pcdb_id = pcdb.pcdb_id
                 and gmr.corporate_id = akc.corporate_id
                 and akc.base_cur_id = cm.cur_id
                 and gmr.status_id = gsm.status_id(+)
                 and pcpd.strategy_id = css.strategy_id
                 and pcpd.product_id = pdm_conc.product_id
                 and qum_pdm_conc.qty_unit_id = pdm_conc.base_quantity_unit
                 and md.base_price_unit_id_in_pum =
                     pum_loc_base.price_unit_id
                 and md.base_price_unit_id_in_pum =
                     pum_base_price_id.price_unit_id
                 and md.tc_price_unit_id = tc_ppu_pum.product_price_unit_id
                 and md.rc_price_unit_id = rc_ppu_pum.product_price_unit_id
                 and gmr.internal_gmr_ref_no = gmr_qty.internal_gmr_ref_no
                 and grd.internal_grd_ref_no = gmr_qty.internal_grd_ref_no
                 and cipde.element_id = gmr_qty.element_id
                 and gmr_qty.qty_unit_id = gmr_qum.qty_unit_id
                 and pci.internal_contract_item_ref_no =
                     ceqs.internal_contract_item_ref_no
                 and aml.attribute_id = ceqs.element_id
                 and grd.process_id = pc_process_id
                 and gmr.process_id = pc_process_id
                 and pci.process_id = pc_process_id
                 and pcm.process_id = pc_process_id
                 and pcpd.process_id = pc_process_id
                 and pcpq.process_id = pc_process_id
                 and pcdi.process_id = pc_process_id
                 and pcpd.process_id = pc_process_id
                 and ciqs.process_id = pc_process_id
                 and cipde.process_id = pc_process_id
                 and pcdb.process_id = pc_process_id
                 and gmr_qty.process_id = pc_process_id
                 and ceqs.process_id = pc_process_id
                 and pcm.purchase_sales = 'P'
                 and pcm.contract_status = 'In Position'
                 and pcm.contract_type = 'CONCENTRATES'
                 and pcpd.input_output = 'Input'
                 and pcm.is_tolling_contract = 'Y'
                 and pcm.is_tolling_extn = 'Y'
                 and pci.is_active = 'Y'
                 and pcm.is_active = 'Y'
                 and pcpd.is_active = 'Y'
                 and pcpq.is_active = 'Y'
                 and pcdi.is_active = 'Y'
                 and pcpd.is_active = 'Y'
                 and ppm.is_active = 'Y'
                 and ppm.is_deleted = 'N'
                 and qav.is_deleted = 'N'
                 and qav.is_comp_product_attribute = 'Y'
                 and qat.is_active = 'Y'
                 and qat.is_deleted = 'N'
                 and aml.is_active = 'Y'
                 and aml.is_deleted = 'N'
                 and qat_und.is_active = 'Y'
                 and qat_und.is_deleted = 'N'
                 and gmr.corporate_id = pc_corporate_id
                 and grd.status = 'Active'
                 and grd.is_deleted = 'N'
                 and gmr.is_deleted = 'N'
                 and nvl(grd.inventory_status, 'NA') <> 'Out'
                 and pcm.purchase_sales = 'P'
                 and nvl(grd.current_qty, 0) > 0
                 and gmr.is_internal_movement = 'N'
                 and grd.internal_grd_ref_no = sam.internal_grd_ref_no
                 and sam.is_latest_position_assay = 'Y'
                 and not exists
               (select gpd.process_id
                        from gpd_gmr_conc_price_daily gpd
                       where gpd.process_id = gmr.process_id
                         and gpd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
                         and gpd.corporate_id = gmr.corporate_id
                         and gpd.element_id = tmpc.element_id)
              union all
              ------  Stock event based GMR price using GPD
              select 'Purchase' section_type,
                     pcpd.profit_center_id profit_center,
                     cpc.profit_center_name,
                     cpc.profit_center_short_name,
                     pc_process_id process_id,
                     gmr.corporate_id,
                     akc.corporate_name,
                     gmr.internal_gmr_ref_no,
                     grd.internal_contract_item_ref_no,
                     pci.del_distribution_item_no,
                     pcdi.delivery_item_no,
                     pcm.contract_ref_no,
                     pcm.purchase_sales,
                     pcpd.product_id conc_product_id,
                     pdm_conc.product_desc conc_product_name,
                     aml.underlying_product_id product_id,
                     pdm.product_desc product_name,
                     grd.origin_id,
                     orm.origin_name,
                     pcpq.quality_template_id conc_quality_id,
                     qat.quality_name conc_quality_name,
                     qav.comp_quality_id quality_id,
                     qat_und.quality_name,
                     grd.container_no,
                     grd.current_qty stock_qty,
                     grd.qty_unit_id,
                     gmr.qty_unit_id gmr_qty_unit_id,
                     qum.qty_unit,
                     qum.decimals stocky_qty_decimal,
                     grd.no_of_units,
                     md.md_id,
                     md.m2m_price_unit_id,
                     md.net_m2m_price,
                     md.m2m_price_unit_cur_id,
                     md.m2m_price_unit_cur_code,
                     md.m2m_price_unit_weight_unit_id,
                     md.m2m_price_unit_weight_unit,
                     nvl(md.m2m_price_unit_weight, 1) m2m_price_unit_weight,
                     md.m2m_price_unit_cur_code || '/' ||
                     decode(md.m2m_price_unit_weight,
                            1,
                            null,
                            md.m2m_price_unit_weight) ||
                     md.m2m_price_unit_weight_unit m2m_price_unit_str,
                     md.m2m_main_cur_id,
                     md.m2m_main_cur_code,
                     md.m2m_main_cur_decimals,
                     md.main_currency_factor,
                     md.settlement_cur_id,
                     md.settlement_to_val_fx_rate,
                     ceqs.element_id, --cipde.element_id,
                     aml.attribute_name,
                     -- pcpq.assay_header_id,
                     sam.ash_id assay_header_id,
                     ceqs.assay_qty,
                     ceqs.assay_qty_unit_id,
                     gmr_qty.payable_qty,
                     gmr_qty.qty_unit_id payable_qty_unit_id,
                     gmr_qum.qty_unit payable_qty_unit,
                     gpd.contract_price,
                     gpd.price_unit_id,
                     gpd.price_unit_weight_unit_id,
                     gpd.price_unit_weight,
                     gpd.price_unit_cur_id,
                     gpd.price_unit_cur_code,
                     gpd.price_unit_weight_unit,
                     gpd.price_fixation_details, --cipde.price_fixation_details,
                     gpd.price_description price_description, --- cipde.price_description,
                     -- null payment_due_date, -- nvl(cipde.payment_due_date, pd_trade_date) payment_due_date,
                     (case
                       when nvl(pcdi.payment_due_date, pd_trade_date) <
                            pd_trade_date then
                        pd_trade_date
                       else
                        nvl(pcdi.payment_due_date, pd_trade_date)
                     end) payment_due_date,
                     akc.base_cur_id as base_cur_id,
                     akc.base_currency_name base_cur_code,
                     cm.decimals as base_cur_decimal,
                     grd.inventory_status,
                     gsm.status shipment_status,
                     (case
                       when nvl(grd.is_afloat, 'N') = 'Y' and
                            nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                        'Shipped NTT'
                       when nvl(grd.is_afloat, 'N') = 'Y' and
                            nvl(grd.inventory_status, 'NA') = 'In' then
                        'Shipped IN'
                       when nvl(grd.is_afloat, 'N') = 'Y' and
                            nvl(grd.inventory_status, 'NA') = 'Out' then
                        'Shipped TT'
                       when nvl(grd.is_afloat, 'N') = 'N' and
                            nvl(grd.inventory_status, 'NA') in ('None', 'NA') then
                        'Stock NTT'
                       when nvl(grd.is_afloat, 'N') = 'N' and
                            nvl(grd.inventory_status, 'NA') = 'In' then
                        'Stock IN'
                       when nvl(grd.is_afloat, 'N') = 'N' and
                            nvl(grd.inventory_status, 'NA') = 'Out' then
                        'Stock TT'
                       else
                        'Others'
                     end) section_name,
                     gpd.price_basis, -- cipde.price_basis,
                     gmr.shed_id,
                     gmr.destination_city_id,
                     gpd.price_fixation_status, ---cipde.price_fixation_status price_fixation_status,
                     pdm.base_quantity_unit base_qty_unit_id,
                     qum_pdm_conc.qty_unit_id as conc_base_qty_unit_id,
                     qum_pdm_conc.decimals as base_qty_decimal,
                     pcpd.strategy_id,
                     css.strategy_name,
                     md.valuation_exchange_id,
                     md.valuation_month,
                     md.derivative_def_id,
                     nvl(gmr.is_voyage_gmr, 'N') is_voyage_gmr,
                     gmr.contract_type gmr_contract_type,
                     null int_alloc_group_id,
                     grd.internal_grd_ref_no internal_grd_dgrd_ref_no,
                     grd.internal_stock_ref_no stock_ref_no,
                     pcm.trader_id,
                     (case
                       when pcm.trader_id is not null then
                        (select gab.firstname || ' ' || gab.lastname
                           from gab_globaladdressbook gab,
                                ak_corporate_user     aku
                          where gab.gabid = aku.gabid
                            and aku.user_id = pcm.trader_id)
                       else
                        ''
                     end) trader_user_name,
                     md.m2m_loc_incoterm_deviation,
                     md.treatment_charge m2m_treatment_charge,
                     md.refine_charge m2m_refine_charge,
                     tc_ppu_pum.price_unit_id m2m_tc_price_unit_id,
                     tc_ppu_pum.price_unit_name m2m_tc_price_unit_name,
                     tc_ppu_pum.cur_id m2m_tc_cur_id,
                     tc_ppu_pum.weight m2m_tc_weight,
                     tc_ppu_pum.weight_unit_id m2m_tc_weight_unit_id,
                     rc_ppu_pum.price_unit_id m2m_rc_price_unit_id,
                     rc_ppu_pum.price_unit_name m2m_rc_price_unit_name,
                     rc_ppu_pum.cur_id m2m_rc_cur_id,
                     rc_ppu_pum.weight m2m_rc_weight,
                     rc_ppu_pum.weight_unit_id m2m_rc_weight_unit_id,
                     md.base_price_unit_id_in_ppu,
                     md.base_price_unit_id_in_pum,
                     qat.eval_basis,
                     pcpq.unit_of_measure,
                     pum_loc_base.weight_unit_id loc_qty_unit_id,
                     tmpc.mvp_id,
                     tmpc.shipment_month,
                     tmpc.shipment_year,
                     pum_base_price_id.price_unit_name base_price_unit_name,
                     nvl(pdm_conc.valuation_against_underlying, 'Y') valuation_against_underlying
                from gmr_goods_movement_record gmr,
                     grd_goods_record_detail grd,
                     gpd_gmr_conc_price_daily gpd,
                     pcm_physical_contract_main pcm,
                     pcpd_pc_product_definition pcpd,
                     cpc_corporate_profit_center cpc,
                     pdm_productmaster pdm,
                     orm_origin_master orm,
                     (select tmp.*
                        from tmpc_temp_m2m_pre_check tmp
                       where tmp.corporate_id = pc_corporate_id
                         and tmp.product_type = 'CONCENTRATES'
                         and tmp.section_name <> 'OPEN') tmpc,
                     qum_quantity_unit_master qum,
                     qat_quality_attributes qat,
                     (select md1.*
                        from md_m2m_daily md1
                       where md1.rate_type <> 'OPEN'
                         and md1.corporate_id = pc_corporate_id
                         and md1.product_type = 'CONCENTRATES'
                         and md1.process_id = pc_process_id) md,
                     ciqs_contract_item_qty_status ciqs,
                     pci_physical_contract_item pci,
                     pcpq_pc_product_quality pcpq,
                     pcdi_pc_delivery_item pcdi,
                     qav_quality_attribute_values qav,
                     ppm_product_properties_mapping ppm,
                     qat_quality_attributes qat_und,
                     aml_attribute_master_list aml,
                     pcdb_pc_delivery_basis pcdb,
                     ak_corporate akc,
                     cm_currency_master cm,
                     gsm_gmr_stauts_master gsm,
                     css_corporate_strategy_setup css,
                     pdm_productmaster pdm_conc,
                     qum_quantity_unit_master qum_pdm_conc,
                     pum_price_unit_master pum_loc_base,
                     pum_price_unit_master pum_base_price_id,
                     v_gmr_stockpayable_qty gmr_qty,
                     qum_quantity_unit_master gmr_qum,
                     v_ppu_pum tc_ppu_pum,
                     v_ppu_pum rc_ppu_pum,
                     ceqs_contract_ele_qty_status ceqs,
                     sam_stock_assay_mapping sam
               where grd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
                 and gmr.internal_contract_ref_no =
                     pcm.internal_contract_ref_no
                 and pcm.internal_contract_ref_no =
                     pcpd.internal_contract_ref_no
                 and pcpd.profit_center_id = cpc.profit_center_id
                 and grd.origin_id = orm.origin_id(+)
                 and gmr.internal_gmr_ref_no = gpd.internal_gmr_ref_no(+)
                 and gmr.process_id = gpd.process_id(+)
                 and gpd.internal_gmr_ref_no = tmpc.internal_gmr_ref_no
                 and gpd.element_id = tmpc.element_id
                 and grd.internal_gmr_ref_no = tmpc.internal_gmr_ref_no(+)
                 and grd.internal_grd_ref_no = tmpc.internal_grd_ref_no(+)
                 and grd.internal_contract_item_ref_no =
                     tmpc.internal_contract_item_ref_no(+)
                 and tmpc.conc_quality_id = qat.quality_id
                 and grd.qty_unit_id = qum.qty_unit_id(+)
                 and tmpc.internal_m2m_id = md.md_id(+)
                 and tmpc.element_id = gpd.element_id
                 and md.element_id = gpd.element_id
                 and grd.process_id = gpd.process_id
                 and grd.internal_contract_item_ref_no =
                     ciqs.internal_contract_item_ref_no
                 and grd.internal_contract_item_ref_no =
                     pci.internal_contract_item_ref_no
                 and pci.pcpq_id = pcpq.pcpq_id
                 and pcm.internal_contract_ref_no =
                     pcdi.internal_contract_ref_no
                 and pcdi.pcdi_id = pci.pcdi_id
                 and pcpq.quality_template_id = qat.quality_id(+)
                 and qat.quality_id = qav.quality_id
                 and qav.attribute_id = ppm.property_id
                 and qav.comp_quality_id = qat_und.quality_id
                 and ppm.attribute_id = aml.attribute_id
                 and aml.underlying_product_id = pdm.product_id(+)
                 and aml.attribute_id = gpd.element_id
                 and pci.pcdb_id = pcdb.pcdb_id
                 and gmr.corporate_id = akc.corporate_id
                 and akc.base_cur_id = cm.cur_id
                 and gmr.status_id = gsm.status_id(+)
                 and pcpd.strategy_id = css.strategy_id
                 and pcpd.product_id = pdm_conc.product_id
                 and qum_pdm_conc.qty_unit_id = pdm_conc.base_quantity_unit
                 and md.base_price_unit_id_in_pum =
                     pum_loc_base.price_unit_id
                 and md.base_price_unit_id_in_pum =
                     pum_base_price_id.price_unit_id
                 and md.tc_price_unit_id = tc_ppu_pum.product_price_unit_id
                 and md.rc_price_unit_id = rc_ppu_pum.product_price_unit_id
                 and gmr.internal_gmr_ref_no = gmr_qty.internal_gmr_ref_no
                 and grd.internal_grd_ref_no = gmr_qty.internal_grd_ref_no
                 and gpd.element_id = gmr_qty.element_id
                 and gmr_qty.qty_unit_id = gmr_qum.qty_unit_id
                 and pci.internal_contract_item_ref_no =
                     ceqs.internal_contract_item_ref_no
                 and aml.attribute_id = ceqs.element_id
                 and grd.process_id = pc_process_id
                 and gmr.process_id = pc_process_id
                 and pci.process_id = pc_process_id
                 and pcm.process_id = pc_process_id
                 and pcpd.process_id = pc_process_id
                 and pcpq.process_id = pc_process_id
                 and pcdi.process_id = pc_process_id
                 and pcpd.process_id = pc_process_id
                 and ciqs.process_id = pc_process_id
                 and gpd.process_id = pc_process_id
                 and pcdb.process_id = pc_process_id
                 and gmr_qty.process_id = pc_process_id
                 and ceqs.process_id = pc_process_id
                 and pcm.purchase_sales = 'P'
                 and pcm.contract_status = 'In Position'
                 and pcm.contract_type = 'CONCENTRATES'
                 and pcpd.input_output = 'Input'
                 and pcm.is_tolling_contract = 'Y'
                 and pcm.is_tolling_extn = 'Y'
                 and pci.is_active = 'Y'
                 and pcm.is_active = 'Y'
                 and pcpd.is_active = 'Y'
                 and pcpq.is_active = 'Y'
                 and pcdi.is_active = 'Y'
                 and pcpd.is_active = 'Y'
                 and ppm.is_active = 'Y'
                 and ppm.is_deleted = 'N'
                 and qav.is_deleted = 'N'
                 and qav.is_comp_product_attribute = 'Y'
                 and qat.is_active = 'Y'
                 and qat.is_deleted = 'N'
                 and aml.is_active = 'Y'
                 and aml.is_deleted = 'N'
                 and qat_und.is_active = 'Y'
                 and qat_und.is_deleted = 'N'
                 and gmr.corporate_id = pc_corporate_id
                 and grd.status = 'Active'
                 and grd.is_deleted = 'N'
                 and gmr.is_deleted = 'N'
                 and nvl(grd.inventory_status, 'NA') <> 'Out'
                 and pcm.purchase_sales = 'P'
                 and nvl(grd.current_qty, 0) > 0
                 and gmr.is_internal_movement = 'N'
                 and grd.internal_grd_ref_no = sam.internal_grd_ref_no
                 and sam.is_latest_position_assay = 'Y'
              union all
              ------  Sales non event based GMR price using CIPDE
              select 'Sales' section_type,
                     pcpd.profit_center_id profit_center,
                     cpc.profit_center_name,
                     cpc.profit_center_short_name,
                     pc_process_id process_id,
                     gmr.corporate_id,
                     akc.corporate_name,
                     gmr.internal_gmr_ref_no,
                     dgrd.internal_contract_item_ref_no,
                     pci.del_distribution_item_no,
                     pcdi.delivery_item_no,
                     pcm.contract_ref_no,
                     pcm.purchase_sales,
                     pcpd.product_id conc_product_id,
                     pdm_conc.product_desc conc_product_name,
                     aml.underlying_product_id product_id,
                     pdm.product_desc product_name,
                     dgrd.origin_id,
                     orm.origin_name,
                     pcpq.quality_template_id conc_quality_id,
                     qat.quality_name conc_quality_name,
                     qav.comp_quality_id quality_id,
                     qat_und.quality_name,
                     '' container_no,
                     dgrd.net_weight stock_qty,
                     dgrd.net_weight_unit_id qty_unit_id,
                     gmr.qty_unit_id gmr_qty_unit_id,
                     qum.qty_unit,
                     qum.decimals stocky_qty_decimal,
                     gmr.current_no_of_units no_of_units,
                     md.md_id,
                     md.m2m_price_unit_id,
                     md.net_m2m_price,
                     md.m2m_price_unit_cur_id,
                     md.m2m_price_unit_cur_code,
                     md.m2m_price_unit_weight_unit_id,
                     md.m2m_price_unit_weight_unit,
                     nvl(md.m2m_price_unit_weight, 1) m2m_price_unit_weight,
                     md.m2m_price_unit_cur_code || '/' ||
                     decode(md.m2m_price_unit_weight,
                            1,
                            null,
                            md.m2m_price_unit_weight) ||
                     md.m2m_price_unit_weight_unit m2m_price_unit_str,
                     md.m2m_main_cur_id,
                     md.m2m_main_cur_code,
                     md.m2m_main_cur_decimals,
                     md.main_currency_factor,
                     md.settlement_cur_id,
                     md.settlement_to_val_fx_rate,
                     cipde.element_id,
                     aml.attribute_name,
                     --pcpq.assay_header_id,
                     sam.ash_id assay_header_id,
                     ceqs.assay_qty,
                     ceqs.assay_qty_unit_id,
                     gmr_qty.payable_qty,
                     gmr_qty.qty_unit_id payable_qty_unit_id,
                     gmr_qum.qty_unit payable_qty_unit,
                     cipde.contract_price,
                     cipde.price_unit_id,
                     cipde.price_unit_weight_unit_id,
                     cipde.price_unit_weight,
                     cipde.price_unit_cur_id,
                     cipde.price_unit_cur_code,
                     cipde.price_unit_weight_unit,
                     cipde.price_fixation_details,
                     cipde.price_description,
                     nvl(cipde.payment_due_date, pd_trade_date) payment_due_date,
                     akc.base_cur_id as base_cur_id,
                     akc.base_currency_name base_cur_code,
                     cm.decimals as base_cur_decimal,
                     gmr.inventory_status,
                     gsm.status shipment_status,
                     (case
                       when nvl(dgrd.inventory_status, 'NA') = 'Under CMA' then
                        'UnderCMA NTT'
                       when nvl(dgrd.is_afloat, 'N') = 'Y' and
                            nvl(dgrd.inventory_status, 'NA') in
                            ('In', 'None', 'NA') then
                        'Shipped NTT'
                       when nvl(dgrd.is_afloat, 'N') = 'Y' and
                            nvl(dgrd.inventory_status, 'NA') = 'Out' then
                        'Shipped TT'
                       when nvl(dgrd.is_afloat, 'N') = 'N' and
                            nvl(dgrd.inventory_status, 'NA') in
                            ('In', 'None', 'NA') then
                        'Stock NTT'
                       when nvl(dgrd.is_afloat, 'N') = 'N' and
                            nvl(dgrd.inventory_status, 'NA') = 'Out' then
                        'Stock TT'
                       else
                        'Others'
                     end) section_name,
                     cipde.price_basis,
                     gmr.shed_id,
                     gmr.destination_city_id,
                     cipde.price_fixation_status price_fixation_status,
                     pdm.base_quantity_unit base_qty_unit_id,
                     qum_pdm_conc.qty_unit_id as conc_base_qty_unit_id,
                     qum_pdm_conc.decimals as base_qty_decimal,
                     pcpd.strategy_id,
                     css.strategy_name,
                     md.valuation_exchange_id,
                     md.valuation_month,
                     md.derivative_def_id,
                     nvl(gmr.is_voyage_gmr, 'N') is_voyage_gmr,
                     gmr.contract_type gmr_contract_type,
                     agh.int_alloc_group_id,
                     dgrd.internal_dgrd_ref_no internal_grd_dgrd_ref_no,
                     dgrd.internal_stock_ref_no stock_ref_no,
                     pcm.trader_id,
                     (case
                       when pcm.trader_id is not null then
                        (select gab.firstname || ' ' || gab.lastname
                           from gab_globaladdressbook gab,
                                ak_corporate_user     aku
                          where gab.gabid = aku.gabid
                            and aku.user_id = pcm.trader_id)
                       else
                        ''
                     end) trader_user_name,
                     md.m2m_loc_incoterm_deviation,
                     md.treatment_charge m2m_treatment_charge,
                     md.refine_charge m2m_refine_charge,
                     tc_ppu_pum.price_unit_id m2m_tc_price_unit_id,
                     tc_ppu_pum.price_unit_name m2m_tc_price_unit_name,
                     tc_ppu_pum.cur_id m2m_tc_cur_id,
                     tc_ppu_pum.weight m2m_tc_weight,
                     tc_ppu_pum.weight_unit_id m2m_tc_weight_unit_id,
                     rc_ppu_pum.price_unit_id m2m_rc_price_unit_id,
                     rc_ppu_pum.price_unit_name m2m_rc_price_unit_name,
                     rc_ppu_pum.cur_id m2m_rc_cur_id,
                     rc_ppu_pum.weight m2m_rc_weight,
                     rc_ppu_pum.weight_unit_id m2m_rc_weight_unit_id,
                     md.base_price_unit_id_in_ppu,
                     md.base_price_unit_id_in_pum,
                     qat.eval_basis,
                     pcpq.unit_of_measure,
                     pum_loc_base.weight_unit_id loc_qty_unit_id,
                     tmpc.mvp_id,
                     tmpc.shipment_month,
                     tmpc.shipment_year,
                     pum_base_price_id.price_unit_name base_price_unit_name,
                     nvl(pdm_conc.valuation_against_underlying, 'Y') valuation_against_underlying
                from gmr_goods_movement_record gmr,
                     dgrd_delivered_grd dgrd,
                     agh_alloc_group_header agh,
                     pcm_physical_contract_main pcm,
                     pcpd_pc_product_definition pcpd,
                     cpc_corporate_profit_center cpc,
                     pdm_productmaster pdm,
                     orm_origin_master orm,
                     (select tmp.*
                        from tmpc_temp_m2m_pre_check tmp
                       where tmp.corporate_id = pc_corporate_id
                         and tmp.product_type = 'CONCENTRATES'
                         and tmp.section_name <> 'OPEN') tmpc,
                     qat_quality_attributes qat,
                     qum_quantity_unit_master qum,
                     (select md1.*
                        from md_m2m_daily md1
                       where md1.rate_type <> 'OPEN'
                         and md1.corporate_id = pc_corporate_id
                         and md1.product_type = 'CONCENTRATES'
                         and md1.process_id = pc_process_id) md,
                     cipde_cipd_element_price cipde,
                     pcdi_pc_delivery_item pcdi,
                     pci_physical_contract_item pci,
                     pcpq_pc_product_quality pcpq,
                     qav_quality_attribute_values qav,
                     ppm_product_properties_mapping ppm,
                     qat_quality_attributes qat_und,
                     aml_attribute_master_list aml,
                     ciqs_contract_item_qty_status ciqs,
                     ak_corporate akc,
                     cm_currency_master cm,
                     gsm_gmr_stauts_master gsm,
                     css_corporate_strategy_setup css,
                     pcdb_pc_delivery_basis pcdb,
                     pdm_productmaster pdm_conc,
                     qum_quantity_unit_master qum_pdm_conc,
                     pum_price_unit_master pum_loc_base,
                     pum_price_unit_master pum_base_price_id,
                     v_gmr_stockpayable_qty gmr_qty,
                     qum_quantity_unit_master gmr_qum,
                     v_ppu_pum tc_ppu_pum,
                     v_ppu_pum rc_ppu_pum,
                     ceqs_contract_ele_qty_status ceqs,
                     sam_stock_assay_mapping sam
               where dgrd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
                 and dgrd.int_alloc_group_id = agh.int_alloc_group_id
                 and gmr.internal_contract_ref_no =
                     pcm.internal_contract_ref_no
                 and pcm.internal_contract_ref_no =
                     pcpd.internal_contract_ref_no
                 and pcpd.profit_center_id = cpc.profit_center_id
                 and dgrd.origin_id = orm.origin_id(+)
                 and dgrd.internal_gmr_ref_no = tmpc.internal_gmr_ref_no(+)
                 and dgrd.internal_grd_ref_no = tmpc.internal_grd_ref_no(+)
                 and dgrd.internal_contract_item_ref_no =
                     tmpc.internal_contract_item_ref_no(+)
                 and tmpc.conc_quality_id = qat.quality_id
                 and dgrd.net_weight_unit_id = qum.qty_unit_id(+)
                 and tmpc.internal_m2m_id = md.md_id(+)
                 and tmpc.element_id = cipde.element_id
                 and md.element_id = cipde.element_id
                 and dgrd.internal_contract_item_ref_no =
                     cipde.internal_contract_item_ref_no
                 and cipde.internal_contract_ref_no =
                     pcm.internal_contract_ref_no
                 and pcm.internal_contract_ref_no =
                     pcdi.internal_contract_ref_no
                 and pcdi.pcdi_id = pci.pcdi_id
                 and pci.internal_contract_item_ref_no =
                     cipde.internal_contract_item_ref_no
                 and pci.pcpq_id = pcpq.pcpq_id
                 and qat.quality_id = qav.quality_id
                 and qav.attribute_id = ppm.property_id
                 and qav.comp_quality_id = qat_und.quality_id
                 and pcpq.quality_template_id = qat.quality_id
                 and ppm.attribute_id = aml.attribute_id(+)
                 and aml.underlying_product_id = pdm.product_id(+)
                 and aml.attribute_id = cipde.element_id
                 and pcpq.quality_template_id = qat.quality_id(+)
                 and pci.internal_contract_item_ref_no =
                     ciqs.internal_contract_item_ref_no
                 and gmr.corporate_id = akc.corporate_id
                 and akc.base_cur_id = cm.cur_id
                 and cm.cur_code = akc.base_currency_name
                 and gmr.status_id = gsm.status_id(+)
                 and pcpd.strategy_id = css.strategy_id
                 and pci.pcdb_id = pcdb.pcdb_id
                 and pcpd.product_id = pdm_conc.product_id
                 and qum_pdm_conc.qty_unit_id = pdm_conc.base_quantity_unit
                 and md.base_price_unit_id_in_pum =
                     pum_loc_base.price_unit_id
                 and md.base_price_unit_id_in_pum =
                     pum_base_price_id.price_unit_id
                 and md.tc_price_unit_id = tc_ppu_pum.product_price_unit_id
                 and md.rc_price_unit_id = rc_ppu_pum.product_price_unit_id
                 and gmr.internal_gmr_ref_no = gmr_qty.internal_gmr_ref_no
                 and dgrd.internal_dgrd_ref_no = gmr_qty.internal_dgrd_ref_no
                 and cipde.element_id = gmr_qty.element_id
                 and gmr_qty.qty_unit_id = gmr_qum.qty_unit_id
                 and pci.internal_contract_item_ref_no =
                     ceqs.internal_contract_item_ref_no
                 and aml.attribute_id = ceqs.element_id
                 and pcm.purchase_sales = 'S'
                 and gsm.is_required_for_m2m = 'Y'
                 and pcm.contract_status = 'In Position'
                 and pcm.contract_type = 'CONCENTRATES'
                 and pcpd.input_output = 'Input'
                 and pcm.is_tolling_contract = 'Y'
                 and pcm.is_tolling_extn = 'Y'
                 and pci.is_active = 'Y'
                 and pcm.is_active = 'Y'
                 and pcpd.is_active = 'Y'
                 and pcpq.is_active = 'Y'
                 and pcdi.is_active = 'Y'
                 and pcdb.is_active = 'Y'
                 and gmr.is_deleted = 'N'
                 and ppm.is_active = 'Y'
                 and ppm.is_deleted = 'N'
                 and qav.is_deleted = 'N'
                 and qav.is_comp_product_attribute = 'Y'
                 and qat.is_active = 'Y'
                 and qat.is_deleted = 'N'
                 and aml.is_active = 'Y'
                 and aml.is_deleted = 'N'
                 and qat_und.is_active = 'Y'
                 and qat_und.is_deleted = 'N'
                 and pcm.process_id = pc_process_id
                 and pcdi.process_id = pc_process_id
                 and pci.process_id = pc_process_id
                 and gmr.process_id = pc_process_id
                 and dgrd.process_id = pc_process_id
                 and agh.process_id = pc_process_id
                 and pcpd.process_id = pc_process_id
                 and cipde.process_id = pc_process_id
                 and pcpq.process_id = pc_process_id
                 and ciqs.process_id = pc_process_id
                 and pcdb.process_id = pc_process_id
                 and gmr_qty.process_id = pc_process_id
                 and ceqs.process_id = pc_process_id
                    -- and upper(dgrd.realized_status) in('UNREALIZED', 'REALIZED', 'REVERSEREALIZED')
                 and dgrd.status = 'Active'
                 and nvl(dgrd.net_weight, 0) > 0
                 and agh.is_deleted = 'N'
                 and gmr.corporate_id = pc_corporate_id
                 and gmr.is_internal_movement = 'N'
                 and dgrd.internal_dgrd_ref_no = sam.internal_dgrd_ref_no
                 and sam.is_latest_position_assay = 'Y'
                 and not exists
               (select gpd.process_id
                        from gpd_gmr_conc_price_daily gpd
                       where gpd.process_id = gmr.process_id
                         and gpd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
                         and gpd.corporate_id = gmr.corporate_id
                         and gpd.element_id = tmpc.element_id)
              union all
              ------  Sales  event based GMR price using GPE
              select 'Sales' section_type,
                     pcpd.profit_center_id profit_center,
                     cpc.profit_center_name,
                     cpc.profit_center_short_name,
                     pc_process_id process_id,
                     gmr.corporate_id,
                     akc.corporate_name,
                     gmr.internal_gmr_ref_no,
                     dgrd.internal_contract_item_ref_no,
                     pci.del_distribution_item_no,
                     pcdi.delivery_item_no,
                     pcm.contract_ref_no,
                     pcm.purchase_sales,
                     pcpd.product_id conc_product_id,
                     pdm_conc.product_desc conc_product_name,
                     aml.underlying_product_id product_id,
                     pdm.product_desc product_name,
                     dgrd.origin_id,
                     orm.origin_name,
                     pcpq.quality_template_id conc_quality_id,
                     qat.quality_name conc_quality_name,
                     qav.comp_quality_id quality_id,
                     qat_und.quality_name,
                     '' container_no,
                     dgrd.net_weight stock_qty,
                     dgrd.net_weight_unit_id qty_unit_id,
                     gmr.qty_unit_id gmr_qty_unit_id,
                     qum.qty_unit,
                     qum.decimals stocky_qty_decimal,
                     gmr.current_no_of_units no_of_units,
                     md.md_id,
                     md.m2m_price_unit_id,
                     md.net_m2m_price,
                     md.m2m_price_unit_cur_id,
                     md.m2m_price_unit_cur_code,
                     md.m2m_price_unit_weight_unit_id,
                     md.m2m_price_unit_weight_unit,
                     nvl(md.m2m_price_unit_weight, 1) m2m_price_unit_weight,
                     md.m2m_price_unit_cur_code || '/' ||
                     decode(md.m2m_price_unit_weight,
                            1,
                            null,
                            md.m2m_price_unit_weight) ||
                     md.m2m_price_unit_weight_unit m2m_price_unit_str,
                     md.m2m_main_cur_id,
                     md.m2m_main_cur_code,
                     md.m2m_main_cur_decimals,
                     md.main_currency_factor,
                     md.settlement_cur_id,
                     md.settlement_to_val_fx_rate,
                     ceqs.element_id,
                     aml.attribute_name,
                     -- pcpq.assay_header_id,
                     sam.ash_id assay_header_id,
                     ceqs.assay_qty,
                     ceqs.assay_qty_unit_id,
                     gmr_qty.payable_qty,
                     gmr_qty.qty_unit_id payable_qty_unit_id,
                     gmr_qum.qty_unit payable_qty_unit,
                     gpd.contract_price,
                     gpd.price_unit_id,
                     gpd.price_unit_weight_unit_id,
                     gpd.price_unit_weight,
                     gpd.price_unit_cur_id,
                     gpd.price_unit_cur_code,
                     gpd.price_unit_weight_unit,
                     gpd.price_fixation_details, -- cipde.price_fixation_details,
                     gpd.price_description, --cipde.price_description,
                     --null payment_due_date, --nvl(cipde.payment_due_date, pd_trade_date) payment_due_date,
                     (case
                       when nvl(pcdi.payment_due_date, pd_trade_date) <
                            pd_trade_date then
                        pd_trade_date
                       else
                        nvl(pcdi.payment_due_date, pd_trade_date)
                     end) payment_due_date,
                     akc.base_cur_id as base_cur_id,
                     akc.base_currency_name base_cur_code,
                     cm.decimals as base_cur_decimal,
                     gmr.inventory_status,
                     gsm.status shipment_status,
                     (case
                       when nvl(dgrd.inventory_status, 'NA') = 'Under CMA' then
                        'UnderCMA NTT'
                       when nvl(dgrd.is_afloat, 'N') = 'Y' and
                            nvl(dgrd.inventory_status, 'NA') in
                            ('In', 'None', 'NA') then
                        'Shipped NTT'
                       when nvl(dgrd.is_afloat, 'N') = 'Y' and
                            nvl(dgrd.inventory_status, 'NA') = 'Out' then
                        'Shipped TT'
                       when nvl(dgrd.is_afloat, 'N') = 'N' and
                            nvl(dgrd.inventory_status, 'NA') in
                            ('In', 'None', 'NA') then
                        'Stock NTT'
                       when nvl(dgrd.is_afloat, 'N') = 'N' and
                            nvl(dgrd.inventory_status, 'NA') = 'Out' then
                        'Stock TT'
                       else
                        'Others'
                     end) section_name,
                     gpd.price_basis, --cipde.price_basis,
                     gmr.shed_id,
                     gmr.destination_city_id,
                     gpd.price_fixation_status, ---cipde.price_fixation_status price_fixation_status,
                     pdm.base_quantity_unit base_qty_unit_id,
                     qum_pdm_conc.qty_unit_id as conc_base_qty_unit_id,
                     qum_pdm_conc.decimals as base_qty_decimal,
                     pcpd.strategy_id,
                     css.strategy_name,
                     md.valuation_exchange_id,
                     md.valuation_month,
                     md.derivative_def_id,
                     nvl(gmr.is_voyage_gmr, 'N') is_voyage_gmr,
                     gmr.contract_type gmr_contract_type,
                     agh.int_alloc_group_id,
                     dgrd.internal_dgrd_ref_no internal_grd_dgrd_ref_no,
                     dgrd.internal_stock_ref_no stock_ref_no,
                     pcm.trader_id,
                     (case
                       when pcm.trader_id is not null then
                        (select gab.firstname || ' ' || gab.lastname
                           from gab_globaladdressbook gab,
                                ak_corporate_user     aku
                          where gab.gabid = aku.gabid
                            and aku.user_id = pcm.trader_id)
                       else
                        ''
                     end) trader_user_name,
                     md.m2m_loc_incoterm_deviation,
                     md.treatment_charge m2m_treatment_charge,
                     md.refine_charge m2m_refine_charge,
                     tc_ppu_pum.price_unit_id m2m_tc_price_unit_id,
                     tc_ppu_pum.price_unit_name m2m_tc_price_unit_name,
                     tc_ppu_pum.cur_id m2m_tc_cur_id,
                     tc_ppu_pum.weight m2m_tc_weight,
                     tc_ppu_pum.weight_unit_id m2m_tc_weight_unit_id,
                     rc_ppu_pum.price_unit_id m2m_rc_price_unit_id,
                     rc_ppu_pum.price_unit_name m2m_rc_price_unit_name,
                     rc_ppu_pum.cur_id m2m_rc_cur_id,
                     rc_ppu_pum.weight m2m_rc_weight,
                     rc_ppu_pum.weight_unit_id m2m_rc_weight_unit_id,
                     md.base_price_unit_id_in_ppu,
                     md.base_price_unit_id_in_pum,
                     qat.eval_basis,
                     pcpq.unit_of_measure,
                     pum_loc_base.weight_unit_id loc_qty_unit_id,
                     tmpc.mvp_id,
                     tmpc.shipment_month,
                     tmpc.shipment_year,
                     pum_base_price_id.price_unit_name base_price_unit_name,
                     nvl(pdm_conc.valuation_against_underlying, 'Y') valuation_against_underlying
                from gmr_goods_movement_record gmr,
                     gpd_gmr_conc_price_daily gpd,
                     dgrd_delivered_grd dgrd,
                     agh_alloc_group_header agh,
                     pcm_physical_contract_main pcm,
                     pcpd_pc_product_definition pcpd,
                     cpc_corporate_profit_center cpc,
                     pdm_productmaster pdm,
                     orm_origin_master orm,
                     (select tmp.*
                        from tmpc_temp_m2m_pre_check tmp
                       where tmp.corporate_id = pc_corporate_id
                         and tmp.product_type = 'CONCENTRATES'
                         and tmp.section_name <> 'OPEN') tmpc,
                     qat_quality_attributes qat,
                     qum_quantity_unit_master qum,
                     (select md1.*
                        from md_m2m_daily md1
                       where md1.rate_type <> 'OPEN'
                         and md1.corporate_id = pc_corporate_id
                         and md1.product_type = 'CONCENTRATES'
                         and md1.process_id = pc_process_id) md,
                     pcdi_pc_delivery_item pcdi,
                     pci_physical_contract_item pci,
                     pcpq_pc_product_quality pcpq,
                     qav_quality_attribute_values qav,
                     ppm_product_properties_mapping ppm,
                     qat_quality_attributes qat_und,
                     aml_attribute_master_list aml,
                     ciqs_contract_item_qty_status ciqs,
                     ak_corporate akc,
                     cm_currency_master cm,
                     gsm_gmr_stauts_master gsm,
                     css_corporate_strategy_setup css,
                     pcdb_pc_delivery_basis pcdb,
                     pdm_productmaster pdm_conc,
                     qum_quantity_unit_master qum_pdm_conc,
                     pum_price_unit_master pum_loc_base,
                     pum_price_unit_master pum_base_price_id,
                     v_gmr_stockpayable_qty gmr_qty,
                     qum_quantity_unit_master gmr_qum,
                     v_ppu_pum tc_ppu_pum,
                     v_ppu_pum rc_ppu_pum,
                     ceqs_contract_ele_qty_status ceqs,
                     sam_stock_assay_mapping sam
               where dgrd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
                 and dgrd.int_alloc_group_id = agh.int_alloc_group_id
                 and gmr.internal_contract_ref_no =
                     pcm.internal_contract_ref_no
                 and pcm.internal_contract_ref_no =
                     pcpd.internal_contract_ref_no
                 and pcpd.profit_center_id = cpc.profit_center_id
                 and dgrd.origin_id = orm.origin_id(+)
                 and dgrd.internal_gmr_ref_no = tmpc.internal_gmr_ref_no(+)
                 and dgrd.internal_grd_ref_no = tmpc.internal_grd_ref_no(+)
                 and dgrd.internal_contract_item_ref_no =
                     tmpc.internal_contract_item_ref_no(+)
                 and tmpc.conc_quality_id = qat.quality_id
                 and dgrd.net_weight_unit_id = qum.qty_unit_id(+)
                 and tmpc.internal_m2m_id = md.md_id(+)
                 and tmpc.element_id = gpd.element_id
                 and md.element_id = gpd.element_id
                 and pcm.internal_contract_ref_no =
                     pcdi.internal_contract_ref_no
                 and pcdi.pcdi_id = pci.pcdi_id
                 and pci.pcpq_id = pcpq.pcpq_id
                 and qat.quality_id = qav.quality_id
                 and qav.attribute_id = ppm.property_id
                 and qav.comp_quality_id = qat_und.quality_id
                 and pcpq.quality_template_id = qat.quality_id
                 and ppm.attribute_id = aml.attribute_id(+)
                 and aml.underlying_product_id = pdm.product_id(+)
                 and aml.attribute_id = gpd.element_id
                 and pcpq.quality_template_id = qat.quality_id(+)
                 and pci.internal_contract_item_ref_no =
                     ciqs.internal_contract_item_ref_no
                 and gmr.corporate_id = akc.corporate_id
                 and akc.base_cur_id = cm.cur_id
                 and cm.cur_code = akc.base_currency_name
                 and gmr.status_id = gsm.status_id(+)
                 and pcpd.strategy_id = css.strategy_id
                 and pci.pcdb_id = pcdb.pcdb_id
                 and pcpd.product_id = pdm_conc.product_id
                 and qum_pdm_conc.qty_unit_id = pdm_conc.base_quantity_unit
                 and md.base_price_unit_id_in_pum =
                     pum_loc_base.price_unit_id
                 and md.base_price_unit_id_in_pum =
                     pum_base_price_id.price_unit_id
                 and md.tc_price_unit_id = tc_ppu_pum.product_price_unit_id
                 and md.rc_price_unit_id = rc_ppu_pum.product_price_unit_id
                 and gmr.internal_gmr_ref_no = gmr_qty.internal_gmr_ref_no
                 and dgrd.internal_dgrd_ref_no = gmr_qty.internal_dgrd_ref_no
                 and gpd.element_id = gmr_qty.element_id
                 and gmr_qty.qty_unit_id = gmr_qum.qty_unit_id
                 and pci.internal_contract_item_ref_no =
                     ceqs.internal_contract_item_ref_no
                 and aml.attribute_id = ceqs.element_id
                 and pcm.purchase_sales = 'S'
                 and gsm.is_required_for_m2m = 'Y'
                 and pcm.contract_status = 'In Position'
                 and pcm.contract_type = 'CONCENTRATES'
                 and pcpd.input_output = 'Input'
                 and pcm.is_tolling_contract = 'Y'
                 and pcm.is_tolling_extn = 'Y'
                 and pci.is_active = 'Y'
                 and pcm.is_active = 'Y'
                 and pcpd.is_active = 'Y'
                 and pcpq.is_active = 'Y'
                 and pcdi.is_active = 'Y'
                 and pcdb.is_active = 'Y'
                 and gmr.is_deleted = 'N'
                 and ppm.is_active = 'Y'
                 and ppm.is_deleted = 'N'
                 and qav.is_deleted = 'N'
                 and qav.is_comp_product_attribute = 'Y'
                 and qat.is_active = 'Y'
                 and qat.is_deleted = 'N'
                 and aml.is_active = 'Y'
                 and aml.is_deleted = 'N'
                 and qat_und.is_active = 'Y'
                 and qat_und.is_deleted = 'N'
                 and pcm.process_id = pc_process_id
                 and pcdi.process_id = pc_process_id
                 and pci.process_id = pc_process_id
                 and gmr.process_id = pc_process_id
                 and dgrd.process_id = pc_process_id
                 and agh.process_id = pc_process_id
                 and pcpd.process_id = pc_process_id
                 and gpd.process_id = pc_process_id
                 and pcpq.process_id = pc_process_id
                 and ciqs.process_id = pc_process_id
                 and pcdb.process_id = pc_process_id
                 and gmr_qty.process_id = pc_process_id
                 and ceqs.process_id = pc_process_id
                    --and upper(dgrd.realized_status) in ('UNREALIZED', 'REALIZED', 'REVERSEREALIZED')
                 and dgrd.status = 'Active'
                 and nvl(dgrd.net_weight, 0) > 0
                 and agh.is_deleted = 'N'
                 and gmr.corporate_id = pc_corporate_id
                 and gmr.is_internal_movement = 'N'
                 and dgrd.internal_dgrd_ref_no = sam.internal_dgrd_ref_no
                 and sam.is_latest_position_assay = 'Y') tt;
  
    vn_cont_price               number;
    vc_cont_price_unit_id       varchar2(15);
    vc_cont_price_unit_cur_id   varchar2(15);
    vc_cont_price_unit_cur_code varchar2(15);
    vn_cont_price_wt            number;
    vc_cont_price_wt_unit_id    varchar2(15);
    vc_cont_price_wt_unit       varchar2(15);
    vc_price_fixation_status    varchar2(50);
    vc_psu_id                   varchar2(500);
    vn_qty_in_base              number;
    vn_ele_qty_in_base          number;
    vn_m2m_amt                  number;
    vc_m2m_price_unit_cur_id    varchar2(15);
    vc_m2m_cur_id               varchar2(15);
    vc_m2m_cur_code             varchar2(15);
    vn_m2m_sub_cur_id_factor    number;
    vn_m2m_cur_decimals         number;
    vn_m2m_base_fx_rate         number;
    vn_m2m_base_deviation       number;
    vn_ele_m2m_amount_in_base   number;
    vobj_error_log              tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count          number := 1;
    --vn_m2m_total_premium_amt       number;
    vn_ele_m2m_total_amount        number;
    vn_ele_m2m_amt_per_unit        number;
    vc_price_cur_id                varchar2(15);
    vc_price_cur_code              varchar2(15);
    vn_cont_price_cur_id_factor    number;
    vn_contract_value_in_price_cur number;
    vn_cont_price_cur_decimals     number;
    vn_fx_price_to_base            number;
    vn_fx_price_deviation          number;
    vn_contract_value_in_val_cur   number;
    vn_contract_value_in_base_cur  number;
    vn_ele_m2m_treatment_charge    number;
    vn_dry_qty                     number;
    vn_wet_qty                     number;
    vn_dry_qty_in_base             number;
    vn_ele_m2m_refine_charge       number;
    vn_loc_amount                  number;
    vn_loc_total_amount            number;
    vn_total_penality              number;
    vn_penality                    number;
    vc_penality_price_unit_id      varchar2(15);
    vc_price_unit_id               varchar2(15);
  begin
  
    for cur_grd_rows in cur_grd
    loop
      vn_cont_price               := 0;
      vc_cont_price_unit_id       := null;
      vc_cont_price_unit_cur_id   := null;
      vc_cont_price_unit_cur_code := null;
      vn_cont_price_wt            := 1;
      vc_cont_price_wt_unit_id    := null;
      vc_cont_price_wt_unit       := null;
      vc_price_fixation_status    := null;
    
      /* if cur_grd_rows.gmr_price is null then
        vn_cont_price               := cur_grd_rows.contract_price;
        vc_cont_price_unit_id       := cur_grd_rows.price_unit_id;
        vc_cont_price_unit_cur_id   := cur_grd_rows.price_unit_cur_id;
        vc_cont_price_unit_cur_code := cur_grd_rows.price_unit_cur_code;
        vn_cont_price_wt            := cur_grd_rows.price_unit_weight;
        vc_cont_price_wt_unit_id    := cur_grd_rows.price_unit_weight_unit_id;
        vc_cont_price_wt_unit       := cur_grd_rows.price_unit_weight_unit;
        vc_price_fixation_status    := cur_grd_rows.price_fixation_status;
      
      else
        vn_cont_price               := cur_grd_rows.gmr_price;
        vc_cont_price_unit_id       := cur_grd_rows.gmr_price_unit_id;
        vc_cont_price_unit_cur_id   := cur_grd_rows.gmr_price_cur_id;
        vc_cont_price_unit_cur_code := cur_grd_rows.gmr_price_cur_code;
        vn_cont_price_wt            := cur_grd_rows.gmr_price_wt;
        vc_cont_price_wt_unit_id    := cur_grd_rows.gmr_price_wt_unit_id;
        vc_cont_price_wt_unit       := cur_grd_rows.gmr_price_wt_unit;
        vc_price_fixation_status    := cur_grd_rows.gmr_price_fixation_status;
      end if;*/
    
      vn_cont_price               := cur_grd_rows.contract_price;
      vc_cont_price_unit_id       := cur_grd_rows.price_unit_id;
      vc_cont_price_unit_cur_id   := cur_grd_rows.price_unit_cur_id;
      vc_cont_price_unit_cur_code := cur_grd_rows.price_unit_cur_code;
      vn_cont_price_wt            := cur_grd_rows.price_unit_weight;
      vc_cont_price_wt_unit_id    := cur_grd_rows.price_unit_weight_unit_id;
      vc_cont_price_wt_unit       := cur_grd_rows.price_unit_weight_unit;
      vc_price_fixation_status    := cur_grd_rows.price_fixation_status;
    
      if cur_grd_rows.stock_qty <> 0 then
        vc_psu_id := cur_grd_rows.internal_gmr_ref_no || '-' ||
                     cur_grd_rows.internal_grd_dgrd_ref_no || '-' ||
                     cur_grd_rows.internal_contract_item_ref_no || '-' ||
                     cur_grd_rows.container_no;
      
        if cur_grd_rows.unit_of_measure = 'Wet' then
          vn_dry_qty := round(pkg_metals_general.fn_get_assay_dry_qty(cur_grd_rows.conc_product_id,
                                                                      cur_grd_rows.assay_header_id,
                                                                      cur_grd_rows.stock_qty,
                                                                      cur_grd_rows.qty_unit_id),
                              cur_grd_rows.stocky_qty_decimal);
        else
          vn_dry_qty := cur_grd_rows.stock_qty;
        end if;
      
        vn_wet_qty := cur_grd_rows.stock_qty;
      
        -- convert into dry qty to base qty element level
      
        vn_dry_qty_in_base := round(pkg_general.f_get_converted_quantity(cur_grd_rows.conc_product_id,
                                                                         cur_grd_rows.qty_unit_id,
                                                                         cur_grd_rows.base_qty_unit_id,
                                                                         1) *
                                    vn_dry_qty,
                                    cur_grd_rows.base_qty_decimal);
      
        vn_qty_in_base := round(cur_grd_rows.stock_qty *
                                pkg_general.f_get_converted_quantity(cur_grd_rows.conc_product_id,
                                                                     cur_grd_rows.qty_unit_id,
                                                                     cur_grd_rows.conc_base_qty_unit_id,
                                                                     1),
                                cur_grd_rows.base_qty_decimal);
      
        vn_ele_qty_in_base := round(pkg_general.f_get_converted_quantity(cur_grd_rows.product_id,
                                                                         cur_grd_rows.payable_qty_unit_id,
                                                                         cur_grd_rows.base_qty_unit_id,
                                                                         1) *
                                    cur_grd_rows.payable_qty,
                                    cur_grd_rows.base_qty_decimal);
        if cur_grd_rows.valuation_against_underlying = 'Y' then
          if cur_grd_rows.eval_basis = 'FIXED' then
            vn_m2m_amt               := 0;
            vc_m2m_price_unit_cur_id := cur_grd_rows.base_cur_id;
          else
            vc_m2m_price_unit_cur_id := nvl(cur_grd_rows.m2m_price_unit_cur_id,
                                            cur_grd_rows.base_cur_id);
            vn_m2m_amt               := nvl(cur_grd_rows.net_m2m_price, 0) /
                                        nvl(cur_grd_rows.m2m_price_unit_weight,
                                            1) *
                                        pkg_general.f_get_converted_quantity(cur_grd_rows.product_id,
                                                                             cur_grd_rows.payable_qty_unit_id,
                                                                             cur_grd_rows.m2m_price_unit_weight_unit_id,
                                                                             cur_grd_rows.payable_qty);
          end if;
        
          pkg_general.sp_get_main_cur_detail(nvl(vc_m2m_price_unit_cur_id,
                                                 cur_grd_rows.base_cur_id),
                                             vc_m2m_cur_id,
                                             vc_m2m_cur_code,
                                             vn_m2m_sub_cur_id_factor,
                                             vn_m2m_cur_decimals);
        
          vn_m2m_amt := round(vn_m2m_amt * vn_m2m_sub_cur_id_factor,
                              cur_grd_rows.base_cur_decimal);
        
          pkg_general.sp_forward_cur_exchange_new(cur_grd_rows.corporate_id,
                                                  pd_trade_date,
                                                  cur_grd_rows.payment_due_date,
                                                  nvl(vc_m2m_cur_id,
                                                      cur_grd_rows.base_cur_id),
                                                  cur_grd_rows.base_cur_id,
                                                  30,
                                                  vn_m2m_base_fx_rate,
                                                  vn_m2m_base_deviation);
        
          if vc_m2m_cur_id <> cur_grd_rows.base_cur_id then
            if vn_m2m_base_fx_rate is null or vn_m2m_base_fx_rate = 0 then
              vobj_error_log.extend;
              vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                   'procedure pkg_phy_physical_process-sp_calc_phy_open_unrealized ',
                                                                   'PHY-005',
                                                                   cur_grd_rows.base_cur_code ||
                                                                   ' to ' ||
                                                                   vc_m2m_cur_code || ' (' ||
                                                                   to_char(cur_grd_rows.payment_due_date,
                                                                           'dd-Mon-yyyy') || ') ',
                                                                   '',
                                                                   gvc_process,
                                                                   pc_user_id,
                                                                   sysdate,
                                                                   pd_trade_date);
              sp_insert_error_log(vobj_error_log);
            
            end if;
          end if;
        
          vn_ele_m2m_amount_in_base := vn_m2m_amt * vn_m2m_base_fx_rate;
        else
          --if valuation against underly is no, then use total concentrate qty and market price to calculate the
          --market value for the gmr level.
          if cur_grd_rows.eval_basis = 'FIXED' then
            vn_m2m_amt               := 0;
            vc_m2m_price_unit_cur_id := cur_grd_rows.base_cur_id;
          else
            vc_m2m_price_unit_cur_id := nvl(cur_grd_rows.m2m_price_unit_cur_id,
                                            cur_grd_rows.base_cur_id);
            vn_m2m_amt               := nvl(cur_grd_rows.net_m2m_price, 0) /
                                        nvl(cur_grd_rows.m2m_price_unit_weight,
                                            1) *
                                        pkg_general.f_get_converted_quantity(cur_grd_rows.conc_product_id,
                                                                             cur_grd_rows.conc_base_qty_unit_id,
                                                                             cur_grd_rows.m2m_price_unit_weight_unit_id,
                                                                             vn_dry_qty_in_base);
          end if;
        
          pkg_general.sp_get_main_cur_detail(nvl(vc_m2m_price_unit_cur_id,
                                                 cur_grd_rows.base_cur_id),
                                             vc_m2m_cur_id,
                                             vc_m2m_cur_code,
                                             vn_m2m_sub_cur_id_factor,
                                             vn_m2m_cur_decimals);
        
          vn_m2m_amt := round(vn_m2m_amt * vn_m2m_sub_cur_id_factor,
                              cur_grd_rows.base_cur_decimal);
        
          pkg_general.sp_forward_cur_exchange_new(cur_grd_rows.corporate_id,
                                                  pd_trade_date,
                                                  cur_grd_rows.payment_due_date,
                                                  nvl(vc_m2m_cur_id,
                                                      cur_grd_rows.base_cur_id),
                                                  cur_grd_rows.base_cur_id,
                                                  30,
                                                  vn_m2m_base_fx_rate,
                                                  vn_m2m_base_deviation);
        
          if vc_m2m_cur_id <> cur_grd_rows.base_cur_id then
            if vn_m2m_base_fx_rate is null or vn_m2m_base_fx_rate = 0 then
              vobj_error_log.extend;
              vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                   'procedure pkg_phy_physical_process-sp_calc_phy_open_unrealized ',
                                                                   'PHY-005',
                                                                   cur_grd_rows.base_cur_code ||
                                                                   ' to ' ||
                                                                   vc_m2m_cur_code || ' (' ||
                                                                   to_char(cur_grd_rows.payment_due_date,
                                                                           'dd-Mon-yyyy') || ') ',
                                                                   '',
                                                                   gvc_process,
                                                                   pc_user_id,
                                                                   sysdate,
                                                                   pd_trade_date);
              sp_insert_error_log(vobj_error_log);
            
            end if;
          end if;
          if cur_grd_rows.ele_rank = 1 then
            vn_ele_m2m_amount_in_base := vn_m2m_amt * vn_m2m_base_fx_rate;
          else
            vn_ele_m2m_amount_in_base := 0;
            vn_m2m_amt                := 0;
          end if;
        
        end if;
        /*  vn_ele_m2m_treatment_charge := round(cur_grd_rows.m2m_treatment_charge *
                                             vn_dry_qty_in_base,
                                             cur_grd_rows.base_cur_decimal);
        vn_ele_m2m_refine_charge    := round(cur_grd_rows.m2m_refine_charge *
                                             vn_ele_qty_in_base,
                                             cur_grd_rows.base_cur_decimal);*/
      
        vn_ele_m2m_treatment_charge := round((cur_grd_rows.m2m_treatment_charge /
                                             nvl(cur_grd_rows.m2m_tc_weight,
                                                  1)) *
                                             pkg_general.f_get_converted_currency_amt(pc_corporate_id,
                                                                                      cur_grd_rows.m2m_tc_cur_id,
                                                                                      cur_grd_rows.base_cur_id,
                                                                                      pd_trade_date,
                                                                                      1) *
                                             (pkg_general.f_get_converted_quantity(cur_grd_rows.conc_product_id,
                                                                                   cur_grd_rows.qty_unit_id,
                                                                                   cur_grd_rows.m2m_tc_weight_unit_id,
                                                                                   vn_dry_qty)),
                                             cur_grd_rows.base_cur_decimal);
      
        vn_ele_m2m_refine_charge := round((cur_grd_rows.m2m_refine_charge /
                                          nvl(cur_grd_rows.m2m_rc_weight,
                                               1)) *
                                          pkg_general.f_get_converted_currency_amt(pc_corporate_id,
                                                                                   cur_grd_rows.m2m_rc_cur_id,
                                                                                   cur_grd_rows.base_cur_id,
                                                                                   pd_trade_date,
                                                                                   1) *
                                          (pkg_general.f_get_converted_quantity(cur_grd_rows.product_id,
                                                                                cur_grd_rows.payable_qty_unit_id,
                                                                                cur_grd_rows.m2m_rc_weight_unit_id,
                                                                                cur_grd_rows.payable_qty)),
                                          cur_grd_rows.base_cur_decimal);
      
        if cur_grd_rows.ele_rank = 1 then
          vn_loc_amount := round(pkg_general.f_get_converted_quantity(cur_grd_rows.conc_product_id,
                                                                      cur_grd_rows.loc_qty_unit_id,
                                                                      cur_grd_rows.conc_base_qty_unit_id,
                                                                      1) *
                                 cur_grd_rows.m2m_loc_incoterm_deviation,
                                 cur_grd_rows.base_cur_decimal);
        
          vn_loc_total_amount := round(vn_loc_amount * vn_qty_in_base,
                                       cur_grd_rows.base_cur_decimal);
        end if;
        vn_total_penality := 0;
        if cur_grd_rows.ele_rank = 1 then
          begin
            select ppu.product_price_unit_id
              into vc_price_unit_id
              from v_ppu_pum         ppu,
                   pdm_productmaster pdm,
                   ak_corporate      akc
             where ppu.product_id = cur_grd_rows.conc_product_id
               and ppu.product_id = pdm.product_id
               and pdm.base_quantity_unit = ppu.weight_unit_id
               and ppu.cur_id = akc.base_cur_id
               and nvl(ppu.weight, 1) = 1
               and akc.corporate_id = pc_corporate_id;
          
          exception
            when no_data_found then
              vc_price_unit_id := null;
          end;
        
          vn_total_penality := 0;
          for cc in (select pci.internal_contract_item_ref_no,
                            pqca.element_id,
                            pcpq.quality_template_id
                       from pci_physical_contract_item  pci,
                            pcpq_pc_product_quality     pcpq,
                            ash_assay_header            ash,
                            asm_assay_sublot_mapping    asm,
                            pqca_pq_chemical_attributes pqca
                      where pci.pcpq_id = pcpq.pcpq_id
                        and pcpq.assay_header_id = ash.ash_id
                        and ash.ash_id = asm.ash_id
                        and asm.asm_id = pqca.asm_id
                        and pci.process_id = pc_process_id
                        and pcpq.process_id = pc_process_id
                        and pci.is_active = 'Y'
                        and pcpq.is_active = 'Y'
                        and ash.is_active = 'Y'
                        and asm.is_active = 'Y'
                        and pqca.is_active = 'Y'
                        and pqca.is_elem_for_pricing = 'N'
                        and pqca.is_deductible = 'N'
                        and pci.internal_contract_item_ref_no =
                            cur_grd_rows.internal_contract_item_ref_no)
          loop
          
            pkg_phy_pre_check_process.sp_calc_m2m_tc_pc_rc_charge(cur_grd_rows.corporate_id,
                                                                  pd_trade_date,
                                                                  cur_grd_rows.conc_product_id,
                                                                  cur_grd_rows.conc_quality_id,
                                                                  cur_grd_rows.mvp_id,
                                                                  'Penalties',
                                                                  cc.element_id,
                                                                  cur_grd_rows.shipment_month,
                                                                  cur_grd_rows.shipment_year,
                                                                  vc_price_unit_id,
                                                                  vn_penality,
                                                                  vc_penality_price_unit_id);
            if nvl(vn_penality, 0) <> 0 then
              vn_total_penality := round(vn_total_penality +
                                         (vn_penality * vn_dry_qty_in_base),
                                         cur_grd_rows.base_cur_decimal);
            end if;
          
          end loop;
        
        end if;
      
        vn_ele_m2m_total_amount := vn_ele_m2m_amount_in_base -
                                   vn_ele_m2m_treatment_charge -
                                   vn_ele_m2m_refine_charge;
      
        vn_ele_m2m_amt_per_unit := round(vn_ele_m2m_total_amount /
                                         vn_ele_qty_in_base,
                                         cur_grd_rows.base_cur_decimal);
      
        pkg_general.sp_get_main_cur_detail(nvl(vc_cont_price_unit_cur_id,
                                               cur_grd_rows.base_cur_id),
                                           vc_price_cur_id,
                                           vc_price_cur_code,
                                           vn_cont_price_cur_id_factor,
                                           vn_cont_price_cur_decimals);
      
        if nvl(vn_cont_price, 0) <> 0 and
           vc_cont_price_wt_unit_id is not null then
        
          vn_contract_value_in_price_cur := (vn_cont_price /
                                            nvl(vn_cont_price_wt, 1)) *
                                            (pkg_general.f_get_converted_quantity(cur_grd_rows.product_id,
                                                                                  cur_grd_rows.qty_unit_id,
                                                                                  vc_cont_price_wt_unit_id,
                                                                                  cur_grd_rows.stock_qty)) *
                                            vn_cont_price_cur_id_factor;
        else
          vn_contract_value_in_price_cur := 0;
        end if;
      
        pkg_general.sp_forward_cur_exchange_new(cur_grd_rows.corporate_id,
                                                pd_trade_date,
                                                cur_grd_rows.payment_due_date,
                                                vc_price_cur_id,
                                                cur_grd_rows.base_cur_id,
                                                30,
                                                vn_fx_price_to_base,
                                                vn_fx_price_deviation);
      
        vn_contract_value_in_price_cur := round(vn_contract_value_in_price_cur,
                                                vn_cont_price_cur_decimals);
      
        vn_contract_value_in_val_cur  := round((vn_contract_value_in_price_cur *
                                               nvl(vn_fx_price_to_base, 1)),
                                               cur_grd_rows.base_cur_decimal);
        vn_contract_value_in_base_cur := vn_contract_value_in_val_cur;
      end if;
    
      insert into psue_element_details
        (corporate_id,
         process_id,
         internal_contract_item_ref_no,
         psu_id,
         internal_gmr_ref_no,
         element_id,
         element_name,
         assay_header_id,
         assay_qty,
         assay_qty_unit_id,
         payable_qty,
         payable_qty_unit_id,
         payable_qty_unit,
         contract_price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         price_unit_weight_unit_id,
         price_unit_weight,
         price_unit_weight_unit,
         md_id,
         m2m_price,
         m2m_price_cur_id,
         m2m_price_cur_code,
         m2m_price_weight_unit_id,
         m2m_price_weight_unit,
         m2m_price_weight_unit_weight,
         m2m_refining_charge,
         m2m_treatment_charge,
         pricing_details,
         m2m_price_unit_id,
         m2m_price_unit_str,
         m2m_amt,
         m2m_amt_cur_id,
         m2m_amt_cur_code,
         contract_value_in_price_cur,
         contract_price_cur_id,
         contract_price_cur_code,
         material_cost_in_base_cur,
         element_qty_in_base_unit,
         total_m2m_amount,
         m2m_amt_per_unit,
         price_cur_to_base_cur_fx_rate,
         m2m_cur_to_base_cur_fx_rate,
         base_price_unit_id_in_ppu,
         base_price_unit_id_in_pum,
         valuation_against_underlying,
         internal_grd_dgrd_ref_no)
      values
        (cur_grd_rows.corporate_id,
         pc_process_id,
         cur_grd_rows.internal_contract_item_ref_no,
         vc_psu_id,
         cur_grd_rows.internal_gmr_ref_no,
         cur_grd_rows.element_id,
         cur_grd_rows.attribute_name,
         cur_grd_rows.assay_header_id,
         cur_grd_rows.assay_qty,
         cur_grd_rows.assay_qty_unit_id,
         cur_grd_rows.payable_qty,
         cur_grd_rows.payable_qty_unit_id,
         cur_grd_rows.payable_qty_unit,
         vn_cont_price,
         vc_cont_price_unit_id,
         vc_cont_price_unit_cur_id,
         vc_cont_price_unit_cur_code,
         vc_cont_price_wt_unit_id,
         vn_cont_price_wt,
         vc_cont_price_wt_unit,
         cur_grd_rows.md_id,
         cur_grd_rows.net_m2m_price,
         cur_grd_rows.m2m_price_unit_cur_id,
         cur_grd_rows.m2m_price_unit_cur_code,
         cur_grd_rows.m2m_price_unit_weight_unit_id,
         cur_grd_rows.m2m_price_unit_weight_unit,
         decode(cur_grd_rows.m2m_price_unit_weight,
                1,
                null,
                cur_grd_rows.m2m_price_unit_weight),
         vn_ele_m2m_refine_charge,
         vn_ele_m2m_treatment_charge,
         cur_grd_rows.price_description,
         cur_grd_rows.m2m_price_unit_id,
         cur_grd_rows.m2m_price_unit_str,
         vn_m2m_amt, --m2m_amt
         cur_grd_rows.base_cur_id,
         cur_grd_rows.base_cur_code,
         vn_contract_value_in_price_cur,
         vc_price_cur_id,
         vc_price_cur_code,
         vn_contract_value_in_base_cur,
         vn_ele_qty_in_base,
         vn_ele_m2m_total_amount, --total_m2m_amount,
         vn_ele_m2m_amt_per_unit, --m2m_amt_per_unit,
         vn_fx_price_to_base, --price_cur_to_base_cur_fx_rate,   
         vn_m2m_base_fx_rate, --m2m_cur_to_base_cur_fx_rate,
         cur_grd_rows.base_price_unit_id_in_ppu, --base_price_unit_id_in_ppu,
         cur_grd_rows.base_price_unit_id_in_pum, --base_price_unit_id_in_pum)*/
         cur_grd_rows.valuation_against_underlying,
         cur_grd_rows.internal_grd_dgrd_ref_no);
    
      if cur_grd_rows.ele_rank = 1 then
        insert into psue_phy_stock_unrealized_ele
          (process_id,
           psu_id,
           corporate_id,
           corporate_name,
           internal_gmr_ref_no,
           internal_contract_item_ref_no,
           contract_ref_no,
           delivery_item_no,
           del_distribution_item_no,
           product_id,
           product_name,
           origin_id,
           origin_name,
           quality_id,
           quality_name,
           container_no,
           stock_wet_qty,
           stock_dry_qty,
           qty_unit_id,
           qty_unit,
           qty_in_base_unit,
           no_of_units,
           prod_base_qty_unit_id,
           prod_base_qty_unit,
           inventory_status,
           shipment_status,
           section_name,
           strategy_id,
           strategy_name,
           valuation_month,
           contract_type,
           profit_center_id,
           profit_center_name,
           profit_center_short_name,
           valuation_exchange_id,
           derivative_def_id,
           gmr_contract_type,
           is_voyage_gmr,
           gmr_ref_no,
           warehouse_id,
           warehouse_name,
           shed_id,
           shed_name,
           int_alloc_group_id,
           internal_grd_dgrd_ref_no,
           price_type_id,
           fixation_method,
           price_fixation_details,
           stock_ref_no,
           trader_name,
           trader_id,
           contract_qty_string,
           contract_price_string,
           m2m_price_string,
           m2m_rc_tc_string,
           m2m_penalty_charge,
           m2m_treatment_charge,
           m2m_refining_charge,
           m2m_loc_diff_premium,
           net_contract_value_in_base_cur,
           net_m2m_amount_in_base_cur,
           prev_net_m2m_amt_in_base_cur,
           pnl_type,
           pnl_in_base_cur,
           pnl_in_per_base_unit,
           prev_day_pnl_in_base_cur,
           prev_day_pnl_per_base_unit,
           trade_day_pnl_in_base_cur,
           trade_day_pnl_per_base_unit,
           cont_unr_status,
           prev_m2m_price_string,
           prev_m2m_rc_tc_string,
           prev_m2m_penalty_charge,
           prev_m2m_treatment_charge,
           prev_m2m_refining_charge,
           prev_m2m_loc_diff_premium,
           base_price_unit_id,
           base_price_unit_name,
           base_cur_id,
           base_cur_code,
           valuation_against_underlying)
        values
          (pc_process_id,
           vc_psu_id,
           cur_grd_rows.corporate_id,
           cur_grd_rows.corporate_name,
           cur_grd_rows.internal_gmr_ref_no,
           cur_grd_rows.internal_contract_item_ref_no,
           cur_grd_rows.contract_ref_no,
           cur_grd_rows.delivery_item_no,
           cur_grd_rows.del_distribution_item_no,
           cur_grd_rows.conc_product_id,
           cur_grd_rows.conc_product_name,
           cur_grd_rows.origin_id,
           cur_grd_rows.origin_name,
           cur_grd_rows.conc_quality_id,
           cur_grd_rows.conc_quality_name,
           cur_grd_rows.container_no,
           vn_wet_qty,
           vn_dry_qty,
           cur_grd_rows.qty_unit_id,
           cur_grd_rows.qty_unit,
           vn_qty_in_base,
           cur_grd_rows.no_of_units,
           null, --prod_base_qty_unit_id
           null, --prod_base_qty_unit
           cur_grd_rows.inventory_status,
           cur_grd_rows.shipment_status,
           cur_grd_rows.section_name,
           cur_grd_rows.strategy_id,
           cur_grd_rows.strategy_name,
           cur_grd_rows.valuation_month,
           cur_grd_rows.purchase_sales,
           cur_grd_rows.profit_center,
           cur_grd_rows.profit_center_name,
           cur_grd_rows.profit_center_short_name,
           cur_grd_rows.valuation_exchange_id,
           cur_grd_rows.derivative_def_id,
           cur_grd_rows.gmr_contract_type,
           cur_grd_rows.is_voyage_gmr,
           null, --gmr_ref_no
           null, --warehouse_id,
           null, --warehouse_name,
           null, --shed_id,
           null, --shed_name
           cur_grd_rows.int_alloc_group_id,
           cur_grd_rows.internal_grd_dgrd_ref_no,
           cur_grd_rows.price_basis,
           vc_price_fixation_status,
           cur_grd_rows.price_fixation_details,
           cur_grd_rows.stock_ref_no,
           cur_grd_rows.trader_user_name,
           cur_grd_rows.trader_id,
           null, --contract_qty_string,
           null, --contract_price_string,  
           null, --m2m_price_string,   
           null, --m2m_rc_tc_string,
           vn_total_penality, --m2m_penalty_charge,
           null, --m2m_treatment_charge,
           null, --m2m_refining_charge,
           vn_loc_total_amount, --m2m_loc_diff_premium,
           null, --net_contract_value_in_base_cur, 
           null, --net_m2m_amount_in_base_cur,
           null, --prev_net_m2m_amt_in_base_cur,
           'Unrealized',
           null, --pnl_in_base_cur,
           null, --pnl_in_per_base_unit,
           null, --prev_day_pnl_in_base_cur,
           null, --prev_day_pnl_per_base_unit,
           null, --trade_day_pnl_in_base_cur,
           null, --trade_day_pnl_per_base_unit,
           null, --cont_unr_status,
           null, --prev_m2m_price_string,    
           null, --prev_m2m_rc_tc_string,
           null, --prev_m2m_penalty_charge, 
           null, --prev_m2m_treatment_charge, 
           null, --prev_m2m_refining_charge, 
           null, --prev_m2m_loc_diff_premium,
           cur_grd_rows.base_price_unit_id_in_ppu,
           cur_grd_rows.base_price_unit_name,
           cur_grd_rows.base_cur_id,
           cur_grd_rows.base_cur_code,
           cur_grd_rows.valuation_against_underlying);
      end if;
    end loop;
  
    for cur_update_pnl in (select psue.psu_id,
                                  sum(psue.material_cost_in_base_cur) net_contract_value_in_base_cur,
                                  sum(psue.m2m_amt) net_m2m_amt,
                                  sum(psue.m2m_treatment_charge) net_m2m_treatment_charge,
                                  sum(psue.m2m_refining_charge) net_m2m_refining_charge,
                                  stragg(psue.element_name || '-' ||
                                         psue.payable_qty || ' ' ||
                                         psue.payable_qty_unit) contract_qty_string,
                                  stragg(psue.element_name || '-' ||
                                         psue.contract_price || ' ' ||
                                         psue.price_unit_cur_code || '/' ||
                                         psue.price_unit_weight ||
                                         psue.price_unit_weight_unit) contract_price_string,
                                  (case
                                     when psue.valuation_against_underlying = 'N' then
                                      max((case
                                     when nvl(psue.m2m_price, 0) <> 0 then
                                      (psue.m2m_price || ' ' ||
                                      psue.m2m_price_cur_code || '/' ||
                                      psue.m2m_price_weight_unit_weight ||
                                      psue.m2m_price_weight_unit)
                                     else
                                      null
                                   end)) else stragg((case
                                    when nvl(psue.m2m_price,
                                             0) <> 0 then
                                     (psue.element_name || '-' ||
                                     psue.m2m_price || ' ' ||
                                     psue.m2m_price_cur_code || '/' ||
                                     psue.m2m_price_weight_unit_weight ||
                                     psue.m2m_price_weight_unit)
                                    else
                                     null
                                  end)) end) m2m_price_string, -- TODO if underly valuation = n, show the concentrate price
                                  stragg('TC:' || psue.element_name || '-' ||
                                         psue.m2m_treatment_charge || ' ' ||
                                         psue.price_unit_cur_code || ' ' ||
                                         'RC:' || psue.element_name || '-' ||
                                         psue.m2m_refining_charge || ' ' ||
                                         psue.price_unit_cur_code) m2m_rc_tc_pen_string
                             from psue_element_details psue
                            where psue.corporate_id = pc_corporate_id
                              and psue.process_id = pc_process_id
                            group by psue.psu_id,
                                     psue.valuation_against_underlying)
    loop
    
      update psue_phy_stock_unrealized_ele psuee
         set psuee.net_contract_value_in_base_cur = cur_update_pnl.
                                                    net_contract_value_in_base_cur,
             psuee.net_m2m_amount                 = cur_update_pnl.net_m2m_amt,
             psuee.m2m_treatment_charge           = cur_update_pnl.net_m2m_treatment_charge,
             psuee.m2m_refining_charge            = cur_update_pnl.net_m2m_refining_charge,
             psuee.contract_price_string          = cur_update_pnl.contract_price_string,
             psuee.m2m_price_string               = cur_update_pnl.m2m_price_string,
             psuee.m2m_rc_tc_string               = cur_update_pnl.m2m_rc_tc_pen_string,
             psuee.contract_qty_string            = cur_update_pnl.contract_qty_string
       where psuee.psu_id = cur_update_pnl.psu_id
         and psuee.process_id = pc_process_id
         and psuee.corporate_id = pc_corporate_id;
    end loop;
  
    update psue_phy_stock_unrealized_ele psuee
       set psuee.net_m2m_amount_in_base_cur = (psuee.net_m2m_amount -
                                              psuee.m2m_treatment_charge -
                                              psuee.m2m_refining_charge -
                                              psuee.m2m_penalty_charge +
                                              psuee.m2m_loc_diff_premium)
     where psuee.corporate_id = pc_corporate_id
       and psuee.process_id = pc_process_id;
  
    --- previous EOD Data
    for cur_update in (select psue_prev_day.net_m2m_amount_in_base_cur,
                              psue_prev_day.net_m2m_amount,
                              psue_prev_day.pnl_in_per_base_unit,
                              psue_prev_day.m2m_price_string,
                              psue_prev_day.m2m_rc_tc_string,
                              psue_prev_day.m2m_penalty_charge,
                              psue_prev_day.m2m_treatment_charge,
                              psue_prev_day.m2m_refining_charge,
                              psue_prev_day.m2m_loc_diff_premium,
                              psue_prev_day.qty_in_base_unit,
                              psue_prev_day.psu_id
                         from psue_phy_stock_unrealized_ele psue_prev_day
                        where process_id = gvc_previous_process_id
                          and corporate_id = pc_corporate_id)
    loop
      update psue_phy_stock_unrealized_ele psue_today
         set psue_today.prev_net_m2m_amt_in_base_cur = cur_update.net_m2m_amount_in_base_cur,
             psue_today.prev_day_pnl_in_base_cur     = cur_update.pnl_in_per_base_unit *
                                                       psue_today.qty_in_base_unit,
             psue_today.prev_net_m2m_amount          = cur_update.net_m2m_amount,
             psue_today.prev_day_pnl_per_base_unit   = cur_update.pnl_in_per_base_unit,
             psue_today.prev_m2m_price_string        = cur_update.m2m_price_string,
             psue_today.prev_m2m_rc_tc_string        = cur_update.m2m_rc_tc_string,
             psue_today.prev_m2m_penalty_charge      = cur_update.m2m_penalty_charge,
             psue_today.prev_m2m_treatment_charge    = cur_update.m2m_treatment_charge,
             psue_today.prev_m2m_refining_charge     = cur_update.m2m_refining_charge,
             psue_today.prev_m2m_loc_diff_premium    = cur_update.m2m_loc_diff_premium,
             psue_today.cont_unr_status              = 'EXISTING_TRADE'
       where psue_today.process_id = pc_process_id
         and psue_today.corporate_id = pc_corporate_id
         and psue_today.psu_id = cur_update.psu_id;
    end loop;
  
    begin
      update psue_phy_stock_unrealized_ele psue
         set psue.prev_net_m2m_amt_in_base_cur = psue.net_m2m_amount_in_base_cur,
             psue.prev_day_pnl_in_base_cur     = 0,
             psue.prev_day_pnl_per_base_unit   = 0,
             psue.prev_net_m2m_amount          = psue.net_m2m_amount,
             psue.prev_m2m_price_string        = psue.m2m_price_string,
             psue.prev_m2m_rc_tc_string        = psue.m2m_rc_tc_string,
             psue.prev_m2m_penalty_charge      = psue.m2m_penalty_charge,
             psue.prev_m2m_treatment_charge    = psue.m2m_treatment_charge,
             psue.prev_m2m_refining_charge     = psue.m2m_refining_charge,
             psue.prev_m2m_loc_diff_premium    = psue.m2m_loc_diff_premium,
             psue.cont_unr_status              = 'NEW_TRADE'
       where psue.cont_unr_status is null
         and psue.process_id = pc_process_id
         and psue.corporate_id = pc_corporate_id;
    end;
  
    update psue_phy_stock_unrealized_ele psue
       set psue.pnl_in_base_cur      = psue.net_m2m_amount_in_base_cur -
                                       psue.prev_net_m2m_amt_in_base_cur,
           psue.pnl_in_per_base_unit = (psue.net_m2m_amount_in_base_cur -
                                       psue.prev_net_m2m_amt_in_base_cur) /
                                       psue.qty_in_base_unit
     where psue.process_id = pc_process_id
       and psue.corporate_id = pc_corporate_id;
  
    update psue_phy_stock_unrealized_ele psue
       set trade_day_pnl_in_base_cur   = nvl(psue.pnl_in_base_cur, 0) -
                                         nvl(psue.prev_day_pnl_in_base_cur,
                                             0),
           trade_day_pnl_per_base_unit = nvl(psue.pnl_in_base_cur, 0) -
                                         nvl(psue.prev_day_pnl_in_base_cur,
                                             0) / psue.qty_in_base_unit
     where psue.process_id = pc_process_id
       and psue.corporate_id = pc_corporate_id;
  
    update psue_phy_stock_unrealized_ele psue
       set (gmr_ref_no, warehouse_id, warehouse_name, shed_id, shed_name, prod_base_qty_unit_id, prod_base_qty_unit) = (select gmr.gmr_ref_no,
                                                                                                                               gmr.warehouse_profile_id,
                                                                                                                               phd_gmr.companyname as warehouse_profile_name,
                                                                                                                               gmr.shed_id,
                                                                                                                               sld.storage_location_name,
                                                                                                                               pdm.base_quantity_unit,
                                                                                                                               qum.qty_unit
                                                                                                                          from gmr_goods_movement_record   gmr,
                                                                                                                               pdm_productmaster           pdm,
                                                                                                                               phd_profileheaderdetails    phd_gmr,
                                                                                                                               sld_storage_location_detail sld,
                                                                                                                               qum_quantity_unit_master    qum
                                                                                                                         where gmr.internal_gmr_ref_no =
                                                                                                                               psue.internal_gmr_ref_no
                                                                                                                           and psue.product_id =
                                                                                                                               pdm.product_id
                                                                                                                           and pdm.base_quantity_unit =
                                                                                                                               qum.qty_unit_id
                                                                                                                           and gmr.warehouse_profile_id =
                                                                                                                               phd_gmr.profileid(+)
                                                                                                                           and gmr.shed_id =
                                                                                                                               sld.storage_loc_id(+)
                                                                                                                           and psue.process_id =
                                                                                                                               gmr.process_id
                                                                                                                           and psue.process_id =
                                                                                                                               pc_process_id)
     where psue.process_id = pc_process_id;
  
  exception
    when others then
      dbms_output.put_line('SQLERRM-1' || sqlerrm);
    
  end;
  procedure sp_process_rollback(pc_corporate_id varchar2,
                                pc_process      varchar2,
                                pd_trade_date   date,
                                pc_dbd_id       varchar2,
                                pc_process_id   varchar2)
  --------------------------------------------------------------------------------------------------------------------------
    --        procedure name                            : sp_process_rollback
    --        author                                    :
    --        created date                              : 11th Jan 2011
    --        purpose                                   : rollback eod
    --        parameters
    --        pc_corporate_id                           : corporate id
    --        modification history
    --        modified date                             :
    --        modified by                               :
    --        modify description                        :
    --------------------------------------------------------------------------------------------------------------------------
   is
  
    vc_dbd_id          varchar2(15);
    vobj_error_log     tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count number := 1;
    vn_logno           number := 0;
  begin
  
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_dbd_id,
                          vn_logno,
                          'Rollback Start');
    vc_dbd_id := pc_dbd_id;
    delete from agdul_alloc_group_detail_ul where dbd_id = vc_dbd_id;
    delete from aghul_alloc_group_header_ul where dbd_id = vc_dbd_id;
    delete from cigcul_contrct_itm_gmr_cost_ul where dbd_id = vc_dbd_id;
    delete from csul_cost_store_ul where dbd_id = vc_dbd_id;
    delete from dgrdul_delivered_grd_ul where dbd_id = vc_dbd_id;
    delete from gmrul_gmr_ul where dbd_id = vc_dbd_id;
    delete from mogrdul_moved_out_grd_ul where dbd_id = vc_dbd_id;
    delete from pcadul_pc_agency_detail_ul where dbd_id = vc_dbd_id;
    delete from pcbpdul_pc_base_price_dtl_ul where dbd_id = vc_dbd_id;
    delete from pcbphul_pc_base_prc_header_ul where dbd_id = vc_dbd_id;
    delete from pcdbul_pc_delivery_basis_ul where dbd_id = vc_dbd_id;
    delete from pcddul_document_details_ul where dbd_id = vc_dbd_id;
    delete from pcdiobul_di_optional_basis_ul where dbd_id = vc_dbd_id;
    delete from pcdipeul_di_pricing_elemnt_ul where dbd_id = vc_dbd_id;
    delete from pcdiqdul_di_quality_detail_ul where dbd_id = vc_dbd_id;
    delete from pcdiul_pc_delivery_item_ul where dbd_id = vc_dbd_id;
    delete from pcipful_pci_pricing_formula_ul where dbd_id = vc_dbd_id;
    delete from pciul_phy_contract_item_ul where dbd_id = vc_dbd_id;
    delete from pcjvul_pc_jv_detail_ul where dbd_id = vc_dbd_id;
    delete from pcmul_phy_contract_main_ul where dbd_id = vc_dbd_id;
    delete from pcpdqdul_pd_quality_dtl_ul where dbd_id = vc_dbd_id;
    delete from pcpdul_pc_product_defintn_ul where dbd_id = vc_dbd_id;
    delete from pcpqul_pc_product_quality_ul where dbd_id = vc_dbd_id;
    delete from pcqpdul_pc_qual_prm_discnt_ul where dbd_id = vc_dbd_id;
    delete from pffxdul_phy_formula_fx_dtl_ul where dbd_id = vc_dbd_id;
    delete from pfqppul_phy_formula_qp_prc_ul where dbd_id = vc_dbd_id;
    delete from ppfdul_phy_price_frmula_dtl_ul where dbd_id = vc_dbd_id;
    delete from ppfhul_phy_price_frmla_hdr_ul where dbd_id = vc_dbd_id;
    delete from ciqsl_contract_itm_qty_sts_log where dbd_id = vc_dbd_id;
    delete from diqsl_delivery_itm_qty_sts_log where dbd_id = vc_dbd_id;
    delete from cqsl_contract_qty_status_log where dbd_id = vc_dbd_id;
    delete from grdl_goods_record_detail_log where dbd_id = vc_dbd_id;
    delete from vdul_voyage_detail_ul where dbd_id = vc_dbd_id;
    delete from pcpchul_payble_contnt_headr_ul where dbd_id = vc_dbd_id;
    delete from pqdul_payable_quality_dtl_ul where dbd_id = vc_dbd_id;
    delete from pcepcul_elem_payble_content_ul where dbd_id = vc_dbd_id;
    delete from pcthul_treatment_header_ul where dbd_id = vc_dbd_id;
    delete from tedul_treatment_element_dtl_ul where dbd_id = vc_dbd_id;
    delete from tqdul_treatment_quality_dtl_ul where dbd_id = vc_dbd_id;
    delete from pcetcul_elem_treatmnt_chrg_ul where dbd_id = vc_dbd_id;
    delete from pcarul_assaying_rules_ul where dbd_id = vc_dbd_id;
    delete from pcaeslul_assay_elm_splt_lmt_ul where dbd_id = vc_dbd_id;
    delete from pcaeslul_assay_elm_splt_lmt_ul where dbd_id = vc_dbd_id;
    delete from arqdul_assay_quality_dtl_ul where dbd_id = vc_dbd_id;
    delete from pcaphul_attr_penalty_header_ul where dbd_id = vc_dbd_id;
    delete from pcapul_attribute_penalty_ul where dbd_id = vc_dbd_id;
    delete from pqdul_penalty_quality_dtl_ul where dbd_id = vc_dbd_id;
    delete from padul_penalty_attribute_dtl_ul where dbd_id = vc_dbd_id;
    delete from pcrhul_refining_header_ul where dbd_id = vc_dbd_id;
    delete from rqdul_refining_quality_dtl_ul where dbd_id = vc_dbd_id;
    delete from redul_refining_element_dtl_ul where dbd_id = vc_dbd_id;
    delete from pcercul_elem_refing_charge_ul where dbd_id = vc_dbd_id;
    delete from dithul_di_treatment_header_ul where dbd_id = vc_dbd_id;
    delete from dirhul_di_refining_header_ul where dbd_id = vc_dbd_id;
    delete from diphul_di_penalty_header_ul where dbd_id = vc_dbd_id;
    delete from cipql_ctrt_itm_payable_qty_log where dbd_id = vc_dbd_id;
    delete from dipql_del_itm_payble_qty_log where dbd_id = vc_dbd_id;
    delete from spql_stock_payable_qty_log where dbd_id = vc_dbd_id;
    delete from dipchul_di_payblecon_header_ul where dbd_id = vc_dbd_id;
    delete from agd_alloc_group_detail where dbd_id = vc_dbd_id;
    delete from agh_alloc_group_header where dbd_id = vc_dbd_id;
    delete from cigc_contract_item_gmr_cost where dbd_id = vc_dbd_id;
    delete from cs_cost_store where dbd_id = vc_dbd_id;
    delete from dgrd_delivered_grd where dbd_id = vc_dbd_id;
    delete from gmr_goods_movement_record where dbd_id = vc_dbd_id;
    delete from mogrd_moved_out_grd where dbd_id = vc_dbd_id;
    delete from pcad_pc_agency_detail where dbd_id = vc_dbd_id;
    delete from pcbpd_pc_base_price_detail where dbd_id = vc_dbd_id;
    delete from pcbph_pc_base_price_header where dbd_id = vc_dbd_id;
    delete from pcdb_pc_delivery_basis where dbd_id = vc_dbd_id;
    delete from pcdd_document_details where dbd_id = vc_dbd_id;
    delete from pcdiob_di_optional_basis where dbd_id = vc_dbd_id;
    delete from pcdipe_di_pricing_elements where dbd_id = vc_dbd_id;
    delete from pcdiqd_di_quality_details where dbd_id = vc_dbd_id;
    delete from pcdi_pc_delivery_item where dbd_id = vc_dbd_id;
    delete from pcipf_pci_pricing_formula where dbd_id = vc_dbd_id;
    delete from pci_physical_contract_item where dbd_id = vc_dbd_id;
    delete from pcjv_pc_jv_detail where dbd_id = vc_dbd_id;
    delete from pcm_physical_contract_main where dbd_id = vc_dbd_id;
    delete from pcpdqd_pd_quality_details where dbd_id = vc_dbd_id;
    delete from pcpd_pc_product_definition where dbd_id = vc_dbd_id;
    delete from pcpq_pc_product_quality where dbd_id = vc_dbd_id;
    delete from pcqpd_pc_qual_premium_discount where dbd_id = vc_dbd_id;
    delete from pffxd_phy_formula_fx_details where dbd_id = vc_dbd_id;
    delete from pfqpp_phy_formula_qp_pricing where dbd_id = vc_dbd_id;
    delete from ppfd_phy_price_formula_details where dbd_id = vc_dbd_id;
    delete from ppfh_phy_price_formula_header where dbd_id = vc_dbd_id;
    delete from ciqs_contract_item_qty_status where dbd_id = vc_dbd_id;
    delete from diqs_delivery_item_qty_status where dbd_id = vc_dbd_id;
    delete from cqs_contract_qty_status where dbd_id = vc_dbd_id;
    delete from grd_goods_record_detail where dbd_id = vc_dbd_id;
    delete from vd_voyage_detail where dbd_id = vc_dbd_id;
    delete from invd_inventory_detail where dbd_id = vc_dbd_id;
    delete from invm_inventory_master where dbd_id = vc_dbd_id;
    delete from cipd_contract_item_price_daily
     where process_id = pc_process_id;
    delete from poud_phy_open_unreal_daily
     where process_id = pc_process_id;
    delete from psu_phy_stock_unrealized where process_id = pc_process_id;
    delete from md_m2m_daily where process_id = pc_process_id;
    delete from gsc_gmr_sec_cost where process_id = pc_process_id;
    delete from gscs_gmr_sec_cost_summary where process_id = pc_process_id;
    delete from cisc_contract_item_sec_cost
     where process_id = pc_process_id;
    delete from gpd_gmr_price_daily where process_id = pc_process_id;
    delete from pcpch_pc_payble_content_header where dbd_id = vc_dbd_id;
    delete from pqd_payable_quality_details where dbd_id = vc_dbd_id;
    delete from pcepc_pc_elem_payable_content where dbd_id = vc_dbd_id;
    delete from pcth_pc_treatment_header where dbd_id = vc_dbd_id;
    delete from ted_treatment_element_details where dbd_id = vc_dbd_id;
    delete from tqd_treatment_quality_details where dbd_id = vc_dbd_id;
    delete from pcetc_pc_elem_treatment_charge where dbd_id = vc_dbd_id;
    delete from pcar_pc_assaying_rules where dbd_id = vc_dbd_id;
    delete from pcaesl_assay_elem_split_limits where dbd_id = vc_dbd_id;
    delete from arqd_assay_quality_details where dbd_id = vc_dbd_id;
    delete from pcaph_pc_attr_penalty_header where dbd_id = vc_dbd_id;
    delete from pcap_pc_attribute_penalty where dbd_id = vc_dbd_id;
    delete from pqd_penalty_quality_details where dbd_id = vc_dbd_id;
    delete from pad_penalty_attribute_details where dbd_id = vc_dbd_id;
    delete from pcrh_pc_refining_header where dbd_id = vc_dbd_id;
    delete from rqd_refining_quality_details where dbd_id = vc_dbd_id;
    delete from red_refining_element_details where dbd_id = vc_dbd_id;
    delete from pcerc_pc_elem_refining_charge where dbd_id = vc_dbd_id;
    delete from ceqs_contract_ele_qty_status where dbd_id = vc_dbd_id;
    delete from cipde_cipd_element_price where process_id = pc_process_id;
    delete from poue_phy_open_unreal_element
     where process_id = pc_process_id;
    delete from poued_element_details where process_id = pc_process_id;
    delete from gpd_gmr_conc_price_daily where process_id = pc_process_id;
    delete from psue_element_details where process_id = pc_process_id;
    delete from psue_phy_stock_unrealized_ele
     where process_id = pc_process_id;
    delete from dith_di_treatment_header where dbd_id = vc_dbd_id;
    delete from dirh_di_refining_header where dbd_id = vc_dbd_id;
    delete from diph_di_penalty_header where dbd_id = vc_dbd_id;
    delete from cipq_contract_item_payable_qty where dbd_id = vc_dbd_id;
    delete from dipq_delivery_item_payable_qty where dbd_id = vc_dbd_id;
    delete from spq_stock_payable_qty where dbd_id = vc_dbd_id;
    delete from dipch_di_payablecontent_header where dbd_id = vc_dbd_id;
    delete from rgmr_realized_gmr where process_id = pc_process_id;
    delete from rgmrd_realized_gmr_detail where process_id = pc_process_id;
    delete from prd_physical_realized_daily
     where process_id = pc_process_id;
    delete from spd_stock_price_daily where process_id = pc_process_id;
    delete from is_invoice_summary where process_id = pc_process_id;
    delete from cdl_cost_delta_log where dbd_id = vc_dbd_id;
    delete from invs_inventory_sales where process_id = pc_process_id;
    delete from tinvp_temp_invm_cog where process_id = pc_process_id;
    delete from tinvs_temp_invm_cogs where process_id = pc_process_id;
    delete from invm_cog where process_id = pc_process_id;
    delete from invm_cogs where process_id = pc_process_id;
    delete from pa_purchase_accural where process_id = pc_process_id;
    delete from pa_purchase_accural_gmr where process_id = pc_process_id;
  
    vn_logno := vn_logno + 1;
    sp_eodeom_process_log(pc_corporate_id,
                          pd_trade_date,
                          pc_dbd_id,
                          vn_logno,
                          'Rollback End');
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure sp_process_rollback',
                                                           'M2M-013',
                                                           ' Code:' ||
                                                           sqlcode ||
                                                           ' Message:' ||
                                                           sqlerrm,
                                                           '',
                                                           pc_process,
                                                           null, --pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;

  procedure sp_calc_daily_trade_pnl
  --------------------------------------------------------------------------------------------------------------------------
    --        procedure name                            : sp_calc_daily_trade_pnl
    --        author                                    : 
    --        created date                              : 11th Jan 2011
    --        purpose                                   : populate daily trade pnl
    --
    --        parameters
    --        pc_corporate_id                           : corporate id
    --        pd_trade_date                             : trade date
    --        pc_process_id                             : eod reference no
    --
    --        modification history
    --        modified date                             : saurabh
    --        modified by                               : exchange name and exchange id
    --        modify description                        :
    --------------------------------------------------------------------------------------------------------------------------
  (pc_corporate_id varchar2,
   pd_trade_date   date,
   pc_process_id   varchar2,
   pc_process      varchar2,
   pc_user_id      varchar2) is
    vc_prev_process_id varchar2(20);
    vd_prev_eod_date   date;
    vc_prev_eom_ref_no varchar2(20);
    vd_prev_eom_date   date;
    vd_acc_start_date  date;
    gvc_process        varchar2(5);
    --vd_acc_end_date           date;
    vobj_error_log            tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count        number := 1;
    vn_base_currency_decimals number;
  begin
    -------- to get the previous eod reference number and date
    sp_write_log(pc_corporate_id,
                 pd_trade_date,
                 'sp_calc_trade_pnl',
                 'one');
    gvc_process := pc_process;
    begin
      select max(t.trade_date) prev_trade_date,
             substr(max(case
                          when t.process_id is not null then
                           to_char(t.trade_date, 'yyyymmddhh24miss') || t.process_id
                        end),
                    15) prev_process_id
        into vd_prev_eod_date,
             vc_prev_process_id
        from tdc_trade_date_closure t
       where t.trade_date < pd_trade_date
         and t.corporate_id = pc_corporate_id
         and t.process = 'EOD';
    exception
      when no_data_found then
        vc_prev_process_id := null;
        vd_prev_eod_date   := to_date('01-Jan-2000', 'dd-Mon-yyyy');
    end;
    -------- to get the previous eom reference number and date
    sp_write_log(pc_corporate_id,
                 pd_trade_date,
                 'sp_calc_trade_pnl',
                 'two');
    begin
      select tdc.trade_date,
             tdc.process_id
        into vd_prev_eom_date,
             vc_prev_eom_ref_no
        from tdc_trade_date_closure tdc
       where tdc.trade_date = (select max(t.trade_date)
                                 from tdc_trade_date_closure t
                                where t.trade_date < pd_trade_date
                                  and t.corporate_id = pc_corporate_id
                                  and t.process = 'EOM')
         and tdc.corporate_id = pc_corporate_id
         and tdc.process = 'EOM';
    exception
      when no_data_found then
        vc_prev_eom_ref_no := null;
        vd_prev_eom_date   := to_date('01-Jan-2000', 'dd-Mon-yyyy');
    end;
    -- to get the accounding period start year date
    sp_write_log(pc_corporate_id,
                 pd_trade_date,
                 'sp_calc_trade_pnl',
                 'three');
    begin
      select start_date
        into vd_acc_start_date
        from cfy_corporate_financial_year@eka_appdb
       where pd_trade_date between start_date and end_date
         and corporateid = pc_corporate_id;
    exception
      when no_data_found then
        vd_acc_start_date := null;
    end;
    -- get the decimals for the base currency
    sp_write_log(pc_corporate_id,
                 pd_trade_date,
                 'sp_calc_trade_pnl',
                 'threeeeeeee');
    begin
      select nvl(decimals, 2)
        into vn_base_currency_decimals
        from ak_corporate       akc,
             cm_currency_master cm
       where akc.corporate_id = pc_corporate_id
         and akc.base_cur_id = cm.cur_id;
    exception
      when others then
        vn_base_currency_decimals := 2;
    end;
    -----------------------------------------------------------------------------------------
    ------------------record unrealized contracts details------------------------------------
    -----------------------------------------------------------------------------------------
    sp_write_log(pc_corporate_id,
                 pd_trade_date,
                 'sp_calc_trade_pnl',
                 'Before Insert into Trade PNL.....');
    insert into tpd_trade_pnl_daily
      (corporate_id,
       corporate_name,
       process_id,
       profit_center_id,
       profit_center_name,
       profit_center_short_name,
       main_section,
       sub_section,
       year_to_date_pnl,
       prev_month_pnl,
       month_to_date_pnl,
       today_pnl,
       pnl_cur_id,
       pnl_cur_code,
       group_id,
       group_name,
       group_cur_id,
       group_cur_code,
       group_qty_unit_id,
       group_qty_unit,
       unrealized_section,
       is_pending_approval)
      select t.corporate_id,
             t.corporate_name,
             pc_process_id,
             profit_center_id,
             profit_center_name,
             profit_center_short_name,
             main_section,
             sub_section,
             round(nvl(sum(today_pnl), 0) - nvl(sum(prev_yearend_pnl), 0),
                   vn_base_currency_decimals) year_to_date_pnl,
             round(nvl(sum(prev_eom_pnl), 0) -
                   nvl(sum(prev_yearend_pnl), 0),
                   vn_base_currency_decimals) prev_month_pnl,
             decode(gvc_process,
                    'EOM',
                    0,
                    round(nvl(sum(today_pnl), 0) - nvl(sum(prev_eom_pnl), 0),
                          vn_base_currency_decimals)) month_to_date_pnl,
             round(nvl(sum(today_pnl), 0) -
                   nvl(decode(gvc_process, 'EOM', 0, sum(prev_eod_pnl)), 0),
                   vn_base_currency_decimals) today_pnl,
             t.base_cur_id,
             base_cur_code,
             gcd.groupid,
             gcd.groupname,
             gcd.group_cur_id,
             cm_gcd.cur_code,
             gcd.group_qty_unit_id,
             qum_gcd.qty_unit,
             unrealized_section,
             is_pending_approval
        from (select poud.corporate_id,
                     poud.corporate_name,
                     poud.profit_center_id,
                     poud.profit_center_name,
                     poud.profit_center_short_name,
                     poud.main_section,
                     poud.sub_section,
                     0 prev_yearend_pnl,
                     0 prev_eom_pnl,
                     sum(case
                           when poud.process_id = vc_prev_process_id then
                            nvl(poud.pnl, 0)
                           else
                            0
                         end) prev_eod_pnl,
                     sum(case
                           when poud.process_id = pc_process_id then
                            nvl(poud.pnl, 0)
                           else
                            0
                         end) today_pnl,
                     poud.pnl_cur_id base_cur_id,
                     poud.pnl_cur_code base_cur_code,
                     entity unrealized_section,
                     poud.approval_status is_pending_approval
                from pps_physical_pnl_summary poud
               where poud.corporate_id = pc_corporate_id
                 and poud.process_id in (vc_prev_process_id, pc_process_id)
                 and poud.main_section = 'Physical'
                 and poud.sub_section = 'Unrealized'
                 and poud.entity = 'Contract'
               group by poud.corporate_id,
                        poud.corporate_name,
                        poud.profit_center_id,
                        poud.profit_center_name,
                        poud.profit_center_short_name,
                        poud.pnl_cur_id,
                        poud.pnl_cur_code,
                        poud.approval_status,
                        poud.main_section,
                        poud.sub_section,
                        poud.entity
              union all
              select poum.corporate_id,
                     poum.corporate_name,
                     poum.profit_center_id,
                     poum.profit_center_name,
                     poum.profit_center_short_name,
                     'Physical' as main_section,
                     'Unrealized' as sub_section,
                     sum(poum.pnl) prev_yearend_pnl,
                     0 prev_eom_pnl,
                     0 prev_eod_pnl,
                     0 today_pnl,
                     poum.pnl_cur_id base_cur_id,
                     poum.pnl_cur_code base_cur_code,
                     poum.entity unrealized_section,
                     poum.approval_status is_pending_approval
                from pps_physical_pnl_summary poum,
                     (select mec1.corporate_id,
                             max(mec1.trade_date) prev_year_month_end,
                             substr(max(case
                                          when mec1.process_id is not null then
                                           to_char(mec1.trade_date, 'yyyymmddhh24miss') ||
                                           mec1.process_id
                                        end),
                                    15) month_process_id
                        from tdc_trade_date_closure mec1
                       where mec1.corporate_id = pc_corporate_id
                         and mec1.process = 'EOM'
                         and mec1.trade_date <=
                             (select max(end_date)
                                from cfy_corporate_financial_year@eka_appdb
                               where end_date < vd_acc_start_date
                                 and corporateid = pc_corporate_id)
                       group by mec1.corporate_id) prev_month_data
               where poum.corporate_id = pc_corporate_id
                 and poum.main_section = 'Physical'
                 and poum.sub_section = 'Unrealized'
                 and poum.entity = 'Contract'
                 and poum.process_id = prev_month_data.month_process_id
                 and poum.corporate_id = prev_month_data.corporate_id
               group by poum.corporate_id,
                        poum.corporate_name,
                        poum.profit_center_id,
                        poum.profit_center_name,
                        poum.profit_center_short_name,
                        poum.pnl_cur_id,
                        poum.pnl_cur_code,
                        poum.approval_status,
                        poum.main_section,
                        poum.sub_section,
                        poum.entity
              union all
              select poum.corporate_id,
                     poum.corporate_name,
                     poum.profit_center_id,
                     poum.profit_center_name,
                     poum.profit_center_short_name,
                     poum.main_section,
                     poum.sub_section,
                     0 prev_yearend_pnl,
                     sum(poum.pnl) prev_eom_pnl,
                     0 prev_eod_pnl,
                     0 today_pnl,
                     poum.pnl_cur_id base_cur_id,
                     poum.pnl_cur_code base_cur_code,
                     poum.entity unrealized_section,
                     poum.approval_status is_pending_approval
                from pps_physical_pnl_summary poum
               where poum.corporate_id = pc_corporate_id
                 and poum.main_section = 'Physical'
                 and poum.sub_section = 'Unrealized'
                 and poum.entity = 'Contract'
                 and poum.process_id = vc_prev_eom_ref_no
               group by poum.corporate_id,
                        poum.corporate_name,
                        poum.profit_center_id,
                        poum.profit_center_name,
                        poum.profit_center_short_name,
                        poum.pnl_cur_id,
                        poum.pnl_cur_code,
                        poum.approval_status,
                        poum.main_section,
                        poum.sub_section,
                        poum.entity
              union all
              select psud.corporate_id,
                     psud.corporate_name,
                     psud.profit_center_id,
                     psud.profit_center_name,
                     psud.profit_center_short_name,
                     psud.main_section,
                     psud.sub_section,
                     0 prev_yearend_pnl,
                     0 prev_eom_pnl,
                     sum(case
                           when psud.process_id = vc_prev_process_id then
                            nvl(psud.pnl, 0)
                           else
                            0
                         end) prev_eod_pnl,
                     sum(case
                           when psud.process_id = pc_process_id then
                            nvl(psud.pnl, 0)
                           else
                            0
                         end) today_pnl,
                     psud.pnl_cur_id,
                     psud.pnl_cur_code,
                     psud.entity unrealized_section,
                     'N' is_pending_approval
                from pps_physical_pnl_summary psud
               where psud.corporate_id = pc_corporate_id
                 and psud.process_id in (vc_prev_process_id, pc_process_id)
                 and psud.main_section = 'Physical'
                 and psud.sub_section = 'Unrealized'
                 and psud.entity = 'Stock'
               group by psud.corporate_id,
                        psud.corporate_name,
                        psud.profit_center_id,
                        psud.profit_center_name,
                        psud.profit_center_short_name,
                        psud.pnl_cur_id,
                        psud.pnl_cur_code,
                        psud.main_section,
                        psud.sub_section,
                        psud.entity
              union all
              select psum.corporate_id,
                     psum.corporate_name,
                     psum.profit_center_id,
                     psum.profit_center_name,
                     psum.profit_center_short_name,
                     psum.main_section,
                     psum.sub_section,
                     sum(psum.pnl) prev_yearend_pnl,
                     0 prev_eom_pnl,
                     0 prev_eod_pnl,
                     0 today_pnl,
                     psum.pnl_cur_id,
                     psum.pnl_cur_code,
                     psum.entity unrealized_section,
                     psum.approval_status is_pending_approval
                from pps_physical_pnl_summary psum,
                     (select mec1.corporate_id,
                             max(mec1.trade_date) prev_year_month_end,
                             substr(max(case
                                          when mec1.process_id is not null then
                                           to_char(mec1.trade_date, 'yyyymmddhh24miss') ||
                                           mec1.process_id
                                        end),
                                    15) month_process_id
                        from tdc_trade_date_closure mec1
                       where mec1.corporate_id = pc_corporate_id
                         and mec1.process = 'EOM'
                         and mec1.trade_date <=
                             (select max(end_date)
                                from cfy_corporate_financial_year@eka_appdb
                               where end_date < vd_acc_start_date
                                 and corporateid = pc_corporate_id)
                       group by mec1.corporate_id) prev_month_data
               where psum.corporate_id = pc_corporate_id
                 and psum.main_section = 'Physical'
                 and psum.sub_section = 'Unrealized'
                 and psum.entity = 'Stock'
                 and psum.process_id = prev_month_data.month_process_id
                 and psum.corporate_id = prev_month_data.corporate_id
               group by psum.corporate_id,
                        psum.corporate_name,
                        psum.profit_center_short_name,
                        psum.profit_center_name,
                        psum.profit_center_id,
                        psum.pnl_cur_id,
                        psum.pnl_cur_code,
                        psum.approval_status,
                        psum.main_section,
                        psum.sub_section,
                        psum.entity
              union all
              select psum.corporate_id,
                     psum.corporate_name,
                     psum.profit_center_id,
                     psum.profit_center_name,
                     psum.profit_center_short_name,
                     psum.main_section,
                     psum.sub_section,
                     0 prev_yearend_pnl,
                     sum(psum.pnl) prev_eom_pnl,
                     0 prev_eod_pnl,
                     0 today_pnl,
                     psum.pnl_cur_id,
                     psum.pnl_cur_code,
                     psum.entity unrealized_section,
                     psum.approval_status is_pending_approval
                from pps_physical_pnl_summary psum
               where psum.corporate_id = pc_corporate_id
                 and psum.main_section = 'Physical'
                 and psum.sub_section = 'Unrealized'
                 and psum.entity = 'Stock'
                 and psum.process_id = vc_prev_eom_ref_no
               group by psum.corporate_id,
                        psum.corporate_name,
                        psum.profit_center_id,
                        psum.profit_center_short_name,
                        psum.profit_center_name,
                        psum.pnl_cur_id,
                        psum.approval_status,
                        psum.pnl_cur_code,
                        psum.main_section,
                        psum.sub_section,
                        psum.entity) t,
             gcd_groupcorporatedetails@eka_appdb gcd,
             ak_corporate akc,
             qum_quantity_unit_master qum_gcd,
             cm_currency_master cm_gcd
       where t.corporate_id = akc.corporate_id
         and akc.groupid = gcd.groupid
         and gcd.group_cur_id = cm_gcd.cur_id
         and gcd.group_qty_unit_id = qum_gcd.qty_unit_id
       group by t.corporate_id,
                t.corporate_name,
                profit_center_id,
                profit_center_name,
                profit_center_short_name,
                main_section,
                sub_section,
                t.base_cur_id, --
                base_cur_code,
                gcd.groupid,
                gcd.groupname,
                gcd.group_cur_id,
                cm_gcd.cur_code,
                gcd.group_qty_unit_id,
                qum_gcd.qty_unit,
                unrealized_section,
                is_pending_approval;
    -----------------------------------------------------------------------------------------
    ------------------record realized physical contracts details----------------------------------
    -----------------------------------------------------------------------------------------
    insert into tpd_trade_pnl_daily
      (corporate_id,
       corporate_name,
       process_id,
       profit_center_id,
       profit_center_name,
       profit_center_short_name,
       main_section,
       sub_section,
       year_to_date_pnl,
       prev_month_pnl,
       month_to_date_pnl,
       today_pnl,
       pnl_cur_id,
       pnl_cur_code,
       group_id,
       group_name,
       group_cur_id,
       group_cur_code,
       group_qty_unit_id,
       group_qty_unit,
       unrealized_section,
       is_pending_approval)
      select t.corporate_id,
             t.corporate_name,
             pc_process_id,
             profit_center_id,
             profit_center_name,
             profit_center_short_name,
             'Physical' as main_section,
             'Realized' as sub_section,
             round(sum(prev_month) +
                   decode(gvc_process,
                          'EOM',
                          sum(today),
                          sum(month_to_date)),
                   vn_base_currency_decimals) year_to_date_pnl,
             round(sum(prev_month), vn_base_currency_decimals) previous_month_pnl,
             round(decode(gvc_process, 'EOM', 0, sum(month_to_date)),
                   vn_base_currency_decimals) month_to_date_pnl,
             round(sum(today), vn_base_currency_decimals) today_pnl,
             t.base_cur_id,
             base_cur_code,
             gcd.groupid,
             gcd.groupname,
             gcd.group_cur_id,
             cm_gcd.cur_code,
             gcd.group_qty_unit_id,
             qum_gcd.qty_unit,
             unrealized_section,
             is_pending_approval
        from (select prd.corporate_id,
                     prd.corporate_name,
                     prd.profit_center_id,
                     prd.profit_center_name,
                     prd.profit_center_short_name,
                     'Physical' as main_section,
                     'Realized' as sub_section,
                     0 prev_month,
                     sum(prd.pnl) month_to_date,
                     sum((case
                           when tdc.trade_date = pd_trade_date then
                            prd.pnl
                           else
                            0
                         end)) today,
                     prd.pnl_cur_id base_cur_id,
                     prd.pnl_cur_code base_cur_code,
                     'Physical' unrealized_section,
                     'N' is_pending_approval
                from pps_physical_pnl_summary prd,
                     tdc_trade_date_closure   tdc
               where prd.corporate_id = pc_corporate_id
                 and prd.process_id = tdc.process_id
                 and prd.corporate_id = tdc.corporate_id
                 and tdc.trade_date <= pd_trade_date
                 and tdc.trade_date > vd_prev_eom_date
                 and prd.main_section = 'Physical'
                 and prd.sub_section = 'Realized'
                 and prd.entity = 'Physical'
               group by prd.corporate_id,
                        prd.corporate_name,
                        prd.profit_center_id,
                        profit_center_name,
                        prd.profit_center_short_name,
                        prd.pnl_cur_id,
                        prd.pnl_cur_code
              union all
              select prm.corporate_id,
                     prm.corporate_name,
                     prm.profit_center_id,
                     prm.profit_center_name,
                     prm.profit_center_short_name,
                     'Physical' as main_section,
                     'Realized' as sub_section,
                     sum(prm.pnl) prev_month,
                     0 month_to_date,
                     0 today,
                     prm.pnl_cur_id,
                     prm.pnl_cur_code,
                     'Physical' unrealized_section,
                     'N' is_pending_approval
                from pps_physical_pnl_summary prm,
                     tdc_trade_date_closure   mec
               where prm.corporate_id = mec.corporate_id
                 and prm.process_id = mec.process_id
                 and mec.process = 'EOM'
                 and prm.corporate_id = pc_corporate_id
                 and mec.trade_date >= vd_acc_start_date
                 and mec.trade_date <= vd_prev_eom_date
                 and prm.main_section = 'Physical'
                 and prm.sub_section = 'Realized'
                 and prm.entity = 'Physical'
               group by prm.corporate_id,
                        prm.corporate_name,
                        prm.profit_center_id,
                        prm.profit_center_name,
                        prm.profit_center_short_name,
                        prm.pnl_cur_id,
                        prm.pnl_cur_code) t,
             gcd_groupcorporatedetails@eka_appdb gcd,
             ak_corporate akc,
             qum_quantity_unit_master qum_gcd,
             cm_currency_master cm_gcd
       where t.corporate_id = akc.corporate_id
         and akc.groupid = gcd.groupid
         and gcd.group_cur_id = cm_gcd.cur_id
         and gcd.group_qty_unit_id = qum_gcd.qty_unit_id
       group by t.corporate_id,
                t.corporate_name,
                profit_center_id,
                profit_center_name,
                profit_center_short_name,
                unrealized_section,
                is_pending_approval,
                t.base_cur_id, --
                base_cur_code,
                gcd.groupid,
                gcd.groupname,
                gcd.group_cur_id,
                cm_gcd.cur_code,
                gcd.group_qty_unit_id,
                qum_gcd.qty_unit;
    --------------------------------------------------------------------------------------
    ------------------record direct to realized costs details----------------------------------
    --------------------------------------------------------------------------------------
    /*insert into tpd_trade_pnl_daily
    (corporate_id,
     corporate_name,
     process_id,
     profit_center_id,
     profit_center_name,
     profit_center_short_name,
     main_section,
     sub_section,
     year_to_date_pnl,
     prev_month_pnl,
     month_to_date_pnl,
     today_pnl,
     pnl_cur_id,
     pnl_cur_code,
     group_id,
     group_name,
     group_cur_id,
     group_cur_code,
     group_qty_unit_id,
     group_qty_unit,
     unrealized_section,
     is_pending_approval)
    select t.corporate_id,
           t.corporate_name,
           pc_process_id,
           profit_center_id,
           profit_center_name,
           profit_center_short_name,
           'Physical' as main_section,
           'Direct to Realized Cost' as sub_section,
           round(sum(prev_month) + decode(gvc_process,'EOM',sum(today),sum(month_to_date)),
                 vn_base_currency_decimals) year_to_date_pnl,
           round(sum(prev_month),
                 vn_base_currency_decimals) previous_month_pnl,
           round(decode(gvc_process,'EOM',0,sum(month_to_date)),
                 vn_base_currency_decimals) month_to_date_pnl,
           round(sum(today),
                 vn_base_currency_decimals) today_pnl,
           t.base_cur_id,
           base_cur_code,
           gcd.groupid,
           gcd.groupname,
           gcd.group_cur_id,
           cm_gcd.cur_code,
           gcd.group_qty_unit_id,
           qum_gcd.qty_unit,
           unrealized_section,
           is_pending_approval
    from   (select gdrc.corporate_id,
                   akc.corporate_name,
                   gdrc.profit_center_id,
                   cpc.profit_center_name,
                   cpc.profit_center_short_name,
                   'Physical' as main_section,
                   'Direct to Realized Cost' as sub_section,
                   0 prev_month,
                   sum(gdrc.dtrc_cost) month_to_date,
                   sum((case
                           when tdc.trade_date = pd_trade_date then
                            gdrc.dtrc_cost
                           else
                            0
                       end)) today,
                   akc.base_cur_id base_cur_id,
                   akc.base_currency_name base_cur_code,
                   'Physical' unrealized_section,
                   'N' is_pending_approval
            from   gdrc_gmr_direct_realized_cost gdrc,
                   cpc_corporate_profit_center cpc,
                   tdc_trade_date_closure   tdc,
                   ak_corporate akc
            where  gdrc.corporate_id = pc_corporate_id
            and    gdrc.process_id = tdc.process_id
            and    gdrc.corporate_id = tdc.corporate_id
            and    tdc.trade_date <= pd_trade_date
            and    tdc.trade_date > vd_prev_eom_date
            and    gdrc.profit_center_id = cpc.profit_center_id
            and    gdrc.corporate_id = akc.corporate_id
            group  by gdrc.corporate_id,
                      akc.corporate_name,
                      gdrc.profit_center_id,
                      cpc.profit_center_name,
                      cpc.profit_center_short_name,
                      akc.base_cur_id,
                      akc.base_currency_name
            union all
            select gdrc.corporate_id,
                   akc.corporate_name,
                   gdrc.profit_center_id,
                   cpc.profit_center_name,
                   cpc.profit_center_short_name,
                   'Physical' as main_section,
                   'Direct to Realized Cost' as sub_section,
                   sum(gdrc.dtrc_cost) prev_month,
                   0 month_to_date,
                   0 today,
                   akc.base_cur_id base_cur_id,
                   akc.base_currency_name base_cur_code,
                   'Physical' unrealized_section,
                   'N' is_pending_approval
            from   gdrc_gmr_direct_realized_cost gdrc,
                   cpc_corporate_profit_center cpc,
                   tdc_trade_date_closure   tdc,
                   ak_corporate akc
            where  gdrc.corporate_id = pc_corporate_id
            and    gdrc.process_id = tdc.process_id
            and    gdrc.corporate_id = tdc.corporate_id
            and    tdc.process = 'EOM'
            and    tdc.trade_date <= vd_prev_eom_date
            and    tdc.trade_date >= vd_acc_start_date
            and    gdrc.profit_center_id = cpc.profit_center_id
            and    gdrc.corporate_id = akc.corporate_id
            group  by gdrc.corporate_id,
                      akc.corporate_name,
                      gdrc.profit_center_id,
                      cpc.profit_center_name,
                      cpc.profit_center_short_name,
                      akc.base_cur_id,
                      akc.base_currency_name) t,
           gcd_groupcorporatedetails@eka_appdb gcd,
           ak_corporate@eka_appdb akc,
           qum_quantity_unit_master qum_gcd,
           cm_currency_master cm_gcd
    where  t.corporate_id = akc.corporate_id
    and    akc.groupid = gcd.groupid
    and    gcd.group_cur_id = cm_gcd.cur_id
    and    gcd.group_qty_unit_id = qum_gcd.qty_unit_id
    group  by t.corporate_id,
              t.corporate_name,
              profit_center_id,
              profit_center_name,
              profit_center_short_name,
              unrealized_section,
              is_pending_approval,
              t.base_cur_id, --
              base_cur_code,
              gcd.groupid,
              gcd.groupname,
              gcd.group_cur_id,
              cm_gcd.cur_code,
              gcd.group_qty_unit_id,
              qum_gcd.qty_unit;*/
    -------------------------------------------------------------------------------------------
    -------------record carrying costs details----------------------------------------
    -------------------------------------------------------------------------------------------
    insert into tpd_trade_pnl_daily
      (corporate_id,
       corporate_name,
       process_id,
       profit_center_id,
       profit_center_name,
       profit_center_short_name,
       main_section,
       sub_section,
       year_to_date_pnl,
       prev_month_pnl,
       month_to_date_pnl,
       today_pnl,
       pnl_cur_id,
       pnl_cur_code,
       group_id,
       group_name,
       group_cur_id,
       group_cur_code,
       group_qty_unit_id,
       group_qty_unit,
       unrealized_section,
       is_pending_approval,
       exchange_id,
       exchange_name)
      select corporate_id,
             corporate_name,
             pc_process_id,
             profit_center_id,
             profit_center_name,
             profit_center_short_name,
             main_section,
             sub_section,
             round(today, vn_base_currency_decimals) ytd_pnl,
             round(prev_month, vn_base_currency_decimals) previous_month_pnl,
             round((today - prev_month), vn_base_currency_decimals) mtd_pnl,
             round(decode(gvc_process, 'EOM', 0, (today - prev_day)),
                   vn_base_currency_decimals) today_pnl,
             cur_id,
             cur_code,
             group_id,
             group_name,
             group_cur_id,
             group_cur_code,
             group_qty_unit_id,
             group_qty_unit,
             unrealized_section,
             is_pending_approval,
             '' exchange_id,
             '' exchange_name
        from (select cps.corporate_id,
                     akc.corporate_name,
                     cps.profit_center_id,
                     cps.profit_center_name,
                     cps.profit_center_short_name,
                     'Carrying Costs' as main_section,
                     cps.sub_section as sub_section,
                     sum((case
                           when cps.process_id = vc_prev_eom_ref_no then
                            nvl(cps.cost_amt, 0)
                           else
                            0
                         end)) prev_month,
                     0 prev_day,
                     0 today,
                     cps.cost_cur_id cur_id,
                     cps.cost_cur_code cur_code,
                     gcd.groupid group_id,
                     gcd.groupname group_name,
                     gcd.group_cur_id group_cur_id,
                     cm_gcd.cur_code group_cur_code,
                     gcd.group_qty_unit_id group_qty_unit_id,
                     qum_gcd.qty_unit group_qty_unit,
                     '' unrealized_section,
                     'N' is_pending_approval
                from cps_cost_pnl_summary                cps,
                     ak_corporate                        akc,
                     gcd_groupcorporatedetails@eka_appdb gcd,
                     cm_currency_master                  cm_akc,
                     cm_currency_master                  cm_gcd,
                     cm_currency_master                  cm_cps,
                     qum_quantity_unit_master            qum_gcd
               where cps.corporate_id = akc.corporate_id
                 and akc.base_currency_name = cm_akc.cur_code
                 and akc.groupid = gcd.groupid
                 and gcd.group_cur_id = cm_gcd.cur_id
                 and gcd.group_qty_unit_id = qum_gcd.qty_unit_id
                 and cm_cps.cur_id = cps.cost_cur_id
                 and cps.process_id = vc_prev_eom_ref_no
                 and cps.main_section = 'Carrying Costs'
               group by cps.corporate_id,
                        akc.corporate_name,
                        cps.profit_center_id,
                        cps.profit_center_name,
                        cps.profit_center_short_name,
                        cps.sub_section,
                        cps.cost_cur_id,
                        cps.cost_cur_code,
                        gcd.groupid,
                        gcd.groupname,
                        gcd.group_cur_id,
                        cm_gcd.cur_code,
                        gcd.group_qty_unit_id,
                        qum_gcd.qty_unit) temp;
    insert into tpd_trade_pnl_daily
      (corporate_id,
       corporate_name,
       process_id,
       profit_center_id,
       profit_center_name,
       profit_center_short_name,
       main_section,
       sub_section,
       year_to_date_pnl,
       prev_month_pnl,
       month_to_date_pnl,
       today_pnl,
       pnl_cur_id,
       pnl_cur_code,
       group_id,
       group_name,
       group_cur_id,
       group_cur_code,
       group_qty_unit_id,
       group_qty_unit,
       unrealized_section,
       is_pending_approval)
      select pc_corporate_id,
             t.corporate_name,
             pc_process_id,
             t.profit_center_id,
             t.profit_center_name,
             t.profit_center_short_name,
             t.main_section,
             t.sub_section,
             sum(t.previous_month_pnl) + sum(t.month_to_date_pnl) year_to_date_pnl,
             sum(t.previous_month_pnl) prev_month_pnl,
             sum(t.month_to_date_pnl) month_to_date_pnl,
             sum(t.today_pnl) today_pnl,
             t.base_cur_id,
             t.base_cur_code,
             gcd.groupid group_id,
             gcd.groupname group_name,
             gcd.group_cur_id group_cur_id,
             cm.cur_code group_cur_code,
             gcd.group_qty_unit_id group_qty_unit_id,
             qum.qty_unit group_qty_unit,
             t.unrealized_section,
             'N' is_pending_approval
        from (select cps.corporate_id,
                     cps.corporate_name,
                     cps.profit_center_id,
                     cps.profit_center_name,
                     cps.profit_center_short_name,
                     cps.main_section,
                     'Write Off Stock' sub_section,
                     sum(case
                           when cps.process_id = pc_process_id then
                            cps.cost_amt
                           else
                            0
                         end) today_pnl,
                     sum(cps.cost_amt) month_to_date_pnl,
                     0 previous_month_pnl,
                     cps.cost_cur_id base_cur_id,
                     cps.cost_cur_code base_cur_code,
                     cps.entity unrealized_section,
                     'N' is_pending_approval
                from cps_cost_pnl_summary   cps,
                     tdc_trade_date_closure tdc
               where cps.corporate_id = pc_corporate_id
                 and tdc.corporate_id = pc_corporate_id
                 and cps.process_id = tdc.process_id
                 and tdc.process = 'EOD'
                 and cps.process_id = pc_process_id
                 and cps.main_section = 'General Cost'
                 and cps.sub_section in
                     ('Write Off Stock', 'Undo Write-Off Stocks')
                 and tdc.trade_date <= pd_trade_date
                 and tdc.trade_date > vd_prev_eom_date
               group by cps.corporate_id,
                        cps.corporate_name,
                        cps.profit_center_id,
                        cps.profit_center_name,
                        cps.profit_center_short_name,
                        cps.main_section,
                        cps.cost_cur_id,
                        cps.cost_cur_code,
                        cps.entity) t,
             gcd_groupcorporatedetails@eka_appdb gcd,
             ak_corporate akc,
             cm_currency_master cm,
             qum_quantity_unit_master qum
       where akc.corporate_id = t.corporate_id
         and akc.groupid = gcd.groupid
         and cm.cur_id = gcd.group_cur_id
         and qum.qty_unit_id = gcd.group_qty_unit_id
       group by t.corporate_id,
                t.corporate_name,
                t.profit_center_id,
                t.profit_center_name,
                t.profit_center_short_name,
                t.main_section,
                t.sub_section,
                t.base_cur_id,
                t.base_cur_code,
                gcd.groupid,
                gcd.groupname,
                gcd.group_cur_id,
                cm.cur_code,
                gcd.group_qty_unit_id,
                qum.qty_unit,
                t.unrealized_section;
    ----ends here      
    -------------record physical write off section for realized-----------------------
    -------------record direct to realized costs details------------------------------   
    -- This is to populate missing sections
    -- Any section that needs data population has to be done before this
    /* INSERT INTO tpd_trade_pnl_daily
        (corporate_id,
         corporate_name,
         process_id,
         profit_center_id,
         profit_center_name,
         profit_center_short_name,
         main_section,
         sub_section,
         year_to_date_pnl,
         prev_month_pnl,
         month_to_date_pnl,
         today_pnl,
         pnl_cur_id,
         pnl_cur_code,
         group_id,
         group_name,
         group_cur_id,
         group_cur_code,
         group_qty_unit_id,
         group_qty_unit,
         unrealized_section,
         is_pending_approval)
        SELECT corporate_id,
               corporate_name,
               pc_process_id,
               cpc.profit_center_id,
               cpc.profit_center_name,
               cpc.profit_center_short_name,
               tps.main_section,
               tps.sub_section,
               0,
               0,
               0,
               0,
               cm_akc.cur_id,
               cm_akc.cur_code,
               gcd.groupid,
               gcd.groupname,
               gcd.group_cur_id,
               cm_gcd.cur_code,
               qum_gcd.qty_unit_id,
               qum_gcd.qty_unit,
               tps.entity,
               'N'
        FROM   ak_corporate                akc,
               cpc_corporate_profit_center cpc,
               tps_trade_pnl_sections      tps,
               cm_currency_master          cm_akc,
               gcd_groupcorporatedetails   gcd,
               cm_currency_master          cm_gcd,
               qum_quantity_unit_master    qum_gcd
        WHERE  akc.base_currency_name = cm_akc.cur_code
        AND    akc.groupid = gcd.groupid
        AND    gcd.group_cur_id = cm_gcd.cur_id
        AND    gcd.group_qty_unit_id = qum_gcd.qty_unit_id
        AND    cpc.corporateid = akc.corporate_id
        AND    tps.is_exchange_required = 'N'
        AND    cpc.corporateid = pc_corporate_id
        AND    NOT EXISTS
         (SELECT *
                FROM   tpd_trade_pnl_daily tpd
                WHERE  tpd.process_id = pc_process_id
                AND    tpd.main_section = tps.main_section
                AND    tpd.sub_section = tps.sub_section
                AND    tpd.unrealized_section = tps.entity
                AND    tpd.profit_center_id = cpc.profit_center_id);
    -- Exchange Based Data
    INSERT INTO tpd_trade_pnl_daily
        (corporate_id,
         corporate_name,
         process_id,
         profit_center_id,
         profit_center_name,
         profit_center_short_name,
         main_section,
         sub_section,
         year_to_date_pnl,
         prev_month_pnl,
         month_to_date_pnl,
         today_pnl,
         pnl_cur_id,
         pnl_cur_code,
         group_id,
         group_name,
         group_cur_id,
         group_cur_code,
         group_qty_unit_id,
         group_qty_unit,
         unrealized_section,
         is_pending_approval,
         exchange_id,
         exchange_name)
        SELECT corporate_id,
               corporate_name,
               pc_process_id,
               cpc.profit_center_id,
               cpc.profit_center_name,
               cpc.profit_center_short_name,
               tps.main_section,
               tps.sub_section,
               0,
               0,
               0,
               0,
               cm_akc.cur_id,
               cm_akc.cur_code,
               gcd.groupid,
               gcd.groupname,
               gcd.group_cur_id,
               cm_gcd.cur_code,
               qum_gcd.qty_unit_id,
               qum_gcd.qty_unit,
               tps.entity,
               'N',
               emt.exchange_id,
               emt.exchange_name
        FROM   ak_corporate                akc,
               cpc_corporate_profit_center cpc,
               tps_trade_pnl_sections      tps,
               cm_currency_master          cm_akc,
               gcd_groupcorporatedetails   gcd,
               cm_currency_master          cm_gcd,
               qum_quantity_unit_master    qum_gcd,
               emt_exchangemaster          emt
        WHERE  akc.base_currency_name = cm_akc.cur_code
        AND    akc.groupid = gcd.groupid
        AND    gcd.group_cur_id = cm_gcd.cur_id
        AND    gcd.group_qty_unit_id = qum_gcd.qty_unit_id
        AND    cpc.corporateid = akc.corporate_id
        AND    tps.is_exchange_required = 'Y'
        AND    cpc.corporateid = pc_corporate_id
        AND    NOT EXISTS
         (SELECT *
                FROM   tpd_trade_pnl_daily tpd
                WHERE  tpd.process_id = pc_process_id
                AND    tpd.main_section = tps.main_section
                AND    tpd.sub_section = tps.sub_section
                AND    tpd.unrealized_section = tps.entity
                AND    tpd.profit_center_id = cpc.profit_center_id
                AND    tpd.exchange_id = emt.exchange_id);*/
    ----PARAMETER INSERT
    insert into tpp_trade_pnl_parameters
      (process_id,
       prev_process_id,
       prev_eod_date,
       prev_eom_ref_no,
       prev_eom_date,
       acc_start_date)
    values
      (pc_process_id,
       vc_prev_process_id,
       vd_prev_eod_date,
       vc_prev_eom_ref_no,
       vd_prev_eom_date,
       vd_acc_start_date);
    ----ENDS HERE 
  
    commit;
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure sp_calc_daily_trade_pnl',
                                                           'M2M-013',
                                                           'Code:' ||
                                                           sqlcode ||
                                                           'Message:' ||
                                                           sqlerrm,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;

  procedure sp_calc_pnl_summary(pc_corporate_id varchar2,
                                pd_trade_date   date,
                                pc_process_id   varchar2,
                                pc_process      varchar2,
                                pc_user_id      varchar2) is
    vobj_error_log     tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count number := 1;
    gvc_process        varchar2(5);
  begin
    --
    -- record physical unrealized pnl
    --the below part is still commented as it is for stocks.
    --
    gvc_process := pc_process;
    insert into pps_physical_pnl_summary
      (corporate_id,
       corporate_name,
       process_id,
       profit_center_id,
       profit_center_short_name,
       profit_center_name,
       main_section,
       sub_section,
       entity,
       pnl,
       pnl_cur_id,
       pnl_cur_code,
       approval_status)
      select poud.corporate_id,
             poud.corporate_name,
             pc_process_id,
             poud.profit_center_id,
             poud.profit_center_short_name,
             poud.profit_center_name,
             'Physical' as main_section,
             'Unrealized' as sub_section,
             'Contract' entity,
             sum(poud.unrealized_pnl_in_base_cur) pnl,
             poud.base_cur_id pnl_cur_id,
             poud.base_cur_code pnl_cur_code,
             (case
               when nvl(poud.approval_status, 'NA') = 'Pending Approval' then
                'Y'
               else
                'N'
             end) is_pending_approval
        from poud_phy_open_unreal_daily poud
       where poud.corporate_id = pc_corporate_id
         and poud.process_id = pc_process_id
         and poud.unrealized_type in ('Unrealized')
       group by poud.corporate_id,
                poud.corporate_name,
                poud.profit_center_id,
                poud.profit_center_name,
                poud.profit_center_short_name,
                poud.base_cur_id,
                poud.base_cur_code,
                poud.approval_status
      union all
      select psu.corporate_id,
             akc.corporate_name,
             pc_process_id,
             cpc.profit_center_id,
             cpc.profit_center_short_name,
             cpc.profit_center_name,
             'Physical' as main_section,
             'Unrealized' as sub_section,
             'Stock' entity,
             sum(psu.pnl_in_base_cur),
             psu.base_cur_id,
             psu.base_cur_code,
             'N'
        from psu_phy_stock_unrealized    psu,
             ak_corporate                akc,
             cpc_corporate_profit_center cpc
       where psu.corporate_id = pc_corporate_id
         and akc.corporate_id = psu.corporate_id
         and psu.process_id = pc_process_id
         and psu.pnl_type in ('Unrealized')
         and psu.profit_center_id = cpc.profit_center_id
       group by psu.corporate_id,
                akc.corporate_name,
                cpc.profit_center_id,
                cpc.profit_center_name,
                cpc.profit_center_short_name,
                psu.base_cur_id,
                psu.base_cur_code
      union all
      ---- record physical open unrealized for element
      select poue.corporate_id,
             poue.corporate_name,
             pc_process_id,
             poue.profit_center_id,
             poue.profit_center_short_name,
             poue.profit_center_name,
             'Physical' as main_section,
             'Unrealized' as sub_section,
             'Contract' entity,
             sum(poue.unrealized_pnl_in_base_cur) pnl,
             poue.base_cur_id pnl_cur_id,
             poue.base_cur_code pnl_cur_code,
             (case
               when nvl(poue.approval_status, 'NA') = 'Pending Approval' then
                'Y'
               else
                'N'
             end) is_pending_approval
        from poue_phy_open_unreal_element poue
       where poue.corporate_id = pc_corporate_id
         and poue.process_id = pc_process_id
         and poue.unrealized_type in ('Unrealized')
       group by poue.corporate_id,
                poue.corporate_name,
                poue.profit_center_id,
                poue.profit_center_name,
                poue.profit_center_short_name,
                poue.base_cur_id,
                poue.base_cur_code,
                poue.approval_status
      -----
      union all
      ---------- record physical stock unrealized for element
      select psue.corporate_id,
             akc.corporate_name,
             pc_process_id,
             psue.profit_center_id,
             psue.profit_center_short_name,
             psue.profit_center_name,
             'Physical' as main_section,
             'Unrealized' as sub_section,
             'Stock' entity,
             sum(psue.pnl_in_base_cur),
             psue.base_cur_id,
             psue.base_cur_code,
             'N'
        from psue_phy_stock_unrealized_ele psue,
             ak_corporate                  akc
       where psue.corporate_id = pc_corporate_id
         and akc.corporate_id = psue.corporate_id
         and psue.process_id = pc_process_id
         and psue.pnl_type in ('Unrealized')
       group by psue.corporate_id,
                akc.corporate_name,
                psue.profit_center_id,
                psue.profit_center_name,
                psue.profit_center_short_name,
                psue.base_cur_id,
                psue.base_cur_code;
    ---------- 
    --
    -- record physical realized pnl
    --
    insert into pps_physical_pnl_summary
      (corporate_id,
       corporate_name,
       process_id,
       profit_center_id,
       profit_center_short_name,
       profit_center_name,
       main_section,
       sub_section,
       entity,
       pnl,
       pnl_cur_id,
       pnl_cur_code,
       approval_status)
      select prd.corporate_id,
             prd.corporate_name,
             pc_process_id,
             prd.profit_center_id,
             prd.profit_center_short_name,
             prd.profit_center_name,
             'Physical' as main_section,
             'Realized' as sub_section,
             'Physical' entity,
             sum(case
                   when prd.realized_type in
                        ('Realized Today', 'Reverse Realized',
                         'Reversal of Special Settlements', 'Special Settlements') then
                    nvl(prd.realized_pnl, 0)
                   when prd.realized_type in ('Previously Realized Price fixed today',
                         'Previously Realized PNL Change') then
                    nvl(prd.realized_pnl, 0) - nvl(prd.prev_real_pnl, 0)
                   else
                    0
                 end),
             prd.base_cur_id,
             prd.base_cur_code,
             'N' is_pending_approval
        from prd_physical_realized_daily prd
       where prd.corporate_id = pc_corporate_id
         and prd.process_id = pc_process_id
       group by prd.corporate_id,
                prd.corporate_name,
                prd.profit_center_id,
                prd.profit_center_short_name,
                prd.profit_center_name,
                prd.base_cur_id,
                prd.base_cur_code;
    commit;
  
    --
    -- record currency - unrealized pnl
    --
    --    insert into cps_curremcy_pnl_summary
    --      (corporate_id,
    --       corporate_name,
    --       process_id,
    --       profit_center_id,
    --       profit_center_name,
    --       profit_center_short_name,
    --       main_section,
    --       sub_section,
    --       pnl,
    --       pnl_cur_id,
    --       pnl_cur_code)
    --      select cpd.corporate_id,
    --             cpd.corporate_name,
    --             cpd.process_id,
    --             cpd.profit_center_id,
    --             cpd.profit_center_name,
    --             cpc.profit_center_short_name,
    --             'Currency' main_section,
    --             'Unrealized' sub_section,
    --             sum(cpd.pnl_value_in_home_currency) pnl,
    --             cpd.home_cur_id,
    --             cpd.home_currency
    --        from cpd_currency_pnl_daily      cpd,
    --             cpc_corporate_profit_center cpc
    --       where cpd.profit_center_id = cpc.profit_center_id
    --         and upper(cpd.pnl_type) = 'UNREALIZED'
    --         and cpd.process_id = pc_process_id
    --         and cpd.corporate_id = pc_corporate_id
    --       group by cpd.corporate_id,
    --                cpd.corporate_name,
    --                cpd.process_id,
    --                cpd.profit_center_id,
    --                cpd.profit_center_name,
    --                cpc.profit_center_short_name,
    --                cpd.home_cur_id,
    --                cpd.home_currency;
    --    --
    --    -- record currency - realized pnl
    --    --
    --    insert into cps_curremcy_pnl_summary
    --      (corporate_id,
    --       corporate_name,
    --       process_id,
    --       profit_center_id,
    --       profit_center_name,
    --       profit_center_short_name,
    --       main_section,
    --       sub_section,
    --       pnl,
    --       pnl_cur_id,
    --       pnl_cur_code)
    --      select cpd.corporate_id,
    --             cpd.corporate_name,
    --             cpd.process_id,
    --             cpd.profit_center_id,
    --             cpd.profit_center_name,
    --             cpc.profit_center_short_name,
    --             'Currency' main_section,
    --             'Realized' sub_section,
    --             sum(cpd.pnl_value_in_home_currency) pnl,
    --             cpd.home_cur_id,
    --             cpd.home_currency
    --        from cpd_currency_pnl_daily      cpd,
    --             cpc_corporate_profit_center cpc
    --       where cpd.profit_center_id = cpc.profit_center_id
    --         and upper(cpd.pnl_type) = 'REALIZED'
    --         and cpd.process_id = pc_process_id
    --         and cpd.corporate_id = pc_corporate_id
    --       group by cpd.corporate_id,
    --                cpd.corporate_name,
    --                cpd.process_id,
    --                cpd.profit_center_id,
    --                cpd.profit_center_name,
    --                cpc.profit_center_short_name,
    --                cpd.home_cur_id,
    --                cpd.home_currency;
    --    --
    --    -- record currency - bank fees pnl
    --    --
    --    insert into cps_curremcy_pnl_summary
    --      (corporate_id,
    --       corporate_name,
    --       process_id,
    --       profit_center_id,
    --       profit_center_name,
    --       profit_center_short_name,
    --       main_section,
    --       sub_section,
    --       pnl,
    --       pnl_cur_id,
    --       pnl_cur_code)
    --      select cpd.corporate_id,
    --             cpd.corporate_name,
    --             cpd.process_id,
    --             cpd.profit_center_id,
    --             cpd.profit_center_name,
    --             cpc.profit_center_short_name,
    --             'Currency' main_section,
    --             'Bank Fees' sub_section,
    --             sum(cpd.bank_charges_in_home_currency) pnl,
    --             cpd.home_cur_id,
    --             cpd.home_currency
    --        from cpd_currency_pnl_daily      cpd,
    --             cpc_corporate_profit_center cpc
    --       where cpd.profit_center_id = cpc.profit_center_id
    --         and cpd.process_id = pc_process_id
    --         and cpd.corporate_id = pc_corporate_id
    --       group by cpd.corporate_id,
    --                cpd.corporate_name,
    --                cpd.process_id,
    --                cpd.profit_center_id,
    --                cpd.profit_center_name,
    --                cpc.profit_center_short_name,
    --                cpd.home_cur_id,
    --                cpd.home_currency;
    --    --
    --    -- record derivatives - unrealized pnl
    --    --
    --    insert into dps_derivative_pnl_summary
    --      (corporate_id,
    --       corporate_name,
    --       process_id,
    --       profit_center_id,
    --       profit_center_short_name,
    --       profit_center_name,
    --       main_section,
    --       sub_section,
    --       entity,
    --       pnl,
    --       pnl_cur_id,
    --       pnl_cur_code,
    --       exchange_id,
    --       exchange_name)
    --      select dpd.corporate_id,
    --             dpd.corporate_name,
    --             pc_process_id,
    --             dpd.profit_center_id,
    --             dpd.profit_center_short_name,
    --             dpd.profit_center_name,
    --             decode(dpd.deal_type_id,
    --                    'Internal Swap',
    --                    'Internal Swap',
    --                    'Futures') as main_section,
    --             'Unrealized' as sub_section,
    --             'Futures' entity,
    --             sum(dpd.pnl_in_base_cur),
    --             dpd.base_cur_id,
    --             dpd.base_cur_code,
    --             dpd.exchange_id,
    --             dpd.exchange_name
    --        from dpd_derivative_pnl_daily dpd
    --       where dpd.corporate_id = pc_corporate_id
    --         and dpd.process_id = pc_process_id
    --         and dpd.instrument_type_id = 'IRMF'
    --         and dpd.pnl_type = 'Unrealized'
    --       group by dpd.corporate_id,
    --                dpd.corporate_name,
    --                pc_process_id,
    --                dpd.profit_center_id,
    --                profit_center_short_name,
    --                dpd.profit_center_name,
    --                decode(deal_type_id,
    --                       'Internal Swap',
    --                       'Internal Swap',
    --                       'Futures'),
    --                dpd.base_cur_id,
    --                dpd.base_cur_code,
    --                dpd.exchange_id,
    --                dpd.exchange_name
    --      union all
    --      select dpd.corporate_id,
    --             dpd.corporate_name,
    --             pc_process_id,
    --             dpd.profit_center_id,
    --             dpd.profit_center_short_name,
    --             dpd.profit_center_name,
    --             decode(dpd.deal_type_id,
    --                    'Internal Swap',
    --                    'Internal Swap',
    --                    'Options') as main_section,
    --             'Unrealized' as sub_section,
    --             'Options' entity,
    --             sum(dpd.pnl_in_base_cur),
    --             dpd.base_cur_id,
    --             dpd.base_cur_code,
    --             dpd.exchange_id exchange_id,
    --             dpd.exchange_name exchange_name
    --        from dpd_derivative_pnl_daily dpd
    --       where dpd.corporate_id = pc_corporate_id
    --         and dpd.process_id = pc_process_id
    --         and dpd.instrument_type_id in
    --             ('IRMCO', 'IRMPO', 'IRMOTCO', 'IRMOTPO')
    --         and dpd.pnl_type = 'Unrealized'
    --       group by dpd.corporate_id,
    --                dpd.corporate_name,
    --                pc_process_id,
    --                dpd.profit_center_id,
    --                dpd.profit_center_short_name,
    --                dpd.profit_center_name,
    --                decode(dpd.deal_type_id,
    --                       'Internal Swap',
    --                       'Internal Swap',
    --                       'Options'),
    --                dpd.base_cur_id,
    --                dpd.base_cur_code,
    --                dpd.exchange_id,
    --                dpd.exchange_name;
    --    --
    --    -- record derivatives - realized pnl
    --    --
    --    insert into dps_derivative_pnl_summary
    --      (corporate_id,
    --       corporate_name,
    --       process_id,
    --       profit_center_id,
    --       profit_center_short_name,
    --       profit_center_name,
    --       main_section,
    --       sub_section,
    --       entity,
    --       pnl,
    --       pnl_cur_id,
    --       pnl_cur_code,
    --       exchange_id,
    --       exchange_name)
    --      select dpd.corporate_id,
    --             dpd.corporate_name,
    --             pc_process_id,
    --             dpd.profit_center_id,
    --             profit_center_short_name,
    --             dpd.profit_center_name,
    --             decode(deal_type_id,
    --                    'Internal Swap',
    --                    'Internal Swap',
    --                    'Futures') as main_section,
    --             'Realized' as sub_section,
    --             'Futures' entiry,
    --             sum(dpd.pnl_in_base_cur),
    --             dpd.base_cur_id,
    --             dpd.base_cur_code,
    --             dpd.exchange_id,
    --             dpd.exchange_name
    --        from dpd_derivative_pnl_daily dpd
    --       where dpd.process_id = pc_process_id
    --         and dpd.instrument_type_id = 'IRMF'
    --         and dpd.pnl_type = 'Realized'
    --       group by dpd.corporate_id,
    --                dpd.corporate_name,
    --                pc_process_id,
    --                dpd.profit_center_id,
    --                profit_center_short_name,
    --                dpd.profit_center_name,
    --                decode(deal_type_id,
    --                       'Internal Swap',
    --                       'Internal Swap',
    --                       'Futures'),
    --                dpd.base_cur_id,
    --                dpd.base_cur_code,
    --                dpd.exchange_id,
    --                dpd.exchange_name
    --      union all
    --      select dpd.corporate_id,
    --             dpd.corporate_name,
    --             pc_process_id,
    --             dpd.profit_center_id,
    --             profit_center_short_name,
    --             dpd.profit_center_name,
    --             decode(deal_type_id,
    --                    'Internal Swap',
    --                    'Internal Swap',
    --                    'Options') as main_section,
    --             'Realized' as sub_section,
    --             'Options' entity,
    --             sum(dpd.pnl_in_base_cur),
    --             dpd.base_cur_id,
    --             dpd.base_cur_code,
    --             dpd.exchange_id,
    --             dpd.exchange_name
    --        from dpd_derivative_pnl_daily dpd
    --       where dpd.corporate_id = pc_corporate_id
    --         and dpd.process_id = pc_process_id
    --         and dpd.instrument_type_id in
    --             ('IRMCO', 'IRMPO', 'IRMOTCO', 'IRMOTPO')
    --         and dpd.pnl_type = 'Realized'
    --       group by dpd.corporate_id,
    --                dpd.corporate_name,
    --                pc_process_id,
    --                dpd.profit_center_id,
    --                profit_center_short_name,
    --                dpd.profit_center_name,
    --                decode(deal_type_id,
    --                       'Internal Swap',
    --                       'Internal Swap',
    --                       'Options'),
    --                dpd.base_cur_id,
    --                dpd.base_cur_code,
    --                dpd.exchange_id,
    --                dpd.exchange_name;
    --    --
    --    -- record realized cost details
    --    --
    --    insert into cps_cost_pnl_summary
    --      (corporate_id,
    --       corporate_name,
    --       process_id,
    --       profit_center_id,
    --       profit_center_name,
    --       profit_center_short_name,
    --       main_section,
    --       sub_section,
    --       entity,
    --       cost_amt,
    --       cost_cur_id,
    --       cost_cur_code)
    --      select cpc.corporateid,
    --             akc.corporate_name,
    --             pc_process_id,
    --             mc.profit_center_id,
    --             cpc.profit_center_name,
    --             cpc.profit_center_short_name,
    --             'Carrying Costs' as main_section,
    --             scm.cost_component_name as sub_section,
    --             'Cost' entity,
    --             sum(mc.base_amt),
    --             mc.base_cur_id,
    --             cm_mc.cur_code
    --        from mc_monthly_costing                  mc,
    --             scm_service_charge_master@eka_appdb scm,
    --             ak_corporate                        akc,
    --             cpc_corporate_profit_center         cpc,
    --             cm_currency_master                  cm_akc,
    --             cm_currency_master                  cm_mc
    --       where mc.cost_component_id = scm.cost_id
    --         and mc.profit_center_id = cpc.profit_center_id
    --         and cpc.corporateid = akc.corporate_id
    --         and akc.base_currency_name = cm_akc.cur_code
    --         and mc.is_deleted = 'N'
    --         and cm_mc.cur_id = mc.base_cur_id
    --         and mc.process_id = pc_process_id
    --         and cpc.corporateid = pc_corporate_id
    --       group by cpc.corporateid,
    --                akc.corporate_name,
    --                pc_process_id,
    --                mc.profit_center_id,
    --                cpc.profit_center_short_name,
    --                cpc.profit_center_name,
    --                scm.cost_component_name,
    --                mc.base_cur_id,
    --                cm_mc.cur_code
    --      union all
    --      select dpd.corporate_id,
    --             dpd.corporate_name,
    --             pc_process_id,
    --             dpd.profit_center_id,
    --             dpd.profit_center_name,
    --             dpd.profit_center_short_name,
    --             'Commissions' main_section,
    --             'Broker Commission' sub_section,
    --             'Commissions' entity,
    --             sum(nvl(dpd.broker_comm_amt, 0) * nvl(dpd.broker_exch_rate, 1)),
    --             dpd.base_cur_id,
    --             dpd.base_cur_code
    --        from dpd_derivative_pnl_daily dpd
    --       where dpd.process_id = pc_process_id
    --         and nvl(dpd.broker_comm_amt, 0) <> 0
    --         and dpd.pnl_type = 'Realized'
    --       group by dpd.corporate_id,
    --                dpd.corporate_name,
    --                pc_process_id,
    --                dpd.profit_center_id,
    --                dpd.profit_center_short_name,
    --                dpd.profit_center_name,
    --                dpd.base_cur_id,
    --                dpd.base_cur_code
    --      union all
    --      select dpd.corporate_id,
    --             dpd.corporate_name,
    --             pc_process_id,
    --             dpd.profit_center_id,
    --             dpd.profit_center_name,
    --             dpd.profit_center_short_name,
    --             'Commissions' main_section,
    --             'Clearer Commission' sub_section,
    --             'Commissions' entity,
    --             sum(nvl(dpd.clearer_comm_amt, 0) *
    --                 nvl(dpd.clearer_exch_rate, 1)),
    --             dpd.base_cur_id,
    --             dpd.base_cur_code
    --        from dpd_derivative_pnl_daily dpd
    --       where dpd.process_id = pc_process_id
    --         and nvl(dpd.clearer_comm_amt, 0) <> 0
    --         and dpd.pnl_type = 'Realized'
    --       group by dpd.corporate_id,
    --                dpd.corporate_name,
    --                pc_process_id,
    --                dpd.profit_center_id,
    --                dpd.profit_center_short_name,
    --                dpd.profit_center_name,
    --                dpd.base_cur_id,
    --                dpd.base_cur_code
    --      union all
    --      select drt.corporate_id,
    --             akc.corporate_name,
    --             tdc.process_id,
    --             cpc.profit_center_id,
    --             cpc.profit_center_name,
    --             cpc.profit_center_short_name,
    --             'Commissions' main_section,
    --             'Broker Commission' sub_section,
    --             'Commissions' entity,
    --             sum(nvl(nvl(drt.broker_comm_amt, 0) *
    --                     pkg_general.f_get_converted_currency_amt(drt.corporate_id,
    --                                                              drt.broker_comm_cur_id,
    --                                                              cm.cur_id,
    --                                                              tdc.trade_date,
    --                                                              1),
    --                     0)) pnl,
    --             cm.cur_id base_cur_id,
    --             cm.cur_code base_cur_code
    --        from dt_derivative_trade         drt,
    --             tdc_trade_date_closure      tdc,
    --             cpc_corporate_profit_center cpc,
    --             ak_corporate                akc,
    --             cm_currency_master          cm
    --       where drt.corporate_id = tdc.corporate_id
    --         and drt.corporate_id = akc.corporate_id
    --         and tdc.corporate_id = pc_corporate_id
    --         and drt.process_id = tdc.process_id
    --         and drt.profit_center_id = cpc.profit_center_id
    --         and akc.base_currency_name = cm.cur_code
    --         and tdc.process_id = pc_process_id
    --         and exists
    --       (select 1
    --                from dpd_derivative_pnl_daily dpd
    --               where dpd.process_id = pc_process_id
    --                 and dpd.derivative_ref_no = drt.derivative_ref_no
    --                 and dpd.is_new_trade = 'Y')
    --         and nvl(drt.broker_comm_amt, 0) <> 0
    --       group by drt.corporate_id,
    --                akc.corporate_name,
    --                tdc.process_id,
    --                cpc.profit_center_id,
    --                cpc.profit_center_name,
    --                cpc.profit_center_short_name,
    --                cm.cur_id,
    --                cm.cur_code
    --      union all
    --      select drt.corporate_id,
    --             akc.corporate_name,
    --             tdc.process_id,
    --             cpc.profit_center_id,
    --             cpc.profit_center_name,
    --             cpc.profit_center_short_name,
    --             'Commissions' main_section,
    --             'Clearer Commission' sub_section,
    --             'Commissions' entity,
    --             sum(nvl(nvl(drt.clearer_comm_amt, 0) *
    --                     pkg_general.f_get_converted_currency_amt(drt.corporate_id,
    --                                                              drt.clearer_comm_cur_id,
    --                                                              cm.cur_id,
    --                                                              tdc.trade_date,
    --                                                              1),
    --                     0)) pnl,
    --             cm.cur_id base_cur_id,
    --             cm.cur_code base_cur_code
    --        from dt_derivative_trade         drt,
    --             tdc_trade_date_closure      tdc,
    --             cpc_corporate_profit_center cpc,
    --             ak_corporate                akc,
    --             cm_currency_master          cm
    --       where drt.corporate_id = tdc.corporate_id
    --         and drt.corporate_id = akc.corporate_id
    --         and tdc.corporate_id = pc_corporate_id
    --         and drt.process_id = tdc.process_id
    --         and drt.profit_center_id = cpc.profit_center_id
    --         and akc.base_currency_name = cm.cur_code
    --         and tdc.process_id = pc_process_id
    --         and exists
    --       (select 1
    --                from dpd_derivative_pnl_daily dpd
    --               where dpd.process_id = pc_process_id
    --                 and dpd.derivative_ref_no = drt.derivative_ref_no
    --                 and dpd.is_new_trade = 'Y')
    --         and nvl(drt.clearer_comm_amt, 0) <> 0
    --       group by drt.corporate_id,
    --                akc.corporate_name,
    --                tdc.process_id,
    --                cpc.profit_center_id,
    --                cpc.profit_center_name,
    --                cpc.profit_center_short_name,
    --                cm.cur_id,
    --                cm.cur_code;
    --    --Added by Siddharth 23-Jul-2011
    --    insert into cps_cost_pnl_summary
    --      (corporate_id,
    --       corporate_name,
    --       process_id,
    --       profit_center_id,
    --       profit_center_name,
    --       profit_center_short_name,
    --       main_section,
    --       sub_section,
    --       entity,
    --       cost_amt,
    --       cost_cur_id,
    --       cost_cur_code)
    --      select ord.corporate_id,
    --             ord.corporate_name,
    --             pc_process_id,
    --             ord.profit_center_id,
    --             ord.profit_center_name,
    --             ord.profit_center_short_name,
    --             'General Cost',
    --             ord.sectionname,
    --             'General Cost' entity,
    --             ord.realized_pnl,
    --             ord.base_cur_id,
    --             ord.base_cur_code
    --        from ored_overall_realized_daily ord
    --       where ord.process_id = pc_process_id
    --         and ord.cost_component = 'Write Off';
    --Ends here  
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure sp_calc_pnl_summary',
                                                           'M2M-013',
                                                           'Code:' ||
                                                           sqlcode ||
                                                           'Message:' ||
                                                           sqlerrm,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;

  function f_get_next_day(p_date     in date,
                          p_day      in varchar2,
                          p_position in number) return date is
  
    v_position_date      date;
    v_next_position      number;
    v_start_day          varchar2(10);
    v_first_day_position date;
  
  begin
  
    begin
      v_next_position := (p_position - 1) * 7;
      v_start_day     := to_char(to_date('01-' ||
                                         to_char(trunc(p_date), 'mon-yyyy'),
                                         'dd-mon-yyyy'),
                                 'dy');
      if upper(trim(v_start_day)) = upper(trim(p_day)) then
        v_first_day_position := to_date('01-' ||
                                        to_char(trunc(p_date), 'mon-yyyy'),
                                        'dd-mon-yyyy');
      else
        v_first_day_position := next_day(to_date('01-' ||
                                                 to_char(p_date, 'mon-yyyy'),
                                                 'dd-mon-yyyy'),
                                         trim(p_day));
      end if;
    
      if v_next_position <= 1 then
        v_position_date := trunc(v_first_day_position);
      else
        v_position_date := trunc(v_first_day_position) + v_next_position;
      end if;
    exception
      when no_data_found then
        return null;
      when others then
        return null;
    end;
    return v_position_date;
  end f_get_next_day;

  function f_is_day_holiday(pc_instrumentid in varchar2,
                            pc_trade_date   date) return boolean is
    pc_counter number(1);
    result_val boolean;
  begin
    --Checking the Week End Holiday List
    begin
      select count(*)
        into pc_counter
        from dual
       where to_char(pc_trade_date, 'Dy') in
             (select clwh.holiday
                from dim_der_instrument_master    dim,
                     clm_calendar_master          clm,
                     clwh_calendar_weekly_holiday clwh
               where dim.holiday_calender_id = clm.calendar_id
                 and clm.calendar_id = clwh.calendar_id
                 and dim.instrument_id = pc_instrumentid
                 and clm.is_deleted = 'N'
                 and clwh.is_deleted = 'N');
      if (pc_counter = 1) then
        result_val := true;
      else
        result_val := false;
      end if;
      if (result_val = false) then
        --Checking Other Holiday List
        select count(*)
          into pc_counter
          from dual
         where trim(pc_trade_date) in
               (select trim(hl.holiday_date)
                  from hm_holiday_master         hm,
                       hl_holiday_list           hl,
                       dim_der_instrument_master dim,
                       clm_calendar_master       clm
                 where hm.holiday_id = hl.holiday_id
                   and dim.holiday_calender_id = clm.calendar_id
                   and clm.calendar_id = hm.calendar_id
                   and dim.instrument_id = pc_instrumentid
                   and hm.is_deleted = 'N'
                   and hl.is_deleted = 'N');
        if (pc_counter = 1) then
          result_val := true;
        else
          result_val := false;
        end if;
      end if;
    end;
    return result_val;
  end f_is_day_holiday;

  /*procedure sp_calc_risk_limits(pc_corporate_id varchar2,
                                pd_trade_date   date,
                                pc_process_id   varchar2,
                                pc_user_id      varchar2) is
  
  begin
    null;
  end;*/

  procedure sp_calc_quality_premium(pc_int_contract_item_ref_no in varchar2,
                                    pc_price_unit_id            in varchar2,
                                    pc_corporate_id             in varchar2,
                                    pd_trade_date               in date,
                                    pc_process_id               in varchar2,
                                    pn_premium                  out number) is
  
    cursor cur_preimium is
      select pcqpd.premium_disc_value,
             pcqpd.premium_disc_unit_id
        from pci_physical_contract_item     pci,
             pcpq_pc_product_quality        pcpq,
             pcpdqd_pd_quality_details      pcpdqd,
             pcqpd_pc_qual_premium_discount pcqpd
       where pci.pcpq_id = pcpq.pcpq_id
         and pcpq.pcpq_id = pcpdqd.pcpq_id
         and pcpdqd.pcqpd_id = pcqpd.pcqpd_id
         and pci.process_id = pc_process_id
         and pcpq.process_id = pc_process_id
         and pcqpd.process_id = pc_process_id
         and pcpdqd.process_id = pc_process_id
         and pci.internal_contract_item_ref_no =
             pc_int_contract_item_ref_no;
    vn_premium       number;
    vn_total_premium number := 0;
  begin
    sp_write_log(pc_corporate_id,
                 pd_trade_date,
                 'sp_calc_quality_premium',
                 'premium for ' || pc_int_contract_item_ref_no || ' in ' ||
                 pc_price_unit_id);
    for cur_preimium_rows in cur_preimium
    loop
      if cur_preimium_rows.premium_disc_unit_id = pc_price_unit_id then
        vn_premium := cur_preimium_rows.premium_disc_value;
      else
        vn_premium := pkg_phy_pre_check_process.f_get_converted_price(pc_corporate_id,
                                                                      cur_preimium_rows.premium_disc_value,
                                                                      cur_preimium_rows.premium_disc_unit_id,
                                                                      pc_price_unit_id,
                                                                      pd_trade_date);
      end if;
      vn_total_premium := vn_total_premium + vn_premium;
    end loop;
    pn_premium := vn_total_premium;
  
  end;

  procedure sp_quality_premium_fw_rate(pc_int_contract_item_ref_no in varchar2,
                                       pc_corporate_id             in varchar2,
                                       pd_trade_date               in date,
                                       pc_price_unit_id            in varchar2,
                                       pc_base_cur_id              in varchar2,
                                       pd_payment_due_date         in date,
                                       pc_product_id               in varchar2,
                                       pc_base_qty_unit_id         in varchar2,
                                       pc_process_id               in varchar2,
                                       pn_premium                  out number,
                                       pc_exch_rate_string         out varchar2) is
  
    cursor cur_preimium is
      select pcqpd.premium_disc_value,
             pcqpd.premium_disc_unit_id
        from pci_physical_contract_item     pci,
             pcpq_pc_product_quality        pcpq,
             pcpdqd_pd_quality_details      pcpdqd,
             pcqpd_pc_qual_premium_discount pcqpd
       where pci.pcpq_id = pcpq.pcpq_id
         and pcpq.pcpq_id = pcpdqd.pcpq_id
         and pcpdqd.pcqpd_id = pcqpd.pcqpd_id
         and pci.process_id = pc_process_id
         and pcpq.process_id = pc_process_id
         and pcqpd.process_id = pc_process_id
         and pcpdqd.process_id = pc_process_id
         and pci.internal_contract_item_ref_no =
             pc_int_contract_item_ref_no;
    vn_premium                 number;
    vn_total_premium           number := 0;
    vc_premium_cur_id          varchar2(15);
    vc_premium_main_cur_id     varchar2(15);
    vc_premium_main_cur_code   varchar2(15);
    vn_premium_cur_main_factor number;
    vc_premium_weight_unit_id  varchar2(15);
    vn_premium_weight          number;
    vn_premium_to_base_fw_rate number;
    vn_forward_points          number;
    vc_base_cur_code           varchar2(15);
    vobj_error_log             tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count         number := 1;
  begin
    select cm.cur_code
      into vc_base_cur_code
      from cm_currency_master cm
     where cm.cur_id = pc_base_cur_id;
    for cur_preimium_rows in cur_preimium
    loop
      if cur_preimium_rows.premium_disc_unit_id = pc_price_unit_id then
        vn_premium := cur_preimium_rows.premium_disc_value;
      else
        --
        -- Get the Currency, Weight Unit and Weight Unit of Premium Price Unit
        --
        select ppu.cur_id,
               ppu.weight_unit_id,
               nvl(ppu.weight, 1)
          into vc_premium_cur_id,
               vc_premium_weight_unit_id,
               vn_premium_weight
          from v_ppu_pum ppu
         where ppu.product_price_unit_id = pc_price_unit_id;
      
        --
        -- Get the Main Currency of the Premium Price Unit
        --
        pkg_general.sp_get_base_cur_detail(vc_premium_cur_id,
                                           vc_premium_main_cur_id,
                                           vc_premium_main_cur_code,
                                           vn_premium_cur_main_factor);
        --
        -- Exchange Rate from Premium to Base Currency
        --                                           
        pkg_general.sp_forward_cur_exchange_new(pc_corporate_id,
                                                pd_trade_date,
                                                pd_payment_due_date,
                                                vc_premium_main_cur_id,
                                                pc_base_cur_id,
                                                30,
                                                vn_premium_to_base_fw_rate,
                                                vn_forward_points);
        if pc_exch_rate_string is null then
          pc_exch_rate_string := '1 ' || vc_base_cur_code || '=' ||
                                 vn_premium_to_base_fw_rate || ' ' ||
                                 vc_premium_main_cur_code;
        else
          pc_exch_rate_string := pc_exch_rate_string || ',' || '1 ' ||
                                 vc_base_cur_code || '=' ||
                                 vn_premium_to_base_fw_rate || ' ' ||
                                 vc_premium_main_cur_code;
        end if;
      
        if vc_premium_main_cur_code <> vc_base_cur_code then
          if vn_premium_to_base_fw_rate is null or
             vn_premium_to_base_fw_rate = 0 then
            vobj_error_log.extend;
            vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                 'procedure sp_quality_premium_fw_rate-sp_calc_phy_open_unrealized ',
                                                                 'PHY-005',
                                                                 vc_base_cur_code ||
                                                                 ' to ' ||
                                                                 vc_premium_main_cur_code || ' (' ||
                                                                 to_char(pd_payment_due_date,
                                                                         'dd-Mon-yyyy') || ') ',
                                                                 '',
                                                                 gvc_process,
                                                                 null, --pc_user_id,
                                                                 sysdate,
                                                                 pd_trade_date);
            sp_insert_error_log(vobj_error_log);
          end if;
        end if;
        vn_premium := (cur_preimium_rows.premium_disc_value /
                      vn_premium_cur_main_factor) *
                      vn_premium_to_base_fw_rate *
                      pkg_general.f_get_converted_quantity(pc_product_id,
                                                           vc_premium_weight_unit_id,
                                                           pc_base_qty_unit_id,
                                                           1);
      end if;
      vn_total_premium := vn_total_premium + vn_premium;
    end loop;
    pn_premium := vn_total_premium;
  end;

  procedure sp_calc_pofh_price(pc_pofh_id       varchar2,
                               pd_trade_date    date,
                               pn_price         out number,
                               pc_price_unit_id out varchar2) as
    cursor cur_ppfh is
      select pfd.pofh_id,
             pfd.qty_fixed,
             pfd.user_price,
             pfd.price_unit_id
        from pfd_price_fixation_details pfd
       where pfd.pofh_id = pc_pofh_id
         and pfd.as_of_date <= pd_trade_date;
  
    vn_qty_fixed  number;
    vn_user_price number;
    --vn_count         number;
    vn_avg_price     number;
    vn_price_unit_id varchar2(10);
  
  begin
  
    vn_qty_fixed := 0;
    --vn_count      := 0;
    vn_user_price := 0;
  
    for cur_ppfh_rows in cur_ppfh
    loop
      vn_qty_fixed     := vn_qty_fixed + cur_ppfh_rows.qty_fixed;
      vn_user_price    := vn_user_price +
                          cur_ppfh_rows.user_price * vn_qty_fixed;
      vn_price_unit_id := cur_ppfh_rows.price_unit_id;
    end loop;
    if vn_qty_fixed <> 0 then
      vn_avg_price     := round(vn_user_price / vn_qty_fixed, 4);
      pn_price         := vn_avg_price;
      pc_price_unit_id := vn_price_unit_id;
    end if;
  end;
  procedure sp_calc_phy_realized_today(pc_corporate_id varchar2,
                                       pd_trade_date   date,
                                       pc_process_id   varchar2,
                                       pc_user_id      varchar2) is
    cursor cur_realized is
    --
    -- 1. Sales Contracts
    --
      select pc_process_id process_id,
             akc.corporate_id,
             akc.corporate_name,
             pcm.internal_contract_ref_no,
             pcm.contract_ref_no,
             pci.internal_contract_item_ref_no,
             pci.del_distribution_item_no,
             pcm.issue_date,
             pcm.purchase_sales contract_type,
             pcm.contract_status,
             agh.int_alloc_group_id,
             agh.alloc_group_name,
             gmr.internal_gmr_ref_no,
             gmr.gmr_ref_no,
             dgrd.internal_dgrd_ref_no internal_grd_ref_no,
             dgrd.internal_stock_ref_no,
             pdm.product_id,
             pdm.product_desc,
             orm.origin_id,
             orm.origin_name,
             qat.quality_id,
             qat.quality_name,
             cpc.profit_center_id,
             cpc.profit_center_name,
             cpc.profit_center_short_name,
             phd_cp.profileid cp_profile_id,
             phd_cp.company_long_name1 cp_name,
             gab.gabid trade_user_id,
             gab.firstname || ' ' || gab.lastname trade_user_name,
             pt.price_type_id price_type_id,
             pt.price_type_name price_type_name,
             itm.incoterm_id,
             itm.incoterm,
             pym.payment_term_id,
             pym.payment_term,
             cipd.price_fixation_details price_fixation_details,
             cipd.price_fixation_status price_fixation_status,
             'Realized Today' realized_type,
             agh.realized_date realized_date,
             dgrd.container_no,
             dgrd.current_qty item_qty,
             dgrd.net_weight_unit_id qty_unit_id,
             qum_dgrd.qty_unit,
             cipd.contract_price,
             cipd.price_unit_id,
             cipd.price_unit_cur_id,
             cipd.price_unit_cur_code,
             cipd.price_unit_weight_unit_id,
             cipd.price_unit_weight_unit,
             cipd.price_unit_weight,
             phd_wh.profileid warehouse_id,
             phd_wh.companyname warehouse_name,
             cim_sld.city_id shed_id,
             cim_sld.city_name shed_name,
             gcd.groupid group_id,
             gcd.groupname group_name,
             cm_gcd.cur_id group_cur_id,
             cm_gcd.cur_code group_cur_code,
             qum_gcd.qty_unit_id group_qty_unit_id,
             qum_gcd.qty_unit group_qty_unit,
             qum_pdm.qty_unit_id base_qty_unit_id,
             qum_pdm.qty_unit base_qty_unit,
             akc.base_cur_id,
             akc.base_currency_name base_cur_code,
             cpc.profit_center_id sales_profit_center_id,
             cpc.profit_center_name sales_profit_center_name,
             cpc.profit_center_short_name sales_profit_center_short_name,
             css.strategy_id as sales_strategy_id,
             css.strategy_name as sales_strategy_name,
             blm.business_line_id as sales_business_line_id,
             blm.business_line_name as sales_business_line_name,
             gmr.internal_gmr_ref_no sales_internal_gmr_ref_no,
             pcm.contract_ref_no sales_contract_ref_no,
             case
               when itm.location_field = 'ORIGINATION' then
                pcdb.country_id
             end origination_city_id,
             case
               when itm.location_field = 'ORIGINATION' then
                cim_pcdb.city_name
             end origination_city_name,
             case
               when itm.location_field = 'ORIGINATION' then
                cym_pcdb.country_id
             end origination_country_id,
             case
               when itm.location_field = 'ORIGINATION' then
                cym_pcdb.country_name
             end origination_country_name,
             case
               when itm.location_field = 'DESTINATION' then
                pcdb.country_id
             end destination_country_id,
             case
               when itm.location_field = 'DESTINATION' then
                cym_pcdb.country_name
             end destination_country_name,
             case
               when itm.location_field = 'DESTINATION' then
                cim_pcdb.city_id
             end destination_city_id,
             case
               when itm.location_field = 'DESTINATION' then
                cim_pcdb.city_name
             end destination_city_name,
             null pool_id, -- get from dgrd -- check
             css.strategy_id,
             css.strategy_name,
             blm.business_line_id,
             blm.business_line_name,
             dgrd.bl_number,
             dgrd.bl_date,
             dgrd.seal_no,
             dgrd.mark_no,
             dgrd.warehouse_ref_no,
             dgrd.warehouse_receipt_no,
             dgrd.warehouse_receipt_date,
             dgrd.is_warrant is_warrant,
             dgrd.warrant_no warrant_no,
             pcdi.pcdi_id,
             null supp_contract_item_ref_no, -- get from dgrd
             null supplier_pcdi_id, -- get from dgrd
             null payable_returnable_type, -- get from dgrd
             nvl(gscs.avg_cost_fw_rate, 0) secondary_cost_per_unit,
             nvl(pcdb.premium, 0) delivery_premium,
             pcdb.premium_unit_id delivery_premium_unit_id,
             null cog_product_premium_per_unit,
             null cog_quality_premium_per_unit,
             pci.price_description,
             pcdi.delivery_item_no,
             cm_ppu.cur_id del_premium_cur_id,
             cm_ppu.cur_code del_premium_cur_code,
             nvl(ppu.weight, 1) del_premium_weight,
             ppu.weight_unit_id del_premium_weight_unit_id,
             pcdi.payment_due_date,
             null contract_qp_fw_exch_rate,
             null contract_pp_fw_exch_rate,
             null accrual_to_base_fw_exch_rate,
             gscs.fw_rate_string sales_sc_exch_rate_string,
             null price_to_base_fw_exch_rate_act,
             null price_to_base_fw_exch_rate
        from agh_alloc_group_header             agh,
             dgrd_delivered_grd                 dgrd,
             pci_physical_contract_item         pci,
             pcdi_pc_delivery_item              pcdi,
             pcm_physical_contract_main         pcm,
             ak_corporate                       akc,
             gmr_goods_movement_record          gmr,
             pcpd_pc_product_definition         pcpd,
             pdm_productmaster                  pdm,
             pcpq_pc_product_quality            pcpq,
             qat_quality_attributes             qat,
             pom_product_origin_master          pom,
             orm_origin_master                  orm,
             cpc_corporate_profit_center        cpc,
             phd_profileheaderdetails           phd_cp,
             ak_corporate_user                  akcu,
             gab_globaladdressbook              gab,
             pcdb_pc_delivery_basis             pcdb,
             itm_incoterm_master                itm,
             pym_payment_terms_master           pym,
             qum_quantity_unit_master           qum_dgrd,
             cipd_contract_item_price_daily     cipd,
             phd_profileheaderdetails           phd_wh,
             gcd_groupcorporatedetails          gcd,
             cm_currency_master                 cm_gcd,
             qum_quantity_unit_master           qum_gcd,
             qum_quantity_unit_master           qum_pdm,
             cym_countrymaster                  cym_pcdb,
             cim_citymaster                     cim_pcdb,
             css_corporate_strategy_setup       css,
             blm_business_line_master@eka_appdb blm,
             sld_storage_location_detail        sld,
             cim_citymaster                     cim_sld,
             gscs_gmr_sec_cost_summary          gscs,
             pt_price_type                      pt,
             v_ppu_pum                          ppu,
             cm_currency_master                 cm_ppu
       where agh.process_id = pc_process_id
         and agh.int_alloc_group_id = dgrd.int_alloc_group_id
         and dgrd.status = 'Active'
         and agh.process_id = dgrd.process_id
         and agh.int_sales_contract_item_ref_no =
             pci.internal_contract_item_ref_no
         and agh.process_id = pci.process_id
         and pci.is_active = 'Y'
         and pcdi.pcdi_id = pci.pcdi_id
         and agh.process_id = pcdi.process_id
         and pcdi.is_active = 'Y'
         and pcdi.internal_contract_ref_no = pcm.internal_contract_ref_no
         and agh.process_id = pcm.process_id
         and pcm.contract_status in ('In Position', 'Pending Approval')
         and pcm.contract_type = 'BASEMETAL'
         and pcm.corporate_id = akc.corporate_id
         and gmr.internal_gmr_ref_no = dgrd.internal_gmr_ref_no
         and agh.process_id = gmr.process_id
         and gmr.is_deleted = 'N'
         and pcm.internal_contract_ref_no = pcpd.internal_contract_ref_no
         and agh.process_id = pcpd.process_id
         and pcpd.is_active = 'Y'
         and pcpd.product_id = pdm.product_id
         and pcpd.pcpd_id = pcpq.pcpd_id
         and agh.process_id = pcpq.process_id
         and pcpq.quality_template_id = qat.quality_id
         and pcpq.is_active = 'Y'
         and qat.product_origin_id = pom.product_origin_id(+)
         and pom.origin_id = orm.origin_id(+)
         and pcpd.profit_center_id = cpc.profit_center_id
         and pcm.cp_id = phd_cp.profileid
         and pcm.trader_id = akcu.user_id
         and akcu.gabid = gab.gabid
         and pcm.internal_contract_ref_no = pcdb.internal_contract_ref_no
         and agh.process_id = pcdb.process_id
         and pcm.payment_term_id = pym.payment_term_id
         and pcdb.inco_term_id = itm.incoterm_id
         and dgrd.net_weight_unit_id = qum_dgrd.qty_unit_id
         and pci.internal_contract_item_ref_no =
             cipd.internal_contract_item_ref_no
         and agh.process_id = cipd.process_id
         and dgrd.warehouse_profile_id = phd_wh.profileid(+)
         and akc.groupid = gcd.groupid
         and gcd.group_cur_id = cm_gcd.cur_id
         and gcd.group_qty_unit_id = qum_gcd.qty_unit_id
         and qum_pdm.qty_unit_id = pdm.base_quantity_unit
         and pcdb.country_id = cym_pcdb.country_id
         and pcdb.city_id = cim_pcdb.city_id
         and pcpd.strategy_id = css.strategy_id
         and cpc.business_line_id = blm.business_line_id
         and dgrd.shed_id = sld.storage_loc_id(+)
         and sld.city_id = cim_sld.city_id(+)
         and agh.realized_status = 'Realized'
         and agh.today_status = 'Realized Today'
         and dgrd.internal_gmr_ref_no = gscs.internal_gmr_ref_no(+)
         and dgrd.process_id = gscs.process_id(+)
         and pcdi.item_price_type = pt.price_type_id(+)
         and ppu.product_price_unit_id(+) = pcdb.premium_unit_id
         and ppu.cur_id = cm_ppu.cur_id(+)
      -- 
      -- 2.  Purchase contracts With Contract Ref Numbers
      -- 
      union all
      select pc_process_id process_id,
             akc.corporate_id corporate_id,
             akc.corporate_name corporate_name,
             pcm.internal_contract_ref_no internal_contract_ref_no,
             pcm.contract_ref_no contract_ref_no,
             pci.internal_contract_item_ref_no internal_contract_item_ref_no,
             pci.del_distribution_item_no del_distribution_item_no,
             pcm.issue_date issue_date,
             pcm.purchase_sales purchase_sales,
             pcm.contract_status contract_status,
             agh.int_alloc_group_id int_alloc_group_id,
             agh.alloc_group_name alloc_group_name,
             gmr.internal_gmr_ref_no internal_gmr_ref_no,
             gmr.gmr_ref_no gmr_ref_no,
             grd.internal_grd_ref_no internal_grd_ref_no,
             grd.internal_stock_ref_no internal_stock_ref_no,
             pdm.product_id product_id,
             pdm.product_desc product_desc,
             orm.origin_id origin_id,
             orm.origin_name origin_name,
             qat.quality_id quality_id,
             qat.quality_name quality_name,
             cpc.profit_center_id profit_center_id,
             cpc.profit_center_name profit_center_name,
             cpc.profit_center_short_name profit_center_short_name,
             phd_cp.profileid cp_profile_id,
             phd_cp.companyname cp_name,
             gab.gabid trade_user_id,
             gab.firstname || ' ' || gab.lastname trade_user_name,
             pt.price_type_id price_type_id,
             pt.price_type_name price_type_name,
             itm.incoterm_id incoterm_id,
             itm.incoterm incoterm,
             pym.payment_term_id payment_term_id,
             pym.payment_term payment_term,
             null price_fixation_details,
             null price_fixation_status,
             'Realized Today' realized_type,
             agh.realized_date realized_date,
             grd.container_no container_no,
             agd.qty item_qty,
             agd.qty_unit_id qty_unit_id,
             qum_agd.qty_unit qty_unit,
             invs.material_cost_per_unit contract_price,
             invs.price_unit_id price_unit_id,
             invs.price_unit_cur_id price_unit_cur_id,
             invs.price_unit_cur_code price_unit_cur_code,
             invs.price_unit_weight_unit_id price_unit_weight_unit_id,
             invs.price_unit_weight_unit price_unit_weight_unit,
             invs.price_unit_weight price_unit_weight,
             phd_wh.profileid warehouse_id,
             phd_wh.companyname warehouse_name,
             cim_sld.city_id shed_id,
             cim_sld.city_name shed_name,
             gcd.groupid group_id,
             gcd.groupname group_name,
             cm_gcd.cur_id group_cur_id,
             cm_gcd.cur_code group_cur_code,
             qum_gcd.qty_unit_id group_qty_unit_id,
             qum_gcd.qty_unit group_qty_unit,
             qum_pdm.qty_unit_id base_qty_unit_id,
             qum_pdm.qty_unit base_qty_unit,
             akc.base_cur_id base_cur_id,
             akc.base_currency_name base_cur_code,
             null sales_profit_center_id,
             null sales_profit_center_name,
             null sales_profit_center_short_name,
             null sales_strategy_id,
             null sales_strategy_name,
             null sales_business_line_id,
             null sales_business_line_name,
             dgrd.internal_gmr_ref_no sales_internal_gmr_ref_no,
             pcm_sales.contract_ref_no sales_contract_ref_no,
             null origination_city_id,
             null origination_city_name,
             null origination_country_id,
             null origination_country_name,
             cym_gmr_dest.country_id destination_country_id,
             cym_gmr_dest.country_name destination_country,
             cim_gmr_dest.city_id destination_city_id,
             cim_gmr_dest.city_name destination_city,
             null pool_id, -- get from grd
             grd.status strategy_id,
             css.strategy_name strategy_name,
             null business_line_id, -- get from grd
             null business_line_name, -- get from grd
             grd.bl_number bl_number,
             grd.bl_date bl_date,
             grd.seal_no seal_no,
             grd.mark_no mark_no,
             grd.warehouse_ref_no warehouse_ref_no,
             grd.warehouse_receipt_no warehouse_receipt_no,
             grd.warehouse_receipt_date warehouse_receipt_date,
             grd.is_warrant is_warrant,
             grd.warrant_no warrant_no,
             grd.pcdi_id pcdi_id,
             grd.supp_contract_item_ref_no supp_contract_item_ref_no,
             grd.supplier_pcdi_id supplier_pcdi_id,
             grd.payable_returnable_type payable_returnable_type,
             nvl(invs.secondary_cost_per_unit, 0) secondary_cost_per_unit,
             nvl(pcdb.premium, 0) delivery_premium,
             pcdb.premium_unit_id delivery_premium_unit_id,
             nvl(invs.product_premium_per_unit, 0) cog_product_premium_per_unit,
             nvl(invs.quality_premium_per_unit, 0) cog_quality_premium_per_unit,
             pci.price_description,
             pcdi.delivery_item_no,
             null del_premium_cur_id,
             null del_premium_cur_code,
             null del_premium_weight,
             null del_premium_weight_unit_id,
             pd_trade_date payment_due_date,
             invs.contract_qp_fw_exch_rate,
             invs.contract_pp_fw_exch_rate,
             invs.accrual_to_base_fw_exch_rate,
             null sales_sc_exch_rate_string,
             invs.price_to_base_fw_exch_rate_act,
             invs.price_to_base_fw_exch_rate
        from agh_alloc_group_header       agh,
             agd_alloc_group_detail       agd,
             grd_goods_record_detail      grd,
             pci_physical_contract_item   pci,
             pcdi_pc_delivery_item        pcdi,
             pcm_physical_contract_main   pcm,
             ak_corporate                 akc,
             gmr_goods_movement_record    gmr,
             pdm_productmaster            pdm,
             qat_quality_attributes       qat,
             pom_product_origin_master    pom,
             orm_origin_master            orm,
             pcpd_pc_product_definition   pcpd,
             cpc_corporate_profit_center  cpc,
             phd_profileheaderdetails     phd_cp,
             ak_corporate_user            akcu,
             gab_globaladdressbook        gab,
             pcdb_pc_delivery_basis       pcdb,
             itm_incoterm_master          itm,
             pym_payment_terms_master     pym,
             qum_quantity_unit_master     qum_agd,
             phd_profileheaderdetails     phd_wh,
             sld_storage_location_detail  sld,
             cim_citymaster               cim_sld,
             gcd_groupcorporatedetails    gcd,
             cm_currency_master           cm_gcd,
             qum_quantity_unit_master     qum_gcd,
             qum_quantity_unit_master     qum_pdm,
             cym_countrymaster            cym_gmr_dest,
             cim_citymaster               cim_gmr_dest,
             invm_cogs                    invs,
             dgrd_delivered_grd           dgrd,
             pci_physical_contract_item   pci_sales,
             pcdi_pc_delivery_item        pcdi_sales,
             pcm_physical_contract_main   pcm_sales,
             pt_price_type                pt,
             css_corporate_strategy_setup css
       where agh.process_id = pc_process_id
         and agh.process_id = agd.process_id
         and agh.int_alloc_group_id = agd.int_alloc_group_id
         and agd.internal_stock_ref_no = grd.internal_grd_ref_no
         and agh.process_id = grd.process_id
         and grd.is_deleted = 'N'
         and grd.internal_contract_item_ref_no =
             pci.internal_contract_item_ref_no
         and agh.process_id = pci.process_id
         and pci.is_active = 'Y'
         and pci.pcdi_id = pcdi.pcdi_id
         and agh.process_id = pcdi.process_id
         and pcdi.internal_contract_ref_no = pcm.internal_contract_ref_no
         and agh.process_id = pcm.process_id
         and pcdi.is_active = 'Y'
         and pcm.contract_status in ('In Position', 'Pending Approval')
         and pcm.contract_type = 'BASEMETAL'
         and pcm.corporate_id = akc.corporate_id
         and grd.internal_gmr_ref_no = gmr.internal_gmr_ref_no
         and agh.process_id = gmr.process_id
         and gmr.is_deleted = 'N'
         and grd.product_id = pdm.product_id
         and grd.quality_id = qat.quality_id
         and qat.product_origin_id = pom.product_origin_id(+)
         and pom.origin_id = orm.origin_id(+)
         and pcm.internal_contract_ref_no = pcpd.internal_contract_ref_no
         and agh.process_id = pcpd.process_id
         and pcpd.profit_center_id = cpc.profit_center_id
         and pcm.cp_id = phd_cp.profileid
         and pcm.trader_id = akcu.user_id
         and akcu.gabid = gab.gabid
         and pcm.internal_contract_ref_no = pcdb.internal_contract_ref_no
         and agh.process_id = pcdb.process_id
         and pci.pcdb_id = pcdb.pcdb_id
         and pcdb.is_active = 'Y'
         and pcdb.inco_term_id = itm.incoterm_id
         and pcm.payment_term_id = pym.payment_term_id
         and agd.qty_unit_id = qum_agd.qty_unit_id
         and grd.warehouse_profile_id = phd_wh.profileid(+)
         and grd.shed_id = sld.storage_loc_id(+)
         and sld.city_id = cim_sld.city_id(+)
         and akc.groupid = gcd.groupid
         and gcd.group_cur_id = cm_gcd.cur_id
         and gcd.group_qty_unit_id = qum_gcd.qty_unit_id
         and pdm.base_quantity_unit = qum_pdm.qty_unit_id
         and gmr.destination_country_id = cym_gmr_dest.country_id(+)
         and gmr.destination_city_id = cim_gmr_dest.city_id(+)
         and agh.realized_status = 'Realized'
         and agh.today_status = 'Realized Today'
         and invs.internal_grd_ref_no = grd.internal_grd_ref_no
         and invs.process_id = grd.process_id
         and invs.sales_internal_gmr_ref_no = dgrd.internal_gmr_ref_no
         and agh.int_alloc_group_id = dgrd.int_alloc_group_id
         and dgrd.process_id = agh.process_id
         and dgrd.status = 'Active'
         and agh.int_sales_contract_item_ref_no =
             pci_sales.internal_contract_item_ref_no
         and pci_sales.process_id = agh.process_id
         and pci_sales.pcdi_id = pcdi_sales.pcdi_id
         and pcdi_sales.internal_contract_ref_no =
             pcm_sales.internal_contract_ref_no
         and pcdi_sales.process_id = agh.process_id
         and pcm_sales.process_id = agh.process_id
         and pcdi.item_price_type = pt.price_type_id(+)
         and grd.strategy_id = css.strategy_id(+);
  
    cursor cur_update_pnl is
      select prd.corporate_id,
             prd.sales_internal_gmr_ref_no,
             prd.process_id,
             prd.int_alloc_group_id,
             nvl(sum(prd.cog_net_sale_value), 0) net_value
        from prd_physical_realized_daily prd
       where prd.process_id = pc_process_id
         and prd.corporate_id = pc_corporate_id
         and prd.realized_type = 'Realized Today'
       group by prd.corporate_id,
                prd.sales_internal_gmr_ref_no,
                prd.process_id,
                prd.int_alloc_group_id;
  
    vobj_error_log                 tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count             number := 1;
    vc_error_msg                   varchar2(10);
    vn_quality_premium_per_unit    number;
    vn_quality_premium             number;
    vn_product_premium_per_unit    number;
    vn_product_premium             number;
    vn_qty_in_base_qty_unit_id     number;
    vn_sc_in_base_cur              number;
    vc_base_price_unit_id          varchar2(15);
    vc_base_price_unit_name        varchar2(15);
    vc_price_cur_id                varchar2(15);
    vc_price_cur_code              varchar2(15);
    vn_cont_price_cur_id_factor    number;
    vn_cont_price_cur_decimals     number;
    vn_cog_net_sale_value          number;
    vn_contract_value_in_base_cur  number;
    vn_contract_value_in_price_cur number;
    vn_cfx_price_cur_to_base_cur   number;
    vc_contract_price_unit_id      varchar2(15);
    vc_del_premium_main_cur_id     varchar2(15);
    vc_del_premium_main_cur_code   varchar2(15);
    vn_del_premium_cur_main_factor number;
    vn_fw_exch_rate_del_to_base    number;
    vn_forward_points              number;
    vc_contract_qp_fw_exch_rate    varchar2(100);
    vc_contract_pp_fw_exch_rate    varchar2(100);
    vc_qual_prem_exch_rate_string  varchar2(100);
    vn_price_to_base_fw_exch_rate  number;
    vc_price_to_base_fw_rate       varchar2(100);
    vc_sc_to_base_fw_exch_rate     varchar2(500);
  
  begin
    vc_error_msg := '1';
    for cur_realized_rows in cur_realized
    loop
      if cur_realized_rows.contract_type = 'S' then
        vc_sc_to_base_fw_exch_rate := cur_realized_rows.accrual_to_base_fw_exch_rate;
      else
        vc_sc_to_base_fw_exch_rate := cur_realized_rows.sales_sc_exch_rate_string;
      end if;
      begin
        select ppu.product_price_unit_id,
               ppu.price_unit_name
          into vc_base_price_unit_id,
               vc_base_price_unit_name
          from v_ppu_pum ppu
         where ppu.cur_id = cur_realized_rows.base_cur_id
           and ppu.weight_unit_id = cur_realized_rows.base_qty_unit_id
           and nvl(ppu.weight, 1) = 1
           and ppu.product_id = cur_realized_rows.product_id;
      exception
        when others then
          sp_write_log(pc_corporate_id,
                       pd_trade_date,
                       'sp_calc_realized_today',
                       'vc_base_price_unit is not available' || ' For' ||
                       cur_realized_rows.contract_ref_no);
      end;
      --
      -- Pricing Main Currency Details
      --
      if cur_realized_rows.contract_type = 'S' then
        pkg_general.sp_get_main_cur_detail(cur_realized_rows.price_unit_cur_id,
                                           vc_price_cur_id,
                                           vc_price_cur_code,
                                           vn_cont_price_cur_id_factor,
                                           vn_cont_price_cur_decimals);
      
      else
        -- It is from COG and has to be in Base Currency
        vc_price_cur_id             := cur_realized_rows.base_cur_id;
        vc_price_cur_code           := cur_realized_rows.base_cur_code;
        vn_cont_price_cur_id_factor := 1;
        vn_cont_price_cur_decimals  := 2;
      end if;
      vc_error_msg := '2';
      --
      -- Quantity in Product Base Unit
      --
      if cur_realized_rows.qty_unit_id <>
         cur_realized_rows.base_qty_unit_id then
        select pkg_general.f_get_converted_quantity(cur_realized_rows.product_id,
                                                    cur_realized_rows.qty_unit_id,
                                                    cur_realized_rows.base_qty_unit_id,
                                                    cur_realized_rows.item_qty)
          into vn_qty_in_base_qty_unit_id
          from dual;
      else
        vn_qty_in_base_qty_unit_id := cur_realized_rows.item_qty;
      end if;
      --
      -- Total Secondary Cost Value = Avg Seconadry Cost * Realized Qty in Product Base Unit
      --
      vn_sc_in_base_cur := cur_realized_rows.secondary_cost_per_unit *
                           vn_qty_in_base_qty_unit_id;
      vc_error_msg      := '3';
      --
      -- Calculate Product Premium, Purchase Contracts from INVM else from Contract
      -- 
      if cur_realized_rows.contract_type = 'P' then
        vn_product_premium := vn_qty_in_base_qty_unit_id *
                              cur_realized_rows.cog_product_premium_per_unit;
      
        vc_contract_pp_fw_exch_rate := cur_realized_rows.contract_pp_fw_exch_rate;
      else
        if cur_realized_rows.delivery_premium <> 0 then
          if cur_realized_rows.delivery_premium_unit_id <>
             vc_base_price_unit_id then
            --
            -- Get the Main Currency of the Delivery Premium Price Unit
            --
            pkg_general.sp_get_base_cur_detail(cur_realized_rows.del_premium_cur_id,
                                               vc_del_premium_main_cur_id,
                                               vc_del_premium_main_cur_code,
                                               vn_del_premium_cur_main_factor);
          
            pkg_general.sp_forward_cur_exchange_new(pc_corporate_id,
                                                    pd_trade_date,
                                                    cur_realized_rows.payment_due_date,
                                                    vc_del_premium_main_cur_id,
                                                    cur_realized_rows.base_cur_id,
                                                    30,
                                                    vn_fw_exch_rate_del_to_base,
                                                    vn_forward_points);
          
            if vc_del_premium_main_cur_id <> cur_realized_rows.base_cur_id then
              if vn_fw_exch_rate_del_to_base is null or
                 vn_fw_exch_rate_del_to_base = 0 then
                vobj_error_log.extend;
                vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                     'procedure pkg_phy_physical_process-sp_physical_realized_today ',
                                                                     'PHY-005',
                                                                     cur_realized_rows.base_cur_code ||
                                                                     ' to ' ||
                                                                     vc_del_premium_main_cur_id || ' (' ||
                                                                     to_char(pd_trade_date,
                                                                             'dd-Mon-yyyy') || ') ',
                                                                     '',
                                                                     gvc_process,
                                                                     pc_user_id,
                                                                     sysdate,
                                                                     pd_trade_date);
                sp_insert_error_log(vobj_error_log);
              end if;
            end if;
            if vn_fw_exch_rate_del_to_base <> 1 then
              vc_contract_pp_fw_exch_rate := '1 ' ||
                                             vc_del_premium_main_cur_code || '=' ||
                                             vn_fw_exch_rate_del_to_base || ' ' ||
                                             cur_realized_rows.base_cur_code;
            end if;
          
            vn_product_premium_per_unit := (cur_realized_rows.delivery_premium /
                                           cur_realized_rows.del_premium_weight) *
                                           vn_del_premium_cur_main_factor *
                                           vn_fw_exch_rate_del_to_base *
                                           pkg_general.f_get_converted_quantity(cur_realized_rows.product_id,
                                                                                cur_realized_rows.del_premium_weight_unit_id,
                                                                                cur_realized_rows.base_qty_unit_id,
                                                                                1);
          
          else
            vn_product_premium_per_unit := cur_realized_rows.delivery_premium;
          end if;
          vn_product_premium := round(vn_product_premium_per_unit *
                                      vn_qty_in_base_qty_unit_id,
                                      2);
        else
          vn_product_premium_per_unit := 0;
          vn_product_premium          := 0;
        end if;
      end if;
      vc_error_msg := '4';
      --
      -- Calculate Contract Quality Premium, Purchase Contracts from COG Sales COntracts from Contract
      -- 
      if cur_realized_rows.contract_type = 'P' then
        vn_quality_premium            := round(cur_realized_rows.cog_quality_premium_per_unit *
                                               vn_qty_in_base_qty_unit_id,
                                               2);
        vc_qual_prem_exch_rate_string := cur_realized_rows.contract_qp_fw_exch_rate;
      else
        sp_quality_premium_fw_rate(cur_realized_rows.internal_contract_item_ref_no,
                                   pc_corporate_id,
                                   pd_trade_date,
                                   vc_base_price_unit_id,
                                   cur_realized_rows.base_cur_id,
                                   cur_realized_rows.payment_due_date,
                                   cur_realized_rows.product_id,
                                   cur_realized_rows.base_qty_unit_id,
                                   pc_process_id,
                                   vn_quality_premium_per_unit,
                                   vc_qual_prem_exch_rate_string);
        if vc_qual_prem_exch_rate_string is not null then
          vc_contract_qp_fw_exch_rate := vc_qual_prem_exch_rate_string;
        end if;
      
        vn_quality_premium := round((vn_quality_premium_per_unit *
                                    vn_qty_in_base_qty_unit_id),
                                    2);
      end if;
      vc_error_msg := '5';
      --  
      -- Contratc value in base cur = Price Per Unit in Base * Qty in Base
      -- 
      vc_error_msg := '5.1';
      if cur_realized_rows.contract_type = 'P' then
        vn_contract_value_in_base_cur  := vn_qty_in_base_qty_unit_id *
                                          cur_realized_rows.contract_price;
        vn_contract_value_in_price_cur := vn_contract_value_in_base_cur;
        vc_price_to_base_fw_rate       := cur_realized_rows.price_to_base_fw_exch_rate;
        select ppu.product_price_unit_id
          into vc_contract_price_unit_id
          from v_ppu_pum ppu
         where ppu.product_price_unit_id = cur_realized_rows.price_unit_id
           and ppu.product_id = cur_realized_rows.product_id;
      else
        vc_error_msg              := '6';
        vc_contract_price_unit_id := cur_realized_rows.price_unit_id;
        --
        -- Contract Value in Price Currency
        -- 
        vn_contract_value_in_price_cur := (cur_realized_rows.contract_price /
                                          nvl(cur_realized_rows.price_unit_weight,
                                               1)) *
                                          vn_cont_price_cur_id_factor *
                                          pkg_general.f_get_converted_quantity(cur_realized_rows.product_id,
                                                                               cur_realized_rows.qty_unit_id,
                                                                               cur_realized_rows.base_qty_unit_id,
                                                                               cur_realized_rows.item_qty);
        --
        -- Get the Contract Value in Base Currency
        --
        vc_error_msg := '7';
        pkg_general.sp_forward_cur_exchange_new(pc_corporate_id,
                                                pd_trade_date,
                                                cur_realized_rows.payment_due_date,
                                                vc_price_cur_id,
                                                cur_realized_rows.base_cur_id,
                                                30,
                                                vn_price_to_base_fw_exch_rate,
                                                vn_forward_points);
      
        if vc_price_cur_id <> cur_realized_rows.base_cur_id then
          if vn_price_to_base_fw_exch_rate is null or
             vn_price_to_base_fw_exch_rate = 0 then
            vobj_error_log.extend;
            vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                 'procedure pkg_phy_physical_process-sp_calc_phy_open_unrealized ',
                                                                 'PHY-005',
                                                                 cur_realized_rows.base_cur_code ||
                                                                 ' to ' ||
                                                                 vc_price_cur_code || ' (' ||
                                                                 to_char(pd_trade_date,
                                                                         'dd-Mon-yyyy') || ') ',
                                                                 '',
                                                                 gvc_process,
                                                                 pc_user_id,
                                                                 sysdate,
                                                                 pd_trade_date);
            sp_insert_error_log(vobj_error_log);
          end if;
        end if;
      
        if vn_price_to_base_fw_exch_rate is not null and
           vn_price_to_base_fw_exch_rate <> 1 then
          vc_price_to_base_fw_rate := '1 ' || vc_price_cur_code || '=' ||
                                      vn_price_to_base_fw_exch_rate || ' ' ||
                                      cur_realized_rows.base_cur_code;
        end if;
        vn_contract_value_in_base_cur := (cur_realized_rows.contract_price /
                                         nvl(cur_realized_rows.price_unit_weight,
                                              1)) *
                                         vn_cont_price_cur_id_factor *
                                         vn_price_to_base_fw_exch_rate *
                                         pkg_general.f_get_converted_quantity(cur_realized_rows.product_id,
                                                                              cur_realized_rows.qty_unit_id,
                                                                              cur_realized_rows.base_qty_unit_id,
                                                                              cur_realized_rows.item_qty);
      end if;
      vc_error_msg := '8';
      --
      -- Total COG or Sale Value = Contract Value (Qty * Price) + Quality Premium + Product Premium
      --  +- Secondary Cost (+ for Purchase Contracts and - for Sales Contracts)
      --
      vn_cog_net_sale_value := vn_contract_value_in_base_cur +
                               vn_quality_premium + vn_product_premium;
      if cur_realized_rows.contract_type = 'P' then
        vn_cog_net_sale_value := -1 * (vn_cog_net_sale_value +
                                 abs(vn_sc_in_base_cur));
      else
        vn_cog_net_sale_value := vn_cog_net_sale_value -
                                 abs(vn_sc_in_base_cur);
      end if;
      vc_error_msg := '9';
      insert into prd_physical_realized_daily
        (process_id,
         trade_date,
         corporate_id,
         corporate_name,
         internal_contract_ref_no,
         contract_ref_no,
         internal_contract_item_ref_no,
         del_distribution_item_no,
         contract_issue_date,
         contract_type,
         contract_status,
         int_alloc_group_id,
         alloc_group_name,
         internal_gmr_ref_no,
         gmr_ref_no,
         internal_grd_ref_no,
         internal_stock_ref_no,
         product_id,
         product_name,
         origin_id,
         origin_name,
         quality_id,
         quality_name,
         profit_center_id,
         profit_center_name,
         profit_center_short_name,
         cp_profile_id,
         cp_name,
         trade_user_id,
         trade_user_name,
         price_type_id,
         price_type_name,
         incoterm_id,
         incoterm,
         payment_term_id,
         payment_term,
         price_fixation_details,
         price_fixation_status,
         realized_type,
         realized_date,
         container_no,
         item_qty,
         qty_unit_id,
         qty_unit,
         contract_price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         price_unit_weight_unit_id,
         price_unit_weight_unit,
         price_unit_weight,
         contract_value_in_price_cur,
         contract_price_cur_id,
         contract_price_cur_code,
         contract_invoice_value,
         secondary_cost_per_unit,
         secondary_cost_value,
         cog_net_sale_value,
         realized_pnl,
         cfx_price_cur_to_base_cur,
         warehouse_id,
         warehouse_name,
         shed_id,
         shed_name,
         group_id,
         group_name,
         group_cur_id,
         group_cur_code,
         group_qty_unit_id,
         group_qty_unit,
         item_qty_in_base_qty_unit,
         base_qty_unit_id,
         base_qty_unit,
         base_cur_id,
         base_cur_code,
         sales_profit_center_id,
         sales_profit_center_name,
         sales_profit_center_short_name,
         sales_strategy_id,
         sales_strategy_name,
         sales_business_line_id,
         sales_business_line_name,
         sales_internal_gmr_ref_no,
         sales_contract_ref_no,
         origination_city_id,
         origination_city_name,
         origination_country_id,
         origination_country_name,
         destination_city_id,
         destination_city_name,
         destination_country_id,
         destination_country_name,
         pool_id,
         strategy_id,
         strategy_name,
         business_line_id,
         business_line_name,
         bl_number,
         bl_date,
         seal_no,
         mark_no,
         warehouse_ref_no,
         warehouse_receipt_no,
         warehouse_receipt_date,
         is_warrant,
         warrant_no,
         pcdi_id,
         supp_contract_item_ref_no,
         supplier_pcdi_id,
         payable_returnable_type,
         quality_premium,
         quality_premium_per_unit,
         product_premium,
         product_premium_per_unit,
         base_price_unit_id,
         base_price_unit_name,
         price_description,
         delivery_item_no,
         price_to_base_fw_exch_rate,
         contract_qp_fw_exch_rate,
         contract_pp_fw_exch_rate,
         accrual_to_base_fw_exch_rate)
      values
        (pc_process_id,
         pd_trade_date,
         cur_realized_rows.corporate_id,
         cur_realized_rows.corporate_name,
         cur_realized_rows.internal_contract_ref_no,
         cur_realized_rows.contract_ref_no,
         cur_realized_rows.internal_contract_item_ref_no,
         cur_realized_rows.del_distribution_item_no,
         cur_realized_rows.issue_date,
         cur_realized_rows.contract_type,
         cur_realized_rows.contract_status,
         cur_realized_rows.int_alloc_group_id,
         cur_realized_rows.alloc_group_name,
         cur_realized_rows.internal_gmr_ref_no,
         cur_realized_rows.gmr_ref_no,
         cur_realized_rows.internal_grd_ref_no,
         cur_realized_rows.internal_stock_ref_no,
         cur_realized_rows.product_id,
         cur_realized_rows.product_desc,
         cur_realized_rows.origin_id,
         cur_realized_rows.origin_name,
         cur_realized_rows.quality_id,
         cur_realized_rows.quality_name,
         cur_realized_rows.profit_center_id,
         cur_realized_rows.profit_center_name,
         cur_realized_rows.profit_center_short_name,
         cur_realized_rows.cp_profile_id,
         cur_realized_rows.cp_name,
         cur_realized_rows.trade_user_id,
         cur_realized_rows.trade_user_name,
         cur_realized_rows.price_type_id,
         cur_realized_rows.price_type_name,
         cur_realized_rows.incoterm_id,
         cur_realized_rows.incoterm,
         cur_realized_rows.payment_term_id,
         cur_realized_rows.payment_term,
         cur_realized_rows.price_fixation_details,
         cur_realized_rows.price_fixation_status,
         cur_realized_rows.realized_type,
         cur_realized_rows.realized_date,
         cur_realized_rows.container_no,
         cur_realized_rows.item_qty,
         cur_realized_rows.qty_unit_id,
         cur_realized_rows.qty_unit,
         cur_realized_rows.contract_price,
         vc_contract_price_unit_id,
         cur_realized_rows.price_unit_cur_id,
         cur_realized_rows.price_unit_cur_code,
         cur_realized_rows.price_unit_weight_unit_id,
         cur_realized_rows.price_unit_weight_unit,
         cur_realized_rows.price_unit_weight,
         vn_contract_value_in_price_cur,
         vc_price_cur_id,
         vc_price_cur_code,
         vn_contract_value_in_base_cur,
         cur_realized_rows.secondary_cost_per_unit,
         vn_sc_in_base_cur,
         vn_cog_net_sale_value,
         null, -- Realized_pnl Updated Below
         vn_cfx_price_cur_to_base_cur,
         cur_realized_rows.warehouse_id,
         cur_realized_rows.warehouse_name,
         cur_realized_rows.shed_id,
         cur_realized_rows.shed_name,
         cur_realized_rows.group_id,
         cur_realized_rows.group_name,
         cur_realized_rows.group_cur_id,
         cur_realized_rows.group_cur_code,
         cur_realized_rows.group_qty_unit_id,
         cur_realized_rows.group_qty_unit,
         vn_qty_in_base_qty_unit_id,
         cur_realized_rows.base_qty_unit_id,
         cur_realized_rows.base_qty_unit,
         cur_realized_rows.base_cur_id,
         cur_realized_rows.base_cur_code,
         cur_realized_rows.sales_profit_center_id,
         cur_realized_rows.sales_profit_center_name,
         cur_realized_rows.sales_profit_center_short_name,
         cur_realized_rows.sales_strategy_id,
         cur_realized_rows.sales_strategy_name,
         cur_realized_rows.sales_business_line_id,
         cur_realized_rows.sales_business_line_name,
         cur_realized_rows.sales_internal_gmr_ref_no,
         cur_realized_rows.sales_contract_ref_no,
         cur_realized_rows.origination_city_id,
         cur_realized_rows.origination_city_name,
         cur_realized_rows.origination_country_id,
         cur_realized_rows.origination_country_name,
         cur_realized_rows.destination_city_id,
         cur_realized_rows.destination_city_name,
         cur_realized_rows.destination_country_id,
         cur_realized_rows.destination_country_name,
         cur_realized_rows.pool_id,
         cur_realized_rows.strategy_id,
         cur_realized_rows.strategy_name,
         cur_realized_rows.business_line_id,
         cur_realized_rows.business_line_name,
         cur_realized_rows.bl_number,
         cur_realized_rows.bl_date,
         cur_realized_rows.seal_no,
         cur_realized_rows.mark_no,
         cur_realized_rows.warehouse_ref_no,
         cur_realized_rows.warehouse_receipt_no,
         cur_realized_rows.warehouse_receipt_date,
         cur_realized_rows.is_warrant,
         cur_realized_rows.warrant_no,
         cur_realized_rows.pcdi_id,
         cur_realized_rows.supp_contract_item_ref_no,
         cur_realized_rows.supplier_pcdi_id,
         cur_realized_rows.payable_returnable_type,
         vn_quality_premium,
         vn_quality_premium_per_unit,
         vn_product_premium,
         vn_product_premium_per_unit,
         vc_base_price_unit_id,
         vc_base_price_unit_name,
         cur_realized_rows.price_description,
         cur_realized_rows.delivery_item_no,
         vc_price_to_base_fw_rate,
         vc_contract_qp_fw_exch_rate,
         vc_contract_pp_fw_exch_rate,
         vc_sc_to_base_fw_exch_rate);
    end loop;
    vc_error_msg := '10';
    --
    -- Update Realized PNL for Sales Contract
    --
    for cur_update_pnl_rows in cur_update_pnl
    loop
      update prd_physical_realized_daily prd
         set prd.realized_pnl = cur_update_pnl_rows.net_value
       where prd.corporate_id = cur_update_pnl_rows.corporate_id
         and prd.contract_type = 'S'
         and prd.realized_type = 'Realized Today'
         and prd.sales_internal_gmr_ref_no =
             cur_update_pnl_rows.sales_internal_gmr_ref_no
         and prd.int_alloc_group_id =
             cur_update_pnl_rows.int_alloc_group_id
         and prd.process_id = pc_process_id
         and rownum < 2;
    end loop;
    vc_error_msg := '11';
    --
    -- Update Sales Profit Center, Strategy and Business Line For Purchase Contracts
    --
    for cur_update_cpc in (select prd.sales_internal_gmr_ref_no,
                                  prd.profit_center_id,
                                  prd.profit_center_short_name,
                                  prd.profit_center_name,
                                  prd.strategy_id,
                                  prd.strategy_name,
                                  prd.business_line_id,
                                  prd.business_line_name
                             from prd_physical_realized_daily prd
                            where prd.process_id = pc_process_id
                              and prd.contract_type = 'S')
    loop
      update prd_physical_realized_daily prd
         set prd.sales_profit_center_id         = cur_update_cpc.profit_center_id,
             prd.sales_profit_center_short_name = cur_update_cpc.profit_center_short_name,
             prd.sales_profit_center_name       = cur_update_cpc.profit_center_name,
             prd.sales_strategy_id              = cur_update_cpc.strategy_id,
             prd.sales_strategy_name            = cur_update_cpc.strategy_name,
             prd.sales_business_line_id         = cur_update_cpc.business_line_id,
             prd.sales_business_line_name       = cur_update_cpc.business_line_name
       where prd.contract_type = 'P'
         and prd.sales_internal_gmr_ref_no =
             cur_update_cpc.sales_internal_gmr_ref_no
         and prd.process_id = pc_process_id;
    end loop;
    vc_error_msg := '12';
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure pkg_phy_physical_process Realized Today',
                                                           'M2M-013',
                                                           'Code:' ||
                                                           sqlcode ||
                                                           'Message:' ||
                                                           sqlerrm ||
                                                           dbms_utility.format_error_backtrace ||
                                                           'No ' ||
                                                           vc_error_msg,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;

  procedure sp_calc_reverse_realized(pc_corporate_id varchar2,
                                     pd_trade_date   date,
                                     pc_process_id   varchar2,
                                     pc_user_id      varchar2) is
    vobj_error_log     tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count number := 1;
    vc_error_msg       varchar2(10);
  begin
    --
    -- GMRs which are cancelled in this EOD but active in previous EOD
    --
    insert into rgmr_realized_gmr
      (process_id,
       int_alloc_group_id,
       internal_gmr_ref_no,
       realized_status)
      select pc_process_id,
             agh_prev.int_alloc_group_id,
             dgrd_prev.internal_gmr_ref_no,
             'Reverse Realized'
        from agh_alloc_group_header agh_prev,
             dgrd_delivered_grd     dgrd_prev
       where agh_prev.int_alloc_group_id = dgrd_prev.int_alloc_group_id
         and agh_prev.process_id = dgrd_prev.process_id
         and agh_prev.process_id = gvc_previous_process_id
         and agh_prev.realized_status = 'Realized'
         and agh_prev.int_alloc_group_id in
             (select agh_curr.int_alloc_group_id
                from agh_alloc_group_header agh_curr,
                     dgrd_delivered_grd     dgrd_curr
               where agh_curr.process_id = pc_process_id
                 and agh_curr.process_id = dgrd_curr.process_id
                 and agh_curr.int_alloc_group_id =
                     dgrd_curr.int_alloc_group_id
                 and agh_curr.realized_status = 'Reverse Realized');
    insert into prd_physical_realized_daily
      (process_id,
       trade_date,
       corporate_id,
       corporate_name,
       internal_contract_ref_no,
       contract_ref_no,
       internal_contract_item_ref_no,
       del_distribution_item_no,
       contract_issue_date,
       contract_type,
       contract_status,
       int_alloc_group_id,
       alloc_group_name,
       internal_gmr_ref_no,
       gmr_ref_no,
       internal_grd_ref_no,
       internal_stock_ref_no,
       product_id,
       product_name,
       origin_id,
       origin_name,
       quality_id,
       quality_name,
       profit_center_id,
       profit_center_name,
       profit_center_short_name,
       cp_profile_id,
       cp_name,
       trade_user_id,
       trade_user_name,
       price_type_id,
       price_type_name,
       incoterm_id,
       incoterm,
       payment_term_id,
       payment_term,
       price_fixation_details,
       price_fixation_status,
       realized_type,
       realized_date,
       container_no,
       item_qty,
       qty_unit_id,
       qty_unit,
       contract_price,
       price_unit_id,
       price_unit_cur_id,
       price_unit_cur_code,
       price_unit_weight_unit_id,
       price_unit_weight_unit,
       price_unit_weight,
       contract_value_in_price_cur,
       contract_price_cur_id,
       contract_price_cur_code,
       contract_invoice_value,
       secondary_cost_per_unit,
       product_premium_per_unit,
       product_premium,
       quality_premium_per_unit,
       quality_premium,
       secondary_cost_value,
       cog_net_sale_value,
       realized_pnl,
       prev_real_price,
       prev_real_price_id,
       prev_real_price_cur_id,
       prev_real_price_cur_code,
       prev_real_price_weight_unit_id,
       prev_real_price_weight_unit,
       prev_real_price_weight,
       prev_real_qty,
       prev_real_qty_id,
       prev_real_qty_unit,
       prev_cont_value_in_price_cur,
       prev_contract_price_cur_id,
       prev_contract_price_cur_code,
       prev_real_contract_value,
       prev_real_secondary_cost,
       prev_real_cog_net_sale_value,
       prev_real_pnl,
       prev_product_premium_per_unit,
       prev_product_premium,
       prev_quality_premium_per_unit,
       prev_quality_premium,
       prev_secondary_cost_per_unit,
       change_in_pnl,
       cfx_price_cur_to_base_cur,
       warehouse_id,
       warehouse_name,
       shed_id,
       shed_name,
       group_id,
       group_name,
       group_cur_id,
       group_cur_code,
       group_qty_unit_id,
       group_qty_unit,
       item_qty_in_base_qty_unit,
       base_qty_unit_id,
       base_qty_unit,
       base_cur_id,
       base_cur_code,
       base_price_unit_id,
       base_price_unit_name,
       sales_profit_center_id,
       sales_profit_center_name,
       sales_profit_center_short_name,
       sales_internal_gmr_ref_no,
       sales_contract_ref_no,
       origination_city_id,
       origination_city_name,
       origination_country_id,
       origination_country_name,
       destination_city_id,
       destination_city_name,
       destination_country_id,
       destination_country_name,
       pool_id,
       strategy_id,
       strategy_name,
       business_line_id,
       business_line_name,
       bl_number,
       bl_date,
       seal_no,
       mark_no,
       warehouse_ref_no,
       warehouse_receipt_no,
       warehouse_receipt_date,
       is_warrant,
       warrant_no,
       pcdi_id,
       supp_contract_item_ref_no,
       supplier_pcdi_id,
       payable_returnable_type,
       delivery_item_no)
      select pc_process_id,
             pd_trade_date,
             prd.corporate_id,
             prd.corporate_name,
             prd.internal_contract_ref_no,
             prd.contract_ref_no,
             prd.internal_contract_item_ref_no,
             prd.del_distribution_item_no,
             prd.contract_issue_date,
             prd.contract_type,
             prd.contract_status,
             prd.int_alloc_group_id,
             prd.alloc_group_name,
             prd.internal_gmr_ref_no,
             prd.gmr_ref_no,
             prd.internal_grd_ref_no,
             prd.internal_stock_ref_no,
             prd.product_id,
             prd.product_name,
             prd.origin_id,
             prd.origin_name,
             prd.quality_id,
             prd.quality_name,
             prd.profit_center_id,
             prd.profit_center_name,
             prd.profit_center_short_name,
             prd.cp_profile_id,
             prd.cp_name,
             prd.trade_user_id,
             prd.trade_user_name,
             prd.price_type_id,
             prd.price_type_name,
             prd.incoterm_id,
             prd.incoterm,
             prd.payment_term_id,
             prd.payment_term,
             prd.price_fixation_details,
             prd.price_fixation_status,
             'Reverse Realized',
             prd.realized_date,
             prd.container_no,
             prd.item_qty,
             prd.qty_unit_id,
             prd.qty_unit,
             prd.contract_price,
             prd.price_unit_id,
             prd.price_unit_cur_id,
             prd.price_unit_cur_code,
             prd.price_unit_weight_unit_id,
             prd.price_unit_weight_unit,
             prd.price_unit_weight,
             prd.contract_value_in_price_cur,
             prd.contract_price_cur_id,
             prd.contract_price_cur_code,
             -1 * prd.contract_invoice_value,
             prd.secondary_cost_per_unit,
             prd.product_premium_per_unit,
             prd.product_premium,
             prd.quality_premium_per_unit,
             prd.quality_premium,
             -1 * prd.secondary_cost_value,
             -1 * prd.cog_net_sale_value,
             -1 * prd.realized_pnl,
             prd.prev_real_price,
             prd.prev_real_price_id,
             prd.prev_real_price_cur_id,
             prd.prev_real_price_cur_code,
             prd.prev_real_price_weight_unit_id,
             prd.prev_real_price_weight_unit,
             prd.prev_real_price_weight,
             prd.prev_real_qty,
             prd.prev_real_qty_id,
             prd.prev_real_qty_unit,
             prev_cont_value_in_price_cur,
             prd.prev_contract_price_cur_id,
             prd.prev_contract_price_cur_code,
             prd.prev_real_contract_value,
             prd.prev_real_secondary_cost,
             prd.prev_real_cog_net_sale_value,
             prd.prev_real_pnl,
             prd.prev_product_premium_per_unit,
             prd.prev_product_premium,
             prd.prev_quality_premium_per_unit,
             prd.prev_quality_premium,
             prd.prev_secondary_cost_per_unit,
             prd.change_in_pnl,
             prd.cfx_price_cur_to_base_cur,
             prd.warehouse_id,
             prd.warehouse_name,
             prd.shed_id,
             prd.shed_name,
             prd.group_id,
             prd.group_name,
             prd.group_cur_id,
             prd.group_cur_code,
             prd.group_qty_unit_id,
             prd.group_qty_unit,
             prd.item_qty_in_base_qty_unit,
             prd.base_qty_unit_id,
             prd.base_qty_unit,
             prd.base_cur_id,
             prd.base_cur_code,
             prd.base_price_unit_id,
             prd.base_price_unit_name,
             prd.sales_profit_center_id,
             prd.sales_profit_center_name,
             prd.sales_profit_center_short_name,
             prd.sales_internal_gmr_ref_no,
             prd.sales_contract_ref_no,
             prd.origination_city_id,
             prd.origination_city_name,
             prd.origination_country_id,
             prd.origination_country_name,
             prd.destination_city_id,
             prd.destination_city_name,
             prd.destination_country_id,
             prd.destination_country_name,
             prd.pool_id,
             prd.strategy_id,
             prd.strategy_name,
             prd.business_line_id,
             prd.business_line_name,
             prd.bl_number,
             prd.bl_date,
             prd.seal_no,
             prd.mark_no,
             prd.warehouse_ref_no,
             prd.warehouse_receipt_no,
             prd.warehouse_receipt_date,
             prd.is_warrant,
             prd.warrant_no,
             prd.pcdi_id,
             prd.supp_contract_item_ref_no,
             prd.supplier_pcdi_id,
             prd.payable_returnable_type,
             prd.delivery_item_no
        from prd_physical_realized_daily prd,
             tdc_trade_date_closure tdc,
             (select prd.sales_internal_gmr_ref_no,
                     max(prd.trade_date) trade_date
                from prd_physical_realized_daily prd,
                     tdc_trade_date_closure      tdc
               where prd.corporate_id = tdc.corporate_id
                 and tdc.corporate_id = pc_corporate_id
                 and prd.realized_type in
                     ('Realized Today', 'Previously Realized PNL Change')
                 and prd.trade_date < pd_trade_date
                 and prd.trade_date = tdc.trade_date
                 and tdc.process = gvc_process
               group by prd.sales_internal_gmr_ref_no) max_eod -- PRD Realized Date and Allocated Sales
       where (prd.int_alloc_group_id, prd.sales_internal_gmr_ref_no) in
             (select rgmr.int_alloc_group_id,
                     rgmr.internal_gmr_ref_no
                from rgmr_realized_gmr rgmr
               where rgmr.process_id = pc_process_id
                 and rgmr.realized_status = 'Reverse Realized') -- Records to be considered for Reverse Realization
         and prd.trade_date = tdc.trade_date
         and tdc.trade_date = max_eod.trade_date
         and prd.sales_internal_gmr_ref_no =
             max_eod.sales_internal_gmr_ref_no
         and tdc.corporate_id = pc_corporate_id
         and tdc.process = gvc_process
         and tdc.process_id = prd.process_id;
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure pkg_phy_physical_process Realized Today',
                                                           'M2M-013',
                                                           'Code:' ||
                                                           sqlcode ||
                                                           'Message:' ||
                                                           sqlerrm ||
                                                           dbms_utility.format_error_backtrace ||
                                                           'No ' ||
                                                           vc_error_msg,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;
  procedure sp_calc_phy_realize_pnl_change(pc_corporate_id varchar2,
                                           pd_trade_date   date,
                                           pc_process      varchar2,
                                           pc_process_id   varchar2,
                                           pc_user_id      varchar2) is
    vobj_error_log                 tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count             number := 1;
    vc_error_msg                   varchar2(10);
    vn_quality_premium             number;
    vn_quality_premium_per_unit    number;
    vn_product_premium             number;
    vn_product_premium_per_unit    number;
    vn_qty_in_base_qty_unit_id     number;
    vn_sc_in_base_cur              number;
    vc_price_cur_id                varchar2(15);
    vc_price_cur_code              varchar2(15);
    vn_cont_price_cur_id_factor    number;
    vn_cont_price_cur_decimals     number;
    vn_contract_value_in_price_cur number;
    vn_contract_value_in_base_cur  number;
    vn_cog_net_sale_value          number;
    vc_del_premium_main_cur_id     varchar2(15);
    vc_del_premium_main_cur_code   varchar2(15);
    vn_del_premium_cur_main_factor number;
    vn_fw_exch_rate_del_to_base    number;
    vn_forward_points              number;
    vc_contract_qp_fw_exch_rate    varchar2(100);
    vc_contract_pp_fw_exch_rate    varchar2(100);
    vc_qual_prem_exch_rate_string  varchar2(100);
    vn_price_to_base_fw_exch_rate  number;
    vc_price_to_base_fw_rate       varchar2(100);
    vc_sc_to_base_fw_rate          varchar2(500);
    vn_contract_price              number;
    vc_price_unit_id               varchar2(15);
    vc_price_unit_cur_id           varchar2(15);
    vc_price_unit_cur_code         varchar2(15);
    vc_price_unit_weight_unit_id   varchar2(15);
    vc_price_unit_weight_unit      varchar2(15);
    vn_price_unit_weight           number;
  
    cursor cur_realized is
      select pd_trade_date trade_date,
             prd.corporate_id,
             prd.corporate_name,
             prd.internal_contract_ref_no,
             prd.contract_ref_no,
             prd.internal_contract_item_ref_no,
             prd.del_distribution_item_no,
             prd.contract_issue_date,
             prd.contract_type,
             prd.contract_status,
             prd.int_alloc_group_id,
             prd.alloc_group_name,
             prd.internal_gmr_ref_no,
             prd.gmr_ref_no,
             prd.internal_grd_ref_no,
             prd.internal_stock_ref_no,
             prd.product_id,
             prd.product_name,
             prd.origin_id,
             prd.origin_name,
             prd.quality_id,
             prd.quality_name,
             prd.profit_center_id,
             prd.profit_center_name,
             prd.profit_center_short_name,
             prd.cp_profile_id,
             prd.cp_name,
             prd.trade_user_id,
             prd.trade_user_name,
             prd.price_type_id,
             prd.price_type_name,
             prd.incoterm_id,
             prd.incoterm,
             prd.payment_term_id,
             prd.payment_term,
             prd.price_fixation_details,
             prd.price_fixation_status,
             'Previously Realized PNL Change' as realized_type,
             prd.realized_date,
             prd.container_no,
             cipd.contract_price,
             cipd.price_unit_id,
             cipd.price_unit_cur_id,
             cipd.price_unit_cur_code,
             cipd.price_unit_weight_unit_id,
             cipd.price_unit_weight_unit,
             cipd.price_unit_weight,
             prd.contract_price as prev_real_price,
             prd.price_unit_id prev_real_price_id,
             prd.price_unit_cur_id prev_real_price_cur_id,
             prd.price_unit_cur_code prev_real_price_cur_code,
             prd.price_unit_weight_unit_id prev_real_price_weight_unit_id,
             prd.price_unit_weight_unit prev_real_price_weight_unit,
             prd.price_unit_weight prev_real_price_weight,
             prd.item_qty prev_real_qty,
             prd.qty_unit_id prev_real_qty_id,
             prd.qty_unit prev_real_qty_unit,
             prd.contract_value_in_price_cur prev_cont_value_in_price_cur,
             prd.contract_price_cur_id prev_contract_price_cur_id,
             prd.contract_price_cur_code prev_contract_price_cur_code,
             prd.contract_invoice_value as prev_real_contract_value,
             prd.secondary_cost_value prev_real_secondary_cost,
             prd.cog_net_sale_value prev_real_cog_net_sale_value,
             prd.realized_pnl prev_real_pnl,
             prd.product_premium_per_unit prev_product_premium_per_unit,
             prd.product_premium prev_product_premium,
             prd.quality_premium_per_unit prev_quality_premium_per_unit,
             prd.quality_premium prev_quality_premium,
             prd.secondary_cost_per_unit prev_secondary_cost_per_unit,
             prd.warehouse_id,
             prd.warehouse_name,
             prd.shed_id,
             prd.shed_name,
             prd.group_id,
             prd.group_name,
             prd.group_cur_id,
             prd.group_cur_code,
             prd.group_qty_unit_id,
             prd.group_qty_unit,
             prd.base_qty_unit_id,
             prd.base_qty_unit,
             prd.base_cur_id,
             prd.base_cur_code,
             prd.base_price_unit_id,
             prd.base_price_unit_name,
             prd.sales_profit_center_id,
             prd.sales_profit_center_name,
             prd.sales_profit_center_short_name,
             prd.sales_strategy_id,
             prd.sales_strategy_name,
             prd.sales_business_line_id,
             prd.sales_business_line_name,
             prd.sales_internal_gmr_ref_no,
             prd.sales_contract_ref_no,
             prd.origination_city_id,
             prd.origination_city_name,
             prd.origination_country_id,
             prd.origination_country_name,
             prd.destination_city_id,
             prd.destination_city_name,
             prd.destination_country_id,
             prd.destination_country_name,
             prd.pool_id,
             prd.strategy_id,
             prd.strategy_name,
             prd.business_line_id,
             prd.business_line_name,
             prd.bl_number,
             prd.bl_date,
             prd.seal_no,
             prd.mark_no,
             prd.warehouse_ref_no,
             prd.warehouse_receipt_no,
             prd.warehouse_receipt_date,
             prd.is_warrant,
             prd.warrant_no,
             prd.pcdi_id,
             prd.supp_contract_item_ref_no,
             prd.supplier_pcdi_id,
             prd.payable_returnable_type,
             prd.price_description,
             nvl(gscs.avg_cost_fw_rate, 0) avg_secondary_cost,
             null product_premium_per_unit,
             null quality_premium_per_unit,
             pcdb.premium product_premium,
             pcdb.premium_unit_id product_premium_unit_id,
             case
               when rgmr.is_mc_change_for_sales = 'Y' then
                dgrd.current_qty
               else
                prd.item_qty
             end item_qty,
             case
               when rgmr.is_mc_change_for_sales = 'Y' then
                dgrd.net_weight_unit_id
               else
                prd.qty_unit_id
             end qty_unit_id,
             case
               when rgmr.is_mc_change_for_sales = 'Y' then
                qum_dgrd.qty_unit
               else
                prd.qty_unit
             end qty_unit,
             prd.delivery_item_no,
             rgmr.is_mc_change_for_sales,
             prd.item_qty_in_base_qty_unit,
             cm_ppu.cur_id del_premium_cur_id,
             cm_ppu.cur_code del_premium_cur_code,
             ppu.weight del_premium_weight,
             ppu.weight_unit_id del_premium_weight_unit_id,
             pcdi.payment_due_date payment_due_date,
             null as price_to_base_fw_exch_rate_act,
             null as price_to_base_fw_exch_rate,
             null as contract_qp_fw_exch_rate,
             null as contract_pp_fw_exch_rate,
             gscs.fw_rate_string as accrual_to_base_fw_exch_rate,
             prd.price_to_base_fw_exch_rate p_price_to_base_fw_exch_rate,
             prd.contract_qp_fw_exch_rate p_contract_qp_fw_exch_rate,
             prd.contract_pp_fw_exch_rate p_contract_pp_fw_exch_rate,
             prd.accrual_to_base_fw_exch_rate p_accrual_to_base_fw_exch_rate,
             rgmrd.latest_internal_invoice_ref_no
        from prd_physical_realized_daily    prd,
             rgmr_realized_gmr              rgmr,
             cipd_contract_item_price_daily cipd,
             gscs_gmr_sec_cost_summary      gscs,
             pcdb_pc_delivery_basis         pcdb,
             dgrd_delivered_grd             dgrd,
             qum_quantity_unit_master       qum_dgrd,
             v_ppu_pum                      ppu,
             cm_currency_master             cm_ppu,
             pcdi_pc_delivery_item          pcdi,
             rgmrd_realized_gmr_detail      rgmrd
       where rgmr.process_id = pc_process_id
         and prd.int_alloc_group_id = rgmr.int_alloc_group_id
         and prd.sales_internal_gmr_ref_no = rgmr.internal_gmr_ref_no
         and prd.process_id = rgmr.realized_process_id
         and rgmr.realized_status = 'Previously Realized PNL Change'
         and prd.internal_contract_item_ref_no =
             cipd.internal_contract_item_ref_no
         and cipd.process_id = pc_process_id
         and rgmr.internal_gmr_ref_no = gscs.internal_gmr_ref_no(+)
         and rgmr.process_id = gscs.process_id(+)
         and prd.contract_type = 'S'
         and prd.internal_contract_ref_no = pcdb.internal_contract_ref_no
         and pcdb.process_id = pc_process_id
         and dgrd.internal_dgrd_ref_no = prd.internal_grd_ref_no
         and dgrd.process_id = pc_process_id
         and qum_dgrd.qty_unit_id = dgrd.net_weight_unit_id
         and ppu.product_price_unit_id(+) = pcdb.premium_unit_id
         and ppu.cur_id = cm_ppu.cur_id(+)
         and prd.internal_contract_ref_no = pcdi.internal_contract_ref_no
         and pcdi.process_id = pc_process_id
         and rgmrd.realized_internal_gmr_ref_no =
             prd.sales_internal_gmr_ref_no
         and rgmrd.contract_type = 'S'
         and rgmrd.process_id = pc_process_id
      union
      select pd_trade_date trade_date,
             prd.corporate_id,
             prd.corporate_name,
             prd.internal_contract_ref_no,
             prd.contract_ref_no,
             prd.internal_contract_item_ref_no,
             prd.del_distribution_item_no,
             prd.contract_issue_date,
             prd.contract_type,
             prd.contract_status,
             prd.int_alloc_group_id,
             prd.alloc_group_name,
             prd.internal_gmr_ref_no,
             prd.gmr_ref_no,
             prd.internal_grd_ref_no,
             prd.internal_stock_ref_no,
             prd.product_id,
             prd.product_name,
             prd.origin_id,
             prd.origin_name,
             prd.quality_id,
             prd.quality_name,
             prd.profit_center_id,
             prd.profit_center_name,
             prd.profit_center_short_name,
             prd.cp_profile_id,
             prd.cp_name,
             prd.trade_user_id,
             prd.trade_user_name,
             prd.price_type_id,
             prd.price_type_name,
             prd.incoterm_id,
             prd.incoterm,
             prd.payment_term_id,
             prd.payment_term,
             prd.price_fixation_details,
             prd.price_fixation_status,
             'Previously Realized PNL Change' as realized_type,
             prd.realized_date,
             prd.container_no,
             invs.material_cost_per_unit contract_price,
             invs.price_unit_id price_unit_id,
             invs.price_unit_cur_id,
             invs.price_unit_cur_code,
             invs.price_unit_weight_unit_id,
             invs.price_unit_weight_unit,
             invs.price_unit_weight,
             prd.contract_price as prev_real_price,
             prd.price_unit_id prev_real_price_id,
             prd.price_unit_cur_id prev_real_price_cur_id,
             prd.price_unit_cur_code prev_real_price_cur_code,
             prd.price_unit_weight_unit_id prev_real_price_weight_unit_id,
             prd.price_unit_weight_unit prev_real_price_weight_unit,
             prd.price_unit_weight prev_real_price_weight,
             prd.item_qty prev_real_qty,
             prd.qty_unit_id prev_real_qty_id,
             prd.qty_unit prev_real_qty_unit,
             prd.contract_value_in_price_cur prev_cont_value_in_price_cur,
             prd.contract_price_cur_id prev_contract_price_cur_id,
             prd.contract_price_cur_code prev_contract_price_cur_code,
             prd.contract_invoice_value as prev_real_contract_value,
             prd.secondary_cost_value prev_real_secondary_cost,
             prd.cog_net_sale_value prev_real_cog_net_sale_value,
             prd.realized_pnl prev_real_pnl,
             prd.product_premium_per_unit prev_product_premium_per_unit,
             prd.product_premium prev_product_premium,
             prd.quality_premium_per_unit prev_quality_premium_per_unit,
             prd.quality_premium prev_quality_premium,
             prd.secondary_cost_per_unit prev_secondary_cost_per_unit,
             prd.warehouse_id,
             prd.warehouse_name,
             prd.shed_id,
             prd.shed_name,
             prd.group_id,
             prd.group_name,
             prd.group_cur_id,
             prd.group_cur_code,
             prd.group_qty_unit_id,
             prd.group_qty_unit,
             prd.base_qty_unit_id,
             prd.base_qty_unit,
             prd.base_cur_id,
             prd.base_cur_code,
             prd.base_price_unit_id,
             prd.base_price_unit_name,
             prd.sales_profit_center_id,
             prd.sales_profit_center_name,
             prd.sales_profit_center_short_name,
             prd.sales_strategy_id,
             prd.sales_strategy_name,
             prd.sales_business_line_id,
             prd.sales_business_line_name,
             prd.sales_internal_gmr_ref_no,
             prd.sales_contract_ref_no,
             prd.origination_city_id,
             prd.origination_city_name,
             prd.origination_country_id,
             prd.origination_country_name,
             prd.destination_city_id,
             prd.destination_city_name,
             prd.destination_country_id,
             prd.destination_country_name,
             prd.pool_id,
             prd.strategy_id,
             prd.strategy_name,
             prd.business_line_id,
             prd.business_line_name,
             prd.bl_number,
             prd.bl_date,
             prd.seal_no,
             prd.mark_no,
             prd.warehouse_ref_no,
             prd.warehouse_receipt_no,
             prd.warehouse_receipt_date,
             prd.is_warrant,
             prd.warrant_no,
             prd.pcdi_id,
             prd.supp_contract_item_ref_no,
             prd.supplier_pcdi_id,
             prd.payable_returnable_type,
             prd.price_description,
             invs.secondary_cost_per_unit avg_secondary_cost,
             invs.product_premium_per_unit,
             invs.quality_premium_per_unit,
             null product_premium,
             null product_premium_unit_id,
             prd.item_qty item_qty,
             prd.qty_unit_id,
             prd.qty_unit,
             prd.delivery_item_no,
             rgmr.is_mc_change_for_sales,
             prd.item_qty_in_base_qty_unit,
             null del_premium_cur_id,
             null del_premium_cur_code,
             null del_premium_weight,
             null del_premium_weight_unit_id,
             pd_trade_date payment_due_date,
             invs.price_to_base_fw_exch_rate_act,
             invs.price_to_base_fw_exch_rate,
             invs.contract_qp_fw_exch_rate,
             invs.contract_pp_fw_exch_rate,
             invs.accrual_to_base_fw_exch_rate,
             prd.price_to_base_fw_exch_rate p_price_to_base_fw_exch_rate,
             prd.contract_qp_fw_exch_rate p_contract_qp_fw_exch_rate,
             prd.contract_pp_fw_exch_rate p_contract_pp_fw_exch_rate,
             prd.accrual_to_base_fw_exch_rate p_accrual_to_base_fw_exch_rate,
             rgmrd.latest_internal_invoice_ref_no
        from prd_physical_realized_daily prd,
             rgmr_realized_gmr           rgmr,
             invm_cogs                   invs,
             grd_goods_record_detail     grd,
             agh_alloc_group_header      agh,
             agd_alloc_group_detail      agd,
             qum_quantity_unit_master    qum_agd,
             rgmrd_realized_gmr_detail   rgmrd
       where rgmr.process_id = pc_process_id
         and prd.int_alloc_group_id = rgmr.int_alloc_group_id
         and prd.sales_internal_gmr_ref_no = rgmr.internal_gmr_ref_no
         and prd.process_id = rgmr.realized_process_id
         and rgmr.realized_status = 'Previously Realized PNL Change'
         and prd.internal_grd_ref_no = invs.internal_grd_ref_no
         and invs.sales_internal_gmr_ref_no = prd.sales_internal_gmr_ref_no
         and invs.process_id = pc_process_id
         and prd.contract_type = 'P'
         and grd.internal_grd_ref_no = prd.internal_grd_ref_no
         and grd.process_id = pc_process_id
         and agd.internal_stock_ref_no = grd.internal_grd_ref_no
         and agd.process_id = pc_process_id
         and agh.int_alloc_group_id = agd.int_alloc_group_id
         and agh.process_id = pc_process_id
         and qum_agd.qty_unit_id = agd.qty_unit_id
         and rgmrd.realized_internal_gmr_ref_no =
             prd.sales_internal_gmr_ref_no
         and rgmrd.purchase_internal_gmr_ref_no = prd.internal_gmr_ref_no
         and rgmrd.contract_type = 'P'
         and rgmrd.process_id = pc_process_id;
    cursor cur_update_pnl is
      select prd.corporate_id,
             prd.int_alloc_group_id,
             prd.sales_internal_gmr_ref_no,
             prd.process_id,
             sum(prd.cog_net_sale_value) net_value
        from prd_physical_realized_daily prd
       where prd.process_id = pc_process_id
         and prd.corporate_id = pc_corporate_id
         and prd.realized_type = 'Previously Realized PNL Change'
       group by prd.corporate_id,
                prd.int_alloc_group_id,
                prd.sales_internal_gmr_ref_no,
                prd.process_id;
  begin
    --
    -- PNL Change for Quantity Change
    --
    delete from trgmr_temp_rgmr where corporate_id = pc_corporate_id;
    vc_error_msg := '1';
  
    insert into trgmr_temp_rgmr
      (corporate_id,
       int_alloc_group_id,
       internal_gmr_ref_no,
       realized_status,
       realized_process_id,
       realized_process_date,
       section_name,
       is_mc_change_for_sales)
      select pc_corporate_id,
             t.int_alloc_group_id,
             t.sales_internal_gmr_ref_no,
             'Previously Realized PNL Change',
             tdc.process_id,
             t.trade_date,
             t.section_name,
             is_mc_change_for_sales
        from (
              --
              -- Get the 'Realized Today', 'Previously Realized PNL Change' data for EOD/EOM
              --
              select prd.sales_internal_gmr_ref_no,
                      prd.int_alloc_group_id,
                      max(prd.trade_date) trade_date,
                      'Material Cost Change Sales' section_name,
                      'Y' is_mc_change_for_sales
                from dgrdul_delivered_grd_ul     dgrdul,
                      dgrd_delivered_grd          dgrd,
                      prd_physical_realized_daily prd,
                      tdc_trade_date_closure      tdc
               where dgrdul.internal_dgrd_ref_no = dgrd.internal_dgrd_ref_no
                 and dgrdul.process_id = pc_process_id
                 and dgrd.process_id = pc_process_id
                 and prd.corporate_id = pc_corporate_id
                 and prd.process_id = tdc.process_id
                 and tdc.process = pc_process
                 and prd.internal_gmr_ref_no = dgrd.internal_gmr_ref_no
                 and prd.trade_date < pd_trade_date
                 and prd.realized_type in
                     ('Realized Today', 'Previously Realized PNL Change')
               group by prd.sales_internal_gmr_ref_no,
                         prd.int_alloc_group_id) t,
             tdc_trade_date_closure tdc
       where tdc.corporate_id = pc_corporate_id
         and tdc.trade_date = t.trade_date
         and tdc.process = pc_process;
    vc_error_msg := '2';
    --
    -- PNL Change For Secondary Cost / Material Cost Change
    --                   
    insert into trgmr_temp_rgmr
      (corporate_id,
       int_alloc_group_id,
       internal_gmr_ref_no,
       realized_status,
       realized_process_id,
       realized_process_date,
       section_name)
      select pc_corporate_id,
             t.int_alloc_group_id,
             t.sales_internal_gmr_ref_no,
             'Previously Realized PNL Change',
             tdc.process_id,
             t.trade_date,
             'Secondary Cost Change'
        from (select prd.sales_internal_gmr_ref_no,
                     prd.int_alloc_group_id,
                     max(prd.trade_date) trade_date
                from cdl_cost_delta_log          cdl,
                     cs_cost_store               cs,
                     cigc_contract_item_gmr_cost cigc,
                     prd_physical_realized_daily prd,
                     tdc_trade_date_closure      tdc,
                     scm_service_charge_master   scm
               where cdl.process_id = pc_process_id
                 and cdl.cost_ref_no = cs.cost_ref_no
                 and cs.internal_cost_id = cs.internal_cost_id
                 and cs.cog_ref_no = cigc.cog_ref_no
                 and cs.process_id = cigc.process_id
                 and cigc.process_id = pc_process_id
                 and scm.cost_id = cs.cost_component_id
                 and scm.cost_type in ('DIRECT_COST', 'SECONDARY_COST')
                 and cigc.internal_gmr_ref_no = prd.internal_gmr_ref_no
                 and prd.trade_date = tdc.trade_date
                 and tdc.process = pc_process
                 and prd.trade_date < pd_trade_date
                 and prd.realized_type in
                     ('Realized Today', 'Previously Realized PNL Change')
               group by prd.sales_internal_gmr_ref_no,
                        prd.int_alloc_group_id) t,
             tdc_trade_date_closure tdc
       where tdc.corporate_id = pc_corporate_id
         and tdc.trade_date = t.trade_date
         and tdc.process = pc_process;
    vc_error_msg := '3';
  
    insert into rgmr_realized_gmr
      (process_id,
       int_alloc_group_id,
       internal_gmr_ref_no,
       realized_status,
       realized_process_id,
       realized_process_date,
       is_mc_change_for_sales)
      select pc_process_id,
             int_alloc_group_id,
             internal_gmr_ref_no,
             realized_status,
             realized_process_id,
             realized_process_date,
             max(is_mc_change_for_sales)
        from trgmr_temp_rgmr t
       where t.corporate_id = pc_corporate_id
       group by int_alloc_group_id,
                internal_gmr_ref_no,
                realized_status,
                realized_process_id,
                realized_process_date;
    vc_error_msg := '4';
  
    --
    -- If PI / FI created mark them as we need to use this price and amount
    --
    insert into rgmrd_realized_gmr_detail
      (process_id,
       realized_internal_gmr_ref_no,
       purchase_internal_gmr_ref_no,
       internal_contract_item_ref_no,
       price_type_id,
       contract_type,
       price_fixation_status,
       is_invoiced,
       corporate_id)
      select pc_process_id,
             prd.sales_internal_gmr_ref_no,
             decode(prd.contract_type, 'P', prd.internal_gmr_ref_no, null) internal_gmr_ref_no,
             prd.internal_contract_item_ref_no,
             prd.price_type_id,
             prd.contract_type,
             prd.price_fixation_status,
             'N',
             prd.corporate_id
        from rgmr_realized_gmr           rgmr,
             prd_physical_realized_daily prd
       where rgmr.process_id = pc_process_id
         and rgmr.int_alloc_group_id = prd.int_alloc_group_id
         and rgmr.internal_gmr_ref_no = prd.sales_internal_gmr_ref_no
         and prd.process_id = rgmr.realized_process_id;
    vc_error_msg := '5';
  
    update rgmrd_realized_gmr_detail t
       set (t.is_invoiced, t.latest_internal_invoice_ref_no) = --
            (select decode(gmr.latest_internal_invoice_ref_no, null, 'N', 'Y'),
                    gmr.latest_internal_invoice_ref_no
               from gmr_goods_movement_record gmr
              where gmr.process_id = pc_process_id
                and gmr.internal_gmr_ref_no = t.realized_internal_gmr_ref_no)
     where t.process_id = pc_process_id
       and t.contract_type = 'S';
    update rgmrd_realized_gmr_detail t
       set (t.is_invoiced, t.latest_internal_invoice_ref_no) = --
            (select decode(gmr.latest_internal_invoice_ref_no, null, 'N', 'Y'),
                    gmr.latest_internal_invoice_ref_no
               from gmr_goods_movement_record gmr
              where gmr.process_id = pc_process_id
                and gmr.internal_gmr_ref_no = t.purchase_internal_gmr_ref_no)
     where t.process_id = pc_process_id
       and t.contract_type = 'P';
  
    --        
    -- update Price Data in RGMRD
    -- 
    update rgmrd_realized_gmr_detail rgmrd
       set (rgmrd.price_type_id, rgmrd.price_fixation_status) = --
            (select cipd.price_basis,
                    cipd.price_fixation_status
               from cipd_contract_item_price_daily cipd
              where cipd.process_id = pc_process_id
                and cipd.internal_contract_item_ref_no =
                    rgmrd.internal_contract_item_ref_no)
     where rgmrd.process_id = pc_process_id;
    vc_error_msg := '6';
  
    for cur_realized_rows in cur_realized
    loop
    
      -- Contract Price Details  
      if cur_realized_rows.latest_internal_invoice_ref_no is null then
        vc_error_msg                 := '7';
        vn_contract_price            := cur_realized_rows.contract_price;
        vc_price_unit_id             := cur_realized_rows.price_unit_id;
        vc_price_unit_cur_id         := cur_realized_rows.price_unit_cur_id;
        vc_price_unit_cur_code       := cur_realized_rows.price_unit_cur_code;
        vc_price_unit_weight_unit_id := cur_realized_rows.price_unit_weight_unit_id;
        vc_price_unit_weight_unit    := cur_realized_rows.price_unit_weight_unit;
        vn_price_unit_weight         := cur_realized_rows.price_unit_weight;
        if vn_price_unit_weight is null then
          vn_price_unit_weight := 1;
        end if;
      
      else
        -- Invoice Present
        vc_error_msg := '8';
        begin
          select iid.new_invoice_price,
                 iid.new_invoice_price_unit_id,
                 ppu.cur_id,
                 cm.cur_code,
                 ppu.weight_unit_id,
                 qum.qty_unit,
                 nvl(ppu.weight, 1) weight
            into vn_contract_price,
                 vc_price_unit_id,
                 vc_price_unit_cur_id,
                 vc_price_unit_cur_code,
                 vc_price_unit_weight_unit_id,
                 vc_price_unit_weight_unit,
                 vn_price_unit_weight
            from iid_invoicable_item_details iid,
                 v_ppu_pum                   ppu,
                 cm_currency_master          cm,
                 qum_quantity_unit_master    qum
           where iid.internal_invoice_ref_no =
                 cur_realized_rows.latest_internal_invoice_ref_no
             and iid.new_invoice_price_unit_id = ppu.product_price_unit_id
             and ppu.cur_id = cm.cur_id
             and ppu.weight_unit_id = qum.qty_unit_id
             and iid.internal_gmr_ref_no =
                 cur_realized_rows.internal_gmr_ref_no;
        
        exception
          when others then
            vc_error_msg := '9';
            -- REMOVE THIS LATER, NOT SURE HOW INVOICE IS WORKING
            vn_contract_price            := cur_realized_rows.contract_price;
            vc_price_unit_id             := cur_realized_rows.price_unit_id;
            vc_price_unit_cur_id         := cur_realized_rows.price_unit_cur_id;
            vc_price_unit_cur_code       := cur_realized_rows.price_unit_cur_code;
            vc_price_unit_weight_unit_id := cur_realized_rows.price_unit_weight_unit_id;
            vc_price_unit_weight_unit    := cur_realized_rows.price_unit_weight_unit;
            vn_price_unit_weight         := cur_realized_rows.price_unit_weight;
          
        end;
      end if;
      vc_error_msg := '10';
    
      vc_sc_to_base_fw_rate := cur_realized_rows.accrual_to_base_fw_exch_rate;
    
      --
      -- If there is quantity change, this qty is used in this EOD
      --
      if cur_realized_rows.contract_type = 'S' and
         cur_realized_rows.is_mc_change_for_sales = 'Y' then
        vc_error_msg := '11';
        if cur_realized_rows.qty_unit_id <>
           cur_realized_rows.base_qty_unit_id then
          select pkg_general.f_get_converted_quantity(cur_realized_rows.product_id,
                                                      cur_realized_rows.qty_unit_id,
                                                      cur_realized_rows.base_qty_unit_id,
                                                      cur_realized_rows.item_qty)
            into vn_qty_in_base_qty_unit_id
            from dual;
        
        else
          vn_qty_in_base_qty_unit_id := cur_realized_rows.item_qty;
        end if;
      else
        vn_qty_in_base_qty_unit_id := cur_realized_rows.item_qty_in_base_qty_unit;
      end if;
      --
      -- Calcualte the New Quality Premium (Sales from Contract and Purchase from INVS)
      --
      vc_error_msg := '12';
    
      if cur_realized_rows.contract_type = 'S' then
        sp_quality_premium_fw_rate(cur_realized_rows.internal_contract_item_ref_no,
                                   pc_corporate_id,
                                   pd_trade_date,
                                   cur_realized_rows.base_price_unit_id,
                                   cur_realized_rows.base_cur_id,
                                   cur_realized_rows.payment_due_date,
                                   cur_realized_rows.product_id,
                                   cur_realized_rows.base_qty_unit_id,
                                   pc_process_id,
                                   vn_quality_premium_per_unit,
                                   vc_qual_prem_exch_rate_string);
        if vc_qual_prem_exch_rate_string is not null then
          vc_contract_qp_fw_exch_rate := vc_qual_prem_exch_rate_string;
        end if;
      
        vn_quality_premium := round((vn_quality_premium_per_unit *
                                    vn_qty_in_base_qty_unit_id),
                                    2);
      else
        vn_quality_premium_per_unit := cur_realized_rows.quality_premium_per_unit;
        vn_quality_premium          := vn_quality_premium_per_unit *
                                       vn_qty_in_base_qty_unit_id;
        vc_contract_qp_fw_exch_rate := cur_realized_rows.contract_qp_fw_exch_rate;
      end if;
      vc_error_msg := '13';
    
      --
      -- Calcualte the new  Product Premium (Sales from Contract and Purchase from INVS)
      --
      if cur_realized_rows.contract_type = 'S' then
        if cur_realized_rows.product_premium <> 0 then
          if cur_realized_rows.product_premium_unit_id <>
             cur_realized_rows.base_price_unit_id then
          
            --
            -- Get the Main Currency of the Delivery Premium Price Unit
            --
            pkg_general.sp_get_base_cur_detail(cur_realized_rows.del_premium_cur_id,
                                               vc_del_premium_main_cur_id,
                                               vc_del_premium_main_cur_code,
                                               vn_del_premium_cur_main_factor);
          
            pkg_general.sp_forward_cur_exchange_new(pc_corporate_id,
                                                    pd_trade_date,
                                                    cur_realized_rows.payment_due_date,
                                                    vc_del_premium_main_cur_id,
                                                    cur_realized_rows.base_cur_id,
                                                    30,
                                                    vn_fw_exch_rate_del_to_base,
                                                    vn_forward_points);
          
            if vc_del_premium_main_cur_id <> cur_realized_rows.base_cur_id then
              if vn_fw_exch_rate_del_to_base is null or
                 vn_fw_exch_rate_del_to_base = 0 then
                vobj_error_log.extend;
                vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                     'procedure pkg_phy_physical_process-sp_calc_realized_pnl_change ',
                                                                     'PHY-005',
                                                                     cur_realized_rows.base_cur_code ||
                                                                     ' to ' ||
                                                                     vc_del_premium_main_cur_code || ' (' ||
                                                                     to_char(pd_trade_date,
                                                                             'dd-Mon-yyyy') || ') ',
                                                                     '',
                                                                     gvc_process,
                                                                     null, --pc_user_id,
                                                                     sysdate,
                                                                     pd_trade_date);
                sp_insert_error_log(vobj_error_log);
              end if;
            end if;
            if vn_fw_exch_rate_del_to_base <> 1 then
              vc_contract_pp_fw_exch_rate := '1 ' ||
                                             vc_del_premium_main_cur_code || '=' ||
                                             vn_fw_exch_rate_del_to_base || ' ' ||
                                             cur_realized_rows.base_cur_code;
            end if;
          
            vn_product_premium_per_unit := (cur_realized_rows.product_premium /
                                           nvl(cur_realized_rows.del_premium_weight,
                                                1)) *
                                           vn_del_premium_cur_main_factor *
                                           vn_fw_exch_rate_del_to_base *
                                           vn_qty_in_base_qty_unit_id;
          else
            vn_product_premium_per_unit := cur_realized_rows.product_premium;
          end if;
          vn_product_premium := round(vn_product_premium_per_unit *
                                      vn_qty_in_base_qty_unit_id,
                                      2);
        else
          vn_product_premium          := 0;
          vn_product_premium_per_unit := 0;
        end if;
      else
        vn_product_premium_per_unit := cur_realized_rows.product_premium_per_unit;
        vn_product_premium          := vn_product_premium_per_unit *
                                       vn_qty_in_base_qty_unit_id;
        vc_contract_pp_fw_exch_rate := cur_realized_rows.contract_pp_fw_exch_rate;
      end if;
    
      vc_error_msg := '14';
    
      --
      -- Secondary Cost in Base
      --
      vn_sc_in_base_cur := cur_realized_rows.avg_secondary_cost *
                           vn_qty_in_base_qty_unit_id;
    
      --
      -- Pricing Main Currency Details
      --
      if cur_realized_rows.contract_type = 'S' then
        pkg_general.sp_get_main_cur_detail(vc_price_unit_cur_id,
                                           vc_price_cur_id,
                                           vc_price_cur_code,
                                           vn_cont_price_cur_id_factor,
                                           vn_cont_price_cur_decimals);
      else
        -- It is from COG and has to be in Base Currency
        vc_price_cur_id             := cur_realized_rows.base_cur_id;
        vc_price_cur_code           := cur_realized_rows.base_cur_code;
        vn_cont_price_cur_id_factor := 1;
        vn_cont_price_cur_decimals  := 2;
      end if;
      vc_error_msg := '15';
      --  
      -- Contratc value in base cur = Price Per Unit in Base * Qty in Base
      -- 
      if cur_realized_rows.contract_type = 'P' then
        vn_contract_value_in_price_cur := vn_qty_in_base_qty_unit_id *
                                          vn_contract_price;
        vn_contract_value_in_base_cur  := vn_contract_value_in_price_cur;
      
      else
        vc_error_msg := '16';
        --
        -- Contract Value in Price Currency
        -- 
        vn_contract_value_in_price_cur := (vn_contract_price /
                                          nvl(vn_price_unit_weight, 1)) *
                                          vn_cont_price_cur_id_factor *
                                          vn_qty_in_base_qty_unit_id;
        --
        -- Get the Contract Value in Base Currency
        --
        vc_error_msg := '17';
        if cur_realized_rows.contract_type = 'P' then
          vc_price_to_base_fw_rate      := cur_realized_rows.price_to_base_fw_exch_rate;
          vn_price_to_base_fw_exch_rate := cur_realized_rows.price_to_base_fw_exch_rate_act;
        else
          pkg_general.sp_forward_cur_exchange_new(pc_corporate_id,
                                                  pd_trade_date,
                                                  cur_realized_rows.payment_due_date,
                                                  vc_price_cur_id,
                                                  cur_realized_rows.base_cur_id,
                                                  30,
                                                  vn_price_to_base_fw_exch_rate,
                                                  vn_forward_points);
        
          if vc_price_cur_id <> cur_realized_rows.base_cur_id then
            if vn_price_to_base_fw_exch_rate is null or
               vn_price_to_base_fw_exch_rate = 0 then
              vobj_error_log.extend;
              vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                                   'procedure pkg_phy_physical_process-sp_ realized_pnl_change ',
                                                                   'PHY-005',
                                                                   cur_realized_rows.base_cur_code ||
                                                                   ' to ' ||
                                                                   vc_price_cur_code || ' (' ||
                                                                   to_char(pd_trade_date,
                                                                           'dd-Mon-yyyy') || ') ',
                                                                   '',
                                                                   gvc_process,
                                                                   pc_user_id,
                                                                   sysdate,
                                                                   pd_trade_date);
              sp_insert_error_log(vobj_error_log);
            end if;
          end if;
        
          if vn_price_to_base_fw_exch_rate is not null and
             vn_price_to_base_fw_exch_rate <> 1 then
            vc_price_to_base_fw_rate := '1 ' ||
                                        cur_realized_rows.base_cur_code || '=' ||
                                        vn_price_to_base_fw_exch_rate || ' ' ||
                                        vc_price_cur_code;
          end if;
        
        end if;
      
        vc_error_msg := '18';
      
        vn_contract_value_in_base_cur := (vn_contract_price /
                                         nvl(vn_price_unit_weight, 1)) *
                                         vn_cont_price_cur_id_factor *
                                         vn_price_to_base_fw_exch_rate *
                                         vn_qty_in_base_qty_unit_id;
      
      end if;
      vc_error_msg := '19';
      --
      -- Total COG/Sale Value = Contract Value + Quality Premium + Product Premium + Secondary Cost
      --
      vn_cog_net_sale_value := vn_contract_value_in_base_cur +
                               vn_quality_premium + vn_product_premium;
      if cur_realized_rows.contract_type = 'P' then
        vn_cog_net_sale_value := -1 * (vn_cog_net_sale_value +
                                 abs(vn_sc_in_base_cur));
      else
        vn_cog_net_sale_value := vn_cog_net_sale_value -
                                 abs(vn_sc_in_base_cur);
      end if;
      vc_error_msg := '20';
      insert into prd_physical_realized_daily
        (process_id,
         trade_date,
         corporate_id,
         corporate_name,
         internal_contract_ref_no,
         contract_ref_no,
         internal_contract_item_ref_no,
         del_distribution_item_no,
         contract_issue_date,
         contract_type,
         contract_status,
         int_alloc_group_id,
         alloc_group_name,
         internal_gmr_ref_no,
         gmr_ref_no,
         internal_grd_ref_no,
         internal_stock_ref_no,
         product_id,
         product_name,
         origin_id,
         origin_name,
         quality_id,
         quality_name,
         profit_center_id,
         profit_center_name,
         profit_center_short_name,
         cp_profile_id,
         cp_name,
         trade_user_id,
         trade_user_name,
         price_type_id,
         price_type_name,
         incoterm_id,
         incoterm,
         payment_term_id,
         payment_term,
         price_fixation_details,
         price_fixation_status,
         realized_type,
         realized_date,
         container_no,
         item_qty,
         qty_unit_id,
         qty_unit,
         contract_price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         price_unit_weight_unit_id,
         price_unit_weight_unit,
         price_unit_weight,
         contract_value_in_price_cur,
         contract_price_cur_id,
         contract_price_cur_code,
         contract_invoice_value,
         secondary_cost_per_unit,
         product_premium_per_unit,
         product_premium,
         quality_premium_per_unit,
         quality_premium,
         secondary_cost_value,
         cog_net_sale_value,
         realized_pnl,
         prev_real_price,
         prev_real_price_id,
         prev_real_price_cur_id,
         prev_real_price_cur_code,
         prev_real_price_weight_unit_id,
         prev_real_price_weight_unit,
         prev_real_price_weight,
         prev_real_qty,
         prev_real_qty_id,
         prev_real_qty_unit,
         prev_cont_value_in_price_cur,
         prev_contract_price_cur_id,
         prev_contract_price_cur_code,
         prev_real_contract_value,
         prev_real_secondary_cost,
         prev_real_cog_net_sale_value,
         prev_real_pnl,
         prev_product_premium_per_unit,
         prev_product_premium,
         prev_quality_premium_per_unit,
         prev_quality_premium,
         prev_secondary_cost_per_unit,
         change_in_pnl,
         cfx_price_cur_to_base_cur,
         warehouse_id,
         warehouse_name,
         shed_id,
         shed_name,
         group_id,
         group_name,
         group_cur_id,
         group_cur_code,
         group_qty_unit_id,
         group_qty_unit,
         item_qty_in_base_qty_unit,
         base_qty_unit_id,
         base_qty_unit,
         base_cur_id,
         base_cur_code,
         base_price_unit_id,
         base_price_unit_name,
         sales_profit_center_id,
         sales_profit_center_name,
         sales_profit_center_short_name,
         sales_strategy_id,
         sales_strategy_name,
         sales_business_line_id,
         sales_business_line_name,
         sales_internal_gmr_ref_no,
         sales_contract_ref_no,
         origination_city_id,
         origination_city_name,
         origination_country_id,
         origination_country_name,
         destination_city_id,
         destination_city_name,
         destination_country_id,
         destination_country_name,
         pool_id,
         strategy_id,
         strategy_name,
         business_line_id,
         business_line_name,
         bl_number,
         bl_date,
         seal_no,
         mark_no,
         warehouse_ref_no,
         warehouse_receipt_no,
         warehouse_receipt_date,
         is_warrant,
         warrant_no,
         pcdi_id,
         supp_contract_item_ref_no,
         supplier_pcdi_id,
         payable_returnable_type,
         price_description,
         delivery_item_no,
         price_to_base_fw_exch_rate,
         contract_qp_fw_exch_rate,
         contract_pp_fw_exch_rate,
         accrual_to_base_fw_exch_rate,
         p_price_to_base_fw_exch_rate,
         p_contract_qp_fw_exch_rate,
         p_contract_pp_fw_exch_rate,
         p_accrual_to_base_fw_exch_rate)
      values
        (pc_process_id,
         pd_trade_date,
         cur_realized_rows.corporate_id,
         cur_realized_rows.corporate_name,
         cur_realized_rows.internal_contract_ref_no,
         cur_realized_rows.contract_ref_no,
         cur_realized_rows.internal_contract_item_ref_no,
         cur_realized_rows.del_distribution_item_no,
         cur_realized_rows.contract_issue_date,
         cur_realized_rows.contract_type,
         cur_realized_rows.contract_status,
         cur_realized_rows.int_alloc_group_id,
         cur_realized_rows.alloc_group_name,
         cur_realized_rows.internal_gmr_ref_no,
         cur_realized_rows.gmr_ref_no,
         cur_realized_rows.internal_grd_ref_no,
         cur_realized_rows.internal_stock_ref_no,
         cur_realized_rows.product_id,
         cur_realized_rows.product_name,
         cur_realized_rows.origin_id,
         cur_realized_rows.origin_name,
         cur_realized_rows.quality_id,
         cur_realized_rows.quality_name,
         cur_realized_rows.profit_center_id,
         cur_realized_rows.profit_center_name,
         cur_realized_rows.profit_center_short_name,
         cur_realized_rows.cp_profile_id,
         cur_realized_rows.cp_name,
         cur_realized_rows.trade_user_id,
         cur_realized_rows.trade_user_name,
         cur_realized_rows.price_type_id,
         cur_realized_rows.price_type_name,
         cur_realized_rows.incoterm_id,
         cur_realized_rows.incoterm,
         cur_realized_rows.payment_term_id,
         cur_realized_rows.payment_term,
         cur_realized_rows.price_fixation_details,
         cur_realized_rows.price_fixation_status,
         cur_realized_rows.realized_type,
         cur_realized_rows.realized_date,
         cur_realized_rows.container_no,
         cur_realized_rows.item_qty,
         cur_realized_rows.qty_unit_id,
         cur_realized_rows.qty_unit,
         vn_contract_price,
         vc_price_unit_id,
         vc_price_unit_cur_id,
         vc_price_unit_cur_code,
         vc_price_unit_weight_unit_id,
         vc_price_unit_weight_unit,
         vn_price_unit_weight,
         vn_contract_value_in_price_cur,
         vc_price_cur_id,
         vc_price_cur_code,
         vn_contract_value_in_base_cur,
         vn_sc_in_base_cur / vn_qty_in_base_qty_unit_id, -- secondary_cost_per_unit,
         vn_product_premium_per_unit,
         vn_product_premium,
         vn_quality_premium_per_unit,
         vn_quality_premium,
         vn_sc_in_base_cur,
         vn_cog_net_sale_value,
         null, --realized_pnl,
         cur_realized_rows.prev_real_price,
         cur_realized_rows.prev_real_price_id,
         cur_realized_rows.prev_real_price_cur_id,
         cur_realized_rows.prev_real_price_cur_code,
         cur_realized_rows.prev_real_price_weight_unit_id,
         cur_realized_rows.prev_real_price_weight_unit,
         cur_realized_rows.prev_real_price_weight,
         cur_realized_rows.prev_real_qty,
         cur_realized_rows.prev_real_qty_id,
         cur_realized_rows.prev_real_qty_unit,
         cur_realized_rows.prev_cont_value_in_price_cur,
         cur_realized_rows.prev_contract_price_cur_id,
         cur_realized_rows.prev_contract_price_cur_code,
         cur_realized_rows.prev_real_contract_value,
         cur_realized_rows.prev_real_secondary_cost,
         cur_realized_rows.prev_real_cog_net_sale_value,
         cur_realized_rows.prev_real_pnl,
         cur_realized_rows.prev_product_premium_per_unit,
         cur_realized_rows.prev_product_premium,
         cur_realized_rows.prev_quality_premium_per_unit,
         cur_realized_rows.prev_quality_premium,
         cur_realized_rows.prev_secondary_cost_per_unit,
         null, -- change_in_pnl,
         null, -- cfx_price_cur_to_base_cur,
         cur_realized_rows.warehouse_id,
         cur_realized_rows.warehouse_name,
         cur_realized_rows.shed_id,
         cur_realized_rows.shed_name,
         cur_realized_rows.group_id,
         cur_realized_rows.group_name,
         cur_realized_rows.group_cur_id,
         cur_realized_rows.group_cur_code,
         cur_realized_rows.group_qty_unit_id,
         cur_realized_rows.group_qty_unit,
         vn_qty_in_base_qty_unit_id,
         cur_realized_rows.base_qty_unit_id,
         cur_realized_rows.base_qty_unit,
         cur_realized_rows.base_cur_id,
         cur_realized_rows.base_cur_code,
         cur_realized_rows.base_price_unit_id,
         cur_realized_rows.base_price_unit_name,
         cur_realized_rows.sales_profit_center_id,
         cur_realized_rows.sales_profit_center_name,
         cur_realized_rows.sales_profit_center_short_name,
         cur_realized_rows.sales_strategy_id,
         cur_realized_rows.sales_strategy_name,
         cur_realized_rows.sales_business_line_id,
         cur_realized_rows.sales_business_line_name,
         cur_realized_rows.sales_internal_gmr_ref_no,
         cur_realized_rows.sales_contract_ref_no,
         cur_realized_rows.origination_city_id,
         cur_realized_rows.origination_city_name,
         cur_realized_rows.origination_country_id,
         cur_realized_rows.origination_country_name,
         cur_realized_rows.destination_city_id,
         cur_realized_rows.destination_city_name,
         cur_realized_rows.destination_country_id,
         cur_realized_rows.destination_country_name,
         cur_realized_rows.pool_id,
         cur_realized_rows.strategy_id,
         cur_realized_rows.strategy_name,
         cur_realized_rows.business_line_id,
         cur_realized_rows.business_line_name,
         cur_realized_rows.bl_number,
         cur_realized_rows.bl_date,
         cur_realized_rows.seal_no,
         cur_realized_rows.mark_no,
         cur_realized_rows.warehouse_ref_no,
         cur_realized_rows.warehouse_receipt_no,
         cur_realized_rows.warehouse_receipt_date,
         cur_realized_rows.is_warrant,
         cur_realized_rows.warrant_no,
         cur_realized_rows.pcdi_id,
         cur_realized_rows.supp_contract_item_ref_no,
         cur_realized_rows.supplier_pcdi_id,
         cur_realized_rows.payable_returnable_type,
         cur_realized_rows.price_description,
         cur_realized_rows.delivery_item_no,
         vc_price_to_base_fw_rate,
         vc_contract_qp_fw_exch_rate,
         vc_contract_pp_fw_exch_rate,
         vc_sc_to_base_fw_rate,
         cur_realized_rows.p_price_to_base_fw_exch_rate,
         cur_realized_rows.p_contract_qp_fw_exch_rate,
         cur_realized_rows.p_contract_pp_fw_exch_rate,
         cur_realized_rows.p_accrual_to_base_fw_exch_rate);
    end loop;
    --
    -- Update Realized PNL Value
    --
    vc_error_msg := '21';
    for cur_update_pnl_rows in cur_update_pnl
    loop
      update prd_physical_realized_daily prd
         set prd.realized_pnl  = cur_update_pnl_rows.net_value,
             prd.change_in_pnl = cur_update_pnl_rows.net_value -
                                 prd.prev_real_pnl
       where prd.corporate_id = cur_update_pnl_rows.corporate_id
         and prd.contract_type = 'S'
         and prd.int_alloc_group_id =
             cur_update_pnl_rows.int_alloc_group_id
         and prd.sales_internal_gmr_ref_no =
             cur_update_pnl_rows.sales_internal_gmr_ref_no
         and prd.process_id = pc_process_id
         and prd.prev_real_pnl is not null;
      --
    -- Let it update the same row where Realized Today was updated 
    -- In Case Sales GMR has more than one record
    --
    end loop;
    vc_error_msg := '22';
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure sp_calc_phy_realize_pnl_change',
                                                           ' M2M-013',
                                                           ' Code:' ||
                                                           sqlcode ||
                                                           ' Message:' ||
                                                           sqlerrm ||
                                                           dbms_utility.format_error_backtrace ||
                                                           'No:' ||
                                                           vc_error_msg,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;
  procedure sp_calc_realized_not_fixed(pc_corporate_id varchar2,
                                       pd_trade_date   date,
                                       pc_process      varchar2,
                                       pc_process_id   varchar2,
                                       pc_user_id      varchar2) is
    cursor cur_not_fixed is
      select prd.corporate_id,
             prd.corporate_name,
             pc_process_id,
             prd.pcdi_id,
             prd.del_distribution_item_no,
             prd.internal_contract_ref_no,
             prd.contract_ref_no,
             prd.contract_issue_date,
             prd.internal_contract_item_ref_no,
             prd.contract_type,
             'Realized Not Final Invoiced' unrealized_type,
             prd.profit_center_id,
             prd.profit_center_name,
             prd.profit_center_short_name,
             prd.cp_profile_id cp_id,
             prd.cp_name,
             prd.trade_user_id,
             prd.trade_user_name,
             prd.product_id,
             prd.product_name,
             prd.item_qty,
             prd.qty_unit_id,
             prd.qty_unit,
             prd.quality_id,
             prd.quality_name,
             prd.product_name product_desc,
             prd.price_type_id,
             prd.price_type_name,
             prd.price_description price_string,
             null as delivery_period_string,
             null fixation_method,
             cipd.price_fixation_status price_fixation_status,
             prd.incoterm_id,
             prd.incoterm,
             prd.origination_city_id,
             prd.origination_city_name,
             prd.origination_country_id,
             prd.origination_country_name,
             prd.destination_city_id,
             prd.destination_city_name,
             prd.destination_country_id,
             prd.destination_country_name,
             prd.payment_term_id,
             prd.payment_term,
             prd.price_fixation_details,
             cipd.contract_price,
             cipd.price_unit_id,
             cipd.price_unit_cur_id,
             cipd.price_unit_cur_code,
             cipd.price_unit_weight_unit_id,
             cipd.price_unit_weight_unit,
             cipd.price_unit_weight,
             prd.base_cur_id,
             prd.base_cur_code,
             prd.realized_date,
             prd.contract_price realized_price,
             prd.price_unit_id realized_price_id,
             prd.price_unit_cur_id realized_price_cur_id,
             prd.price_unit_cur_code realized_price_cur_code,
             prd.price_unit_weight_unit_id realized_price_weight_unit,
             prd.price_unit_weight realized_price_weight,
             prd.item_qty as realized_qty,
             prd.qty_unit_id realized_qty_unit_id,
             prd.group_id,
             prd.group_name,
             prd.group_cur_id,
             prd.group_cur_code,
             prd.group_qty_unit_id,
             prd.group_qty_unit,
             prd.base_qty_unit_id,
             prd.base_qty_unit,
             prd.item_qty_in_base_qty_unit qty_in_base_unit,
             prd.strategy_id,
             prd.strategy_name,
             prd.internal_grd_ref_no as realized_internal_stock_ref_no,
             prd.sales_internal_gmr_ref_no,
             null sales_gmr_ref_no,
             prd.base_price_unit_id,
             prd.internal_grd_ref_no,
             prd.internal_gmr_ref_no,
             prd.delivery_item_no,
             prd.contract_invoice_value
        from prd_physical_realized_daily    prd,
             cipd_contract_item_price_daily cipd,
             agh_alloc_group_header         agh,
             gmr_goods_movement_record      gmr
       where (prd.sales_internal_gmr_ref_no, prd.int_alloc_group_id,
              prd.trade_date) in
             (select prd.sales_internal_gmr_ref_no,
                     prd.int_alloc_group_id,
                     max(prd.trade_date) trade_date
                from prd_physical_realized_daily prd,
                     tdc_trade_date_closure      tdc
               where prd.trade_date = tdc.trade_date
                 and tdc.process = pc_process
                 and prd.corporate_id = pc_corporate_id
                 and prd.realized_type in
                     ('Realized Today', 'Previously Realized PNL Change')
               group by prd.sales_internal_gmr_ref_no,
                        prd.int_alloc_group_id)
         and prd.internal_contract_item_ref_no =
             cipd.internal_contract_item_ref_no
         and cipd.process_id = pc_process_id
         and agh.int_alloc_group_id = prd.int_alloc_group_id
         and agh.process_id = pc_process_id
         and agh.is_deleted = 'N' -- Allocation is Active 
         and gmr.internal_gmr_ref_no = prd.sales_internal_gmr_ref_no
         and gmr.process_id = pc_process_id
         and nvl(gmr.is_final_invoiced, 'N') = 'N' -- As of today FI is not done
         and prd.contract_type = 'S'
         and cipd.price_basis <> 'Fixed'
      -- For Variable contracts only
      union
      select prd.corporate_id,
             prd.corporate_name,
             pc_process_id,
             prd.pcdi_id,
             prd.del_distribution_item_no,
             prd.internal_contract_ref_no,
             prd.contract_ref_no,
             prd.contract_issue_date,
             prd.internal_contract_item_ref_no,
             prd.contract_type,
             'Realized Not Final Invoiced' unrealized_type,
             prd.profit_center_id,
             prd.profit_center_name,
             prd.profit_center_short_name,
             prd.cp_profile_id cp_id,
             prd.cp_name,
             prd.trade_user_id,
             prd.trade_user_name,
             prd.product_id,
             prd.product_name,
             prd.item_qty,
             prd.qty_unit_id,
             prd.qty_unit,
             prd.quality_id,
             prd.quality_name,
             prd.product_name product_desc,
             prd.price_type_id,
             prd.price_type_name,
             prd.price_description price_string,
             null as delivery_period_string,
             null fixation_method,
             cipd.price_fixation_status price_fixation_status,
             prd.incoterm_id,
             prd.incoterm,
             prd.origination_city_id,
             prd.origination_city_name,
             prd.origination_country_id,
             prd.origination_country_name,
             prd.destination_city_id,
             prd.destination_city_name,
             prd.destination_country_id,
             prd.destination_country_name,
             prd.payment_term_id,
             prd.payment_term,
             prd.price_fixation_details,
             cipd.contract_price,
             cipd.price_unit_id,
             cipd.price_unit_cur_id,
             cipd.price_unit_cur_code,
             cipd.price_unit_weight_unit_id,
             cipd.price_unit_weight_unit,
             cipd.price_unit_weight,
             prd.base_cur_id,
             prd.base_cur_code,
             prd.realized_date,
             prd.contract_price realized_price,
             prd.price_unit_id realized_price_id,
             prd.price_unit_cur_id realized_price_cur_id,
             prd.price_unit_cur_code realized_price_cur_code,
             prd.price_unit_weight_unit_id realized_price_weight_unit,
             prd.price_unit_weight realized_price_weight,
             prd.item_qty as realized_qty,
             prd.qty_unit_id realized_qty_unit_id,
             prd.group_id,
             prd.group_name,
             prd.group_cur_id,
             prd.group_cur_code,
             prd.group_qty_unit_id,
             prd.group_qty_unit,
             prd.base_qty_unit_id,
             prd.base_qty_unit,
             prd.item_qty_in_base_qty_unit qty_in_base_unit,
             prd.strategy_id,
             prd.strategy_name,
             prd.internal_grd_ref_no as realized_internal_stock_ref_no,
             prd.sales_internal_gmr_ref_no,
             null sales_gmr_ref_no,
             prd.base_price_unit_id,
             prd.internal_grd_ref_no,
             prd.internal_gmr_ref_no,
             prd.delivery_item_no,
             prd.contract_invoice_value
      
        from prd_physical_realized_daily    prd,
             cipd_contract_item_price_daily cipd,
             agh_alloc_group_header         agh,
             gmr_goods_movement_record      gmr
       where (prd.sales_internal_gmr_ref_no, prd.int_alloc_group_id,
              prd.trade_date) in
             (select prd.sales_internal_gmr_ref_no,
                     prd.int_alloc_group_id,
                     max(prd.trade_date) trade_date
                from prd_physical_realized_daily prd,
                     tdc_trade_date_closure      tdc
               where prd.trade_date = tdc.trade_date
                 and tdc.process = pc_process
                 and prd.corporate_id = pc_corporate_id
                 and prd.realized_type in
                     ('Realized Today', 'Previously Realized PNL Change')
               group by prd.sales_internal_gmr_ref_no,
                        prd.int_alloc_group_id)
         and prd.internal_contract_item_ref_no =
             cipd.internal_contract_item_ref_no
         and cipd.process_id = pc_process_id
         and agh.int_alloc_group_id = prd.int_alloc_group_id
         and agh.process_id = pc_process_id
         and agh.is_deleted = 'N' -- Allocation is Active 
         and gmr.internal_gmr_ref_no = prd.internal_gmr_ref_no
         and gmr.process_id = pc_process_id
         and nvl(gmr.is_final_invoiced, 'N') = 'N' -- As of today FI is not done
         and prd.contract_type = 'P'
         and cipd.price_basis <> 'Fixed';
  
    vobj_error_log                 tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count             number := 1;
    vc_error_msg                   varchar2(10);
    vn_contract_value_in_price_cur number;
    vn_contract_value_in_base_cur  number;
    vc_price_cur_id                varchar2(15);
    vc_price_cur_code              varchar2(15);
    vn_cont_price_cur_id_factor    number;
    vn_cont_price_cur_decimals     number;
    vn_pnl_in_base_cur             number;
    vn_realized_amount_in_base_cur number;
    vn_prev_unr_pnl                number;
    vn_trade_day_pnl               number;
    vn_unreal_pnl_in_base_per_unit number;
    vn_price_to_base_fw_rate       number;
    vc_price_to_base_fw_rate       varchar2(100);
    vn_forward_points              number;
  begin
    vc_error_msg := '1';
    for cur_not_fixed_rows in cur_not_fixed
    loop
      --
      -- Calculate the Current contract value in Price Currency
      --
      pkg_general.sp_get_main_cur_detail(cur_not_fixed_rows.price_unit_cur_id,
                                         vc_price_cur_id,
                                         vc_price_cur_code,
                                         vn_cont_price_cur_id_factor,
                                         vn_cont_price_cur_decimals);
      vc_error_msg                   := '2';
      vn_contract_value_in_price_cur := (cur_not_fixed_rows.contract_price /
                                        nvl(cur_not_fixed_rows.price_unit_weight,
                                             1)) *
                                        (pkg_general.f_get_converted_quantity(cur_not_fixed_rows.product_id,
                                                                              cur_not_fixed_rows.realized_qty_unit_id,
                                                                              cur_not_fixed_rows.price_unit_weight_unit_id,
                                                                              cur_not_fixed_rows.realized_qty)) *
                                        vn_cont_price_cur_id_factor;
      vn_contract_value_in_price_cur := round(vn_contract_value_in_price_cur,
                                              vn_cont_price_cur_decimals);
      --
      -- Convert contract value in Price Currency to Base Currency
      --
      vc_error_msg := '3';
      pkg_general.sp_forward_cur_exchange_new(pc_corporate_id,
                                              pd_trade_date,
                                              pd_trade_date,
                                              vc_price_cur_id,
                                              cur_not_fixed_rows.base_cur_id,
                                              30,
                                              vn_price_to_base_fw_rate,
                                              vn_forward_points);
      if vc_price_cur_id <> cur_not_fixed_rows.base_cur_id then
        if vn_price_to_base_fw_rate is null or vn_price_to_base_fw_rate = 0 then
          vobj_error_log.extend;
          vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                               'procedure pkg_phy_physical_process-sp_calc_realized not fixed ',
                                                               'PHY-005',
                                                               cur_not_fixed_rows.base_cur_code ||
                                                               ' to ' ||
                                                               vc_price_cur_code || ' (' ||
                                                               to_char(pd_trade_date,
                                                                       'dd-Mon-yyyy') || ') ',
                                                               '',
                                                               gvc_process,
                                                               null, -- pc_user_id,
                                                               sysdate,
                                                               pd_trade_date);
          sp_insert_error_log(vobj_error_log);
        end if;
      end if;
    
      if vn_price_to_base_fw_rate <> 0 or vn_price_to_base_fw_rate <> 1 or
         vn_price_to_base_fw_rate is not null then
        vc_price_to_base_fw_rate := '1 ' || vc_price_cur_code || '=' ||
                                    vn_price_to_base_fw_rate || ' ' ||
                                    cur_not_fixed_rows.base_cur_code;
      end if;
      vn_contract_value_in_base_cur := round((vn_contract_value_in_price_cur *
                                             vn_price_to_base_fw_rate),
                                             2);
    
      --
      -- Value in Base Price Currency
      --
    
      vn_realized_amount_in_base_cur := cur_not_fixed_rows.contract_invoice_value;
    
      vc_error_msg := '4';
      --
      -- Calcualte the PNL in base
      --
    
      if cur_not_fixed_rows.contract_type = 'S' then
        vn_pnl_in_base_cur := vn_contract_value_in_base_cur -
                              vn_realized_amount_in_base_cur;
      else
        vn_pnl_in_base_cur := vn_realized_amount_in_base_cur -
                              vn_contract_value_in_base_cur;
      end if;
      vn_pnl_in_base_cur := round(vn_pnl_in_base_cur, 2);
      --
      -- Get the Previous Unrealized PNL
      --
      begin
        select poud_prev_day.unrealized_pnl_in_base_cur
          into vn_prev_unr_pnl
          from poud_phy_open_unreal_daily poud_prev_day
         where poud_prev_day.process_id = gvc_previous_process_id
           and poud_prev_day.unrealized_type =
               'Realized Not Final Invoiced'
           and corporate_id = pc_corporate_id
           and poud_prev_day.sales_internal_gmr_ref_no =
               cur_not_fixed_rows.sales_internal_gmr_ref_no
           and poud_prev_day.internal_contract_item_ref_no =
               cur_not_fixed_rows.internal_contract_item_ref_no
           and poud_prev_day.contract_type =
               cur_not_fixed_rows.contract_type
           and poud_prev_day.realized_internal_stock_ref_no =
               cur_not_fixed_rows.internal_grd_ref_no;
      exception
        when no_data_found then
          vn_prev_unr_pnl := 0;
      end;
    
      vc_error_msg                   := '5';
      vn_trade_day_pnl               := vn_pnl_in_base_cur -
                                        vn_prev_unr_pnl;
      vn_unreal_pnl_in_base_per_unit := vn_pnl_in_base_cur /
                                        cur_not_fixed_rows.qty_in_base_unit;
    
      vc_error_msg := '2';
      insert into poud_phy_open_unreal_daily
        (corporate_id,
         corporate_name,
         process_id,
         pcdi_id,
         delivery_item_no,
         prefix,
         middle_no,
         suffix,
         internal_contract_ref_no,
         contract_ref_no,
         contract_issue_date,
         internal_contract_item_ref_no,
         basis_type,
         delivery_period_type,
         delivery_from_month,
         delivery_from_year,
         delivery_to_month,
         delivery_to_year,
         delivery_from_date,
         delivery_to_date,
         transit_days,
         contract_type,
         approval_status,
         unrealized_type,
         profit_center_id,
         profit_center_name,
         profit_center_short_name,
         cp_profile_id,
         cp_name,
         trade_user_id,
         trade_user_name,
         product_id,
         product_name,
         item_qty,
         qty_unit_id,
         qty_unit,
         quality_id,
         quality_name,
         product_desc,
         price_type_id,
         price_type_name,
         price_string,
         item_delivery_period_string,
         fixation_method,
         price_fixation_status,
         incoterm_id,
         incoterm,
         origination_city_id,
         origination_city,
         origination_country_id,
         origination_country,
         destination_city_id,
         destination_city,
         destination_country_id,
         destination_country,
         origination_region_id,
         origination_region,
         destination_region_id,
         destination_region,
         payment_term_id,
         payment_term,
         price_fixation_details,
         contract_price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         price_unit_weight_unit_id,
         price_unit_weight,
         price_unit_weight_unit,
         net_m2m_price,
         m2m_price_unit_id,
         m2m_price_cur_id,
         m2m_price_cur_code,
         m2m_price_weight,
         m2m_price_weght_unit_id,
         m2m_price_weight_unit,
         contract_value_in_price_cur,
         contract_value_in_val_cur,
         price_main_cur_id,
         price_main_cur_code,
         valualtion_cur_id,
         valualtion_cur_code,
         m2m_amt,
         m2m_amt_cur_id,
         m2m_amt_cur_code,
         sc_in_valuation_cur,
         sc_in_base_cur,
         contract_premium_value,
         premium_cur_id,
         premium_cur_code,
         expected_cog_net_sale_value,
         unrealized_pnl_in_val_cur,
         unrealized_pnl_in_base_cur,
         prev_day_unr_pnl_in_val_cur,
         prev_day_unr_pnl_in_base_cur,
         trade_day_pnl_in_val_cur,
         trade_day_pnl_in_base_cur,
         base_cur_id,
         base_cur_code,
         expected_cog_in_val_cur,
         price_cur_to_val_cur_fx_rate,
         price_cur_to_base_cur_fx_rate,
         base_cur_to_val_cur_fx_rate,
         val_to_base_corp_fx_rate,
         spot_rate_val_cur_to_base_cur,
         unrealized_pnl_in_m2m_price_id,
         prev_unr_pnl_in_m2m_price_id,
         trade_day_pnl_in_m2m_price_id,
         realized_date,
         realized_price,
         realized_price_id,
         realized_price_cur_id,
         realized_price_cur_code,
         realized_price_weight,
         realized_price_weight_unit,
         realized_qty,
         realized_qty_id,
         realized_qty_unit,
         md_id,
         group_id,
         group_name,
         group_cur_id,
         group_cur_code,
         group_qty_unit_id,
         group_qty_unit,
         base_qty_unit_id,
         base_qty_unit,
         prev_item_qty,
         prev_qty_unit_id,
         cont_unr_status,
         unfxd_qty,
         fxd_qty,
         qty_in_base_unit,
         eod_trade_date,
         strategy_id,
         strategy_name,
         derivative_def_id,
         valuation_exchange_id,
         valuation_dr_id,
         valuation_dr_id_name,
         valuation_month,
         price_month,
         pay_in_cur_id,
         pay_in_cur_code,
         unreal_pnl_in_base_per_unit,
         unreal_pnl_in_val_cur_per_unit,
         realized_internal_stock_ref_no,
         sales_internal_gmr_ref_no,
         sales_gmr_ref_no,
         price_to_base_fw_exch_rate)
      values
        (pc_corporate_id,
         cur_not_fixed_rows.corporate_name,
         pc_process_id,
         cur_not_fixed_rows.pcdi_id,
         cur_not_fixed_rows.delivery_item_no,
         null, -- prefix
         null, -- middle_no
         null, -- suffix
         cur_not_fixed_rows.internal_contract_ref_no,
         cur_not_fixed_rows.contract_ref_no,
         cur_not_fixed_rows.contract_issue_date,
         cur_not_fixed_rows.internal_contract_item_ref_no,
         null, --basis_type
         null, --delivery_period_type
         null, --delivery_from_month
         null, --delivery_from_year
         null, --delivery_to_month
         null, --delivery_to_year
         null, --delivery_from_date
         null, --delivery_to_date
         null, --transit_days
         cur_not_fixed_rows.contract_type,
         null, --approval_status
         cur_not_fixed_rows.unrealized_type,
         cur_not_fixed_rows.profit_center_id,
         cur_not_fixed_rows.profit_center_name,
         cur_not_fixed_rows.profit_center_short_name,
         cur_not_fixed_rows.cp_id,
         cur_not_fixed_rows.cp_name,
         cur_not_fixed_rows.trade_user_id,
         cur_not_fixed_rows.trade_user_name,
         cur_not_fixed_rows.product_id,
         cur_not_fixed_rows.product_name,
         cur_not_fixed_rows.item_qty,
         cur_not_fixed_rows.qty_unit_id,
         cur_not_fixed_rows.qty_unit,
         cur_not_fixed_rows.quality_id,
         cur_not_fixed_rows.quality_name,
         cur_not_fixed_rows.product_desc,
         cur_not_fixed_rows.price_type_id,
         cur_not_fixed_rows.price_type_name,
         null, -- price_string
         null, -- item_delivery_period_string
         null, -- fixation_method
         null, -- price_fixation_status
         cur_not_fixed_rows.incoterm_id,
         cur_not_fixed_rows.incoterm,
         cur_not_fixed_rows.origination_city_id,
         cur_not_fixed_rows.origination_city_name,
         cur_not_fixed_rows.origination_country_id,
         cur_not_fixed_rows.origination_country_name,
         cur_not_fixed_rows.destination_city_id,
         cur_not_fixed_rows.destination_city_name,
         cur_not_fixed_rows.destination_country_id,
         cur_not_fixed_rows.destination_country_name,
         null, --origination_region_id
         null, --origination_region
         null, --destination_region_id
         null, --destination_region
         cur_not_fixed_rows.payment_term_id,
         cur_not_fixed_rows.payment_term,
         cur_not_fixed_rows.price_fixation_details,
         cur_not_fixed_rows.contract_price,
         cur_not_fixed_rows.price_unit_id,
         cur_not_fixed_rows.price_unit_cur_id,
         cur_not_fixed_rows.price_unit_cur_code,
         cur_not_fixed_rows.price_unit_weight_unit_id,
         cur_not_fixed_rows.price_unit_weight,
         cur_not_fixed_rows.price_unit_weight_unit,
         null, -- net_m2m_price
         null, -- m2m_price_unit_id
         null, -- m2m_price_cur_id
         null, -- m2m_price_cur_code
         null, -- m2m_price_weight
         null, -- m2m_price_weght_unit_id
         null, -- m2m_price_weight_unit
         vn_contract_value_in_price_cur, --contract_value_in_price_cur
         vn_contract_value_in_base_cur, --contract_value_in_val_cur
         cur_not_fixed_rows.price_unit_cur_id,
         cur_not_fixed_rows.price_unit_cur_code,
         null, --valualtion_cur_id
         null, --valualtion_cur_code
         null, --m2m_amt
         null, --2m_amt_cur_id
         null, --m2m_amt_cur_code
         null, --sc_in_valuation_cur
         null, --sc_in_base_cur
         null, --contract_premium_value
         null, --premium_cur_id
         null, -- premium_cur_code
         null, --expected_cog_net_sale_value
         vn_pnl_in_base_cur, -- unrealized_pnl_in_val_cur
         vn_pnl_in_base_cur, -- unrealized_pnl_in_base_cur
         vn_prev_unr_pnl, -- prev_day_unr_pnl_in_val_cur
         vn_prev_unr_pnl, -- prev_day_unr_pnl_in_base_cur
         vn_trade_day_pnl, -- trade_day_pnl_in_val_cur
         vn_trade_day_pnl, -- trade_day_pnl_in_base_cur
         cur_not_fixed_rows.base_cur_id,
         cur_not_fixed_rows.base_cur_code,
         null, -- expected_cog_in_val_cur
         null, -- price_cur_to_val_cur_fx_rate
         null, -- price_cur_to_base_cur_fx_rate
         null, -- base_cur_to_val_cur_fx_rate
         null, -- val_to_base_corp_fx_rate
         null, -- spot_rate_val_cur_to_base_cur
         null, -- unrealized_pnl_in_m2m_price_id
         null, -- prev_unr_pnl_in_m2m_price_id
         null, -- trade_day_pnl_in_m2m_price_id
         cur_not_fixed_rows.realized_date,
         cur_not_fixed_rows.realized_price,
         cur_not_fixed_rows.realized_price_id,
         cur_not_fixed_rows.realized_price_cur_id,
         cur_not_fixed_rows.realized_price_cur_code,
         cur_not_fixed_rows.realized_price_weight,
         cur_not_fixed_rows.realized_price_weight_unit,
         cur_not_fixed_rows.realized_qty,
         cur_not_fixed_rows.realized_qty_unit_id,
         cur_not_fixed_rows.realized_qty_unit_id, -- realized_qty_unit,
         null, -- md_id
         cur_not_fixed_rows.group_id,
         cur_not_fixed_rows.group_name,
         cur_not_fixed_rows.group_cur_id,
         cur_not_fixed_rows.group_cur_code,
         cur_not_fixed_rows.group_qty_unit_id,
         cur_not_fixed_rows.group_qty_unit,
         cur_not_fixed_rows.base_qty_unit_id,
         cur_not_fixed_rows.base_qty_unit,
         null, -- prev_item_qty
         null, -- prev_qty_unit_id
         null, -- cont_unr_status 
         null, -- unfxd_qty
         null, -- fxd_qty
         cur_not_fixed_rows.qty_in_base_unit, -- qty_in_base_unit
         pd_trade_date, --eod_trade_date,
         cur_not_fixed_rows.strategy_id,
         cur_not_fixed_rows.strategy_name,
         null, --derivative_def_id
         null, --valuation_exchange_id
         null, --valuation_dr_id
         null, --valuation_dr_id_name
         null, --valuation_month
         null, --price_month
         null, --pay_in_cur_id
         null, --pay_in_cur_code
         vn_unreal_pnl_in_base_per_unit, --unreal_pnl_in_base_per_unit
         vn_unreal_pnl_in_base_per_unit, --unreal_pnl_in_val_cur_per_unit
         cur_not_fixed_rows.internal_grd_ref_no, --realized_internal_stock_ref_no
         cur_not_fixed_rows.sales_internal_gmr_ref_no,
         cur_not_fixed_rows.sales_gmr_ref_no,
         vc_price_to_base_fw_rate);
    end loop;
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure sp_calc_realized_not_fixed Realized Today',
                                                           ' M2M-013',
                                                           'Code:' ||
                                                           sqlcode ||
                                                           'Message:' ||
                                                           sqlerrm ||
                                                           dbms_utility.format_error_backtrace ||
                                                           'No ' ||
                                                           vc_error_msg,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
  end;
  procedure sp_populate_price_conversion(pc_corporate_id varchar2,
                                         pd_trade_date   date) is
    cursor cur_price_units_out is
      select ppu.internal_price_unit_id price_unit_id
        from ppu_product_price_units ppu;
    cursor cur_price_units_in is
      select ppu.internal_price_unit_id price_unit_id
        from ppu_product_price_units ppu;
    vn_conv_factor number;
  begin
    delete from pc_price_conversion where corporate_id = pc_corporate_id;
    for cur_price_units_out_rows in cur_price_units_out
    loop
      for cur_price_units_in_rows in cur_price_units_in
      loop
        vn_conv_factor := pkg_phy_pre_check_process.f_get_converted_price(pc_corporate_id,
                                                                          1,
                                                                          cur_price_units_out_rows.price_unit_id,
                                                                          cur_price_units_in_rows.price_unit_id,
                                                                          pd_trade_date);
        insert into pc_price_conversion
          (corporate_id, from_price_unit_id, to_price_unit_id, conv_factor)
        values
          (pc_corporate_id,
           cur_price_units_out_rows.price_unit_id,
           cur_price_units_in_rows.price_unit_id,
           vn_conv_factor);
      end loop;
    end loop;
  end;

  procedure sp_calc_invm_cog(pc_corporate_id varchar2,
                             pc_process_id   varchar2,
                             pc_user_id      varchar2,
                             pd_trade_date   date) is
    vobj_error_log                tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count            number := 1;
    vc_error_msg                  varchar2(5) := '0';
    vn_qty_conv_price_to_stock    number;
    vn_qty_conv_stock_to_base     number;
    vn_fw_exch_rate_trans_to_base number;
    vn_forward_points             number;
    vc_exch_rate_string           varchar2(25);
  begin
  
    insert into tinvp_temp_invm_cog
      (corporate_id,
       process_id,
       internal_cost_id,
       cost_type,
       internal_grd_ref_no,
       product_id,
       base_qty_unit_id,
       base_qty_unit,
       grd_current_qty,
       grd_qty_unit_id,
       cost_value,
       transformation_ratio,
       transaction_price_unit_id,
       transaction_cur_factor,
       transaction_amt_cur_id,
       transaction_amt_main_cur_id,
       base_cur_id,
       base_cur_code,
       base_price_unit_id,
       price_qty_unit_id,
       price_weight,
       price_to_stock_wt_conversion,
       stock_to_base_wt_conversion,
       transact_to_base_fw_exch_rate,
       base_price_unit_id_in_ppu)
      select pc_corporate_id,
             pc_process_id,
             cs.internal_cost_id,
             case
               when scms.cost_display_name = 'Material Cost' then
                'Price'
               when scms.cost_display_name = 'Location Premium' then
                'Location Premium'
               when scms.cost_display_name = 'Quality Premium' then
                'Quality Premium'
               else
                'Secondary Cost'
             end cost_type,
             grd.internal_grd_ref_no,
             grd.product_id,
             pum_base.weight_unit_id,
             qum.qty_unit,
             grd.current_qty,
             grd.qty_unit_id,
             cs.cost_value,
             scm.transformation_ratio,
             cs.transaction_price_unit_id,
             nvl(scd.factor, 1),
             cs.transaction_amt_cur_id,
             nvl(scd.cur_id, cs.transaction_amt_cur_id),
             akc.base_cur_id,
             cm.cur_code,
             pum_base.price_unit_id as base_price_unit_id,
             pum_trans.weight_unit_id as price_weight_unit_id,
             nvl(pum_trans.weight, 1),
             1,
             1,
             1,
             ppu.product_price_unit_id
        from scm_stock_cost_mapping      scm,
             grd_goods_record_detail     grd,
             cigc_contract_item_gmr_cost cigc,
             cs_cost_store               cs,
             cpm_corporateproductmaster  cpm,
             scm_service_charge_master   scms,
             pdm_productmaster           pdm,
             ak_corporate                akc,
             pum_price_unit_master       pum_base,
             scd_sub_currency_detail     scd,
             pum_price_unit_master       pum_trans,
             invm_inventory_master       invm,
             v_ppu_pum                   ppu,
             qum_quantity_unit_master    qum,
             cm_currency_master          cm
       where scm.internal_grd_ref_no = grd.internal_grd_ref_no
         and scm.cog_ref_no = cigc.cog_ref_no
         and cigc.cog_ref_no = cs.cog_ref_no
         and cpm.product_id = grd.product_id
         and cs.cost_component_id = scms.cost_id
         and (scms.cost_display_name in
             ('Material Cost', 'Location Premium', 'Quality Premium') or
             scms.cost_type = 'SECONDARY_COST')
         and cs.cost_type = 'Accrual'
         and cs.cost_ref_no not in
             (select cs_in.cost_ref_no
                from cs_cost_store cs_in
               where cs_in.cost_type = 'Actual'
                 and cs_in.is_deleted = 'N')
         and cpm.corporate_id = pc_corporate_id
         and cs.is_deleted = 'N'
         and cigc.is_deleted = 'N'
         and scm.is_deleted = 'N'
         and grd.is_deleted = 'N'
         and grd.product_id = pdm.product_id
         and cpm.corporate_id = akc.corporate_id
         and pum_base.cur_id = akc.base_cur_id
         and pum_base.weight_unit_id = pdm.base_quantity_unit
         and pum_base.is_active = 'Y'
         and pum_base.is_deleted = 'N'
         and cs.transaction_amt_cur_id = scd.sub_cur_id(+)
         and grd.process_id = pc_process_id
         and cs.process_id = pc_process_id
         and cigc.process_id = pc_process_id
         and cs.transaction_price_unit_id = pum_trans.price_unit_id
         and pum_trans.is_active = 'Y'
         and pum_trans.is_deleted = 'N'
         and grd.current_qty <> 0
         and invm.internal_grd_ref_no = grd.internal_grd_ref_no
         and invm.process_id = pc_process_id
         and ppu.price_unit_id = pum_base.price_unit_id
         and ppu.product_id = grd.product_id
         and invm.is_active = 'Y'
         and pum_base.weight_unit_id = qum.qty_unit_id
         and akc.base_cur_id = cm.cur_id
      union all
      select pc_corporate_id,
             pc_process_id,
             cs.internal_cost_id,
             case
               when scms.cost_display_name = 'Material Cost' then
                'Price'
               when scms.cost_display_name = 'Location Premium' then
                'Location Premium'
               when scms.cost_display_name = 'Quality Premium' then
                'Quality Premium'
               else
                'Secondary Cost'
             end cost_type,
             grd.internal_grd_ref_no,
             grd.product_id,
             pum_base.weight_unit_id,
             qum.qty_unit,
             grd.current_qty,
             grd.qty_unit_id,
             cs.cost_value,
             scm.transformation_ratio,
             cs.transaction_price_unit_id,
             nvl(scd.factor, 1),
             cs.transaction_amt_cur_id,
             nvl(scd.cur_id, cs.transaction_amt_cur_id),
             akc.base_cur_id,
             cm.cur_code,
             pum_base.price_unit_id as base_price_unit_id,
             pum_trans.weight_unit_id as price_weight_unit_id,
             nvl(pum_trans.weight, 1),
             1,
             1,
             1,
             ppu.product_price_unit_id
        from scm_stock_cost_mapping      scm,
             grd_goods_record_detail     grd,
             cigc_contract_item_gmr_cost cigc,
             cs_cost_store               cs,
             cpm_corporateproductmaster  cpm,
             scm_service_charge_master   scms,
             pdm_productmaster           pdm,
             ak_corporate                akc,
             pum_price_unit_master       pum_base,
             scd_sub_currency_detail     scd,
             pum_price_unit_master       pum_trans,
             invm_inventory_master       invm,
             v_ppu_pum                   ppu,
             qum_quantity_unit_master    qum,
             cm_currency_master          cm
       where scm.internal_grd_ref_no = grd.internal_grd_ref_no
         and scm.cog_ref_no = cigc.cog_ref_no
         and cigc.cog_ref_no = cs.cog_ref_no
         and cpm.product_id = grd.product_id
         and cs.cost_component_id = scms.cost_id
         and (scms.cost_display_name in
             ('Material Cost', 'Location Premium', 'Quality Premium') or
             scms.cost_type = 'SECONDARY_COST')
         and cs.cost_type = 'Actual'
         and cs.is_deleted = 'N'
         and cpm.corporate_id = pc_corporate_id
         and cigc.is_deleted = 'N'
         and scm.is_deleted = 'N'
         and grd.is_deleted = 'N'
         and grd.product_id = pdm.product_id
         and cpm.corporate_id = akc.corporate_id
         and pum_base.cur_id = akc.base_cur_id
         and pum_base.weight_unit_id = pdm.base_quantity_unit
         and pum_base.is_active = 'Y'
         and pum_base.is_deleted = 'N'
         and cs.transaction_amt_cur_id = scd.sub_cur_id(+)
         and grd.process_id = pc_process_id
         and cs.process_id = pc_process_id
         and cigc.process_id = pc_process_id
         and cs.transaction_price_unit_id = pum_trans.price_unit_id
         and pum_trans.is_active = 'Y'
         and pum_trans.is_deleted = 'N'
         and grd.current_qty <> 0
         and invm.internal_grd_ref_no = grd.internal_grd_ref_no
         and invm.process_id = pc_process_id
         and ppu.price_unit_id = pum_base.price_unit_id
         and ppu.product_id = grd.product_id
         and invm.is_active = 'Y'
         and pum_base.weight_unit_id = qum.qty_unit_id
         and akc.base_cur_id = cm.cur_id;
    --
    -- Quantity Conversion from Price Weight Unit to Stock Weight Unit
    --         
    for cur_conv1 in (select t.product_id,
                             t.price_qty_unit_id,
                             t.grd_qty_unit_id
                        from tinvp_temp_invm_cog t
                       where t.process_id = pc_process_id
                         and t.price_qty_unit_id <> t.grd_qty_unit_id
                       group by t.price_qty_unit_id,
                                t.grd_qty_unit_id,
                                t.product_id)
    loop
      select pkg_general.f_get_converted_quantity(cur_conv1.product_id,
                                                  cur_conv1.price_qty_unit_id,
                                                  cur_conv1.grd_qty_unit_id,
                                                  1)
        into vn_qty_conv_price_to_stock
        from dual;
      update tinvp_temp_invm_cog t
         set t.price_to_stock_wt_conversion = vn_qty_conv_price_to_stock
       where t.price_qty_unit_id = cur_conv1.price_qty_unit_id
         and t.grd_qty_unit_id = cur_conv1.grd_qty_unit_id
         and t.product_id = cur_conv1.product_id
         and t.process_id = pc_process_id;
    end loop;
    --
    -- Quantity Conversion from Stock Weight Unit to Product Base Unit
    --
    for cur_conv2 in (select t.product_id,
                             t.grd_qty_unit_id,
                             t.base_qty_unit_id
                        from tinvp_temp_invm_cog t
                       where t.grd_qty_unit_id <> t.base_qty_unit_id
                         and t.process_id = pc_process_id
                       group by t.product_id,
                                t.grd_qty_unit_id,
                                t.base_qty_unit_id)
    loop
      select pkg_general.f_get_converted_quantity(cur_conv2.product_id,
                                                  cur_conv2.grd_qty_unit_id,
                                                  cur_conv2.base_qty_unit_id,
                                                  1)
        into vn_qty_conv_stock_to_base
        from dual;
      update tinvp_temp_invm_cog t
         set t.price_to_stock_wt_conversion = vn_qty_conv_stock_to_base
       where t.base_qty_unit_id = cur_conv2.base_qty_unit_id
         and t.grd_qty_unit_id = cur_conv2.grd_qty_unit_id
         and t.product_id = cur_conv2.product_id
         and t.process_id = pc_process_id;
    end loop;
    --
    -- Value in Transaction Currency
    --    
    update tinvp_temp_invm_cog t
       set t.value_in_transact_currency = t.cost_value *
                                          t.transaction_cur_factor *
                                          t.price_to_stock_wt_conversion *
                                          t.grd_current_qty *
                                          t.transformation_ratio /
                                          t.price_weight
     where t.process_id = pc_process_id;
  
    --
    -- Get the Exchange Rate from Transaction Main Currency to Base Currency
    --
    for cur_exch_rate in (select t.transaction_amt_main_cur_id,
                                 t.base_cur_id,
                                 cm_base.cur_code base_cur_code,
                                 cm_trans.cur_code transaction_amt_main_cur_code
                            from tinvp_temp_invm_cog t,
                                 cm_currency_master  cm_trans,
                                 cm_currency_master  cm_base
                           where t.transaction_amt_main_cur_id <>
                                 t.base_cur_id
                             and t.process_id = pc_process_id
                             and t.transaction_amt_main_cur_id =
                                 cm_trans.cur_id
                             and t.base_cur_id = cm_base.cur_id
                           group by t.transaction_amt_main_cur_id,
                                    t.base_cur_id,
                                    cm_base.cur_code,
                                    cm_trans.cur_code)
    loop
      pkg_general.sp_forward_cur_exchange_new(pc_corporate_id,
                                              pd_trade_date,
                                              pd_trade_date,
                                              cur_exch_rate.transaction_amt_main_cur_id,
                                              cur_exch_rate.base_cur_id,
                                              30,
                                              vn_fw_exch_rate_trans_to_base,
                                              vn_forward_points);
    
      if vn_fw_exch_rate_trans_to_base is null or
         vn_fw_exch_rate_trans_to_base = 0 then
        vc_error_msg := '3';
        vobj_error_log.extend;
        vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                             'procedure pkg_phy_physical_process-sp cog',
                                                             'PHY-005',
                                                             cur_exch_rate.base_cur_code ||
                                                             ' to ' ||
                                                             cur_exch_rate.transaction_amt_main_cur_code || ' (' ||
                                                             to_char(pd_trade_date,
                                                                     'dd-Mon-yyyy') || ') ',
                                                             '',
                                                             gvc_process,
                                                             pc_user_id,
                                                             sysdate,
                                                             pd_trade_date);
        sp_insert_error_log(vobj_error_log);
      
      else
        vc_error_msg        := '4';
        vc_exch_rate_string := '1 ' ||
                               cur_exch_rate.transaction_amt_main_cur_code || '=' ||
                               vn_fw_exch_rate_trans_to_base || ' ' ||
                               cur_exch_rate.base_cur_code;
        update tinvp_temp_invm_cog t
           set t.transact_to_base_fw_exch_rate = vn_fw_exch_rate_trans_to_base,
               trans_to_base_fw_exch_rate      = vc_exch_rate_string
         where t.transaction_amt_main_cur_id =
               cur_exch_rate.transaction_amt_main_cur_id
           and t.base_cur_id = cur_exch_rate.base_cur_id
           and t.process_id = pc_process_id;
      end if;
    
    end loop;
  
    --
    -- Update Value in Base and Avg Cost in Base Price Unit
    --
  
    update tinvp_temp_invm_cog t
       set t.value_in_base_currency = t.value_in_transact_currency *
                                      t.transact_to_base_fw_exch_rate,
           t.avg_cost               = (t.value_in_transact_currency *
                                      t.transact_to_base_fw_exch_rate) /
                                      (t.stock_to_base_wt_conversion *
                                      t.grd_current_qty)
     where t.process_id = pc_process_id;
    --
    -- All calculations done and ready with data into invm_cog
    --
    insert into invm_cog
      (process_id,
       internal_grd_ref_no,
       material_cost_per_unit,
       secondary_cost_per_unit,
       product_premium_per_unit,
       quality_premium_per_unit,
       price_to_base_fw_exch_rate_act,
       price_to_base_fw_exch_rate,
       contract_qp_fw_exch_rate,
       contract_pp_fw_exch_rate,
       accrual_to_base_fw_exch_rate,
       price_unit_id,
       price_unit_cur_id,
       price_unit_cur_code,
       price_unit_weight_unit_id,
       price_unit_weight_unit,
       price_unit_weight)
      select pc_process_id,
             internal_grd_ref_no,
             sum(material_cost_per_unit),
             nvl(sum(secondary_cost_per_unit), 0),
             nvl(sum(product_premium_per_unit), 0),
             nvl(sum(quality_premium_per_unit), 0),
             min(price_to_base_fw_exch_rate_act),
             f_string_aggregate(price_to_base_fw_exch_rate),
             f_string_aggregate(contract_qp_fw_exch_rate),
             f_string_aggregate(contract_pp_fw_exch_rate),
             f_string_aggregate(accrual_to_base_fw_exch_rate),
             price_unit_id,
             price_unit_cur_id,
             price_unit_cur_code,
             price_unit_weight_unit_id,
             price_unit_weight_unit,
             weight
        from (select t.internal_grd_ref_no,
                     case
                       when t.cost_type = 'Price' then
                        t.avg_cost
                       else
                        0
                     end as material_cost_per_unit,
                     case
                       when t.cost_type = 'Price' then
                        t.transact_to_base_fw_exch_rate
                       else
                        null
                     end as price_to_base_fw_exch_rate_act,
                     case
                       when t.cost_type = 'Price' then
                        t.trans_to_base_fw_exch_rate
                       else
                        null
                     end as price_to_base_fw_exch_rate,
                     case
                       when t.cost_type = 'Location Premium' then
                        t.avg_cost
                       else
                        0
                     end as product_premium_per_unit,
                     case
                       when t.cost_type = 'Location Premium' then
                        t.trans_to_base_fw_exch_rate
                       else
                        null
                     end as contract_pp_fw_exch_rate,
                     
                     case
                       when t.cost_type = 'Quality Premium' then
                        t.avg_cost
                       else
                        0
                     end as quality_premium_per_unit,
                     case
                       when t.cost_type = 'Quality Premium' then
                        t.trans_to_base_fw_exch_rate
                       else
                        null
                     end as contract_qp_fw_exch_rate,
                     case
                       when t.cost_type = 'Secondary Cost' then
                        t.avg_cost
                       else
                        0
                     end as secondary_cost_per_unit,
                     case
                       when t.cost_type = 'Secondary Cost' then
                        t.trans_to_base_fw_exch_rate
                       else
                        null
                     end as accrual_to_base_fw_exch_rate,
                     base_price_unit_id_in_ppu price_unit_id,
                     base_cur_id price_unit_cur_id,
                     base_cur_code price_unit_cur_code,
                     base_qty_unit_id price_unit_weight_unit_id,
                     base_qty_unit price_unit_weight_unit,
                     1 weight
                from tinvp_temp_invm_cog t
               where t.process_id = pc_process_id) t
       group by internal_grd_ref_no,
                price_unit_id,
                price_unit_cur_id,
                price_unit_cur_code,
                price_unit_weight_unit_id,
                price_unit_weight_unit,
                weight;
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure pkg_phy_physical_process sp_calc_invm_cog',
                                                           'M2M-013',
                                                           'Code:' ||
                                                           sqlcode ||
                                                           'Message:' ||
                                                           sqlerrm ||
                                                           dbms_utility.format_error_backtrace ||
                                                           'No ' ||
                                                           vc_error_msg,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
    
  end;

  procedure sp_calc_invm_cogs(pc_corporate_id varchar2,
                              pc_process_id   varchar2,
                              pc_user_id      varchar2,
                              pd_trade_date   date) is
    vobj_error_log                tableofpelerrorlog := tableofpelerrorlog();
    vn_eel_error_count            number := 1;
    vc_error_msg                  varchar2(5) := '0';
    vn_qty_conv_price_to_stock    number;
    vn_qty_conv_stock_to_base     number;
    vn_fw_exch_rate_trans_to_base number;
    vn_forward_points             number;
    vc_exch_rate_string           varchar2(25);
  begin
  
    insert into tinvs_temp_invm_cogs
      (corporate_id,
       process_id,
       internal_cost_id,
       cost_type,
       internal_grd_ref_no,
       sales_internal_gmr_ref_no,
       product_id,
       base_qty_unit_id,
       base_qty_unit,
       grd_current_qty,
       grd_qty_unit_id,
       cost_value,
       transformation_ratio,
       transaction_price_unit_id,
       transaction_cur_factor,
       transaction_amt_cur_id,
       transaction_amt_main_cur_id,
       base_cur_id,
       base_cur_code,
       base_price_unit_id,
       price_qty_unit_id,
       price_weight,
       price_to_stock_wt_conversion,
       stock_to_base_wt_conversion,
       transact_to_base_fw_exch_rate,
       base_price_unit_id_in_ppu)
      select pc_corporate_id,
             pc_process_id,
             cs.internal_cost_id,
             case
               when scms.cost_display_name = 'Material Cost' then
                'Price'
               when scms.cost_display_name = 'Location Premium' then
                'Location Premium'
               when scms.cost_display_name = 'Quality Premium' then
                'Quality Premium'
               else
                'Secondary Cost'
             end cost_type,
             grd.internal_grd_ref_no,
             invm.sales_internal_gmr_ref_no,
             grd.product_id,
             pum_base.weight_unit_id,
             qum.qty_unit,
             invm.stock_qty,
             grd.qty_unit_id,
             cs.cost_value,
             scm.transformation_ratio,
             cs.transaction_price_unit_id,
             nvl(scd.factor, 1),
             cs.transaction_amt_cur_id,
             nvl(scd.cur_id, cs.transaction_amt_cur_id),
             akc.base_cur_id,
             cm.cur_code,
             pum_base.price_unit_id as base_price_unit_id,
             pum_trans.weight_unit_id as price_weight_unit_id,
             nvl(pum_trans.weight, 1),
             1,
             1,
             1,
             ppu.product_price_unit_id
        from scm_stock_cost_mapping      scm,
             invs_inventory_sales        invm,
             dgrd_delivered_grd          dgrd,
             agh_alloc_group_header      agh,
             agd_alloc_group_detail      agd,
             grd_goods_record_detail     grd,
             cigc_contract_item_gmr_cost cigc,
             cs_cost_store               cs,
             cpm_corporateproductmaster  cpm,
             scm_service_charge_master   scms,
             pdm_productmaster           pdm,
             ak_corporate                akc,
             pum_price_unit_master       pum_base,
             scd_sub_currency_detail     scd,
             pum_price_unit_master       pum_trans,
             v_ppu_pum                   ppu,
             qum_quantity_unit_master    qum,
             cm_currency_master          cm
      
       where invm.internal_dgrd_ref_no = scm.internal_dgrd_ref_no
         and invm.process_id = pc_process_id
         and invm.internal_dgrd_ref_no = dgrd.internal_dgrd_ref_no
         and dgrd.int_alloc_group_id = agh.int_alloc_group_id
         and agh.int_alloc_group_id = agd.int_alloc_group_id
         and agd.internal_stock_ref_no = grd.internal_grd_ref_no
         and dgrd.process_id = pc_process_id
         and agh.process_id = pc_process_id
         and agd.process_id = pc_process_id
         and scm.cog_ref_no = cigc.cog_ref_no
         and cigc.cog_ref_no = cs.cog_ref_no
         and cpm.product_id = grd.product_id
         and cs.cost_component_id = scms.cost_id
         and (scms.cost_display_name in
             ('Material Cost', 'Location Premium', 'Quality Premium') or
             scms.cost_type = 'SECONDARY_COST')
         and cs.cost_type = 'Accrual'
         and cs.cost_ref_no not in
             (select cs_in.cost_ref_no
                from cs_cost_store cs_in
               where cs_in.cost_type = 'Actual'
                 and cs_in.is_deleted = 'N')
         and cpm.corporate_id = pc_corporate_id
         and cs.is_deleted = 'N'
         and cigc.is_deleted = 'N'
         and scm.is_deleted = 'N'
         and grd.is_deleted = 'N'
         and grd.product_id = pdm.product_id
         and cpm.corporate_id = akc.corporate_id
         and pum_base.cur_id = akc.base_cur_id
         and pum_base.weight_unit_id = pdm.base_quantity_unit
         and pum_base.is_active = 'Y'
         and pum_base.is_deleted = 'N'
         and cs.transaction_amt_cur_id = scd.sub_cur_id(+)
         and grd.process_id = pc_process_id
         and cs.process_id = pc_process_id
         and cigc.process_id = pc_process_id
         and cs.transaction_price_unit_id = pum_trans.price_unit_id
         and pum_trans.is_active = 'Y'
         and pum_trans.is_deleted = 'N'
         and ppu.price_unit_id = pum_base.price_unit_id
         and ppu.product_id = grd.product_id
         and pum_base.weight_unit_id = qum.qty_unit_id
         and akc.base_cur_id = cm.cur_id
         and invm.is_active = 'Y'
      union all
      select pc_corporate_id,
             pc_process_id,
             cs.internal_cost_id,
             case
               when scms.cost_display_name = 'Material Cost' then
                'Price'
               when scms.cost_display_name = 'Location Premium' then
                'Location Premium'
               when scms.cost_display_name = 'Quality Premium' then
                'Quality Premium'
               else
                'Secondary Cost'
             end cost_type,
             grd.internal_grd_ref_no,
             invm.sales_internal_gmr_ref_no,
             grd.product_id,
             pum_base.weight_unit_id,
             qum.qty_unit,
             invm.stock_qty,
             grd.qty_unit_id,
             cs.cost_value,
             scm.transformation_ratio,
             cs.transaction_price_unit_id,
             nvl(scd.factor, 1),
             cs.transaction_amt_cur_id,
             nvl(scd.cur_id, cs.transaction_amt_cur_id),
             akc.base_cur_id,
             cm.cur_code,
             pum_base.price_unit_id as base_price_unit_id,
             pum_trans.weight_unit_id as price_weight_unit_id,
             nvl(pum_trans.weight, 1),
             1,
             1,
             1,
             ppu.product_price_unit_id
        from scm_stock_cost_mapping      scm,
             invs_inventory_sales        invm,
             dgrd_delivered_grd          dgrd,
             agh_alloc_group_header      agh,
             agd_alloc_group_detail      agd,
             grd_goods_record_detail     grd,
             cigc_contract_item_gmr_cost cigc,
             cs_cost_store               cs,
             cpm_corporateproductmaster  cpm,
             scm_service_charge_master   scms,
             pdm_productmaster           pdm,
             ak_corporate                akc,
             pum_price_unit_master       pum_base,
             scd_sub_currency_detail     scd,
             pum_price_unit_master       pum_trans,
             v_ppu_pum                   ppu,
             qum_quantity_unit_master    qum,
             cm_currency_master          cm
       where invm.process_id = pc_process_id
         and invm.internal_dgrd_ref_no = scm.internal_dgrd_ref_no
         and invm.process_id = pc_process_id
         and invm.internal_dgrd_ref_no = dgrd.internal_dgrd_ref_no
         and dgrd.int_alloc_group_id = agh.int_alloc_group_id
         and agh.int_alloc_group_id = agd.int_alloc_group_id
         and agd.internal_stock_ref_no = grd.internal_grd_ref_no
         and dgrd.process_id = pc_process_id
         and agh.process_id = pc_process_id
         and agd.process_id = pc_process_id
         and scm.cog_ref_no = cigc.cog_ref_no
         and cigc.cog_ref_no = cs.cog_ref_no
         and cpm.product_id = grd.product_id
         and cs.cost_component_id = scms.cost_id
         and (scms.cost_display_name in
             ('Material Cost', 'Location Premium', 'Quality Premium') or
             scms.cost_type = 'SECONDARY_COST')
         and cs.cost_type = 'Actual'
         and cs.is_deleted = 'N'
         and cpm.corporate_id = pc_corporate_id
         and cigc.is_deleted = 'N'
         and scm.is_deleted = 'N'
         and grd.is_deleted = 'N'
         and grd.product_id = pdm.product_id
         and cpm.corporate_id = akc.corporate_id
         and pum_base.cur_id = akc.base_cur_id
         and pum_base.weight_unit_id = pdm.base_quantity_unit
         and pum_base.is_active = 'Y'
         and pum_base.is_deleted = 'N'
         and cs.transaction_amt_cur_id = scd.sub_cur_id(+)
         and grd.process_id = pc_process_id
         and cs.process_id = pc_process_id
         and cigc.process_id = pc_process_id
         and cs.transaction_price_unit_id = pum_trans.price_unit_id
         and pum_trans.is_active = 'Y'
         and pum_trans.is_deleted = 'N'
         and ppu.price_unit_id = pum_base.price_unit_id
         and ppu.product_id = grd.product_id
         and invm.is_active = 'Y'
         and pum_base.weight_unit_id = qum.qty_unit_id
         and akc.base_cur_id = cm.cur_id;
    --
    -- Quantity Conversion from Price Weight Unit to Stock Weight Unit
    --         
    for cur_conv1 in (select t.product_id,
                             t.price_qty_unit_id,
                             t.grd_qty_unit_id
                        from tinvs_temp_invm_cogs t
                       where t.process_id = pc_process_id
                         and t.price_qty_unit_id <> t.grd_qty_unit_id
                       group by t.price_qty_unit_id,
                                t.grd_qty_unit_id,
                                t.product_id)
    loop
      select pkg_general.f_get_converted_quantity(cur_conv1.product_id,
                                                  cur_conv1.price_qty_unit_id,
                                                  cur_conv1.grd_qty_unit_id,
                                                  1)
        into vn_qty_conv_price_to_stock
        from dual;
      update tinvs_temp_invm_cogs t
         set t.price_to_stock_wt_conversion = vn_qty_conv_price_to_stock
       where t.price_qty_unit_id = cur_conv1.price_qty_unit_id
         and t.grd_qty_unit_id = cur_conv1.grd_qty_unit_id
         and t.product_id = cur_conv1.product_id
         and t.process_id = pc_process_id;
    end loop;
    --
    -- Quantity Conversion from Stock Weight Unit to Product Base Unit
    --
    for cur_conv2 in (select t.product_id,
                             t.grd_qty_unit_id,
                             t.base_qty_unit_id
                        from tinvs_temp_invm_cogs t
                       where t.grd_qty_unit_id <> t.base_qty_unit_id
                         and t.process_id = pc_process_id
                       group by t.product_id,
                                t.grd_qty_unit_id,
                                t.base_qty_unit_id)
    loop
      select pkg_general.f_get_converted_quantity(cur_conv2.product_id,
                                                  cur_conv2.grd_qty_unit_id,
                                                  cur_conv2.base_qty_unit_id,
                                                  1)
        into vn_qty_conv_stock_to_base
        from dual;
      update tinvs_temp_invm_cogs t
         set t.price_to_stock_wt_conversion = vn_qty_conv_stock_to_base
       where t.base_qty_unit_id = cur_conv2.base_qty_unit_id
         and t.grd_qty_unit_id = cur_conv2.grd_qty_unit_id
         and t.product_id = cur_conv2.product_id
         and t.process_id = pc_process_id;
    end loop;
    --
    -- Value in Transaction Currency
    --    
    update tinvs_temp_invm_cogs t
       set t.value_in_transact_currency = t.cost_value *
                                          t.transaction_cur_factor *
                                          t.price_to_stock_wt_conversion *
                                          t.grd_current_qty *
                                          t.transformation_ratio /
                                          t.price_weight
     where t.process_id = pc_process_id;
  
    --
    -- Get the Exchange Rate from Transaction Main Currency to Base Currency
    --
    for cur_exch_rate in (select t.transaction_amt_main_cur_id,
                                 t.base_cur_id,
                                 cm_base.cur_code base_cur_code,
                                 cm_trans.cur_code transaction_amt_main_cur_code
                            from tinvs_temp_invm_cogs t,
                                 cm_currency_master   cm_trans,
                                 cm_currency_master   cm_base
                           where t.transaction_amt_main_cur_id <>
                                 t.base_cur_id
                             and t.process_id = pc_process_id
                             and t.transaction_amt_main_cur_id =
                                 cm_trans.cur_id
                             and t.base_cur_id = cm_base.cur_id
                           group by t.transaction_amt_main_cur_id,
                                    t.base_cur_id,
                                    cm_base.cur_code,
                                    cm_trans.cur_code)
    loop
      pkg_general.sp_forward_cur_exchange_new(pc_corporate_id,
                                              pd_trade_date,
                                              pd_trade_date,
                                              cur_exch_rate.transaction_amt_main_cur_id,
                                              cur_exch_rate.base_cur_id,
                                              30,
                                              vn_fw_exch_rate_trans_to_base,
                                              vn_forward_points);
    
      if vn_fw_exch_rate_trans_to_base is null or
         vn_fw_exch_rate_trans_to_base = 0 then
        vc_error_msg := '3';
        vobj_error_log.extend;
        vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                             'procedure pkg_phy_physical_process-sp cog',
                                                             'PHY-005',
                                                             cur_exch_rate.base_cur_code ||
                                                             ' to ' ||
                                                             cur_exch_rate.transaction_amt_main_cur_code || ' (' ||
                                                             to_char(pd_trade_date,
                                                                     'dd-Mon-yyyy') || ') ',
                                                             '',
                                                             gvc_process,
                                                             pc_user_id,
                                                             sysdate,
                                                             pd_trade_date);
        sp_insert_error_log(vobj_error_log);
      
      else
        vc_error_msg        := '4';
        vc_exch_rate_string := '1 ' ||
                               cur_exch_rate.transaction_amt_main_cur_code || '=' ||
                               vn_fw_exch_rate_trans_to_base || ' ' ||
                               cur_exch_rate.base_cur_code;
      
        update tinvs_temp_invm_cogs t
           set t.transact_to_base_fw_exch_rate = vn_fw_exch_rate_trans_to_base,
               trans_to_base_fw_exch_rate      = vc_exch_rate_string
         where t.transaction_amt_main_cur_id =
               cur_exch_rate.transaction_amt_main_cur_id
           and t.base_cur_id = cur_exch_rate.base_cur_id
           and t.process_id = pc_process_id;
      end if;
    end loop;
  
    --
    -- Update Value in Base and Avg Cost in Base Price Unit
    --
  
    update tinvs_temp_invm_cogs t
       set t.value_in_base_currency = t.value_in_transact_currency *
                                      t.transact_to_base_fw_exch_rate,
           t.avg_cost               = (t.value_in_transact_currency *
                                      t.transact_to_base_fw_exch_rate) /
                                      (t.stock_to_base_wt_conversion *
                                      t.grd_current_qty)
     where t.process_id = pc_process_id;
    --
    -- All calculations done and ready with data into invm_cog
    --
    insert into invm_cogs
      (process_id,
       sales_internal_gmr_ref_no,
       internal_grd_ref_no,
       material_cost_per_unit,
       secondary_cost_per_unit,
       product_premium_per_unit,
       quality_premium_per_unit,
       price_to_base_fw_exch_rate_act,
       price_to_base_fw_exch_rate,
       contract_qp_fw_exch_rate,
       contract_pp_fw_exch_rate,
       accrual_to_base_fw_exch_rate,
       price_unit_id,
       price_unit_cur_id,
       price_unit_cur_code,
       price_unit_weight_unit_id,
       price_unit_weight_unit,
       price_unit_weight)
      select pc_process_id,
             sales_internal_gmr_ref_no,
             internal_grd_ref_no,
             sum(material_cost_per_unit),
             nvl(sum(secondary_cost_per_unit), 0),
             nvl(sum(product_premium_per_unit), 0),
             nvl(sum(quality_premium_per_unit), 0),
             min(price_to_base_fw_exch_rate_act),
             f_string_aggregate(price_to_base_fw_exch_rate),
             f_string_aggregate(contract_qp_fw_exch_rate),
             f_string_aggregate(contract_pp_fw_exch_rate),
             f_string_aggregate(accrual_to_base_fw_exch_rate),
             price_unit_id,
             price_unit_cur_id,
             price_unit_cur_code,
             price_unit_weight_unit_id,
             price_unit_weight_unit,
             weight
      
        from (select t.internal_grd_ref_no,
                     sales_internal_gmr_ref_no,
                     case
                       when t.cost_type = 'Price' then
                        t.avg_cost
                       else
                        0
                     end as material_cost_per_unit,
                     case
                       when t.cost_type = 'Price' then
                        t.transact_to_base_fw_exch_rate
                       else
                        null
                     end as price_to_base_fw_exch_rate_act,
                     
                     case
                       when t.cost_type = 'Price' then
                        t.trans_to_base_fw_exch_rate
                       else
                        null
                     end as price_to_base_fw_exch_rate,
                     case
                       when t.cost_type = 'Location Premium' then
                        t.avg_cost
                       else
                        0
                     end as product_premium_per_unit,
                     case
                       when t.cost_type = 'Location Premium' then
                        t.trans_to_base_fw_exch_rate
                       else
                        null
                     end as contract_pp_fw_exch_rate,
                     
                     case
                       when t.cost_type = 'Quality Premium' then
                        t.avg_cost
                       else
                        0
                     end as quality_premium_per_unit,
                     case
                       when t.cost_type = 'Quality Premium' then
                        t.trans_to_base_fw_exch_rate
                       else
                        null
                     end as contract_qp_fw_exch_rate,
                     case
                       when t.cost_type = 'Secondary Cost' then
                        t.avg_cost
                       else
                        0
                     end as secondary_cost_per_unit,
                     case
                       when t.cost_type = 'Secondary Cost' then
                        t.trans_to_base_fw_exch_rate
                       else
                        null
                     end as accrual_to_base_fw_exch_rate,
                     base_price_unit_id_in_ppu price_unit_id,
                     base_cur_id price_unit_cur_id,
                     base_cur_code price_unit_cur_code,
                     base_qty_unit_id price_unit_weight_unit_id,
                     base_qty_unit price_unit_weight_unit,
                     1 weight
                from tinvs_temp_invm_cogs t
               where t.process_id = pc_process_id)
       group by internal_grd_ref_no,
                sales_internal_gmr_ref_no,
                price_unit_id,
                price_unit_cur_id,
                price_unit_cur_code,
                price_unit_weight_unit_id,
                price_unit_weight_unit,
                weight;
  exception
    when others then
      vobj_error_log.extend;
      vobj_error_log(vn_eel_error_count) := pelerrorlogobj(pc_corporate_id,
                                                           'procedure pkg_phy_physical_process sp_calc_invm_cogs',
                                                           'M2M-013',
                                                           'Code:' ||
                                                           sqlcode ||
                                                           'Message:' ||
                                                           sqlerrm ||
                                                           dbms_utility.format_error_backtrace ||
                                                           'No ' ||
                                                           vc_error_msg,
                                                           '',
                                                           gvc_process,
                                                           pc_user_id,
                                                           sysdate,
                                                           pd_trade_date);
      sp_insert_error_log(vobj_error_log);
    
  end;
  procedure sp_phy_purchase_accural(pc_corporate_id varchar2,
                                    pd_trade_date   date,
                                    pc_process_id   varchar2,
                                    pc_dbd_id       varchar2) as
  
    cursor cur_pur_accural is
      select gmr.internal_gmr_ref_no,
             grd.internal_grd_ref_no,
             gmr.gmr_ref_no,
             grd.product_id,
             spq.element_id,
             spq.payable_qty,
             spq.qty_unit_id payable_qty_unit_id,
             sac.element_total_qty assay_qty,
             sac.element_qty_unit_id assay_qty_unit_id,
             gmr.corporate_id,
             akc.corporate_name,
             pcpd.product_id conc_product_id,
             pdm_conc.product_desc conc_product_name,
             pcpq.quality_template_id conc_quality_id,
             qat.quality_name conc_quality_name,
             pcpd.profit_center_id profit_center,
             cpc.profit_center_name,
             cpc.profit_center_short_name,
             pc_process_id process_id,
             gmr.contract_type contract_type,
             akc.base_cur_id as base_cur_id,
             akc.base_currency_name base_cur_code,
             cm.decimals as base_cur_decimal,
             aml.attribute_name element_name,
             pcpch.payable_type,
             pcm.cp_id,
             phd.companyname counterparty_name,
             pcm.invoice_currency_id pay_cur_id,
             cm_pay.cur_code pay_cur_code
        from gmr_goods_movement_record      gmr,
             grd_goods_record_detail        grd,
             spq_stock_payable_qty          spq,
             ak_corporate                   akc,
             cm_currency_master             cm,
             pcpd_pc_product_definition     pcpd,
             pdm_productmaster              pdm_conc,
             qum_quantity_unit_master       qum_pdm_conc,
             pcpq_pc_product_quality        pcpq,
             qat_quality_attributes         qat,
             cpc_corporate_profit_center    cpc,
             sac_stock_assay_content        sac,
             aml_attribute_master_list      aml,
             pcpch_pc_payble_content_header pcpch,
             pcm_physical_contract_main     pcm,
             phd_profileheaderdetails       phd,
             ii_invoicable_item             ii,
             cm_currency_master             cm_pay
      
       where gmr.internal_gmr_ref_no = grd.internal_gmr_ref_no
         and grd.internal_grd_ref_no = spq.internal_grd_ref_no
         and gmr.corporate_id = akc.corporate_id
         and akc.base_cur_id = cm.cur_id
         and gmr.internal_contract_ref_no = pcpd.internal_contract_ref_no
         and pcpd.product_id = pdm_conc.product_id
         and qum_pdm_conc.qty_unit_id = pdm_conc.base_quantity_unit
         and pcpd.pcpd_id = pcpq.pcpd_id
         and pcpq.quality_template_id = qat.quality_id(+)
         and pcpd.profit_center_id = cpc.profit_center_id
         and grd.internal_grd_ref_no = sac.internal_grd_ref_no
         and spq.element_id = aml.attribute_id
         and spq.element_id = sac.element_id
         and gmr.process_id = pc_process_id
         and grd.process_id = pc_process_id
         and pcpq.process_id = pc_process_id
         and pcpd.input_output = 'Input'
         and pcpd.process_id = pc_process_id
         and gmr.corporate_id = pc_corporate_id
         and gmr.internal_contract_ref_no = pcpch.internal_contract_ref_no
         and spq.element_id = pcpch.element_id
         and gmr.internal_contract_ref_no = pcm.internal_contract_ref_no
         and pcm.cp_id = phd.profileid
         and gmr.internal_gmr_ref_no = ii.internal_gmr_ref_no
         and grd.internal_grd_ref_no = ii.stock_id
         and pcm.invoice_currency_id = cm_pay.cur_id
         and gmr.is_deleted = 'N'
         and gmr.is_internal_movement = 'N'
         and pcpd.is_active = 'Y'
         and pcpq.is_active = 'Y'
         and pcm.is_active = 'Y'
         and spq.process_id = pc_process_id
         and pcpch.process_id = pc_process_id
         and pcm.process_id = pc_process_id
      union all
      select gmr.internal_gmr_ref_no,
             grd.internal_grd_ref_no,
             gmr.gmr_ref_no,
             grd.product_id,
             sac.element_id,
             null payable_qty,
             null payable_qty_unit_id,
             sac.element_total_qty assay_qty,
             sac.element_qty_unit_id assay_qty_unit_id,
             gmr.corporate_id,
             akc.corporate_name,
             pcpd.product_id conc_product_id,
             pdm_conc.product_desc conc_product_name,
             pcpq.quality_template_id conc_quality_id,
             qat.quality_name conc_quality_name,
             pcpd.profit_center_id profit_center,
             cpc.profit_center_name,
             cpc.profit_center_short_name,
             pc_process_id process_id,
             gmr.contract_type contract_type,
             akc.base_cur_id as base_cur_id,
             akc.base_currency_name base_cur_code,
             cm.decimals as base_cur_decimal,
             aml.attribute_name element_name,
             null payable_type,
             pcm.cp_id,
             phd.companyname counterparty_name,
             pcm.invoice_currency_id pay_cur_id,
             cm_pay.cur_code pay_cur_code
        from gmr_goods_movement_record   gmr,
             grd_goods_record_detail     grd,
             ak_corporate                akc,
             cm_currency_master          cm,
             pcpd_pc_product_definition  pcpd,
             pdm_productmaster           pdm_conc,
             qum_quantity_unit_master    qum_pdm_conc,
             pcpq_pc_product_quality     pcpq,
             qat_quality_attributes      qat,
             cpc_corporate_profit_center cpc,
             sac_stock_assay_content     sac,
             aml_attribute_master_list   aml,
             pcm_physical_contract_main  pcm,
             phd_profileheaderdetails    phd,
             ii_invoicable_item          ii,
             cm_currency_master          cm_pay
      
       where gmr.internal_gmr_ref_no = grd.internal_gmr_ref_no
         and gmr.corporate_id = akc.corporate_id
         and akc.base_cur_id = cm.cur_id
         and gmr.internal_contract_ref_no = pcpd.internal_contract_ref_no
         and pcpd.product_id = pdm_conc.product_id
         and qum_pdm_conc.qty_unit_id = pdm_conc.base_quantity_unit
         and pcpd.pcpd_id = pcpq.pcpd_id
         and pcpq.quality_template_id = qat.quality_id(+)
         and pcpd.profit_center_id = cpc.profit_center_id
         and grd.internal_grd_ref_no = sac.internal_grd_ref_no
         and sac.element_id = aml.attribute_id
         and gmr.internal_contract_ref_no = pcm.internal_contract_ref_no
         and pcm.cp_id = phd.profileid
         and gmr.internal_gmr_ref_no = ii.internal_gmr_ref_no
         and grd.internal_grd_ref_no = ii.stock_id
         and pcm.invoice_currency_id = cm_pay.cur_id
         and pcm.process_id = pc_process_id
         and gmr.process_id = pc_process_id
         and grd.process_id = pc_process_id
         and pcpq.process_id = pc_process_id
         and pcpd.input_output = 'Input'
         and pcpd.process_id = pc_process_id
         and gmr.corporate_id = pc_corporate_id
         and gmr.is_deleted = 'N'
         and gmr.is_internal_movement = 'N'
         and pcpd.is_active = 'Y'
         and pcpq.is_active = 'Y'
         and pcm.is_active = 'Y'
         and aml.is_active = 'Y'
         and not exists
       (select spq.element_id
                from spq_stock_payable_qty spq
               where spq.process_id = gmr.process_id
                 and spq.internal_gmr_ref_no = gmr.internal_gmr_ref_no
                 and spq.element_id = sac.element_id);
  
    vn_payable_amount            number;
    vn_rc_amount                 number;
    vn_tc_amount                 number;
    vn_penality_amount           number;
    vn_gmr_treatment_charge      number;
    vc_gmr_treatment_cur_id      varchar2(15);
    vn_base_gmr_treatment_charge number;
    vn_gmr_refine_charge         number;
    vc_gmr_refine_cur_id         varchar2(15);
    vn_base_gmr_refine_charge    number;
    vn_gmr_penality_charge       number;
    vc_gmr_penality_cur_id       varchar2(15);
    vn_base_gmr_penality_charge  number;
    vn_gmr_price                 number;
    vc_gmr_price_untit_id        varchar2(15);
    vn_gmr_price_unit_weight     varchar2(15);
    vn_price_unit_weight_unit_id varchar2(15);
    vc_gmr_price_unit_cur_id     varchar2(10);
    vc_gmr_price_unit_cur_code   varchar2(10);
    vn_payable_amt_in_price_cur  number;
    vn_payable_amt_in_pay_cur    number;
    vc_price_cur_id              varchar2(15);
    vc_price_cur_code            varchar2(15);
    vn_cont_price_cur_id_factor  number;
    vn_cont_price_cur_decimals   number;
    vn_fx_rate_price_to_pay      number;
  
  begin
    for cur_pur_accural_rows in cur_pur_accural
    loop
    
      begin
        select psu.m2m_price,
               psu.m2m_price_unit_id,
               psu.m2m_price_weight_unit_id,
               psu.m2m_price_cur_id,
               psu.m2m_price_cur_code
          into vn_gmr_price,
               vc_gmr_price_untit_id,
               vn_price_unit_weight_unit_id,
               vc_gmr_price_unit_cur_id,
               vc_gmr_price_unit_cur_code
          from gmr_goods_movement_record gmr,
               grd_goods_record_detail   grd,
               psue_element_details      psu
         where gmr.internal_gmr_ref_no = grd.internal_gmr_ref_no
           and psu.internal_gmr_ref_no = gmr.internal_gmr_ref_no
           and psu.internal_grd_dgrd_ref_no = grd.internal_grd_ref_no
           and gmr.internal_gmr_ref_no =
               cur_pur_accural_rows.internal_gmr_ref_no
           and grd.internal_grd_ref_no =
               cur_pur_accural_rows.internal_grd_ref_no
           and psu.process_id = pc_process_id
           and gmr.process_id = pc_process_id
           and grd.process_id = pc_process_id
           and gmr.corporate_id = pc_corporate_id
           and gmr.is_deleted = 'N'
           and psu.element_id = cur_pur_accural_rows.element_id;
      exception
        when no_data_found then
          vn_gmr_price                 := null;
          vc_gmr_price_untit_id        := null;
          vn_price_unit_weight_unit_id := null;
          vc_gmr_price_unit_cur_id     := null;
          vc_gmr_price_unit_cur_code   := null;
      end;
    
      pkg_general.sp_get_main_cur_detail(vc_gmr_price_unit_cur_id,
                                         vc_price_cur_id,
                                         vc_price_cur_code,
                                         vn_cont_price_cur_id_factor,
                                         vn_cont_price_cur_decimals);
    
      vn_payable_amt_in_price_cur := (vn_gmr_price /
                                     nvl(vn_gmr_price_unit_weight, 1)) *
                                     (pkg_general.f_get_converted_quantity(cur_pur_accural_rows.conc_product_id,
                                                                           cur_pur_accural_rows.payable_qty_unit_id,
                                                                           vn_price_unit_weight_unit_id,
                                                                           cur_pur_accural_rows.payable_qty)) *
                                     vn_cont_price_cur_id_factor;
    
      vn_fx_rate_price_to_pay   := pkg_general.f_get_converted_currency_amt(cur_pur_accural_rows.corporate_id,
                                                                            vc_gmr_price_unit_cur_id,
                                                                            cur_pur_accural_rows.pay_cur_id,
                                                                            pd_trade_date,
                                                                            1);
      vn_payable_amt_in_pay_cur := vn_payable_amt_in_price_cur *
                                   vn_fx_rate_price_to_pay;
      pkg_metals_general.sp_get_gmr_treatment_charge(cur_pur_accural_rows.internal_gmr_ref_no,
                                                     cur_pur_accural_rows.internal_grd_ref_no,
                                                     cur_pur_accural_rows.element_id,
                                                     pc_dbd_id,
                                                     vn_gmr_price,
                                                     vc_gmr_price_untit_id,
                                                     vn_gmr_treatment_charge,
                                                     vc_gmr_treatment_cur_id);
    
      -- converted treatment charges to base currency                                           
      vn_base_gmr_treatment_charge := round(pkg_general.f_get_converted_currency_amt(cur_pur_accural_rows.corporate_id,
                                                                                     vc_gmr_treatment_cur_id,
                                                                                     cur_pur_accural_rows.pay_cur_id,
                                                                                     pd_trade_date,
                                                                                     vn_gmr_treatment_charge),
                                            cur_pur_accural_rows.base_cur_decimal);
    
      pkg_metals_general.sp_get_gmr_refine_charge(cur_pur_accural_rows.internal_gmr_ref_no,
                                                  cur_pur_accural_rows.internal_grd_ref_no,
                                                  cur_pur_accural_rows.element_id,
                                                  pc_dbd_id,
                                                  vn_gmr_price,
                                                  vc_gmr_price_untit_id,
                                                  vn_gmr_refine_charge,
                                                  vc_gmr_refine_cur_id);
    
      --- converted refine charges to base currency                                              
    
      vn_base_gmr_refine_charge := round(pkg_general.f_get_converted_currency_amt(cur_pur_accural_rows.corporate_id,
                                                                                  vc_gmr_refine_cur_id,
                                                                                  cur_pur_accural_rows.pay_cur_id,
                                                                                  pd_trade_date,
                                                                                  vn_gmr_refine_charge),
                                         cur_pur_accural_rows.base_cur_decimal);
      pkg_metals_general.sp_get_gmr_penalty_charge(cur_pur_accural_rows.internal_gmr_ref_no,
                                                   cur_pur_accural_rows.internal_grd_ref_no,
                                                   pc_dbd_id,
                                                   cur_pur_accural_rows.element_id,
                                                   vn_gmr_penality_charge,
                                                   vc_gmr_penality_cur_id);
    
      vn_base_gmr_penality_charge := round(pkg_general.f_get_converted_currency_amt(cur_pur_accural_rows.corporate_id,
                                                                                    vc_gmr_penality_cur_id,
                                                                                    cur_pur_accural_rows.pay_cur_id,
                                                                                    pd_trade_date,
                                                                                    vn_gmr_penality_charge),
                                           cur_pur_accural_rows.base_cur_decimal);
    
      insert into pa_purchase_accural
        (corporate_id,
         process_id,
         product_id,
         product_type,
         contract_type,
         cp_id,
         counterparty_name,
         gmr_ref_no,
         internal_gmr_ref_no,
         internal_grd_ref_no,
         element_id,
         element_name,
         payable_returnable_type,
         assay_content,
         assay_content_unit,
         payable_qty,
         payable_qty_unit_id,
         price,
         price_unit_id,
         price_unit_cur_id,
         price_unit_cur_code,
         fx_rate_price_to_pay,
         pay_in_cur_id,
         pay_in_cur_code,
         tcharges_amount,
         rcharges_amount,
         penalty_amount,
         payable_amt_price_ccy,
         payable_amt_pay_ccy,
         frightcharges_amount,
         othercharges_amount)
      values
        (cur_pur_accural_rows.corporate_id,
         pc_process_id,
         cur_pur_accural_rows.product_id,
         cur_pur_accural_rows.conc_product_name,
         cur_pur_accural_rows.contract_type,
         cur_pur_accural_rows.cp_id,
         cur_pur_accural_rows.counterparty_name,
         cur_pur_accural_rows.gmr_ref_no,
         cur_pur_accural_rows.internal_gmr_ref_no,
         cur_pur_accural_rows.internal_grd_ref_no,
         cur_pur_accural_rows.element_id,
         cur_pur_accural_rows.element_name,
         cur_pur_accural_rows.payable_type,
         cur_pur_accural_rows.assay_qty,
         cur_pur_accural_rows.assay_qty_unit_id,
         nvl(cur_pur_accural_rows.payable_qty, 0),
         nvl(cur_pur_accural_rows.payable_qty_unit_id,
             cur_pur_accural_rows.assay_qty_unit_id),
         vn_gmr_price,
         vc_gmr_price_untit_id,
         vc_gmr_price_unit_cur_id,
         vc_gmr_price_unit_cur_code,
         vn_fx_rate_price_to_pay,
         cur_pur_accural_rows.pay_cur_id,
         cur_pur_accural_rows.pay_cur_code,
         vn_base_gmr_treatment_charge,
         vn_base_gmr_refine_charge,
         vn_base_gmr_penality_charge,
         nvl(vn_payable_amt_in_price_cur, 0),
         nvl(vn_payable_amt_in_pay_cur, 0),
         0, --frightcharges_amount,
         0 --othercharges_amount    
         );
    end loop;
  
    ---- Invoiced  GMR Level
    insert into pa_purchase_accural_gmr
      (corporate_id,
       process_id,
       eod_trade_date,
       product_id,
       product_type,
       contract_type,
       cp_id,
       counterparty_name,
       gmr_ref_no,
       element_id,
       element_name,
       payable_returnable_type,
       assay_content,
       assay_content_unit,
       payable_qty,
       payable_qty_unit_id,
       tcharges_amount,
       rcharges_amount,
       penalty_amount,
       payable_amt_pay_ccy,
       pay_in_cur_id,
       pay_in_cur_code,
       frightcharges_amount,
       othercharges_amount,
       tranascation_type) with latest_invoice as
      (select inv.gmr_ref_no,
              inv.internal_invoice_ref_no,
              inv.eff_date,
              inv.process_id
         from (select gmr.gmr_ref_no,
                      iss.internal_invoice_ref_no,
                      axs.eff_date,
                      pc_process_id process_id,
                      rank() over(partition by gmr.gmr_ref_no order by axs.eff_date desc) rank_disp
                 from gmr_goods_movement_record  gmr,
                      is_invoice_summary         iss,
                      iam_invoice_action_mapping iam,
                      axs_action_summary         axs
                where gmr.internal_contract_ref_no =
                      iss.internal_contract_ref_no
                  and iss.internal_invoice_ref_no =
                      iam.internal_invoice_ref_no
                  and iam.invoice_action_ref_no = axs.internal_action_ref_no
                  and gmr.process_id = pc_process_id
                  and iss.process_id = pc_process_id
                group by gmr.gmr_ref_no,
                         iss.internal_invoice_ref_no,
                         axs.eff_date,
                         pc_process_id) inv
        where inv.rank_disp = 1)
      select temp.corporate_id,
             pc_process_id,
             pd_trade_date,
             temp.product_id,
             pdm_conc.product_desc,
             temp.contract_type,
             pcm.cp_id,
             phd.companyname,
             temp.gmr_ref_no,
             temp.element_id,
             aml.attribute_name,
             pcpch.payable_type,
             sum(temp.assay_qty) payable_qty,
             temp.assay_qty_unit assay_qty_unit,
             sum(temp.payble_qty) payable_qty,
             temp.payable_qty_unit payable_qty_unit_id,
             sum(temp.tcharges_amount) tcharges_amount,
             sum(temp.rcharges_amount) rcharges_amount,
             sum(temp.penalty_amount) penalty_amount,
             sum(temp.element_payable_amount) element_payable_amount,
             temp.invoice_currency_id,
             cm.cur_code,
             0,
             0,
             'Invoiced'
        from (select grd.internal_gmr_ref_no,
                     grd.internal_grd_ref_no,
                     gmr.internal_contract_ref_no,
                     gmr.gmr_ref_no,
                     gmr.corporate_id,
                     grd.product_id,
                     grd.quality_id,
                     grd.profit_center_id,
                     iid.invoice_currency_id,
                     iied.element_id,
                     gmr.contract_type,
                     0 assay_qty,
                     (case
                       when rm.ratio_name = '%' then
                        ash.net_weight_unit
                       else
                        rm.qty_unit_id_numerator
                     end) assay_qty_unit,
                     iied.element_invoiced_qty payble_qty,
                     iied.element_inv_qty_unit_id payable_qty_unit,
                     iied.element_payable_amount,
                     0 tcharges_amount,
                     0 rcharges_amount,
                     0 penalty_amount
                from gmr_goods_movement_record     gmr,
                     grd_goods_record_detail       grd,
                     iid_invoicable_item_details   iid,
                     iied_inv_item_element_details iied,
                     ak_corporate                  akc,
                     cm_currency_master            cm,
                     iam_invoice_assay_mapping     iam,
                     ash_assay_header              ash,
                     asm_assay_sublot_mapping      asm,
                     pqca_pq_chemical_attributes   pqca,
                     rm_ratio_master               rm,
                     latest_invoice                inv
               where gmr.internal_gmr_ref_no = grd.internal_gmr_ref_no
                 and gmr.internal_gmr_ref_no = iid.internal_gmr_ref_no
                 and grd.internal_grd_ref_no = iid.stock_id
                 and iid.internal_invoice_ref_no =
                     iied.internal_invoice_ref_no
                 and iid.stock_id = iied.grd_id
                 and gmr.corporate_id = akc.corporate_id
                 and akc.base_cur_id = cm.cur_id
                 and iid.internal_invoice_ref_no =
                     iam.internal_invoice_ref_no
                 and iid.stock_id = iam.internal_grd_ref_no
                 and iam.ash_id = ash.ash_id
                 and ash.ash_id = asm.ash_id
                 and asm.asm_id = pqca.asm_id
                 and iied.element_id = pqca.element_id
                 and pqca.unit_of_measure = rm.ratio_id
                 and gmr.gmr_ref_no = inv.gmr_ref_no
                 and gmr.process_id = inv.process_id
                 and grd.process_id = pc_process_id
                 and gmr.process_id = pc_process_id
                 and gmr.is_deleted = 'N'
                 and gmr.corporate_id = pc_corporate_id
              union all
              ----- assay qty
              select grd.internal_gmr_ref_no,
                     grd.internal_grd_ref_no,
                     gmr.internal_contract_ref_no,
                     gmr.gmr_ref_no,
                     gmr.corporate_id,
                     grd.product_id,
                     grd.quality_id,
                     grd.profit_center_id,
                     iid.invoice_currency_id,
                     pqca.element_id,
                     gmr.contract_type,
                     (case
                       when rm.ratio_name = '%' then
                        (pqca.typical * asm.dry_weight) / 100
                       else
                        pkg_general.f_get_converted_quantity(aml.underlying_product_id,
                                                             asm.net_weight_unit,
                                                             rm.qty_unit_id_denominator,
                                                             asm.dry_weight) *
                        pqca.typical
                     
                     end) assay_qty,
                     (case
                       when rm.ratio_name = '%' then
                        ash.net_weight_unit
                       else
                        rm.qty_unit_id_numerator
                     end) assay_qty_unit,
                     0 payble_qty,
                     (case
                       when rm.ratio_name = '%' then
                        ash.net_weight_unit
                       else
                        rm.qty_unit_id_numerator
                     end) payable_qty_unit,
                     0 element_payable_amount,
                     0 tcharges_amount,
                     0 rcharges_amount,
                     0 penalty_amount
                from gmr_goods_movement_record   gmr,
                     grd_goods_record_detail     grd,
                     iid_invoicable_item_details iid,
                     ak_corporate                akc,
                     cm_currency_master          cm,
                     iam_invoice_assay_mapping   iam,
                     ash_assay_header            ash,
                     asm_assay_sublot_mapping    asm,
                     pqca_pq_chemical_attributes pqca,
                     rm_ratio_master             rm,
                     aml_attribute_master_list   aml,
                     latest_invoice              inv
               where gmr.internal_gmr_ref_no = grd.internal_gmr_ref_no
                 and gmr.internal_gmr_ref_no = iid.internal_gmr_ref_no
                 and grd.internal_grd_ref_no = iid.stock_id
                 and gmr.corporate_id = akc.corporate_id
                 and akc.base_cur_id = cm.cur_id
                 and iid.internal_invoice_ref_no =
                     iam.internal_invoice_ref_no
                 and iid.stock_id = iam.internal_grd_ref_no
                 and iam.ash_id = ash.ash_id
                 and ash.ash_id = asm.ash_id
                 and asm.asm_id = pqca.asm_id
                 and pqca.element_id = aml.attribute_id
                 and pqca.unit_of_measure = rm.ratio_id
                 and gmr.gmr_ref_no = inv.gmr_ref_no
                 and gmr.process_id = inv.process_id
                 and grd.process_id = pc_process_id
                 and gmr.process_id = pc_process_id
                 and gmr.is_deleted = 'N'
                 and gmr.corporate_id = pc_corporate_id
              ---- Tc Chrages
              union all
              select grd.internal_gmr_ref_no,
                     grd.internal_grd_ref_no,
                     gmr.internal_contract_ref_no,
                     gmr.gmr_ref_no,
                     gmr.corporate_id,
                     grd.product_id,
                     grd.quality_id,
                     grd.profit_center_id,
                     iid.invoice_currency_id,
                     intc.element_id,
                     gmr.contract_type,
                     0 assay_qty,
                     (case
                       when rm.ratio_name = '%' then
                        ash.net_weight_unit
                       else
                        rm.qty_unit_id_numerator
                     end) assay_qty_unit,
                     0 payble_qty,
                     (case
                       when rm.ratio_name = '%' then
                        ash.net_weight_unit
                       else
                        rm.qty_unit_id_numerator
                     end) payable_qty_unit,
                     0 element_payable_amount,
                     intc.tcharges_amount tcharges_amount,
                     0 rcharges_amount,
                     0 penalty_amount
                from gmr_goods_movement_record   gmr,
                     grd_goods_record_detail     grd,
                     iid_invoicable_item_details iid,
                     intc_inv_treatment_charges  intc,
                     ak_corporate                akc,
                     cm_currency_master          cm,
                     aml_attribute_master_list   aml,
                     iam_invoice_assay_mapping   iam,
                     ash_assay_header            ash,
                     asm_assay_sublot_mapping    asm,
                     pqca_pq_chemical_attributes pqca,
                     rm_ratio_master             rm,
                     latest_invoice              inv
               where gmr.internal_gmr_ref_no = grd.internal_gmr_ref_no
                 and gmr.internal_gmr_ref_no = iid.internal_gmr_ref_no
                 and grd.internal_grd_ref_no = iid.stock_id
                 and iid.internal_invoice_ref_no =
                     intc.internal_invoice_ref_no
                 and iid.stock_id = intc.grd_id
                 and gmr.corporate_id = akc.corporate_id
                 and intc.element_id = aml.attribute_id
                 and akc.base_cur_id = cm.cur_id
                 and iid.internal_invoice_ref_no =
                     iam.internal_invoice_ref_no
                 and iid.stock_id = iam.internal_grd_ref_no
                 and iam.ash_id = ash.ash_id
                 and ash.ash_id = asm.ash_id
                 and asm.asm_id = pqca.asm_id
                 and intc.element_id = pqca.element_id
                 and pqca.unit_of_measure = rm.ratio_id
                 and gmr.gmr_ref_no = inv.gmr_ref_no
                 and gmr.process_id = inv.process_id
                 and grd.process_id = pc_process_id
                 and gmr.process_id = pc_process_id
                 and gmr.is_deleted = 'N'
                 and gmr.corporate_id = pc_corporate_id
              -- Rc Chargess
              union all
              select grd.internal_gmr_ref_no,
                     grd.internal_grd_ref_no,
                     gmr.internal_contract_ref_no,
                     gmr.gmr_ref_no,
                     gmr.corporate_id,
                     grd.product_id,
                     grd.quality_id,
                     grd.profit_center_id,
                     iid.invoice_currency_id,
                     inrc.element_id,
                     gmr.contract_type,
                     0 assay_qty,
                     (case
                       when rm.ratio_name = '%' then
                        ash.net_weight_unit
                       else
                        rm.qty_unit_id_numerator
                     end) assay_qty_unit,
                     0 payble_qty,
                     (case
                       when rm.ratio_name = '%' then
                        ash.net_weight_unit
                       else
                        rm.qty_unit_id_numerator
                     end) payable_qty_unit,
                     0 element_payable_amount,
                     0 tcharges_amount,
                     inrc.rcharges_amount rcharges_amount,
                     0 penalty_amount
                from gmr_goods_movement_record   gmr,
                     grd_goods_record_detail     grd,
                     iid_invoicable_item_details iid,
                     inrc_inv_refining_charges   inrc,
                     ak_corporate                akc,
                     cm_currency_master          cm,
                     aml_attribute_master_list   aml,
                     iam_invoice_assay_mapping   iam,
                     ash_assay_header            ash,
                     asm_assay_sublot_mapping    asm,
                     pqca_pq_chemical_attributes pqca,
                     rm_ratio_master             rm,
                     latest_invoice              inv
               where gmr.internal_gmr_ref_no = grd.internal_gmr_ref_no
                 and gmr.internal_gmr_ref_no = iid.internal_gmr_ref_no
                 and grd.internal_grd_ref_no = iid.stock_id
                 and iid.internal_invoice_ref_no =
                     inrc.internal_invoice_ref_no
                 and iid.stock_id = inrc.grd_id
                 and gmr.corporate_id = akc.corporate_id
                 and inrc.element_id = aml.attribute_id
                 and akc.base_cur_id = cm.cur_id
                 and iid.internal_invoice_ref_no =
                     iam.internal_invoice_ref_no
                 and iid.stock_id = iam.internal_grd_ref_no
                 and iam.ash_id = ash.ash_id
                 and ash.ash_id = asm.ash_id
                 and asm.asm_id = pqca.asm_id
                 and inrc.element_id = pqca.element_id
                 and pqca.unit_of_measure = rm.ratio_id
                 and gmr.gmr_ref_no = inv.gmr_ref_no
                 and gmr.process_id = inv.process_id
                 and grd.process_id = pc_process_id
                 and gmr.process_id = pc_process_id
                 and gmr.is_deleted = 'N'
                 and gmr.corporate_id = pc_corporate_id
              -- penality
              union all
              select grd.internal_gmr_ref_no,
                     grd.internal_grd_ref_no,
                     gmr.internal_contract_ref_no,
                     gmr.gmr_ref_no,
                     gmr.corporate_id,
                     grd.product_id,
                     grd.quality_id,
                     grd.profit_center_id,
                     iid.invoice_currency_id,
                     iepd.element_id,
                     gmr.contract_type,
                     0 assay_qty,
                     (case
                       when rm.ratio_name = '%' then
                        ash.net_weight_unit
                       else
                        rm.qty_unit_id_numerator
                     end) assay_qty_unit,
                     0 payble_qty,
                     (case
                       when rm.ratio_name = '%' then
                        ash.net_weight_unit
                       else
                        rm.qty_unit_id_numerator
                     end) payable_qty_unit,
                     0 element_payable_amount,
                     0 tcharges_amount,
                     0 rcharges_amount,
                     iepd.element_penalty_amount penalty_amount
                from gmr_goods_movement_record   gmr,
                     grd_goods_record_detail     grd,
                     iid_invoicable_item_details iid,
                     iepd_inv_epenalty_details   iepd,
                     ak_corporate                akc,
                     cm_currency_master          cm,
                     iam_invoice_assay_mapping   iam,
                     ash_assay_header            ash,
                     asm_assay_sublot_mapping    asm,
                     pqca_pq_chemical_attributes pqca,
                     rm_ratio_master             rm,
                     latest_invoice              inv
               where gmr.internal_gmr_ref_no = grd.internal_gmr_ref_no
                 and gmr.internal_gmr_ref_no = iid.internal_gmr_ref_no
                 and grd.internal_grd_ref_no = iid.stock_id
                 and iid.internal_invoice_ref_no =
                     iepd.internal_invoice_ref_no
                 and iid.stock_id = iepd.stock_id
                 and gmr.corporate_id = akc.corporate_id
                 and akc.base_cur_id = cm.cur_id
                 and iid.internal_invoice_ref_no =
                     iam.internal_invoice_ref_no
                 and iid.stock_id = iam.internal_grd_ref_no
                 and iam.ash_id = ash.ash_id
                 and ash.ash_id = asm.ash_id
                 and asm.asm_id = pqca.asm_id
                 and iepd.element_id = pqca.element_id
                 and pqca.unit_of_measure = rm.ratio_id
                 and gmr.gmr_ref_no = inv.gmr_ref_no
                 and gmr.process_id = inv.process_id
                 and grd.process_id = pc_process_id
                 and gmr.process_id = pc_process_id
                 and gmr.is_deleted = 'N'
                 and gmr.corporate_id = pc_corporate_id) temp,
             pdm_productmaster pdm_conc,
             qat_quality_attributes qat,
             cpc_corporate_profit_center cpc,
             ak_corporate akc,
             cm_currency_master cm,
             aml_attribute_master_list aml,
             pcm_physical_contract_main pcm,
             phd_profileheaderdetails phd,
             pcpch_pc_payble_content_header pcpch
       where temp.product_id = pdm_conc.product_id
         and temp.quality_id = qat.quality_id(+)
         and temp.profit_center_id = cpc.profit_center_id
         and temp.corporate_id = akc.corporate_id
         and temp.element_id = aml.attribute_id
         and temp.invoice_currency_id = cm.cur_id
         and temp.internal_contract_ref_no = pcm.internal_contract_ref_no
         and pcm.cp_id = phd.profileid
         and pcm.cp_id = phd.profileid
         and temp.internal_contract_ref_no =
             pcpch.internal_contract_ref_no(+)
         and temp.element_id = pcpch.element_id(+)
         and pcm.process_id = pc_process_id
         and pcpch.process_id(+) = pc_process_id
         and pcm.is_active = 'Y'
         and pcpch.is_active(+) = 'Y'
       group by temp.corporate_id,
                pc_process_id,
                temp.product_id,
                pdm_conc.product_desc,
                pcm.cp_id,
                temp.contract_type,
                phd.companyname,
                temp.gmr_ref_no,
                temp.element_id,
                aml.attribute_name,
                pcpch.payable_type,
                temp.invoice_currency_id,
                temp.payable_qty_unit,
                temp.assay_qty_unit,
                cm.cur_code,
                'Invoiced';
  
    --calucalted GMR Leval             
    insert into pa_purchase_accural_gmr
      (corporate_id,
       process_id,
       eod_trade_date,
       product_id,
       product_type,
       contract_type,
       cp_id,
       counterparty_name,
       gmr_ref_no,
       element_id,
       element_name,
       payable_returnable_type,
       assay_content,
       assay_content_unit,
       payable_qty,
       payable_qty_unit_id,
       price,
       price_unit_id,
       price_unit_cur_id,
       price_unit_cur_code,
       pay_in_cur_id,
       pay_in_cur_code,
       payable_amt_price_ccy,
       payable_amt_pay_ccy,
       fx_rate_price_to_pay,
       tcharges_amount,
       rcharges_amount,
       penalty_amount,
       frightcharges_amount,
       othercharges_amount,
       tranascation_type)
      select pa.corporate_id,
             pc_process_id,
             pd_trade_date,
             pa.product_id,
             pa.product_type,
             pa.contract_type,
             pa.cp_id,
             pa.counterparty_name,
             pa.gmr_ref_no,
             pa.element_id,
             pa.element_name,
             pa.payable_returnable_type,
             sum(pa.assay_content),
             pa.assay_content_unit,
             sum(pa.payable_qty),
             pa.payable_qty_unit_id,
             pa.price,
             pa.price_unit_id,
             pa.price_unit_cur_id,
             pa.price_unit_cur_code,
             pa.pay_in_cur_id,
             pa.pay_in_cur_code,
             sum(pa.payable_amt_price_ccy),
             sum(pa.payable_amt_pay_ccy),
             pa.fx_rate_price_to_pay,
             sum(pa.tcharges_amount),
             sum(pa.rcharges_amount),
             sum(pa.penalty_amount),
             0,
             0,
             'Calculated'
        from pa_purchase_accural pa
       where pa.process_id = pc_process_id
         and pa.corporate_id = pc_corporate_id
       group by pa.corporate_id,
                pc_process_id,
                pa.product_id,
                pa.product_type,
                pa.contract_type,
                pa.cp_id,
                pa.counterparty_name,
                pa.gmr_ref_no,
                pa.element_id,
                pa.element_name,
                pa.payable_returnable_type,
                pa.assay_content_unit,
                pa.payable_qty_unit_id,
                pa.price,
                pa.price_unit_id,
                pa.price_unit_cur_id,
                pa.price_unit_cur_code,
                pa.pay_in_cur_id,
                pa.pay_in_cur_code,
                pa.fx_rate_price_to_pay,
                'Calculated';
    -- diff GMR level
  
    insert into pa_purchase_accural_gmr
      (corporate_id,
       process_id,
       eod_trade_date,
       product_id,
       product_type,
       contract_type,
       cp_id,
       counterparty_name,
       gmr_ref_no,
       element_id,
       element_name,
       payable_returnable_type,
       assay_content,
       assay_content_unit,
       payable_qty,
       payable_qty_unit_id,
       tcharges_amount,
       rcharges_amount,
       penalty_amount,
       payable_amt_pay_ccy,
       pay_in_cur_id,
       pay_in_cur_code,
       frightcharges_amount,
       othercharges_amount,
       tranascation_type)
      select pa.corporate_id,
             pc_process_id,
             pd_trade_date,
             pa.product_id,
             pa.product_type,
             pa.contract_type,
             pa.cp_id,
             pa.counterparty_name,
             pa.gmr_ref_no,
             pa.element_id,
             pa.element_name,
             pa.payable_returnable_type,
             sum(case
                   when pa.tranascation_type = 'Calculated' then
                    pa.assay_content
                   else
                    0
                 end) - sum(case
                              when pa.tranascation_type = 'Invoiced' then
                               pa.assay_content
                              else
                               0
                            end) assay_content,
             pa.assay_content_unit,
             sum(case
                   when pa.tranascation_type = 'Calculated' then
                    pa.payable_qty
                   else
                    0
                 end) - sum(case
                              when pa.tranascation_type = 'Invoiced' then
                               pa.payable_qty
                              else
                               0
                            end) payable_qty,
             pa.payable_qty_unit_id,
             sum(case
                   when pa.tranascation_type = 'Calculated' then
                    pa.tcharges_amount
                   else
                    0
                 end) - sum(case
                              when pa.tranascation_type = 'Invoiced' then
                               pa.tcharges_amount
                              else
                               0
                            end) tcharges_amount,
             sum(case
                   when pa.tranascation_type = 'Calculated' then
                    pa.rcharges_amount
                   else
                    0
                 end) - sum(case
                              when pa.tranascation_type = 'Invoiced' then
                               pa.rcharges_amount
                              else
                               0
                            end) rcharges_amount,
             sum(case
                   when pa.tranascation_type = 'Calculated' then
                    pa.penalty_amount
                   else
                    0
                 end) - sum(case
                              when pa.tranascation_type = 'Invoiced' then
                               pa.penalty_amount
                              else
                               0
                            end) penalty_amount,
             sum(case
                   when pa.tranascation_type = 'Calculated' then
                    pa.payable_amt_pay_ccy
                   else
                    0
                 end) - sum(case
                              when pa.tranascation_type = 'Invoiced' then
                               pa.payable_amt_pay_ccy
                              else
                               0
                            end) payable_amount,
             pa.pay_in_cur_id,
             pa.pay_in_cur_code,
             0,
             0,
             'Difference'
        from pa_purchase_accural_gmr pa
       where pa.process_id = pc_process_id
         and pa.corporate_id = pc_corporate_id
       group by pa.corporate_id,
                pc_process_id,
                pa.product_id,
                pa.product_type,
                pa.contract_type,
                pa.cp_id,
                pa.counterparty_name,
                pa.gmr_ref_no,
                pa.element_id,
                pa.element_name,
                pa.payable_returnable_type,
                pa.assay_content_unit,
                pa.payable_qty_unit_id,
                pa.pay_in_cur_id,
                pa.pay_in_cur_code,
                'Difference';
  
    commit;
  end;
end;
/
